#!/usr/bin/env python3
"""
üß™ BATERIA INTENSIVA DE TESTES - CLAUDE AI
Teste completo e detalhado de TODAS as funcionalidades
"""

import sys
import os
import importlib
import traceback
import time
import json
from datetime import datetime
from typing import Dict, List, Any, Optional

# Adicionar diret√≥rio raiz ao path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

class BateriaTestesIntensiva:
    """Bateria intensiva de testes para sistemas Claude AI"""
    
    def __init__(self):
        self.resultados = {
            'sistema_atual': {},
            'sistema_novo': {},
            'testes_funcionais': {},
            'testes_performance': {},
            'testes_integracao': {},
            'comparacao_detalhada': {}
        }
        
        # Consultas de teste mais diversificadas
        self.consultas_basicas = [
            "Quantas entregas do Assai em dezembro?",
            "Gere um relat√≥rio Excel das entregas atrasadas",
            "Qual o status dos embarques hoje?",
            "An√°lise de fretes por transportadora",
            "Pedidos pendentes de faturamento"
        ]
        
        # Consultas espec√≠ficas para testar funcionalidades
        self.consultas_excel = [
            "Exportar dados do Carrefour para Excel",
            "Gerar planilha de entregas atrasadas",
            "Relat√≥rio completo em Excel dos fretes",
            "Criar planilha de an√°lise de pedidos"
        ]
        
        self.consultas_nlp = [
            "Qual cliente tem mais problemas?",
            "Analise padr√µes de atraso nas entregas",
            "Identifique tend√™ncias nos dados",
            "Extraia insights dos embarques"
        ]
        
        self.consultas_contexto = [
            ("Entregas do Assai em janeiro", "E em fevereiro?"),
            ("Fretes da transportadora X", "Qual o valor total?"),
            ("Pedidos atrasados", "Quantos s√£o urgentes?")
        ]
        
        self.consultas_desenvolvimento = [
            "Leia o arquivo app/models.py",
            "Descubra a estrutura do projeto",
            "Analise o c√≥digo da aplica√ß√£o",
            "Liste todos os m√≥dulos dispon√≠veis"
        ]
    
    def executar_bateria_completa(self):
        """Executa bateria completa de testes"""
        print("üß™ BATERIA INTENSIVA DE TESTES - CLAUDE AI")
        print("=" * 80)
        print("üïí Tempo estimado: 10-15 minutos")
        print("üîç Testes: Funcional, Performance, Integra√ß√£o, NLP, Excel, Contexto")
        print()
        
        inicio = time.time()
        
        # 1. Testes de inicializa√ß√£o e m√≥dulos
        self.testar_inicializacao_modulos()
        
        # 2. Testes funcionais b√°sicos
        self.testar_funcionalidades_basicas()
        
        # 3. Testes espec√≠ficos por categoria
        self.testar_funcionalidades_excel()
        self.testar_funcionalidades_nlp()
        self.testar_contexto_conversacional()
        self.testar_funcionalidades_desenvolvimento()
        
        # 4. Testes de integra√ß√£o
        self.testar_integracao_banco()
        
        # 5. Testes de performance
        self.testar_performance()
        
        # 6. Testes de recupera√ß√£o de erro
        self.testar_recuperacao_erros()
        
        # 7. Compara√ß√£o detalhada
        self.comparar_sistemas_detalhado()
        
        fim = time.time()
        tempo_total = fim - inicio
        
        # 8. Relat√≥rio final
        self.gerar_relatorio_completo(tempo_total)
    
    def testar_inicializacao_modulos(self):
        """Testa inicializa√ß√£o e presen√ßa de m√≥dulos espec√≠ficos"""
        print("üîß TESTE 1: INICIALIZA√á√ÉO E M√ìDULOS")
        print("-" * 60)
        
        # Sistema Atual
        print("\nü§ñ SISTEMA ATUAL:")
        try:
            from app.claude_ai.claude_real_integration import ClaudeRealIntegration
            sistema_atual = ClaudeRealIntegration()
            
            # Lista completa de m√≥dulos para testar
            modulos_testar = [
                'multi_agent_system',
                'advanced_ai_system', 
                'nlp_analyzer',
                'intelligent_analyzer',
                'enhanced_claude',
                'suggestion_engine',
                'ml_models',
                'human_learning',
                'input_validator',
                'ai_config',
                'vendedor_analyzer',
                'geral_analyzer',
                'alert_engine',
                'mapeamento_semantico',
                'mcp_connector',
                'system_alerts',
                'ai_logger',
                'intelligent_cache',
                'project_scanner',
                'client',
                'redis_disponivel'
            ]
            
            modulos_presentes = []
            modulos_funcionais = []
            
            for modulo in modulos_testar:
                presente = hasattr(sistema_atual, modulo)
                if presente:
                    obj = getattr(sistema_atual, modulo)
                    funcional = obj is not None
                    modulos_presentes.append(modulo)
                    if funcional:
                        modulos_funcionais.append(modulo)
                    print(f"   {'‚úÖ' if funcional else '‚ö†Ô∏è'} {modulo}: {'Funcional' if funcional else 'Presente mas None'}")
                else:
                    print(f"   ‚ùå {modulo}: Ausente")
            
            # Testar m√©todos espec√≠ficos
            metodos_testar = [
                'processar_consulta_real',
                '_processar_comando_excel',
                '_processar_comando_desenvolvimento',
                '_is_excel_command',
                '_is_dev_command'
            ]
            
            metodos_funcionais = []
            for metodo in metodos_testar:
                if hasattr(sistema_atual, metodo):
                    metodos_funcionais.append(metodo)
                    print(f"   ‚úÖ M√©todo {metodo}: Presente")
                else:
                    print(f"   ‚ùå M√©todo {metodo}: Ausente")
            
            self.resultados['sistema_atual'] = {
                'inicializacao': True,
                'modulos_presentes': modulos_presentes,
                'modulos_funcionais': modulos_funcionais,
                'metodos_funcionais': metodos_funcionais,
                'total_modulos': len(modulos_funcionais),
                'modo_real': sistema_atual.modo_real,
                'client_ativo': sistema_atual.client is not None
            }
            
        except Exception as e:
            print(f"‚ùå ERRO SISTEMA ATUAL: {e}")
            self.resultados['sistema_atual'] = {'inicializacao': False, 'erro': str(e)}
            traceback.print_exc()
        
        # Sistema Novo
        print("\nüÜï SISTEMA NOVO:")
        try:
            from app.claude_ai_novo.core.claude_integration import ClaudeRealIntegration as ClaudeNovo
            sistema_novo = ClaudeNovo()
            
            # Lista de m√≥dulos do sistema novo
            modulos_novo = [
                'excel_commands',
                'database_loader',
                'conversation_context',
                'human_learning',
                'lifelong_learning',
                'suggestion_engine',
                'intention_analyzer',
                'query_analyzer',
                'redis_cache',
                'intelligent_cache',
                'client',
                'redis_disponivel'
            ]
            
            modulos_presentes_novo = []
            modulos_funcionais_novo = []
            
            for modulo in modulos_novo:
                presente = hasattr(sistema_novo, modulo)
                if presente:
                    obj = getattr(sistema_novo, modulo)
                    funcional = obj is not None
                    modulos_presentes_novo.append(modulo)
                    if funcional:
                        modulos_funcionais_novo.append(modulo)
                    print(f"   {'‚úÖ' if funcional else '‚ö†Ô∏è'} {modulo}: {'Funcional' if funcional else 'Presente mas None'}")
                else:
                    print(f"   ‚ùå {modulo}: Ausente")
            
            # Testar m√©todos espec√≠ficos do novo sistema
            metodos_novo = [
                'processar_consulta_real',
                '_analisar_intencao',
                '_recuperar_contexto_conversacional',
                '_verificar_cache_redis',
                '_aplicar_lifelong_learning'
            ]
            
            metodos_funcionais_novo = []
            for metodo in metodos_novo:
                if hasattr(sistema_novo, metodo):
                    metodos_funcionais_novo.append(metodo)
                    print(f"   ‚úÖ M√©todo {metodo}: Presente")
                else:
                    print(f"   ‚ùå M√©todo {metodo}: Ausente")
            
            self.resultados['sistema_novo'] = {
                'inicializacao': True,
                'modulos_presentes': modulos_presentes_novo,
                'modulos_funcionais': modulos_funcionais_novo,
                'metodos_funcionais': metodos_funcionais_novo,
                'total_modulos': len(modulos_funcionais_novo),
                'modo_real': sistema_novo.modo_real,
                'client_ativo': sistema_novo.client is not None
            }
            
        except Exception as e:
            print(f"‚ùå ERRO SISTEMA NOVO: {e}")
            self.resultados['sistema_novo'] = {'inicializacao': False, 'erro': str(e)}
            traceback.print_exc()
    
    def testar_funcionalidades_basicas(self):
        """Testa funcionalidades b√°sicas de consulta"""
        print("\nüìù TESTE 2: FUNCIONALIDADES B√ÅSICAS")
        print("-" * 60)
        
        for sistema_nome, sistema_key in [("ATUAL", "sistema_atual"), ("NOVO", "sistema_novo")]:
            print(f"\nü§ñ TESTANDO {sistema_nome}:")
            
            if not self.resultados[sistema_key].get('inicializacao', False):
                print("   ‚ùå Sistema n√£o inicializado - Pulando testes")
                continue
            
            try:
                if sistema_key == "sistema_atual":
                    from app.claude_ai.claude_real_integration import ClaudeRealIntegration
                    sistema = ClaudeRealIntegration()
                else:
                    from app.claude_ai_novo.core.claude_integration import ClaudeRealIntegration as ClaudeNovo
                    sistema = ClaudeNovo()
                
                resultados_consultas = {}
                
                for i, consulta in enumerate(self.consultas_basicas, 1):
                    print(f"   Teste {i}: {consulta[:40]}...")
                    
                    try:
                        inicio = time.time()
                        resposta = sistema.processar_consulta_real(consulta)
                        fim = time.time()
                        tempo = fim - inicio
                        
                        sucesso = (
                            len(resposta) > 20 and 
                            "erro" not in resposta.lower() and
                            "exception" not in resposta.lower()
                        )
                        
                        resultados_consultas[consulta] = {
                            'sucesso': sucesso,
                            'tempo_resposta': tempo,
                            'tamanho_resposta': len(resposta),
                            'contem_dados': any(palavra in resposta.lower() for palavra in ['total', 'quantidade', 'dados', 'registros'])
                        }
                        
                        print(f"      {'‚úÖ' if sucesso else '‚ùå'} {tempo:.2f}s - {len(resposta)} chars")
                        
                    except Exception as e:
                        resultados_consultas[consulta] = {
                            'sucesso': False,
                            'erro': str(e),
                            'tempo_resposta': 0
                        }
                        print(f"      ‚ùå ERRO: {str(e)[:50]}")
                
                self.resultados['testes_funcionais'][sistema_key] = resultados_consultas
                
            except Exception as e:
                print(f"   ‚ùå ERRO GERAL: {e}")
                self.resultados['testes_funcionais'][sistema_key] = {'erro': str(e)}
    
    def testar_funcionalidades_excel(self):
        """Testa funcionalidades espec√≠ficas de Excel"""
        print("\nüìä TESTE 3: FUNCIONALIDADES EXCEL")
        print("-" * 60)
        
        for sistema_nome, sistema_key in [("ATUAL", "sistema_atual"), ("NOVO", "sistema_novo")]:
            print(f"\nüìà TESTANDO EXCEL {sistema_nome}:")
            
            if not self.resultados[sistema_key].get('inicializacao', False):
                continue
            
            try:
                if sistema_key == "sistema_atual":
                    from app.claude_ai.claude_real_integration import ClaudeRealIntegration
                    sistema = ClaudeRealIntegration()
                else:
                    from app.claude_ai_novo.core.claude_integration import ClaudeRealIntegration as ClaudeNovo
                    sistema = ClaudeNovo()
                
                resultados_excel = {}
                
                for consulta in self.consultas_excel:
                    try:
                        # Testar detec√ß√£o de comando Excel
                        if hasattr(sistema, '_is_excel_command'):
                            eh_excel = sistema._is_excel_command(consulta)
                            print(f"   üìä Detec√ß√£o Excel: {'‚úÖ' if eh_excel else '‚ùå'} - {consulta[:30]}")
                        elif hasattr(sistema, 'excel_commands') and sistema.excel_commands:
                            eh_excel = sistema.excel_commands.is_excel_command(consulta)
                            print(f"   üìä Detec√ß√£o Excel: {'‚úÖ' if eh_excel else '‚ùå'} - {consulta[:30]}")
                        else:
                            eh_excel = False
                            print(f"   üìä Detec√ß√£o Excel: ‚ùå M√≥dulo n√£o encontrado - {consulta[:30]}")
                        
                        # Testar processamento
                        resposta = sistema.processar_consulta_real(consulta)
                        contem_excel = any(palavra in resposta.lower() for palavra in ['excel', 'planilha', '.xlsx', 'relat√≥rio'])
                        
                        resultados_excel[consulta] = {
                            'detectou_excel': eh_excel,
                            'resposta_contem_excel': contem_excel,
                            'processou_com_sucesso': len(resposta) > 20
                        }
                        
                    except Exception as e:
                        resultados_excel[consulta] = {
                            'erro': str(e),
                            'detectou_excel': False
                        }
                        print(f"   ‚ùå ERRO: {str(e)[:40]}")
                
                if 'testes_excel' not in self.resultados:
                    self.resultados['testes_excel'] = {}
                self.resultados['testes_excel'][sistema_key] = resultados_excel
                
            except Exception as e:
                print(f"   ‚ùå ERRO GERAL EXCEL: {e}")
    
    def testar_funcionalidades_nlp(self):
        """Testa funcionalidades de NLP"""
        print("\nüî¨ TESTE 4: FUNCIONALIDADES NLP")
        print("-" * 60)
        
        for sistema_nome, sistema_key in [("ATUAL", "sistema_atual"), ("NOVO", "sistema_novo")]:
            print(f"\nüß† TESTANDO NLP {sistema_nome}:")
            
            if not self.resultados[sistema_key].get('inicializacao', False):
                continue
            
            try:
                if sistema_key == "sistema_atual":
                    from app.claude_ai.claude_real_integration import ClaudeRealIntegration
                    sistema = ClaudeRealIntegration()
                else:
                    from app.claude_ai_novo.core.claude_integration import ClaudeRealIntegration as ClaudeNovo
                    sistema = ClaudeNovo()
                
                resultados_nlp = {}
                
                # Testar presen√ßa de analisadores NLP
                nlp_presente = False
                if hasattr(sistema, 'nlp_analyzer') and sistema.nlp_analyzer:
                    nlp_presente = True
                    print("   ‚úÖ NLP Analyzer: Presente e ativo")
                elif hasattr(sistema, 'intention_analyzer') and sistema.intention_analyzer:
                    nlp_presente = True
                    print("   ‚úÖ Intention Analyzer: Presente e ativo")
                else:
                    print("   ‚ùå Analisadores NLP: N√£o encontrados")
                
                # Testar consultas que requerem an√°lise inteligente
                for consulta in self.consultas_nlp:
                    try:
                        resposta = sistema.processar_consulta_real(consulta)
                        
                        # Verificar se a resposta demonstra an√°lise inteligente
                        palavras_analise = ['an√°lise', 'padr√£o', 'tend√™ncia', 'insight', 'conclus√£o', 'porque', 'indica']
                        tem_analise = any(palavra in resposta.lower() for palavra in palavras_analise)
                        
                        resultados_nlp[consulta] = {
                            'processou': len(resposta) > 20,
                            'demonstrou_analise': tem_analise,
                            'tamanho_resposta': len(resposta)
                        }
                        
                        print(f"   {'‚úÖ' if tem_analise else '‚ö†Ô∏è'} {consulta[:30]}... - {'An√°lise detectada' if tem_analise else 'Resposta simples'}")
                        
                    except Exception as e:
                        resultados_nlp[consulta] = {'erro': str(e)}
                        print(f"   ‚ùå ERRO: {str(e)[:40]}")
                
                if 'testes_nlp' not in self.resultados:
                    self.resultados['testes_nlp'] = {}
                self.resultados['testes_nlp'][sistema_key] = {
                    'nlp_presente': nlp_presente,
                    'resultados_consultas': resultados_nlp
                }
                
            except Exception as e:
                print(f"   ‚ùå ERRO GERAL NLP: {e}")
    
    def testar_contexto_conversacional(self):
        """Testa funcionalidades de contexto conversacional"""
        print("\nüó£Ô∏è TESTE 5: CONTEXTO CONVERSACIONAL")
        print("-" * 60)
        
        for sistema_nome, sistema_key in [("ATUAL", "sistema_atual"), ("NOVO", "sistema_novo")]:
            print(f"\nüí¨ TESTANDO CONTEXTO {sistema_nome}:")
            
            if not self.resultados[sistema_key].get('inicializacao', False):
                continue
            
            try:
                if sistema_key == "sistema_atual":
                    from app.claude_ai.claude_real_integration import ClaudeRealIntegration
                    sistema = ClaudeRealIntegration()
                else:
                    from app.claude_ai_novo.core.claude_integration import ClaudeRealIntegration as ClaudeNovo
                    sistema = ClaudeNovo()
                
                resultados_contexto = {}
                
                # Verificar se o sistema tem contexto conversacional
                tem_contexto = False
                if hasattr(sistema, 'conversation_context') and sistema.conversation_context:
                    tem_contexto = True
                    print("   ‚úÖ Conversation Context: Presente e ativo")
                else:
                    print("   ‚ùå Conversation Context: N√£o encontrado")
                
                # Testar conversas sequenciais
                for i, (pergunta1, pergunta2) in enumerate(self.consultas_contexto, 1):
                    try:
                        print(f"   Teste {i}: Conversa sequencial")
                        
                        # Primeira pergunta
                        resposta1 = sistema.processar_consulta_real(pergunta1)
                        print(f"      P1: {pergunta1}")
                        print(f"      R1: {resposta1[:50]}...")
                        
                        # Segunda pergunta (dependente do contexto)
                        resposta2 = sistema.processar_consulta_real(pergunta2)
                        print(f"      P2: {pergunta2}")
                        print(f"      R2: {resposta2[:50]}...")
                        
                        # Verificar se a segunda resposta mant√©m contexto
                        contextual = (
                            len(resposta2) > 20 and
                            "n√£o entendi" not in resposta2.lower() and
                            "mais espec√≠fico" not in resposta2.lower()
                        )
                        
                        resultados_contexto[f"conversa_{i}"] = {
                            'pergunta1': pergunta1,
                            'pergunta2': pergunta2,
                            'manteve_contexto': contextual,
                            'tamanho_resposta1': len(resposta1),
                            'tamanho_resposta2': len(resposta2)
                        }
                        
                        print(f"      {'‚úÖ' if contextual else '‚ùå'} Contexto {'mantido' if contextual else 'perdido'}")
                        
                    except Exception as e:
                        resultados_contexto[f"conversa_{i}"] = {'erro': str(e)}
                        print(f"      ‚ùå ERRO: {str(e)[:40]}")
                
                if 'testes_contexto' not in self.resultados:
                    self.resultados['testes_contexto'] = {}
                self.resultados['testes_contexto'][sistema_key] = {
                    'tem_contexto': tem_contexto,
                    'resultados_conversas': resultados_contexto
                }
                
            except Exception as e:
                print(f"   ‚ùå ERRO GERAL CONTEXTO: {e}")
    
    def testar_funcionalidades_desenvolvimento(self):
        """Testa funcionalidades de desenvolvimento/projeto"""
        print("\nüîß TESTE 6: FUNCIONALIDADES DESENVOLVIMENTO")
        print("-" * 60)
        
        for sistema_nome, sistema_key in [("ATUAL", "sistema_atual"), ("NOVO", "sistema_novo")]:
            print(f"\n‚öôÔ∏è TESTANDO DEV {sistema_nome}:")
            
            if not self.resultados[sistema_key].get('inicializacao', False):
                continue
            
            try:
                if sistema_key == "sistema_atual":
                    from app.claude_ai.claude_real_integration import ClaudeRealIntegration
                    sistema = ClaudeRealIntegration()
                else:
                    from app.claude_ai_novo.core.claude_integration import ClaudeRealIntegration as ClaudeNovo
                    sistema = ClaudeNovo()
                
                resultados_dev = {}
                
                # Verificar se tem funcionalidades de desenvolvimento
                tem_dev = False
                if hasattr(sistema, 'project_scanner') and sistema.project_scanner:
                    tem_dev = True
                    print("   ‚úÖ Project Scanner: Presente e ativo")
                elif hasattr(sistema, '_is_dev_command'):
                    tem_dev = True
                    print("   ‚úÖ Dev Commands: M√©todo presente")
                else:
                    print("   ‚ùå Funcionalidades Dev: N√£o encontradas")
                
                # Testar comandos de desenvolvimento
                for consulta in self.consultas_desenvolvimento:
                    try:
                        # Testar detec√ß√£o de comando dev
                        eh_dev = False
                        if hasattr(sistema, '_is_dev_command'):
                            eh_dev = sistema._is_dev_command(consulta)
                        
                        resposta = sistema.processar_consulta_real(consulta)
                        
                        # Verificar se a resposta cont√©m informa√ß√µes t√©cnicas
                        termos_tecnicos = ['class', 'def', 'import', 'function', 'module', 'arquivo', 'c√≥digo']
                        tem_info_tecnica = any(termo in resposta.lower() for termo in termos_tecnicos)
                        
                        resultados_dev[consulta] = {
                            'detectou_dev': eh_dev,
                            'tem_info_tecnica': tem_info_tecnica,
                            'processou_com_sucesso': len(resposta) > 20
                        }
                        
                        print(f"   {'‚úÖ' if tem_info_tecnica else '‚ö†Ô∏è'} {consulta[:30]}... - {'Info t√©cnica' if tem_info_tecnica else 'Resposta gen√©rica'}")
                        
                    except Exception as e:
                        resultados_dev[consulta] = {'erro': str(e)}
                        print(f"   ‚ùå ERRO: {str(e)[:40]}")
                
                if 'testes_dev' not in self.resultados:
                    self.resultados['testes_dev'] = {}
                self.resultados['testes_dev'][sistema_key] = {
                    'tem_funcionalidades_dev': tem_dev,
                    'resultados_comandos': resultados_dev
                }
                
            except Exception as e:
                print(f"   ‚ùå ERRO GERAL DEV: {e}")
    
    def testar_integracao_banco(self):
        """Testa integra√ß√£o com banco de dados"""
        print("\nüóÑÔ∏è TESTE 7: INTEGRA√á√ÉO BANCO DE DADOS")
        print("-" * 60)
        # Implementar testes de integra√ß√£o com banco
        # Por enquanto, placeholder
        self.resultados['testes_integracao'] = {'placeholder': True}
    
    def testar_performance(self):
        """Testa performance dos sistemas"""
        print("\n‚ö° TESTE 8: PERFORMANCE")
        print("-" * 60)
        
        consulta_teste = "Qual o status do sistema?"
        
        for sistema_nome, sistema_key in [("ATUAL", "sistema_atual"), ("NOVO", "sistema_novo")]:
            print(f"\nüèÉ TESTANDO PERFORMANCE {sistema_nome}:")
            
            if not self.resultados[sistema_key].get('inicializacao', False):
                continue
            
            try:
                if sistema_key == "sistema_atual":
                    from app.claude_ai.claude_real_integration import ClaudeRealIntegration
                    sistema = ClaudeRealIntegration()
                else:
                    from app.claude_ai_novo.core.claude_integration import ClaudeRealIntegration as ClaudeNovo
                    sistema = ClaudeNovo()
                
                tempos = []
                sucessos = 0
                
                for i in range(5):  # 5 execu√ß√µes para m√©dia
                    try:
                        inicio = time.time()
                        resposta = sistema.processar_consulta_real(consulta_teste)
                        fim = time.time()
                        tempo = fim - inicio
                        
                        tempos.append(tempo)
                        if len(resposta) > 10:
                            sucessos += 1
                        
                        print(f"   Execu√ß√£o {i+1}: {tempo:.3f}s")
                        
                    except Exception as e:
                        print(f"   Execu√ß√£o {i+1}: ERRO - {str(e)[:30]}")
                
                if tempos:
                    tempo_medio = sum(tempos) / len(tempos)
                    tempo_min = min(tempos)
                    tempo_max = max(tempos)
                    
                    print(f"   üìä M√©dia: {tempo_medio:.3f}s | Min: {tempo_min:.3f}s | Max: {tempo_max:.3f}s")
                    print(f"   ‚úÖ Taxa sucesso: {sucessos}/5 ({sucessos*20}%)")
                else:
                    tempo_medio = 0
                    sucessos = 0
                
                if 'performance' not in self.resultados:
                    self.resultados['performance'] = {}
                self.resultados['performance'][sistema_key] = {
                    'tempo_medio': tempo_medio,
                    'tempo_min': tempo_min if tempos else 0,
                    'tempo_max': tempo_max if tempos else 0,
                    'taxa_sucesso': sucessos / 5,
                    'execucoes_realizadas': len(tempos)
                }
                
            except Exception as e:
                print(f"   ‚ùå ERRO PERFORMANCE: {e}")
    
    def testar_recuperacao_erros(self):
        """Testa recupera√ß√£o de erros"""
        print("\nüö® TESTE 9: RECUPERA√á√ÉO DE ERROS")
        print("-" * 60)
        
        consultas_erro = [
            "",  # Consulta vazia
            "askdjaskdj askdja skdj",  # Consulta sem sentido
            "SELECT * FROM tabela_inexistente",  # Comando SQL inv√°lido
            "A" * 10000  # Consulta muito longa
        ]
        
        for sistema_nome, sistema_key in [("ATUAL", "sistema_atual"), ("NOVO", "sistema_novo")]:
            print(f"\n‚ö†Ô∏è TESTANDO ERROS {sistema_nome}:")
            
            if not self.resultados[sistema_key].get('inicializacao', False):
                continue
            
            try:
                if sistema_key == "sistema_atual":
                    from app.claude_ai.claude_real_integration import ClaudeRealIntegration
                    sistema = ClaudeRealIntegration()
                else:
                    from app.claude_ai_novo.core.claude_integration import ClaudeRealIntegration as ClaudeNovo
                    sistema = ClaudeNovo()
                
                recuperacao_erros = {}
                
                for i, consulta in enumerate(consultas_erro, 1):
                    try:
                        resposta = sistema.processar_consulta_real(consulta)
                        
                        # Verificar se o sistema se recuperou graciosamente
                        recuperou = (
                            len(resposta) > 5 and
                            "traceback" not in resposta.lower() and
                            "exception" not in resposta.lower()
                        )
                        
                        recuperacao_erros[f"erro_{i}"] = {
                            'recuperou_graciosamente': recuperou,
                            'tamanho_resposta': len(resposta)
                        }
                        
                        print(f"   Erro {i}: {'‚úÖ' if recuperou else '‚ùå'} {'Recupera√ß√£o OK' if recuperou else 'Erro exposto'}")
                        
                    except Exception as e:
                        recuperacao_erros[f"erro_{i}"] = {
                            'recuperou_graciosamente': False,
                            'excecao_lancada': str(e)
                        }
                        print(f"   Erro {i}: ‚ùå Exce√ß√£o lan√ßada")
                
                if 'recuperacao_erros' not in self.resultados:
                    self.resultados['recuperacao_erros'] = {}
                self.resultados['recuperacao_erros'][sistema_key] = recuperacao_erros
                
            except Exception as e:
                print(f"   ‚ùå ERRO GERAL: {e}")
    
    def comparar_sistemas_detalhado(self):
        """Compara sistemas de forma detalhada"""
        print("\n‚öñÔ∏è COMPARA√á√ÉO DETALHADA")
        print("-" * 60)
        
        atual = self.resultados.get('sistema_atual', {})
        novo = self.resultados.get('sistema_novo', {})
        
        comparacao = {
            'modulos': {
                'atual_total': atual.get('total_modulos', 0),
                'novo_total': novo.get('total_modulos', 0),
                'diferenca': atual.get('total_modulos', 0) - novo.get('total_modulos', 0)
            },
            'funcionalidades_unicas': {
                'apenas_atual': [],
                'apenas_novo': [],
                'ambos': []
            }
        }
        
        # Identificar funcionalidades √∫nicas
        modulos_atual = set(atual.get('modulos_funcionais', []))
        modulos_novo = set(novo.get('modulos_funcionais', []))
        
        comparacao['funcionalidades_unicas']['apenas_atual'] = list(modulos_atual - modulos_novo)
        comparacao['funcionalidades_unicas']['apenas_novo'] = list(modulos_novo - modulos_atual)
        comparacao['funcionalidades_unicas']['ambos'] = list(modulos_atual & modulos_novo)
        
        print(f"üìä M√ìDULOS FUNCIONAIS:")
        print(f"   Sistema Atual: {len(modulos_atual)} m√≥dulos")
        print(f"   Sistema Novo:  {len(modulos_novo)} m√≥dulos")
        print(f"   Diferen√ßa:     {len(modulos_atual) - len(modulos_novo):+d}")
        
        print(f"\nüîß FUNCIONALIDADES EXCLUSIVAS ATUAL:")
        for func in comparacao['funcionalidades_unicas']['apenas_atual']:
            print(f"   ‚ö° {func}")
        
        print(f"\nüÜï FUNCIONALIDADES EXCLUSIVAS NOVO:")
        for func in comparacao['funcionalidades_unicas']['apenas_novo']:
            print(f"   ‚ö° {func}")
        
        print(f"\nü§ù FUNCIONALIDADES EM AMBOS:")
        for func in comparacao['funcionalidades_unicas']['ambos']:
            print(f"   ‚úÖ {func}")
        
        self.resultados['comparacao_detalhada'] = comparacao
    
    def gerar_relatorio_completo(self, tempo_total: float):
        """Gera relat√≥rio completo dos testes"""
        print("\n" + "="*80)
        print("üìã RELAT√ìRIO COMPLETO - BATERIA INTENSIVA DE TESTES")
        print("="*80)
        
        print(f"\n‚è±Ô∏è ESTAT√çSTICAS GERAIS:")
        print(f"   Tempo total: {tempo_total:.1f} segundos")
        print(f"   Testes realizados: 9 categorias")
        print(f"   Data/Hora: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")
        
        # Resumo por sistema
        for sistema_nome, sistema_key in [("SISTEMA ATUAL", "sistema_atual"), ("SISTEMA NOVO", "sistema_novo")]:
            print(f"\nü§ñ {sistema_nome}:")
            
            dados = self.resultados.get(sistema_key, {})
            if dados.get('inicializacao', False):
                print(f"   ‚úÖ Inicializa√ß√£o: OK")
                print(f"   üîß M√≥dulos ativos: {dados.get('total_modulos', 0)}")
                print(f"   üåê Modo real: {dados.get('modo_real', False)}")
                print(f"   üíæ Client ativo: {dados.get('client_ativo', False)}")
            else:
                print(f"   ‚ùå Inicializa√ß√£o: FALHOU")
                print(f"   üö® Erro: {dados.get('erro', 'Desconhecido')}")
        
        # Performance
        perf_atual = self.resultados.get('performance', {}).get('sistema_atual', {})
        perf_novo = self.resultados.get('performance', {}).get('sistema_novo', {})
        
        print(f"\n‚ö° PERFORMANCE:")
        if perf_atual:
            print(f"   Sistema Atual: {perf_atual.get('tempo_medio', 0):.3f}s m√©dio")
        if perf_novo:
            print(f"   Sistema Novo:  {perf_novo.get('tempo_medio', 0):.3f}s m√©dio")
        
        # Recomenda√ß√£o final
        self.gerar_recomendacao_final()
        
        # Salvar resultados
        self.salvar_resultados_detalhados()
    
    def gerar_recomendacao_final(self):
        """Gera recomenda√ß√£o final baseada em todos os testes"""
        print(f"\nüéØ RECOMENDA√á√ÉO FINAL:")
        
        atual_ok = self.resultados.get('sistema_atual', {}).get('inicializacao', False)
        novo_ok = self.resultados.get('sistema_novo', {}).get('inicializacao', False)
        
        if atual_ok and novo_ok:
            modulos_atual = len(self.resultados.get('sistema_atual', {}).get('modulos_funcionais', []))
            modulos_novo = len(self.resultados.get('sistema_novo', {}).get('modulos_funcionais', []))
            
            if modulos_atual > modulos_novo:
                print("   üèÜ SISTEMA ATUAL tem mais funcionalidades ativas")
                print("   üí° RECOMENDA√á√ÉO: MANTER SISTEMA ATUAL")
            elif modulos_novo > modulos_atual:
                print("   üèÜ SISTEMA NOVO tem mais funcionalidades ativas")
                print("   üí° RECOMENDA√á√ÉO: MIGRAR PARA SISTEMA NOVO")
            else:
                print("   ‚öñÔ∏è SISTEMAS EQUIVALENTES em funcionalidades")
                print("   üí° RECOMENDA√á√ÉO: ESCOLHA BASEADA EM ARQUITETURA")
        elif atual_ok:
            print("   üèÜ APENAS SISTEMA ATUAL funcional")
            print("   üí° RECOMENDA√á√ÉO: MANTER SISTEMA ATUAL")
        elif novo_ok:
            print("   üèÜ APENAS SISTEMA NOVO funcional")
            print("   üí° RECOMENDA√á√ÉO: MIGRAR PARA SISTEMA NOVO")
        else:
            print("   üö® NENHUM SISTEMA funcional")
            print("   üí° RECOMENDA√á√ÉO: INVESTIGAR PROBLEMAS")
    
    def salvar_resultados_detalhados(self):
        """Salva resultados detalhados em arquivo"""
        with open('bateria_testes_claude_completa.json', 'w', encoding='utf-8') as f:
            json.dump(self.resultados, f, indent=2, ensure_ascii=False, default=str)
        
        print(f"\nüíæ Resultados detalhados salvos em: bateria_testes_claude_completa.json")

def main():
    """Fun√ß√£o principal"""
    print("üß™ BATERIA INTENSIVA DE TESTES - CLAUDE AI")
    print("üî¨ An√°lise cient√≠fica e detalhada dos sistemas")
    print("‚è±Ô∏è Tempo estimado: 10-15 minutos")
    print()
    input("Pressione ENTER para iniciar a bateria intensiva de testes...")
    
    bateria = BateriaTestesIntensiva()
    bateria.executar_bateria_completa()
    
    print("\nüéØ BATERIA DE TESTES CONCLU√çDA!")
    print("üìä Consulte bateria_testes_claude_completa.json para dados completos")

if __name__ == "__main__":
    main() 