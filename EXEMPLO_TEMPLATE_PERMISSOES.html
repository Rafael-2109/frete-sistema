<!-- 
EXEMPLO: Como usar o novo sistema de permissões nos templates
============================================================

Substitui as verificações antigas por sistema granular
-->

{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h1>Dashboard com Permissões Granulares</h1>
    
    <!-- ===== SISTEMA ANTIGO (não usar mais) ===== -->
    {% if current_user.perfil == 'administrador' %}
    <!-- PROBLEMA: Verificação hardcoded, inflexível -->
    <div class="alert alert-info">Área administrativa antiga</div>
    {% endif %}
    
    <!-- ===== SISTEMA NOVO (usar este) ===== -->
    
    <!-- 1. Verificação de Admin (compatibilidade) -->
    {% if user_is_admin() %}
    <div class="alert alert-success">
        <strong>🔑 Área Administrativa</strong>
        Você tem privilégios administrativos
    </div>
    {% endif %}
    
    <!-- 2. Verificação por Nível Hierárquico -->
    {% if user_level() >= 8 %}
    <div class="card border-warning mb-3">
        <div class="card-header">🎖️ Área Gerencial (Nível {{ user_level() }})</div>
        <div class="card-body">
            Conteúdo para gerentes e administradores
        </div>
    </div>
    {% endif %}
    
    <!-- 3. Permissões Granulares por Módulo/Função -->
    <div class="row">
        <!-- Card Faturamento -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">📊 Faturamento</div>
                <div class="card-body">
                    <!-- Visualizar sempre permitido para quem tem acesso -->
                    {% if user_can_access('faturamento', 'listar', 'visualizar') %}
                    <a href="/faturamento/" class="btn btn-outline-primary btn-sm">
                        📋 Ver Relatórios
                    </a>
                    {% endif %}
                    
                    <!-- Editar apenas para quem tem permissão -->
                    {% if user_can_access('faturamento', 'editar', 'editar') %}
                    <a href="/faturamento/editar" class="btn btn-warning btn-sm">
                        ✏️ Editar Dados
                    </a>
                    {% endif %}
                    
                    <!-- Importar apenas para níveis específicos -->
                    {% if user_can_access('faturamento', 'importar', 'editar') %}
                    <a href="/faturamento/importar" class="btn btn-success btn-sm">
                        📤 Importar Odoo
                    </a>
                    {% endif %}
                    
                    <!-- Se não tem nenhum acesso -->
                    {% if not user_can_access('faturamento', 'listar', 'visualizar') %}
                    <p class="text-muted">
                        <i class="fas fa-lock"></i> Acesso restrito
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Card Carteira -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">🛒 Carteira de Pedidos</div>
                <div class="card-body">
                    {% if user_can_access('carteira', 'listar', 'visualizar') %}
                    <a href="/carteira/" class="btn btn-outline-primary btn-sm">
                        📋 Ver Pedidos
                    </a>
                    {% endif %}
                    
                    {% if user_can_access('carteira', 'separacao', 'editar') %}
                    <a href="/carteira/separacoes" class="btn btn-info btn-sm">
                        📦 Gerenciar Separações
                    </a>
                    {% endif %}
                    
                    {% if user_can_access('carteira', 'expedicao', 'editar') %}
                    <a href="/carteira/expedicoes" class="btn btn-success btn-sm">
                        🚚 Controlar Expedições
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Card Estoque -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">📦 Estoque</div>
                <div class="card-body">
                    {% if user_can_access('estoque', 'listar', 'visualizar') %}
                    <a href="/estoque/" class="btn btn-outline-primary btn-sm">
                        📊 Ver Movimentações
                    </a>
                    {% endif %}
                    
                    {% if user_can_access('estoque', 'ajustar', 'editar') %}
                    <a href="/estoque/ajustes" class="btn btn-warning btn-sm">
                        ⚖️ Ajustar Estoque
                    </a>
                    {% endif %}
                    
                    {% if user_can_access('estoque', 'relatorio', 'visualizar') %}
                    <a href="/estoque/relatorios" class="btn btn-info btn-sm">
                        📈 Relatórios
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- 4. Área Administrativa Completa -->
    {% if user_level() >= 9 %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    🔧 Painel Administrativo (Nível {{ user_level() }})
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if user_can_access('admin', 'usuarios', 'editar') %}
                        <div class="col-md-3">
                            <a href="/auth/usuarios" class="btn btn-outline-danger btn-block">
                                👥 Gerenciar Usuários
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if user_can_access('admin', 'permissoes', 'editar') %}
                        <div class="col-md-3">
                            <a href="/admin/permissions/" class="btn btn-outline-danger btn-block">
                                🔐 Gerenciar Permissões
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if user_can_access('admin', 'sistema', 'editar') %}
                        <div class="col-md-3">
                            <a href="/admin/sistema" class="btn btn-outline-danger btn-block">
                                ⚙️ Configurações Sistema
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if user_can_access('claude_ai', 'configurar', 'editar') %}
                        <div class="col-md-3">
                            <a href="/claude-ai/config" class="btn btn-outline-danger btn-block">
                                🤖 Configurar Claude AI
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 5. Informações de Debug (apenas para admins) -->
    {% if user_is_admin() %}
    <div class="mt-4">
        <div class="card">
            <div class="card-header">🐛 Debug - Informações do Usuário</div>
            <div class="card-body">
                <ul>
                    <li><strong>Nome:</strong> {{ current_user.nome }}</li>
                    <li><strong>Perfil Antigo:</strong> {{ current_user.perfil }}</li>
                    <li><strong>Nível Hierárquico:</strong> {{ user_level() }}</li>
                    <li><strong>É Admin:</strong> {{ user_is_admin() }}</li>
                    <li><strong>Data Login:</strong> {{ moment(current_user.ultimo_login).format('DD/MM/YYYY HH:mm') }}</li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}
    
</div>

<!-- JavaScript para demonstrar chamadas AJAX com permissões -->
<script>
// Exemplo: Verificar permissão via AJAX antes de ação
function verificarPermissaoEExecutar(modulo, funcao, nivel, callback) {
    // Esta seria uma implementação via AJAX
    fetch('/api/check-permission', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            modulo: modulo,
            funcao: funcao,
            nivel: nivel
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.tem_permissao) {
            callback();
        } else {
            alert('Você não tem permissão para esta ação.');
        }
    });
}

// Exemplo de uso
function editarFaturamento() {
    verificarPermissaoEExecutar('faturamento', 'editar', 'editar', function() {
        // Executar ação apenas se tem permissão
        window.location.href = '/faturamento/editar';
    });
}
</script>
{% endblock %}