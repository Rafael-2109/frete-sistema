<!-- 
EXEMPLO: Como usar o novo sistema de permissÃµes nos templates
============================================================

Substitui as verificaÃ§Ãµes antigas por sistema granular
-->

{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h1>Dashboard com PermissÃµes Granulares</h1>
    
    <!-- ===== SISTEMA ANTIGO (nÃ£o usar mais) ===== -->
    {% if current_user.perfil == 'administrador' %}
    <!-- PROBLEMA: VerificaÃ§Ã£o hardcoded, inflexÃ­vel -->
    <div class="alert alert-info">Ãrea administrativa antiga</div>
    {% endif %}
    
    <!-- ===== SISTEMA NOVO (usar este) ===== -->
    
    <!-- 1. VerificaÃ§Ã£o de Admin (compatibilidade) -->
    {% if user_is_admin() %}
    <div class="alert alert-success">
        <strong>ğŸ”‘ Ãrea Administrativa</strong>
        VocÃª tem privilÃ©gios administrativos
    </div>
    {% endif %}
    
    <!-- 2. VerificaÃ§Ã£o por NÃ­vel HierÃ¡rquico -->
    {% if user_level() >= 8 %}
    <div class="card border-warning mb-3">
        <div class="card-header">ğŸ–ï¸ Ãrea Gerencial (NÃ­vel {{ user_level() }})</div>
        <div class="card-body">
            ConteÃºdo para gerentes e administradores
        </div>
    </div>
    {% endif %}
    
    <!-- 3. PermissÃµes Granulares por MÃ³dulo/FunÃ§Ã£o -->
    <div class="row">
        <!-- Card Faturamento -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">ğŸ“Š Faturamento</div>
                <div class="card-body">
                    <!-- Visualizar sempre permitido para quem tem acesso -->
                    {% if user_can_access('faturamento', 'listar', 'visualizar') %}
                    <a href="/faturamento/" class="btn btn-outline-primary btn-sm">
                        ğŸ“‹ Ver RelatÃ³rios
                    </a>
                    {% endif %}
                    
                    <!-- Editar apenas para quem tem permissÃ£o -->
                    {% if user_can_access('faturamento', 'editar', 'editar') %}
                    <a href="/faturamento/editar" class="btn btn-warning btn-sm">
                        âœï¸ Editar Dados
                    </a>
                    {% endif %}
                    
                    <!-- Importar apenas para nÃ­veis especÃ­ficos -->
                    {% if user_can_access('faturamento', 'importar', 'editar') %}
                    <a href="/faturamento/importar" class="btn btn-success btn-sm">
                        ğŸ“¤ Importar Odoo
                    </a>
                    {% endif %}
                    
                    <!-- Se nÃ£o tem nenhum acesso -->
                    {% if not user_can_access('faturamento', 'listar', 'visualizar') %}
                    <p class="text-muted">
                        <i class="fas fa-lock"></i> Acesso restrito
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Card Carteira -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">ğŸ›’ Carteira de Pedidos</div>
                <div class="card-body">
                    {% if user_can_access('carteira', 'listar', 'visualizar') %}
                    <a href="/carteira/" class="btn btn-outline-primary btn-sm">
                        ğŸ“‹ Ver Pedidos
                    </a>
                    {% endif %}
                    
                    {% if user_can_access('carteira', 'separacao', 'editar') %}
                    <a href="/carteira/separacoes" class="btn btn-info btn-sm">
                        ğŸ“¦ Gerenciar SeparaÃ§Ãµes
                    </a>
                    {% endif %}
                    
                    {% if user_can_access('carteira', 'expedicao', 'editar') %}
                    <a href="/carteira/expedicoes" class="btn btn-success btn-sm">
                        ğŸšš Controlar ExpediÃ§Ãµes
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Card Estoque -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">ğŸ“¦ Estoque</div>
                <div class="card-body">
                    {% if user_can_access('estoque', 'listar', 'visualizar') %}
                    <a href="/estoque/" class="btn btn-outline-primary btn-sm">
                        ğŸ“Š Ver MovimentaÃ§Ãµes
                    </a>
                    {% endif %}
                    
                    {% if user_can_access('estoque', 'ajustar', 'editar') %}
                    <a href="/estoque/ajustes" class="btn btn-warning btn-sm">
                        âš–ï¸ Ajustar Estoque
                    </a>
                    {% endif %}
                    
                    {% if user_can_access('estoque', 'relatorio', 'visualizar') %}
                    <a href="/estoque/relatorios" class="btn btn-info btn-sm">
                        ğŸ“ˆ RelatÃ³rios
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- 4. Ãrea Administrativa Completa -->
    {% if user_level() >= 9 %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    ğŸ”§ Painel Administrativo (NÃ­vel {{ user_level() }})
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if user_can_access('admin', 'usuarios', 'editar') %}
                        <div class="col-md-3">
                            <a href="/auth/usuarios" class="btn btn-outline-danger btn-block">
                                ğŸ‘¥ Gerenciar UsuÃ¡rios
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if user_can_access('admin', 'permissoes', 'editar') %}
                        <div class="col-md-3">
                            <a href="/admin/permissions/" class="btn btn-outline-danger btn-block">
                                ğŸ” Gerenciar PermissÃµes
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if user_can_access('admin', 'sistema', 'editar') %}
                        <div class="col-md-3">
                            <a href="/admin/sistema" class="btn btn-outline-danger btn-block">
                                âš™ï¸ ConfiguraÃ§Ãµes Sistema
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if user_can_access('claude_ai', 'configurar', 'editar') %}
                        <div class="col-md-3">
                            <a href="/claude-ai/config" class="btn btn-outline-danger btn-block">
                                ğŸ¤– Configurar Claude AI
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 5. InformaÃ§Ãµes de Debug (apenas para admins) -->
    {% if user_is_admin() %}
    <div class="mt-4">
        <div class="card">
            <div class="card-header">ğŸ› Debug - InformaÃ§Ãµes do UsuÃ¡rio</div>
            <div class="card-body">
                <ul>
                    <li><strong>Nome:</strong> {{ current_user.nome }}</li>
                    <li><strong>Perfil Antigo:</strong> {{ current_user.perfil }}</li>
                    <li><strong>NÃ­vel HierÃ¡rquico:</strong> {{ user_level() }}</li>
                    <li><strong>Ã‰ Admin:</strong> {{ user_is_admin() }}</li>
                    <li><strong>Data Login:</strong> {{ moment(current_user.ultimo_login).format('DD/MM/YYYY HH:mm') }}</li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}
    
</div>

<!-- JavaScript para demonstrar chamadas AJAX com permissÃµes -->
<script>
// Exemplo: Verificar permissÃ£o via AJAX antes de aÃ§Ã£o
function verificarPermissaoEExecutar(modulo, funcao, nivel, callback) {
    // Esta seria uma implementaÃ§Ã£o via AJAX
    fetch('/api/check-permission', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            modulo: modulo,
            funcao: funcao,
            nivel: nivel
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.tem_permissao) {
            callback();
        } else {
            alert('VocÃª nÃ£o tem permissÃ£o para esta aÃ§Ã£o.');
        }
    });
}

// Exemplo de uso
function editarFaturamento() {
    verificarPermissaoEExecutar('faturamento', 'editar', 'editar', function() {
        // Executar aÃ§Ã£o apenas se tem permissÃ£o
        window.location.href = '/faturamento/editar';
    });
}
</script>
{% endblock %}