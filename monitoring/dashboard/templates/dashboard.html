<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Frete Sistema - Monitoring Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        
        .header {
            background-color: #1a1a2e;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .metric-card h3 {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 600;
            color: #1a1a2e;
        }
        
        .metric-unit {
            font-size: 0.875rem;
            color: #999;
            margin-left: 0.25rem;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .chart-container h2 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .alerts-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .alerts-container h2 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .alert-item {
            padding: 0.75rem 1rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-critical {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .alert-timestamp {
            font-size: 0.75rem;
            color: #666;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-healthy {
            background-color: #28a745;
        }
        
        .status-warning {
            background-color: #ffc107;
        }
        
        .status-critical {
            background-color: #dc3545;
        }
        
        .user-activity {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .activity-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
            font-size: 0.875rem;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>MCP Frete Sistema - Monitoring Dashboard</h1>
    </div>
    
    <div class="container">
        <!-- Real-time Metrics -->
        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card">
                <h3>CPU Usage</h3>
                <div class="metric-value" id="cpuUsage">
                    <span class="loading">Loading...</span>
                </div>
            </div>
            
            <div class="metric-card">
                <h3>Memory Usage</h3>
                <div class="metric-value" id="memoryUsage">
                    <span class="loading">Loading...</span>
                </div>
            </div>
            
            <div class="metric-card">
                <h3>Disk Usage</h3>
                <div class="metric-value" id="diskUsage">
                    <span class="loading">Loading...</span>
                </div>
            </div>
            
            <div class="metric-card">
                <h3>API Requests</h3>
                <div class="metric-value" id="apiRequests">
                    <span class="loading">Loading...</span>
                </div>
            </div>
            
            <div class="metric-card">
                <h3>Error Rate</h3>
                <div class="metric-value" id="errorRate">
                    <span class="loading">Loading...</span>
                </div>
            </div>
            
            <div class="metric-card">
                <h3>Cache Hit Rate</h3>
                <div class="metric-value" id="cacheHitRate">
                    <span class="loading">Loading...</span>
                </div>
            </div>
            
            <div class="metric-card">
                <h3>DB Connections</h3>
                <div class="metric-value" id="dbConnections">
                    <span class="loading">Loading...</span>
                </div>
            </div>
            
            <div class="metric-card">
                <h3>Active Users</h3>
                <div class="metric-value" id="activeUsers">
                    <span class="loading">Loading...</span>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <h2>System Performance</h2>
                <canvas id="performanceChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>API Metrics</h2>
                <canvas id="apiChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>Database Performance</h2>
                <canvas id="dbChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>Cache Performance</h2>
                <canvas id="cacheChart"></canvas>
            </div>
        </div>
        
        <!-- Alerts -->
        <div class="alerts-container">
            <h2>Recent Alerts</h2>
            <div id="alertsList">
                <p class="loading">No alerts</p>
            </div>
        </div>
        
        <!-- User Activity -->
        <div class="user-activity">
            <h2>User Activity</h2>
            <div class="activity-list" id="activityList">
                <p class="loading">Loading activity...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Chart configurations
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Value'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        };
        
        // Initialize charts
        const performanceChart = new Chart(document.getElementById('performanceChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'CPU %',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    },
                    {
                        label: 'Memory %',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }
                ]
            },
            options: chartOptions
        });
        
        const apiChart = new Chart(document.getElementById('apiChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Requests/min',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        tension: 0.1
                    },
                    {
                        label: 'Errors/min',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }
                ]
            },
            options: chartOptions
        });
        
        const dbChart = new Chart(document.getElementById('dbChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Query Count',
                        data: [],
                        borderColor: 'rgb(153, 102, 255)',
                        tension: 0.1
                    },
                    {
                        label: 'Avg Duration (ms)',
                        data: [],
                        borderColor: 'rgb(255, 159, 64)',
                        tension: 0.1
                    }
                ]
            },
            options: chartOptions
        });
        
        const cacheChart = new Chart(document.getElementById('cacheChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Hit Rate %',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }
                ]
            },
            options: chartOptions
        });
        
        // Update metric cards
        function updateMetricCard(id, value, unit = '') {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = `${value.toFixed(1)}<span class="metric-unit">${unit}</span>`;
            }
        }
        
        // Handle real-time metrics updates
        socket.on('metrics_update', (data) => {
            updateMetricCard('cpuUsage', data.cpu_usage, '%');
            updateMetricCard('memoryUsage', data.memory_usage, '%');
            updateMetricCard('diskUsage', data.disk_usage, '%');
            
            // Update performance chart
            const timestamp = new Date(data.timestamp).toLocaleTimeString();
            
            performanceChart.data.labels.push(timestamp);
            performanceChart.data.datasets[0].data.push(data.cpu_usage);
            performanceChart.data.datasets[1].data.push(data.memory_usage);
            
            // Keep only last 20 data points
            if (performanceChart.data.labels.length > 20) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            
            performanceChart.update('none');
        });
        
        // Handle alerts
        socket.on('alert', (alert) => {
            const alertsList = document.getElementById('alertsList');
            const alertClass = alert.level === 'critical' ? 'alert-critical' : 'alert-warning';
            const statusClass = alert.level === 'critical' ? 'status-critical' : 'status-warning';
            
            const alertElement = document.createElement('div');
            alertElement.className = `alert-item ${alertClass}`;
            alertElement.innerHTML = `
                <div>
                    <span class="status-indicator ${statusClass}"></span>
                    ${alert.message}
                </div>
                <span class="alert-timestamp">${new Date(alert.timestamp).toLocaleTimeString()}</span>
            `;
            
            // Remove "no alerts" message if present
            const noAlerts = alertsList.querySelector('.loading');
            if (noAlerts) {
                noAlerts.remove();
            }
            
            // Add new alert at the top
            alertsList.insertBefore(alertElement, alertsList.firstChild);
            
            // Keep only last 10 alerts
            while (alertsList.children.length > 10) {
                alertsList.removeChild(alertsList.lastChild);
            }
        });
        
        // Fetch current metrics periodically
        function fetchCurrentMetrics() {
            fetch('/api/metrics/current')
                .then(response => response.json())
                .then(data => {
                    updateMetricCard('apiRequests', data.api_requests || 0, '/min');
                    updateMetricCard('errorRate', data.error_rate || 0, '%');
                    updateMetricCard('cacheHitRate', data.cache_hit_rate || 0, '%');
                    updateMetricCard('dbConnections', data.db_connections || 0, '');
                });
        }
        
        // Fetch user activity
        function fetchUserActivity() {
            fetch('/api/user/activity')
                .then(response => response.json())
                .then(data => {
                    updateMetricCard('activeUsers', data.active_users || 0, '');
                    
                    const activityList = document.getElementById('activityList');
                    if (data.recent_actions && data.recent_actions.length > 0) {
                        activityList.innerHTML = data.recent_actions.map(action => `
                            <div class="activity-item">
                                <strong>${action.user || 'Anonymous'}</strong> - ${action.action || 'Unknown action'}
                                <span class="alert-timestamp">${new Date(action.timestamp).toLocaleTimeString()}</span>
                            </div>
                        `).join('');
                    } else {
                        activityList.innerHTML = '<p class="loading">No recent activity</p>';
                    }
                });
        }
        
        // Fetch historical data for charts
        function fetchHistoricalData() {
            // API metrics
            fetch('/api/metrics/api_requests?limit=20')
                .then(response => response.json())
                .then(data => {
                    apiChart.data.labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
                    apiChart.data.datasets[0].data = data.map(d => d.value);
                    apiChart.update('none');
                });
            
            fetch('/api/metrics/api_errors?limit=20')
                .then(response => response.json())
                .then(data => {
                    apiChart.data.datasets[1].data = data.map(d => d.value);
                    apiChart.update('none');
                });
            
            // Database metrics
            fetch('/api/metrics/db_query_count?limit=20')
                .then(response => response.json())
                .then(data => {
                    dbChart.data.labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
                    dbChart.data.datasets[0].data = data.map(d => d.value);
                    dbChart.update('none');
                });
            
            fetch('/api/metrics/db_query_avg_duration?limit=20')
                .then(response => response.json())
                .then(data => {
                    dbChart.data.datasets[1].data = data.map(d => d.value * 1000); // Convert to ms
                    dbChart.update('none');
                });
            
            // Cache metrics
            fetch('/api/metrics/cache_hit_rate?limit=20')
                .then(response => response.json())
                .then(data => {
                    cacheChart.data.labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
                    cacheChart.data.datasets[0].data = data.map(d => d.value);
                    cacheChart.update('none');
                });
        }
        
        // Initialize
        socket.on('connect', () => {
            console.log('Connected to monitoring dashboard');
            fetchCurrentMetrics();
            fetchUserActivity();
            fetchHistoricalData();
        });
        
        // Periodic updates
        setInterval(fetchCurrentMetrics, 5000);
        setInterval(fetchUserActivity, 10000);
        setInterval(fetchHistoricalData, 30000);
    </script>
</body>
</html>