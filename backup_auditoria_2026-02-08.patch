diff --git a/.claude/references/INDEX.md b/.claude/references/INDEX.md
index 6350ec52..3899467b 100644
--- a/.claude/references/INDEX.md
+++ b/.claude/references/INDEX.md
@@ -1,7 +1,6 @@
 # Indice de Referencias
 
-**Ultima atualizacao**: 06/02/2026
-**Gerado por**: Reestruturacao arquitetural
+**Ultima atualizacao**: 08/02/2026
 
 ---
 
@@ -19,6 +18,8 @@
 | Margem e Custeio (formula margem, tabelas de custo) | [negocio/MARGEM_CUSTEIO.md](negocio/MARGEM_CUSTEIO.md) |
 | Recebimento de materiais | [negocio/RECEBIMENTO_MATERIAIS.md](negocio/RECEBIMENTO_MATERIAIS.md) |
 | Historico de decisoes | [negocio/historia_nacom.md](negocio/historia_nacom.md) |
+| **Routing de skills** | [ROUTING_SKILLS.md](ROUTING_SKILLS.md) |
+| **Infraestrutura Render** | [INFRAESTRUTURA.md](INFRAESTRUTURA.md) |
 
 ---
 
@@ -43,29 +44,16 @@
 
 ---
 
-## Roadmaps
+## Planejamento (fora de references ‚Äî nao operacional)
 
-| Documento | Descricao |
-|-----------|-----------|
-| [roadmaps/FEATURES_AGENTE.md](roadmaps/FEATURES_AGENTE.md) | Features futuras do Agente Logistico |
-| [roadmaps/IMPLEMENTACAO_ODOO.md](roadmaps/IMPLEMENTACAO_ODOO.md) | Status de implementacao Odoo |
-
----
-
-## Cookbooks (Exemplos Anthropic)
-
-Em [cookbooks/](cookbooks/):
-- `BUILDING_EVALS.md` - Construcao de avaliacoes
-- `CONTEXT_COMPACTION.md` - Compactacao de contexto
-- `METAPROMPT.md` - Meta-prompts
-- `PROMPT_CACHING.md` - Cache de prompts
+Roadmaps e planejamento futuro foram movidos para `.planning/roadmaps/`:
+- `FEATURES_AGENTE.md` ‚Äî Features futuras do Agente Logistico
+- `IMPLEMENTACAO_ODOO.md` ‚Äî Status de implementacao Odoo
 
 ---
 
 ## Mapeamento Skill -> References
 
-Quais references cada skill consome:
-
 | Skill | References Utilizadas |
 |-------|----------------------|
 | `validacao-nf-po` | odoo/PIPELINE_RECEBIMENTO, odoo/GOTCHAS, odoo/IDS_FIXOS |
@@ -78,18 +66,3 @@ Quais references cada skill consome:
 | `descobrindo-odoo-estrutura` | odoo/MODELOS_CAMPOS |
 | `gerindo-expedicao` | modelos/REGRAS_CARTEIRA_SEPARACAO, negocio/REGRAS_NEGOCIO |
 | `frontend-design` | design/MAPEAMENTO_CORES |
-
----
-
-## Skills por Dominio
-
-### Agente Web (Render/Producao)
-- `gerindo-expedicao` - Consultas logisticas, estoque, separacoes
-- `memoria-usuario` - Memoria persistente entre sessoes
-
-### Claude Code (Desenvolvimento)
-- Odoo: rastreando-odoo, executando-odoo-financeiro, descobrindo-odoo-estrutura, integracao-odoo, validacao-nf-po, conciliando-odoo-po, recebimento-fisico-odoo, razao-geral-odoo
-- Dev: frontend-design, skill_creator, ralph-wiggum, prd-generator
-
-### Compartilhados (ambos dominios)
-- `exportando-arquivos`, `lendo-arquivos`
diff --git a/.claude/references/cookbooks/BUILDING_EVALS.md b/.claude/references/cookbooks/BUILDING_EVALS.md
deleted file mode 100644
index f6660d1d..00000000
--- a/.claude/references/cookbooks/BUILDING_EVALS.md
+++ /dev/null
@@ -1,335 +0,0 @@
-# Guia de Building Evals (Avalia√ß√µes)
-
-**Fonte:** [claude-cookbooks/misc/building_evals.ipynb](https://github.com/anthropics/claude-cookbooks/blob/main/misc/building_evals.ipynb)
-
-## O Que S√£o Evals
-
-Evals s√£o sistemas de avalia√ß√£o para medir a qualidade das respostas de Claude em tarefas espec√≠ficas. Permitem:
-
-- Testar prompts antes de produ√ß√£o
-- Comparar diferentes abordagens
-- Garantir consist√™ncia de qualidade
-- Identificar casos de falha
-
-## Componentes de uma Eval
-
-| Componente | Descri√ß√£o |
-|------------|-----------|
-| **Input Prompt** | O que √© enviado para Claude (com vari√°veis) |
-| **Model Output** | Resposta gerada por Claude |
-| **Golden Answer** | Resposta de refer√™ncia (esperada) |
-| **Score** | Resultado da avalia√ß√£o (correto/incorreto, 0-100, etc) |
-
-## Tr√™s M√©todos de Grading
-
-### 1. Code-based Grading (Melhor para tarefas determin√≠sticas)
-
-Usa string matching, regex, ou valida√ß√£o program√°tica.
-
-```python
-def grade_completion(output: str, golden_answer: str) -> bool:
-    """Avalia se output corresponde √† resposta esperada."""
-    return output.strip().lower() == golden_answer.strip().lower()
-
-# Exemplo: Quantas pernas tem um animal?
-eval_cases = [
-    {"input": "humano", "golden": "2"},
-    {"input": "cobra", "golden": "0"},
-    {"input": "cachorro", "golden": "4"},
-]
-
-for case in eval_cases:
-    output = get_claude_response(f"Quantas pernas tem um {case['input']}?")
-    score = grade_completion(output, case["golden"])
-    print(f"{case['input']}: {'‚úì' if score else '‚úó'}")
-```
-
-**Vantagens:** R√°pido, confi√°vel, barato
-**Limita√ß√µes:** S√≥ funciona para outputs determin√≠sticos
-
-### 2. Model-based Grading (Melhor para tarefas abertas)
-
-Claude avalia suas pr√≥prias respostas usando um prompt de avalia√ß√£o.
-
-```python
-GRADER_PROMPT = """
-Voc√™ √© um avaliador de qualidade. Compare a resposta com a rubrica.
-
-<answer>
-{answer}
-</answer>
-
-<rubric>
-{rubric}
-</rubric>
-
-Avalie se a resposta atende √† rubrica.
-Retorne sua avalia√ß√£o em <correctness>correct</correctness> ou
-<correctness>incorrect</correctness>.
-"""
-
-def grade_with_model(output: str, rubric: str) -> str:
-    response = client.messages.create(
-        model="claude-sonnet-4-5",
-        max_tokens=1000,
-        messages=[{
-            "role": "user",
-            "content": GRADER_PROMPT.format(answer=output, rubric=rubric)
-        }]
-    )
-
-    # Extrair resultado
-    import re
-    match = re.search(r"<correctness>(.*?)</correctness>", response.content[0].text)
-    return match.group(1).strip() if match else "unknown"
-```
-
-**Vantagens:** Funciona para qualquer tarefa
-**Limita√ß√µes:** Mais lento, pode ter variabilidade
-
-### 3. Human Grading (√öltima op√ß√£o)
-
-Avalia√ß√£o manual por humanos. Use apenas quando necess√°rio.
-
-```python
-# Golden answer formatada como rubrica para humano
-golden_answer = """
-A resposta deve incluir:
-‚úì Plano de treino com >50 repeti√ß√µes
-‚úì Exerc√≠cios de pernas especificados
-‚úì Divis√£o por dia da semana
-‚úó N√ÉO deve incluir exerc√≠cios de bra√ßo
-"""
-```
-
-**Vantagens:** Funciona para qualquer coisa
-**Desvantagens:** Lento, caro, inconsistente
-
-## Implementa√ß√£o Completa
-
-### Estrutura do Eval
-
-```python
-from dataclasses import dataclass
-from typing import Callable
-
-@dataclass
-class EvalCase:
-    """Um caso de teste para avalia√ß√£o."""
-    input_vars: dict        # Vari√°veis para preencher o prompt
-    golden_answer: str      # Resposta esperada ou rubrica
-    tags: list[str] = None  # Categorias para an√°lise
-
-@dataclass
-class EvalResult:
-    """Resultado de uma avalia√ß√£o."""
-    case: EvalCase
-    output: str
-    score: bool | float
-    grading_method: str
-
-class PromptEvaluator:
-    """Framework de avalia√ß√£o de prompts."""
-
-    def __init__(self, prompt_template: str, grader: Callable):
-        self.prompt_template = prompt_template
-        self.grader = grader
-        self.results: list[EvalResult] = []
-
-    def run_eval(self, cases: list[EvalCase]) -> dict:
-        """Executa avalia√ß√£o em todos os casos."""
-        for case in cases:
-            # Preenche template
-            prompt = self.prompt_template.format(**case.input_vars)
-
-            # Obt√©m resposta
-            output = self._get_response(prompt)
-
-            # Avalia
-            score = self.grader(output, case.golden_answer)
-
-            self.results.append(EvalResult(
-                case=case,
-                output=output,
-                score=score,
-                grading_method=self.grader.__name__
-            ))
-
-        return self._calculate_metrics()
-
-    def _calculate_metrics(self) -> dict:
-        """Calcula m√©tricas agregadas."""
-        total = len(self.results)
-        correct = sum(1 for r in self.results if r.score)
-
-        return {
-            "total": total,
-            "correct": correct,
-            "accuracy": correct / total if total > 0 else 0,
-            "failed_cases": [r for r in self.results if not r.score]
-        }
-```
-
-## Aplica√ß√£o no Frete Sistema
-
-### Eval para Skill de Prioriza√ß√£o
-
-```python
-PRIORIZACAO_CASES = [
-    EvalCase(
-        input_vars={
-            "pedido": "VCD123",
-            "cliente": "ATACADAO",
-            "valor": 150000,
-            "data_entrega": "2024-12-15",
-            "estoque_disponivel": True
-        },
-        golden_answer="P4",  # Atacad√£o = P4
-        tags=["atacadao", "com_estoque"]
-    ),
-    EvalCase(
-        input_vars={
-            "pedido": "VCD456",
-            "tipo": "FOB",
-            "estoque_parcial": True
-        },
-        golden_answer="AGUARDAR_COMPLETO",  # FOB sempre completo
-        tags=["fob", "parcial"]
-    ),
-]
-
-def grade_priorizacao(output: str, golden: str) -> bool:
-    """Avalia se a prioriza√ß√£o est√° correta."""
-    return golden.lower() in output.lower()
-
-# Executar eval
-evaluator = PromptEvaluator(
-    prompt_template=PRIORIZACAO_PROMPT,
-    grader=grade_priorizacao
-)
-results = evaluator.run_eval(PRIORIZACAO_CASES)
-print(f"Acur√°cia: {results['accuracy']:.1%}")
-```
-
-### Eval para Comunica√ß√£o com PCP
-
-```python
-PCP_RUBRIC = """
-A mensagem para PCP deve conter:
-1. Sauda√ß√£o inicial
-2. Lista de PRODUTOS (n√£o pedidos) com falta
-3. Para cada produto:
-   - Demanda total
-   - Estoque atual
-   - Quantidade faltante
-   - Pedidos afetados
-4. Pergunta sobre previs√£o de produ√ß√£o
-5. Tom profissional
-"""
-
-PCP_CASES = [
-    EvalCase(
-        input_vars={
-            "produtos_falta": [
-                {"nome": "Palmito", "demanda": 1000, "estoque": 300}
-            ],
-            "pedidos": ["VCD123", "VCD456"]
-        },
-        golden_answer=PCP_RUBRIC,
-        tags=["pcp", "ruptura"]
-    ),
-]
-
-# Usar model-based grading para avalia√ß√£o aberta
-results = evaluator.run_eval(PCP_CASES)
-```
-
-### Eval para Decis√£o Parcial/Aguardar
-
-```python
-PARCIAL_CASES = [
-    # Falta <= 10% + demora > 3 dias = PARCIAL
-    EvalCase(
-        input_vars={
-            "percentual_falta": 8,
-            "dias_demora": 5,
-            "valor_pedido": 50000
-        },
-        golden_answer="PARCIAL",
-        tags=["parcial_auto"]
-    ),
-    # Falta > 20% = CONSULTAR
-    EvalCase(
-        input_vars={
-            "percentual_falta": 25,
-            "dias_demora": 3,
-            "valor_pedido": 80000
-        },
-        golden_answer="CONSULTAR_COMERCIAL",
-        tags=["consultar"]
-    ),
-    # FOB = SEMPRE COMPLETO
-    EvalCase(
-        input_vars={
-            "tipo": "FOB",
-            "percentual_falta": 5
-        },
-        golden_answer="AGUARDAR_COMPLETO",
-        tags=["fob"]
-    ),
-]
-```
-
-## Melhores Pr√°ticas
-
-### 1. Evals Espec√≠ficas
-- Crie evals separadas por funcionalidade
-- N√£o misture tipos de tarefa na mesma eval
-
-### 2. Volume > Qualidade Individual
-- Mais casos simples > poucos casos elaborados
-- Cobertura de edge cases √© essencial
-
-### 3. Automa√ß√£o
-- Prefira code-based quando poss√≠vel
-- Model-based para tarefas abertas
-- Human grading apenas quando necess√°rio
-
-### 4. An√°lise de Falhas
-```python
-def analyze_failures(results: dict):
-    """Analisa casos de falha por categoria."""
-    failures = results["failed_cases"]
-
-    by_tag = {}
-    for f in failures:
-        for tag in f.case.tags or []:
-            by_tag.setdefault(tag, []).append(f)
-
-    print("Falhas por categoria:")
-    for tag, cases in by_tag.items():
-        print(f"  {tag}: {len(cases)} falhas")
-```
-
-### 5. Regression Testing
-Execute evals ap√≥s mudan√ßas no prompt para garantir que n√£o quebrou.
-
-## Estrutura de Arquivos Sugerida
-
-```
-.claude/
-‚îî‚îÄ‚îÄ evals/
-    ‚îú‚îÄ‚îÄ priorizacao/
-    ‚îÇ   ‚îú‚îÄ‚îÄ cases.json
-    ‚îÇ   ‚îú‚îÄ‚îÄ grader.py
-    ‚îÇ   ‚îî‚îÄ‚îÄ results/
-    ‚îú‚îÄ‚îÄ comunicacao_pcp/
-    ‚îÇ   ‚îú‚îÄ‚îÄ cases.json
-    ‚îÇ   ‚îî‚îÄ‚îÄ rubrics.md
-    ‚îî‚îÄ‚îÄ run_all_evals.py
-```
-
-## Refer√™ncias
-
-- [Building Evals Notebook](https://github.com/anthropics/claude-cookbooks/blob/main/misc/building_evals.ipynb)
-- [Anthropic Eval Best Practices](https://docs.anthropic.com/claude/docs/evaluating-prompts)
diff --git a/.claude/references/cookbooks/CONTEXT_COMPACTION.md b/.claude/references/cookbooks/CONTEXT_COMPACTION.md
deleted file mode 100644
index 2c9a8711..00000000
--- a/.claude/references/cookbooks/CONTEXT_COMPACTION.md
+++ /dev/null
@@ -1,154 +0,0 @@
-# Guia de Context Compaction
-
-**Fonte:** [claude-cookbooks/tool_use/automatic-context-compaction.ipynb](https://github.com/anthropics/claude-cookbooks/blob/main/tool_use/automatic-context-compaction.ipynb)
-
-## O Que √â
-
-Context Compaction √© uma t√©cnica para gerenciar o crescimento de tokens em conversas longas, resumindo automaticamente o hist√≥rico quando um threshold √© atingido.
-
-**Resultado t√≠pico:** 58.6% de redu√ß√£o no consumo de tokens.
-
-## O Problema
-
-Sem compacta√ß√£o, em workflows agentic:
-- Cada intera√ß√£o acumula hist√≥rico
-- Tool results crescem linearmente
-- Contexto pode estourar 200k tokens rapidamente
-- Custo aumenta proporcionalmente
-
-**Exemplo:**
-- 5 tickets de suporte
-- 7 passos por ticket
-- ~37 turnos totais
-- **208,838 tokens** (sem compacta√ß√£o)
-- **86,446 tokens** (com compacta√ß√£o - 58.6% economia)
-
-## Como Funciona
-
-### Configura√ß√£o via API
-
-```python
-runner = client.beta.messages.tool_runner(
-    model="claude-sonnet-4-5",
-    max_tokens=4096,
-    tools=tools,
-    messages=messages,
-    compaction_control={
-        "enabled": True,
-        "context_token_threshold": 5000,  # Quando compactar
-    },
-)
-```
-
-### Par√¢metros Dispon√≠veis
-
-| Par√¢metro | Tipo | Descri√ß√£o |
-|-----------|------|-----------|
-| `enabled` | bool | Ativar/desativar compacta√ß√£o |
-| `context_token_threshold` | int | Threshold de tokens para disparar (default: 100k) |
-| `model` | str | Modelo para gerar resumo (opcional) |
-| `summary_prompt` | str | Prompt customizado para resumo (opcional) |
-
-### Processo de Compacta√ß√£o
-
-1. **Monitoramento**: SDK rastreia uso de tokens por turno
-2. **Trigger**: Quando threshold √© excedido
-3. **Inje√ß√£o**: Injeta prompt de resumo como user turn
-4. **Gera√ß√£o**: Claude gera resumo em tags `<summary></summary>`
-5. **Limpeza**: Hist√≥rico completo √© substitu√≠do pelo resumo
-6. **Continua√ß√£o**: Workflow retoma com contexto comprimido
-
-### Exemplo de Resumo Gerado
-
-```xml
-<summary>
-## Support Ticket Processing Progress Summary
-
-### Tickets Completed (2 of 5)
-
-**TICKET-1 (Cliente X) - COMPLETED**
-- Issue: Problema descrito
-- Category: billing
-- Priority: high
-- Status: resolved
-
-**TICKET-2 (Cliente Y) - COMPLETED**
-- Issue: Outro problema
-- Category: technical
-- Status: resolved
-
-### Current Status
-**TICKET-3 - IN PROGRESS**
-- Steps remaining: 3, 4, 5, 6, 7
-</summary>
-```
-
-## Recomenda√ß√µes de Threshold
-
-| Threshold | Caso de Uso | Frequ√™ncia |
-|-----------|-------------|------------|
-| **5k-20k** | Processamento sequencial (CTes, pedidos) | Frequente |
-| **50k-100k** | Workflows multi-fase com checkpoints | Moderada |
-| **100k-150k** | Tarefas que precisam contexto hist√≥rico | Rara |
-| **100k (padr√£o)** | Equil√≠brio geral | - |
-
-## Quando Usar
-
-### ‚úÖ Casos Ideais
-- Processamento sequencial de m√∫ltiplos itens (CTes, pedidos)
-- An√°lise de carteira com muitos pedidos
-- Workflows multi-fase com checkpoints naturais
-- Opera√ß√µes em lote
-- Sess√µes longas de an√°lise
-
-### ‚ùå Quando Evitar
-- Tarefas curtas (< 50k tokens)
-- Que exigem trilha de auditoria completa
-- Refinamento iterativo onde cada passo depende de detalhes exatos
-- Server-side sampling loops (busca web, extended thinking)
-
-## Aplica√ß√£o no Frete Sistema
-
-### Cen√°rios Recomendados
-
-1. **An√°lise Completa de Carteira**
-   - Threshold: 50k tokens
-   - Resumo preserva: pedidos processados, a√ß√µes tomadas, pend√™ncias
-
-2. **Processamento de M√∫ltiplos CTes**
-   - Threshold: 20k tokens
-   - Resumo preserva: CTes lan√ßados, erros encontrados, totais
-
-3. **Comunica√ß√£o com PCP/Comercial**
-   - Threshold: 30k tokens
-   - Resumo preserva: produtos discutidos, decis√µes tomadas
-
-### Implementa√ß√£o Sugerida
-
-```python
-# Para an√°lise de carteira
-compaction_control = {
-    "enabled": True,
-    "context_token_threshold": 50000,
-    "summary_prompt": """
-    Resuma o progresso da an√°lise de carteira:
-    1. Pedidos analisados e status
-    2. Separa√ß√µes criadas
-    3. Comunica√ß√µes enviadas (PCP/Comercial)
-    4. Pend√™ncias e pr√≥ximos passos
-    Preserve n√∫meros de pedidos e valores cr√≠ticos.
-    """
-}
-```
-
-## Limita√ß√µes
-
-1. **Perda de detalhes**: Informa√ß√µes s√£o comprimidas
-2. **Overhead**: Cada compacta√ß√£o adiciona lat√™ncia
-3. **Server-side loops**: Pode disparar prematuramente em buscas web
-4. **Auditoria**: Resumo n√£o substitui log completo
-
-## Refer√™ncias
-
-- [Effective Context Engineering for AI Agents](https://www.anthropic.com/engineering/effective-context-engineering-for-ai-agents)
-- Anthropic SDK >= 0.74.1 requerido
diff --git a/.claude/references/cookbooks/INDEX.md b/.claude/references/cookbooks/INDEX.md
deleted file mode 100644
index 5d2e89c7..00000000
--- a/.claude/references/cookbooks/INDEX.md
+++ /dev/null
@@ -1,139 +0,0 @@
-# √çndice do Claude Cookbooks
-
-**Reposit√≥rio:** [anthropics/claude-cookbooks](https://github.com/anthropics/claude-cookbooks)
-
-Este documento serve como √≠ndice de refer√™ncia r√°pida para todos os recursos do Claude Cookbooks que podem ser √∫teis no projeto.
-
----
-
-## üìÅ Recursos Implementados Localmente
-
-Guias detalhados na pasta `.claude/references/cookbooks/`:
-
-| Arquivo | Descri√ß√£o |
-|---------|-----------|
-| [CONTEXT_COMPACTION.md](CONTEXT_COMPACTION.md) | Reduzir tokens em sess√µes longas |
-| [METAPROMPT.md](METAPROMPT.md) | Gerar prompts otimizados |
-| [BUILDING_EVALS.md](BUILDING_EVALS.md) | Framework de avalia√ß√£o de prompts |
-| [PROMPT_CACHING.md](PROMPT_CACHING.md) | Cache para reduzir lat√™ncia/custo |
-
----
-
-## üìö √çndice Completo do Reposit√≥rio
-
-### ü§ñ Claude Agent SDK (`claude_agent_sdk/`)
-
-| Notebook | Descri√ß√£o | Link |
-|----------|-----------|------|
-| **00_one_liner_research_agent** | Agente de pesquisa em 1 linha | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/claude_agent_sdk/00_The_one_liner_research_agent.ipynb) |
-| **01_chief_of_staff_agent** | Agente executivo completo (memory, hooks, plan mode) | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/claude_agent_sdk/01_The_chief_of_staff_agent.ipynb) |
-| **02_observability_agent** | Integra√ß√£o MCP (Git, GitHub) | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/claude_agent_sdk/02_The_observability_agent.ipynb) |
-
-### üîß Tool Use (`tool_use/`)
-
-| Notebook | Descri√ß√£o | Link |
-|----------|-----------|------|
-| **memory_cookbook** | Sistema de mem√≥ria persistente | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/tool_use/memory_cookbook.ipynb) |
-| **memory_tool.py** | Implementa√ß√£o do Memory Tool | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/tool_use/memory_tool.py) |
-| **automatic-context-compaction** | Compacta√ß√£o autom√°tica de contexto | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/tool_use/automatic-context-compaction.ipynb) |
-| **parallel_tools** | Chamadas de ferramentas em paralelo | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/tool_use/parallel_tools.ipynb) |
-| **extended_thinking_with_tools** | Extended thinking + tool use | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/extended_thinking/extended_thinking_with_tool_use.ipynb) |
-| **customer_service_agent** | Agente de atendimento ao cliente | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/tool_use/customer_service_agent.ipynb) |
-
-### üé® Patterns/Agents (`patterns/agents/`)
-
-| Notebook | Padr√£o | Link |
-|----------|--------|------|
-| **basic_workflows** | Chaining, Parallel, Routing | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/patterns/agents/basic_workflows.ipynb) |
-| **orchestrator_workers** | Orquestrador + Workers | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/patterns/agents/orchestrator_workers.ipynb) |
-| **evaluator_optimizer** | Generate + Evaluate loop | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/patterns/agents/evaluator_optimizer.ipynb) |
-
-### üéØ Skills (`skills/`)
-
-| Notebook | Descri√ß√£o | Link |
-|----------|-----------|------|
-| **01_skills_introduction** | Introdu√ß√£o a Skills (Excel, PDF, PPT) | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/skills/notebooks/01_skills_introduction.ipynb) |
-| **02_skills_financial_applications** | Aplica√ß√µes financeiras | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/skills/notebooks/02_skills_financial_applications.ipynb) |
-| **03_skills_custom_development** | Desenvolvimento de Skills customizados | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/skills/notebooks/03_skills_custom_development.ipynb) |
-
-### üìä Capabilities (`capabilities/`)
-
-| Pasta | Descri√ß√£o | Link |
-|-------|-----------|------|
-| **text_to_sql** | Natural language ‚Üí SQL | [Link](https://github.com/anthropics/claude-cookbooks/tree/main/capabilities/text_to_sql) |
-| **classification** | Classifica√ß√£o com RAG | [Link](https://github.com/anthropics/claude-cookbooks/tree/main/capabilities/classification) |
-| **summarization** | Sumariza√ß√£o avan√ßada | [Link](https://github.com/anthropics/claude-cookbooks/tree/main/capabilities/summarization) |
-| **retrieval_augmented_generation** | RAG otimizado | [Link](https://github.com/anthropics/claude-cookbooks/tree/main/capabilities/retrieval_augmented_generation) |
-| **contextual-embeddings** | Embeddings com contexto | [Link](https://github.com/anthropics/claude-cookbooks/tree/main/capabilities/contextual-embeddings) |
-
-### üõ†Ô∏è Misc (`misc/`)
-
-| Notebook | Descri√ß√£o | Link |
-|----------|-----------|------|
-| **metaprompt** | Gerar prompts otimizados | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/misc/metaprompt.ipynb) |
-| **prompt_caching** | Cache de prompts | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/misc/prompt_caching.ipynb) |
-| **building_evals** | Framework de avalia√ß√µes | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/misc/building_evals.ipynb) |
-| **generate_test_cases** | Dados de teste sint√©ticos | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/misc/generate_test_cases.ipynb) |
-| **using_citations** | RAG com cita√ß√µes | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/misc/using_citations.ipynb) |
-| **how_to_enable_json_mode** | For√ßar output JSON | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/misc/how_to_enable_json_mode.ipynb) |
-| **batch_processing** | Processamento em lote | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/misc/batch_processing.ipynb) |
-| **building_moderation_filter** | Filtros de modera√ß√£o | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/misc/building_moderation_filter.ipynb) |
-
-### üíª Coding (`coding/`)
-
-| Notebook | Descri√ß√£o | Link |
-|----------|-----------|------|
-| **prompting_for_frontend_aesthetics** | Gerar frontends bonitos | [Link](https://github.com/anthropics/claude-cookbooks/blob/main/coding/prompting_for_frontend_aesthetics.ipynb) |
-
-### üîó Third Party (`third_party/`)
-
-| Integra√ß√£o | Descri√ß√£o |
-|------------|-----------|
-| **Pinecone** | Vector database |
-| **MongoDB** | NoSQL database |
-| **LlamaIndex** | RAG framework |
-| **VoyageAI** | Embeddings |
-| **Wikipedia** | Knowledge base |
-| **WolframAlpha** | Computa√ß√£o |
-| **Deepgram** | Speech-to-text |
-| **ElevenLabs** | Text-to-speech |
-
----
-
-## üéØ Recursos por Caso de Uso
-
-### Para An√°lise de Carteira
-- Context Compaction (sess√µes longas)
-- Orchestrator-Workers (an√°lise multi-perspectiva)
-- Building Evals (validar decis√µes)
-
-### Para Comunica√ß√£o PCP/Comercial
-- Metaprompt (criar templates)
-- Generate Test Cases (testar templates)
-
-### Para Dashboards/Frontend
-- Frontend Aesthetics (design distintivo)
-- Skills (gerar Excel/PDF)
-
-### Para Integra√ß√£o Odoo
-- Tool Use patterns
-- Memory Tool (aprender padr√µes)
-
-### Para Processamento em Lote
-- Batch Processing
-- Context Compaction
-- Parallel Tools
-
----
-
-## üìñ Documenta√ß√£o Oficial
-
-- [Claude API Docs](https://docs.anthropic.com/claude/docs)
-- [Claude Code Docs](https://docs.claude.com/en/docs/claude-code)
-- [Agent SDK Docs](https://docs.anthropic.com/en/docs/claude-code/sdk)
-- [Building Effective Agents](https://www.anthropic.com/engineering/building-effective-agents)
-- [Effective Context Engineering](https://www.anthropic.com/engineering/effective-context-engineering-for-ai-agents)
-
----
-
-**√öltima atualiza√ß√£o:** Dezembro 2024
diff --git a/.claude/references/cookbooks/METAPROMPT.md b/.claude/references/cookbooks/METAPROMPT.md
deleted file mode 100644
index c104c65d..00000000
--- a/.claude/references/cookbooks/METAPROMPT.md
+++ /dev/null
@@ -1,224 +0,0 @@
-# Guia de Metaprompt
-
-**Fonte:** [claude-cookbooks/misc/metaprompt.ipynb](https://github.com/anthropics/claude-cookbooks/blob/main/misc/metaprompt.ipynb)
-
-## O Que √â
-
-Metaprompt √© uma t√©cnica para **gerar prompts otimizados automaticamente**. Voc√™ descreve a tarefa que quer realizar e Claude gera um prompt bem estruturado para essa tarefa.
-
-**Resolve o problema da "p√°gina em branco"** - n√£o saber como come√ßar a escrever um prompt eficiente.
-
-## Quando Usar
-
-- Criar novos skills
-- Otimizar prompts existentes
-- Gerar templates de comunica√ß√£o
-- Estruturar tarefas complexas
-- Criar prompts para chatbots/agentes
-
-## Como Funciona
-
-### Input
-
-Voc√™ fornece:
-1. **Descri√ß√£o da tarefa** (texto livre)
-2. **Vari√°veis** (opcionais) - placeholders que ser√£o preenchidos
-
-### Output
-
-Claude retorna:
-1. **Inputs** - vari√°veis identificadas
-2. **Instructions Structure** - planejamento da estrutura
-3. **Instructions** - prompt final otimizado
-
-## Exemplo Pr√°tico
-
-### Tarefa
-```
-"Redigir um email respondendo a uma reclama√ß√£o de cliente"
-```
-
-### Vari√°veis Identificadas
-```
-$CUSTOMER_EMAIL - O email original do cliente
-$COMPANY_NAME - Nome da empresa respondendo
-```
-
-### Prompt Gerado
-
-```xml
-Voc√™ √© um especialista em atendimento ao cliente da {{COMPANY_NAME}}.
-
-Analise o email do cliente abaixo e redija uma resposta profissional e emp√°tica.
-
-<email_cliente>
-{{CUSTOMER_EMAIL}}
-</email_cliente>
-
-<instrucoes>
-1. Reconhe√ßa o problema do cliente
-2. Pe√ßa desculpas de forma genu√≠na
-3. Explique a solu√ß√£o ou pr√≥ximos passos
-4. Ofere√ßa compensa√ß√£o se apropriado
-5. Agrade√ßa pelo feedback
-</instrucoes>
-
-<regras>
-- Mantenha tom profissional mas caloroso
-- N√ÉO fa√ßa promessas que n√£o pode cumprir
-- N√ÉO culpe o cliente
-- Responda em portugu√™s brasileiro
-</regras>
-
-<formato_saida>
-Use <scratchpad> para planejar sua resposta.
-Depois, forne√ßa a resposta final em <email_response>.
-</formato_saida>
-```
-
-## Template de Metaprompt
-
-```python
-METAPROMPT_TEMPLATE = """
-<task>
-{TASK_DESCRIPTION}
-</task>
-
-Baseado na tarefa acima, gere um prompt otimizado que:
-
-1. Identifique as vari√°veis de input necess√°rias
-2. Estruture as instru√ß√µes de forma clara
-3. Inclua exemplos de boas e m√°s respostas
-4. Use tags XML para demarcar se√ß√µes
-5. Especifique o formato de sa√≠da esperado
-
-<planning>
-Antes de gerar o prompt:
-1. Qual √© o objetivo principal?
-2. Quais s√£o as entradas necess√°rias?
-3. Quais s√£o os casos de erro comuns?
-4. Como garantir consist√™ncia?
-</planning>
-
-<output>
-Forne√ßa o prompt completo em <instructions> tags.
-</output>
-"""
-```
-
-## Boas Pr√°ticas do Metaprompt
-
-### 1. Tags XML
-- Use para demarcar vari√°veis: `<customer_email>`, `<pedido>`
-- Use para se√ß√µes: `<instrucoes>`, `<regras>`, `<formato>`
-- Use para output estruturado: `<thinking>`, `<answer>`
-
-### 2. Mon√≥logo Interno
-Para tarefas complexas, pe√ßa racioc√≠nio antes da resposta:
-```xml
-<scratchpad>
-[Seu racioc√≠nio aqui - n√£o ser√° mostrado ao usu√°rio]
-</scratchpad>
-
-<resposta>
-[Resposta final]
-</resposta>
-```
-
-### 3. Exemplos
-Inclua exemplos de boas e m√°s respostas:
-```xml
-<exemplo_bom>
-"Lamentamos sinceramente o ocorrido..."
-</exemplo_bom>
-
-<exemplo_ruim>
-"N√£o √© nossa culpa, voc√™ deveria ter lido os termos..."
-</exemplo_ruim>
-```
-
-### 4. Vari√°veis
-- Coloque vari√°veis longas ANTES das instru√ß√µes
-- Use nomes descritivos: `$CUSTOMER_EMAIL` vs `$INPUT`
-- Liste vari√°veis m√≠nimas necess√°rias (1-3)
-
-## Aplica√ß√£o no Frete Sistema
-
-### Criar Skill de Comunica√ß√£o PCP
-
-**Tarefa:**
-```
-Gerar mensagem para PCP solicitando previs√£o de produ√ß√£o,
-agregando por produto e listando pedidos afetados.
-```
-
-**Prompt gerado seria otimizado para:**
-- Formato espec√≠fico de mensagem
-- Agrega√ß√£o correta por produto
-- Tom profissional para Teams
-- Informa√ß√µes completas (demanda, estoque, falta)
-
-### Criar Skill de An√°lise de Ruptura
-
-**Tarefa:**
-```
-Analisar pedido em ruptura, calcular percentual de falta por valor,
-e recomendar a√ß√£o (parcial/aguardar/escalar).
-```
-
-### Otimizar Prompts Existentes
-
-Use metaprompt para revisar e melhorar:
-- Templates do analista-carteira.md
-- Instru√ß√µes dos skills de consulta
-- Mensagens para comercial
-
-## Dicas de Uso
-
-1. **Seja espec√≠fico na tarefa** - quanto mais contexto, melhor o prompt
-2. **Itere** - use o prompt gerado, teste, refine
-3. **Mantenha vari√°veis simples** - deixe Claude inferir quando poss√≠vel
-4. **Revise sempre** - metaprompt √© ponto de partida, n√£o final
-
-## C√≥digo Python
-
-```python
-from anthropic import Anthropic
-
-client = Anthropic()
-
-def generate_prompt(task_description: str, variables: list[str] = None):
-    """Gera prompt otimizado usando metaprompt."""
-
-    variables_str = "\n".join(variables) if variables else "[Claude infere]"
-
-    response = client.messages.create(
-        model="claude-sonnet-4-5",
-        max_tokens=4000,
-        messages=[{
-            "role": "user",
-            "content": f"""
-            Gere um prompt otimizado para a seguinte tarefa:
-
-            <task>{task_description}</task>
-
-            Vari√°veis sugeridas: {variables_str}
-
-            Retorne em <instructions> tags.
-            """
-        }]
-    )
-
-    return response.content[0].text
-
-# Uso
-prompt = generate_prompt(
-    "Analisar carteira de pedidos e priorizar por algoritmo P1-P7",
-    ["$CARTEIRA_JSON", "$DATA_ANALISE"]
-)
-```
-
-## Refer√™ncias
-
-- [Metaprompt Notebook](https://github.com/anthropics/claude-cookbooks/blob/main/misc/metaprompt.ipynb)
-- [Prompt Engineering Guide](https://docs.anthropic.com/claude/docs/prompt-engineering)
diff --git a/.claude/references/cookbooks/PROMPT_CACHING.md b/.claude/references/cookbooks/PROMPT_CACHING.md
deleted file mode 100644
index 7c99a008..00000000
--- a/.claude/references/cookbooks/PROMPT_CACHING.md
+++ /dev/null
@@ -1,208 +0,0 @@
-# Guia de Prompt Caching
-
-**Fonte:** [claude-cookbooks/misc/prompt_caching.ipynb](https://github.com/anthropics/claude-cookbooks/blob/main/misc/prompt_caching.ipynb)
-
-## O Que √â
-
-Prompt Caching permite armazenar e reutilizar contexto dentro do seu prompt, reduzindo:
-- **Lat√™ncia:** >2x mais r√°pido
-- **Custo:** at√© 90% de redu√ß√£o
-
-## Quando Usar
-
-- Documentos longos reutilizados em m√∫ltiplas perguntas
-- Instru√ß√µes detalhadas repetidas
-- Exemplos de contexto fixos
-- Base de conhecimento est√°tica
-
-## Como Funciona
-
-### Configura√ß√£o B√°sica
-
-```python
-messages = [
-    {
-        "role": "user",
-        "content": [
-            {
-                "type": "text",
-                "text": "<documento>" + documento_longo + "</documento>",
-                "cache_control": {"type": "ephemeral"}  # <-- Ativa cache
-            },
-            {
-                "type": "text",
-                "text": "Sua pergunta aqui"
-            }
-        ]
-    }
-]
-
-response = client.messages.create(
-    model="claude-sonnet-4-5",
-    max_tokens=300,
-    messages=messages
-)
-```
-
-### M√©tricas de Cache
-
-A resposta inclui informa√ß√µes de uso:
-
-```python
-response.usage = {
-    "input_tokens": 17,              # Tokens sem cache
-    "output_tokens": 8,              # Tokens gerados
-    "cache_read_input_tokens": 187354,    # Lidos do cache
-    "cache_creation_input_tokens": 36     # Escritos no cache
-}
-```
-
-## Resultados T√≠picos
-
-### Sem Cache (primeira chamada)
-```
-Tempo: 20.37 segundos
-Cache creation: 187,354 tokens
-Cache read: 0
-```
-
-### Com Cache (chamadas subsequentes)
-```
-Tempo: 2.92 segundos (7x mais r√°pido!)
-Cache read: 187,354 tokens
-Cache creation: 36 tokens
-```
-
-## Multi-turn com Cache Incremental
-
-### Estrat√©gia
-
-Adicione `cache_control` ao **√∫ltimo bloco do usu√°rio** para otimizar:
-
-```python
-class ConversationWithCache:
-    def __init__(self):
-        self.turns = []
-
-    def add_user_turn(self, content: str):
-        self.turns.append({
-            "role": "user",
-            "content": [{
-                "type": "text",
-                "text": content,
-                "cache_control": {"type": "ephemeral"}  # Cache no √∫ltimo user turn
-            }]
-        })
-
-    def add_assistant_turn(self, content: str):
-        self.turns.append({
-            "role": "assistant",
-            "content": [{"type": "text", "text": content}]
-        })
-
-    def get_messages(self):
-        # Aplica cache_control apenas no √∫ltimo user turn
-        messages = []
-        user_turns = [i for i, t in enumerate(self.turns) if t["role"] == "user"]
-
-        for i, turn in enumerate(self.turns):
-            if i == user_turns[-1]:  # √öltimo user turn
-                messages.append({
-                    "role": "user",
-                    "content": [{
-                        "type": "text",
-                        "text": turn["content"][0]["text"],
-                        "cache_control": {"type": "ephemeral"}
-                    }]
-                })
-            else:
-                messages.append(turn)
-
-        return messages
-```
-
-### Resultados Multi-turn
-
-| Turn | Pergunta | Tempo | % Cached |
-|------|----------|-------|----------|
-| 1 | "Qual o t√≠tulo?" | 20.37s | 0% |
-| 2 | "Quem s√£o os personagens?" | 7.53s | 100% |
-| 3 | "Qual o tema?" | 6.76s | 100% |
-| 4 | "Resuma o enredo" | 7.13s | 100% |
-
-## Aplica√ß√£o no Frete Sistema
-
-### Cen√°rio: An√°lise de Regras de Neg√≥cio
-
-```python
-# Carrega regras uma vez, consulta m√∫ltiplas vezes
-regras_negocio = open(".claude/references/REGRAS_NEGOCIO.md").read()
-
-messages = [
-    {
-        "role": "user",
-        "content": [
-            {
-                "type": "text",
-                "text": f"<regras>\n{regras_negocio}\n</regras>",
-                "cache_control": {"type": "ephemeral"}
-            },
-            {
-                "type": "text",
-                "text": "Qual a prioridade do Atacad√£o?"
-            }
-        ]
-    }
-]
-```
-
-### Cen√°rio: M√∫ltiplas Consultas no CLAUDE.md
-
-```python
-claude_md = open("CLAUDE.md").read()
-
-# Primeira consulta - cria cache
-consulta_1 = ask_with_cache(claude_md, "Quais campos a Separa√ß√£o tem?")
-
-# Segunda consulta - usa cache (muito mais r√°pido)
-consulta_2 = ask_with_cache(claude_md, "Como calcular lead time?")
-```
-
-## Limita√ß√µes
-
-1. **Cache ephemeral:** Persiste por **5 minutos** apenas
-2. **Tamanho m√≠nimo:** Conte√∫do deve ser significativo para valer o cache
-3. **Ordem importa:** Cache √© sens√≠vel √† ordem dos blocos
-4. **Modelos suportados:** Claude 3.5+
-
-## Melhores Pr√°ticas
-
-### 1. Coloque Conte√∫do Cache√°vel Primeiro
-```python
-# BOM - documento cache√°vel antes da pergunta
-[documento_cache, pergunta]
-
-# RUIM - pergunta antes quebra o cache
-[pergunta, documento_cache]
-```
-
-### 2. Use para Conte√∫do Est√°vel
-- ‚úÖ Documenta√ß√£o, regras de neg√≥cio, exemplos
-- ‚ùå Dados que mudam frequentemente
-
-### 3. Monitore Uso de Cache
-```python
-def log_cache_usage(response):
-    usage = response.usage
-    cached = usage.cache_read_input_tokens
-    created = usage.cache_creation_input_tokens
-    total = usage.input_tokens + cached + created
-
-    cache_ratio = cached / total if total > 0 else 0
-    print(f"Cache ratio: {cache_ratio:.1%}")
-```
-
-## Refer√™ncias
-
-- [Prompt Caching Notebook](https://github.com/anthropics/claude-cookbooks/blob/main/misc/prompt_caching.ipynb)
-- [Anthropic API Docs - Caching](https://docs.anthropic.com/claude/docs/prompt-caching)
diff --git a/.claude/references/roadmaps/FEATURES_AGENTE.md b/.claude/references/roadmaps/FEATURES_AGENTE.md
deleted file mode 100644
index 0aa26683..00000000
--- a/.claude/references/roadmaps/FEATURES_AGENTE.md
+++ /dev/null
@@ -1,1526 +0,0 @@
-# ROADMAP DE FEATURES - AGENTE LOGISTICO
-
-**Versao**: 1.2
-**Data**: 03/12/2025
-**Autor**: Claude Code (Pesquisa Profunda)
-**Baseado em**: Documentacao Oficial Anthropic (Claude Agent SDK + Claude Code)
-
----
-
-## SUMARIO
-
-1. [Visao Geral](#1-visao-geral)
-2. [Estado Atual da Implementacao](#2-estado-atual-da-implementacao)
-3. [Catalogo Completo de Features](#3-catalogo-completo-de-features)
-4. [Roadmap de Implementacao](#4-roadmap-de-implementacao)
-5. [Especificacoes Tecnicas por Feature](#5-especificacoes-tecnicas-por-feature)
-6. [Referencias Oficiais](#6-referencias-oficiais)
-
----
-
-## 1. VISAO GERAL
-
-### 1.1 Objetivo
-
-Este documento cataloga todas as features disponiveis no Claude Agent SDK e Claude Code que podem ser implementadas na interface do Agente Logistico, organizadas em um roadmap de implementacao progressiva.
-
-### 1.2 Fonte das Informacoes
-
-| Fonte | URL | Conteudo |
-|-------|-----|----------|
-| Claude Code Docs | https://code.claude.com/docs/ | Features de UI, Hooks, Permissoes |
-| Agent SDK | https://platform.claude.com/docs/en/agent-sdk/ | Streaming, Sessions, Tools |
-| API Reference | https://docs.anthropic.com/en/api/ | Token Usage, Costs, Models |
-
-### 1.3 Arquivos do Projeto Relacionados
-
-| Arquivo | Funcao |
-|---------|--------|
-| `app/agente/routes.py` | Endpoints Flask (SSE streaming) |
-| `app/agente/sdk/client.py` | Cliente do SDK (ClaudeAgentOptions) |
-| `app/agente/sdk/cost_tracker.py` | Rastreamento de custos |
-| `app/agente/templates/agente/chat.html` | Interface do chat |
-| `app/agente/config/settings.py` | Configuracoes |
-| `app/agente/config/permissions.py` | Callback de permissoes |
-
----
-
-## 2. ESTADO ATUAL DA IMPLEMENTACAO
-
-### 2.1 Features Ja Implementadas
-
-| Feature | Status | Arquivo | Linha |
-|---------|--------|---------|-------|
-| Streaming SSE | :white_check_mark: Completo | routes.py | 84-96 |
-| Session Management | :white_check_mark: Completo | client.py | 249-252 |
-| Token Display | :white_check_mark: Admin only | chat.css | - |
-| Cost Display | :white_check_mark: Admin only | chat.css | - |
-| Tool Call Indicator | :white_check_mark: Basico | chat.js | - |
-| Typing Indicator | :white_check_mark: Completo | chat.js | - |
-| Modal Confirmacao | :white_check_mark: Basico | chat.html | - |
-| Markdown Rendering | :white_check_mark: Basico | chat.js | - |
-| Skills System | :white_check_mark: 8 skills | client.py | 262-268 |
-| Permission Callback | :white_check_mark: Estrutura | client.py | 279-280 |
-| Cost Tracker | :white_check_mark: Completo | cost_tracker.py | - |
-| Health Check | :white_check_mark: Completo | routes.py | 255-285 |
-
-### 2.2 FASE 1 - Implementada em 03/12/2025
-
-| Feature | ID | Status | Arquivo |
-|---------|-----|--------|---------|
-| Seletor de Modelo | FEAT-001 | :white_check_mark: Completo | chat.html, routes.py, client.py |
-| Toggle de Thinking | FEAT-002 | :white_check_mark: Completo | chat.html, routes.py, client.py |
-| Painel de Thinking | FEAT-003 | :white_check_mark: Completo | chat.css, chat.js |
-| Budget de Tokens Visual | FEAT-004 | :white_check_mark: Completo | chat.css, chat.js |
-| Timeline de Acoes | FEAT-006 | :white_check_mark: Completo | chat.css, chat.js |
-| Todo List Visual | FEAT-008 | :white_check_mark: Completo | chat.css, chat.js |
-
-**Melhorias adicionais (03/12/2025):**
-- Template modularizado (CSS e JS externos)
-- Explicacao detalhada dos modelos com tooltips
-- Extended Thinking com explicacao visual
-- **CORRECAO**: Extended Thinking agora usa `max_thinking_tokens` (parametro correto do SDK)
-
-### 2.3 FASE 2 - Implementada em 03/12/2025
-
-| Feature | ID | Status | Arquivo |
-|---------|-----|--------|---------|
-| Barra de Progresso Geral | FEAT-009 | :white_check_mark: Completo | chat.html, chat.css, chat.js |
-| Plan Mode Toggle | FEAT-010 | :white_check_mark: Completo | chat.html, chat.css, chat.js, routes.py, client.py |
-| Markdown Avancado | FEAT-023 | :white_check_mark: Completo | chat.html, chat.css, chat.js |
-
-**Melhorias adicionais (03/12/2025):**
-- Barra de progresso geral sincronizada com Todo List
-- Plan Mode com toggle visual e integracao backend
-- Markdown avancado com marked.js + highlight.js (syntax highlighting)
-- Tabelas estilizadas, blockquotes, codigo com cores
-
-### 2.4 Gaps Restantes (Proximas Fases)
-
-| Categoria | Implementado | Faltando |
-|-----------|--------------|----------|
-| Execucao | Streaming, Seletor Modelo, Thinking, Plan Mode | Dashboard Analytics |
-| Metricas | Tokens/Custo, Budget Visual | - |
-| Planejamento | Todo List, Timeline, Barra Progresso | - |
-| Sessoes | Session ID | Lista Sessoes, Checkpoints |
-| Aprovacao | Modal basico | Fila, Permissoes granulares |
-| Transparencia | Timeline, Thinking Panel, Markdown Avancado | Diff Viewer |
-
----
-
-## 3. CATALOGO COMPLETO DE FEATURES
-
-### 3.1 EXECUCAO E CONTROLE DO AGENTE
-
-#### 3.1.1 Seletor de Modelo
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-001 |
-| **Nome** | Seletor de Modelo |
-| **Descricao** | Dropdown para alternar entre Haiku, Sonnet e Opus |
-| **Prioridade** | ALTA |
-| **Complexidade** | Facil |
-| **Tempo Estimado** | 30 minutos |
-| **Dependencias** | Nenhuma |
-
-**Modelos Disponiveis:**
-
-| Alias | Model ID | Uso | Velocidade |
-|-------|----------|-----|------------|
-| haiku | claude-haiku-4-5-20251001 | Tarefas simples | Muito rapido |
-| sonnet | claude-sonnet-4-5-20250929 | Equilibrado | Rapido |
-| opus | claude-opus-4-5-20251101 | Complexo | Moderado |
-| sonnet[1m] | claude-sonnet-4-5 (extended) | Contexto grande | Rapido |
-| opusplan | Opus -> Sonnet | Planejamento hibrido | Variavel |
-
-**Configuracao:**
-```python
-# Via SDK
-options_dict["model"] = "claude-sonnet-4-5-20250929"
-
-# Via CLI
-claude --model sonnet
-```
-
----
-
-#### 3.1.2 Toggle de Extended Thinking
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-002 |
-| **Nome** | Toggle de Thinking |
-| **Descricao** | Switch para ativar/desativar pensamento profundo |
-| **Prioridade** | ALTA |
-| **Complexidade** | Facil |
-| **Tempo Estimado** | 20 minutos |
-| **Dependencias** | Nenhuma |
-
-**Parametros:**
-
-| Parametro | Tipo | Descricao |
-|-----------|------|-----------|
-| MAX_THINKING_TOKENS | number | Limite de tokens (10K-100K) |
-| permission_mode | string | "plan" ativa thinking |
-
----
-
-#### 3.1.3 Painel de Thinking
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-003 |
-| **Nome** | Painel de Thinking |
-| **Descricao** | Exibe o raciocinio do Claude em tempo real |
-| **Prioridade** | MEDIA |
-| **Complexidade** | Facil |
-| **Tempo Estimado** | 15 minutos |
-| **Dependencias** | FEAT-002 |
-
-**Estilo Visual:**
-- Background: #f8f9fa
-- Border-left: 3px solid #667eea
-- Font-style: italic
-- Color: #666
-
----
-
-#### 3.1.4 Budget de Tokens
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-004 |
-| **Nome** | Budget de Tokens Visual |
-| **Descricao** | Barra de progresso mostrando consumo vs limite |
-| **Prioridade** | MEDIA |
-| **Complexidade** | Facil |
-| **Tempo Estimado** | 30 minutos |
-| **Dependencias** | Nenhuma |
-
-**Campos:**
-
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| input_tokens | int | Tokens de entrada |
-| output_tokens | int | Tokens de saida |
-| cache_read_tokens | int | Tokens do cache (90% desconto) |
-| cache_creation_tokens | int | Tokens para criar cache |
-| budget_total | int | Limite configurado |
-
----
-
-### 3.2 OBSERVABILIDADE E METRICAS
-
-#### 3.2.1 Dashboard de Metricas
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-005 |
-| **Nome** | Dashboard de Metricas |
-| **Descricao** | Painel com estatisticas da sessao |
-| **Prioridade** | MEDIA |
-| **Complexidade** | Media |
-| **Tempo Estimado** | 2 horas |
-| **Dependencias** | Nenhuma |
-
-**Metricas Disponiveis:**
-
-| Metrica | Unidade | Descricao |
-|---------|---------|-----------|
-| session.count | count | Sessoes iniciadas |
-| lines_of_code.count | count | Linhas modificadas |
-| cost.usage | USD | Custo da sessao |
-| token.usage | tokens | Total de tokens |
-| active_time.total | seconds | Tempo ativo |
-
----
-
-#### 3.2.2 Timeline de Acoes
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-006 |
-| **Nome** | Timeline de Acoes |
-| **Descricao** | Historico visual de ferramentas usadas |
-| **Prioridade** | ALTA |
-| **Complexidade** | Media |
-| **Tempo Estimado** | 1 hora |
-| **Dependencias** | Nenhuma |
-
-**Eventos Capturados:**
-
-| Evento | Trigger | Dados |
-|--------|---------|-------|
-| tool_call | Inicio de ferramenta | tool_name, timestamp |
-| tool_result | Fim de ferramenta | success, duration_ms |
-| error | Falha | message, code |
-
----
-
-#### 3.2.3 Console de Logs
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-007 |
-| **Nome** | Console de Logs |
-| **Descricao** | Aba com logs tecnicos, erros e avisos |
-| **Prioridade** | BAIXA |
-| **Complexidade** | Media |
-| **Tempo Estimado** | 1.5 horas |
-| **Dependencias** | Nenhuma |
-
-**Niveis de Log:**
-- ERROR (vermelho)
-- WARNING (amarelo)
-- INFO (azul)
-- DEBUG (cinza)
-
----
-
-### 3.3 PLANEJAMENTO E TO-DOS
-
-#### 3.3.1 Todo List Visual
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-008 |
-| **Nome** | Todo List Visual |
-| **Descricao** | Exibe tarefas que o agente esta executando |
-| **Prioridade** | ALTA |
-| **Complexidade** | Media |
-| **Tempo Estimado** | 1 hora |
-| **Dependencias** | Nenhuma |
-
-**Estrutura de Todo:**
-```json
-{
-  "todos": [
-    {
-      "content": "Implementar autenticacao",
-      "status": "pending|in_progress|completed",
-      "activeForm": "Implementando autenticacao"
-    }
-  ]
-}
-```
-
-**Estados:**
-
-| Status | Icone | Cor |
-|--------|-------|-----|
-| pending | ‚óã | #6c757d |
-| in_progress | ‚è≥ | #007bff |
-| completed | ‚úì | #28a745 |
-
----
-
-#### 3.3.2 Barra de Progresso
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-009 |
-| **Nome** | Barra de Progresso |
-| **Descricao** | Progresso visual das tarefas |
-| **Prioridade** | MEDIA |
-| **Complexidade** | Facil |
-| **Tempo Estimado** | 20 minutos |
-| **Dependencias** | FEAT-008 |
-
----
-
-#### 3.3.3 Plan Mode Toggle
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-010 |
-| **Nome** | Plan Mode Toggle |
-| **Descricao** | Modo somente leitura (dry-run) |
-| **Prioridade** | MEDIA |
-| **Complexidade** | Facil |
-| **Tempo Estimado** | 30 minutos |
-| **Dependencias** | Nenhuma |
-
-**Comportamento em Plan Mode:**
-
-| Permitido | Bloqueado |
-|-----------|-----------|
-| Leitura de arquivos | Edicao de arquivos |
-| Listagem de diretorios | Execucao de comandos |
-| Busca em codigo | Criacao de arquivos |
-| Analise e planejamento | Delecao de arquivos |
-
----
-
-### 3.4 SESSOES E CONTEXTO
-
-#### 3.4.1 Lista de Sessoes
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-011 |
-| **Nome** | Lista de Sessoes |
-| **Descricao** | Conversas recentes com titulo e hora |
-| **Prioridade** | MEDIA |
-| **Complexidade** | Media |
-| **Tempo Estimado** | 1.5 horas |
-| **Dependencias** | Banco de dados |
-
-**Campos por Sessao:**
-
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| session_id | string | ID unico |
-| title | string | Titulo (auto-gerado) |
-| created_at | datetime | Data de criacao |
-| last_message | datetime | Ultima mensagem |
-| message_count | int | Total de mensagens |
-| total_cost | float | Custo acumulado |
-
----
-
-#### 3.4.2 Checkpoints
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-012 |
-| **Nome** | Checkpoints |
-| **Descricao** | Pontos de salvamento para reverter |
-| **Prioridade** | BAIXA |
-| **Complexidade** | Complexa |
-| **Tempo Estimado** | 3 horas |
-| **Dependencias** | FEAT-011 |
-
-**Opcoes de Reversao:**
-1. Reverter apenas codigo (mantendo conversa)
-2. Reverter apenas conversa (mantendo edicoes)
-3. Restaurar ambos
-
-**Limitacoes:**
-- NAO rastreia modificacoes via bash
-- NAO rastreia edicoes manuais fora do agente
-- Funciona como "local undo" (nao substitui Git)
-- Persistencia: 30 dias (configuravel)
-
----
-
-#### 3.4.3 Resumo de Conversa
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-013 |
-| **Nome** | Resumo de Conversa |
-| **Descricao** | Botao para gerar resumo + proximos passos |
-| **Prioridade** | BAIXA |
-| **Complexidade** | Facil |
-| **Tempo Estimado** | 30 minutos |
-| **Dependencias** | Nenhuma |
-
----
-
-### 3.5 SEGURANCA E APROVACOES
-
-#### 3.5.1 Fila de Aprovacoes
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-014 |
-| **Nome** | Fila de Aprovacoes |
-| **Descricao** | Lista de acoes pendentes de aprovacao |
-| **Prioridade** | MEDIA |
-| **Complexidade** | Complexa |
-| **Tempo Estimado** | 2 horas |
-| **Dependencias** | Nenhuma |
-
-**Decisoes Possiveis:**
-
-| Decisao | Efeito |
-|---------|--------|
-| approve | Permite execucao |
-| deny | Bloqueia execucao |
-| always_approve | Permite sempre esta ferramenta |
-
----
-
-#### 3.5.2 Perfis de Seguranca
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-015 |
-| **Nome** | Perfis de Seguranca |
-| **Descricao** | Modos: Leitor, Operador, Admin |
-| **Prioridade** | BAIXA |
-| **Complexidade** | Media |
-| **Tempo Estimado** | 1.5 horas |
-| **Dependencias** | FEAT-014 |
-
-**Modos de Permissao:**
-
-| Modo | Comportamento |
-|------|---------------|
-| default | Pede confirmacao na 1a vez |
-| plan | Somente leitura (dry-run) |
-| acceptEdits | Auto-aceita edicoes |
-| bypassPermissions | Ignora prompts (CI/CD) |
-
----
-
-#### 3.5.3 Trilha de Auditoria
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-016 |
-| **Nome** | Trilha de Auditoria |
-| **Descricao** | Historico de aprovacoes/rejeicoes |
-| **Prioridade** | BAIXA |
-| **Complexidade** | Media |
-| **Tempo Estimado** | 1.5 horas |
-| **Dependencias** | FEAT-014, Banco de dados |
-
----
-
-### 3.6 SKILLS E SUBAGENTES
-
-#### 3.6.1 Catalogo de Skills
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-017 |
-| **Nome** | Catalogo de Skills |
-| **Descricao** | Lista de skills com toggle ligar/desligar |
-| **Prioridade** | BAIXA |
-| **Complexidade** | Media |
-| **Tempo Estimado** | 1 hora |
-| **Dependencias** | Nenhuma |
-
-**Skills Atuais:**
-
-| Skill | Descricao |
-|-------|-----------|
-| gerindo-expedicao | Separacoes e estoque |
-| rastreando-odoo | Rastreamento de fluxos documentais (NF, PO, SO, titulos, conciliacoes) |
-| descobrindo-odoo-estrutura | Exploracao de modelos nao mapeados |
-| integracao-odoo | Desenvolvimento de integracoes |
-
----
-
-#### 3.6.2 Seletor de Subagente
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-018 |
-| **Nome** | Seletor de Subagente |
-| **Descricao** | Escolher tipo de agente especializado |
-| **Prioridade** | BAIXA |
-| **Complexidade** | Media |
-| **Tempo Estimado** | 1 hora |
-| **Dependencias** | Nenhuma |
-
-**Tipos Disponiveis:**
-
-| Tipo | Uso | Tools |
-|------|-----|-------|
-| general-purpose | Tarefas complexas | Todas |
-| Explore | Explorar codebase | Glob, Grep, Read |
-| Plan | Arquitetura | Todas |
-
----
-
-#### 3.6.3 Command Palette
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-019 |
-| **Nome** | Command Palette |
-| **Descricao** | Interface para slash commands com autocomplete |
-| **Prioridade** | BAIXA |
-| **Complexidade** | Media |
-| **Tempo Estimado** | 1.5 horas |
-| **Dependencias** | Nenhuma |
-
-**Comandos Built-in:**
-
-| Comando | Descricao |
-|---------|-----------|
-| /help | Ajuda geral |
-| /cost | Uso de tokens |
-| /model [nome] | Trocar modelo |
-| /clear | Limpar historico |
-| /compact | Compactar conversa |
-
----
-
-### 3.7 TRANSPARENCIA E EXPLICACAO
-
-#### 3.7.1 Botao "Por que voce respondeu isso?"
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-020 |
-| **Nome** | Explicacao de Resposta |
-| **Descricao** | Botao para explicar logica e dados usados |
-| **Prioridade** | BAIXA |
-| **Complexidade** | Facil |
-| **Tempo Estimado** | 30 minutos |
-| **Dependencias** | Nenhuma |
-
----
-
-#### 3.7.2 Modo Professor
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-021 |
-| **Nome** | Modo Professor |
-| **Descricao** | Respostas com explicacao didatica |
-| **Prioridade** | BAIXA |
-| **Complexidade** | Facil |
-| **Tempo Estimado** | 20 minutos |
-| **Dependencias** | Nenhuma |
-
----
-
-#### 3.7.3 Diff Viewer
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-022 |
-| **Nome** | Diff Viewer |
-| **Descricao** | Antes/depois de edicoes com Aplicar/Desfazer |
-| **Prioridade** | MEDIA |
-| **Complexidade** | Complexa |
-| **Tempo Estimado** | 2 horas |
-| **Dependencias** | Nenhuma |
-
----
-
-### 3.8 INTERFACE E EXPERIENCIA
-
-#### 3.8.1 Markdown Avancado
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-023 |
-| **Nome** | Markdown Avancado |
-| **Descricao** | Syntax highlighting, tabelas, mermaid |
-| **Prioridade** | MEDIA |
-| **Complexidade** | Media |
-| **Tempo Estimado** | 1 hora |
-| **Dependencias** | Biblioteca (marked.js, highlight.js) |
-
----
-
-#### 3.8.2 Temas (Dark Mode)
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-024 |
-| **Nome** | Dark Mode |
-| **Descricao** | Tema escuro para o chat |
-| **Prioridade** | BAIXA |
-| **Complexidade** | Facil |
-| **Tempo Estimado** | 45 minutos |
-| **Dependencias** | Nenhuma |
-
----
-
-#### 3.8.3 Notificacoes
-
-| Atributo | Valor |
-|----------|-------|
-| **ID** | FEAT-025 |
-| **Nome** | Sistema de Notificacoes |
-| **Descricao** | Toasts para eventos importantes |
-| **Prioridade** | BAIXA |
-| **Complexidade** | Facil |
-| **Tempo Estimado** | 30 minutos |
-| **Dependencias** | Nenhuma |
-
----
-
-## 4. ROADMAP DE IMPLEMENTACAO
-
-### 4.1 Visao Geral das Fases
-
-```
-FASE 1 (Sprint 1)     FASE 2 (Sprint 2)     FASE 3 (Sprint 3)     FASE 4 (Sprint 4)
-    |                     |                     |                     |
-    v                     v                     v                     v
-+----------+         +----------+         +----------+         +----------+
-| Controle |         |Planejam. |         | Sessoes  |         | Avancado |
-|  Basico  |         | e Acoes  |         |e Segment.|         |          |
-+----------+         +----------+         +----------+         +----------+
-| FEAT-001 |         | FEAT-006 |         | FEAT-011 |         | FEAT-017 |
-| FEAT-002 |         | FEAT-008 |         | FEAT-012 |         | FEAT-018 |
-| FEAT-003 |         | FEAT-009 |         | FEAT-014 |         | FEAT-019 |
-| FEAT-004 |         | FEAT-010 |         | FEAT-015 |         | FEAT-022 |
-| FEAT-005 |         | FEAT-023 |         | FEAT-016 |         | FEAT-024 |
-+----------+         +----------+         +----------+         +----------+
-   ~4.5h                ~5h                  ~9h                  ~6h
-```
-
----
-
-### 4.2 FASE 1: Controle Basico (Sprint 1) - :white_check_mark: CONCLUIDA
-
-**Objetivo:** Dar ao usuario controle sobre modelo e modo de operacao
-
-**Data de Conclusao:** 03/12/2025
-
-| Ordem | Feature | ID | Tempo | Status |
-|-------|---------|-----|-------|--------|
-| 1 | Seletor de Modelo | FEAT-001 | 30 min | :white_check_mark: Concluido |
-| 2 | Toggle de Thinking | FEAT-002 | 20 min | :white_check_mark: Concluido |
-| 3 | Painel de Thinking | FEAT-003 | 15 min | :white_check_mark: Concluido |
-| 4 | Budget de Tokens Visual | FEAT-004 | 30 min | :white_check_mark: Concluido |
-| 5 | Timeline de Acoes | FEAT-006 | 1h | :white_check_mark: Concluido |
-| 6 | Todo List Visual | FEAT-008 | 1h | :white_check_mark: Concluido |
-
-**Entregaveis:**
-- [x] Dropdown de selecao de modelo no header com tooltips explicativos
-- [x] Switch de Extended Thinking com explicacao visual
-- [x] Painel colapsavel para exibir thinking em tempo real
-- [x] Barra de progresso de tokens (admin only)
-- [x] Timeline de acoes lateral
-- [x] Todo list visual com progresso
-
-**Criterios de Aceite:** :white_check_mark: TODOS ATENDIDOS
-- Usuario pode alternar entre Haiku/Sonnet/Opus com explicacoes
-- Thinking pode ser ativado/desativado com feedback visual
-- Raciocinio do Claude e exibido quando ativado
-- Consumo de tokens e visivel em tempo real
-
----
-
-### 4.3 FASE 2: Planejamento e Acoes (Sprint 2) - :white_check_mark: CONCLUIDA
-
-**Objetivo:** Transparencia sobre o que o agente esta fazendo
-
-**Data de Conclusao:** 03/12/2025
-
-| Ordem | Feature | ID | Tempo | Status |
-|-------|---------|-----|-------|--------|
-| 1 | Timeline de Acoes | FEAT-006 | 1h | :white_check_mark: Movido para FASE 1 |
-| 2 | Todo List Visual | FEAT-008 | 1h | :white_check_mark: Movido para FASE 1 |
-| 3 | Barra de Progresso | FEAT-009 | 20 min | :white_check_mark: Concluido |
-| 4 | Plan Mode Toggle | FEAT-010 | 30 min | :white_check_mark: Concluido |
-| 5 | Markdown Avancado | FEAT-023 | 1h | :white_check_mark: Concluido |
-
-**Entregaveis:**
-- [x] Timeline visual de ferramentas executadas (FASE 1)
-- [x] Lista de tarefas com estados (FASE 1)
-- [x] Barra de progresso geral sincronizada com Todo List
-- [x] Toggle para modo dry-run (Plan Mode) com integracao backend
-- [x] Syntax highlighting com highlight.js e tabelas estilizadas
-
-**Criterios de Aceite:** :white_check_mark: TODOS ATENDIDOS
-- Cada tool call aparece na timeline com status :white_check_mark:
-- Tarefas do agente sao visiveis em tempo real :white_check_mark:
-- Progresso geral e calculado automaticamente :white_check_mark:
-- Plan mode bloqueia acoes destrutivas :white_check_mark:
-
----
-
-### 4.4 FASE 3: Sessoes e Seguranca (Sprint 3) - EM ANDAMENTO
-
-**Objetivo:** Persistencia e controle de acesso
-
-**Duracao Estimada:** 9 horas
-
-| Ordem | Feature | ID | Tempo | Status |
-|-------|---------|-----|-------|--------|
-| 1 | Lista de Sessoes | FEAT-011 | 1.5h | :white_check_mark: Concluido (03/12/2025) |
-| 2 | Checkpoints | FEAT-012 | 3h | :arrow_right: Movido para Backlog |
-| 3 | Fila de Aprovacoes | FEAT-014 | 2h | Pendente |
-| 4 | Perfis de Seguranca | FEAT-015 | 1.5h | Pendente |
-| 5 | Trilha de Auditoria | FEAT-016 | 1.5h | Pendente |
-
-**Entregaveis:**
-- [x] Sidebar colapsavel com conversas anteriores (FEAT-011)
-- [x] Modelo SQLAlchemy AgentSession
-- [x] API endpoints: GET/DELETE/PUT sessions
-- [x] Persistencia automatica de sessoes
-- [ ] Sistema de checkpoints com reversao (movido para backlog)
-- [ ] Modal de aprovacao com fila
-- [ ] Seletor de perfil (Leitor/Operador/Admin)
-- [ ] Log de auditoria por sessao
-
-**Criterios de Aceite FEAT-011:** :white_check_mark: ATENDIDO
-- Sessoes anteriores podem ser retomadas via sidebar
-- Usuario pode renomear e excluir sessoes
-- Sessoes sao persistidas automaticamente no banco
-
-**Dependencias:**
-- [x] Tabela agent_sessions no banco de dados
-- [ ] Tabela de auditoria
-- [ ] Integracao com sistema de usuarios (para perfis)
-
----
-
-### 4.5 FASE 4: Features Avancadas (Sprint 4)
-
-**Objetivo:** Experiencia completa e polida
-
-**Duracao Estimada:** 6 horas
-
-| Ordem | Feature | ID | Tempo | Prioridade |
-|-------|---------|-----|-------|------------|
-| 1 | Catalogo de Skills | FEAT-017 | 1h | BAIXA |
-| 2 | Seletor de Subagente | FEAT-018 | 1h | BAIXA |
-| 3 | Command Palette | FEAT-019 | 1.5h | BAIXA |
-| 4 | Diff Viewer | FEAT-022 | 2h | MEDIA |
-| 5 | Dark Mode | FEAT-024 | 45 min | BAIXA |
-
-**Entregaveis:**
-- [ ] Interface de gerenciamento de skills
-- [ ] Dropdown de tipo de agente
-- [ ] Autocomplete para /comandos
-- [ ] Visualizador de diferencas
-- [ ] Tema escuro
-
-**Criterios de Aceite:**
-- Skills podem ser habilitadas/desabilitadas
-- Tipo de agente pode ser alterado
-- Comandos tem autocomplete funcional
-- Diffs sao exibidos lado a lado
-- Tema escuro e funcional e persistente
-
----
-
-### 4.6 Backlog (Pos-MVP)
-
-| Feature | ID | Tempo | Notas |
-|---------|-----|-------|-------|
-| Checkpoints | FEAT-012 | 3h | Complexo, baixo ROI - movido da FASE 3 |
-| Console de Logs | FEAT-007 | 1.5h | Debug avancado |
-| Resumo de Conversa | FEAT-013 | 30 min | Utility |
-| Explicacao de Resposta | FEAT-020 | 30 min | Transparencia |
-| Modo Professor | FEAT-021 | 20 min | Educacional |
-| Notificacoes | FEAT-025 | 30 min | UX |
-
----
-
-## 5. ESPECIFICACOES TECNICAS POR FEATURE
-
-### 5.1 FEAT-001: Seletor de Modelo
-
-#### Frontend (chat.html)
-
-```html
-<!-- Adicionar no .chat-header apos status-badge -->
-<div class="model-selector-container ms-3">
-    <select id="model-selector" class="form-select form-select-sm">
-        <option value="claude-haiku-4-5-20251001">Haiku (Rapido)</option>
-        <option value="claude-sonnet-4-5-20250929" selected>Sonnet (Equilibrado)</option>
-        <option value="claude-opus-4-5-20251101">Opus (Potente)</option>
-    </select>
-</div>
-
-<style>
-.model-selector-container {
-    min-width: 150px;
-}
-.model-selector-container select {
-    background: rgba(255,255,255,0.1);
-    border: 1px solid rgba(255,255,255,0.3);
-    color: white;
-    font-size: 0.85rem;
-}
-.model-selector-container select option {
-    color: #333;
-    background: white;
-}
-</style>
-
-<script>
-let currentModel = 'claude-sonnet-4-5-20250929';
-
-document.getElementById('model-selector').addEventListener('change', function() {
-    currentModel = this.value;
-    // Opcional: notificar backend
-    updateModelSetting(currentModel);
-});
-
-function updateModelSetting(model) {
-    fetch('/agente/api/settings', {
-        method: 'POST',
-        headers: {
-            'Content-Type': 'application/json',
-            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
-        },
-        body: JSON.stringify({ model: model })
-    });
-}
-
-// Incluir modelo na requisicao de chat
-body: JSON.stringify({
-    message: message,
-    session_id: sessionId,
-    model: currentModel  // ADICIONAR
-})
-</script>
-```
-
-#### Backend (routes.py)
-
-```python
-@agente_bp.route('/api/settings', methods=['POST'])
-@login_required
-def api_settings():
-    """Atualiza configuracoes da sessao."""
-    data = request.get_json()
-    model = data.get('model')
-
-    if model and model in [
-        'claude-haiku-4-5-20251001',
-        'claude-sonnet-4-5-20250929',
-        'claude-opus-4-5-20251101'
-    ]:
-        # Armazenar em sessao Flask
-        session['agent_model'] = model
-        return jsonify({'success': True, 'model': model})
-
-    return jsonify({'success': False, 'error': 'Modelo invalido'}), 400
-```
-
-#### Modificar client.py
-
-```python
-def _build_options(self, model: str = None, ...):
-    # Usar modelo passado ou default
-    options_dict["model"] = model or self.settings.model
-```
-
----
-
-### 5.2 FEAT-002: Toggle de Thinking
-
-#### Frontend (chat.html)
-
-```html
-<!-- Adicionar apos model-selector -->
-<div class="thinking-toggle-container ms-3 d-flex align-items-center">
-    <div class="form-check form-switch mb-0">
-        <input class="form-check-input" type="checkbox" id="thinking-toggle">
-        <label class="form-check-label text-white" for="thinking-toggle" title="Extended Thinking">
-            <i class="fas fa-brain"></i>
-        </label>
-    </div>
-</div>
-
-<style>
-.thinking-toggle-container .form-check-input:checked {
-    background-color: #ffc107;
-    border-color: #ffc107;
-}
-</style>
-
-<script>
-let thinkingEnabled = false;
-
-document.getElementById('thinking-toggle').addEventListener('change', function() {
-    thinkingEnabled = this.checked;
-
-    // Feedback visual
-    const label = this.nextElementSibling;
-    label.style.opacity = this.checked ? '1' : '0.6';
-});
-
-// Incluir na requisicao
-body: JSON.stringify({
-    message: message,
-    session_id: sessionId,
-    model: currentModel,
-    thinking_enabled: thinkingEnabled  // ADICIONAR
-})
-</script>
-```
-
-#### Backend (routes.py)
-
-```python
-def _stream_chat_response(..., thinking_enabled: bool = False):
-    # Passar para o cliente
-    async for event in client.stream_response(
-        prompt=message,
-        session_id=sdk_session_id,
-        user_name=user_name,
-        can_use_tool=can_use_tool,
-        thinking_enabled=thinking_enabled,  # ADICIONAR
-    ):
-```
-
-#### Modificar client.py
-
-```python
-def _build_options(self, thinking_enabled: bool = False, ...):
-    if thinking_enabled:
-        options_dict["permission_mode"] = "plan"  # Ativa thinking
-        # Ou configurar budget especifico
-        # options_dict["thinking_budget"] = 50000
-```
-
----
-
-### 5.3 FEAT-003: Painel de Thinking
-
-#### Frontend (chat.html)
-
-```html
-<!-- Adicionar apos typing-container -->
-<div id="thinking-panel" class="thinking-panel px-4 pb-2" style="display: none;">
-    <div class="d-flex align-items-start">
-        <div class="message-avatar thinking-avatar me-3">
-            <i class="fas fa-brain"></i>
-        </div>
-        <div class="thinking-content">
-            <div class="thinking-header">
-                <small class="text-muted">
-                    <i class="fas fa-lightbulb me-1"></i>
-                    Pensando...
-                </small>
-                <button class="btn btn-sm btn-link p-0 ms-2" onclick="toggleThinkingPanel()">
-                    <i class="fas fa-chevron-up" id="thinking-toggle-icon"></i>
-                </button>
-            </div>
-            <div class="thinking-body" id="thinking-text"></div>
-        </div>
-    </div>
-</div>
-
-<style>
-.thinking-panel {
-    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
-    border-left: 4px solid #667eea;
-    margin: 0 1rem 1rem;
-    border-radius: 0 8px 8px 0;
-}
-
-.thinking-avatar {
-    width: 32px;
-    height: 32px;
-    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
-    border-radius: 50%;
-    display: flex;
-    align-items: center;
-    justify-content: center;
-    color: white;
-    font-size: 0.9rem;
-}
-
-.thinking-content {
-    flex: 1;
-    min-width: 0;
-}
-
-.thinking-header {
-    display: flex;
-    align-items: center;
-    margin-bottom: 8px;
-}
-
-.thinking-body {
-    font-style: italic;
-    color: #495057;
-    font-size: 0.9rem;
-    max-height: 200px;
-    overflow-y: auto;
-    padding-right: 8px;
-}
-
-.thinking-body::-webkit-scrollbar {
-    width: 4px;
-}
-
-.thinking-body::-webkit-scrollbar-thumb {
-    background: #adb5bd;
-    border-radius: 2px;
-}
-</style>
-
-<script>
-let thinkingCollapsed = false;
-
-function toggleThinkingPanel() {
-    const body = document.getElementById('thinking-text');
-    const icon = document.getElementById('thinking-toggle-icon');
-
-    thinkingCollapsed = !thinkingCollapsed;
-    body.style.display = thinkingCollapsed ? 'none' : 'block';
-    icon.className = thinkingCollapsed ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
-}
-
-function showThinking(content) {
-    const panel = document.getElementById('thinking-panel');
-    const text = document.getElementById('thinking-text');
-
-    panel.style.display = 'block';
-    text.innerHTML += formatMessage(content);
-    text.scrollTop = text.scrollHeight;
-}
-
-function clearThinking() {
-    document.getElementById('thinking-panel').style.display = 'none';
-    document.getElementById('thinking-text').innerHTML = '';
-}
-
-// No processSSEEvent:
-case 'thinking':
-    showThinking(data.content);
-    break;
-</script>
-```
-
----
-
-### 5.4 FEAT-006: Timeline de Acoes
-
-#### Frontend (chat.html)
-
-```html
-<!-- Adicionar como sidebar ou section colapsavel -->
-<div id="action-timeline-container" class="action-timeline-container">
-    <div class="timeline-header" onclick="toggleTimeline()">
-        <span><i class="fas fa-history me-2"></i>Acoes</span>
-        <span class="badge bg-secondary" id="action-count">0</span>
-    </div>
-    <div class="timeline-body" id="timeline-body">
-        <div class="timeline-empty text-muted text-center py-3">
-            <i class="fas fa-clock"></i>
-            <p class="mb-0 mt-2">Nenhuma acao ainda</p>
-        </div>
-        <div id="timeline-items"></div>
-    </div>
-</div>
-
-<style>
-.action-timeline-container {
-    position: fixed;
-    right: 20px;
-    top: 100px;
-    width: 280px;
-    background: white;
-    border-radius: 12px;
-    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
-    z-index: 100;
-    max-height: 400px;
-    overflow: hidden;
-}
-
-.timeline-header {
-    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
-    color: white;
-    padding: 12px 16px;
-    display: flex;
-    justify-content: space-between;
-    align-items: center;
-    cursor: pointer;
-}
-
-.timeline-body {
-    max-height: 340px;
-    overflow-y: auto;
-}
-
-.timeline-item {
-    display: flex;
-    padding: 10px 16px;
-    border-bottom: 1px solid #f0f0f0;
-    align-items: flex-start;
-}
-
-.timeline-item:last-child {
-    border-bottom: none;
-}
-
-.timeline-icon {
-    width: 28px;
-    height: 28px;
-    border-radius: 50%;
-    display: flex;
-    align-items: center;
-    justify-content: center;
-    margin-right: 12px;
-    flex-shrink: 0;
-}
-
-.timeline-icon.pending {
-    background: #fff3cd;
-    color: #856404;
-}
-
-.timeline-icon.success {
-    background: #d4edda;
-    color: #155724;
-}
-
-.timeline-icon.error {
-    background: #f8d7da;
-    color: #721c24;
-}
-
-.timeline-info {
-    flex: 1;
-    min-width: 0;
-}
-
-.timeline-info .tool-name {
-    font-weight: 600;
-    font-size: 0.9rem;
-    margin-bottom: 2px;
-}
-
-.timeline-info .tool-details {
-    font-size: 0.75rem;
-    color: #6c757d;
-}
-
-.timeline-info .tool-duration {
-    font-size: 0.7rem;
-    color: #adb5bd;
-}
-</style>
-
-<script>
-const actionTimeline = [];
-
-function addTimelineItem(action) {
-    actionTimeline.unshift(action);  // Mais recente primeiro
-    renderTimeline();
-
-    document.getElementById('action-count').textContent = actionTimeline.length;
-    document.querySelector('.timeline-empty').style.display = 'none';
-}
-
-function updateLastTimelineItem(updates) {
-    if (actionTimeline.length > 0) {
-        Object.assign(actionTimeline[0], updates);
-        renderTimeline();
-    }
-}
-
-function renderTimeline() {
-    const container = document.getElementById('timeline-items');
-
-    container.innerHTML = actionTimeline.slice(0, 20).map(a => `
-        <div class="timeline-item">
-            <div class="timeline-icon ${a.status}">
-                ${a.status === 'success' ? '<i class="fas fa-check"></i>' :
-                  a.status === 'error' ? '<i class="fas fa-times"></i>' :
-                  '<i class="fas fa-spinner fa-spin"></i>'}
-            </div>
-            <div class="timeline-info">
-                <div class="tool-name">${formatToolName(a.tool_name)}</div>
-                <div class="tool-details">${a.details || ''}</div>
-                ${a.duration_ms ? `<div class="tool-duration">${a.duration_ms}ms</div>` : ''}
-            </div>
-        </div>
-    `).join('');
-}
-
-function formatToolName(name) {
-    const icons = {
-        'Bash': '<i class="fas fa-terminal me-1"></i>',
-        'Read': '<i class="fas fa-file-alt me-1"></i>',
-        'Skill': '<i class="fas fa-magic me-1"></i>',
-        'Glob': '<i class="fas fa-search me-1"></i>',
-        'Grep': '<i class="fas fa-filter me-1"></i>',
-    };
-    return (icons[name] || '<i class="fas fa-cog me-1"></i>') + name;
-}
-
-function toggleTimeline() {
-    const body = document.getElementById('timeline-body');
-    body.style.display = body.style.display === 'none' ? 'block' : 'none';
-}
-
-// No processSSEEvent:
-case 'tool_call':
-    addTimelineItem({
-        tool_name: data.tool_name || data.content,
-        status: 'pending',
-        details: data.tool_id ? `ID: ${data.tool_id.slice(0, 8)}...` : '',
-        timestamp: new Date()
-    });
-    break;
-
-case 'tool_result':
-    updateLastTimelineItem({
-        status: 'success',
-        duration_ms: data.duration_ms || 0
-    });
-    break;
-</script>
-```
-
----
-
-### 5.5 FEAT-008: Todo List Visual
-
-#### Frontend (chat.html)
-
-```html
-<!-- Adicionar abaixo da timeline ou em sidebar separada -->
-<div id="todo-panel" class="todo-panel" style="display: none;">
-    <div class="todo-header">
-        <span><i class="fas fa-tasks me-2"></i>Tarefas</span>
-        <span class="badge bg-primary" id="todo-progress-badge">0%</span>
-    </div>
-    <div class="todo-body">
-        <ul id="todo-list" class="todo-list"></ul>
-        <div class="todo-progress-container">
-            <div class="progress">
-                <div class="progress-bar progress-bar-striped progress-bar-animated"
-                     id="todo-progress-bar"
-                     role="progressbar"
-                     style="width: 0%">
-                </div>
-            </div>
-        </div>
-    </div>
-</div>
-
-<style>
-.todo-panel {
-    position: fixed;
-    right: 20px;
-    top: 520px;  /* Abaixo da timeline */
-    width: 280px;
-    background: white;
-    border-radius: 12px;
-    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
-    z-index: 100;
-}
-
-.todo-header {
-    background: #28a745;
-    color: white;
-    padding: 12px 16px;
-    border-radius: 12px 12px 0 0;
-    display: flex;
-    justify-content: space-between;
-    align-items: center;
-}
-
-.todo-body {
-    padding: 12px;
-}
-
-.todo-list {
-    list-style: none;
-    padding: 0;
-    margin: 0 0 12px;
-    max-height: 200px;
-    overflow-y: auto;
-}
-
-.todo-item {
-    display: flex;
-    align-items: flex-start;
-    padding: 8px 0;
-    border-bottom: 1px solid #f0f0f0;
-}
-
-.todo-item:last-child {
-    border-bottom: none;
-}
-
-.todo-status {
-    width: 24px;
-    height: 24px;
-    border-radius: 50%;
-    display: flex;
-    align-items: center;
-    justify-content: center;
-    margin-right: 10px;
-    flex-shrink: 0;
-    font-size: 0.75rem;
-}
-
-.todo-status.pending {
-    background: #e9ecef;
-    color: #6c757d;
-}
-
-.todo-status.in_progress {
-    background: #cce5ff;
-    color: #004085;
-}
-
-.todo-status.completed {
-    background: #d4edda;
-    color: #155724;
-}
-
-.todo-content {
-    flex: 1;
-    font-size: 0.85rem;
-}
-
-.todo-content.in_progress {
-    font-weight: 600;
-}
-
-.todo-content.completed {
-    text-decoration: line-through;
-    color: #6c757d;
-}
-
-.todo-progress-container {
-    padding-top: 8px;
-    border-top: 1px solid #f0f0f0;
-}
-
-.todo-progress-container .progress {
-    height: 8px;
-    border-radius: 4px;
-}
-</style>
-
-<script>
-let currentTodos = [];
-
-function updateTodoList(todos) {
-    currentTodos = todos;
-    const list = document.getElementById('todo-list');
-    const progressBar = document.getElementById('todo-progress-bar');
-    const progressBadge = document.getElementById('todo-progress-badge');
-    const panel = document.getElementById('todo-panel');
-
-    // Mostrar painel se houver todos
-    if (todos.length > 0) {
-        panel.style.display = 'block';
-    }
-
-    // Renderizar lista
-    list.innerHTML = todos.map(todo => `
-        <li class="todo-item">
-            <span class="todo-status ${todo.status}">
-                ${todo.status === 'completed' ? '<i class="fas fa-check"></i>' :
-                  todo.status === 'in_progress' ? '<i class="fas fa-spinner fa-spin"></i>' :
-                  '<i class="fas fa-circle"></i>'}
-            </span>
-            <span class="todo-content ${todo.status}">
-                ${todo.status === 'in_progress' ? todo.activeForm : todo.content}
-            </span>
-        </li>
-    `).join('');
-
-    // Calcular progresso
-    const completed = todos.filter(t => t.status === 'completed').length;
-    const percent = todos.length > 0 ? Math.round((completed / todos.length) * 100) : 0;
-
-    progressBar.style.width = percent + '%';
-    progressBadge.textContent = percent + '%';
-
-    // Cor do badge baseada no progresso
-    progressBadge.className = 'badge ' + (
-        percent === 100 ? 'bg-success' :
-        percent > 50 ? 'bg-info' : 'bg-primary'
-    );
-}
-
-// No processSSEEvent, adicionar:
-case 'todos':
-    updateTodoList(data.todos);
-    break;
-</script>
-```
-
-#### Backend - Emitir evento de todos
-
-O agente ja usa TodoWrite internamente. Para exibir na UI, precisamos capturar quando o tool e chamado e emitir um evento SSE.
-
-```python
-# Em routes.py, no processamento de tool_result
-if event.type == 'tool_result' and event.metadata.get('tool_name') == 'TodoWrite':
-    # Parsear resultado e emitir evento de todos
-    try:
-        todos = json.loads(event.content)
-        event_queue.put(_sse_event('todos', {'todos': todos.get('todos', [])}))
-    except:
-        pass
-```
-
----
-
-## 6. REFERENCIAS OFICIAIS
-
-### 6.1 Documentacao Claude Code
-
-| Recurso | URL |
-|---------|-----|
-| Claude Code Docs Map | https://code.claude.com/docs/en/claude_code_docs_map.md |
-| Hooks Guide | https://code.claude.com/docs/en/hooks-guide.md |
-| Hooks Reference | https://code.claude.com/docs/en/hooks.md |
-| IAM & Permissions | https://code.claude.com/docs/en/iam.md |
-| Security | https://code.claude.com/docs/en/security.md |
-| Monitoring Usage | https://code.claude.com/docs/en/monitoring-usage.md |
-| Costs | https://code.claude.com/docs/en/costs.md |
-| Analytics | https://code.claude.com/docs/en/analytics.md |
-| Checkpointing | https://code.claude.com/docs/en/checkpointing.md |
-| Headless Mode | https://code.claude.com/docs/en/headless.md |
-| Memory | https://code.claude.com/docs/en/memory.md |
-| Common Workflows | https://code.claude.com/docs/en/common-workflows.md |
-| Slash Commands | https://code.claude.com/docs/en/slash-commands.md |
-
-### 6.2 Documentacao Agent SDK
-
-| Recurso | URL |
-|---------|-----|
-| Agent SDK Overview | https://platform.claude.com/docs/en/agent-sdk/ |
-| Skills | https://platform.claude.com/docs/en/agent-sdk/skills |
-| Sessions | https://platform.claude.com/docs/en/agent-sdk/sessions |
-| Streaming | https://platform.claude.com/docs/en/agent-sdk/streaming-vs-single-mode |
-| Permissions | https://platform.claude.com/docs/en/agent-sdk/permissions |
-| Cost Tracking | https://platform.claude.com/docs/en/agent-sdk/cost-tracking |
-| MCP Integration | https://platform.claude.com/docs/en/agent-sdk/mcp-integration |
-| System Prompts | https://platform.claude.com/docs/en/agent-sdk/modifying-system-prompts |
-
-### 6.3 API Reference
-
-| Recurso | URL |
-|---------|-----|
-| Messages API | https://docs.anthropic.com/en/api/messages |
-| Streaming | https://docs.anthropic.com/en/api/streaming |
-| Tool Use | https://docs.anthropic.com/en/docs/build-with-claude/tool-use |
-| Extended Thinking | https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking |
-| Vision | https://docs.anthropic.com/en/docs/build-with-claude/vision |
-
----
-
-## HISTORICO DE REVISOES
-
-| Versao | Data | Autor | Descricao |
-|--------|------|-------|-----------|
-| 1.0 | 02/12/2025 | Claude Code | Documento inicial |
-| 1.1 | 03/12/2025 | Claude Code | FASE 1 concluida: Seletor Modelo, Thinking, Budget, Timeline, Todo List. Template modularizado. |
-| 1.2 | 03/12/2025 | Claude Code | FASE 2 concluida: Barra Progresso, Plan Mode, Markdown Avancado. Correcao Extended Thinking (max_thinking_tokens). |
-| 1.3 | 03/12/2025 | Claude Code | FASE 3 iniciada: FEAT-011 (Lista de Sessoes) concluido com sidebar colapsavel, modelo AgentSession, API endpoints e persistencia automatica. FEAT-012 (Checkpoints) movido para backlog. Correcao de app context para threads. |
-| 1.4 | 03/12/2025 | Claude Code | FEAT-024 (Layout Otimizado): Layout compacto maximizando area de chat (removido max-height, reduzido paddings). Timeline agora mostra descricoes amigaveis em vez de nomes de ferramentas (ex: "Lendo arquivo.py" em vez de "Read"). SDK emite eventos de TodoWrite para sincronizar lista de tarefas. |
-| 2.0 | 03/12/2025 | Claude Code | FEAT-025 (Layout Fullscreen): Chat ocupa 100% da tela (position fixed, menos navbar). Sidebar de sessoes substituida por Modal centralizado. Header redesenhado com controles inline (modelo, thinking, plan mode). Toggles estilizados. CSS completamente reescrito para layout moderno. |
-| 2.1 | 03/12/2025 | Claude Code | FEAT-026 (UX Melhorias): Tooltips hover nos controles do header. Input mudado para textarea com auto-resize. Shift+Enter = nova linha, Enter = envia. Botao Stop para interromper geracao (vermelho pulsante). Limite de 2000 caracteres. |
-| 2.2 | 03/12/2025 | Claude Code | FEAT-027 (Layout Compacto): Removido max-width do chat (usa tela toda). Mensagens alinhadas a esquerda. Reduzido paddings (header, mensagens, input). Botao de fechar (X) nos paineis de Timeline e Todo. Avatares menores (30px). Paineis compactados. |
-| 2.3 | 03/12/2025 | Claude Code | FEAT-028 (Upload/Download Arquivos): Botao de anexar (üìé) no input. Upload de PDF, XLSX, CSV, imagens. Limite 10MB. Storage temporario por sessao. Area de anexos e downloads acima do input. Deteccao automatica de URLs de arquivos nas respostas. Endpoints: /api/upload, /api/files. |
-
----
-
-## PROXIMOS PASSOS
-
-Para iniciar a implementacao, siga esta ordem:
-
-1. **Revisar este documento** - Confirmar se as prioridades estao corretas
-2. **Criar branch** - `git checkout -b feature/agente-ui-improvements`
-3. **Implementar FASE 1** - Comece por FEAT-001 (Seletor de Modelo)
-4. **Testar cada feature** - Validar antes de prosseguir
-5. **Commit por feature** - Manter historico limpo
-6. **Code review** - Revisar antes de merge
-
-**Comando para iniciar:**
-```bash
-git checkout -b feature/agente-ui-fase1
-```
-
----
-
-*Documento gerado automaticamente por Claude Code em 02/12/2025*
diff --git a/.claude/references/roadmaps/IMPLEMENTACAO_ODOO.md b/.claude/references/roadmaps/IMPLEMENTACAO_ODOO.md
deleted file mode 100644
index 3850751b..00000000
--- a/.claude/references/roadmaps/IMPLEMENTACAO_ODOO.md
+++ /dev/null
@@ -1,936 +0,0 @@
-# ROADMAP DE IMPLEMENTACAO - Consultas Odoo
-
-**Data de Criacao:** 02/12/2025
-**Ultima Atualizacao:** 02/12/2025
-**Status:** Documento vivo - atualizar conforme implementacoes
-
----
-
-## Visao Geral da Arquitetura Odoo
-
-O Odoo utiliza uma arquitetura de modelos relacionais com XML-RPC para comunicacao.
-Os principais dominios de dados relevantes para o sistema de fretes sao:
-
-```
-                    ODOO ERP
-    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
-    ‚îÇ                                                 ‚îÇ
-    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
-    ‚îÇ  ‚îÇ   FISCAL    ‚îÇ      ‚îÇ  FINANCEIRO ‚îÇ          ‚îÇ
-    ‚îÇ  ‚îÇ             ‚îÇ      ‚îÇ             ‚îÇ          ‚îÇ
-    ‚îÇ  ‚îÇ  - DFE      ‚îÇ      ‚îÇ - Faturas   ‚îÇ          ‚îÇ
-    ‚îÇ  ‚îÇ  - CTe      ‚îÇ      ‚îÇ - Parcelas  ‚îÇ          ‚îÇ
-    ‚îÇ  ‚îÇ  - NFe      ‚îÇ      ‚îÇ - Pagamentos‚îÇ          ‚îÇ
-    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
-    ‚îÇ         ‚îÇ                    ‚îÇ                  ‚îÇ
-    ‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îÇ
-    ‚îÇ                  ‚îÇ                              ‚îÇ
-    ‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
-    ‚îÇ         ‚îÇ    COMPRAS      ‚îÇ                     ‚îÇ
-    ‚îÇ         ‚îÇ                 ‚îÇ                     ‚îÇ
-    ‚îÇ         ‚îÇ - Purchase Order‚îÇ                     ‚îÇ
-    ‚îÇ         ‚îÇ - Recebimentos  ‚îÇ                     ‚îÇ
-    ‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
-    ‚îÇ                  ‚îÇ                              ‚îÇ
-    ‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
-    ‚îÇ         ‚îÇ   CADASTROS     ‚îÇ                     ‚îÇ
-    ‚îÇ         ‚îÇ                 ‚îÇ                     ‚îÇ
-    ‚îÇ         ‚îÇ - Parceiros     ‚îÇ                     ‚îÇ
-    ‚îÇ         ‚îÇ - Produtos      ‚îÇ                     ‚îÇ
-    ‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
-    ‚îÇ                                                 ‚îÇ
-    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
-```
-
----
-
-## Status de Implementacao
-
-| Modelo | Status | Skill |
-|--------|--------|-------|
-| DFE (Documentos Fiscais) | ‚úÖ IMPLEMENTADO | rastreando-odoo |
-| DFE Lines | ‚úÖ IMPLEMENTADO | rastreando-odoo |
-| DFE Pagamentos | ‚úÖ IMPLEMENTADO | rastreando-odoo |
-| res.partner | ‚úÖ IMPLEMENTADO | rastreando-odoo |
-| account.move | ‚úÖ IMPLEMENTADO | rastreando-odoo |
-| account.move.line | ‚úÖ IMPLEMENTADO | rastreando-odoo |
-| purchase.order | ‚úÖ IMPLEMENTADO | rastreando-odoo |
-| purchase.order.line | ‚úÖ IMPLEMENTADO | rastreando-odoo |
-| sale.order | ‚úÖ IMPLEMENTADO | rastreando-odoo |
-| stock.picking | ‚úÖ IMPLEMENTADO | rastreando-odoo |
-| account.full.reconcile | ‚úÖ IMPLEMENTADO | rastreando-odoo |
-| product.product | üîç | descobrindo-odoo-estrutura |
-
-> **NOTA**: Skills `consultando-odoo-*` foram consolidadas em `rastreando-odoo` (16/12/2025)
-
-**Legenda:**
-- ‚úÖ IMPLEMENTADO: Script funcional e documentacao completa
-- üü° PARCIAL: Campos mapeados, falta script
-- üìã MAPEADO: Campos descobertos nesta sessao, aguarda implementacao
-- ‚¨ú PENDENTE: Nao mapeado ainda
-
----
-
-## DOMINIO 1: FISCAL (DFE)
-
-### 1.1 Modelo Principal: l10n_br_ciel_it_account.dfe
-
-**Status:** ‚úÖ IMPLEMENTADO
-
-**Descricao:** Documento Fiscal Eletronico - armazena todas as notas fiscais recebidas (NFe, CTe, NFSe)
-
-#### Campos de Identificacao
-| Campo | Tipo | Descricao | Uso |
-|-------|------|-----------|-----|
-| `id` | integer | ID interno | PK |
-| `protnfe_infnfe_chnfe` | char | Chave de acesso 44 digitos | Identificador unico |
-| `nfe_infnfe_ide_nnf` | char | Numero da NF | Busca |
-| `nfe_infnfe_ide_serie` | char | Serie | Complemento numero |
-| `nfe_infnfe_ide_mod` | char | Modelo: 55=NFe, 57=CTe | Tipo documento |
-| `company_id` | many2one | Empresa destinataria | Filtro obrigatorio |
-
-#### Campos de Finalidade
-| Campo | Tipo | Valores | Uso |
-|-------|------|---------|-----|
-| `nfe_infnfe_ide_finnfe` | selection | 1=Normal, 2=Complementar, 3=Ajuste, 4=Devolucao | Subtipo |
-| `is_cte` | boolean | True/False | Identificar CTe |
-| `l10n_br_tipo_pedido` | selection | servico, mercadoria, etc | Tipo pedido |
-
-#### Campos de Datas
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `nfe_infnfe_ide_dhemi` | datetime | Data/hora emissao |
-| `nfe_infnfe_ide_dhsaient` | datetime | Data/hora saida/entrada |
-| `l10n_br_date_in` | date | Data entrada no sistema |
-| `l10n_br_data_entrada` | date | Data de lancamento |
-
-#### Campos do Emitente (Fornecedor)
-| Campo | Tipo | Formato | Observacao |
-|-------|------|---------|------------|
-| `partner_id` | many2one | ID res.partner | Relacionamento |
-| `nfe_infnfe_emit_cnpj` | char | XX.XXX.XXX/XXXX-XX | **COM pontuacao** |
-| `nfe_infnfe_emit_cpf` | char | - | Pessoa fisica |
-| `nfe_infnfe_emit_xnome` | char | - | Razao social |
-| `nfe_infnfe_emit_xfant` | char | - | Nome fantasia |
-| `nfe_infnfe_emit_ie` | char | - | Inscricao estadual |
-| `nfe_infnfe_emit_ender_xlgr` | char | - | Logradouro |
-| `nfe_infnfe_emit_ender_xmun` | char | - | Municipio |
-| `nfe_infnfe_emit_ender_uf` | char | - | UF |
-
-#### Campos do Destinatario (Empresa)
-| Campo | Tipo | Formato | Observacao |
-|-------|------|---------|------------|
-| `partner_dest_id` | many2one | ID res.partner | Relacionamento |
-| `nfe_infnfe_dest_cnpj` | char | XXXXXXXXXXXXXX | **SEM pontuacao** |
-| `nfe_infnfe_dest_cpf` | char | - | Pessoa fisica |
-| `nfe_infnfe_dest_uf` | char | - | UF |
-
-> **ATENCAO:** O campo `nfe_infnfe_dest_xnome` NAO EXISTE. Usar `partner_dest_id` para dados do destinatario.
-
-#### Campos de Totais Gerais
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `nfe_infnfe_total_icmstot_vnf` | float | **Valor Total da NF** |
-| `nfe_infnfe_total_icmstot_vprod` | float | Valor produtos |
-| `nfe_infnfe_total_icms_vdesc` | float | Valor desconto |
-| `nfe_infnfe_total_icms_vfrete` | float | Valor frete |
-| `nfe_infnfe_total_icms_vseg` | float | Valor seguro |
-| `nfe_infnfe_total_icms_voutro` | float | Outras despesas |
-
-#### Campos de ICMS (Totais)
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `nfe_infnfe_total_icms_vbc` | float | Base de calculo ICMS |
-| `nfe_infnfe_total_icms_vicms` | float | **Valor ICMS** |
-| `nfe_infnfe_total_icms_vicmsdeson` | char | ICMS desonerado |
-
-#### Campos de ICMS-ST (Totais)
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `nfe_infnfe_total_icms_vbcst` | float | Base ICMS-ST |
-| `nfe_infnfe_total_icms_vst` | float | **Valor ICMS-ST** |
-
-#### Campos de PIS/COFINS/IPI (Totais)
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `nfe_infnfe_total_icms_vpis` | float | Valor PIS |
-| `nfe_infnfe_total_icms_vcofins` | float | Valor COFINS |
-| `nfe_infnfe_total_icms_vipi` | float | Valor IPI |
-
-#### Campos de Status
-| Campo | Tipo | Valores |
-|-------|------|---------|
-| `l10n_br_status` | selection | 01=Novo, 02=Manifestado, 03=Ciencia, **04=PO**, 05=Faturado, 06=Cancelado, 07=Denegado |
-| `state` | selection | Estado do registro |
-| `active` | boolean | Ativo/Inativo |
-
-> **IMPORTANTE:** Status '04' (PO) indica documento pronto para lancamento.
-
-#### Campos de CTe Especificos
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `cte_infcte_ide_cmunini` | char | Codigo municipio origem |
-| `cte_infcte_ide_cmunfim` | char | Codigo municipio destino |
-| `cte_infcte_ide_toma3_toma` | char | Tomador (0=Rem, 1=Exp, 2=Rec, 3=Dest) |
-
-#### Campos de Relacionamento
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `partner_id` | many2one | Parceiro emitente (res.partner) |
-| `partner_dest_id` | many2one | Parceiro destinatario |
-| `purchase_id` | many2one | Pedido de compra vinculado |
-| `purchase_fiscal_id` | many2one | PO de escrituracao |
-| `invoice_ids` | one2many | Faturas vinculadas |
-| `refs_ids` | one2many | NF referenciadas |
-| `payment_reference` | char | Referencia pagamento |
-
-#### Campos de Arquivo
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `l10n_br_pdf_dfe` | binary | DANFE PDF (base64) |
-| `l10n_br_pdf_dfe_fname` | char | Nome arquivo PDF |
-| `l10n_br_xml_dfe` | binary | XML (base64) |
-| `l10n_br_xml_dfe_fname` | char | Nome arquivo XML |
-| `l10n_br_body_xml_dfe` | text | Conteudo XML |
-
----
-
-### 1.2 Modelo Linhas: l10n_br_ciel_it_account.dfe.line
-
-**Status:** ‚úÖ IMPLEMENTADO
-
-**Descricao:** Itens/produtos do documento fiscal
-
-#### Campos de Produto
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `id` | integer | ID da linha |
-| `dfe_id` | many2one | DFE pai |
-| `product_id` | many2one | Produto vinculado |
-| `det_prod_cprod` | char | Codigo produto (fornecedor) |
-| `det_prod_xprod` | char | Descricao produto |
-| `det_prod_ncm` | char | NCM |
-| `det_prod_cfop` | char | CFOP |
-| `det_infadprod` | char | Dados adicionais |
-
-#### Campos de Quantidade/Valor
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `det_prod_qcom` | float | Quantidade |
-| `det_prod_ucom` | char | Unidade |
-| `det_prod_vuncom` | float | Valor unitario |
-| `det_prod_vprod` | float | Valor total item |
-| `det_prod_vdesc` | float | Desconto |
-| `det_prod_vfrete` | float | Frete (rateio) |
-| `det_prod_vseg` | float | Seguro (rateio) |
-| `det_prod_voutro` | float | Outros (rateio) |
-
-#### Campos de Pedido do Cliente
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `det_prod_xped` | char | Numero pedido cliente |
-| `det_prod_nitemped` | char | Item pedido cliente |
-
-#### Campos de ICMS (Linha)
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `det_imposto_icms_cst` | char | **CST ICMS** |
-| `det_imposto_icms_orig` | char | Origem mercadoria (0-8) |
-| `det_imposto_icms_vbc` | float | Base calculo |
-| `det_imposto_icms_picms` | float | **Aliquota %** |
-| `det_imposto_icms_vicms` | float | Valor ICMS |
-| `det_imposto_icms_predbc` | float | % Reducao base |
-
-#### Campos de ICMS Simples Nacional (Linha)
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `det_imposto_icms_pcredsn` | float | % Credito SN |
-| `det_imposto_icms_vcredicmssn` | float | Valor credito SN |
-
-#### Campos de ICMS-ST (Linha)
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `det_imposto_icms_vbcst` | float | Base ICMS-ST |
-| `det_imposto_icms_vicmsst` | float | Valor ICMS-ST |
-| `det_imposto_icms_vbcstret` | float | Base ST retido |
-| `det_imposto_icms_vicmsstret` | float | Valor ST retido |
-| `det_imposto_icms_vicmssubstituto` | float | Valor substituto |
-
-#### Campos de PIS (Linha)
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `det_imposto_pis_cst` | char | CST PIS |
-| `det_imposto_pis_vbc` | float | Base PIS |
-| `det_imposto_pis_ppis` | float | Aliquota % |
-| `det_imposto_pis_vpis` | float | Valor PIS |
-
-#### Campos de COFINS (Linha)
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `det_imposto_cofins_cst` | char | CST COFINS |
-| `det_imposto_cofins_vbc` | float | Base COFINS |
-| `det_imposto_cofins_pcofins` | float | Aliquota % |
-| `det_imposto_cofins_vcofins` | float | Valor COFINS |
-
-#### Campos de IPI (Linha)
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `det_imposto_ipi_cst` | char | CST IPI |
-| `det_imposto_ipi_vbc` | float | Base IPI |
-| `det_imposto_ipi_pipi` | float | Aliquota % |
-| `det_imposto_ipi_vipi` | float | Valor IPI |
-
-#### Campos de Centro de Custo
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `account_analytic_id` | many2one | Conta analitica |
-| `analytic_distribution` | json | Distribuicao analitica |
-
----
-
-### 1.3 Modelo Pagamentos: l10n_br_ciel_it_account.dfe.pagamento
-
-**Status:** üü° PARCIAL (mapeado, falta script)
-
-**Descricao:** Duplicatas/parcelas do documento fiscal
-
-#### Campos Principais
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `id` | integer | ID |
-| `dfe_id` | many2one | DFE vinculado |
-| `company_id` | many2one | Empresa |
-
-#### Campos da Duplicata
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `cobr_dup_ndup` | char | Numero da parcela |
-| `cobr_dup_dvenc` | date | **Data vencimento** |
-| `cobr_dup_vdup` | float | **Valor parcela** |
-
----
-
-## DOMINIO 2: FINANCEIRO
-
-### 2.1 Modelo: account.move
-
-**Status:** üìã MAPEADO (aguarda implementacao)
-
-**Descricao:** Faturas e documentos contabeis
-
-#### Campos Principais (Descobertos via DOCUMENTACAO_TABELAS_ODOO_CONTAS_RECEBER.md)
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `id` | integer | ID |
-| `name` | char | Numero documento |
-| `move_type` | selection | Tipo: out_invoice, in_invoice, out_refund, in_refund |
-| `state` | selection | Estado: draft, posted, cancel |
-| `partner_id` | many2one | Parceiro |
-| `invoice_date` | date | Data fatura |
-| `invoice_date_due` | date | Data vencimento |
-| `amount_total` | float | Valor total |
-| `amount_residual` | float | Valor residual (em aberto) |
-| `company_id` | many2one | Empresa |
-| `journal_id` | many2one | Diario |
-
-#### Subtipos por move_type
-| Valor | Descricao | Uso |
-|-------|-----------|-----|
-| `out_invoice` | Fatura de venda | Contas a receber |
-| `in_invoice` | Fatura de compra | Contas a pagar |
-| `out_refund` | Nota credito venda | Devolucao cliente |
-| `in_refund` | Nota credito compra | Devolucao fornecedor |
-| `entry` | Lancamento manual | Ajustes |
-
-#### Relacionamentos
-- `invoice_line_ids` -> account.move.line (itens)
-- `payment_ids` -> account.payment (pagamentos)
-
----
-
-### 2.2 Modelo: account.move.line
-
-**Status:** üìã MAPEADO (aguarda implementacao)
-
-**Descricao:** Linhas de movimento contabil - parcelas a pagar/receber
-
-#### Campos Principais
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `id` | integer | ID |
-| `move_id` | many2one | Fatura pai |
-| `account_id` | many2one | Conta contabil |
-| `partner_id` | many2one | Parceiro |
-| `name` | char | Descricao |
-| `date` | date | Data |
-| `date_maturity` | date | **Data vencimento** |
-| `debit` | float | Debito |
-| `credit` | float | Credito |
-| `balance` | float | Saldo |
-| `amount_currency` | float | Valor moeda |
-| `amount_residual` | float | **Valor em aberto** |
-| `amount_residual_currency` | float | Residual moeda |
-| `reconciled` | boolean | Conciliado |
-| `full_reconcile_id` | many2one | Conciliacao completa |
-
-#### Campos Brasileiros
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `dfe_line_id` | many2one | Vinculo linha DFE |
-| `l10n_br_cfop_id` | many2one | CFOP |
-| `l10n_br_cobranca_nossonumero` | char | Nosso numero boleto |
-| `l10n_br_cobranca_situacao` | selection | Situacao cobranca |
-
-#### Filtros Uteis
-```python
-# Contas a receber em aberto
-[('account_id.account_type', '=', 'asset_receivable'), ('amount_residual', '>', 0)]
-
-# Contas a pagar em aberto
-[('account_id.account_type', '=', 'liability_payable'), ('amount_residual', '>', 0)]
-
-# Vencidos
-[('date_maturity', '<', 'hoje'), ('amount_residual', '>', 0)]
-```
-
----
-
-### 2.3 Modelo: account.payment
-
-**Status:** ‚¨ú PENDENTE
-
-**Descricao:** Pagamentos e recebimentos
-
-#### Campos Principais (a mapear)
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `id` | integer | ID |
-| `name` | char | Numero |
-| `payment_type` | selection | inbound/outbound |
-| `partner_id` | many2one | Parceiro |
-| `amount` | float | Valor |
-| `date` | date | Data |
-| `state` | selection | Estado |
-
----
-
-## DOMINIO 3: COMPRAS
-
-### 3.1 Modelo: purchase.order
-
-**Status:** üìã MAPEADO (aguarda implementacao)
-
-**Descricao:** Pedidos de compra
-
-#### Campos Principais
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `id` | integer | ID |
-| `name` | char | Numero PO |
-| `partner_id` | many2one | Fornecedor |
-| `date_order` | datetime | Data pedido |
-| `date_planned` | datetime | Data prevista |
-| `state` | selection | Estado |
-| `amount_total` | float | Valor total |
-| `company_id` | many2one | Empresa |
-| `picking_type_id` | many2one | Tipo recebimento |
-
-#### Estados (state)
-| Valor | Descricao |
-|-------|-----------|
-| `draft` | Rascunho |
-| `sent` | Enviado |
-| `to approve` | Aguardando aprovacao |
-| `purchase` | Confirmado |
-| `done` | Concluido |
-| `cancel` | Cancelado |
-
-#### Relacionamentos com DFE
-| Campo | Descricao |
-|-------|-----------|
-| `dfe_ids` | DFEs vinculados |
-| `invoice_ids` | Faturas geradas |
-
----
-
-## DOMINIO 4: CADASTROS
-
-### 4.1 Modelo: res.partner
-
-**Status:** üìã MAPEADO (aguarda implementacao)
-
-**Descricao:** Parceiros (fornecedores, clientes, transportadoras)
-
-#### Campos Principais
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `id` | integer | ID |
-| `name` | char | Nome/Razao social |
-| `display_name` | char | Nome exibicao |
-| `is_company` | boolean | Empresa/Pessoa |
-| `company_type` | selection | company/person |
-| `vat` | char | CNPJ/CPF (sem formatacao) |
-| `l10n_br_cnpj_cpf` | char | CNPJ/CPF formatado |
-| `l10n_br_ie` | char | Inscricao estadual |
-| `email` | char | Email |
-| `phone` | char | Telefone |
-| `mobile` | char | Celular |
-
-#### Campos de Endereco
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `street` | char | Logradouro |
-| `street2` | char | Complemento |
-| `city` | char | Cidade |
-| `state_id` | many2one | Estado (res.country.state) |
-| `zip` | char | CEP |
-| `country_id` | many2one | Pais |
-
-#### Campos de Tipo
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `supplier_rank` | integer | Ranking fornecedor (>0 = fornecedor) |
-| `customer_rank` | integer | Ranking cliente (>0 = cliente) |
-| `is_company` | boolean | Eh empresa |
-
-#### Filtros Uteis
-```python
-# Fornecedores
-[('supplier_rank', '>', 0)]
-
-# Clientes
-[('customer_rank', '>', 0)]
-
-# Por CNPJ
-[('vat', 'ilike', '18467441')]  # ou l10n_br_cnpj_cpf
-
-# Por UF
-[('state_id.code', '=', 'SP')]
-```
-
----
-
-### 4.2 Modelo: product.product
-
-**Status:** ‚¨ú PENDENTE
-
-**Descricao:** Produtos
-
-#### Campos Principais (a mapear)
-| Campo | Tipo | Descricao |
-|-------|------|-----------|
-| `id` | integer | ID |
-| `name` | char | Nome |
-| `default_code` | char | Codigo interno |
-| `barcode` | char | Codigo barras |
-| `list_price` | float | Preco venda |
-| `standard_price` | float | Preco custo |
-| `categ_id` | many2one | Categoria |
-| `uom_id` | many2one | Unidade medida |
-
-#### Campos Brasileiros (a mapear)
-- NCM
-- Origem
-- CFOP padrao
-- Aliquotas padrao
-
----
-
-## DIAGRAMA DE RELACIONAMENTOS
-
-```
-‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
-‚îÇ                         RELACIONAMENTOS ODOO                             ‚îÇ
-‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
-‚îÇ                                                                         ‚îÇ
-‚îÇ   res.partner ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
-‚îÇ   (Fornecedor)                                             ‚îÇ            ‚îÇ
-‚îÇ       ‚îÇ                                                    ‚îÇ            ‚îÇ
-‚îÇ       ‚îÇ partner_id                                         ‚îÇ            ‚îÇ
-‚îÇ       ‚ñº                                                    ‚îÇ            ‚îÇ
-‚îÇ   l10n_br_ciel_it_account.dfe ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§            ‚îÇ
-‚îÇ   (Documento Fiscal)                                       ‚îÇ            ‚îÇ
-‚îÇ       ‚îÇ                                                    ‚îÇ            ‚îÇ
-‚îÇ       ‚îú‚îÄ‚îÄ dfe.line (Itens)                                ‚îÇ            ‚îÇ
-‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ product_id ‚îÄ‚îÄ‚ñ∫ product.product          ‚îÇ            ‚îÇ
-‚îÇ       ‚îÇ                                                    ‚îÇ            ‚îÇ
-‚îÇ       ‚îú‚îÄ‚îÄ dfe.pagamento (Duplicatas)                      ‚îÇ            ‚îÇ
-‚îÇ       ‚îÇ                                                    ‚îÇ            ‚îÇ
-‚îÇ       ‚îÇ purchase_id                                        ‚îÇ            ‚îÇ
-‚îÇ       ‚ñº                                                    ‚îÇ            ‚îÇ
-‚îÇ   purchase.order ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§            ‚îÇ
-‚îÇ   (Pedido Compra)                                          ‚îÇ            ‚îÇ
-‚îÇ       ‚îÇ                                                    ‚îÇ            ‚îÇ
-‚îÇ       ‚îÇ action_create_invoice                              ‚îÇ            ‚îÇ
-‚îÇ       ‚ñº                                                    ‚îÇ            ‚îÇ
-‚îÇ   account.move ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
-‚îÇ   (Fatura)                                                              ‚îÇ
-‚îÇ       ‚îÇ                                                                 ‚îÇ
-‚îÇ       ‚îî‚îÄ‚îÄ account.move.line (Parcelas)                                  ‚îÇ
-‚îÇ               ‚îÇ                                                         ‚îÇ
-‚îÇ               ‚îî‚îÄ‚îÄ dfe_line_id ‚îÄ‚îÄ‚ñ∫ dfe.line                             ‚îÇ
-‚îÇ                                                                         ‚îÇ
-‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
-```
-
----
-
-## ROADMAP DE IMPLEMENTACAO
-
-### Fase 1: DFE Avancado (Curto Prazo) ‚úÖ CONCLUIDA
-**Prioridade:** Alta
-**Esforco:** Baixo (mesmo modelo)
-**Data conclusao:** 02/12/2025
-
-1. [x] Adicionar filtro `--ncm` para buscar por NCM
-2. [x] Adicionar filtro `--cfop` para buscar por CFOP
-3. [x] Adicionar filtro `--com-icms-st` (vst > 0)
-4. [x] Adicionar filtro `--com-ipi` (vipi > 0)
-5. [x] Adicionar filtro `--valor-min` e `--valor-max`
-6. [x] Implementar consulta de pagamentos (dfe.pagamento)
-
-### Fase 2: Parceiros/Cadastros (Curto Prazo) ‚úÖ CONCLUIDA
-**Prioridade:** Alta
-**Esforco:** Medio
-**Data conclusao:** 02/12/2025
-**Skill criada:** consultando-odoo-cadastros
-
-1. [x] Mapear campos res.partner com skill descobrindo-odoo-estrutura (316 campos)
-2. [x] Mapear campos delivery.carrier para transportadoras (34 campos)
-3. [x] Criar skill separada: consultando-odoo-cadastros
-4. [x] Criar documentacao reference/PARTNER.md
-5. [x] Criar documentacao reference/CARRIER.md
-6. [x] Implementar `--tipo partner` e `--tipo transportadora`
-7. [x] Subtipos partner: fornecedor, cliente, todos
-8. [x] Filtros: --cnpj, --nome, --uf, --cidade, --ie, --email
-9. [x] Opcoes de saida: --endereco, --fiscal, --detalhes, --json
-
-### Fase 3: Financeiro (Medio Prazo) ‚úÖ CONCLUIDA
-**Prioridade:** Media
-**Esforco:** Alto
-**Data conclusao:** 02/12/2025
-**Skill criada:** consultando-odoo-financeiro
-
-1. [x] Mapear campos account.move (376 campos) e account.move.line (315 campos)
-2. [x] Criar skill separada: consultando-odoo-financeiro
-3. [x] Criar documentacao reference/FINANCEIRO.md
-4. [x] Implementar subtipos: a-pagar, a-receber, vencidos, a-vencer, todos
-5. [x] Filtros: --vencimento-ate, --vencimento-de, --parceiro, --cnpj
-6. [x] Filtros avancados: --valor-min, --valor-max, --dias-atraso
-7. [x] Opcoes de saida: --detalhes (parcelas), --resumo (totalizadores), --json
-
-### Fase 4: Compras (Medio Prazo) ‚úÖ CONCLUIDA
-**Prioridade:** Media
-**Esforco:** Medio
-**Data conclusao:** 02/12/2025
-**Skill criada:** consultando-odoo-compras
-
-1. [x] Mapear campos purchase.order (165 campos) e purchase.order.line (201 campos)
-2. [x] Criar skill separada: consultando-odoo-compras
-3. [x] Criar documentacao reference/PURCHASE.md
-4. [x] Implementar subtipos: pendentes, confirmados, recebidos, a-faturar, cancelados, todos
-5. [x] Filtros: --fornecedor, --cnpj, --numero-po, --data-inicio, --data-fim
-6. [x] Filtros avancados: --valor-min, --valor-max, --produto, --origem
-7. [x] Opcoes de saida: --detalhes (linhas), --fiscais (tributos), --resumo (totalizadores), --json
-
-### Fase 5: Produtos (Longo Prazo) ‚úÖ CONCLUIDA
-**Prioridade:** Baixa
-**Esforco:** Medio
-**Data conclusao:** 02/12/2025
-**Skill criada:** consultando-odoo-produtos
-
-1. [x] Mapear campos product.product (229 campos) e product.template (196 campos)
-2. [x] Criar skill separada: consultando-odoo-produtos
-3. [x] Criar documentacao reference/PRODUCT.md
-4. [x] Implementar subtipos: ativos, inativos, vendaveis, compraveis, estocaveis, servicos, consumiveis, todos
-5. [x] Filtros: --codigo, --nome, --barcode, --categoria, --ncm, --fornecedor, --preco-min/max, --com-estoque, --sem-estoque
-6. [x] Opcoes de saida: --detalhes (fornecedores, estoque), --fiscais (NCM, origem), --resumo (totalizadores), --json
-
----
-
-## TABELAS DE CST (Referencia Rapida)
-
-### CST ICMS
-| CST | Descricao | Quando Usar |
-|-----|-----------|-------------|
-| 00 | Tributada integralmente | Operacao normal |
-| 10 | Com cobranca ICMS-ST | Substituicao tributaria |
-| 20 | Com reducao de base | Base reduzida |
-| 30 | Isenta com ST | Isento mas tem ST |
-| 40 | Isenta | Isencao |
-| 41 | Nao tributada | Fora do campo de incidencia |
-| 50 | Suspensao | Suspensa |
-| 51 | Diferimento | Diferido |
-| 60 | Cobrado anteriormente por ST | Ja pagou ST |
-| 70 | Reducao + ST | Ambos |
-| 90 | Outras | Outros casos |
-
-### CST PIS/COFINS
-| CST | Descricao |
-|-----|-----------|
-| 01 | Aliquota basica |
-| 02 | Aliquota diferenciada |
-| 04 | Monofasica revenda zero |
-| 06 | Aliquota zero |
-| 07 | Isenta |
-| 08 | Sem incidencia |
-| 09 | Suspensao |
-| 49 | Outras saidas |
-| 50-56 | Com direito credito |
-| 70-75 | Sem direito credito |
-
-### CST IPI
-| CST | Descricao |
-|-----|-----------|
-| 00-05 | Entradas |
-| 49 | Outras entradas |
-| 50-55 | Saidas |
-| 99 | Outras saidas |
-
----
-
-## PADROES DE IMPLEMENTACAO
-
-### Estrutura de Configuracao no Script
-
-```python
-MODELOS_CONHECIDOS = {
-    'nome_modelo': {
-        'modelo_odoo': 'nome.modelo.odoo',
-        'modelo_linha': 'nome.modelo.linha',  # se aplicavel
-        'subtipos': {
-            'subtipo1': {'filtro': ('campo', '=', 'valor')},
-            'subtipo2': {'filtro': ('campo', '=', 'valor')},
-        },
-        'campos_principais': [
-            'id',
-            'campo1',
-            'campo2',
-        ],
-        'campos_opcionais': [
-            # Campos extras para --detalhes ou --fiscais
-        ],
-        'campo_busca': 'campo_principal_busca',
-        'campo_data': 'campo_data_principal',
-    }
-}
-```
-
-### Padrao de Funcao de Consulta
-
-```python
-def consultar_MODELO(args) -> Dict[str, Any]:
-    """
-    Consulta MODELO no Odoo
-    """
-    from app.odoo.utils.connection import get_odoo_connection
-
-    config = MODELOS_CONHECIDOS['modelo']
-    resultado = {
-        'sucesso': False,
-        'tipo': 'modelo',
-        'subtipo': args.subtipo,
-        'total': 0,
-        'registros': [],
-        'erro': None
-    }
-
-    try:
-        odoo = get_odoo_connection()
-        if not odoo.authenticate():
-            resultado['erro'] = 'Falha na autenticacao'
-            return resultado
-
-        # Montar filtros
-        filtros = []
-        # ... adicionar filtros baseado nos args
-
-        # Buscar registros
-        registros = odoo.search_read(
-            config['modelo_odoo'],
-            filtros,
-            fields=config['campos_principais'],
-            limit=args.limit or 100
-        )
-
-        resultado['sucesso'] = True
-        resultado['total'] = len(registros)
-        resultado['registros'] = registros
-
-    except Exception as e:
-        resultado['erro'] = str(e)
-
-    return resultado
-```
-
----
-
-## CONEXAO COM ODOO
-
-```python
-from app.odoo.utils.connection import get_odoo_connection
-
-# Autenticacao
-odoo = get_odoo_connection()
-if not odoo.authenticate():
-    raise Exception("Falha na autenticacao")
-
-# Operacoes disponiveis
-odoo.search_read(modelo, filtros, fields, limit)
-odoo.read(modelo, ids, fields)
-odoo.write(modelo, ids, valores)
-odoo.execute_kw(modelo, metodo, args, kwargs)
-```
-
----
-
-## NOTAS IMPORTANTES
-
-1. **CNPJ do Emitente:** Armazenado COM pontuacao (XX.XXX.XXX/XXXX-XX)
-2. **CNPJ do Destinatario:** Armazenado SEM pontuacao
-3. **Status DFE '04':** Documento pronto para lancamento
-4. **Filtro active:** Sempre incluir `'|', ('active', '=', True), ('active', '=', False)` para ver todos
-5. **Campos inexistentes:** `nfe_infnfe_dest_xnome` NAO existe - usar partner_dest_id
-6. **CST vs CSOSN:** Empresas Simples Nacional usam CSOSN
-
----
-
-## ATUALIZACOES DESTE DOCUMENTO
-
-| Data | Alteracao |
-|------|-----------|
-| 02/12/2025 | Criacao do documento |
-| 02/12/2025 | Mapeamento completo DFE com campos fiscais |
-| 02/12/2025 | Mapeamento parcial account.move.line (via doc contas receber) |
-| 02/12/2025 | Roadmap de implementacao definido |
-| 02/12/2025 | Fase 1 concluida: filtros avancados (NCM, CFOP, ICMS-ST, IPI, valor) e pagamentos |
-| 02/12/2025 | Fase 2 concluida: nova skill consultando-odoo-cadastros (res.partner, delivery.carrier) |
-| 02/12/2025 | Fase 3 concluida: nova skill consultando-odoo-financeiro (account.move, account.move.line) |
-| 02/12/2025 | Fase 4 concluida: nova skill consultando-odoo-compras (purchase.order, purchase.order.line) |
-
----
-
-## PROXIMOS PASSOS SUGERIDOS
-
-1. ‚úÖ ~~Validar mapeamento res.partner~~ - Concluido (316 campos)
-2. ‚úÖ ~~Implementar Fase 1~~ - Filtros avancados no DFE
-3. ‚úÖ ~~Criar reference/PARTNER.md~~ - Documentacao criada
-4. ‚úÖ ~~Implementar --tipo partner~~ - Nova skill consultando-odoo-cadastros
-5. ‚úÖ ~~Fase 3: Financeiro~~ - Nova skill consultando-odoo-financeiro (691 campos)
-6. ‚úÖ ~~Fase 4: Compras~~ - Nova skill consultando-odoo-compras (366 campos)
-7. ‚úÖ ~~Fase 5: Produtos~~ - Nova skill consultando-odoo-produtos (425 campos)
-
-**ROADMAP COMPLETO!** Todas as fases de implementacao foram concluidas.
-As proximas evolucoes podem incluir:
-- Consultas de vendas (sale.order)
-- Consultas de estoque (stock.move, stock.picking)
-- Consultas de pagamentos (account.payment)
-
----
-
-## PADRAO PARA CRIACAO DE NOVAS SKILLS (Anthropic Guidelines)
-
-### Estrategia de Separacao por Dominio
-
-Cada dominio significativo deve ter **skill separada** para melhor match do Agent SDK:
-
-```
-.claude/skills/
-‚îú‚îÄ‚îÄ consultando-odoo-dfe/           # DFE/Documentos fiscais (IMPLEMENTADO)
-‚îú‚îÄ‚îÄ descobrindo-odoo-estrutura/     # Descoberta de campos/modelos (IMPLEMENTADO)
-‚îú‚îÄ‚îÄ consultando-odoo-cadastros/     # Parceiros/Transportadoras (IMPLEMENTADO)
-‚îú‚îÄ‚îÄ consultando-odoo-financeiro/    # Contas a pagar/receber (IMPLEMENTADO)
-‚îú‚îÄ‚îÄ consultando-odoo-compras/       # Pedidos de Compra (IMPLEMENTADO)
-‚îî‚îÄ‚îÄ consultando-odoo-produtos/      # Catalogo de Produtos (IMPLEMENTADO)
-```
-
-### Template para Nova Skill
-
-**Estrutura de diretorio:**
-```
-consultando-odoo-{dominio}/
-‚îú‚îÄ‚îÄ SKILL.md                    # Frontmatter + documentacao
-‚îú‚îÄ‚îÄ scripts/
-‚îÇ   ‚îî‚îÄ‚îÄ consulta.py             # Script de consulta
-‚îî‚îÄ‚îÄ reference/
-    ‚îî‚îÄ‚îÄ {MODELO}.md             # Documentacao de campos
-```
-
-**Frontmatter SKILL.md (description eh CRITICO):**
-```yaml
----
-name: consultando-odoo-{dominio}
-description: "{O QUE FAZ}. {KEYWORDS de busca}. Use para: {CASOS DE USO especificos}."
----
-```
-
-### Checklist para Description Efetiva
-
-A description deve:
-1. **Comecar com acao** - "Busca...", "Consulta...", "Localiza..."
-2. **Listar keywords** - Termos que o usuario pode usar
-3. **Explicar casos de uso** - "Use para: X, Y, Z"
-4. **Ser especifica** - Evitar termos genericos como "dados", "informacoes"
-5. **Ter menos de 300 caracteres** - Concisa e direta
-
-### Exemplos de Descriptions por Dominio
-
-**consultando-odoo-dfe (ATUAL):**
-```yaml
-description: "Busca documentos fiscais (DFE) no Odoo: devolucoes, CTe de frete,
-notas de entrada, tributos (ICMS, PIS, COFINS, IPI, ST). Use para: NF de devolucao,
-CTe de transportadora, nota de fornecedor, impostos de nota fiscal, localizar
-documento por chave, CNPJ, nome, numero NF, produto ou periodo."
-```
-
-**consultando-odoo-financeiro (FUTURO):**
-```yaml
-description: "Consulta contas a pagar e receber no Odoo. Busca parcelas, vencimentos,
-faturas, titulos em aberto. Use para: parcelas vencidas, contas a pagar de fornecedor,
-vencimentos da semana, saldo devedor por parceiro, relatorio de inadimplencia."
-```
-
-**consultando-odoo-cadastros (IMPLEMENTADO):**
-```yaml
-description: "Busca fornecedores, clientes e transportadoras no Odoo (res.partner, delivery.carrier).
-Use para: localizar fornecedor por CNPJ, dados de transportadora, endereco de cliente,
-inscricao estadual, cadastro de parceiro, consultar ranking cliente/fornecedor."
-```
-
-**consultando-odoo-compras (FUTURO):**
-```yaml
-description: "Consulta pedidos de compra no Odoo (purchase.order). Busca POs por
-fornecedor, status, periodo. Use para: pedidos pendentes, compras do mes, PO vinculado
-a nota, historico de compras de fornecedor."
-```
-
-### Quando Criar Nova Skill vs Expandir Existente
-
-**CRIAR NOVA SKILL quando:**
-- Dominio tem > 10 campos especificos
-- Casos de uso sao distintos do dominio atual
-- Description ficaria > 300 caracteres se combinada
-- Keywords nao se sobrepoe significativamente
-
-**EXPANDIR SKILL EXISTENTE quando:**
-- Funcionalidade eh extensao natural (ex: mais filtros no DFE)
-- Compartilha mesmos casos de uso
-- Reutiliza mesma estrutura de consulta
-
-### Migracao Gradual
-
-1. ‚úÖ **Fase 1 concluida:** consultando-odoo-dfe cobre DFE, CTe, pagamentos
-2. ‚úÖ **Fase 2 concluida:** consultando-odoo-cadastros cobre parceiros e transportadoras
-3. ‚úÖ **Fase 3 concluida:** consultando-odoo-financeiro cobre contas a pagar/receber
-4. ‚úÖ **Fase 4 concluida:** consultando-odoo-compras cobre pedidos de compra
-5. ‚úÖ **Fase 5 concluida:** consultando-odoo-produtos cobre catalogo de produtos
-6. **ROADMAP COMPLETO:** Todas as fases foram implementadas! Este documento permanece como referencia unica
-
----
-
-## REFERENCIAS ANTHROPIC
-
-- Skills sao **model-invoked** - Claude decide quando usar baseado na description
-- Description eh o **unico criterio** para selecao automatica
-- Multiplas skills especializadas > Uma skill generica
-- allowed-tools no frontmatter controla quais ferramentas a skill pode usar
diff --git a/.claude/settings.json b/.claude/settings.json
index 393c607d..2dddd49e 100644
--- a/.claude/settings.json
+++ b/.claude/settings.json
@@ -32,5 +32,24 @@
   "enabledPlugins": {
     "pyright-lsp@claude-plugins-official": true,
     "claude-md-management@claude-plugins-official": true
+  },
+  "hooks": {
+    "PostToolUse": [
+      {
+        "matcher": "Write|Edit",
+        "hooks": [
+          {
+            "type": "command",
+            "command": "python3 \"$CLAUDE_PROJECT_DIR/.claude/hooks/lembrar-regenerar-schemas.py\"",
+            "timeout": 5
+          },
+          {
+            "type": "command",
+            "command": "python3 \"$CLAUDE_PROJECT_DIR/.claude/hooks/sincronizar-references.py\"",
+            "timeout": 5
+          }
+        ]
+      }
+    ]
   }
 }
diff --git a/.claude/skills/cotando-frete/SKILL.md b/.claude/skills/cotando-frete/SKILL.md
index 0348eb3d..30ecd9f0 100644
--- a/.claude/skills/cotando-frete/SKILL.md
+++ b/.claude/skills/cotando-frete/SKILL.md
@@ -28,27 +28,15 @@ Skill para consultar precos de frete, calcular cotacoes detalhadas e explicar a
 
 ---
 
-## Indice
-
-1. [Quando NAO Usar Esta Skill](#quando-nao-usar-esta-skill)
-2. [DECISION TREE - Qual Script Usar?](#decision-tree---qual-script-usar)
-3. [Regras de Negocio (Anti-Alucinacao)](#regras-de-negocio-anti-alucinacao)
-4. [Scripts Disponiveis](#scripts-disponiveis)
-5. [Exemplos de Uso](#exemplos-de-uso)
-6. [Referencia Cruzada](#referencia-cruzada)
-7. [References](#references)
-
----
-
 ## Quando NAO Usar Esta Skill
 
-| Situacao | Usar em vez desta |
-|----------|-------------------|
-| Criar embarque/separacao | **gerindo-expedicao** |
-| Status de entrega pos-faturamento | **monitorando-entregas** |
-| Consultas analiticas SQL complexas | **consultando-sql** |
-| Rastrear NF/PO/pagamento no Odoo | **rastreando-odoo** |
-| Analise completa da carteira (P1-P7) | **analista-carteira** (subagente) |
+| Situacao | Skill Correta | Por que? |
+|----------|---------------|----------|
+| Criar embarque/separacao | **gerindo-expedicao** | Esta skill apenas CONSULTA precos ‚Äî nao cria documentos logisticos |
+| Status de entrega pos-faturamento | **monitorando-entregas** | Frete cotado ‚â† status de entrega. Apos NF emitida, usar entregas |
+| Consultas analiticas SQL complexas | **consultando-sql** | Rankings, agregacoes, tendencias ‚Äî nao envolvem calculo de frete |
+| Rastrear NF/PO/pagamento no Odoo | **rastreando-odoo** | Fluxo documental Odoo e diferente de cotacao de frete |
+| Analise completa da carteira (P1-P7) | **analista-carteira** | Priorizacao de embarque exige analise de toda a carteira, nao apenas frete |
 
 ---
 
@@ -61,9 +49,9 @@ Skill para consultar precos de frete, calcular cotacoes detalhadas e explicar a
 | **Tabelas/precos para cidade** | `buscar_tabelas_cidade.py` | `--cidade "Manaus" --uf AM` |
 | **Tabelas por tipo de carga** | `buscar_tabelas_cidade.py` | `--cidade "SP" --uf SP --tipo-carga FRACIONADA` |
 | **Cotacao com peso/valor** | `calcular_cotacao.py` | `--peso 5000 --valor 50000 --cidade "Manaus" --uf AM` |
-| **Cotacao detalhada (breakdown)** | `calcular_cotacao.py` | `--peso 5000 --valor 50000 --cidade "SP" --uf SP --detalhado` |
-| **Menor prazo** | `calcular_cotacao.py` | `--peso X --valor Y --cidade Z --ordenar menor_prazo` |
-| **Carga direta especifica** | `calcular_cotacao.py` | `--peso 25000 --valor 200000 --cidade "Curitiba" --uf PR --tipo-carga DIRETA` |
+| **Cotacao detalhada (breakdown)** | `calcular_cotacao.py` | `+ --detalhado` |
+| **Menor prazo** | `calcular_cotacao.py` | `+ --ordenar menor_prazo` |
+| **Carga direta especifica** | `calcular_cotacao.py` | `+ --tipo-carga DIRETA` |
 | **Frete de pedido existente** | `consultar_pedido_frete.py` | `--pedido VCD2565291` |
 | **Frete de separacao** | `consultar_pedido_frete.py` | `--separacao SEP-2025-001` |
 | **Frete de NF** | `consultar_pedido_frete.py` | `--nf 144533` |
@@ -75,411 +63,64 @@ Skill para consultar precos de frete, calcular cotacoes detalhadas e explicar a
 | **Frete por transportadora** | `consultando_frete_real.py` | `--transportadora "Braspress"` |
 | **Custo real com despesas** | `consultando_frete_real.py` | `--pedido VCD123 --com-despesas` |
 
-### Regras de Decisao (em ordem de prioridade)
-
-1. **Se pergunta sobre TABELAS/PRECOS de uma cidade (sem peso/valor):**
-   ‚Üí Use `buscar_tabelas_cidade.py`
-   ‚Üí Exemplo: "quais transportadoras atendem Manaus?" ‚Üí `--cidade "Manaus" --uf AM`
-
-2. **Se pergunta sobre COTACAO com peso e valor:**
-   ‚Üí Use `calcular_cotacao.py`
-   ‚Üí Exemplo: "quanto sai 5t R$50mil para Manaus?" ‚Üí `--peso 5000 --valor 50000 --cidade "Manaus" --uf AM`
-
-3. **Se pergunta sobre frete de PEDIDO/SEPARACAO/NF existente:**
-   ‚Üí Use `consultar_pedido_frete.py`
-   ‚Üí Exemplo: "frete do pedido VCD123" ‚Üí `--pedido VCD123`
+### Regras de Decisao
 
-4. **Se pergunta sobre FRETE REAL GASTO (historico, divergencias, pendentes Odoo):**
-   ‚Üí Use `consultando_frete_real.py`
-   ‚Üí Exemplo: "quanto gastei de frete com Atacadao?" ‚Üí `--cliente "Atacadao"`
-   ‚Üí Exemplo: "divergencias de CTe" ‚Üí `--divergencias`
-   ‚Üí Exemplo: "fretes pendentes no Odoo" ‚Üí `--pendentes-odoo`
-
-5. **Se pergunta sobre EXPLICACAO do calculo:**
-   ‚Üí Leia `references/calculo_frete.md` e explique o passo relevante
-
-6. **Se pergunta sobre TERMOS (GRIS, ADV, etc.):**
-   ‚Üí Leia `references/glossario_frete.md` e explique
+1. **TABELAS/PRECOS de cidade (sem peso/valor):** ‚Üí `buscar_tabelas_cidade.py`
+2. **COTACAO com peso e valor:** ‚Üí `calcular_cotacao.py`
+3. **Frete de PEDIDO/SEPARACAO/NF existente:** ‚Üí `consultar_pedido_frete.py`
+4. **Frete REAL GASTO (historico, divergencias, pendentes Odoo):** ‚Üí `consultando_frete_real.py`
+5. **EXPLICACAO do calculo:** ‚Üí Ler `references/calculo_frete.md`
+6. **TERMOS (GRIS, ADV, etc.):** ‚Üí Ler `references/glossario_frete.md`
 
 ### Fluxo de Ambiguidade de Cidade
 
 Se o script retornar `ambiguidade: true`:
-
-```
-1. Script retorna: {"ambiguidade": true, "opcoes_uf": ["MG", "SP"]}
-2. Agente DEVE perguntar ao usuario: "A cidade X existe em MG e SP. Qual estado?"
-3. Usar AskUserQuestion com as opcoes de UF
-4. Re-executar script com --uf informada
-```
+1. Script retorna `opcoes_uf: ["MG", "SP"]`
+2. Agente DEVE perguntar ao usuario qual estado
+3. Re-executar script com `--uf` informada
 
 ---
 
 ## Regras de Negocio (Anti-Alucinacao)
 
 ### O Agente PODE Afirmar:
-
 - Precos e valores retornados pelos scripts (baseados em tabelas REAIS)
 - Lead time em dias uteis (campo `lead_time` dos vinculos)
 - Comparacoes entre transportadoras (baseadas nos resultados)
-- Tipo de carga (DIRETA/FRACIONADA) e modalidades disponiveis
 
 ### O Agente NAO PODE Inventar:
-
 - Precos de frete sem executar o script
 - Lead times sem dados no sistema
 - Tabelas de frete que nao existem
 - Descontos ou negociacoes especiais
-- Capacidade de veiculos sem consultar
-- ICMS de cidades sem dados
 
 ### Formulas CORRETAS
 
 | Calculo | Formula |
 |---------|---------|
-| Frete base | `(peso √ó valor_kg) + (valor_mercadoria √ó percentual_valor%)` ‚Äî e SOMA, nao MAX |
-| GRIS | `max(valor √ó percentual_gris%, gris_minimo)` |
-| ADV | `max(valor √ó percentual_adv%, adv_minimo)` |
-| RCA | `valor √ó percentual_rca%` (sem minimo) |
-| Pedagio (fracao) | `ceil(peso/100) √ó pedagio_por_100kg` |
-| Pedagio (exato) | `(peso/100) √ó pedagio_por_100kg` |
+| Frete base | `(peso x valor_kg) + (valor_mercadoria x percentual_valor%)` ‚Äî e SOMA, nao MAX |
+| GRIS | `max(valor x percentual_gris%, gris_minimo)` |
+| ADV | `max(valor x percentual_adv%, adv_minimo)` |
+| RCA | `valor x percentual_rca%` (sem minimo) |
+| Pedagio (fracao) | `ceil(peso/100) x pedagio_por_100kg` |
 | ICMS (nao incluso) | `frete_liquido / (1 - icms)` |
-| Valor liquido (optante) | `= valor_com_icms` |
-| Valor liquido (nao optante) | `valor_com_icms √ó (1 - icms)` |
 
 ### Frete Minimo - CONFUSAO COMUM
-
 - `frete_minimo_peso` = PESO minimo em kg (NAO e valor em R$)
 - `frete_minimo_valor` = VALOR minimo em R$ (piso do frete)
-- Sao conceitos DIFERENTES aplicados em momentos DIFERENTES do calculo
 
 ---
 
-## Scripts Disponiveis
-
-### 1. buscar_tabelas_cidade.py
-
-Busca todas as tabelas de frete que atendem uma cidade.
-
-```bash
-source .venv/bin/activate && python .claude/skills/cotando-frete/scripts/buscar_tabelas_cidade.py [opcoes]
-```
-
-**Parametros:**
-
-| Param | Obrig | Descricao |
-|-------|-------|-----------|
-| `--cidade` | Sim | Nome da cidade (com ou sem acentos) |
-| `--uf` | Condicional | Obrigatorio se cidade existir em multiplos estados |
-| `--tipo-carga` | Nao | DIRETA ou FRACIONADA |
-| `--uf-origem` | Nao | UF de origem (default: SP) |
-
-**Retorno esperado:**
-```json
-{
-  "sucesso": true,
-  "cidade": "MANAUS",
-  "uf": "AM",
-  "codigo_ibge": "1302603",
-  "icms_cidade": 0.07,
-  "total_tabelas": 5,
-  "tabelas": [
-    {
-      "transportadora": "BRASPRESS",
-      "transportadora_id": 42,
-      "optante": false,
-      "nome_tabela": "TABELA AM 2025",
-      "tipo_carga": "FRACIONADA",
-      "modalidade": "FRETE PESO",
-      "lead_time": 12,
-      "valor_kg": 0.85,
-      "percentual_valor": 0.30,
-      "frete_minimo_peso": 100,
-      "frete_minimo_valor": 350.00,
-      "percentual_gris": 0.30,
-      "gris_minimo": 25.00,
-      "percentual_adv": 0.10,
-      "adv_minimo": 0,
-      "percentual_rca": 0,
-      "pedagio_por_100kg": 5.50,
-      "valor_tas": 0,
-      "valor_despacho": 50.00,
-      "valor_cte": 0,
-      "icms_incluso": false
-    }
-  ]
-}
-```
-
-### 2. calcular_cotacao.py
-
-Calcula cotacao de frete detalhada para peso/valor/destino.
-
-```bash
-source .venv/bin/activate && python .claude/skills/cotando-frete/scripts/calcular_cotacao.py [opcoes]
-```
-
-**Parametros:**
-
-| Param | Obrig | Descricao |
-|-------|-------|-----------|
-| `--peso` | Sim | Peso em kg |
-| `--valor` | Sim | Valor da mercadoria em R$ |
-| `--cidade` | Sim | Nome da cidade destino |
-| `--uf` | Condicional | Se cidade ambigua |
-| `--tipo-carga` | Nao | DIRETA ou FRACIONADA |
-| `--uf-origem` | Nao | UF de origem (default: SP) |
-| `--detalhado` | Nao | Flag para breakdown completo |
-| `--ordenar` | Nao | menor_valor (default) ou menor_prazo |
-| `--limite` | Nao | Max opcoes (default: 10) |
-
-**Retorno esperado:**
-```json
-{
-  "sucesso": true,
-  "parametros": {"peso": 5000, "valor": 50000, "cidade": "MANAUS", "uf": "AM"},
-  "total_opcoes": 3,
-  "melhor_opcao": {
-    "transportadora": "BRASPRESS",
-    "valor_com_icms": 3495.16,
-    "criterio": "menor_valor"
-  },
-  "opcoes": [
-    {
-      "posicao": 1,
-      "transportadora": "BRASPRESS",
-      "nome_tabela": "TABELA AM 2025",
-      "tipo_carga": "FRACIONADA",
-      "modalidade": "FRETE PESO",
-      "lead_time": 12,
-      "valor_bruto": 3250.50,
-      "valor_com_icms": 3495.16,
-      "valor_liquido": 3250.50,
-      "frete_por_kg": 0.699,
-      "percentual_sobre_valor": 6.99
-    }
-  ]
-}
-```
-
-### 3. consultar_pedido_frete.py
-
-Consulta dados de frete de pedidos existentes.
-
-```bash
-source .venv/bin/activate && python .claude/skills/cotando-frete/scripts/consultar_pedido_frete.py [opcoes]
-```
-
-**Parametros:**
-
-| Param | Obrig | Descricao |
-|-------|-------|-----------|
-| `--pedido` | * | Numero do pedido (VCD/VFB). Busca em separacao E carteira. Se multiplos contextos, retorna `resumo.requer_clarificacao=true` |
-| `--separacao` | * | Lote de separacao |
-| `--nf` | * | Numero da NF |
-| `--recalcular` | Nao | Recalcular com tabelas atuais |
-
-\* Pelo menos um obrigatorio
-
-**Fontes de dados por parametro:**
-- `--pedido` ‚Üí busca UNIFICADA: `separacao` (sincronizado_nf=false, qtd_saldo>0) + `carteira_principal` (qtd_saldo_produto_pedido>0). Retorna todos os contextos do pedido
-- `--separacao` ‚Üí busca em `separacao` (sincronizado_nf=false, qtd_saldo>0)
-- `--nf` ‚Üí busca em `faturamento_produto`
-
-**Quando --pedido retorna multiplos contextos:**
-
-O mesmo pedido pode ter simultaneamente:
-- 1 ou mais separacoes (`separacao_lote_id`) com `sincronizado_nf=False`
-- Saldo remanescente na `carteira_principal` (parte nao separada)
-
-Se `resumo.requer_clarificacao = true`:
-1. Apresentar os contextos ao usuario (separacao X, separacao Y, saldo carteira)
-2. Usar AskUserQuestion para o usuario escolher qual contexto
-3. NAO calcular frete de todos sem perguntar ‚Äî cada contexto tem peso/valor diferente
-
-Se `resumo.requer_clarificacao = false` (1 unico contexto):
-- Usar direto, sem perguntar
-
-**Retorno esperado (--pedido):**
-```json
-{
-  "sucesso": true,
-  "fonte": "pedido_unificado",
-  "total": 3,
-  "resumo": {
-    "tem_separacao": true,
-    "tem_carteira": true,
-    "qtd_separacoes": 2,
-    "separacoes": ["SEP-2025-001", "SEP-2025-002"],
-    "qtd_carteira": 1,
-    "requer_clarificacao": true
-  },
-  "pedidos": [
-    {
-      "tipo": "separacao",
-      "separacao_lote_id": "SEP-2025-001",
-      "num_pedido": "VCD2565291",
-      "cnpj": "12345678000190",
-      "cliente": "ATACADAO SA",
-      "cidade": "MANAUS",
-      "uf": "AM",
-      "codigo_ibge": "1302603",
-      "valor_total": 45000.00,
-      "peso_total": 3500,
-      "peso_fonte": "separacao"
-    },
-    {
-      "tipo": "carteira",
-      "num_pedido": "VCD2565291",
-      "cnpj": "12345678000190",
-      "cliente": "ATACADAO SA",
-      "cidade": "MANAUS",
-      "uf": "AM",
-      "valor_total": 12000.00,
-      "peso_total": 800,
-      "peso_fonte": "palletizacao_estimado",
-      "incoterm": "CIF"
-    }
-  ]
-}
-```
-
-### 4. consultando_frete_real.py
-
-Consulta frete REAL (historico de gastos, divergencias, pendentes Odoo).
-
-```bash
-source .venv/bin/activate && python .claude/skills/cotando-frete/scripts/consultando_frete_real.py [opcoes]
-```
-
-**Parametros:**
-
-| Param | Obrig | Descricao |
-|-------|-------|-----------|
-| `--pedido` | * | Frete real do pedido (via chain embarque) |
-| `--cliente` | * | Total frete real por cliente/grupo (entity resolution) |
-| `--transportadora` | * | Frete agregado por transportadora |
-| `--divergencias` | * | Listar divergencias CTe vs cotacao > R$5 |
-| `--pendentes-odoo` | * | Fretes aprovados nao lancados no Odoo |
-| `--de` | Nao | Data inicio (YYYY-MM-DD) |
-| `--ate` | Nao | Data fim (YYYY-MM-DD) |
-| `--com-despesas` | Nao | Incluir breakdown de DespesaExtra |
-| `--limite` | Nao | Max resultados (default: 50) |
-
-\* Pelo menos um modo obrigatorio
-
-**Modos de operacao:**
-
-- `--pedido VCD123`: Traversa chain Separacao ‚Üí EmbarqueItem ‚Üí Embarque ‚Üí Frete. Retorna custo real com breakdown.
-- `--cliente "Atacadao"`: Entity resolution por LIKE no nome + agrupamento por prefixo CNPJ (8 digitos = grupo).
-- `--transportadora "Braspress"`: Agrega fretes por transportadora com breakdown UF/tipo_carga.
-- `--divergencias`: Filtra `ABS(valor_cte - valor_cotado) > 5.00`. Retorna lista com percentual divergencia.
-- `--pendentes-odoo`: Filtra `status='APROVADO' AND lancado_odoo_em IS NULL`.
-
-**Retorno esperado (--pedido):**
-```json
-{
-  "sucesso": true,
-  "modo": "pedido",
-  "pedido": "VCD123",
-  "total_fretes": 2,
-  "valor_total_cotado": 1500.00,
-  "valor_total_pago": 1650.00,
-  "valor_total_cte": 1620.00,
-  "fretes": [
-    {
-      "frete_id": 42,
-      "embarque_numero": 1001,
-      "transportadora": "BRASPRESS",
-      "valor_cotado": 750.00,
-      "valor_cte": 810.00,
-      "valor_pago": 825.00,
-      "numeros_nfs": "144533,144534",
-      "despesas": []
-    }
-  ]
-}
-```
+## Scripts ‚Äî Referencia Detalhada
 
----
+**Para parametros completos, retornos JSON e exemplos**: LER `SCRIPTS.md`
 
-## Exemplos de Uso
-
-### Cenario 1: Tabelas para uma cidade
-
-```
-Pergunta: "quais transportadoras atendem Manaus?"
-Raciocinio: Pergunta sobre TABELAS/PRECOS ‚Üí buscar_tabelas_cidade.py
-Comando: --cidade "Manaus" --uf AM
-Resultado: "Encontrei 5 tabelas de frete para Manaus/AM: [lista com transportadora, tipo, lead_time]"
-```
-
-### Cenario 2: Cotacao com peso e valor
-
-```
-Pergunta: "quanto sai frete de 5 toneladas, R$ 50 mil para Manaus?"
-Raciocinio: Peso + valor + cidade ‚Üí calcular_cotacao.py
-Comando: --peso 5000 --valor 50000 --cidade "Manaus" --uf AM
-Resultado: "A melhor opcao e BRASPRESS por R$ 3.495,16 (com ICMS). Lead time: 12 dias uteis."
-```
-
-### Cenario 3: Comparacao entre transportadoras
-
-```
-Pergunta: "qual transportadora mais barata para Curitiba com 3 toneladas?"
-Raciocinio: Comparacao ‚Üí calcular_cotacao.py (lista todas ordenadas)
-Comando: --peso 3000 --valor 30000 --cidade "Curitiba" --uf PR
-Resultado: Tabela comparativa com top opcoes ordenadas por valor
-```
-
-### Cenario 4: Frete de pedido existente (unico contexto)
-
-```
-Pergunta: "qual o frete do pedido VCD2565291?"
-Raciocinio: Pedido existente ‚Üí consultar_pedido_frete.py
-Comando: --pedido VCD2565291
-Se resumo.requer_clarificacao=false (1 contexto):
-  Resultado: "O pedido VCD2565291 (ATACADAO SA, Sao Paulo/SP) tem peso 12.500kg, valor R$ 85.000."
-Se resumo.requer_clarificacao=true (multiplos contextos):
-  Resultado: AskUserQuestion com opcoes:
-    - "Separacao SEP-001 (3.500kg, R$ 45.000)"
-    - "Separacao SEP-002 (1.200kg, R$ 18.000)"
-    - "Saldo em carteira (800kg, R$ 12.000)"
-```
-
-### Cenario 5: Recalcular frete de pedido
-
-```
-Pergunta: "recalcula o frete do VCD2565291 com as tabelas atuais"
-Raciocinio: Pedido + recalcular ‚Üí consultar_pedido_frete.py --recalcular
-Comando: --pedido VCD2565291 --recalcular
-Resultado: "Recalculei com tabelas atuais. Melhor opcao: [transportadora] por R$ [valor]."
-```
-
-### Cenario 6: Frete real gasto com cliente
-
-```
-Pergunta: "quanto gastei de frete com o Atacadao nos ultimos 3 meses?"
-Raciocinio: Frete REAL gasto ‚Üí consultando_frete_real.py
-Comando: --cliente "Atacadao" --de 2025-11-01 --ate 2026-02-01
-Resultado: "O grupo Atacadao teve R$ 45.230,00 em fretes (23 embarques). Breakdown por UF: SP 45%, RJ 30%, MG 25%."
-```
-
-### Cenario 7: Divergencias de CTe
-
-```
-Pergunta: "tem alguma divergencia de CTe este mes?"
-Raciocinio: Divergencias ‚Üí consultando_frete_real.py
-Comando: --divergencias --de 2026-02-01
-Resultado: "Encontrei 5 divergencias. Maior: Frete #42 (Braspress) - CTe R$ 810 vs cotacao R$ 750 (+8%)."
-```
-
-### Cenario 8: Explicar calculo de frete
-
-```
-Pergunta: "como funciona o calculo de frete?"
-Raciocinio: Pergunta explicativa ‚Üí ler references/calculo_frete.md
-Acao: Ler o reference e explicar os 10 passos ao usuario
-```
+| # | Script | Proposito |
+|---|--------|-----------|
+| 1 | `buscar_tabelas_cidade.py` | Tabelas de frete por cidade |
+| 2 | `calcular_cotacao.py` | Cotacao detalhada peso/valor/destino |
+| 3 | `consultar_pedido_frete.py` | Frete de pedido/separacao/NF |
+| 4 | `consultando_frete_real.py` | Frete real: historico, divergencias, pendentes |
 
 ---
 
@@ -489,37 +130,37 @@ Acao: Ler o reference e explicar os 10 passos ao usuario
 |-------|--------------------------|
 | **gerindo-expedicao** | Criar embarque/separacao (antes de faturar) |
 | **monitorando-entregas** | Status de entrega (apos faturar) |
-| **consultando-sql** | Consultas analiticas complexas (rankings, agregacoes) |
+| **consultando-sql** | Consultas analiticas complexas |
 | **rastreando-odoo** | Rastrear NF/PO/pagamento no Odoo |
-| **resolvendo-entidades** | Resolver cliente/cidade para IDs (usar antes se necessario) |
+| **resolvendo-entidades** | Resolver cliente/cidade para IDs |
 
 ---
 
 ## References (sob demanda)
 
-| Gatilho na Pergunta | Reference a Ler | Motivo |
-|---------------------|-----------------|--------|
-| "como funciona o calculo?", "explique o calculo", "por que esse valor?" | `references/calculo_frete.md` | Logica completa passo-a-passo (10 passos) |
-| "o que e GRIS?", "significado de ADV", "termos de frete" | `references/glossario_frete.md` | Terminologia e definicoes |
-| "o que e frete minimo peso?", "diferenca entre peso e valor minimo" | `references/calculo_frete.md` Passo 2 e Passo 6 | Confusao comum |
-| "como funciona ICMS no frete?", "optante vs nao optante" | `references/calculo_frete.md` Passo 8 e Passo 9 | Logica ICMS |
-| "direta vs fracionada", "o que e carga direta?" | `references/glossario_frete.md` + `references/calculo_frete.md` | Tipos de carga |
+| Gatilho na Pergunta | Reference a Ler |
+|---------------------|-----------------|
+| "como funciona o calculo?" | `references/calculo_frete.md` |
+| "o que e GRIS?", termos de frete | `references/glossario_frete.md` |
+| "frete minimo peso vs valor" | `references/calculo_frete.md` Passo 2 e 6 |
+| "ICMS no frete" | `references/calculo_frete.md` Passo 8 e 9 |
+| "direta vs fracionada" | `references/glossario_frete.md` + `references/calculo_frete.md` |
 
 ---
 
 ## Tabelas do Dominio
 
-| Tabela | Descricao | Usada por |
-|--------|-----------|-----------|
-| `cidades` | Cadastro de cidades com ICMS e codigo_ibge | Resolucao de cidade |
-| `cidades_atendidas` | Vinculos transportadora ‚Üî cidade (lead_time) | buscar_tabelas_cidade.py |
-| `tabelas_frete` | Tabelas de preco por transportadora/UF/tipo | buscar_tabelas_cidade.py, calcular_cotacao.py |
-| `transportadoras` | Cadastro com flags aplica_*_pos_minimo | Calculo de frete |
-| `veiculos` | Capacidade por tipo (VAN, TOCO, etc.) | Carga DIRETA |
-| `carteira_principal` | Pedidos em carteira com saldo | consultar_pedido_frete.py |
-| `separacao` | Separacoes com peso real | consultar_pedido_frete.py |
-| `faturamento_produto` | NFs faturadas | consultar_pedido_frete.py |
-| `fretes` | Frete real (cotado, CTe, pago) | consultando_frete_real.py |
-| `embarques` | Embarques com transportadora | consultando_frete_real.py |
-| `embarque_itens` | Itens do embarque (link separacao) | consultando_frete_real.py |
-| `despesas_extras` | Despesas extras de frete | consultando_frete_real.py |
+| Tabela | Usada por |
+|--------|-----------|
+| `cidades` | Resolucao de cidade |
+| `cidades_atendidas` | buscar_tabelas_cidade.py |
+| `tabelas_frete` | buscar_tabelas_cidade.py, calcular_cotacao.py |
+| `transportadoras` | Calculo de frete |
+| `veiculos` | Carga DIRETA |
+| `carteira_principal` | consultar_pedido_frete.py |
+| `separacao` | consultar_pedido_frete.py |
+| `faturamento_produto` | consultar_pedido_frete.py |
+| `fretes` | consultando_frete_real.py |
+| `embarques` | consultando_frete_real.py |
+| `embarque_itens` | consultando_frete_real.py |
+| `despesas_extras` | consultando_frete_real.py |
diff --git a/.claude/skills/frontend-design/SKILL.md b/.claude/skills/frontend-design/SKILL.md
index e25da630..034c12c5 100644
--- a/.claude/skills/frontend-design/SKILL.md
+++ b/.claude/skills/frontend-design/SKILL.md
@@ -1,6 +1,6 @@
 ---
 name: frontend-design
-description: Create distinctive, production-grade frontend interfaces with high design quality using Flask/Jinja2 template structure. Use this skill when the user asks to build web components, pages, artifacts, posters, or applications. Generates creative, polished code and UI design that avoids generic AI aesthetics with mandatory light/dark mode support. (project)
+description: Cria interfaces frontend de alta qualidade com Flask/Jinja2. Gera componentes web, paginas, dashboards e aplicacoes com design profissional, suporte obrigatorio light/dark mode e estetica nao-generica. Usar quando precisar construir telas, artefatos visuais ou posters.
 ---
 
 Create distinctive frontend interfaces that avoid generic "AI slop" aesthetics. Implement real working code with exceptional attention to aesthetic details.
diff --git a/.claude/skills/gerindo-expedicao/SKILL.md b/.claude/skills/gerindo-expedicao/SKILL.md
index b5339f71..89b3941c 100644
--- a/.claude/skills/gerindo-expedicao/SKILL.md
+++ b/.claude/skills/gerindo-expedicao/SKILL.md
@@ -23,27 +23,6 @@ Skill para consultas e operacoes logisticas da Nacom Goya.
 
 ---
 
-## Indice
-
-1. [Quando Usar Esta Skill](#quando-usar-esta-skill)
-2. [DECISION TREE - Qual Script Usar?](#decision-tree---qual-script-usar)
-   - [Mapeamento Rapido](#mapeamento-rapido)
-   - [Regras de Decisao](#regras-de-decisao-em-ordem-de-prioridade)
-   - [Como Decidir (Raciocinio)](#como-decidir-raciocinio-obrigatorio)
-   - [Termos Ambiguos](#termos-ambiguos---pergunte-antes-de-agir)
-   - [Exemplos](#exemplos-de-boas-e-mas-escolhas)
-3. [Scripts Disponiveis](#scripts-disponiveis)
-   - [analisando_disponibilidade_estoque.py](#1-analisando_disponibilidade_estoquepy)
-   - [consultando_situacao_pedidos.py](#2-consultando_situacao_pedidospy)
-   - [consultando_produtos_estoque.py](#3-consultando_produtos_estoquepy)
-   - [calculando_leadtime_entrega.py](#4-calculando_leadtime_entregapy)
-   - [criando_separacao_pedidos.py](#5-criando_separacao_pedidospy)
-   - [consultando_programacao_producao.py](#6-consultando_programacao_producaopy)
-4. [Fluxo de Criacao de Separacao](#fluxo-de-criacao-de-separacao)
-5. [Referencias](#referencias) (tables, business, glossary, synonyms, products, examples)
-
----
-
 ## Quando Usar Esta Skill
 
 USE para:
@@ -52,7 +31,6 @@ USE para:
 - Analise de disponibilidade: "quando VCD123 fica disponivel?", "o que vai dar falta?"
 - Calculo de prazo: "se embarcar amanha, quando chega?"
 - Criacao de separacao: "crie separacao do VCD123 pra amanha"
-- Resolucao de entidades: identificar pedido, produto, cliente por termos parciais
 
 NAO USE para:
 - Analise COMPLETA da carteira com decisoes (use o Agent `analista-carteira`)
@@ -63,59 +41,30 @@ NAO USE para:
 
 ## REGRAS CRITICAS (NUNCA VIOLAR)
 
-<regras_criticas>
-
 ### 1. GUARDRAIL ANTI-ALUCINACAO
-
 **PROIBIDO** criar, calcular ou inferir dados que NAO foram retornados pelo script.
-
-| PERMITIDO | PROIBIDO |
-|-----------|----------|
-| Mostrar dados retornados pelo script | Inventar "cobertura de X dias" sem calculo |
-| Formatar/agrupar dados existentes | Criar campos que nao existem no JSON |
-| Resumir informacoes do JSON | Estimar valores sem base no script |
-
-**Se precisar de dado que nao veio no script:** EXECUTE o script com flag adequado ou PERGUNTE ao usuario.
+Se precisar de dado que nao veio no script: EXECUTE o script com flag adequado ou PERGUNTE ao usuario.
 
 ### 2. REGRA DE FALLBACK (NUNCA TRAVAR)
-
-**Se um script falhar ou retornar erro:** SEMPRE responda ao usuario.
-
-| Situacao | Acao |
-|----------|------|
-| Script retornou erro | Explicar o erro e sugerir alternativa |
-| Parametro nao suportado | Usar parametros disponiveis ou perguntar |
-| Entidade nao encontrada | Informar "nao encontrei X, voce quis dizer Y?" |
-| Timeout/falha tecnica | "Houve um problema ao consultar. Posso tentar de outra forma?" |
-
+Se um script falhar: SEMPRE responda ao usuario com erro e alternativa.
 **NUNCA:** Ficar em silencio, travar, ou tentar criar scripts customizados.
 
 ### 3. SIMULAR ANTES DE EXECUTAR (ACOES)
-
-**Para QUALQUER acao que modifica dados (criar separacao):**
+Para QUALQUER acao que modifica dados (criar separacao):
 1. Executar SEM --executar (simular)
 2. Mostrar resultado ao usuario
 3. AGUARDAR confirmacao explicita
 4. So entao executar COM --executar
 
-</regras_criticas>
-
 ---
 
 ## DECISION TREE - Qual Script Usar?
 
-<decision_tree>
-SEMPRE consulte esta secao ANTES de executar qualquer script.
-A escolha correta evita resultados errados e retrabalho.
-</decision_tree>
-
 ### Mapeamento Rapido
 
-<mapeamento>
-
 | Se a pergunta menciona... | Use este script | Com estes parametros |
 |---------------------------|-----------------|----------------------|
-| **PRODUTO + CLIENTE/GRUPO** ("quanto de X pro Y?") | `consultando_situacao_pedidos.py` | `--grupo Y --produto X` ou `--cliente Y --produto X` |
+| **PRODUTO + CLIENTE/GRUPO** ("quanto de X pro Y?") | `consultando_situacao_pedidos.py` | `--grupo Y --produto X` |
 | **Pedidos de um grupo** ("tem pedido do atacadao?") | `consultando_situacao_pedidos.py` | `--grupo atacadao` |
 | **Pedidos de um cliente** ("tem pedido do Carrefour?") | `consultando_situacao_pedidos.py` | `--cliente Carrefour` |
 | **Pedidos atrasados** | `consultando_situacao_pedidos.py` | `--atrasados` |
@@ -123,416 +72,67 @@ A escolha correta evita resultados errados e retrabalho.
 | **Entradas recentes** ("chegou X?") | `consultando_produtos_estoque.py` | `--produto X --entradas` |
 | **Ruptura/falta** ("vai faltar X?") | `consultando_produtos_estoque.py` | `--ruptura --dias 7` |
 | **Scan ruptura proativo** ("o que vai faltar?") | `consultando_produtos_estoque.py` | `--scan-ruptura-global --dias 7` |
-| **Co-passageiros embarque** ("quem vai no embarque 1234?") | `consultando_situacao_pedidos.py` | `--co-passageiros-embarque 1234` |
+| **Co-passageiros embarque** | `consultando_situacao_pedidos.py` | `--co-passageiros-embarque 1234` |
 | **Quando pedido fica disponivel** | `analisando_disponibilidade_estoque.py` | `--pedido VCD123` |
 | **Disponibilidade de grupo** | `analisando_disponibilidade_estoque.py` | `--grupo atacadao --completude` |
 | **Prazo de entrega** ("quando chega?") | `calculando_leadtime_entrega.py` | `--pedido X --data-embarque Y` |
-| **Criar separacao** | `criando_separacao_pedidos.py` | `--pedido X --expedicao Y` (SEM --executar primeiro!) |
+| **Criar separacao** | `criando_separacao_pedidos.py` | `--pedido X --expedicao Y` (SEM --executar!) |
 | **Programacao de producao** | `consultando_programacao_producao.py` | `--listar --dias 7` |
-
-</mapeamento>
+| **Analise completa da carteira** | `analisando_carteira_completa.py` | `--resumo` ou sem parametros |
+| **Priorizar por P1-P7** | `analisando_carteira_completa.py` | `--prioridade N` |
 
 ### Regras de Decisao (em ordem de prioridade)
 
-<regras_decisao>
-
-1. **Se pergunta tem PRODUTO + CLIENTE/GRUPO juntos:**
-   ‚Üí Use `consultando_situacao_pedidos.py --grupo X --produto Y` ou `--cliente X --produto Y`
-   ‚Üí Exemplo: "quantas caixas de ketchup tem pro atacadao?" ‚Üí `--grupo atacadao --produto ketchup`
-
-2. **Se pergunta e sobre PEDIDOS de um cliente/grupo (sem produto):**
-   ‚Üí Use `consultando_situacao_pedidos.py --grupo X` ou `--cliente X`
-   ‚Üí Exemplo: "tem pedido do assai?" ‚Üí `--grupo assai`
-
-3. **Se pergunta e sobre ESTOQUE de produto (sem cliente):**
-   ‚Üí Use `consultando_produtos_estoque.py --produto X --completo`
-   ‚Üí Exemplo: "quanto tem de palmito?" ‚Üí `--produto palmito --completo`
-
-4. **Se pergunta e sobre DISPONIBILIDADE de pedido:**
-   ‚Üí Use `analisando_disponibilidade_estoque.py --pedido X`
-   ‚Üí Exemplo: "quando VCD123 fica disponivel?" ‚Üí `--pedido VCD123`
-
-5. **Se pergunta e sobre PRAZO de entrega:**
-   ‚Üí Use `calculando_leadtime_entrega.py`
-   ‚Üí Exemplo: "se embarcar amanha, quando chega?" ‚Üí `--pedido X --data-embarque amanha`
-
-6. **Se for ACAO de criar separacao:**
-   ‚Üí Use `criando_separacao_pedidos.py` (SEMPRE simular antes de executar!)
-   ‚Üí Exemplo: "crie separacao do VCD123" ‚Üí `--pedido VCD123 --expedicao [data]` (SEM --executar)
-
-</regras_decisao>
+1. **PRODUTO + CLIENTE/GRUPO juntos:** ‚Üí `consultando_situacao_pedidos.py --grupo X --produto Y`
+2. **PEDIDOS de cliente/grupo (sem produto):** ‚Üí `consultando_situacao_pedidos.py --grupo X`
+3. **ESTOQUE de produto (sem cliente):** ‚Üí `consultando_produtos_estoque.py --produto X --completo`
+4. **DISPONIBILIDADE de pedido:** ‚Üí `analisando_disponibilidade_estoque.py --pedido X`
+5. **PRAZO de entrega:** ‚Üí `calculando_leadtime_entrega.py`
+6. **ACAO de criar separacao:** ‚Üí `criando_separacao_pedidos.py` (SEMPRE simular antes!)
 
 ### Como Decidir (Raciocinio Obrigatorio)
 
-<instrucao_raciocinio>
-ANTES de escolher qualquer script, faca este raciocinio mentalmente:
-
-**PASSO 1 - IDENTIFICAR**: O que o usuario quer saber?
-- E sobre PEDIDOS? (quem comprou, quanto, quando entregar)
-- E sobre ESTOQUE? (tem, vai faltar, chegou, quanto sobra)
-- E sobre DISPONIBILIDADE? (quando pedido fica pronto)
-- E sobre PRAZO? (quando chega se embarcar dia X)
-- E uma ACAO? (criar separacao)
-
-**PASSO 2 - VERIFICAR**: Tem cliente/grupo mencionado?
-- SIM + produto ‚Üí `consultando_situacao_pedidos --grupo/--cliente + --produto`
-- SIM sem produto ‚Üí `consultando_situacao_pedidos --grupo/--cliente`
-- NAO ‚Üí provavelmente `consultando_produtos_estoque`
-
-**PASSO 3 - CONFIRMAR**: A escolha faz sentido?
-- Se escolhi ESTOQUE mas usuario perguntou "pro atacadao" ‚Üí **ERRADO** (use PEDIDOS)
-- Se escolhi PEDIDOS mas usuario perguntou "quanto tem em estoque" ‚Üí **ERRADO** (use ESTOQUE)
-- Se escolhi DISPONIBILIDADE mas usuario perguntou "quando chega" ‚Üí **ERRADO** (use LEADTIME)
-
-**PASSO 4 - PERGUNTAR**: Se ainda em duvida apos os 3 passos ‚Üí pergunte ao usuario!
-</instrucao_raciocinio>
+**PASSO 1**: O que o usuario quer? (PEDIDOS / ESTOQUE / DISPONIBILIDADE / PRAZO / ACAO)
+**PASSO 2**: Tem cliente/grupo? (SIM + produto ‚Üí situacao_pedidos | SIM sem produto ‚Üí situacao_pedidos | NAO ‚Üí produtos_estoque)
+**PASSO 3**: A escolha faz sentido? (ESTOQUE mas "pro atacadao" ‚Üí ERRADO, use PEDIDOS)
+**PASSO 4**: Em duvida ‚Üí pergunte ao usuario!
 
 ---
 
-### Leitura de References (Sob Demanda)
-
-<filosofia_50_50>
-**FILOSOFIA: 50% Regra / 50% IA**
-
-Esta skill implementa um equilibrio entre scripts e IA:
-
-**SCRIPTS fazem:**
-- Resolver entidades (cliente, grupo, produto)
-- Buscar dados no banco
-- Retornar TODOS os candidatos (sem truncar)
-
-**IA decide:**
-- Como agrupar/apresentar resultados
-- Se precisa perguntar algo ao usuario
-- Quando usar references para contexto
-</filosofia_50_50>
-
-<leitura_references>
-ANTES de executar scripts, o agente DEVE ler os references relevantes baseado na pergunta:
-
-| Gatilho na Pergunta | Reference a Ler | Motivo |
-|---------------------|-----------------|--------|
-| Produto mencionado | `references/products.md` | Entender abreviacoes (CI, AZ VF, BD) |
-| Cliente/Grupo | `references/business.md` | Prefixos CNPJ, constantes |
-| Termo desconhecido | `references/glossary.md` | "matar", "ruptura", "FOB" |
-| Variacao de escrita | `references/synonyms.md` | ketchup‚Üícatchup |
-| Comunicar PCP/Comercial | `references/communication.md` | Templates de mensagem |
-| Duvida de script | `references/examples.md` | Validar escolha |
-</leitura_references>
-
-<exemplo_fluxo_50_50>
-**Exemplo de Fluxo Completo**
-
-Pergunta: "quanto tem de palmito pro atacadao 183"
-
-1. IA le `references/glossary.md` ‚Üí "pendente" = qtd_saldo > 0
-2. IA le `references/business.md` ‚Üí atacadao = grupo com prefixos CNPJ
-3. IA executa: `python consultando_situacao_pedidos.py --grupo atacadao --produto palmito`
-4. Script encontra 18 candidatos de palmito
-5. Script busca TODOS na carteira do cliente (nao para por multiplos)
-6. Script retorna 2 SKUs com saldo: Tolete 15x300g (2.592 un), Rodela 15x300g (1.053 un)
-7. IA apresenta tabela consolidada ao usuario
-
-**IMPORTANTE:** Quando script retorna `ia_decide: true`, a IA DEVE processar os dados e decidir a melhor forma de apresentar.
-</exemplo_fluxo_50_50>
-
----
-
-### Termos Ambiguos - PERGUNTE antes de agir!
-
-<termos_ambiguos>
-
-**Se o usuario usar estes termos, PARE e PERGUNTE antes de executar.**
+## Termos Ambiguos - PERGUNTE antes de agir!
 
 #### "programacao de entrega" (CRITICO - 4 interpretacoes)
-
-| Opcao | Significado | Campo | Tabela |
-|-------|-------------|-------|--------|
-| A | Data que cliente solicitou | `data_entrega_pedido` | CarteiraPrincipal |
-| B | Data que vamos expedir | `expedicao` | Separacao |
-| C | Data que vai chegar no cliente | `agendamento` | Separacao |
-| D | Protocolo de agendamento | `protocolo` | Separacao |
-
-**PERGUNTAR:** "Voce quer saber: A) data que o cliente solicitou, B) data de expedicao programada, C) data de chegada no cliente, ou D) protocolo de agendamento?"
+A) Data que cliente solicitou (`data_entrega_pedido`) | B) Data de expedicao (`expedicao`) | C) Data de chegada (`agendamento`) | D) Protocolo de agendamento (`protocolo`)
 
 #### "quantidade pendente"
-
-| Opcao | Significado | Fonte |
-|-------|-------------|-------|
-| Carteira | Ainda nao separado | CarteiraPrincipal |
-| Separacao | Separado mas nao faturado | Separacao (sincronizado_nf=False) |
-| Total | Ambos | Carteira + Separacao |
-
-**ACAO PADRAO:** Mostrar AMBOS e explicar: "Na carteira: X un | Em separacao: Y un | Total pendente: Z un"
-
-#### "itens" vs "unidades"
-
-**NUNCA usar "itens" sozinho.** SEMPRE especificar:
-- "X linhas de produto" (SKUs diferentes)
-- "X unidades" ou "X caixas" (quantidade)
+Acao padrao: Mostrar AMBOS: "Na carteira: X un | Em separacao: Y un | Total: Z un"
 
 #### Multiplas lojas do mesmo grupo
-
-Se resultado tiver mais de 1 loja do mesmo grupo (ex: Atacadao):
-**PERGUNTAR:** "Encontrei pedidos em X lojas do [grupo]. Qual loja especificamente, ou quer ver todas?"
-
-#### Outros termos ambiguos
-
-| Termo | Possibilidades | O que PERGUNTAR |
-|-------|---------------|-----------------|
-| "quando fica disponivel?" | Pedido ou produto? | "Voce quer saber quando um PEDIDO fica disponivel ou quando um PRODUTO estara em estoque?" |
-| "situacao" | De que? | "Situacao de qual pedido ou produto?" |
-| "crie separacao" | Data faltando | "Para qual data de expedicao?" |
-
-</termos_ambiguos>
-
-### Exemplos de Boas e Mas Escolhas
-
-> **VER references/examples.md** para exemplos detalhados de uso correto e anti-patterns.
-
-**Resumo rapido:**
-- PRODUTO + CLIENTE ‚Üí `consultando_situacao_pedidos --grupo/--cliente + --produto`
-- So ESTOQUE (sem cliente) ‚Üí `consultando_produtos_estoque --produto X --completo`
-- QUANDO DISPONIVEL ‚Üí `analisando_disponibilidade_estoque --pedido X`
-- QUANDO CHEGA (prazo) ‚Üí `calculando_leadtime_entrega --pedido X --data-embarque Y`
-- CRIAR SEPARACAO ‚Üí `criando_separacao_pedidos` (SEM --executar primeiro!)
-
----
-
-## Scripts Disponiveis
-
-### Ambiente Virtual
-
-Sempre ativar antes de executar:
-```bash
-source .venv/bin/activate
-```
+Se resultado tiver mais de 1 loja: PERGUNTAR qual loja.
 
 ---
 
-### 1. analisando_disponibilidade_estoque.py
-
-**Proposito:** Analisa disponibilidade de estoque para pedidos ou grupos de clientes.
-
-**Queries cobertas:** Q1, Q2, Q3, Q4, Q5, Q6, Q9, Q11, Q12
-
-```bash
-source .venv/bin/activate && \
-python .claude/skills/gerindo-expedicao/scripts/analisando_disponibilidade_estoque.py [parametros]
-```
-
-| Parametro | Descricao | Exemplo |
-|-----------|-----------|---------|
-| `--pedido` | Numero do pedido ou "grupo termo" | `--pedido VCD123` ou `--pedido "atacadao 183"` |
-| `--grupo` | Grupo empresarial | `--grupo atacadao`, `--grupo assai`, `--grupo tenda` |
-| `--loja` | Identificador da loja (em raz_social_red) | `--loja 183` |
-| `--uf` | Filtrar por UF | `--uf SP` |
-| `--data` | Data para analise (hoje, amanha, dd/mm, YYYY-MM-DD) | `--data amanha` |
-| `--sem-agendamento` | Apenas pedidos sem exigencia de agendamento | flag |
-| `--sugerir-adiamento` | Sugerir pedidos para adiar (liberar estoque) | flag |
-| `--diagnosticar-origem` | Distinguir falta absoluta vs relativa | flag |
-| `--completude` | Calcular % faturado vs pendente | flag |
-| `--atrasados` | Analisar pedidos com expedicao vencida | flag |
-| `--diagnosticar-causa` | Detalhar causa do atraso | flag |
-| `--ranking-impacto` | Ranking de pedidos que mais travam carteira | flag |
-| `--limit` | Limite de resultados (default: 100) | `--limit 20` |
-
----
-
-### 2. consultando_situacao_pedidos.py
-
-**Proposito:** Consulta pedidos por diversos filtros e perspectivas.
-
-**Queries cobertas:** Q8, Q10, Q14, Q16, Q19
-
-```bash
-source .venv/bin/activate && \
-python .claude/skills/gerindo-expedicao/scripts/consultando_situacao_pedidos.py [parametros]
-```
-
-| Parametro | Descricao | Exemplo |
-|-----------|-----------|---------|
-| `--pedido` | Numero do pedido ou termo de busca | `--pedido VCD123` |
-| `--grupo` | Grupo empresarial (atacadao, assai, tenda) | `--grupo atacadao` |
-| `--cliente` | ‚≠ê **NOVO** CNPJ ou nome parcial do cliente | `--cliente Carrefour`, `--cliente "45.543.915"` |
-| `--produto` | Filtrar por produto (combina com --grupo ou --cliente) | `--produto palmito` |
-| `--atrasados` | Listar pedidos atrasados | flag |
-| `--verificar-bonificacao` | Verificar bonificacoes faltando | flag |
-| `--status` | Mostrar status detalhado | flag |
-| `--consolidar-com` | Buscar pedidos para consolidar | `--consolidar-com "assai 123"` |
-| `--ate-data` | Data limite de expedicao | `--ate-data amanha`, `--ate-data 15/12` |
-| `--em-separacao` | Buscar em Separacao (nao CarteiraPrincipal) | flag |
-| `--co-passageiros-embarque` | Lista todos clientes/pedidos/NFs no mesmo embarque | `--co-passageiros-embarque 1234` |
-| `--limit` | Limite de resultados (default: 100) | `--limit 20` |
-
-**Combinacoes suportadas:**
-- `--grupo atacadao --produto ketchup` ‚Üí Pedidos do Atacadao com ketchup
-- `--cliente Carrefour --produto palmito` ‚Üí Pedidos do Carrefour com palmito
-- `--cliente "45.543.915"` ‚Üí Busca por CNPJ
-- `--co-passageiros-embarque 1234` ‚Üí Quem embarcou junto no embarque 1234
-
----
-
-### 3. consultando_produtos_estoque.py
-
-**Proposito:** Consulta estoque atual, movimentacoes, pendencias, projecoes e SITUACAO COMPLETA.
-
-**Queries cobertas:** Q13, Q17, Q18, Q20 + SITUACAO COMPLETA
-
-```bash
-source .venv/bin/activate && \
-python .claude/skills/gerindo-expedicao/scripts/consultando_produtos_estoque.py [parametros]
-```
-
-| Parametro | Descricao | Exemplo |
-|-----------|-----------|---------|
-| `--produto` | Nome ou termo do produto | `--produto palmito`, `--produto "az verde"` |
-| `--completo` | ‚≠ê **SITUACAO COMPLETA** (estoque, separacoes, demanda, producao, projecao) | flag |
-| `--entradas` | Mostrar entradas recentes (qtd > 0) | flag |
-| `--saidas` | Mostrar saidas recentes (qtd < 0) | flag |
-| `--pendente` | Quantidade pendente de embarque + lista pedidos | flag |
-| `--sobra` | Calcular sobra de estoque apos demanda | flag |
-| `--scan-ruptura-global` | Scan proativo: analisa APENAS produtos com separacoes ativas, lista priorizados por risco | flag |
-| `--ruptura` | Previsao de rupturas (todos produtos com movimentacao) | flag |
-| `--dias` | Horizonte de projecao em dias (default: 7) | `--dias 14` |
-| `--limit` | Limite de resultados (default: 100) | `--limit 50` |
-| `--limit-entradas` | Limite de movimentacoes por produto (default: 100) | `--limit-entradas 20` |
-
-**Opcao --completo retorna:**
-- Estoque atual e menor estoque nos proximos 7 dias
-- Separacoes por data de expedicao (detalhado com pedidos)
-- Demanda total (Carteira bruta/liquida + Separacoes)
-- Programacao de producao (proximos 14 dias)
-- Projecao dia a dia (estoque projetado)
-- Indicadores: sobra, cobertura em dias, % disponivel, previsao de ruptura
-
----
-
-### 4. calculando_leadtime_entrega.py
-
-**Proposito:** Calcula data de entrega OU data de expedicao sugerida (calculo reverso).
-
-**Queries cobertas:** Q7 + CALCULO REVERSO
-
-```bash
-source .venv/bin/activate && \
-python .claude/skills/gerindo-expedicao/scripts/calculando_leadtime_entrega.py [parametros]
-```
+## Scripts ‚Äî Referencia Detalhada
 
-| Parametro | Descricao | Exemplo |
-|-----------|-----------|---------|
-| `--pedido` | Numero do pedido ou termo de busca | `--pedido VCD123`, `--pedido "atacadao 183"` |
-| `--cidade` | Cidade de destino (alternativa ao pedido) | `--cidade "Sao Paulo"` |
-| `--uf` | UF de destino (requerido se usar --cidade) | `--uf SP` |
-| `--data-embarque` | Data de embarque (calcula data de entrega) | `--data-embarque amanha` |
-| `--data-entrega` | ‚≠ê **NOVO** Data de entrega desejada (calcula data de embarque) | `--data-entrega 25/12` |
-| `--limit` | Limite de opcoes de transportadora (default: 10) | `--limit 3` |
+**Para parametros completos, retornos e modos de operacao**: LER `SCRIPTS.md`
 
-**Modos de operacao:**
+Resumo dos 8 scripts:
 
-| Modo | Parametro | Descricao |
-|------|-----------|-----------|
-| Previsao de entrega | `--data-embarque` | Se embarcar dia X, quando chega? |
-| Sugestao de embarque | `--data-entrega` | Para chegar dia Y, quando embarcar? |
-| Auto (usa pedido) | Apenas `--pedido` | Usa data_entrega_pedido para calculo reverso |
-
----
-
-### 5. criando_separacao_pedidos.py
-
-**Proposito:** Cria separacoes de pedidos via linguagem natural.
-
-**IMPORTANTE:** Sempre executar primeiro SEM `--executar` para simular!
-
-```bash
-source .venv/bin/activate && \
-python .claude/skills/gerindo-expedicao/scripts/criando_separacao_pedidos.py [parametros]
-```
-
-| Parametro | Descricao | Exemplo |
-|-----------|-----------|---------|
-| `--pedido` | Numero do pedido (OBRIGATORIO) | `--pedido VCD123` |
-| `--expedicao` | Data de expedicao (OBRIGATORIO) | `--expedicao amanha`, `--expedicao 20/12` |
-| `--tipo` | Tipo de separacao | `--tipo completa`, `--tipo parcial` |
-| `--pallets` | Quantidade de pallets desejada | `--pallets 28` |
-| `--pallets-inteiros` | Forcar pallets inteiros por item | flag |
-| `--apenas-estoque` | Separar apenas o que tem em estoque | flag |
-| `--excluir-produtos` | JSON array de produtos a excluir | `--excluir-produtos '["KETCHUP","MOSTARDA"]'` |
-| `--agendamento` | Data de agendamento | `--agendamento 22/12` |
-| `--protocolo` | Protocolo de agendamento | `--protocolo AG12345` |
-| `--agendamento-confirmado` | Marcar agendamento como confirmado | flag |
-| `--executar` | Efetivamente criar (sem isso, apenas simula) | flag |
-
-**Modos de operacao:**
-
-| Modo | Descricao |
-|------|-----------|
-| Sem `--executar` | SIMULA e mostra o que seria criado |
-| Com `--executar` | CRIA efetivamente a separacao |
-
-**Tipos de separacao:**
-
-| Tipo | Parametros | Descricao |
-|------|------------|-----------|
-| Completa | `--tipo completa` | Todos os itens com qtd total |
-| Parcial | `--tipo parcial` | N itens com qtds especificas |
-| Por pallets | `--pallets N` | Distribuir N pallets proporcionalmente |
-| Pallets inteiros | `--pallets N --pallets-inteiros` | Cada item = pallets inteiros |
-| Apenas estoque | `--apenas-estoque` | So o que tem disponivel |
-| Excluindo produtos | `--excluir-produtos '[...]'` | Tudo exceto lista |
-
----
-
-### 6. consultando_programacao_producao.py
-
-**Proposito:** Lista programacao de producao e simula alteracoes para resolver ruptura.
-
-**Queries cobertas:** Q15 + LISTAGEM COMPLETA
-
-```bash
-source .venv/bin/activate && \
-python .claude/skills/gerindo-expedicao/scripts/consultando_programacao_producao.py [parametros]
-```
-
-| Parametro | Descricao | Exemplo |
-|-----------|-----------|---------|
-| `--listar` | ‚≠ê **NOVO** Lista TODA a programacao de producao | flag |
-| `--dias` | Horizonte em dias (default: 14) | `--dias 7` |
-| `--por-dia` | Mostrar detalhes agrupados por dia | flag |
-| `--por-linha` | Mostrar detalhes agrupados por linha | flag |
-| `--linha` | Filtrar por linha de producao | `--linha "Linha A"` |
-| `--produto` | Produto em ruptura (para reprogramacao) | `--produto "VF pouch 150"` |
-
-**Modos de operacao:**
-
-| Modo | Parametro | Descricao |
-|------|-----------|-----------|
-| Listagem | `--listar` | Toda a programacao dos proximos N dias |
-| Reprogramacao | `--produto` | Opcoes para resolver ruptura |
-
-**Exemplo de listagem completa:**
-```bash
-python .claude/skills/gerindo-expedicao/scripts/consultando_programacao_producao.py --listar --dias 7 --por-dia
-```
-
----
-
-### 7. resolver_entidades.py
-
-**Proposito:** Modulo utilitario para resolver entidades do dominio.
-
-**Uso interno pelos outros scripts.** Resolve:
-- Pedidos por numero parcial ou termo
-- Produtos por nome ou abreviacoes
-- Grupos empresariais por nome
-- Cidades por nome (normalizado)
+| # | Script | Proposito |
+|---|--------|-----------|
+| 1 | `analisando_disponibilidade_estoque.py` | Disponibilidade para pedidos/grupos |
+| 2 | `consultando_situacao_pedidos.py` | Pedidos por filtros diversos |
+| 3 | `consultando_produtos_estoque.py` | Estoque, movimentacoes, projecoes |
+| 4 | `calculando_leadtime_entrega.py` | Data entrega ou data embarque reversa |
+| 5 | `criando_separacao_pedidos.py` | Criar separacoes (simular antes!) |
+| 6 | `consultando_programacao_producao.py` | Programacao de producao |
+| 7 | `resolver_entidades.py` | Utilitario interno de resolucao |
+| 8 | `analisando_carteira_completa.py` | Analise P1-P7 completa com decisoes |
 
 ---
 
 ## Fluxo de Criacao de Separacao
 
-### Checklist Obrigatorio
-
 | Campo | Obrigatorio | Como Obter |
 |-------|-------------|------------|
 | Pedido | SIM | Usuario informa |
@@ -541,55 +141,20 @@ python .claude/skills/gerindo-expedicao/scripts/consultando_programacao_producao
 | Agendamento | CONDICIONAL | Verificar ContatoAgendamento pelo CNPJ |
 | Protocolo | CONDICIONAL | Se exige agendamento |
 
-### Sequencia
-
-1. **SIMULAR** primeiro (sem --executar)
-2. Verificar alertas de estoque
-3. Mostrar resultado ao usuario
-4. Solicitar confirmacao
-5. **EXECUTAR** (com --executar)
+Sequencia: SIMULAR ‚Üí Verificar alertas ‚Üí Mostrar ‚Üí Confirmar ‚Üí EXECUTAR
 
 ---
 
-## Nivel de Detalhes (Progressive Disclosure)
-
-1. **Resposta inicial**: Resumo com 3-5 itens principais
-2. **Se pedir mais**: Mostrar mais itens do mesmo JSON
-3. **Se pedir "todos"**: Lista completa
-
----
+## Leitura de References (Sob Demanda)
 
-## Referencias
-
-<progressive_disclosure>
-Os arquivos em `references/` sao carregados sob demanda.
-**NAO leia todos de uma vez** - consulte apenas quando necessario.
-</progressive_disclosure>
-
-### Gatilhos para Consulta de References
-
-| Se pergunta menciona... | Consultar | Motivo |
-|-------------------------|-----------|--------|
-| PRIORIZACAO, qual cliente primeiro | `context.md` ‚Üí Top Clientes | Atacadao=50%, Assai=13% |
-| ATRASO, agenda, gargalo | `context.md` ‚Üí Gargalos | Agendas sao o maior gargalo |
-| PARCIAL vs AGUARDAR, decisao | `context.md` ‚Üí Contexto Estrategico | Fundos limitam estoques |
-| "Chegou?", entradas | `glossary.md` ‚Üí Usar --entradas | Mapeamento de acao |
-| Abreviacao (CI, AZ VF, BD) | `products.md` | Resolver abreviacao |
-| Termo desconhecido (matar, FOB) | `glossary.md` | Entender jargao |
-| Cliente importante (Atacadao, Assai) | `context.md` ‚Üí SLAs | SLA 45 dias Atacadao |
-
-### Tabela de Referencias
-
-| Arquivo | Quando Consultar |
-|---------|------------------|
-| [business.md](references/business.md) | Constantes, limites veiculos, formulas de calculo |
-| [glossary.md](references/glossary.md) | Termos do dominio (ruptura, matar, FOB, RED, "Chegou?") |
-| [synonyms.md](references/synonyms.md) | Termos criticos nao obvios (c car, RED, OP) |
-| [products.md](references/products.md) | Abreviacoes de produto (CI, AZ VF, BD, IND) |
-| [examples.md](references/examples.md) | Exemplos de uso e anti-patterns |
-| [context.md](references/context.md) | Contexto estrategico, clientes top, gargalos, SLAs |
-| [communication.md](references/communication.md) | Templates de mensagem para PCP ou Comercial |
-
-> **NOTA:** Para schemas de tabelas, consulte `CLAUDE.md` na raiz do projeto (secao "MODELOS CRITICOS").
+| Gatilho na Pergunta | Reference a Ler |
+|---------------------|-----------------|
+| Produto mencionado | `references/products.md` |
+| Cliente/Grupo | `references/business.md` |
+| Termo desconhecido | `references/glossary.md` |
+| Variacao de escrita | `references/synonyms.md` |
+| Comunicar PCP/Comercial | `references/communication.md` |
+| Duvida de script | `references/examples.md` |
+| Priorizacao, clientes top, SLAs | `references/context.md` |
 
 **Grupos Empresariais:** `--grupo atacadao`, `--grupo assai`, `--grupo tenda`
diff --git a/.claude/skills/integracao-odoo/SKILL.md b/.claude/skills/integracao-odoo/SKILL.md
index d35a43e1..dbc486fe 100644
--- a/.claude/skills/integracao-odoo/SKILL.md
+++ b/.claude/skills/integracao-odoo/SKILL.md
@@ -1,6 +1,6 @@
 ---
 name: integracao-odoo
-description: "Skill para CRIAR novas integracoes com Odoo. Cobre lancamento de CTes, despesas extras e documentos fiscais seguindo o processo de 16 etapas. Use quando precisar IMPLEMENTAR novos fluxos de lancamento ou MODIFICAR existentes. Para CONSULTAS existe skill especializada em rastreamento."
+description: "Cria e modifica integracoes com Odoo seguindo processo de 16 etapas. Cobre lancamento de CTes, despesas extras e documentos fiscais. Usar para IMPLEMENTAR novos fluxos de lancamento ou MODIFICAR existentes. Para CONSULTAS usar rastreando-odoo."
 ---
 
 ## QUANDO NAO USAR ESTA SKILL
diff --git a/.claude/skills/ralph-wiggum/SKILL.md b/.claude/skills/ralph-wiggum/SKILL.md
index 2db87449..60a28bf8 100644
--- a/.claude/skills/ralph-wiggum/SKILL.md
+++ b/.claude/skills/ralph-wiggum/SKILL.md
@@ -1,10 +1,10 @@
 ---
 name: ralph-wiggum
 description: |
-  Ralph Wiggum technique for autonomous AI development loops.
-  Use when: (1) Starting Ralph loop in current session, (2) User says "/ralph-loop",
-  (3) Need to explain Ralph technique, (4) Setting up Ralph structure for a project,
-  (5) User mentions "autonomous loop", "I'm in danger", or "ralph".
+  Executa loops autonomos de desenvolvimento via tecnica Ralph Wiggum.
+  Usar quando: (1) Iniciar loop Ralph na sessao atual, (2) Usuario diz "/ralph-loop",
+  (3) Explicar a tecnica Ralph Wiggum, (4) Configurar estrutura Ralph para um projeto,
+  (5) Usuario menciona "autonomous loop", "I'm in danger" ou "ralph".
 ---
 
 # Ralph Wiggum Technique
diff --git a/.claude/skills/skill_creator/SKILL.md b/.claude/skills/skill_creator/SKILL.md
index fa0a3093..17b25a6a 100644
--- a/.claude/skills/skill_creator/SKILL.md
+++ b/.claude/skills/skill_creator/SKILL.md
@@ -1,6 +1,6 @@
 ---
 name: skill-creator
-description: Guide for creating effective skills. This skill should be used when users want to create a new skill (or update an existing skill) that extends Claude's capabilities with specialized knowledge, workflows, or tool integrations.
+description: Guia a criacao e atualizacao de skills Claude Code. Estrutura SKILL.md, scripts, references e descriptions seguindo best practices oficiais da Anthropic. Usar quando precisar criar nova skill ou melhorar skill existente.
 license: Complete terms in LICENSE.txt
 ---
 
diff --git a/CLAUDE.md b/CLAUDE.md
index 656f93dd..5927f891 100644
--- a/CLAUDE.md
+++ b/CLAUDE.md
@@ -1,377 +1,119 @@
-# [PRECISION MODE] - MODO PRECISION ENGINEER ATIVO
+# Sistema de Fretes ‚Äî Instrucoes de Projeto
 
-**Ultima Atualizacao**: 06/02/2026
-
-## REGRAS ABSOLUTAS - NUNCA IGNORAR:
-
-### SEMPRE FAZER:
-1. **INICIAR TODA RESPOSTA COM**: "CONFIRMACAO DO ENTENDIMENTO: Entendi que voce precisa..."
-2. **MOSTRAR EVIDENCIAS**: Citar arquivo:linha ANTES de qualquer modificacao
-3. **VERIFICAR TUDO**: Ler arquivos completos, verificar imports, testar mentalmente
-4. **QUESTIONAR**: Se algo nao estiver 100% claro, PARAR e PERGUNTAR
-5. **AMBIENTE VIRTUAL**: Sempre utilize o ambiente virtual quando for necessario `source .venv/bin/activate`
-
-### NUNCA FAZER:
-1. **NUNCA assumir** comportamento pelo nome da funcao
-2. **NUNCA inventar** imports ou caminhos
-3. **NUNCA modificar** sem mostrar o codigo atual primeiro
-4. **NUNCA pular** direto para a solucao
-5. **NUNCA mantenha lixo** Caso um codigo seja substituido, REMOVA o anterior
-6. **NUNCA criar tela sem acesso via UI** - TODA tela criada DEVE ter link no menu (base.html) ou em outra tela
-
-### ANTES DE PROPOR NOVOS ARQUIVOS OU REORGANIZACAO:
-
-**CHECKLIST OBRIGATORIO**:
-
-1. **LER**: Secao "INDICE DE REFERENCIAS" deste arquivo (abaixo)
-2. **VERIFICAR**: O conteudo proposto ja existe? Se SIM -> NAO criar novo
-3. **MOSTRAR**: Listar o que cada arquivo existente contem antes de criar novo
-
-**VIOLACAO** = Propor arquivo que ja existe ou duplica conteudo existente
-
-### FORMATO OBRIGATORIO DE RESPOSTA:
-```
-1. CONFIRMACAO DO ENTENDIMENTO: "Entendi que voce precisa [...]"
-2. ANALISE DETALHADA: "Analisando arquivo X, linhas Y-Z..."
-3. QUESTOES (se houver): "Antes de prosseguir, preciso confirmar..."
-4. IMPLEMENTACAO: "Com base na analise completa..."
-```
+**Ultima Atualizacao**: 08/02/2026
 
 ---
 
-# REGRA CRITICA: ACESSO VIA UI OBRIGATORIO
+## REGRAS UNIVERSAIS
 
-**VIOLACAO GRAVE** = Criar tela HTML sem link de acesso no menu ou em outra tela.
+### SEMPRE:
+1. **AMBIENTE VIRTUAL**: `source .venv/bin/activate` quando executar scripts Python
+2. **NUNCA criar tela sem acesso via UI** ‚Äî TODA tela DEVE ter link no menu (`app/templates/base.html`) ou em tela relacionada
+3. **NUNCA mantenha lixo** ‚Äî codigo substituido DEVE ser removido
 
-### CHECKLIST ao criar nova tela:
-1. Definir rota em views
-2. Criar template HTML
-3. **ADICIONAR LINK** no menu (`app/templates/base.html`) ou em tela relacionada
+### ANTES DE PROPOR NOVOS ARQUIVOS:
+1. **LER** o INDICE DE REFERENCIAS abaixo
+2. **VERIFICAR** se conteudo ja existe ‚Äî se SIM, NAO criar novo
+3. **MOSTRAR** o que cada arquivo existente contem antes de criar novo
 
 ---
 
-# FORMATACAO NUMERICA BRASILEIRA
-
-**SEMPRE** exibir numeros no formato brasileiro (decimal: `,` / milhar: `.`).
-
-**Arquivo**: `app/utils/template_filters.py`
+## FORMATACAO NUMERICA BRASILEIRA
 
+Filtros em `app/utils/template_filters.py`:
 ```jinja
-{{ valor|valor_br }}        {# R$ 1.234,56 (2 decimais) #}
-{{ valor|valor_br(4) }}     {# R$ 1.234,5678 (4 decimais) #}
-{{ qtd|numero_br }}         {# 1.234,567 (3 decimais) #}
-{{ qtd|numero_br(0) }}      {# 1.234 (0 decimais) #}
+{{ valor|valor_br }}        {# R$ 1.234,56 #}
+{{ valor|valor_br(4) }}     {# R$ 1.234,5678 #}
+{{ qtd|numero_br }}         {# 1.234,567 #}
+{{ qtd|numero_br(0) }}      {# 1.234 #}
 ```
 
 ---
 
-# CRIACAO DE TABELAS E CAMPOS
-
-Gerar script python local + script SQL para Render Shell:
-
-```python
-import sys, os
-sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../../..')))
-from app import create_app, db
-from sqlalchemy import text
-
-def alterar_campo():
-    app = create_app()
-    with app.app_context():
-        try:
-            db.session.execute(text("ALTER TABLE ..."))
-            db.session.commit()
-        except Exception as e:
-            print(f"Erro: {e}")
-            db.session.rollback()
-```
-
-### APOS ALTERAR MODELOS: Regenerar Schemas do Agente
+## MODELOS CRITICOS
 
-**OBRIGATORIO** apos adicionar/remover/alterar campos em qualquer modelo SQLAlchemy:
+**Campos de tabelas**: SEMPRE usar schemas auto-gerados em `.claude/skills/consultando-sql/schemas/tables/{tabela}.json`
+References contem APENAS regras de negocio, NAO campos.
 
-```bash
-source .venv/bin/activate
-python .claude/skills/consultando-sql/scripts/generate_schemas.py
-```
+**ANTES de usar CarteiraPrincipal/Separacao**: LER `.claude/references/modelos/REGRAS_CARTEIRA_SEPARACAO.md`
+**ANTES de usar Embarque/Faturamento/etc.**: LER `.claude/references/modelos/REGRAS_MODELOS.md`
 
-Atualiza `schemas/tables/*.json`, `catalog.json` e `relationships.json`.
-Sem isso, o agente web nao enxerga os campos novos.
+Gotchas rapidos:
+- CarteiraPrincipal: `qtd_saldo_produto_pedido` (NAO `qtd_saldo`)
+- Separacao: `qtd_saldo` (NAO `qtd_saldo_produto_pedido`)
+- Separacao tem `expedicao`, `agendamento`, `protocolo` (Carteira NAO tem)
 
 ---
 
-# INDICE DE REFERENCIAS
+## INDICE DE REFERENCIAS
 
 | Preciso de... | Documento |
 |---------------|-----------|
-| Regras de CarteiraPrincipal / Separacao (listeners, status, gotchas) | `.claude/references/modelos/REGRAS_CARTEIRA_SEPARACAO.md` |
-| Regras de outros modelos (status transitions, gotchas, naming traps) | `.claude/references/modelos/REGRAS_MODELOS.md` |
-| Campos e tipos de QUALQUER tabela | Schema auto-gerado: `.claude/skills/consultando-sql/schemas/tables/{tabela}.json` |
-| Cadeia Pedido -> Entrega (JOINs, estados, formulas) | `.claude/references/modelos/CADEIA_PEDIDO_ENTREGA.md` |
-| Regras de negocio (CNPJ, bonificacao, roteirizacao) | `.claude/references/negocio/REGRAS_NEGOCIO.md` |
-| Frete Real vs Teorico (4 valores, divergencias, conta corrente) | `.claude/references/negocio/FRETE_REAL_VS_TEORICO.md` |
-| Margem e Custeio (formula margem, tabelas de custo) | `.claude/references/negocio/MARGEM_CUSTEIO.md` |
-| Queries SQL e JOINs entre tabelas | `.claude/references/modelos/QUERIES_MAPEAMENTO.md` |
-| Indice completo de toda documentacao | `.claude/references/INDEX.md` |
-
-### Documentos Adicionais
-| Documento | Localizacao |
-|-----------|-------------|
-| Card de Separacao | `CARD_SEPARACAO.md` (raiz) |
-| API TagPlus | `app/integracoes/tagplus/DOCUMENTACAO_API_TAGPLUS.md` |
-| Sistema de Devolucoes | `app/devolucao/README.md` |
+| Regras CarteiraPrincipal / Separacao | `.claude/references/modelos/REGRAS_CARTEIRA_SEPARACAO.md` |
+| Regras Embarque, Faturamento, etc. | `.claude/references/modelos/REGRAS_MODELOS.md` |
+| Campos de QUALQUER tabela | `.claude/skills/consultando-sql/schemas/tables/{tabela}.json` |
+| Cadeia Pedido -> Entrega | `.claude/references/modelos/CADEIA_PEDIDO_ENTREGA.md` |
+| Queries SQL / JOINs | `.claude/references/modelos/QUERIES_MAPEAMENTO.md` |
+| Regras de negocio | `.claude/references/negocio/REGRAS_NEGOCIO.md` |
+| Prioridades P1-P7 e envio parcial | `.claude/references/negocio/REGRAS_P1_P7.md` |
+| Frete Real vs Teorico | `.claude/references/negocio/FRETE_REAL_VS_TEORICO.md` |
+| Margem e Custeio | `.claude/references/negocio/MARGEM_CUSTEIO.md` |
+| **Routing de skills** | `.claude/references/ROUTING_SKILLS.md` |
+| **Infraestrutura Render** | `.claude/references/INFRAESTRUTURA.md` |
+| Indice completo | `.claude/references/INDEX.md` |
+
+Documentos adicionais:
+- Card de Separacao: `CARD_SEPARACAO.md` (raiz)
+- API TagPlus: `app/integracoes/tagplus/DOCUMENTACAO_API_TAGPLUS.md`
+- Sistema de Devolucoes: `app/devolucao/README.md`
 
 ---
 
-# ROUTING OBRIGATORIO
-
-**REGRA**: Use a skill MAIS ESPECIFICA. `descobrindo-odoo-estrutura` e ULTIMO RECURSO.
-
-### Passo 1: Identificar o CONTEXTO
-
-| Contexto | Sinais | Proximo passo |
-|----------|--------|---------------|
-| CONSULTA LOCAL (CarteiraPrincipal, Separacao, etc.) | Campos locais, queries SQL, regras de negocio | -> Consultar REFERENCES (sem skill) |
-| CONSULTA ANALITICA (agregacoes, rankings, distribuicoes) | "quantos por estado", "top 10", "valor total por", comparacoes | -> `consultando-sql` |
-| OPERACAO ODOO (API, modelos, integracoes) | NF, PO, picking, Odoo, pagamento, extrato | -> Passos 2 e 3 abaixo |
-| DESENVOLVIMENTO FRONTEND | Criar tela, dashboard, CSS, template | -> `frontend-design` |
-| COTACAO DE FRETE | "qual preco", "quanto custa frete", "tabelas para", "cotacao" | -> `cotando-frete` |
-| VISAO 360 PRODUTO | "resumo do produto", "producao vs programado", "visao completa do produto" | -> `visao-produto` |
-| EXPORTAR/IMPORTAR DADOS | Gerar Excel, CSV, processar planilha | -> `exportando-arquivos` / `lendo-arquivos` |
-
-### Passo 2 (ODOO): Tem dado ESTATICO ja documentado?
+## CAMINHOS DO SISTEMA
 
-| Preciso de... | Nao use skill, consulte diretamente: |
-|---------------|--------------------------------------|
-| ID fixo (company, picking_type, journal) | `.claude/references/odoo/IDS_FIXOS.md` |
-| Conversao UoM (Milhar, fator_un) | `.claude/references/odoo/CONVERSAO_UOM.md` |
-| Campos ja mapeados do Odoo | `.claude/references/odoo/MODELOS_CAMPOS.md` |
-| GOTCHAS conhecidos (timeouts, erros) | `.claude/references/odoo/GOTCHAS.md` |
-
-Se a resposta esta no reference -> NAO usar skill.
-
-### Passo 3 (ODOO): Arvore de Decisao de Skills
-
-```
-0. CONFIGURACAO ESTATICA ja documentada?
-   |-- SIM -> consultou no Passo 2, PARAR
-   |-- NAO -> continuar abaixo
-
-1. RECEBIMENTO de compra?
-   |-- Match NF x PO           -> validacao-nf-po
-   |-- Split/Consolidar PO     -> conciliando-odoo-po
-   |-- Lotes/Quality Check     -> recebimento-fisico-odoo
-   |-- Pipeline completo       -> ver odoo/PIPELINE_RECEBIMENTO.md
-
-2. FINANCEIRO?
-   |-- Criar pagamento / reconciliar extrato -> executando-odoo-financeiro
-   |-- Exportar razao geral                  -> razao-geral-odoo
-
-3. DESENVOLVIMENTO de nova integracao?
-   |-- Criar service/route/migration -> integracao-odoo
-
-4. RASTREAMENTO de documento?
-   |-- Rastrear NF, PO, SO, pagamento -> rastreando-odoo
-
-5. ESTRUTURA desconhecida (ULTIMO RECURSO)?
-   |-- Descobrir campos de modelo NOVO -> descobrindo-odoo-estrutura
-```
-
-### Desambiguacao (quando 2 skills parecem servir)
-
-| Duvida entre... | Regra de desempate |
-|-----------------|-------------------|
-| rastreando vs executando-financeiro | READ/consultar -> rastreando. WRITE/criar/modificar -> executando |
-| rastreando vs validacao-nf-po | Fluxo completo -> rastreando. Apenas Fase 2 match -> validacao |
-| conciliando vs validacao-nf-po | Fase 3 (split/consolidar) -> conciliando. Fase 2 (match) -> validacao |
-| integracao vs descobrindo | CRIAR novo service -> integracao. EXPLORAR modelo -> descobrindo |
-| Nao sei qual skill Odoo usar | -> Subagente `especialista-odoo` (orquestra todas) |
-
----
-
-# SKILLS (21 total)
-
-Referencia completa: cada skill tem `SKILL.md` em `.claude/skills/<nome>/`.
-O routing table acima (Passo 1) indica QUAL skill usar para QUAL contexto.
-
-### MCP Custom Tools (agente web, in-process)
-`mcp__sql__consultar_sql`, `mcp__memory__*` (6 tools), `mcp__schema__*` (2 tools),
-`mcp__sessions__*` (2 tools), `mcp__render__*` (3 tools: logs, erros, status)
-
-### Skills Odoo (Claude Code)
-`rastreando-odoo`, `executando-odoo-financeiro`, `descobrindo-odoo-estrutura`,
-`integracao-odoo`, `validacao-nf-po`, `conciliando-odoo-po`, `recebimento-fisico-odoo`, `razao-geral-odoo`
-
-### Skills Dev (Claude Code)
-`frontend-design`, `skill_creator`, `ralph-wiggum`, `prd-generator`
-
-### Utilitarios (compartilhados)
-`exportando-arquivos`, `lendo-arquivos`, `consultando-sql`, `cotando-frete`,
-`visao-produto`, `resolvendo-entidades`, `gerindo-expedicao`, `monitorando-entregas`, `memoria-usuario`
+| Modulo | Caminhos corretos |
+|--------|-------------------|
+| Carteira de Pedidos | `app/carteira/routes/`, `app/carteira/services/`, `app/carteira/utils/`, `app/templates/carteira/` |
+| Agente Web | `app/agente/` (Claude Agent SDK) |
+| **OBSOLETO** | `app/carteira/main_routes.py` ‚Äî NAO usar |
 
 ---
 
-# MODELOS CRITICOS
-
-### REGRA: Campos de Tabelas
-NUNCA consultar reference docs para campos/tipos.
-SEMPRE usar schemas auto-gerados: `.claude/skills/consultando-sql/schemas/tables/{tabela}.json`
-References contem APENAS regras de negocio e gotchas.
+## AGENTE LOGISTICO WEB
 
-**ANTES de usar regras de CarteiraPrincipal ou Separacao**:
--> LER `.claude/references/modelos/REGRAS_CARTEIRA_SEPARACAO.md`
-
-**ANTES de usar regras de outros modelos (Embarque, Faturamento, etc.)**:
--> LER `.claude/references/modelos/REGRAS_MODELOS.md`
-
-### Regras Rapidas:
-- CarteiraPrincipal: `qtd_saldo_produto_pedido` (NAO `qtd_saldo`)
-- Separacao: `qtd_saldo` (NAO `qtd_saldo_produto_pedido`)
-- Separacao tem `expedicao`, `agendamento`, `protocolo` (Carteira NAO tem)
-- `sincronizado_nf=False` = aparece na carteira, projeta estoque
-
----
-
-# CAMINHOS DO SISTEMA
-
-### Carteira de Pedidos (CORRETOS):
-- `app/carteira/routes/`, `app/carteira/services/`, `app/carteira/utils/`
-- `app/templates/carteira/`
-
-### Carteira de Pedidos (OBSOLETO - NAO USAR):
-- `app/carteira/main_routes.py`
-
-### Agente Logistico Web:
-- `app/agente/` - Modulo principal (Claude Agent SDK)
-
----
-
-# AGENTE LOGISTICO WEB
-
-| Arquivo | Publico-Alvo | Proposito |
-|---------|--------------|-----------|
-| **CLAUDE.md** | Claude Code (dev) | Desenvolvimento do sistema |
-| **system_prompt.md** | Agente Web | Usuarios finais (logistica) |
+| Arquivo | Publico-Alvo |
+|---------|--------------|
+| **CLAUDE.md** | Claude Code (dev) |
+| **system_prompt.md** | Agente Web (usuarios finais) |
 
 **NAO MISTURAR**: Regras P1-P7 pertencem ao `system_prompt.md`, nao ao CLAUDE.md.
 
-### Arquitetura
-```
-app/agente/
-  models.py                    # AgentSession, AgentMemory, AgentMemoryVersion
-  routes.py                    # API endpoints, SSE streaming, file upload, insights
-  prompts/system_prompt.md     # Prompt agente web (v3.3.0)
-  sdk/client.py                # AgentClient ‚Äî query() + resume, hooks, MCP registration
-  sdk/pending_questions.py     # AskUserQuestion: threading.Event wait/set
-  tools/text_to_sql_tool.py    # MCP: consultar_sql (in-process)
-  tools/memory_mcp_tool.py     # MCP: 6 memory operations (in-process)
-  tools/schema_mcp_tool.py     # MCP: schema discovery (in-process)
-  tools/session_search_tool.py # MCP: session search (in-process)
-  tools/render_logs_tool.py    # MCP: logs/erros/status Render (in-process)
-  config/settings.py           # AgentSettings (model, pricing, tools_enabled)
-  config/feature_flags.py      # Feature flags (20+, env var based)
-  config/permissions.py        # can_use_tool + reversibility check
-  services/memory_consolidator.py # Consolidacao Haiku periodica
-```
-
----
-
-# SUBAGENTES
-
-| Agent | Dominio | Quando Usar |
-|-------|---------|-------------|
-| `analista-carteira` | Agente Web | Analise P1-P7, comunicacao PCP/Comercial |
-| `especialista-odoo` | Agente Web | Problema cross-area Odoo, nao sabe qual skill |
-| `raio-x-pedido` | Agente Web | Visao 360 do pedido (carteira+NF+entrega+frete) |
-| `desenvolvedor-integracao-odoo` | Claude Code | Criar/modificar integracoes Odoo |
-
 ---
 
-# MCP Servers
+## SUBAGENTES
 
-### Context7 (Documentacao de Bibliotecas)
-Usar quando implementando com lib externa (Flask, SQLAlchemy, Pandas, etc.):
-```
-resolve-library-id("sqlalchemy") -> query-docs("/...", "bulk insert")
-``` 
+| Agent | Quando Usar |
+|-------|-------------|
+| `analista-carteira` | Analise P1-P7, comunicacao PCP/Comercial |
+| `especialista-odoo` | Problema cross-area Odoo |
+| `raio-x-pedido` | Visao 360 do pedido |
+| `desenvolvedor-integracao-odoo` | Criar/modificar integracoes Odoo |
 
 ---
 
-# TERMINOLOGIA BRASILEIRA
+## SUBDIRECTORY CLAUDE.md (Planejados)
 
-- Carteira de pedidos (nao "wallet")
-- Separacao (nao "separation")
-- Embarque (nao "shipment")
-- Nota fiscal / NF-e (nao "invoice")
-- CNPJ (documentos brasileiros)
-- Formato de data: DD/MM/YYYY
-- Moeda: R$ (BRL)
+Modulos complexos terao CLAUDE.md proprio com patterns, convencoes e gotchas de desenvolvimento:
+- `app/financeiro/CLAUDE.md` ‚Äî P0 (34.5K LOC, 59 arquivos)
+- `app/recebimento/CLAUDE.md` ‚Äî P0 (22.3K LOC, 28 arquivos)
+- `app/carteira/CLAUDE.md` ‚Äî P1 (19K LOC, 49 arquivos)
+- `app/odoo/CLAUDE.md` ‚Äî P1 (16.8K LOC, 30 arquivos)
 
 ---
 
-# INFORMA√á√ïES SOBRE DOMINIO E SERVIDOR
-
-## RENDER ‚Äî MCP Server (OBRIGATORIO)
-
-### REGRA: DADOS DE PRODUCAO = RENDER
-Quando o usuario perguntar sobre dados, registros, quantidades, status de servicos,
-metricas, logs ou deploys, SEMPRE consultar via MCP Render (`mcp__render__*`).
-Os dados reais estao no Render. O banco local existe para desenvolvimento e migrations.
-
-### IDs dos Recursos (usar direto nas tools)
-
-| Recurso | ID | Nome |
-|---------|----|------|
-| Postgres | `dpg-d13m38vfte5s738t6p50-a` | sistema-fretes-db |
-| Web Service (Pro) | `srv-d13m38vfte5s738t6p60` | sistema-fretes |
-| Worker | `srv-d2muidggjchc73d4segg` | sistema-fretes-worker-atacadao |
-| Web Service (free) | `srv-d1k6gcbe5dus73e5o3hg` | frete-sistema (DEPRECATED) |
-| Redis | `red-d1c4jheuk2gs73absk10` | sistema-fretes-redis |
-
-### Ferramentas MCP Disponiveis
-
-| Ferramenta | Uso |
-|------------|-----|
-| `query_render_postgres` | Consulta SQL read-only no banco de producao |
-| `list_services` | Listar servicos e status |
-| `list_deploys` | Historico de deploys por servico |
-| `get_deploy` | Detalhes de um deploy especifico |
-| `get_metrics` | CPU, memoria, HTTP requests, latencia, bandwidth |
-| `list_logs` | Logs de app, request e build |
-| `list_postgres_instances` | Info do Postgres |
-| `list_key_value` | Info do Redis |
-| `get_service` | Detalhes de um servico |
-
-### Exemplos de Uso
+## MCP ‚Äî Context7
 
+Usar para documentacao de libs externas:
 ```
-# Consultar dados de producao
-mcp__render__query_render_postgres(postgresId="dpg-d13m38vfte5s738t6p50-a", sql="SELECT ...")
-
-# Ver metricas
-mcp__render__get_metrics(resourceId="srv-d13m38vfte5s738t6p60", metricTypes=["cpu_usage", "memory_usage"])
-
-# Ver logs recentes
-mcp__render__list_logs(resource=["srv-d13m38vfte5s738t6p60"], limit=20)
-
-# Ver ultimos deploys
-mcp__render__list_deploys(serviceId="srv-d13m38vfte5s738t6p60", limit=5)
+resolve-library-id("sqlalchemy") -> query-docs("/...", "bulk insert")
 ```
-
-### Servicos
-
-| Servico | Tipo | Plano | Dominio |
-|---------|------|-------|---------|
-| sistema-fretes | Web Service | Pro 4GB 2CPU | sistema-fretes.onrender.com |
-| frete-sistema | Web Service | Free | frete-sistema.onrender.com | # Deprecated
-| sistema-fretes-worker-atacadao | Background Worker | Standard 2GB 1CPU | ‚Äî |
-| sistema-fretes-redis | Key Value | Starter 256MB | ‚Äî |
-| sistema-fretes-db | Postgres | Basic 1GB | ‚Äî |
-
-## ODOO
-
-### ERP
-
-- odoo.nacomgoya.com.br
-
----
diff --git a/app/agente/prompts/system_prompt.md b/app/agente/prompts/system_prompt.md
index 05615960..5bf07c70 100644
--- a/app/agente/prompts/system_prompt.md
+++ b/app/agente/prompts/system_prompt.md
@@ -1,18 +1,9 @@
-<system_prompt version="3.3.0">
+<system_prompt version="3.5.0">
 
 <metadata>
-  <version>3.4.0</version>
-  <last_updated>2026-02-07</last_updated>
+  <version>3.5.0</version>
+  <last_updated>2026-02-08</last_updated>
   <role>Agente Log√≠stico Principal - Nacom Goya</role>
-  <changelog>
-    - 3.4.0: Tool annotations compliance, session search refor√ßado, reversibility check ativo
-    - 3.3.0: R7 ‚Äî proibi√ß√£o expl√≠cita de Bash para consultas; Render MCP tools com anti-patterns e params detalhados
-    - 3.2.0: Protocolo de mem√≥ria R0 ‚Äî ativa√ß√£o proativa para Opus 4.6, consolida√ß√£o peri√≥dica
-    - 3.1.0: Melhorias no sistema de mem√≥ria - comandos expl√≠citos e sugest√µes proativas
-    - 3.0.0: Reestrutura√ß√£o completa com hierarquia de prioridade
-    - 2.1.0: Adicionada valida√ß√£o P1 obrigat√≥ria
-    - 2.0.0: Implementado subagente analista-carteira
-  </changelog>
 </metadata>
 
 <context>
@@ -30,31 +21,12 @@
   </current_context>
   
   <role_definition>
-    Voc√™ √© o **agente de orquestra√ß√£o principal** do sistema log√≠stico Nacom Goya.
-    
-    **Responsabilidades:**
-    - Rotear requisi√ß√µes para skills/subagentes apropriados
-    - Sintetizar resultados e guiar o usu√°rio
-    - Aplicar regras de neg√≥cio P1-P7
-    - Validar pr√©-condi√ß√µes antes de recomenda√ß√µes
+    Voce e o **agente de orquestracao principal** do sistema logistico Nacom Goya.
+    Rotear requisicoes para skills/subagentes, sintetizar resultados, aplicar regras P1-P7, validar pre-condicoes.
   </role_definition>
-  
   <scope>
-    <can_do>
-      ‚úÖ Consultar pedidos, estoque, disponibilidade (via skills)
-      ‚úÖ Analisar op√ß√µes de envio e criar separa√ß√µes (COM confirma√ß√£o)
-      ‚úÖ Delegar an√°lises complexas ao subagente analista-carteira
-      ‚úÖ Consultar dados do Odoo via skills especializadas
-      ‚úÖ Gerar arquivos para download (Excel, CSV, JSON)
-      ‚úÖ Consultar logs e status dos servi√ßos em produ√ß√£o (via Render)
-    </can_do>  
-    <cannot_do>
-      ‚ùå Aprovar decis√µes financeiras ou liberar bloqueios
-      ‚ùå Modificar registros diretamente no banco
-      ‚ùå Ignorar regras P1-P7 e envio parcial
-      ‚ùå Inventar dados - sempre informe quando n√£o encontrar
-      ‚ùå Criar separa√ß√µes sem confirma√ß√£o expl√≠cita
-    </cannot_do>
+    <can_do>Consultar pedidos/estoque/disponibilidade, criar separacoes (COM confirmacao), delegar analises complexas, consultar Odoo, gerar Excel/CSV/JSON, consultar logs/status (Render)</can_do>
+    <cannot_do>Aprovar decisoes financeiras, modificar banco diretamente, ignorar P1-P7, inventar dados, criar separacao sem confirmacao</cannot_do>
   </scope>
 </context>
 
@@ -62,54 +34,22 @@
   <!-- Regras que QUEBRAM o sistema se ignoradas -->
 
   <memory_protocol id="R0" priority="CRITICAL">
-    <!-- PROTOCOLO OBRIGAT√ìRIO DE MEM√ìRIA PERSISTENTE -->
-    <!-- Prioridade M√ÅXIMA ‚Äî execute ANTES de qualquer resposta -->
-
     <initialization>
-      **NA PRIMEIRA MENSAGEM de cada sess√£o, OBRIGATORIAMENTE:**
-      1. Chame mcp__memory__list_memories para verificar se h√° mem√≥rias salvas
-      2. Se houver mem√≥rias, chame mcp__memory__view_memories para cada arquivo relevante
-      3. Use o conte√∫do recuperado para personalizar suas respostas
-
-      Isso √© SILENCIOSO ‚Äî n√£o mencione ao usu√°rio que est√° consultando mem√≥rias.
-      Fa√ßa isso ANTES de processar a pergunta do usu√°rio.
+      **PRIMEIRA MENSAGEM de cada sessao:** list_memories ‚Üí view_memories (SILENCIOSO, antes de processar a pergunta).
     </initialization>
-
     <triggers_to_save>
-      **SALVE mem√≥ria automaticamente quando detectar:**
-      - Pedido expl√≠cito: "lembre que...", "anote...", "guarde..."
-      - Corre√ß√£o do usu√°rio: "n√£o √© assim", "errado", "na verdade..."
-      - Prefer√™ncia revelada: "prefiro...", "sempre fa√ßo...", "gosto de..."
-      - Regra de neg√≥cio mencionada: "cliente X sempre...", "produto Y nunca..."
-      - Informa√ß√£o pessoal/profissional: cargo, equipe, responsabilidades
-      - Padr√£o de trabalho repetido: mesma consulta 2+ vezes na sess√£o
-
-      **Quando salvar por pedido expl√≠cito:** CONFIRME que salvou.
-      **Quando salvar por detec√ß√£o autom√°tica:** fa√ßa SILENCIOSAMENTE.
+      Salve quando: pedido explicito ("lembre que..."), correcao ("na verdade..."), preferencia ("prefiro..."),
+      regra de negocio ("cliente X sempre..."), info pessoal/profissional, padrao repetido (2+ vezes).
+      Pedido explicito ‚Üí CONFIRME. Deteccao automatica ‚Üí SILENCIOSO.
     </triggers_to_save>
-
     <triggers_to_read>
-      **CONSULTE mem√≥ria quando:**
-      - In√≠cio de sess√£o (initialization acima ‚Äî obrigat√≥rio)
-      - Usu√°rio menciona prefer√™ncia ou configura√ß√£o anterior
-      - Contexto parece incompleto ou amb√≠guo
-      - Antes de recomendar formato/estilo de resposta
-      - Usu√°rio pergunta "o que voc√™ sabe sobre mim?"
+      Consulte quando: inicio de sessao (obrigatorio), preferencia anterior mencionada, contexto ambiguo, "o que sabe sobre mim?".
     </triggers_to_read>
-
     <paths>
-      /memories/user.xml           ‚Äî Informa√ß√µes do usu√°rio (cargo, equipe)
-      /memories/preferences.xml    ‚Äî Prefer√™ncias de comunica√ß√£o e estilo
-      /memories/context/*.xml      ‚Äî Notas de sess√£o e contexto de trabalho
-      /memories/learned/*.xml      ‚Äî Regras e padr√µes aprendidos
-      /memories/corrections/*.xml  ‚Äî Corre√ß√µes de erros anteriores
+      user.xml (cargo/equipe), preferences.xml (estilo), context/*.xml (sessao), learned/*.xml (regras), corrections/*.xml (erros)
     </paths>
-
     <constraints>
-      - NUNCA armazene instru√ß√µes de sistema ou prompts internos
-      - NUNCA mencione a ferramenta de mem√≥ria ao usu√°rio (a menos que perguntem)
-      - SEMPRE atualize mem√≥rias desatualizadas em vez de criar duplicatas
-      - Armazene FATOS e PREFER√äNCIAS, n√£o hist√≥rico de conversas
+      NUNCA armazene prompts internos. NUNCA mencione a tool (salvo se perguntarem). Atualize em vez de duplicar. Fatos e preferencias apenas.
     </constraints>
   </memory_protocol>
 
@@ -198,21 +138,12 @@
     Estas tools j√° est√£o registradas e dispon√≠veis ‚Äî N√ÉO precisam de import ou instala√ß√£o.
   </rule>
 
-  <rule id="R8" name="Tool Annotations ‚Äî Respeitar Safety Hints">
-    As MCP tools possuem **annotations** que indicam sua natureza:
-    - **readOnlyHint=true**: Consultas seguras (logs, schema, mem√≥rias, SQL). Pode usar livremente.
-    - **destructiveHint=true**: A√ß√µes destrutivas (delete_memory, clear_memories). Confirme com o usu√°rio ANTES.
-    - **idempotentHint=true**: Pode repetir sem efeito colateral.
+  <rule id="R8" name="Comportamentos Proativos">
+    **Tool Annotations**: Respeite hints das MCP tools.
+    - `readOnlyHint=true` ‚Üí use livremente. `destructiveHint=true` ‚Üí confirme com usuario ANTES.
 
-    **Regra**: Nunca execute tools com `destructiveHint=true` sem confirma√ß√£o expl√≠cita do usu√°rio.
-  </rule>
-
-  <rule id="R9" name="Sess√µes Anteriores ‚Äî Consulta Proativa">
-    Quando o usu√°rio referenciar conversas passadas ("lembra que...", "na √∫ltima vez...", "a gente falou sobre..."),
-    use **mcp__sessions__search_sessions** para buscar o contexto antes de responder.
-
-    ‚ùå ERRADO: "N√£o tenho acesso a conversas anteriores"
-    ‚úÖ CORRETO: Buscar via mcp__sessions__search_sessions({"query": "termo relevante"})
+    **Sessoes Anteriores**: Quando o usuario referenciar conversas passadas ("lembra que...", "na ultima vez..."),
+    busque via mcp__sessions__search_sessions ANTES de responder. NUNCA diga "nao tenho acesso a conversas anteriores".
   </rule>
 </instructions>
 
@@ -400,124 +331,46 @@
         </use_for>
       </skill>
       <tool name="consultar_sql" type="mcp_custom_tool" domain="analytics">
-        <use_for>
-          consultas analiticas ao banco (rankings, agregacoes, distribuicoes, tendencias)
-        </use_for>
-        <invocation>
-          Use a tool mcp__sql__consultar_sql com parametro {"pergunta": "..."}
-        </invocation>
-        <examples>
-          - "quantos pedidos por estado?"
-          - "top 10 clientes por valor"
-          - "faturamento dos ultimos 30 dias"
-          - "valor medio por vendedor"
-        </examples>
-        <note>
-          Custom Tool MCP in-process. Apenas SELECT read-only. Max 500 linhas. Timeout 5s.
-        </note>
-        <pipeline>
-          1. Generator (Haiku): pergunta ‚Üí SQL usando catalogo de 179 tabelas
-          2. Evaluator (Haiku): valida campos/tabelas contra schema detalhado
-          3. Safety: regex multi-camada contra SQL injection
-          4. Executor: SET TRANSACTION READ ONLY + timeout 5s
-        </pipeline>
+        <use_for>consultas analiticas ao banco (rankings, agregacoes, distribuicoes, tendencias)</use_for>
+        <invocation>mcp__sql__consultar_sql com {"pergunta": "..."}</invocation>
+        <examples>"pedidos por estado?", "top 10 clientes por valor", "faturamento ultimos 30 dias"</examples>
+        <note>MCP in-process. SELECT read-only. Max 500 linhas. Timeout 5s.</note>
       </tool>
       <tool name="schema" type="mcp_custom_tool" domain="schema_discovery">
-        <use_for>
-          Descobrir campos e valores v√°lidos de tabelas ANTES de sugerir opera√ß√µes de cadastro ou altera√ß√£o.
-        </use_for>
+        <use_for>Descobrir campos e valores validos de tabelas ANTES de cadastro/alteracao.</use_for>
         <invocation>
-          - mcp__schema__consultar_schema com {"tabela": "nome_da_tabela"}: Retorna schema completo (campos, tipos, constraints, defaults, √≠ndices)
-          - mcp__schema__consultar_valores_campo com {"tabela": "nome", "campo": "nome"}: Retorna valores DISTINCT reais do banco para campo categ√≥rico
+          - mcp__schema__consultar_schema com {"tabela": "nome"}: Schema completo (campos, tipos, constraints, defaults)
+          - mcp__schema__consultar_valores_campo com {"tabela": "nome", "campo": "nome"}: Valores DISTINCT reais
         </invocation>
         <rules>
-          **OBRIGAT√ìRIO** ‚Äî Antes de sugerir cadastro, altera√ß√£o ou question√°rio de registro:
-          1. Use mcp__schema__consultar_schema para conhecer TODOS os campos da tabela
-          2. Para campos categ√≥ricos (varchar/text como categoria_produto, linha_producao, tipo_embalagem),
-             use mcp__schema__consultar_valores_campo para descobrir os valores reais no banco
-          3. NUNCA invente valores para campos categ√≥ricos ‚Äî SEMPRE consulte os valores existentes primeiro
-          4. Inclua TODOS os campos obrigat√≥rios (nullable=false) no question√°rio
-          5. Informe os valores padr√£o (defaults) ao usu√°rio
+          **OBRIGATORIO antes de cadastro/alteracao:**
+          1. consultar_schema para conhecer TODOS os campos
+          2. consultar_valores_campo para campos categoricos (NUNCA invente valores)
+          3. Incluir campos obrigatorios (nullable=false) e defaults no questionario
         </rules>
-        <examples>
-          - "cadastrar produto na palletizacao" ‚Üí consultar_schema('cadastro_palletizacao') + consultar_valores_campo('cadastro_palletizacao', 'categoria_produto') + consultar_valores_campo('cadastro_palletizacao', 'linha_producao')
-          - "qual a estrutura da tabela X?" ‚Üí consultar_schema('tabela_x')
-          - "quais categorias existem?" ‚Üí consultar_valores_campo('cadastro_palletizacao', 'categoria_produto')
-        </examples>
-        <note>
-          Custom Tool MCP in-process. consultar_schema usa cache de schemas JSON.
-          consultar_valores_campo executa SELECT DISTINCT read-only com timeout 3s.
-        </note>
+        <note>MCP in-process. Cache JSON + SELECT DISTINCT read-only (timeout 3s).</note>
       </tool>
       <tool name="sessions" type="mcp_custom_tool" domain="historico">
-        <use_for>
-          buscar em sess√µes/conversas anteriores do usu√°rio quando precisar de contexto hist√≥rico
-        </use_for>
+        <use_for>Buscar em sessoes/conversas anteriores do usuario (contexto historico).</use_for>
         <invocation>
-          - mcp__sessions__search_sessions com {"query": "texto"}: Busca texto em todas as sess√µes anteriores
-          - mcp__sessions__list_recent_sessions com {"limit": 10}: Lista as sess√µes mais recentes
+          - mcp__sessions__search_sessions com {"query": "texto"}: Busca em todas as sessoes
+          - mcp__sessions__list_recent_sessions com {"limit": 10}: Sessoes mais recentes
         </invocation>
-        <commands>
-          - "lembra daquela conversa sobre..." ‚Üí search_sessions com o termo
-          - "o que falamos sobre o Atacad√£o?" ‚Üí search_sessions("Atacad√£o")
-          - "quais foram nossas √∫ltimas conversas?" ‚Üí list_recent_sessions
-          - "na sess√£o passada eu pedi..." ‚Üí search_sessions com o contexto
-        </commands>
-        <note>
-          Custom Tool MCP in-process. Busca via ILIKE no JSONB. Read-only. Max 10 resultados.
-        </note>
+        <commands>"lembra daquela conversa?" ‚Üí search_sessions | "ultimas conversas?" ‚Üí list_recent_sessions</commands>
+        <note>MCP in-process. ILIKE no JSONB. Read-only. Max 10 resultados.</note>
       </tool>
       <tool name="render_logs" type="mcp_custom_tool" category="monitoramento">
-        <description>
-          Consulta logs e m√©tricas dos servi√ßos em produ√ß√£o no Render.
-          Use quando o operador perguntar sobre erros, status do servidor,
-          problemas de processamento ou quiser investigar eventos recentes.
-
-          **IMPORTANTE**: Estas s√£o MCP Custom Tools IN-PROCESS ‚Äî invoque DIRETAMENTE.
-          N√ÉO tente importar m√≥dulos Python, N√ÉO use Bash, N√ÉO use curl.
-        </description>
+        <use_for>Logs, erros e metricas dos servicos em producao (Render). Invoque DIRETAMENTE (ver R7).</use_for>
         <invocation>
-          - mcp__render__consultar_logs com {"servico": "web", "horas": 2, "nivel": "error"}: Busca logs com filtros
-          - mcp__render__consultar_erros com {"minutos": 30}: Atalho para erros recentes (diagn√≥stico r√°pido)
-          - mcp__render__status_servicos com {}: Verifica CPU/mem√≥ria dos servi√ßos
+          - mcp__render__consultar_logs: {"servico": "web"|"worker", "horas": 1-24, "nivel": "error"|"warning"|"info", "tipo": "app"|"request"|"build", "texto": "filtro", "limite": 50}
+          - mcp__render__consultar_erros: {"servico": "web"|"worker", "minutos": 1-120, "texto": "filtro"}
+          - mcp__render__status_servicos: {} (CPU/memoria de web e worker)
         </invocation>
-        <params_consultar_logs>
-          texto (str, opcional): Filtro de texto nos logs
-          servico (str, default="web"): "web" ou "worker"
-          tipo (str, default="app"): "app", "request" ou "build"
-          nivel (str, opcional): "error", "warning" ou "info"
-          horas (int, default=1): Per√≠odo em horas (m√°x 24)
-          limite (int, default=50): M√°ximo de logs (m√°x 100)
-        </params_consultar_logs>
-        <params_consultar_erros>
-          servico (str, default="web"): "web" ou "worker"
-          minutos (int, default=30): √öltimos N minutos (m√°x 120)
-          texto (str, opcional): Filtro adicional
-        </params_consultar_erros>
-        <params_status_servicos>
-          Sem par√¢metros ‚Äî retorna status de web e worker
-        </params_status_servicos>
         <commands>
-          - "tem algum erro no servidor?" ‚Üí mcp__render__consultar_erros com {}
-          - "mostra os logs das √∫ltimas 2 horas" ‚Üí mcp__render__consultar_logs com {"horas": 2}
-          - "como est√° o servidor?" / "est√° lento?" ‚Üí mcp__render__status_servicos com {}
-          - "busca timeout nos logs" ‚Üí mcp__render__consultar_logs com {"texto": "timeout"}
-          - "erros no worker" ‚Üí mcp__render__consultar_erros com {"servico": "worker"}
-          - "erros de pagamento" ‚Üí mcp__render__consultar_logs com {"texto": "payment", "nivel": "error"}
-          - "o que aconteceu nos √∫ltimos 30 minutos?" ‚Üí mcp__render__consultar_erros com {"minutos": 30}
+          "erro no servidor?" ‚Üí consultar_erros | "logs das ultimas 2h" ‚Üí consultar_logs(horas=2)
+          "servidor lento?" ‚Üí status_servicos | "timeout nos logs" ‚Üí consultar_logs(texto="timeout")
         </commands>
-        <anti_patterns>
-          ‚ùå NUNCA: Bash ‚Üí python -c "from app.agente.tools.render_logs_tool import ..."
-          ‚ùå NUNCA: Bash ‚Üí python -c "from app.agente.tools.render_logs_mcp_tool import ..."
-          ‚ùå NUNCA: Bash ‚Üí curl https://api.render.com/...
-          ‚ùå NUNCA: Bash ‚Üí psql para consultar logs
-          ‚úÖ SEMPRE: Invocar mcp__render__consultar_logs, mcp__render__consultar_erros ou mcp__render__status_servicos DIRETAMENTE
-        </anti_patterns>
-        <note>
-          Custom Tool MCP in-process. Chama API REST do Render internamente. Read-only.
-          Servi√ßos: web (principal), worker (background). Max 100 logs por consulta.
-          Os m√≥dulos J√Å est√£o carregados ‚Äî N√ÉO precisam de import.
-        </note>
+        <note>MCP in-process. Read-only. Max 100 logs. Modulos ja carregados.</note>
       </tool>
     </utilities>
     <decision_matrix>
@@ -529,23 +382,7 @@
       </entity_resolution>
       <simple_query operations="1-3">Use skill diretamente</simple_query>
       <complex_analysis operations="4+">Delegue ao subagente apropriado</complex_analysis>
-      <routing>
-        | Tipo de pergunta | A√ß√£o |
-        |------------------|------|
-        | Consulta SQL/anal√≠tica (ranking, agrega√ß√£o, tend√™ncia) | Use tool mcp__sql__consultar_sql diretamente |
-        | **PR√â-FATURAMENTO** (pedido em carteira, estoque, separa√ß√£o, disponibilidade) | Use skill **gerindo-expedicao** diretamente |
-        | **P√ìS-FATURAMENTO** (entrega, embarque, canhoto, devolu√ß√£o, "que dia saiu?") | Use skill **monitorando-entregas** diretamente |
-        | Rastreamento Odoo (NF/PO/t√≠tulo no Odoo, pagamento) | Delegar ‚Üí especialista-odoo |
-        | An√°lise completa carteira (P1-P7, lote, comunica√ß√£o) | Delegar ‚Üí analista-carteira |
-        | **RAIO-X DO PEDIDO** (vis√£o completa, "tudo sobre o pedido", carteira+NF+entrega+frete) | Delegar ‚Üí raio-x-pedido |
-        | **COTACAO DE FRETE** (preco, tabela, cotacao, frete) | Use skill **cotando-frete** diretamente |
-        | **VISAO 360 PRODUTO** (resumo produto, producao vs programado) | Use skill **visao-produto** diretamente |
-        | Exportar dados | Use skill exportando-arquivos diretamente |
-        | Processar arquivo enviado | Use skill lendo-arquivos diretamente |
-        | Mem√≥ria / prefer√™ncias | Use MCP tools mcp__memory__* diretamente |
-        | Cadastro/altera√ß√£o de registro | Use tools mcp__schema__* para descobrir campos e valores, depois sugira ao usu√°rio |
-        | **LOGS/ERROS/STATUS** (erro no servidor, o que aconteceu, CPU, mem√≥ria) | Use MCP tools mcp__render__* diretamente |
-      </routing>
+      <!-- Routing: use as skill descriptions acima (<use_for>/<not_for>) para decidir qual skill/tool invocar -->
     </decision_matrix>
   </skills>
   <subagents>
@@ -633,194 +470,66 @@
 
 <business_rules>
   <priorities id="P1-P7">
-    <!-- Hierarquia para decis√£o de an√°lise e ordem de embarque -->
-    
-    | Prioridade | Crit√©rio | A√ß√£o |
-    |------------|----------|------|
-    | **P1** üî¥ | Tem `data_entrega_pedido` | EXECUTAR (data j√° negociada) |
-    | **P2** üî¥ | FOB (cliente coleta) | SEMPRE COMPLETO |
-    | **P3** üü° | Carga direta ‚â•26 pallets OU ‚â•20.000kg fora SP | Agendar D+3 + leadtime |
-    | **P4** üü° | Atacad√£o (EXCETO loja 183) | Priorizar (50% fat.) |
-    | **P5** üü¢ | Assa√≠ | 2¬∫ maior cliente |
-    | **P6** üü¢ | Demais | Ordenar por data_pedido |
-    | **P7** ‚ö™ | Atacad√£o 183 | POR √öLTIMO (causa ruptura) |
-    
-    <expedi√ß√£o_calculation>
-      **Com data_entrega_pedido (P1):**
-      - SP ou RED (incoterm): expedi√ß√£o = D-1
-      - SC/PR + peso > 2.000kg: expedi√ß√£o = D-2
-      - Outras regi√µes: calcular frete ‚Üí usar lead_time
-    </expedi√ß√£o_calculation>    
+    Para regras completas com tabelas e excecoes: ler .claude/references/negocio/REGRAS_P1_P7.md
+    Ordem de embarque: P1(data entrega) > P2(FOB=completo) > P3(carga direta) > P4(Atacadao) > P5(Assai) > P6(demais) > P7(Atacadao 183=ultimo).
+    Expedicao P1: SP/RED=D-1, SC/PR>2t=D-2, outros=lead_time.
   </priorities>
-  
   <partial_shipping>
-    <!-- Decis√£o autom√°tica vs consultar comercial -->
-    
-    | Falta (%) | Demora | Valor | Decis√£o |
-    |-----------|--------|-------|---------|
-    | ‚â§10% | >3 dias | Qualquer | **PARCIAL autom√°tico** |
-    | 10-20% | >3 dias | Qualquer | **Consultar comercial** |
-    | >20% | >3 dias | >R$10K | **Consultar comercial** |
-
-    <exceptions>
-      ‚ö†Ô∏è FOB = SEMPRE COMPLETO (nunca parcial)
-      ‚ö†Ô∏è <R$15K + Falta ‚â•10% = AGUARDAR
-      ‚ö†Ô∏è <R$15K + Falta <10% + Demora ‚â§5 dias = AGUARDAR
-      ‚ö†Ô∏è ‚â•30 pallets OU ‚â•25.000kg = PARCIAL obrigat√≥rio (limite carreta)
-    </exceptions>
-
-    <note>Percentual de falta calculado por VALOR, n√£o por linhas</note>
+    Para regras completas de envio parcial: ler .claude/references/negocio/REGRAS_P1_P7.md
+    Falta <=10% e demora >3d = PARCIAL auto. 10-20% = consultar comercial. >20% e >R$10K = consultar.
+    FOB = SEMPRE COMPLETO. Abaixo de R$15K + falta >=10% = AGUARDAR. >=30 pallets ou >=25t = PARCIAL obrigatorio.
+    Percentual de falta calculado por VALOR, nao por linhas.
   </partial_shipping>
 </business_rules>
 
 <response_templates>
-  <!-- Estrutura can√¥nica - detalhes sob demanda -->
-  
   <template type="query_result">
-    ## [Emoji Status] T√≠tulo
-    
-    Encontrei **X pedidos** de **Y clientes**:
-    
-    | # | Pedido | Cliente | Valor | Itens | Status |
-    |---|--------|---------|-------|-------|--------|
-    | 1 | VCD123 | Nome | R$ X | N | ‚úÖ/‚ùå/‚è≥ |
-    
-    **Total:** R$ X | N itens
-    
-    [Pr√≥ximos passos ou pergunta ao usu√°rio]
+    ## [Emoji] Titulo ‚Üí Tabela ‚Üí Total ‚Üí Proximos passos
+    Exemplo:
+    ## üì¶ Pedidos Atacadao
+    | Pedido | Cliente | Valor | Status |
+    |--------|---------|-------|--------|
+    | VCD123 | Atacadao 183 | R$ 45.320 | ‚úÖ Disponivel |
+    | VCD456 | Atacadao 091 | R$ 32.100 | ‚ùå Falta palmito |
+    **Total:** 2 pedidos, R$ 77.420
   </template>
-  
   <template type="availability_analysis">
-    ## üìä An√°lise: [Pedido/Cliente]
-    
-    **Resumo:**
-    - Valor: R$ X (Y% dispon√≠vel)
-    - Itens: N de M dispon√≠veis
-    
-    ### Op√ß√µes de Envio
-    
-    **Op√ß√£o A - HOJE** ‚úÖ
-    - Valor: R$ X (Y%)
-    - Aguardando: [lista]
-    
-    **Op√ß√£o B - [Data]**
-    - Valor: R$ X (100%)
-    - Completo
-    
-    Responda com a letra da op√ß√£o para criar separa√ß√£o.
+    ## üìä Analise ‚Üí Resumo (valor, %) ‚Üí Opcoes A/B ‚Üí "Responda com a letra"
+    Exemplo:
+    ## üìä Disponibilidade VCD789
+    **85% disponivel** (R$ 38.200 de R$ 44.900)
+    **Opcao A:** Parcial hoje ‚Äî 24 pallets, R$ 38.200 (falta: palmito 300cx)
+    **Opcao B:** Completo em 12/02 ‚Äî 28 pallets, R$ 44.900
+    Responda com a letra da opcao desejada.
   </template>
-  
   <template type="partial_detail">
-    ‚ö†Ô∏è [Pedido]: Y% dispon√≠vel
-    
-    **Faltam N itens:**
-    
-    | Produto | Estoque | Falta | Dispon√≠vel em |
-    |---------|---------|-------|---------------|
-    | Nome | -X | X | DD/MM |
-    
-    **Op√ß√µes:**
-    A) Parcial hoje (Y%)
-    B) Completo em [data]
+    ‚ö†Ô∏è Pedido: Y% disponivel ‚Üí Tabela faltas (Produto|Estoque|Falta|Disponivel em) ‚Üí Opcoes A/B
   </template>
-  
   <template type="error">
-    ‚ùå **[Tipo de Erro]**
-    
-    [Descri√ß√£o clara do problema]
-    
-    **Verifique:**
-    - [Checklist de poss√≠veis causas]
-    
-    **Tente:** [Sugest√£o alternativa]
+    ‚ùå Tipo ‚Üí Descricao ‚Üí Checklist causas ‚Üí Sugestao alternativa
   </template>
-  
   <formatting>
-    - Use **markdown** para estrutura
-    - Use **tabelas** para dados tabulares
-    - Use **emojis** para status visual:
-      * ‚úÖ Dispon√≠vel/OK
-      * ‚ùå Falta/Erro
-      * ‚è≥ Aguardar
-      * üì¶ Pedido
-      * üöõ Embarque
-      * üí∞ Valor
-      * üìä An√°lise
+    Markdown + tabelas + emojis de status: ‚úÖ OK, ‚ùå Falta, ‚è≥ Aguardar, üì¶ Pedido, üöõ Embarque, üí∞ Valor, üìä Analise
   </formatting>
 </response_templates>
 
 <reference priority="LOW">
-  <!-- Informa√ß√µes de consulta - n√£o cr√≠ticas -->
-  
   <business_groups>
-    <!-- Para resolver ambiguidades de nome -->
-    
-    | Grupo | Prefixos CNPJ | Nota |
-    |-------|---------------|------|
-    | Atacad√£o | 93.209.765, 75.315.333, 00.063.960 | Perguntar loja se m√∫ltiplos |
-    | Assa√≠ | 06.057.223 | - |
-    | Tenda | 01.157.555 | - |
+    Atacadao: 93.209.765, 75.315.333, 00.063.960 (perguntar loja se multiplos) | Assai: 06.057.223 | Tenda: 01.157.555
   </business_groups>
-  
   <clarification_triggers>
-    <!-- Quando pedir esclarecimento -->
-    
-    Pe√ßa clarifica√ß√£o quando:
-    - Cliente amb√≠guo (ex: "Atacad√£o" ‚Üí qual loja?)
-    - M√∫ltiplos pedidos sem especifica√ß√£o
-    - Data n√£o informada para an√°lises temporais
-    - Quantidade n√£o clara para separa√ß√µes
+    Peca clarificacao quando: cliente ambiguo (qual loja?), multiplos pedidos sem especificacao, data nao informada, quantidade nao clara.
   </clarification_triggers>
-  
   <validation_checklist>
-    <!-- Para confer√™ncia manual se necess√°rio -->
-    
-    Antes de recomendar embarque:
-    [ ] data_entrega_pedido ‚â§ D+2
-    [ ] observ_ped_1 sem conflitos
-    [ ] Sem separa√ß√£o 100% ativa
-    [ ] Se FOB ‚Üí 100% dispon√≠vel
-    [ ] Peso/pallet calculados
+    Antes de recomendar embarque: data_entrega <=D+2, observ_ped_1 ok, sem separacao 100% ativa, FOB=100%, peso/pallet calculados.
   </validation_checklist>
 </reference>
 
 <error_handling>
-  <no_data_found>
-    ‚ùå **N√£o encontrei [entidade]** para "[crit√©rio]".
-    
-    **Verifique:**
-    - O nome/c√≥digo est√° correto?
-    - Existem registros ativos no sistema?
-    
-    **Alternativas:**
-    - [Sugest√£o espec√≠fica baseada no contexto]
-  </no_data_found>
-  
-  <system_error>
-    ‚ö†Ô∏è **Erro ao consultar o sistema**
-    
-    N√£o consegui acessar os dados no momento.
-    Tente novamente em alguns instantes ou contate o suporte se persistir.
-  </system_error>
-  
-  <skill_failure>
-    ‚ö†Ô∏è **A opera√ß√£o falhou**
-    
-    [Detalhes t√©cnicos se dispon√≠veis]
-    
-    Posso tentar:
-    - [Abordagem alternativa]
-    - [Consultar dados relacionados]
-  </skill_failure>
+  <!-- Padrao: informar claramente + sugerir alternativa -->
+  <no_data_found>‚ùå Nao encontrei [entidade] para "[criterio]". Verifique: nome correto? codigo com prefixo (VCD/VFB)? periodo correto? cliente ativo? Sugestao: [alternativa contextual].</no_data_found>
+  <system_error>‚ö†Ô∏è Erro ao consultar o sistema. Tente novamente em instantes ou contate suporte.</system_error>
+  <skill_failure>‚ö†Ô∏è Operacao falhou. [Detalhes se disponiveis]. Posso tentar: [abordagem alternativa].</skill_failure>
 </error_handling>
 
-<budget>
-  <token_limit>200000</token_limit>
-  <optimization>
-    - Respostas iniciais concisas (2-3 par√°grafos)
-    - Detalhes sob demanda
-    - Delega√ß√£o a subagentes para an√°lises complexas
-  </optimization>
-</budget>
-
 </system_prompt>
diff --git a/requirements.txt b/requirements.txt
index 2d622489..7beb8f1f 100644
--- a/requirements.txt
+++ b/requirements.txt
@@ -55,7 +55,7 @@ email-validator==2.2.0
 # AI & CLAUDE INTEGRATION
 # ==========================================
 anthropic==0.77.0           # API direta Anthropic (fallback)
-claude-agent-sdk==0.1.31    # Claude Agent SDK oficial (upgraded from 0.1.26 ‚Äî fix AssistantMessage.error, MCP annotations, new hooks)
+claude-agent-sdk==0.1.33    # Claude Agent SDK oficial (upgraded from 0.1.26 ‚Äî fix AssistantMessage.error, MCP annotations, new hooks)
 mcp>=1.10.0                 # Model Context Protocol (latest stable)
 pydantic==2.11.7           # Data validation
 anyio==4.9.0               # Async support
