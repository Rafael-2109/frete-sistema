#!/usr/bin/env python3

"""
Script de Manuten√ß√£o Completo do Sistema de Pedidos

Este script realiza 3 opera√ß√µes principais:
1. Cria cota√ß√µes para pedidos FOB que n√£o possuem cotacao_id
2. Atualiza status de todos os pedidos, 3. Verifica NFs que deveriam estar nos pedidos mas n√£o est√£o.

Executar: python script_manutencao_pedidos_completo.py
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app import create_app, db
from app.pedidos.models import Pedido
from app.embarques.models import Embarque, EmbarqueItem
from app.cotacao.models import Cotacao
from app.transportadoras.models import Transportadora
from datetime import datetime

def criar_cotacoes_fob():
    """
    1. Cria cota√ß√µes para pedidos FOB que n√£o possuem cotacao_id
    """
    print("\n" + "="*60)
    print("1Ô∏è‚É£ CRIANDO COTA√á√ïES PARA PEDIDOS FOB")
    print("="*60)
    
    # Buscar pedidos FOB sem cotacao_id
    pedidos_fob_sem_cotacao = Pedido.query.filter(
        Pedido.transportadora == "FOB - COLETA",
        Pedido.cotacao_id.is_(None)
    ).all()
    
    print(f"üìä Encontrados {len(pedidos_fob_sem_cotacao)} pedidos FOB sem cota√ß√£o")
    
    if not pedidos_fob_sem_cotacao:
        print("‚úÖ Todos os pedidos FOB j√° possuem cota√ß√£o!")
        return 0
    
    # Buscar ou criar transportadora FOB
    transportadora_fob = Transportadora.query.filter_by(razao_social="FOB - COLETA").first()
    
    if not transportadora_fob:
        print("‚ùå Transportadora 'FOB - COLETA' n√£o encontrada! Criando...")
        transportadora_fob = Transportadora(
            razao_social="FOB - COLETA",
            cnpj="00000000000000",
            cidade="FOB",
            uf="SP",
            optante=False,
            condicao_pgto="FOB"
        )
        db.session.add(transportadora_fob)
        db.session.flush()
        print(f"‚úÖ Transportadora FOB criada com ID: {transportadora_fob.id}")
    
    # Verificar se j√° existe uma cota√ß√£o FOB global
    cotacao_fob_global = Cotacao.query.filter_by(
        transportadora_id=transportadora_fob.id,
        tipo_carga='FOB',
        nome_tabela='FOB - COLETA'
    ).first()
    
    if not cotacao_fob_global:
        print("üîß Criando cota√ß√£o FOB global...")
        cotacao_fob_global = Cotacao(
            usuario_id=1,  # Sistema
            transportadora_id=transportadora_fob.id,
            status='Fechado',
            data_criacao=datetime.now(),
            data_fechamento=datetime.now(),
            tipo_carga='FOB',
            valor_total=0,
            peso_total=0,
            modalidade='FOB',
            nome_tabela='FOB - COLETA',
            frete_minimo_valor=0,
            valor_kg=0,
            percentual_valor=0,
            frete_minimo_peso=0,
            icms=0,
            percentual_gris=0,
            pedagio_por_100kg=0,
            valor_tas=0,
            percentual_adv=0,
            percentual_rca=0,
            valor_despacho=0,
            valor_cte=0,
            icms_incluso=False,
            icms_destino=0
        )
        db.session.add(cotacao_fob_global)
        db.session.flush()
        print(f"‚úÖ Cota√ß√£o FOB global criada com ID: {cotacao_fob_global.id}")
    else:
        print(f"‚úÖ Cota√ß√£o FOB global j√° existe com ID: {cotacao_fob_global.id}")
    
    # Atualizar todos os pedidos FOB sem cotacao_id
    pedidos_atualizados = 0
    for pedido in pedidos_fob_sem_cotacao:
        pedido.cotacao_id = cotacao_fob_global.id
        if not pedido.transportadora:
            pedido.transportadora = "FOB - COLETA"
        pedidos_atualizados += 1
        print(f"   ‚úÖ Pedido {pedido.num_pedido}: cotacao_id definido como {cotacao_fob_global.id}")
    
    db.session.commit()
    print(f"\nüéâ RESULTADO: {pedidos_atualizados} pedidos FOB atualizados com cota√ß√£o!")
    return pedidos_atualizados

def atualizar_status_todos_pedidos():
    """
    2. Atualiza o status de todos os pedidos baseado na l√≥gica status_calculado
    """
    print("\n" + "="*60)
    print("2Ô∏è‚É£ ATUALIZANDO STATUS DE TODOS OS PEDIDOS")
    print("="*60)
    
    pedidos = Pedido.query.all()
    print(f"üìä Processando {len(pedidos)} pedidos...")
    
    atualizados = 0
    status_count = {}
    
    for pedido in pedidos:
        status_atual = pedido.status
        status_correto = pedido.status_calculado
        
        # Contabiliza estat√≠sticas
        status_count[status_correto] = status_count.get(status_correto, 0) + 1
        
        if status_atual != status_correto:
            print(f"   üîÑ Pedido {pedido.num_pedido}: '{status_atual}' ‚Üí '{status_correto}'")
            pedido.status = status_correto
            atualizados += 1
    
    if atualizados > 0:
        db.session.commit()
        print(f"\nüéâ RESULTADO: {atualizados} status de pedidos atualizados!")
    else:
        print(f"\n‚úÖ RESULTADO: Todos os status j√° estavam corretos!")
    
    print("\nüìà ESTAT√çSTICAS DE STATUS:")
    for status, count in status_count.items():
        print(f"   ‚Ä¢ {status}: {count} pedidos")
    
    return atualizados

def verificar_nfs_nao_sincronizadas():
    """
    3. Verifica NFs que deveriam estar preenchidas nos pedidos mas n√£o est√£o
    """
    print("\n" + "="*60)
    print("3Ô∏è‚É£ VERIFICANDO NFs N√ÉO SINCRONIZADAS")
    print("="*60)
    
    # Buscar itens de embarque ativos com NF preenchida
    itens_com_nf = EmbarqueItem.query.join(Embarque).filter(
        EmbarqueItem.nota_fiscal.isnot(None),
        EmbarqueItem.nota_fiscal != '',
        EmbarqueItem.status == 'ativo',
        Embarque.status == 'ativo'
    ).all()
    
    print(f"üìä Encontrados {len(itens_com_nf)} itens de embarque com NF preenchida")
    
    nfs_corrigidas = 0
    problemas_encontrados = []
    
    for item in itens_com_nf:
        pedido = None
        
        # Buscar pedido correspondente
        if item.separacao_lote_id:
            pedido = Pedido.query.filter_by(separacao_lote_id=item.separacao_lote_id).first()
        
        if not pedido and item.pedido:
            pedido = Pedido.query.filter_by(num_pedido=item.pedido).first()
        
        if not pedido:
            problemas_encontrados.append(f"Pedido {item.pedido} (lote: {item.separacao_lote_id}) n√£o encontrado")
            continue
        
        # Verificar se a NF do pedido est√° sincronizada
        if not pedido.nf or pedido.nf != item.nota_fiscal:
            nf_anterior = pedido.nf
            pedido.nf = item.nota_fiscal
            nfs_corrigidas += 1
            
            print(f"   üîß Pedido {pedido.num_pedido}: NF corrigida '{nf_anterior or 'None'}' ‚Üí '{item.nota_fiscal}'")
            
            # Para pedidos FOB, garantir que tenham cotacao_id
            if pedido.transportadora == "FOB - COLETA" and not pedido.cotacao_id:
                transportadora_fob = Transportadora.query.filter_by(razao_social="FOB - COLETA").first()
                if transportadora_fob:
                    cotacao_fob = Cotacao.query.filter_by(
                        transportadora_id=transportadora_fob.id,
                        tipo_carga='FOB'
                    ).first()
                    if cotacao_fob:
                        pedido.cotacao_id = cotacao_fob.id
                        print(f"      üìã Cota√ß√£o FOB tamb√©m corrigida: {cotacao_fob.id}")
    
    if nfs_corrigidas > 0:
        db.session.commit()
        print(f"\nüéâ RESULTADO: {nfs_corrigidas} NFs sincronizadas com os pedidos!")
    else:
        print(f"\n‚úÖ RESULTADO: Todas as NFs j√° estavam sincronizadas!")
    
    if problemas_encontrados:
        print(f"\n‚ö†Ô∏è PROBLEMAS ENCONTRADOS ({len(problemas_encontrados)}):")
        for problema in problemas_encontrados[:5]:  # Mostra apenas os 5 primeiros
            print(f"   ‚Ä¢ {problema}")
        if len(problemas_encontrados) > 5:
            print(f"   ‚Ä¢ ... e mais {len(problemas_encontrados) - 5} problemas")
    
    return nfs_corrigidas, len(problemas_encontrados)

def verificar_status_apos_correcoes():
    """
    Verifica√ß√£o final: mostra estat√≠sticas dos pedidos ap√≥s todas as corre√ß√µes
    """
    print("\n" + "="*60)
    print("üìä VERIFICA√á√ÉO FINAL - ESTAT√çSTICAS ATUALIZADAS")
    print("="*60)
    
    # Estat√≠sticas gerais
    total_pedidos = Pedido.query.count()
    pedidos_fob = Pedido.query.filter_by(transportadora="FOB - COLETA").count()
    pedidos_com_nf = Pedido.query.filter(Pedido.nf.isnot(None), Pedido.nf != '').count()
    pedidos_com_cotacao = Pedido.query.filter(Pedido.cotacao_id.isnot(None)).count()
    
    print(f"üìà ESTAT√çSTICAS GERAIS:")
    print(f"   ‚Ä¢ Total de pedidos: {total_pedidos}")
    print(f"   ‚Ä¢ Pedidos FOB: {pedidos_fob}")
    print(f"   ‚Ä¢ Pedidos com NF: {pedidos_com_nf}")
    print(f"   ‚Ä¢ Pedidos com cota√ß√£o: {pedidos_com_cotacao}")
    print(f"   ‚Ä¢ Cobertura de cota√ß√µes: {(pedidos_com_cotacao/total_pedidos*100):.1f}%")
    
    # Status dos pedidos
    status_query = db.session.query(
        Pedido.status, 
        db.func.count(Pedido.id)
    ).group_by(Pedido.status).all()
    
    print(f"\nüìä DISTRIBUI√á√ÉO POR STATUS:")
    for status, count in status_query:
        print(f"   ‚Ä¢ {status}: {count} pedidos")
    
    # Pedidos FOB espec√≠ficos
    if pedidos_fob > 0:
        pedidos_fob_sem_cotacao = Pedido.query.filter(
            Pedido.transportadora == "FOB - COLETA",
            Pedido.cotacao_id.is_(None)
        ).count()
        
        print(f"\nüöõ PEDIDOS FOB:")
        print(f"   ‚Ä¢ Total FOB: {pedidos_fob}")
        print(f"   ‚Ä¢ FOB sem cota√ß√£o: {pedidos_fob_sem_cotacao}")
        print(f"   ‚Ä¢ FOB com cota√ß√£o: {pedidos_fob - pedidos_fob_sem_cotacao}")

def main():
    """Fun√ß√£o principal que executa todas as opera√ß√µes de manuten√ß√£o"""
    
    print("üîß SCRIPT DE MANUTEN√á√ÉO COMPLETO DO SISTEMA DE PEDIDOS")
    print("=" * 70)
    print("Este script ir√°:")
    print("1Ô∏è‚É£ Criar cota√ß√µes para pedidos FOB sem cotacao_id")
    print("2Ô∏è‚É£ Atualizar status de todos os pedidos")
    print("3Ô∏è‚É£ Sincronizar NFs que faltam nos pedidos")
    print("=" * 70)
    
    app = create_app()
    
    with app.app_context():
        try:
            # Opera√ß√£o 1: Criar cota√ß√µes FOB
            fob_atualizados = criar_cotacoes_fob()
            
            # Opera√ß√£o 2: Atualizar status
            status_atualizados = atualizar_status_todos_pedidos()
            
            # Opera√ß√£o 3: Verificar NFs
            nfs_corrigidas, problemas = verificar_nfs_nao_sincronizadas()
            
            # Verifica√ß√£o final
            verificar_status_apos_correcoes()
            
            # Resumo final
            print("\n" + "="*60)
            print("üéâ RESUMO FINAL DA MANUTEN√á√ÉO")
            print("="*60)
            print(f"‚úÖ Pedidos FOB com cota√ß√£o criada: {fob_atualizados}")
            print(f"‚úÖ Status de pedidos atualizados: {status_atualizados}")
            print(f"‚úÖ NFs sincronizadas: {nfs_corrigidas}")
            if problemas > 0:
                print(f"‚ö†Ô∏è Problemas que precisam aten√ß√£o: {problemas}")
            print("\nüöÄ Manuten√ß√£o conclu√≠da com sucesso!")
            
        except Exception as e:
            print(f"\n‚ùå ERRO durante a manuten√ß√£o: {str(e)}")
            db.session.rollback()
            raise

if __name__ == "__main__":
    main() 