{
  "name": "fretes",
  "description": "Fretes contratados para embarques. 4 tipos de valor: valor_cotado (calculado pela tabela de frete), valor_cte (cobrado pela transportadora no CTe), valor_considerado (validado internamente), valor_pago (efetivamente pago). Para custo real use valor_pago. Divergencia: ABS(valor_cte - valor_cotado). numeros_nfs e campo CSV com NFs do frete. tipo_carga: DIRETA ou FRACIONADA. Pendentes Odoo: status=APROVADO AND lancado_odoo_em IS NULL.",
  "fields": [
    {
      "name": "id",
      "type": "integer",
      "description": "Primary key"
    },
    {
      "name": "embarque_id",
      "type": "integer",
      "description": "FK → embarques.id",
      "nullable": false
    },
    {
      "name": "cnpj_cliente",
      "type": "varchar(20)",
      "nullable": false
    },
    {
      "name": "nome_cliente",
      "type": "varchar(255)",
      "nullable": false
    },
    {
      "name": "transportadora_id",
      "type": "integer",
      "description": "FK → transportadoras.id",
      "nullable": false
    },
    {
      "name": "tipo_carga",
      "type": "varchar(20)",
      "description": "'FRACIONADA' ou 'DIRETA'",
      "nullable": false
    },
    {
      "name": "modalidade",
      "type": "varchar(50)",
      "description": "VALOR, PESO, VAN, etc.",
      "nullable": false
    },
    {
      "name": "uf_destino",
      "type": "varchar(2)",
      "nullable": false
    },
    {
      "name": "cidade_destino",
      "type": "varchar(100)",
      "nullable": false
    },
    {
      "name": "peso_total",
      "type": "float",
      "nullable": false
    },
    {
      "name": "valor_total_nfs",
      "type": "float",
      "nullable": false
    },
    {
      "name": "quantidade_nfs",
      "type": "integer",
      "nullable": false
    },
    {
      "name": "numeros_nfs",
      "type": "text",
      "description": "Lista das NFs separadas por vírgula",
      "nullable": false
    },
    {
      "name": "tabela_nome_tabela",
      "type": "varchar(100)"
    },
    {
      "name": "tabela_valor_kg",
      "type": "float"
    },
    {
      "name": "tabela_percentual_valor",
      "type": "float"
    },
    {
      "name": "tabela_frete_minimo_valor",
      "type": "float"
    },
    {
      "name": "tabela_frete_minimo_peso",
      "type": "float"
    },
    {
      "name": "tabela_icms",
      "type": "float"
    },
    {
      "name": "tabela_percentual_gris",
      "type": "float"
    },
    {
      "name": "tabela_pedagio_por_100kg",
      "type": "float"
    },
    {
      "name": "tabela_valor_tas",
      "type": "float"
    },
    {
      "name": "tabela_percentual_adv",
      "type": "float"
    },
    {
      "name": "tabela_percentual_rca",
      "type": "float"
    },
    {
      "name": "tabela_valor_despacho",
      "type": "float"
    },
    {
      "name": "tabela_valor_cte",
      "type": "float"
    },
    {
      "name": "tabela_icms_incluso",
      "type": "boolean",
      "default": false
    },
    {
      "name": "tabela_icms_destino",
      "type": "float"
    },
    {
      "name": "tabela_gris_minimo",
      "type": "float",
      "description": "Valor mínimo de GRIS",
      "default": 0
    },
    {
      "name": "tabela_adv_minimo",
      "type": "float",
      "description": "Valor mínimo de ADV",
      "default": 0
    },
    {
      "name": "tabela_icms_proprio",
      "type": "float",
      "description": "ICMS próprio da tabela"
    },
    {
      "name": "valor_cotado",
      "type": "float",
      "description": "Calculado automaticamente pela tabela",
      "nullable": false
    },
    {
      "name": "valor_cte",
      "type": "float",
      "description": "Valor cobrado pela transportadora"
    },
    {
      "name": "valor_considerado",
      "type": "float",
      "description": "Valor que consideramos válido (inicialmente = valor_cotado)"
    },
    {
      "name": "valor_pago",
      "type": "float",
      "description": "Valor que efetivamente pagamos"
    },
    {
      "name": "numero_cte",
      "type": "varchar(255)"
    },
    {
      "name": "data_emissao_cte",
      "type": "date"
    },
    {
      "name": "vencimento",
      "type": "date"
    },
    {
      "name": "fatura_frete_id",
      "type": "integer",
      "description": "FK → faturas_frete.id"
    },
    {
      "name": "frete_cte_id",
      "type": "integer",
      "description": "FK → conhecimento_transporte.id"
    },
    {
      "name": "odoo_dfe_id",
      "type": "integer",
      "description": "ID do DFe no Odoo"
    },
    {
      "name": "odoo_purchase_order_id",
      "type": "integer",
      "description": "ID do PO no Odoo"
    },
    {
      "name": "odoo_invoice_id",
      "type": "integer",
      "description": "ID da Invoice no Odoo"
    },
    {
      "name": "lancado_odoo_em",
      "type": "timestamp",
      "description": "Data/hora do lançamento no Odoo"
    },
    {
      "name": "lancado_odoo_por",
      "type": "varchar(100)",
      "description": "Usuário que lançou no Odoo"
    },
    {
      "name": "status",
      "type": "varchar(20)",
      "description": "PENDENTE, EM_TRATATIVA, APROVADO, REJEITADO, PAGO, CANCELADO, LANCADO_ODOO",
      "default": "PENDENTE"
    },
    {
      "name": "requer_aprovacao",
      "type": "boolean",
      "default": false
    },
    {
      "name": "aprovado_por",
      "type": "varchar(100)"
    },
    {
      "name": "aprovado_em",
      "type": "timestamp"
    },
    {
      "name": "observacoes_aprovacao",
      "type": "text"
    },
    {
      "name": "considerar_diferenca",
      "type": "boolean",
      "description": "Para lançar na conta corrente mesmo com diferença até R$ 5,00",
      "default": false
    },
    {
      "name": "criado_em",
      "type": "timestamp",
      "description": "Data de criação"
    },
    {
      "name": "criado_por",
      "type": "varchar(100)",
      "nullable": false
    },
    {
      "name": "lancado_em",
      "type": "timestamp"
    },
    {
      "name": "lancado_por",
      "type": "varchar(100)"
    }
  ],
  "foreign_keys": [
    {
      "column": "embarque_id",
      "references": "embarques.id"
    },
    {
      "column": "transportadora_id",
      "references": "transportadoras.id"
    },
    {
      "column": "fatura_frete_id",
      "references": "faturas_frete.id"
    },
    {
      "column": "frete_cte_id",
      "references": "conhecimento_transporte.id"
    }
  ],
  "query_hints": [
    {
      "descricao": "Custo real total (frete + despesas extras)",
      "sql": "SELECT f.id, f.valor_pago, COALESCE(SUM(de.valor_despesa), 0) AS despesas, f.valor_pago + COALESCE(SUM(de.valor_despesa), 0) AS custo_total FROM fretes f LEFT JOIN despesas_extras de ON de.frete_id = f.id GROUP BY f.id, f.valor_pago"
    },
    {
      "descricao": "Divergencia CTe vs cotacao (transportadora cobrando mais)",
      "sql": "SELECT f.id, f.numero_cte, t.razao_social, f.valor_cotado, f.valor_cte, ABS(f.valor_cte - f.valor_cotado) AS diferenca FROM fretes f JOIN transportadoras t ON t.id = f.transportadora_id WHERE f.valor_cte IS NOT NULL AND ABS(f.valor_cte - f.valor_cotado) > 5.00 ORDER BY diferenca DESC"
    },
    {
      "descricao": "Fretes pendentes de lancamento no Odoo",
      "sql": "SELECT f.id, f.numero_cte, f.valor_pago, t.razao_social FROM fretes f JOIN transportadoras t ON t.id = f.transportadora_id WHERE f.status = 'APROVADO' AND f.lancado_odoo_em IS NULL ORDER BY f.criado_em"
    },
    {
      "descricao": "Frete medio por kg e UF",
      "sql": "SELECT uf_destino, AVG(valor_pago / NULLIF(peso_total, 0)) AS frete_medio_kg FROM fretes WHERE valor_pago IS NOT NULL AND peso_total > 0 GROUP BY uf_destino ORDER BY frete_medio_kg DESC"
    },
    {
      "descricao": "Gasto por tipo de carga (DIRETA vs FRACIONADA)",
      "sql": "SELECT tipo_carga, COUNT(*) AS qtd, SUM(valor_pago) AS total_pago, AVG(valor_pago) AS media FROM fretes WHERE valor_pago IS NOT NULL GROUP BY tipo_carga"
    },
    {
      "descricao": "Ranking transportadoras por valor total pago",
      "sql": "SELECT t.razao_social, COUNT(*) AS qtd_fretes, SUM(f.valor_pago) AS total_pago, AVG(f.valor_pago) AS media_frete FROM fretes f JOIN transportadoras t ON t.id = f.transportadora_id WHERE f.valor_pago IS NOT NULL GROUP BY t.razao_social ORDER BY total_pago DESC"
    },
    {
      "descricao": "Evolucao mensal do custo de frete",
      "sql": "SELECT DATE_TRUNC('month', criado_em) AS mes, COUNT(*) AS qtd, SUM(valor_pago) AS total FROM fretes WHERE valor_pago IS NOT NULL GROUP BY mes ORDER BY mes"
    }
  ],
  "indices": [
    {
      "name": "ix_fretes_cnpj_cliente",
      "columns": [
        "cnpj_cliente"
      ],
      "unique": false
    },
    {
      "name": "ix_fretes_odoo_dfe_id",
      "columns": [
        "odoo_dfe_id"
      ],
      "unique": false
    },
    {
      "name": "ix_fretes_odoo_purchase_order_id",
      "columns": [
        "odoo_purchase_order_id"
      ],
      "unique": false
    },
    {
      "name": "ix_fretes_frete_cte_id",
      "columns": [
        "frete_cte_id"
      ],
      "unique": false
    },
    {
      "name": "ix_fretes_odoo_invoice_id",
      "columns": [
        "odoo_invoice_id"
      ],
      "unique": false
    },
    {
      "name": "ix_fretes_numero_cte",
      "columns": [
        "numero_cte"
      ],
      "unique": false
    }
  ]
}