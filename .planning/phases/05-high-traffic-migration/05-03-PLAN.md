---
phase: 05-high-traffic-migration
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/static/css/modules/_carteira.css
  - app/templates/carteira/dashboard.html
  - app/templates/carteira/agrupados_balanceado.html
autonomous: true

must_haves:
  truths:
    - "Carteira dashboard uses design tokens (cleanup of any remaining hardcoded colors)"
    - "agrupados_balanceado.html uses tokens for colors while preserving layout"
    - "Dark mode toggle works on carteira templates"
  artifacts:
    - path: "app/static/css/modules/_carteira.css"
      provides: "Carteira module overrides using tokens"
      min_lines: 30
    - path: "app/templates/carteira/agrupados_balanceado.html"
      provides: "Template with token-based colors"
  key_links:
    - from: "app/templates/carteira/agrupados_balanceado.html"
      to: "app/static/css/modules/_carteira.css"
      via: "main.css imports module CSS"
      pattern: "class=.*cart-"
---

<objective>
Migrate carteira module templates (dashboard, agrupados_balanceado) to design tokens

Purpose: Clean up remaining hardcoded colors in carteira templates
Output: Templates using design tokens, styles consolidated in _carteira.css
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-high-traffic-migration/05-RESEARCH.md
@app/static/css/modules/_carteira.css
@app/static/css/modules/carteira/agrupados.css
@app/static/css/tokens/_design-tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate carteira/dashboard.html</name>
  <files>
    app/templates/carteira/dashboard.html
    app/static/css/modules/_carteira.css
  </files>
  <action>
Research indicates dashboard.html has minimal hardcoded colors (0 in CSS, 2 inline).

1. Read app/templates/carteira/dashboard.html completely
2. Identify any remaining hardcoded colors in:
   - Inline style attributes
   - {% block extra_css %} blocks
3. Replace with design tokens or remove if using component classes
4. Ensure template uses existing component classes:
   - .card from _cards.css
   - .badge-* from _badges.css
   - .btn-* from _buttons.css

If inline styles exist for colors, create semantic classes in _carteira.css:
```css
/* Carteira Dashboard */
.cart-dashboard-stat {
    background: var(--bg-light);
    border: 1px solid var(--border);
}

.cart-dashboard-link:hover {
    background: var(--amber-50);
    color: hsl(45 100% 20%);
}
```
  </action>
  <verify>
    grep -c "style=.*#" app/templates/carteira/dashboard.html || echo "0 inline color styles"
    grep -c "#[0-9a-fA-F]\{3,6\}" app/templates/carteira/dashboard.html || echo "0 hardcoded colors"
  </verify>
  <done>dashboard.html has no hardcoded colors in styles</done>
</task>

<task type="auto">
  <name>Task 2: Migrate agrupados_balanceado.html</name>
  <files>
    app/templates/carteira/agrupados_balanceado.html
    app/static/css/modules/_carteira.css
  </files>
  <action>
Research indicates ~30 hardcoded colors in CSS, 15 inline styles.

1. Read app/templates/carteira/agrupados_balanceado.html completely
2. Note: Existing app/static/css/modules/carteira/agrupados.css has partial token support
3. Strategy:
   - Extract any remaining inline <style> blocks to _carteira.css
   - Replace hardcoded colors with design tokens
   - Preserve layout (do NOT change grid, flexbox, or positioning)

Key patterns to migrate:

For filter badges:
- Already use --cart-badge-* variables (good)
- Ensure variables map to design tokens (check agrupados.css)

For inline styles (15 found):
- Convert `style="color: #xxx"` to semantic classes
- Convert `style="background: #xxx"` to semantic classes

Add to _carteira.css (consolidate with existing patterns):
```css
/* Carteira Filter Badges - Override with design tokens */
.cart-filter-badge {
    background: var(--bg-light);
    border: 1px solid var(--border);
    color: var(--text);
}

.cart-filter-badge--active {
    background: var(--amber-55);
    color: hsl(45 100% 10%);
    border-color: var(--amber-55);
}

/* Carteira Table Row States */
.cart-row--highlight {
    background: hsla(45 90% 50% / 0.1);
}

.cart-row--selected {
    background: hsla(45 90% 50% / 0.2);
    border-left: 3px solid var(--amber-55);
}

/* Status Indicators */
.cart-status--pendente {
    color: var(--text-muted);
}

.cart-status--urgente {
    color: var(--semantic-danger);
}

.cart-status--concluido {
    color: var(--semantic-success);
}
```

4. Check for any [data-theme="dark"] overrides in template
5. Remove them if design tokens handle the theme switching
6. Verify agrupados.css variables reference design tokens correctly
  </action>
  <verify>
    grep -c "#[0-9a-fA-F]\{3,6\}" app/templates/carteira/agrupados_balanceado.html || echo "0 hardcoded colors"
    grep -c "style=.*#" app/templates/carteira/agrupados_balanceado.html || echo "0 inline color styles"
    grep "cart-" app/static/css/modules/_carteira.css | head -5
  </verify>
  <done>agrupados_balanceado.html has no hardcoded colors, layout preserved</done>
</task>

</tasks>

<verification>
1. Run: `grep -c "#[0-9a-fA-F]\{3,6\}" app/templates/carteira/dashboard.html app/templates/carteira/agrupados_balanceado.html`
   Expected: Very low counts (only in comments/URLs/data attributes)

2. Run: `grep -c "var(--" app/static/css/modules/_carteira.css`
   Expected: Multiple token usages (10+)

3. Visual check: Open /carteira/dashboard in browser
   - Toggle dark/light mode
   - Expected: All elements adapt correctly

4. Visual check: Open /carteira/agrupados in browser
   - Toggle dark/light mode
   - Expected: Filters, badges, and table rows adapt to theme
   - CRITICAL: Layout should be IDENTICAL to before migration
</verification>

<success_criteria>
- dashboard.html has no hardcoded hex colors in CSS/inline styles
- agrupados_balanceado.html uses tokens for colors
- Layout of agrupados_balanceado.html is unchanged
- _carteira.css contains semantic classes using design tokens
- Dark mode works correctly on both templates
</success_criteria>

<output>
After completion, create `.planning/phases/05-high-traffic-migration/05-03-SUMMARY.md`
</output>
