---
phase: 05-high-traffic-migration
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/static/css/modules/_carteira.css
  - app/templates/carteira/dashboard.html
  - app/static/css/modules/carteira/agrupados.css
autonomous: true

must_haves:
  truths:
    - "Carteira dashboard uses design tokens (cleanup of any remaining hardcoded colors)"
    - "agrupados_balanceado.html uses tokens for colors while preserving layout"
    - "Dark mode toggle works on carteira templates"
  artifacts:
    - path: "app/static/css/modules/_carteira.css"
      provides: "Carteira module overrides using tokens"
      min_lines: 30
    - path: "app/templates/carteira/agrupados_balanceado.html"
      provides: "Template with token-based colors"
  key_links:
    - from: "app/templates/carteira/agrupados_balanceado.html"
      to: "app/static/css/modules/_carteira.css"
      via: "main.css imports module CSS"
      pattern: "class=.*cart-"
---

<objective>
Migrate carteira module templates (dashboard, agrupados_balanceado) to design tokens

Purpose: Clean up remaining hardcoded colors in carteira templates
Output: Templates using design tokens, styles consolidated in _carteira.css
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-high-traffic-migration/05-RESEARCH.md
@app/static/css/modules/_carteira.css
@app/static/css/modules/carteira/agrupados.css
@app/static/css/tokens/_design-tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate carteira/dashboard.html</name>
  <files>
    app/templates/carteira/dashboard.html
    app/static/css/modules/_carteira.css
  </files>
  <action>
Research indicates dashboard.html has minimal hardcoded colors (0 in CSS, 2 inline).

1. Read app/templates/carteira/dashboard.html completely
2. Identify any remaining hardcoded colors in:
   - Inline style attributes
   - {% block extra_css %} blocks
3. Replace with design tokens or remove if using component classes
4. Ensure template uses existing component classes:
   - .card from _cards.css
   - .badge-* from _badges.css
   - .btn-* from _buttons.css

If inline styles exist for colors, create semantic classes in _carteira.css:
```css
/* Carteira Dashboard */
.cart-dashboard-stat {
    background: var(--bg-light);
    border: 1px solid var(--border);
}

.cart-dashboard-link:hover {
    background: var(--amber-50);
    color: hsl(45 100% 20%);
}
```
  </action>
  <verify>
    grep -c "style=.*#" app/templates/carteira/dashboard.html || echo "0 inline color styles"
    grep -c "#[0-9a-fA-F]\{3,6\}" app/templates/carteira/dashboard.html || echo "0 hardcoded colors"
  </verify>
  <done>dashboard.html has no hardcoded colors in styles</done>
</task>

<task type="auto">
  <name>Task 2: Migrate agrupados.css external stylesheet</name>
  <files>
    app/static/css/modules/carteira/agrupados.css
    app/static/css/modules/_carteira.css
  </files>
  <action>
IMPORTANT: The agrupados_balanceado.html template has 0 inline hardcoded colors.
The colors are in the EXTERNAL stylesheet: app/static/css/modules/carteira/agrupados.css (~7 hardcoded colors).

1. Read app/static/css/modules/carteira/agrupados.css completely
2. Identify all hardcoded hex colors (#xxx, #xxxxxx)
3. Replace with design tokens:
   - #fff, #ffffff -> var(--bg-light)
   - #1a1a2e, #212529 -> var(--text)
   - #6c757d -> var(--text-muted)
   - #e0e0e0, #dee2e6 -> var(--border)
   - #f8f9fa -> var(--bg)
   - #28a745 -> var(--semantic-success)
   - #dc3545 -> var(--semantic-danger)
   - #ffc107 -> var(--amber-50)
   - #007bff -> var(--amber-55)

4. Verify agrupados.css variables reference design tokens correctly
5. Check for any [data-theme="dark"] overrides in the CSS file
6. Remove them if design tokens handle the theme switching
7. Preserve layout (do NOT change grid, flexbox, or positioning)

If consolidation is needed, add semantic classes to _carteira.css:
```css
/* Carteira Filter Badges - Override with design tokens */
.cart-filter-badge {
    background: var(--bg-light);
    border: 1px solid var(--border);
    color: var(--text);
}

.cart-filter-badge--active {
    background: var(--amber-55);
    color: hsl(45 100% 10%);
    border-color: var(--amber-55);
}

/* Carteira Table Row States */
.cart-row--highlight {
    background: hsla(45 90% 50% / 0.1);
}

.cart-row--selected {
    background: hsla(45 90% 50% / 0.2);
    border-left: 3px solid var(--amber-55);
}
```
  </action>
  <verify>
    grep -c "#[0-9a-fA-F]\{3,6\}" app/static/css/modules/carteira/agrupados.css || echo "0 hardcoded colors"
    grep -c "var(--" app/static/css/modules/carteira/agrupados.css
    grep "cart-" app/static/css/modules/_carteira.css | head -5
  </verify>
  <done>agrupados.css has no hardcoded colors, uses design tokens</done>
</task>

</tasks>

<verification>
1. Run: `grep -c "#[0-9a-fA-F]\{3,6\}" app/templates/carteira/dashboard.html app/templates/carteira/agrupados_balanceado.html`
   Expected: Very low counts (only in comments/URLs/data attributes)

2. Run: `grep -c "var(--" app/static/css/modules/_carteira.css`
   Expected: Multiple token usages (10+)

3. Visual check: Open /carteira/dashboard in browser
   - Toggle dark/light mode
   - Expected: All elements adapt correctly

4. Visual check: Open /carteira/agrupados in browser
   - Toggle dark/light mode
   - Expected: Filters, badges, and table rows adapt to theme
   - CRITICAL: Layout should be IDENTICAL to before migration
</verification>

<success_criteria>
- dashboard.html has no hardcoded hex colors in CSS/inline styles
- agrupados_balanceado.html uses tokens for colors
- Layout of agrupados_balanceado.html is unchanged
- _carteira.css contains semantic classes using design tokens
- Dark mode works correctly on both templates
</success_criteria>

<output>
After completion, create `.planning/phases/05-high-traffic-migration/05-03-SUMMARY.md`
</output>
