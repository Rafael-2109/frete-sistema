---
phase: 01-layer-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - app/static/css/tokens/_design-tokens.css
  - app/static/css/base/_bootstrap-overrides.css
  - app/static/css/base/_navbar.css
  - app/static/css/utilities/_utilities.css
  - app/static/css/main.css
  - app/templates/base.html
autonomous: true

must_haves:
  truths:
    - "Design tokens are wrapped in @layer tokens"
    - "Bootstrap overrides are wrapped in @layer base"
    - "main.css imports all wrapped files with layer() function"
    - "base.html loads main.css as single design system entry point"
    - "Dark mode toggle continues to work without flash"
  artifacts:
    - path: "app/static/css/tokens/_design-tokens.css"
      provides: "Design tokens in tokens layer"
      contains: "@layer tokens"
    - path: "app/static/css/base/_bootstrap-overrides.css"
      provides: "Bootstrap overrides in base layer"
      contains: "@layer base"
    - path: "app/static/css/main.css"
      provides: "Entry point with active imports"
      contains: "@import url('./tokens/_design-tokens.css') layer(tokens)"
    - path: "app/templates/base.html"
      provides: "Template loading main.css"
      contains: "main.css"
  key_links:
    - from: "app/templates/base.html"
      to: "app/static/css/main.css"
      via: "link href"
      pattern: "main\\.css"
    - from: "app/static/css/main.css"
      to: "app/static/css/tokens/_design-tokens.css"
      via: "@import layer(tokens)"
      pattern: "@import.*_design-tokens.*layer\\(tokens\\)"
    - from: "app/static/css/main.css"
      to: "app/static/css/base/_bootstrap-overrides.css"
      via: "@import layer(base)"
      pattern: "@import.*_bootstrap-overrides.*layer\\(base\\)"
---

<objective>
Wrap existing CSS files in appropriate @layer declarations, move them to the new folder structure, update main.css to import them, and update base.html to load main.css as the single entry point.

Purpose: Activate the layer system by connecting all existing CSS through main.css with proper layer assignments. This establishes cascade control where higher layers (utilities, overrides) can override lower layers (tokens, base) without !important.

Output: Working CSS layer system with all existing styles preserved, dark mode still functional
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-layer-infrastructure/01-RESEARCH.md
@.planning/phases/01-layer-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-layer-infrastructure/01-02-SUMMARY.md

# Current CSS files to wrap
@app/static/css/_design-tokens.css
@app/static/css/bootstrap-overrides.css
@app/static/css/navbar.css
@app/static/css/_utilities.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wrap and move CSS files to layer structure</name>
  <files>
    app/static/css/tokens/_design-tokens.css
    app/static/css/base/_bootstrap-overrides.css
    app/static/css/base/_navbar.css
    app/static/css/utilities/_utilities.css
  </files>
  <action>
Move and wrap existing CSS files in their appropriate layers.

**Step 1: Move _design-tokens.css to tokens/ and wrap in @layer tokens**

Read the current file from `app/static/css/_design-tokens.css` and create a new version at `app/static/css/tokens/_design-tokens.css`:

```css
/* Original file content wrapped in layer */
@layer tokens {
    /* ═══════════════════════════════════════════════════════════════════════════
       DESIGN TOKENS - NACOM GOYA
       ... (entire existing content) ...
       ═══════════════════════════════════════════════════════════════════════════ */

    :root {
        /* ... all existing :root content ... */
    }

    [data-bs-theme="dark"],
    [data-theme="dark"] {
        /* ... all existing dark mode content ... */
    }

    [data-bs-theme="light"],
    [data-theme="light"] {
        /* ... all existing light mode content ... */
    }

    /* ... rest of file ... */
}
```

Important: Wrap the ENTIRE content of _design-tokens.css inside `@layer tokens { ... }`.

**Step 2: Move bootstrap-overrides.css to base/ and wrap in @layer base**

Read `app/static/css/bootstrap-overrides.css` and create `app/static/css/base/_bootstrap-overrides.css`:

Critical changes:
1. REMOVE the @import statements for fonts and _design-tokens.css (they will be handled by main.css)
2. Wrap ALL remaining content in `@layer base { ... }`

```css
/* REMOVED - handled by main.css now:
   @import url('https://fonts.googleapis.com/css2?family=...');
   @import url('./_design-tokens.css');
*/

@layer base {
    /* ═══════════════════════════════════════════════════════════════════════════
       BOOTSTRAP OVERRIDES - Nacom Goya
       Carrega APÓS bootstrap.min.css
       ═══════════════════════════════════════════════════════════════════════════ */

    body {
        background: var(--bg-dark);
        color: var(--text-muted);
        font-family: var(--font-sans);
    }

    /* ... rest of existing content ... */
}
```

**Step 3: Move navbar.css to base/ and wrap in @layer base**

Read `app/static/css/navbar.css` and create `app/static/css/base/_navbar.css`:

```css
@layer base {
    /* All existing navbar.css content */
    .nc-navbar { ... }
    /* ... */
}
```

**Step 4: Move _utilities.css to utilities/ and wrap in @layer utilities**

Read `app/static/css/_utilities.css` and create `app/static/css/utilities/_utilities.css`:

```css
@layer utilities {
    /* All existing _utilities.css content */
    /* ... */
}
```

**Important notes:**
- Do NOT delete the original files yet (keep as backup until verified working)
- The @layer wrapper goes around ALL content in each file
- Remove @import statements from bootstrap-overrides.css - they move to main.css
  </action>
  <verify>
```bash
# Verify files exist in new locations
echo "=== Checking new file locations ==="
ls -la app/static/css/tokens/_design-tokens.css
ls -la app/static/css/base/_bootstrap-overrides.css
ls -la app/static/css/base/_navbar.css
ls -la app/static/css/utilities/_utilities.css

# Verify @layer wrappers
echo ""
echo "=== Checking @layer declarations ==="
head -5 app/static/css/tokens/_design-tokens.css | grep "@layer tokens"
head -5 app/static/css/base/_bootstrap-overrides.css | grep "@layer base"
head -5 app/static/css/base/_navbar.css | grep "@layer base"
head -5 app/static/css/utilities/_utilities.css | grep "@layer utilities"

# Verify no @import in bootstrap-overrides (moved to main.css)
echo ""
echo "=== Checking @import removed from bootstrap-overrides ==="
grep "@import" app/static/css/base/_bootstrap-overrides.css && echo "FAIL: @import still present" || echo "OK: No @import found"
```
  </verify>
  <done>
Four CSS files moved to new structure with @layer wrappers. No @import statements in bootstrap-overrides.css.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update main.css with active imports</name>
  <files>app/static/css/main.css</files>
  <action>
Update main.css to activate the layer imports (uncomment and fix paths).

Replace the commented imports with active ones:

```css
/**
 * main.css - CSS Entry Point for Nacom Goya Design System
 *
 * This file establishes the CSS cascade layer order and imports
 * all stylesheets in the correct priority sequence.
 *
 * Layer Priority (lowest to highest):
 * 1. reset     - Browser normalization
 * 2. tokens    - Design tokens (colors, spacing, typography)
 * 3. base      - Bootstrap overrides, global defaults
 * 4. components - Reusable UI components (buttons, cards, etc.)
 * 5. modules   - Feature-specific styles (carteira, financeiro, etc.)
 * 6. utilities - Utility classes (spacing, visibility, etc.)
 * 7. overrides - Temporary migration overrides (remove when complete)
 *
 * Browser Support: 96%+ (all modern browsers since March 2022)
 */

/* ═══════════════════════════════════════════════════════════════════════════
   LAYER ORDER DECLARATION (MUST BE FIRST)
   ═══════════════════════════════════════════════════════════════════════════ */

@layer reset, tokens, base, components, modules, utilities, overrides;

/* ═══════════════════════════════════════════════════════════════════════════
   EXTERNAL IMPORTS (fonts, etc.)
   Note: These are NOT in layers - they load as unlayered styles
   ═══════════════════════════════════════════════════════════════════════════ */

@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');

/* ═══════════════════════════════════════════════════════════════════════════
   LAYER IMPORTS
   ═══════════════════════════════════════════════════════════════════════════ */

/* Tokens - Design system variables */
@import url('./tokens/_design-tokens.css') layer(tokens);

/* Base - Bootstrap overrides and global defaults */
@import url('./base/_bootstrap-overrides.css') layer(base);
@import url('./base/_navbar.css') layer(base);

/* Components - Reusable UI patterns (Phase 2)
   @import url('./components/_buttons.css') layer(components);
   @import url('./components/_cards.css') layer(components);
*/

/* Utilities - Helper classes */
@import url('./utilities/_utilities.css') layer(utilities);

/* Legacy - Temporary overrides during migration (Phase 7)
   @import url('./legacy/_inline-overrides.css') layer(overrides);
*/

/* ═══════════════════════════════════════════════════════════════════════════
   END OF IMPORTS
   ═══════════════════════════════════════════════════════════════════════════ */
```

Key changes:
1. Added Google Fonts @import (moved from bootstrap-overrides.css)
2. Activated tokens, base, and utilities imports
3. Kept components and legacy commented (for future phases)
  </action>
  <verify>
```bash
# Verify main.css has active imports
echo "=== Checking main.css imports ==="
grep -E "^@import" app/static/css/main.css

# Count active imports (should be 5: fonts + tokens + bootstrap-overrides + navbar + utilities)
echo ""
echo "=== Active import count ==="
grep -c "^@import" app/static/css/main.css
# Expected: 5

# Verify layer() function used
echo ""
echo "=== Checking layer() usage ==="
grep "layer(tokens)" app/static/css/main.css && echo "OK: tokens layer"
grep "layer(base)" app/static/css/main.css && echo "OK: base layer"
grep "layer(utilities)" app/static/css/main.css && echo "OK: utilities layer"
```
  </verify>
  <done>
main.css has 5 active @import statements: fonts (unlayered), tokens, bootstrap-overrides (base), navbar (base), utilities.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update base.html to use main.css entry point</name>
  <files>app/templates/base.html</files>
  <action>
Replace the individual CSS imports in base.html with the single main.css entry point.

**Find these lines (around lines 13-17):**
```html
<!-- Design System Nacom Goya -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-overrides.css') }}?v=6">
<link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}?v=6">
<link rel="stylesheet" href="{{ url_for('static', filename='css/financeiro/premium-effects.css') }}?v=6">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=6">
```

**Replace with:**
```html
<!-- Design System Nacom Goya - Single Entry Point -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}?v=7">

<!-- Additional module styles (until migrated to main.css in Phase 5+) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/financeiro/premium-effects.css') }}?v=7">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=7">
```

**What this changes:**
- `bootstrap-overrides.css` -> now loaded via main.css
- `navbar.css` -> now loaded via main.css
- `financeiro/premium-effects.css` -> kept separate (migrated in Phase 5)
- `style.css` -> kept separate (may contain legacy styles)

**Important:** Bump cache version from ?v=6 to ?v=7 to force browsers to reload CSS.

**Note:** Do NOT remove the flash prevention script (lines 19-27). It should remain exactly as-is:
```html
<script>
  (function() {
    var saved = localStorage.getItem('nacom-theme');
    var theme = saved || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
    document.documentElement.setAttribute('data-bs-theme', theme);
    document.documentElement.setAttribute('data-theme', theme);
  })();
</script>
```
  </action>
  <verify>
```bash
# Verify main.css is loaded
echo "=== Checking main.css in base.html ==="
grep "main.css" app/templates/base.html

# Verify old individual CSS removed
echo ""
echo "=== Checking old CSS references removed ==="
grep "bootstrap-overrides.css" app/templates/base.html && echo "FAIL: bootstrap-overrides.css still present" || echo "OK: bootstrap-overrides.css removed"
grep "navbar.css" app/templates/base.html && echo "FAIL: navbar.css still present" || echo "OK: navbar.css removed"

# Verify flash prevention script still exists
echo ""
echo "=== Checking flash prevention script ==="
grep "nacom-theme" app/templates/base.html && echo "OK: Flash prevention script present" || echo "FAIL: Flash prevention script missing"

# Verify premium-effects and style.css still present (not migrated yet)
echo ""
echo "=== Checking remaining CSS (expected) ==="
grep "premium-effects.css" app/templates/base.html && echo "OK: premium-effects.css present"
grep "style.css" app/templates/base.html && echo "OK: style.css present"
```
  </verify>
  <done>
base.html loads main.css as single entry point, with premium-effects.css and style.css kept separate for now.
  </done>
</task>

</tasks>

<verification>
Run these checks to verify Phase 1, Plan 03 completion:

```bash
# 1. Verify layer system is working
echo "=== Testing CSS load order ==="
# Check main.css @layer is first
head -30 app/static/css/main.css | grep "@layer reset"

# 2. Verify all wrapped files
echo ""
echo "=== Checking @layer wrappers ==="
for file in "tokens/_design-tokens.css" "base/_bootstrap-overrides.css" "base/_navbar.css" "utilities/_utilities.css"; do
  if grep -q "@layer" "app/static/css/$file" 2>/dev/null; then
    echo "OK: $file has @layer"
  else
    echo "FAIL: $file missing @layer"
  fi
done

# 3. Verify base.html uses main.css
echo ""
echo "=== Checking base.html ==="
grep "main.css" app/templates/base.html && echo "OK: main.css loaded" || echo "FAIL: main.css not found"

# 4. Start dev server and test dark mode manually
echo ""
echo "=== Manual test required ==="
echo "1. Start the app: flask run"
echo "2. Open browser to http://localhost:5000"
echo "3. Toggle dark/light mode"
echo "4. Verify no flash of wrong theme on page load"
echo "5. Verify styles look correct in both modes"
```

**Browser test (CRITICAL):**
Open developer tools and check:
1. Network tab shows main.css loading
2. No 404 errors for CSS files
3. Elements tab shows @layer in computed styles
4. Dark mode toggle works without page reload
</verification>

<success_criteria>
1. All 4 CSS files wrapped in appropriate @layer declarations
2. Files moved to tokens/, base/, utilities/ folders
3. main.css has 5 active @import statements
4. base.html loads main.css as entry point
5. No @import statements remain in bootstrap-overrides.css
6. Dark mode toggle works without flash (FOWT prevention verified)
7. Visual appearance unchanged from before migration
8. No console errors related to CSS loading
</success_criteria>

<output>
After completion, create `.planning/phases/01-layer-infrastructure/01-03-SUMMARY.md`
</output>
