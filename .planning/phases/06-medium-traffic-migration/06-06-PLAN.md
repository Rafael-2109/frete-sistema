---
phase: 06-medium-traffic-migration
plan: 06
type: execute
wave: 4
depends_on: ["06-01"]
files_modified:
  - app/templates/bi/*.html
  - app/static/css/modules/_bi.css
  - app/templates/bi/js/*.js
autonomous: true

must_haves:
  truths:
    - "BI templates use design tokens for backgrounds and text"
    - "Chart.js colors read from CSS custom properties"
    - "Charts update colors when theme changes"
  artifacts:
    - path: "app/static/css/modules/_bi.css"
      provides: "BI module styles with chart tokens"
      contains: "--chart-primary"
  key_links:
    - from: "app/templates/bi/js/*.js"
      to: "app/static/css/modules/_bi.css"
      via: "getComputedStyle reading --chart-* tokens"
      pattern: "getComputedStyle"
---

<objective>
Migrate BI module with Chart.js color integration

Purpose: Handle complex case where JS needs to read CSS tokens for chart colors
Output: BI module migrated with theme-aware Chart.js visualizations
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-medium-traffic-migration/06-RESEARCH.md
@app/static/css/modules/_bi.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate BI template styles (92 colors, 4 templates)</name>
  <files>
    app/templates/bi/*.html
    app/static/css/modules/_bi.css
  </files>
  <action>
1. Scan all 4 BI templates for inline styles and hardcoded colors
2. Categorize:
   - Template structure (backgrounds, text, borders) -> design tokens
   - Chart colors (defined in JS) -> defer to Task 2
   - Gradient backgrounds -> convert to token-based gradients
3. Extract patterns to _bi.css:
   - .bi-card-* for dashboard cards
   - .bi-header-* for section headers
   - .bi-metric-* for metric displays
4. Replace hardcoded colors with design tokens

Focus on:
- Dashboard card backgrounds
- Metric value colors
- Header gradients
- Legend text colors

Token mapping:
- #fff -> var(--bg-light)
- #f8f9fa -> var(--bg)
- #212529 -> var(--text)
- #6c757d -> var(--text-muted)
- #dee2e6 -> var(--border)
- Gradient backgrounds -> use token-based hsla() values

Note: Chart colors in JS will be addressed in Task 2.
  </action>
  <verify>
    grep -r "#[0-9a-fA-F]\{3,6\}" app/templates/bi/ --include="*.html" | grep -v "{#" | grep -v "Chart" | wc -l
    grep "@layer modules" app/static/css/modules/_bi.css
  </verify>
  <done>BI template styles migrated to design tokens</done>
</task>

<task type="auto">
  <name>Task 2: Create Chart.js color utility for theme-aware charts</name>
  <files>
    app/templates/bi/js/*.js
    app/static/css/modules/_bi.css
  </files>
  <action>
1. Verify _bi.css has chart color tokens (created in 06-01):
   ```css
   :root {
     --chart-primary: var(--amber-55);
     --chart-secondary: var(--amber-40);
     --chart-success: var(--semantic-success);
     --chart-danger: var(--semantic-danger);
     --chart-info: hsl(190 65% 45%);
     --chart-bg-primary: hsla(45 100% 50% / 0.1);
     --chart-bg-secondary: hsla(45 100% 50% / 0.05);
   }
   ```

2. Create ChartColors utility in BI JS files:
   ```javascript
   const ChartColors = {
     get(name) {
       return getComputedStyle(document.documentElement)
         .getPropertyValue(`--chart-${name}`).trim();
     },
     primary: () => ChartColors.get('primary'),
     secondary: () => ChartColors.get('secondary'),
     success: () => ChartColors.get('success'),
     danger: () => ChartColors.get('danger'),
     info: () => ChartColors.get('info'),
     bgPrimary: () => ChartColors.get('bg-primary'),
     bgSecondary: () => ChartColors.get('bg-secondary'),
   };
   ```

3. Replace hardcoded Chart.js colors with utility calls:
   Before:
   ```javascript
   backgroundColor: 'rgba(102, 126, 234, 0.1)',
   borderColor: 'rgba(102, 126, 234, 1)',
   ```
   After:
   ```javascript
   backgroundColor: ChartColors.bgPrimary(),
   borderColor: ChartColors.primary(),
   ```

4. Add theme change listener for chart updates:
   ```javascript
   // Listen for theme changes and update charts
   const observer = new MutationObserver((mutations) => {
     mutations.forEach((mutation) => {
       if (mutation.attributeName === 'data-bs-theme') {
         // Update all charts with new colors
         Chart.instances.forEach(chart => chart.update());
       }
     });
   });
   observer.observe(document.documentElement, { attributes: true });
   ```

Note: Research indicates 92 colors in BI, many are Chart.js related.
Focus on most impactful charts first.
  </action>
  <verify>
    grep "ChartColors" app/templates/bi/js/*.js
    grep "getComputedStyle" app/templates/bi/js/*.js
  </verify>
  <done>Chart.js colors read from CSS tokens and update on theme change</done>
</task>

</tasks>

<verification>
1. Run: `grep -r "#[0-9a-fA-F]\{3,6\}" app/templates/bi/ --include="*.html" | grep -v "{#" | wc -l`
   Expected: Near zero for non-chart colors

2. Check chart utility exists:
   `grep "ChartColors" app/templates/bi/js/*.js`
   Expected: Utility defined and used

3. Visual check: Load BI dashboard in both light and dark modes
   Expected: Charts update colors appropriately when theme changes

4. Functional check: Charts render correctly with data
</verification>

<success_criteria>
- BI template styles migrated to design tokens
- ChartColors utility created for reading CSS tokens in JS
- Chart.js instances use token-based colors
- Theme change listener updates charts automatically
- Charts render correctly in both light and dark modes
</success_criteria>

<output>
After completion, create `.planning/phases/06-medium-traffic-migration/06-06-SUMMARY.md`
</output>
