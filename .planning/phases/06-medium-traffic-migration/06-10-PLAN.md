---
phase: 06-medium-traffic-migration
plan: 10
type: execute
wave: 5
depends_on: ["06-01"]
files_modified:
  - app/static/js/carteira-simples.js
  - app/static/js/portal-async-integration.js
  - app/static/js/programacao-lote.js
  - app/static/js/carteira-service.js
  - app/static/js/analises-drilldown.js
  - app/static/js/contas_receber_comparativo.js
  - app/capacitor/gps-service-hibrido.js
autonomous: true

must_haves:
  truths:
    - "JS files use CSS custom properties instead of hardcoded hex colors"
    - "Dynamic styling reads colors from design tokens"
    - "Odoo tag colors mapped to design system"
  artifacts:
    - path: "app/static/js/carteira-simples.js"
      provides: "Carteira JS with token-based colors"
      contains: "getComputedStyle"
  key_links:
    - from: "app/static/js/carteira-simples.js"
      to: "app/static/css/tokens/_design-tokens.css"
      via: "getComputedStyle reading CSS variables"
      pattern: "getPropertyValue"
---

<objective>
Migrate JavaScript files with hardcoded colors to use CSS custom properties

Purpose: Complete the migration by addressing 51 hardcoded colors in 7 JS files
Output: JS files read colors from CSS tokens for theme-aware dynamic styling
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-medium-traffic-migration/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate carteira JS files (23 colors)</name>
  <files>
    app/static/js/carteira-simples.js
    app/static/js/carteira-service.js
  </files>
  <action>
**carteira-simples.js (20 colors):**

1. Identify hardcoded color patterns:
   - Inline styles with `!important`
   - Odoo tag color mapping
   - Status/badge colors

2. Create color utility at top of file:
```javascript
// Design token reader utility
const DesignTokens = {
  get(name) {
    return getComputedStyle(document.documentElement)
      .getPropertyValue(`--${name}`).trim();
  },
  // Semantic colors
  bg: () => DesignTokens.get('bg'),
  bgLight: () => DesignTokens.get('bg-light'),
  text: () => DesignTokens.get('text'),
  textMuted: () => DesignTokens.get('text-muted'),
  border: () => DesignTokens.get('border'),
  success: () => DesignTokens.get('semantic-success'),
  danger: () => DesignTokens.get('semantic-danger'),
  amber50: () => DesignTokens.get('amber-50'),
  amber55: () => DesignTokens.get('amber-55'),
};
```

3. Replace hardcoded colors:
   Before:
   ```javascript
   element.style.setProperty('background-color', '#dc3545', 'important');
   ```
   After (prefer CSS class):
   ```javascript
   element.classList.add('bg-danger');
   ```
   Or (if class not suitable):
   ```javascript
   element.style.backgroundColor = DesignTokens.danger();
   ```

4. For Odoo tag colors, create mapping:
```javascript
const OdooTagColors = {
  0: () => DesignTokens.textMuted(),  // Gray
  1: () => DesignTokens.danger(),      // Red
  2: () => DesignTokens.amber50(),     // Orange/Amber
  3: () => DesignTokens.get('amber-40'), // Yellow
  4: () => DesignTokens.get('bs-info'), // Light blue
  5: () => DesignTokens.success(),     // Green
  // Add others as needed
};
```

**carteira-service.js (3 colors):**
- Apply same pattern
- Likely badge/status colors

Remove `!important` where possible - layer system handles specificity.
  </action>
  <verify>
    grep -r "#[0-9a-fA-F]\{3,6\}" app/static/js/carteira-simples.js app/static/js/carteira-service.js | wc -l
    grep "DesignTokens\|getComputedStyle" app/static/js/carteira-simples.js
  </verify>
  <done>Carteira JS files use CSS tokens instead of hardcoded colors</done>
</task>

<task type="auto">
  <name>Task 2: Migrate remaining JS files (28 colors)</name>
  <files>
    app/static/js/portal-async-integration.js
    app/static/js/programacao-lote.js
    app/static/js/analises-drilldown.js
    app/static/js/contas_receber_comparativo.js
    app/capacitor/gps-service-hibrido.js
  </files>
  <action>
**portal-async-integration.js (20 colors):**
- Status toast colors
- Progress indicators
- Replace with DesignTokens utility (copy from carteira-simples.js)

**programacao-lote.js (4 colors):**
- Status colors
- Minimal changes needed

**analises-drilldown.js (2 colors):**
- Chart colors
- Use ChartColors utility from BI module if applicable

**contas_receber_comparativo.js (1 color):**
- Single color - quick fix

**gps-service-hibrido.js (1 color):**
- Map marker color
- May need special handling for Capacitor

For each file:
1. Add DesignTokens utility (or import if modular)
2. Replace hardcoded hex colors with token reads
3. Prefer CSS classes over inline styles
4. Remove `!important` where possible

Migration pattern:
```javascript
// Before
element.style.color = '#28a745';

// After - Option 1: CSS class (preferred)
element.classList.add('text-success');

// After - Option 2: Token read (when class not suitable)
element.style.color = DesignTokens.success();
```

For toast/notification libraries:
```javascript
// Before
toastr.success('Message', { backgroundColor: '#28a745' });

// After
toastr.success('Message', { backgroundColor: DesignTokens.success() });
```
  </action>
  <verify>
    grep -r "#[0-9a-fA-F]\{3,6\}" app/static/js/portal-async-integration.js app/static/js/programacao-lote.js app/static/js/analises-drilldown.js app/static/js/contas_receber_comparativo.js app/capacitor/gps-service-hibrido.js | wc -l
  </verify>
  <done>All JS files use CSS tokens for dynamic colors</done>
</task>

</tasks>

<verification>
1. Run: `grep -r "#[0-9a-fA-F]\{3,6\}" app/static/js/carteira-simples.js app/static/js/portal-async-integration.js app/static/js/programacao-lote.js app/static/js/carteira-service.js app/static/js/analises-drilldown.js app/static/js/contas_receber_comparativo.js app/capacitor/gps-service-hibrido.js | wc -l`
   Expected: Near zero (from 51)

2. Verify token utility present:
   `grep "DesignTokens\|getComputedStyle" app/static/js/carteira-simples.js`
   Expected: Utility defined or imported

3. Functional check: Load pages using these JS files
   Expected: Dynamic styling works correctly

4. Theme toggle check: Switch theme while dynamic elements visible
   Expected: Colors update appropriately (or on next render)
</verification>

<success_criteria>
- 7 JS files migrated from hardcoded colors to CSS tokens
- DesignTokens utility available for reading CSS custom properties
- Odoo tag colors mapped to design system
- `!important` usage reduced or eliminated from JS
- Dynamic styling works in both light and dark modes
</success_criteria>

<output>
After completion, create `.planning/phases/06-medium-traffic-migration/06-10-SUMMARY.md`
</output>
