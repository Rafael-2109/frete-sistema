{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-file-invoice"></i> Pedidos de Venda</h2>
        <div>
            <a href="{{ url_for('motochefe.adicionar_pedido') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Novo Pedido
            </a>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="GET" class="row g-2">
                <div class="col-md-4">
                    <label class="form-label">Faturado</label>
                    <select name="faturado" class="form-select">
                        <option value="">Todos</option>
                        <option value="0">NÃ£o Faturados</option>
                        <option value="1">Faturados</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Enviado</label>
                    <select name="enviado" class="form-select">
                        <option value="">Todos</option>
                        <option value="0">NÃ£o Enviados</option>
                        <option value="1">Enviados</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                    <a href="{{ url_for('motochefe.listar_pedidos') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Limpar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>Vendedor</th>
                            <th>Pedido - Data<br><small>Cliente</small></th>
                            <th>Entrega</th>
                            <th>Total</th>
                            <th>Vencimento<br><small>Saldo</small></th>
                            <th>NF</th>
                            <th>AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in pedidos %}
                        <tr>
                            {# Coluna 1: Vendedor #}
                            <td>{{ p.vendedor.vendedor if p.vendedor else '-' }}</td>

                            {# Coluna 2: Pedido - Data + Cliente #}
                            <td>
                                <strong>{{ p.numero_pedido }}</strong> - {{ p.data_pedido.strftime('%d/%m/%Y') if p.data_pedido else '-' }}<br>
                                <small class="text-muted">{{ p.cliente.cliente if p.cliente else '-' }}</small>
                            </td>

                            {# Coluna 3: Entrega (data_expedicao) #}
                            <td>{{ p.data_expedicao.strftime('%d/%m/%Y') if p.data_expedicao else '-' }}</td>

                            {# Coluna 4: Qtd Motos + Total #}
                            <td>
                                {{ p.quantidade_motos }} Motos<br>
                                <small class="text-success fw-bold">R$ {{ p.valor_total_pedido|valor_br }}</small>
                            </td>

                            {# Coluna 5: Vencimento + Saldo #}
                            <td>
                                {% set primeiro_titulo = p.titulos|selectattr('numero_parcela', 'equalto', 1)|selectattr('status', 'ne', 'CANCELADO')|first %}
                                {% if primeiro_titulo and primeiro_titulo.data_vencimento %}
                                    {{ primeiro_titulo.data_vencimento.strftime('%d/%m/%Y') }}
                                    {% if primeiro_titulo.atrasado %}
                                        <br><span class="badge bg-danger">VENCIDO</span>
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                                <br>
                                <small {% if p.saldo_a_receber > 0 %}class="text-danger fw-bold"{% else %}class="text-success"{% endif %}>
                                    R$ {{ p.saldo_a_receber|valor_br }}
                                </small>
                            </td>

                            {# Coluna 6: Status + NF #}
                            <td>
                                {% if p.enviado %}
                                <span class="badge bg-primary">Enviado</span>
                                {% elif p.faturado %}
                                <span class="badge bg-info">Faturado</span>
                                {% else %}
                                <span class="badge bg-warning">Aberto</span>
                                {% endif %}
                                <br>
                                {% if p.faturado %}
                                    <button type="button" class="btn btn-outline-primary btn-sm"
                                            data-bs-toggle="modal"
                                            data-bs-target="#modalEditarNF{{ p.id }}"
                                            title="Editar NF">
                                        <i class="fas fa-file-invoice"></i> {{ p.numero_nf }}
                                    </button>
                                {% else %}
                                <button type="button" class="btn btn-success btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalFaturar{{ p.id }}">
                            <i class="fas fa-file-invoice-dollar"></i> Faturar
                        </button>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {# ðŸ†• BotÃ£o Imprimir - Verde se impresso, Amarelo se nÃ£o #}
                                    <a href="{{ url_for('motochefe.imprimir_pedido', id=p.id) }}"
                                       class="btn {% if p.impresso %}btn-success{% else %}btn-warning{% endif %}"
                                       target="_blank"
                                       {% if p.impresso %}
                                       title="Impresso em {{ p.impresso_em.strftime('%d/%m/%Y Ã s %H:%M') if p.impresso_em else '-' }} por {{ p.impresso_por or 'N/A' }}"
                                       {% else %}
                                       title="Imprimir Pedido"
                                       {% endif %}
                                       style="color: #000; font-size: 1.1rem;">
                                        <i class="fas fa-print"></i>
                                    </a>
                                    <a href="{{ url_for('motochefe.detalhes_pedido', id=p.id) }}" class="btn btn-info">
                                        <i class="fas fa-eye"></i> Ver
                                    </a>
                                    {% if p.saldo_a_receber > 0 %}
                                    <button type="button" class="btn btn-success"
                                            data-bs-toggle="modal"
                                            data-bs-target="#modalReceber{{ p.id }}">
                                        <i class="fas fa-dollar-sign"></i> Receber
                                    </button>
                                    {% endif %}
                                    {# ðŸ†• BotÃ£o Cancelar (apenas se nÃ£o faturado) #}
                                    {% if not p.faturado and p.status != 'CANCELADO' %}
                                    <button type="button" class="btn btn-danger"
                                            data-bs-toggle="modal"
                                            data-bs-target="#modalCancelar{{ p.id }}"
                                            title="Solicitar Cancelamento">
                                        <i class="fas fa-ban"></i> Cancelar
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>

                        {# ðŸ†• Modal de Cancelamento #}
                        <div class="modal fade" id="modalCancelar{{ p.id }}" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header bg-danger text-white">
                                        <h5 class="modal-title">
                                            <i class="fas fa-ban"></i> Solicitar Cancelamento
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="POST" action="{{ url_for('motochefe.solicitar_cancelamento_pedido', id=p.id) }}">
                                        <div class="modal-body" style="overflow-wrap: break-word; word-wrap: break-word; word-break: break-word; hyphens: auto;">
                                            <p><strong>Pedido:</strong> {{ p.numero_pedido }}</p>
                                            <p style="word-break: break-all;"><strong>Cliente:</strong> {{ p.cliente.cliente if p.cliente else '-' }}</p>
                                            <p><strong>Valor:</strong> R$ {{ p.valor_total_pedido|valor_br }}</p>

                                            <div class="alert alert-warning" style="white-space: normal; word-wrap: break-word; overflow-wrap: break-word;">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                <strong>AtenÃ§Ã£o!</strong><br>
                                                O pedido serÃ¡ <strong>imediatamente</strong> cancelado e removido da lista, mas precisarÃ¡ de aprovaÃ§Ã£o na tela "ConfirmaÃ§Ã£o de Pedidos".
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label text-danger"><strong>Motivo do Cancelamento *</strong></label>
                                                <textarea name="observacao" class="form-control" rows="3" required
                                                          placeholder="Digite o motivo do cancelamento..."></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" class="btn btn-danger">
                                                <i class="fas fa-ban"></i> Confirmar Cancelamento
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {# Fim Modal Cancelamento #}

                        <!-- Modal de Faturamento -->
                        <div class="modal fade" id="modalFaturar{{ p.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header bg-success text-white">
                                        <h5 class="modal-title">
                                            <i class="fas fa-file-invoice-dollar"></i> 
                                            Faturar Pedido {{ p.numero_pedido }}
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="POST" action="{{ url_for('motochefe.faturar_pedido', id=p.id) }}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <div class="modal-body">
                                            <div class="alert alert-info">
                                                <strong>Cliente:</strong> {{ p.cliente.cliente }}<br>
                                                <strong>Valor Total:</strong> R$ {{ p.valor_total_pedido|valor_br }}<br>
                                                <strong>Qtd Motos:</strong> {{ p.quantidade_motos }}
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Empresa Emissora *</label>
                                                <div class="input-group">
                                                    <select name="empresa_venda_id" class="form-select" required>
                                                        <option value="">Selecione...</option>
                                                        {% for emp in empresas %}
                                                        <option value="{{ emp.id }}">{{ emp.empresa }} - {{ emp.cnpj_empresa }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <button type="button" class="btn btn-outline-secondary" 
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#modalNovaEmpresa">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">NÃºmero NF *</label>
                                                    <input type="text" name="numero_nf" class="form-control" required>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Data NF *</label>
                                                    <input type="date" name="data_nf" class="form-control" 
                                                           value="{{ today if today else '' }}" required>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-check"></i> Confirmar Faturamento
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Modal de EdiÃ§Ã£o de NF -->
                        {% if p.faturado %}
                        <div class="modal fade modal-lg" id="modalEditarNF{{ p.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title">
                                            <i class="fas fa-edit"></i>
                                            Editar NF do Pedido {{ p.numero_pedido }}
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="POST" action="{{ url_for('motochefe.editar_nf_pedido', id=p.id) }}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <div class="modal-body">
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                <strong>AtenÃ§Ã£o:</strong> A alteraÃ§Ã£o da NF nÃ£o afeta os tÃ­tulos financeiros jÃ¡ criados.
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">NÃºmero NF Atual</label>
                                                <input type="text" class="form-control" value="{{ p.numero_nf }}" disabled>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Novo NÃºmero NF *</label>
                                                    <input type="text" name="numero_nf" class="form-control"
                                                           value="{{ p.numero_nf }}" required>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Nova Data NF *</label>
                                                    <input type="date" name="data_nf" class="form-control"
                                                           value="{{ p.data_nf.strftime('%Y-%m-%d') if p.data_nf else '' }}" required>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save"></i> Salvar AlteraÃ§Ãµes
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Modal de Recebimento por Pedido -->
                        {% if p.saldo_a_receber > 0 %}
                        <div class="modal fade modal-lg" id="modalReceber{{ p.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header bg-success text-white">
                                        <h5 class="modal-title">
                                            <i class="fas fa-dollar-sign"></i>
                                            Receber Pagamento - Pedido {{ p.numero_pedido }}
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="POST" action="{{ url_for('motochefe.receber_pedido', id=p.id) }}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <div class="modal-body">
                                            <div class="alert alert-info">
                                                <strong>Cliente:</strong> {{ p.cliente.cliente }}<br>
                                                <strong>Valor Total Pedido:</strong> R$ {{ p.valor_total_pedido|valor_br }}<br>
                                                <strong>Saldo a Receber:</strong> <span class="text-danger fw-bold">R$ {{ p.saldo_a_receber|valor_br }}</span>
                                            </div>

                                            <div class="alert alert-warning">
                                                <i class="fas fa-info-circle"></i>
                                                <strong>Ordem de Pagamento AutomÃ¡tica (por moto):</strong><br>
                                                O valor serÃ¡ aplicado POR MOTO COMPLETA:<br>
                                                <strong>Moto 1:</strong> 1Âº MovimentaÃ§Ã£o â†’ 2Âº Montagem â†’ 3Âº Frete â†’ 4Âº Venda<br>
                                                <strong>Moto 2:</strong> 1Âº MovimentaÃ§Ã£o â†’ 2Âº Montagem â†’ 3Âº Frete â†’ 4Âº Venda<br>
                                                <small class="text-muted">(QuitaÃ§Ã£o completa de cada moto antes de passar para a prÃ³xima)</small>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Empresa Recebedora *</label>
                                                <select name="empresa_recebedora_id" class="form-select" required>
                                                    <option value="">Selecione...</option>
                                                    {% for emp in empresas %}
                                                    <option value="{{ emp.id }}">{{ emp.empresa }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Valor Recebido *</label>
                                                <input type="number" step="0.01" name="valor_recebido"
                                                       class="form-control" placeholder="0.00" required>
                                                <small class="text-muted">
                                                    Digite o valor total recebido. O sistema distribuirÃ¡ automaticamente entre os tÃ­tulos.
                                                </small>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-check"></i> Confirmar Recebimento
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">Nenhum pedido encontrado</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            <!-- PaginaÃ§Ã£o -->
            {% if paginacao %}
                {% include 'motochefe/_pagination.html' %}
            {% endif %}
        </div>
        </div>
    </div>
</div>

<!-- Modal Nova Empresa (dentro do modal de faturamento) -->
<div class="modal fade" id="modalNovaEmpresa" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5><i class="fas fa-building"></i> Cadastrar Nova Empresa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formNovaEmpresa">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="from_modal" value="1"/>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CNPJ *</label>
                            <input type="text" name="cnpj_empresa" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome Empresa *</label>
                            <input type="text" name="empresa" class="form-control" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Banco</label>
                            <input type="text" name="banco" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Chave PIX</label>
                            <input type="text" name="chave_pix" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Cadastro de empresa via AJAX
document.getElementById('formNovaEmpresa')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch("{{ url_for('motochefe.adicionar_empresa') }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fechar modal
            bootstrap.Modal.getInstance(document.getElementById('modalNovaEmpresa')).hide();
            
            // Adicionar empresa no select de todas as modals de faturamento
            document.querySelectorAll('select[name="empresa_venda_id"]').forEach(select => {
                const option = document.createElement('option');
                option.value = data.id;
                option.textContent = data.nome;
                option.selected = true;
                select.appendChild(option);
            });
            
            // Limpar form
            this.reset();
            
            alert('Empresa cadastrada com sucesso!');
        }
    })
    .catch(error => {
        alert('Erro ao cadastrar empresa: ' + error);
    });
});
</script>

<!-- Modal Visualizar Estoque -->
<div class="modal fade" id="modalEstoqueAgrupamento" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-layer-group"></i> Visualizar Estoque de Motos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- FILTROS -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <strong><i class="fas fa-filter"></i> Filtros</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Status:</label>
                                <select id="filtro_status_estoque" class="form-select form-select-sm">
                                    <option value="">Todos</option>
                                    <option value="DISPONIVEL" selected>DisponÃ­vel</option>
                                    <option value="RESERVADA">Reservada</option>
                                    <option value="VENDIDA">Vendida</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Modelo:</label>
                                <select id="filtro_modelo_estoque" class="form-select form-select-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Cor:</label>
                                <select id="filtro_cor_estoque" class="form-select form-select-sm">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">PotÃªncia:</label>
                                <select id="filtro_potencia_estoque" class="form-select form-select-sm">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LOADING -->
                <div id="loading_estoque" class="text-center py-5" style="display:none;">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted">Carregando dados...</p>
                </div>

                <!-- ACCORDIONS -->
                <div id="accordion_estoque">
                    <!-- ConteÃºdo gerado por JavaScript -->
                </div>

                <!-- Mensagem vazia -->
                <div id="mensagem_vazio_estoque" class="alert alert-warning text-center" style="display:none;">
                    <i class="fas fa-exclamation-triangle"></i> Nenhuma moto encontrada com os filtros selecionados.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// JAVASCRIPT - MODAL DE ESTOQUE AGRUPADO
// ============================================================================
(function() {
    'use strict';

    const modal = document.getElementById('modalEstoqueAgrupamento');
    const accordionContainer = document.getElementById('accordion_estoque');
    const loadingDiv = document.getElementById('loading_estoque');
    const mensagemVazio = document.getElementById('mensagem_vazio_estoque');

    // Elementos de filtro
    const filtroStatus = document.getElementById('filtro_status_estoque');
    const filtroModelo = document.getElementById('filtro_modelo_estoque');
    const filtroCor = document.getElementById('filtro_cor_estoque');
    const filtroPotencia = document.getElementById('filtro_potencia_estoque');

    // Carregar ao abrir modal
    modal.addEventListener('show.bs.modal', function() {
        carregarOpcoesFiltros();
        carregarDados();
    });

    // Aplicar filtros em tempo real
    [filtroStatus, filtroModelo, filtroCor, filtroPotencia].forEach(elem => {
        elem.addEventListener('change', carregarDados);
    });

    // Carregar opÃ§Ãµes dos filtros
    function carregarOpcoesFiltros() {
        fetch("{{ url_for('motochefe.api_opcoes_filtros') }}")
            .then(res => res.json())
            .then(data => {
                filtroModelo.innerHTML = '<option value="">Todos</option>';
                data.modelos.forEach(modelo => {
                    filtroModelo.innerHTML += `<option value="${modelo}">${modelo}</option>`;
                });

                filtroCor.innerHTML = '<option value="">Todas</option>';
                data.cores.forEach(cor => {
                    filtroCor.innerHTML += `<option value="${cor}">${cor}</option>`;
                });

                filtroPotencia.innerHTML = '<option value="">Todas</option>';
                data.potencias.forEach(pot => {
                    filtroPotencia.innerHTML += `<option value="${pot}">${pot}</option>`;
                });
            })
            .catch(err => console.error('Erro ao carregar opÃ§Ãµes:', err));
    }

    // Carregar dados agrupados
    function carregarDados() {
        loadingDiv.style.display = 'block';
        accordionContainer.style.display = 'none';
        mensagemVazio.style.display = 'none';

        const params = new URLSearchParams({
            autopropelido_sim: 'true',
            autopropelido_nao: 'true',
            status: filtroStatus.value,
            modelo: filtroModelo.value,
            cor: filtroCor.value,
            potencia: filtroPotencia.value
        });

        fetch(`{{ url_for('motochefe.api_motos_agrupamento') }}?${params}`)
            .then(res => res.json())
            .then(dados => {
                loadingDiv.style.display = 'none';

                if (dados.length === 0) {
                    mensagemVazio.style.display = 'block';
                    return;
                }

                renderizarAccordions(dados);
                accordionContainer.style.display = 'block';
            })
            .catch(err => {
                console.error('Erro ao carregar dados:', err);
                loadingDiv.style.display = 'none';
                mensagemVazio.style.display = 'block';
            });
    }

    // Renderizar accordions
    function renderizarAccordions(dados) {
        let html = '<div class="accordion" id="accordionModelos">';

        dados.forEach((modelo, idxModelo) => {
            const modeloId = `modelo_est_${idxModelo}`;

            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${modeloId}">
                            <strong>${modelo.modelo}</strong>
                            <span class="badge bg-info ms-2">${modelo.quantidade} motos</span>
                            <span class="badge bg-success ms-2">R$ ${formatarValorBR(modelo.preco_tabela || 0)}</span>
                            ${modelo.autopropelido ? '<span class="badge bg-warning text-dark ms-1">Autopropelida</span>' : ''}
                        </button>
                    </h2>
                    <div id="${modeloId}" class="accordion-collapse collapse" data-bs-parent="#accordionModelos">
                        <div class="accordion-body">
                            ${renderizarCores(modelo.cores, modeloId)}
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        accordionContainer.innerHTML = html;
    }

    // Renderizar Cores
    function renderizarCores(cores, parentId) {
        let html = '<div class="accordion" id="accordion_' + parentId + '">';

        cores.forEach((cor, idxCor) => {
            const corId = `${parentId}_cor_${idxCor}`;

            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${corId}">
                            <i class="fas fa-square" style="color:${getCorHex(cor.cor)}"></i>
                            <strong class="ms-2">${cor.cor}</strong>
                            <span class="badge bg-secondary ms-2">${cor.quantidade} motos</span>
                        </button>
                    </h2>
                    <div id="${corId}" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul class="list-group">
            `;

            cor.potencias.forEach(pot => {
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <strong>${pot.potencia}</strong>
                        <span class="badge bg-info">${pot.quantidade} motos</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="mostrarMotosEstoque(${JSON.stringify(pot.motos).replace(/"/g, '&quot;')}, '${pot.potencia}', '${cor.cor}')">
                            <i class="fas fa-eye"></i> Ver Chassi
                        </button>
                    </li>
                `;
            });

            html += `
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        return html;
    }

    function getCorHex(cor) {
        const cores = {
            'Preta': '#000000',
            'Branca': '#FFFFFF',
            'Vermelha': '#DC3545',
            'Azul': '#0D6EFD',
            'Verde': '#198754',
            'Amarela': '#FFC107',
            'Laranja': '#FD7E14',
            'Cinza': '#6C757D',
            'Prata': '#ADB5BD'
        };
        return cores[cor] || '#6C757D';
    }

    function formatarValorBR(valor) {
        return parseFloat(valor).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&.').replace('.', ',');
    }

    window.mostrarMotosEstoque = function(motos, potencia, cor) {
        let html = `
            <div class="modal fade" id="modalListaMotosEstoque" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-motorcycle"></i> Lista de Motos - ${cor} ${potencia}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Chassi</th>
                                        <th>Motor</th>
                                        <th>Ano</th>
                                        <th>NF</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
        `;

        motos.forEach(moto => {
            const statusClass = moto.status === 'DISPONIVEL' ? 'success' : moto.status === 'RESERVADA' ? 'warning' : 'danger';

            html += `
                <tr>
                    <td><code>${moto.chassi}</code></td>
                    <td><code>${moto.motor}</code></td>
                    <td>${moto.ano || '-'}</td>
                    <td>${moto.nf}</td>
                    <td><span class="badge bg-${statusClass}">${moto.status}</span></td>
                </tr>
            `;
        });

        html += `
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const oldModal = document.getElementById('modalListaMotosEstoque');
        if (oldModal) oldModal.remove();

        document.body.insertAdjacentHTML('beforeend', html);

        const modalInstance = new bootstrap.Modal(document.getElementById('modalListaMotosEstoque'));
        modalInstance.show();

        document.getElementById('modalListaMotosEstoque').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    };
})();
</script>
{% endblock %}
