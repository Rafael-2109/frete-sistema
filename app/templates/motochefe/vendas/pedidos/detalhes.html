{% extends "base.html" %}



{% block title %}Detalhes do Pedido {{ pedido.numero_pedido }} - MotoChefe{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Cabe√ßalho -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-shopping-cart"></i> Pedido {{ pedido.numero_pedido }}</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('motochefe.listar_pedidos') }}">Pedidos</a></li>
                            <li class="breadcrumb-item active">{{ pedido.numero_pedido }}</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    {# üÜï Bot√£o Imprimir Pedido #}
                    <a href="{{ url_for('motochefe.imprimir_pedido', id=pedido.id) }}"
                       class="btn btn-secondary btn-lg"
                       target="_blank">
                        <i class="fas fa-print"></i> Imprimir Pedido
                        {% if pedido.impresso %}
                        <span class="badge bg-success ms-2">
                            <i class="fas fa-check"></i> Impresso
                        </span>
                        {% endif %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card {% if pedido.faturado %}border-success{% else %}border-warning{% endif %}">
                <div class="card-body text-center">
                    <h6>Status Faturamento</h6>
                    {% if pedido.faturado %}
                        <h4 class="text-success"><i class="fas fa-check-circle"></i> FATURADO</h4>
                        {% if pedido.numero_nf %}
                            <p class="mb-0">NF: {{ pedido.numero_nf }}</p>
                            <small>{{ pedido.data_nf.strftime('%d/%m/%Y') if pedido.data_nf else '' }}</small>
                        {% endif %}
                    {% else %}
                        <h4 class="text-warning"><i class="fas fa-clock"></i> PENDENTE</h4>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card {% if pedido.enviado %}border-success{% else %}border-secondary{% endif %}">
                <div class="card-body text-center">
                    <h6>Status Envio</h6>
                    {% if pedido.enviado %}
                        <h4 class="text-success"><i class="fas fa-truck"></i> ENVIADO</h4>
                    {% else %}
                        <h4 class="text-secondary"><i class="fas fa-box"></i> N√ÉO ENVIADO</h4>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card {% if pedido.impresso %}border-success{% else %}border-warning{% endif %}">
                <div class="card-body text-center">
                    <h6>Status Impress√£o</h6>
                    {% if pedido.impresso %}
                        <h4 class="text-success"><i class="fas fa-print"></i> IMPRESSO</h4>
                        <p class="mb-0" style="font-size: 0.85rem;">
                            {{ pedido.impresso_em.strftime('%d/%m/%Y √†s %H:%M') if pedido.impresso_em else '-' }}
                        </p>
                        <small class="text-muted">por {{ pedido.impresso_por or 'N/A' }}</small>
                    {% else %}
                        <h4 class="text-warning"><i class="fas fa-clock"></i> N√ÉO IMPRESSO</h4>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h6>Valor Total</h6>
                    <h3 class="text-primary mb-0">R$ {{ pedido.valor_total_pedido|float|valor_br }}</h3>
                    {% if pedido.valor_frete_cliente > 0 %}
                        <small class="text-muted">+ Frete: R$ {{ pedido.valor_frete_cliente|float|valor_br }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Informa√ß√µes do Pedido -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-info-circle"></i> Informa√ß√µes do Pedido
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <th width="40%">N√∫mero Pedido:</th>
                            <td><strong>{{ pedido.numero_pedido }}</strong></td>
                        </tr>
                        <tr>
                            <th>Data Pedido:</th>
                            <td>{{ pedido.data_pedido.strftime('%d/%m/%Y') }}</td>
                        </tr>
                        {% if pedido.data_expedicao %}
                        <tr>
                            <th>Data Expedi√ß√£o:</th>
                            <td>{{ pedido.data_expedicao.strftime('%d/%m/%Y') }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Forma Pagamento:</th>
                            <td>{{ pedido.forma_pagamento or 'N√£o informada' }}</td>
                        </tr>
                        <tr>
                            <th>Condi√ß√£o Pagamento:</th>
                            <td>{{ pedido.condicao_pagamento or 'N√£o informada' }}</td>
                        </tr>
                        <tr>
                            <th>Tipo Frete:</th>
                            <td>{{ pedido.tipo_frete or '-' }}</td>
                        </tr>
                        {% if pedido.transportadora %}
                        <tr>
                            <th>Transportadora:</th>
                            <td>{{ pedido.transportadora.transportadora }}</td>
                        </tr>
                        {% endif %}
                        {% if pedido.responsavel_movimentacao %}
                        <tr>
                            <th>Respons√°vel Movimenta√ß√£o:</th>
                            <td>{{ pedido.responsavel_movimentacao }}</td>
                        </tr>
                        {% endif %}
                        {% if pedido.observacoes %}
                        <tr>
                            <th>Observa√ß√µes:</th>
                            <td><em>{{ pedido.observacoes }}</em></td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- Informa√ß√µes do Cliente -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-user"></i> Cliente
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <th width="40%">Nome:</th>
                            <td><strong>{{ pedido.cliente.cliente }}</strong></td>
                        </tr>
                        <tr>
                            <th>CNPJ:</th>
                            <td>{{ pedido.cliente.cnpj_cliente }}</td>
                        </tr>
                        {% if pedido.cliente.telefone %}
                        <tr>
                            <th>Telefone:</th>
                            <td>{{ pedido.cliente.telefone }}</td>
                        </tr>
                        {% endif %}
                        {% if pedido.cliente.endereco %}
                        <tr>
                            <th>Endere√ßo:</th>
                            <td>{{ pedido.cliente.endereco }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- Informa√ß√µes do Vendedor -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-user-tie"></i> Vendedor
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <th width="40%">Vendedor:</th>
                            <td><strong>{{ pedido.vendedor.vendedor }}</strong></td>
                        </tr>
                        {% if pedido.equipe %}
                        <tr>
                            <th>Equipe:</th>
                            <td>{{ pedido.equipe.equipe_vendas }}</td>
                        </tr>
                        {% endif %}
                        {% if pedido.vendedor.telefone %}
                        <tr>
                            <th>Telefone:</th>
                            <td>{{ pedido.vendedor.telefone }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>

        <!-- Itens do Pedido -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <i class="fas fa-motorcycle"></i> Motos do Pedido ({{ pedido.quantidade_motos }} unidade(s))
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th>Chassi</th>
                                <th>Modelo</th>
                                <th>Cor</th>
                                <th class="text-right">Pre√ßo Venda</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in pedido.itens %}
                            <tr>
                                <td><small>{{ item.numero_chassi }}</small></td>
                                <td>{{ item.moto.modelo.nome_modelo }}</td>
                                <td>{{ item.moto.cor }}</td>
                                <td class="text-right">R$ {{ item.preco_venda|float|valor_br }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary"
                                        data-chassi="{{ item.numero_chassi }}"
                                        data-modelo="{{ item.moto.modelo.nome_modelo }}"
                                        data-cor="{{ item.moto.cor }}"
                                        data-preco="{{ item.preco_venda|float }}"
                                        onclick="abrirModalSubstituicao(this)">
                                        <i class="fas fa-exchange-alt"></i> Substituir
                                    </button>
                                </td>
                            </tr>
                            {% if item.montagem_contratada %}
                            <tr class="table-secondary">
                                <td colspan="3">
                                    <small>
                                        <i class="fas fa-tools"></i> Montagem
                                        {% if item.fornecedor_montagem %}
                                            - {{ item.fornecedor_montagem }}
                                        {% endif %}
                                        {% if item.montagem_paga %}
                                            <span class="badge bg-success ml-2">PAGA</span>
                                        {% else %}
                                            <span class="badge bg-warning ml-2">PENDENTE</span>
                                        {% endif %}
                                    </small>
                                </td>
                                <td class="text-right"><small>+ R$ {{ item.valor_montagem|float|valor_br }}</small></td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                        <tfoot class="font-weight-bold bg-light">
                            <tr>
                                <td colspan="3" class="text-right">TOTAL:</td>
                                <td class="text-right">R$ {{ pedido.valor_total_pedido|float|valor_br }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- T√≠tulos Financeiros -->
            {% if pedido.titulos %}
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-file-invoice"></i> T√≠tulos Financeiros ({{ pedido.titulos|length }})
                    <small class="text-muted">- Sistema por Moto + Tipo</small>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th>Chassi</th>
                                <th>Tipo</th>
                                <th>Parcela</th>
                                <th>Vencimento</th>
                                <th class="text-right">Valor Saldo</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in pedido.titulos %}
                            <tr>
                                <td>
                                    {% if t.numero_chassi %}
                                        <small>{{ t.numero_chassi[-6:] }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-primary">{{ t.tipo_titulo }}</span></td>
                                <td>{{ t.numero_parcela }}</td>
                                <td>
                                    {% if t.data_vencimento %}
                                        {{ t.data_vencimento.strftime('%d/%m/%Y') }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-right">R$ {{ t.valor_saldo|float|valor_br }}</td>
                                <td>
                                    {% if t.status == 'PAGO' %}
                                        <span class="badge bg-success">PAGO</span>
                                    {% elif t.status == 'ABERTO' %}
                                        <span class="badge bg-warning">ABERTO</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ t.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('motochefe.detalhes_titulo', id=t.id) }}" class="btn btn-sm btn-info" title="Ver Detalhes">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Comiss√µes -->
            {% if pedido.comissoes %}
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-percent"></i> Comiss√µes ({{ pedido.comissoes|length }})
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th>Vendedor</th>
                                <th class="text-right">Valor</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in pedido.comissoes %}
                            <tr>
                                <td>{{ c.vendedor.vendedor }}</td>
                                <td class="text-right">R$ {{ c.valor_rateado|float|valor_br }}</td>
                                <td>
                                    {% if c.status == 'PAGO' %}
                                        <span class="badge bg-success">PAGO</span>
                                    {% else %}
                                        <span class="badge bg-warning">PENDENTE</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('motochefe.detalhes_comissao', id=c.id) }}" class="btn btn-sm btn-info" title="Ver Detalhes">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Montagens Detalhadas (se houver) -->
    {% set montagens = pedido.itens|selectattr('montagem_contratada')|list %}
    {% if montagens %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <i class="fas fa-tools"></i> Detalhes das Montagens
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th>Chassi</th>
                                <th>Fornecedor Montagem</th>
                                <th class="text-right">Valor</th>
                                <th>Data Pagamento</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in montagens %}
                            <tr>
                                <td><small>{{ item.numero_chassi }}</small></td>
                                <td>{{ item.fornecedor_montagem or 'N√£o informado' }}</td>
                                <td class="text-right">R$ {{ item.valor_montagem|float|valor_br }}</td>
                                <td>
                                    {% if item.data_pagamento_montagem %}
                                        {{ item.data_pagamento_montagem.strftime('%d/%m/%Y') }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.montagem_paga %}
                                        <span class="badge bg-success">PAGA</span>
                                    {% else %}
                                        <span class="badge bg-warning">PENDENTE</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="font-weight-bold">
                            <tr>
                                <td colspan="2" class="text-right">TOTAL MONTAGENS:</td>
                                <td class="text-right">R$ {{ (montagens|sum(attribute='valor_montagem'))|valor_br }}</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Bot√µes de A√ß√£o -->
    <div class="row mt-4">
        <div class="col-md-12">
            <a href="{{ url_for('motochefe.listar_pedidos') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar para Lista
            </a>
            <a href="{{ url_for('motochefe.extrato_financeiro') }}" class="btn btn-info">
                <i class="fas fa-file-invoice-dollar"></i> Ver Extrato Financeiro
            </a>
        </div>
    </div>
</div>

<!-- Modal Sele√ß√£o de Moto para Substitui√ß√£o -->
<div class="modal fade" id="modalSelecaoMoto" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-exchange-alt"></i> Substituir Moto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Moto a ser substitu√≠da -->
                <div class="card mb-3 border-danger">
                    <div class="card-header bg-danger text-white">
                        <strong>Moto a ser Substitu√≠da</strong>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3"><strong>Chassi:</strong> <span id="chassiAtual"></span></div>
                            <div class="col-md-3"><strong>Modelo:</strong> <span id="modeloAtual"></span></div>
                            <div class="col-md-3"><strong>Cor:</strong> <span id="corAtual"></span></div>
                            <div class="col-md-3"><strong>Pre√ßo:</strong> R$ <span id="precoAtual"></span></div>
                        </div>
                    </div>
                </div>

                <!-- Loading -->
                <div id="loadingMotos" class="text-center py-4" style="display:none;">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2">Carregando motos dispon√≠veis...</p>
                </div>

                <!-- Accordion de Motos Dispon√≠veis -->
                <div id="accordionMotos"></div>

                <!-- Mensagem vazia -->
                <div id="mensagemVazio" class="alert alert-warning" style="display:none;">
                    Nenhuma moto dispon√≠vel para substitui√ß√£o.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirma√ß√£o de Substitui√ß√£o -->
<div class="modal fade" id="modalConfirmacaoSubstituicao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="formSubstituicao" action="{{ url_for('motochefe.substituir_moto', pedido_id=pedido.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="chassi_antigo" id="chassiAntigoForm"/>
                <input type="hidden" name="chassi_novo" id="chassiNovoForm"/>

                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirmar Substitui√ß√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Valores</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Pre√ßo Moto Atual:</label>
                            <input type="text" class="form-control" id="precoAntigoForm" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Pre√ßo Moto Nova: <span class="text-danger">*</span></label>
                            <input type="number" step="0.01" class="form-control" name="preco_novo" id="precoNovoForm" required>
                            <small class="text-muted">Campo edit√°vel - voc√™ pode ajustar o valor se necess√°rio</small>
                        </div>
                    </div>

                    <h6>Motivo da Substitui√ß√£o <span class="text-danger">*</span></h6>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="motivo" id="motivoAvaria" value="AVARIA" required>
                            <label class="form-check-label" for="motivoAvaria">
                                <strong>Avaria</strong> - A moto atual ser√° marcada como AVARIADO
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="motivo" id="motivoOutros" value="OUTROS" required>
                            <label class="form-check-label" for="motivoOutros">
                                <strong>Outros</strong> - A moto atual volta para DISPONIVEL
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Observa√ß√£o: <span class="text-danger">*</span></label>
                        <textarea name="observacao" class="form-control" rows="3" required placeholder="Descreva o motivo da substitui√ß√£o..."></textarea>
                    </div>

                    <div class="alert alert-info">
                        <small><i class="fas fa-info-circle"></i> <strong>Importante:</strong>
                        Se o valor da moto nova for diferente, o t√≠tulo financeiro ser√° ajustado automaticamente.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-exchange-alt"></i> Confirmar Substitui√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Fun√ß√£o helper para formatar valores monet√°rios no padr√£o brasileiro
function formatarValorBR(valor, decimais = 2) {
    if (valor === null || valor === undefined) return '0,00';
    const numero = parseFloat(valor);
    if (isNaN(numero)) return '0,00';

    // Formatar com decimais e substituir separadores
    return numero.toFixed(decimais)
        .replace(/\d(?=(\d{3})+\.)/g, '$&.')  // Adiciona ponto a cada 3 d√≠gitos
        .replace('.', ',');  // Troca ponto por v√≠rgula no decimal
}

let chassiAtualGlobal = '';
let precoAtualGlobal = 0;

function abrirModalSubstituicao(button) {
    const chassi = button.getAttribute('data-chassi');
    const modelo = button.getAttribute('data-modelo');
    const cor = button.getAttribute('data-cor');
    const preco = parseFloat(button.getAttribute('data-preco'));

    // Armazenar globalmente
    chassiAtualGlobal = chassi;
    precoAtualGlobal = preco;

    // Preencher dados da moto atual
    document.getElementById('chassiAtual').textContent = chassi;
    document.getElementById('modeloAtual').textContent = modelo;
    document.getElementById('corAtual').textContent = cor;
    document.getElementById('precoAtual').textContent = formatarValorBR(preco);

    // Carregar motos dispon√≠veis
    carregarMotosDisponiveis(chassi);

    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalSelecaoMoto'));
    modal.show();
}

function carregarMotosDisponiveis(chassiAtual) {
    const loadingDiv = document.getElementById('loadingMotos');
    const accordionDiv = document.getElementById('accordionMotos');
    const mensagemVazio = document.getElementById('mensagemVazio');

    // Mostrar loading
    loadingDiv.style.display = 'block';
    accordionDiv.style.display = 'none';
    mensagemVazio.style.display = 'none';

    // Buscar motos
    fetch(`/motochefe/pedidos/{{ pedido.id }}/motos-disponiveis/${chassiAtual}`)
        .then(res => res.json())
        .then(data => {
            loadingDiv.style.display = 'none';

            // Verificar se h√° motos
            const totalMotos = Object.values(data).reduce((sum, arr) => sum + arr.length, 0);
            if (totalMotos === 0) {
                mensagemVazio.style.display = 'block';
                return;
            }

            // Renderizar accordion
            renderizarAccordionMotos(data);
            accordionDiv.style.display = 'block';
        })
        .catch(err => {
            console.error('Erro ao carregar motos:', err);
            loadingDiv.style.display = 'none';
            mensagemVazio.style.display = 'block';
        });
}

function renderizarAccordionMotos(dados) {
    const accordion = document.getElementById('accordionMotos');
    let html = '<div class="accordion" id="accordionPrioridades">';

    // Prioridade 1: Mesmo modelo + mesma cor
    if (dados.mesmo_modelo_mesma_cor && dados.mesmo_modelo_mesma_cor.length > 0) {
        html += criarGrupoAccordion('prioridade1', 'Mesmo Modelo + Mesma Cor', dados.mesmo_modelo_mesma_cor, 'success');
    }

    // Prioridade 2: Mesmo modelo
    if (dados.mesmo_modelo && dados.mesmo_modelo.length > 0) {
        html += criarGrupoAccordion('prioridade2', 'Mesmo Modelo', dados.mesmo_modelo, 'primary');
    }

    // Prioridade 3: Mesma cor
    if (dados.mesma_cor && dados.mesma_cor.length > 0) {
        html += criarGrupoAccordion('prioridade3', 'Mesma Cor', dados.mesma_cor, 'info');
    }

    // Prioridade 4: Outros
    if (dados.outros && dados.outros.length > 0) {
        html += criarGrupoAccordion('prioridade4', 'Outros Modelos e Cores', dados.outros, 'secondary');
    }

    html += '</div>';
    accordion.innerHTML = html;
}

function criarGrupoAccordion(id, titulo, motos, cor) {
    let html = `
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${id}">
                    <strong>${titulo}</strong>
                    <span class="badge bg-${cor} ms-2">${motos.length} motos</span>
                </button>
            </h2>
            <div id="${id}" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Chassi</th>
                                <th>Modelo</th>
                                <th>Cor</th>
                                <th>Pre√ßo</th>
                                <th>Ano</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
    `;

    motos.forEach(moto => {
        html += `
            <tr>
                <td><code>${moto.chassi}</code></td>
                <td>${moto.modelo}<br><small class="text-muted">${moto.potencia}</small></td>
                <td>${moto.cor}</td>
                <td>R$ ${formatarValorBR(moto.preco_tabela)}</td>
                <td>${moto.ano || '-'}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-success" onclick="selecionarMoto('${moto.chassi}', ${moto.preco_tabela})">
                        <i class="fas fa-check"></i> Substituir
                    </button>
                </td>
            </tr>
        `;
    });

    html += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    return html;
}

function selecionarMoto(chassiNovo, precoNovo) {
    // Fechar modal de sele√ß√£o
    const modalSelecao = bootstrap.Modal.getInstance(document.getElementById('modalSelecaoMoto'));
    modalSelecao.hide();

    // Preencher formul√°rio de confirma√ß√£o
    document.getElementById('chassiAntigoForm').value = chassiAtualGlobal;
    document.getElementById('chassiNovoForm').value = chassiNovo;
    document.getElementById('precoAntigoForm').value = `R$ ${formatarValorBR(precoAtualGlobal)}`;
    // Campo edit√°vel - preencher apenas o valor num√©rico
    document.getElementById('precoNovoForm').value = precoNovo.toFixed(2);

    // Abrir modal de confirma√ß√£o
    const modalConfirmacao = new bootstrap.Modal(document.getElementById('modalConfirmacaoSubstituicao'));
    modalConfirmacao.show();
}
</script>
{% endblock %}
