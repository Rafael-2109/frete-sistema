{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="fas fa-file-invoice"></i>
                {% if pedido %}Editar Pedido{% else %}Novo Pedido de Venda{% endif %}
            </h4>
        </div>
        <div class="card-body">
            <form method="POST" id="formPedido">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="itens_json" id="itens_json"/>
                <input type="hidden" name="parcelas_json" id="parcelas_json"/>
                <input type="hidden" name="valor_total_pedido" id="valor_total_pedido"/>

                <!-- Dados Gerais -->
                <h5 class="mb-3"><i class="fas fa-info-circle"></i> Dados Gerais</h5>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Nº Pedido *</label>
                        <div class="input-group">
                            <input type="text" name="numero_pedido" id="numero_pedido" class="form-control"
                                   value="{{ pedido.numero_pedido if pedido else '' }}" required
                                   placeholder="Ex: MC 1321">
                            <button type="button" class="btn btn-info" onclick="buscarProximoNumero()" title="Gerar próximo número">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <small class="text-muted">Campo editável - Clique no botão para gerar automaticamente</small>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Data Pedido *</label>
                        <input type="date" name="data_pedido" class="form-control"
                               value="{{ pedido.data_pedido.strftime('%Y-%m-%d') if pedido and pedido.data_pedido else today }}" required readonly>
                        <small class="text-muted">Data de criação do pedido (automática)</small>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Data Entrega / Coleta</label>
                        <input type="date" name="data_expedicao" class="form-control"
                               value="{{ pedido.data_expedicao.strftime('%Y-%m-%d') if pedido and pedido.data_expedicao else '' }}" required>
                        <small class="text-muted">Data de entrega ou coleta (obrigatória)</small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Equipe de Vendas *</label>
                        <select name="equipe_vendas_id" id="sel_equipe" class="form-select" required>
                            <option value="">Selecione...</option>
                            {% for e in equipes %}
                            <option value="{{ e.id }}"
                                    data-permitir-prazo="{{ e.permitir_prazo|lower }}"
                                    data-permitir-parcelamento="{{ e.permitir_parcelamento|lower }}"
                                    data-permitir-montagem="{{ e.permitir_montagem|lower }}">
                                {{ e.equipe_vendas }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Vendedor *</label>
                        <select name="vendedor_id" id="sel_vendedor" class="form-select" required disabled>
                            <option value="">Selecione equipe primeiro...</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Cliente *</label>
                        <select name="cliente_id" id="sel_cliente" class="form-select" required disabled>
                            <option value="">Selecione vendedor primeiro...</option>
                        </select>
                    </div>
                </div>

                <!-- Campo de Prazo (condicional) -->
                <div class="row" id="div_prazo" style="display: none;">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Prazo (dias) *</label>
                        <input type="number" name="prazo_dias" id="input_prazo" class="form-control" min="0" value="0">
                        <small class="text-muted">Dias após data de expedição</small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 mb-3" id="div_tipo_frete">
                        <label class="form-label">Tipo Frete</label>
                        <select name="tipo_frete" id="sel_tipo_frete" class="form-select">
                            <option value="">Selecione...</option>
                            <option value="CIF">CIF</option>
                            <option value="FOB">FOB</option>
                        </select>
                        <small class="text-muted">Transportadora será definida ao alocar no embarque</small>
                    </div>
                    <div class="col-md-3 mb-3" id="div_valor_frete" style="display: none;">
                        <label class="form-label">Valor Frete Cliente</label>
                        <input type="number" step="0.01" name="valor_frete_cliente" id="input_frete" class="form-control" value="0">
                        <small class="text-muted">Apenas para CIF</small>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Observações</label>
                    <textarea name="observacoes" class="form-control" rows="2"></textarea>
                </div>

                <hr class="my-4">

                <!-- Adicionar Item -->
                <div class="d-flex align-items-center gap-3 mb-3">
                    <button type="button" class="btn btn-info" id="btnVisualizarEstoque" data-bs-toggle="modal" data-bs-target="#modalEstoqueAgrupamento" style="display:none;">
                        <i class="fas fa-layer-group"></i> Visualizar Estoque
                    </button>
                    <h5 class="mb-0"><i class="fas fa-motorcycle"></i> Itens do Pedido</h5>
                </div>
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Modelo</label>
                                <select id="sel_modelo" class="form-select">
                                    <option value="">Selecione...</option>
                                    {% for m in modelos %}
                                    <option value="{{ m.id }}"
                                            data-preco="{{ m.preco_tabela }}"
                                            data-nome="{{ m.nome_modelo }}"
                                            data-potencia="{{ m.potencia_motor }}">
                                        {{ m.nome_modelo }} (R$ {{ m.preco_tabela|valor_br }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Cor *</label>
                                <select id="sel_cor" class="form-select" required>
                                    <option value="">Selecione modelo primeiro...</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Quantidade</label>
                                <input type="number" id="txt_qtd" class="form-control" min="1" value="1">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Preço Venda</label>
                                <input type="number" step="0.01" id="txt_preco" class="form-control">
                            </div>
                        </div>
                        <div id="div_montagem" style="display: none;">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" id="chk_montagem" class="form-check-input">
                                        <label class="form-check-label">Montagem Contratada</label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Valor Montagem</label>
                                    <input type="number" step="0.01" id="txt_valor_montagem" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" class="btn btn-primary" onclick="adicionarItem()">
                                    <i class="fas fa-plus"></i> Adicionar Item
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Itens -->
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Modelo</th>
                            <th>Cor</th>
                            <th>Qtd</th>
                            <th>Preço Un</th>
                            <th>Montagem</th>
                            <th>Total</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="tbody_itens">
                        <tr id="tr_vazio">
                            <td colspan="7" class="text-center text-muted">Nenhum item adicionado</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="5" class="text-end">TOTAL DO PEDIDO:</th>
                            <th id="td_total">R$ 0,00</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>

                <div id="div_parcelas" style="display: none;">
                    <hr class="my-4">

                    <!-- Parcelamento -->
                    <h5 class="mb-3"><i class="fas fa-calendar-alt"></i> Parcelamento</h5>
                    <div class="card mb-3">
                        <div class="card-body">
                            <button type="button" class="btn btn-sm btn-primary" onclick="adicionarParcela()">
                                <i class="fas fa-plus"></i> Adicionar Parcela
                            </button>
                            <table class="table table-sm mt-3">
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>Valor (R$)</th>
                                        <th>Prazo (dias)</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="tbody_parcelas">
                                    <tr id="tr_parcelas_vazio">
                                        <td colspan="4" class="text-center text-muted">Nenhuma parcela cadastrada</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save"></i> Salvar Pedido
                    </button>
                    <a href="{{ url_for('motochefe.listar_pedidos') }}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Função helper para formatar valores monetários no padrão brasileiro
function formatarValorBR(valor, decimais = 2) {
    if (valor === null || valor === undefined) return '0,00';
    const numero = parseFloat(valor);
    if (isNaN(numero)) return '0,00';

    // Formatar com decimais e substituir separadores
    return numero.toFixed(decimais)
        .replace(/\d(?=(\d{3})+\.)/g, '$&.')  // Adiciona ponto a cada 3 dígitos
        .replace('.', ',');  // Troca ponto por vírgula no decimal
}

let itens = [];
let parcelas = [];
let cliente_crossdocking = false;

// 🆕 CASCATA: Equipe → Vendedor
document.getElementById('sel_equipe').addEventListener('change', async function() {
    const equipeId = this.value;
    const selVendedor = document.getElementById('sel_vendedor');
    const selCliente = document.getElementById('sel_cliente');

    selVendedor.innerHTML = '<option value="">Carregando...</option>';
    selVendedor.disabled = true;
    selCliente.innerHTML = '<option value="">Selecione vendedor primeiro...</option>';
    selCliente.disabled = true;

    if (!equipeId) {
        selVendedor.innerHTML = '<option value="">Selecione equipe primeiro...</option>';
        return;
    }

    const response = await fetch(`/motochefe/api/vendedores-por-equipe?equipe_id=${equipeId}`);
    const vendedores = await response.json();

    selVendedor.innerHTML = '<option value="">Selecione...</option>';
    vendedores.forEach(v => {
        selVendedor.innerHTML += `<option value="${v.id}">${v.vendedor}</option>`;
    });
    selVendedor.disabled = false;

    const option = this.options[this.selectedIndex];
    const permitirMontagem = option.dataset.permitirMontagem === 'true';
    const permitirPrazo = option.dataset.permitirPrazo === 'true';
    const permitirParcelamento = option.dataset.permitirParcelamento === 'true';

    const divMontagem = document.getElementById('div_montagem');
    if (divMontagem) {
        divMontagem.style.display = permitirMontagem ? 'block' : 'none';
    }

    const divPrazo = document.getElementById('div_prazo');
    const divParcelas = document.getElementById('div_parcelas');

    // Lógica de exibição:
    // - permitir_prazo=False: À vista (sem prazo, sem parcelas)
    // - permitir_prazo=True, permitir_parcelamento=False: Prazo único (1 vencimento)
    // - permitir_prazo=True, permitir_parcelamento=True: Prazo E parcelas (múltiplos vencimentos)

    if (!permitirPrazo) {
        // À vista: esconde tudo
        if (divPrazo) divPrazo.style.display = 'none';
        if (divParcelas) divParcelas.style.display = 'none';
        // Limpar parcelas
        parcelas = [];
        atualizarTabelaParcelas();
    } else {
        // COM prazo
        if (divPrazo) divPrazo.style.display = 'block';

        if (permitirParcelamento) {
            // COM parcelamento: mostrar seção de parcelas
            if (divParcelas) divParcelas.style.display = 'block';
        } else {
            // SEM parcelamento: esconder seção, limpar array
            if (divParcelas) divParcelas.style.display = 'none';
            parcelas = [];
            atualizarTabelaParcelas();
        }
    }
});

// 🆕 CASCATA: Vendedor → Cliente
document.getElementById('sel_vendedor').addEventListener('change', async function() {
    const vendedorId = this.value;
    const selCliente = document.getElementById('sel_cliente');
    const btnEstoque = document.getElementById('btnVisualizarEstoque');

    selCliente.innerHTML = '<option value="">Carregando...</option>';
    selCliente.disabled = true;

    if (!vendedorId) {
        selCliente.innerHTML = '<option value="">Selecione vendedor primeiro...</option>';
        // Esconder botão de visualizar estoque
        if (btnEstoque) btnEstoque.style.display = 'none';
        return;
    }

    // Mostrar botão de visualizar estoque
    if (btnEstoque) btnEstoque.style.display = 'inline-block';

    const response = await fetch(`/motochefe/api/clientes-por-vendedor?vendedor_id=${vendedorId}`);
    const clientes = await response.json();

    selCliente.innerHTML = '<option value="">Selecione...</option>';
    clientes.forEach(c => {
        selCliente.innerHTML += `<option value="${c.id}" data-crossdocking="${c.crossdocking}">${c.cliente} - ${c.cnpj}</option>`;
    });
    selCliente.disabled = false;
});

// 🆕 EVENTO: Cliente → CrossDocking
document.getElementById('sel_cliente').addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    cliente_crossdocking = option.dataset.crossdocking === 'true';

    const divTipoFrete = document.getElementById('div_tipo_frete');
    const divValorFrete = document.getElementById('div_valor_frete');

    if (divTipoFrete) {
        divTipoFrete.style.display = cliente_crossdocking ? 'none' : 'block';
    }

    // Se crossdocking=true, ocultar também valor frete
    if (cliente_crossdocking && divValorFrete) {
        divValorFrete.style.display = 'none';
    }
});

// 🆕 EVENTO: Tipo Frete → Valor Frete (exibe apenas se CIF)
document.getElementById('sel_tipo_frete').addEventListener('change', function() {
    const tipoFrete = this.value;
    const divValorFrete = document.getElementById('div_valor_frete');

    if (divValorFrete) {
        divValorFrete.style.display = (tipoFrete === 'CIF') ? 'block' : 'none';

        // Se FOB ou vazio, zerar valor frete
        if (tipoFrete !== 'CIF') {
            document.getElementById('input_frete').value = '0';
            atualizarTabelaItens(); // Recalcular total
        }
    }
});

// Buscar cores ao selecionar modelo
document.getElementById('sel_modelo').addEventListener('change', async function() {
    const modeloId = this.value;
    const precoTabela = this.options[this.selectedIndex]?.dataset.preco || 0;
    document.getElementById('txt_preco').value = precoTabela;

    const selCor = document.getElementById('sel_cor');

    if (!modeloId) {
        selCor.innerHTML = '<option value="">Selecione modelo primeiro...</option>';
        selCor.disabled = true;
        return;
    }

    const response = await fetch(`/motochefe/api/cores-disponiveis?modelo_id=${modeloId}`);
    const cores = await response.json();

    if (cores.length === 0) {
        selCor.innerHTML = '<option value="">Sem estoque disponível</option>';
        selCor.disabled = true;
    } else {
        selCor.innerHTML = '<option value="">Selecione...</option>';
        cores.forEach(c => {
            selCor.innerHTML += `<option value="${c.cor}">${c.label}</option>`;
        });
        selCor.disabled = false;
    }
});

// Habilitar campo montagem
document.getElementById('chk_montagem').addEventListener('change', function() {
    document.getElementById('txt_valor_montagem').disabled = !this.checked;
    if (!this.checked) document.getElementById('txt_valor_montagem').value = '';
});

// Adicionar item
function adicionarItem() {
    const selModelo = document.getElementById('sel_modelo');
    const modelo_id = selModelo.value;
    const selectedOption = selModelo.options[selModelo.selectedIndex];
    const modelo_nome = selectedOption?.dataset.nome || selectedOption?.text || '';
    const selCor = document.getElementById('sel_cor');
    const cor = selCor.value;
    const quantidade = parseInt(document.getElementById('txt_qtd').value);
    const preco_venda = parseFloat(document.getElementById('txt_preco').value);
    const montagem = document.getElementById('chk_montagem').checked;
    const valor_montagem = montagem ? parseFloat(document.getElementById('txt_valor_montagem').value || 0) : 0;

    if (!modelo_id || !cor || !quantidade || !preco_venda) {
        alert('Preencha todos os campos do item');
        return;
    }

    const item = {
        modelo_id: parseInt(modelo_id),
        modelo_nome: modelo_nome,
        cor: cor,
        quantidade: quantidade,
        preco_venda: preco_venda,
        montagem: montagem,
        valor_montagem: valor_montagem,
        total: (preco_venda * quantidade) + (montagem ? valor_montagem * quantidade : 0)
    };

    itens.push(item);
    atualizarTabelaItens();
    limparFormItem();
}

function removerItem(index) {
    itens.splice(index, 1);
    atualizarTabelaItens();
}

function atualizarTabelaItens() {
    const tbody = document.getElementById('tbody_itens');
    const trVazio = document.getElementById('tr_vazio');

    if (itens.length === 0) {
        trVazio.style.display = '';
        tbody.innerHTML = '<tr id="tr_vazio"><td colspan="7" class="text-center text-muted">Nenhum item adicionado</td></tr>';
    } else {
        tbody.innerHTML = itens.map((item, index) => `
            <tr>
                <td>${item.modelo_nome}</td>
                <td>${item.cor}</td>
                <td>${item.quantidade}</td>
                <td>R$ ${formatarValorBR(item.preco_venda)}</td>
                <td>${item.montagem ? 'R$ ' + formatarValorBR(item.valor_montagem) : '-'}</td>
                <td>R$ ${formatarValorBR(item.total)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removerItem(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    const totalItens = itens.reduce((sum, item) => sum + item.total, 0);
    const frete = parseFloat(document.getElementById('input_frete')?.value || 0);
    const totalComFrete = totalItens + frete;

    document.getElementById('td_total').textContent = 'R$ ' + formatarValorBR(totalComFrete);
    document.getElementById('valor_total_pedido').value = totalComFrete.toFixed(2);
}

// Listener no frete
document.getElementById('input_frete').addEventListener('input', atualizarTabelaItens);

function limparFormItem() {
    document.getElementById('sel_modelo').value = '';
    document.getElementById('sel_cor').innerHTML = '<option value="">Selecione modelo primeiro...</option>';
    document.getElementById('sel_cor').disabled = true;
    document.getElementById('txt_qtd').value = '1';
    document.getElementById('txt_preco').value = '';
    document.getElementById('chk_montagem').checked = false;
    document.getElementById('txt_valor_montagem').value = '';
    document.getElementById('txt_valor_montagem').disabled = true;
}

// Parcelas
function adicionarParcela() {
    const numero = parcelas.length + 1;
    const total = parseFloat(document.getElementById('valor_total_pedido').value || 0);

    if (total === 0) {
        alert('Adicione itens ao pedido antes de criar parcelas');
        return;
    }

    const valorPorParcela = (total / numero).toFixed(2);

    // Adicionar nova parcela
    parcelas.push({
        numero: numero,
        valor: parseFloat(valorPorParcela),
        prazo_dias: 30  // Padrão 30 dias, EDITÁVEL pelo usuário
    });

    // ✅ RECALCULAR VALORES das parcelas (mantém prazo_dias editado)
    parcelas.forEach((p, index) => {
        p.numero = index + 1;
        p.valor = parseFloat(valorPorParcela);
        // NÃO recalcular prazo_dias - usuário pode ter editado
    });

    atualizarTabelaParcelas();
}

function removerParcela(index) {
    parcelas.splice(index, 1);
    // Renumerar
    parcelas.forEach((p, i) => p.numero = i + 1);
    atualizarTabelaParcelas();
}

function atualizarTabelaParcelas() {
    const tbody = document.getElementById('tbody_parcelas');
    
    if (parcelas.length === 0) {
        tbody.innerHTML = '<tr id="tr_parcelas_vazio"><td colspan="4" class="text-center text-muted">Nenhuma parcela cadastrada</td></tr>';
    } else {
        tbody.innerHTML = parcelas.map((p, index) => `
            <tr>
                <td>${p.numero}/${parcelas.length}</td>
                <td>
                    <input type="number" step="0.01" class="form-control form-control-sm" 
                           value="${p.valor}" onchange="parcelas[${index}].valor = parseFloat(this.value)">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${p.prazo_dias}" onchange="parcelas[${index}].prazo_dias = parseInt(this.value)">
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removerParcela(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

// Submit com validações
document.getElementById('formPedido').addEventListener('submit', function(e) {
    // Validação 1: Itens
    if (itens.length === 0) {
        e.preventDefault();
        alert('Adicione pelo menos um item ao pedido');
        return;
    }

    // Validação 2: Parcelas (se houver)
    if (parcelas.length > 0) {
        const totalPedido = parseFloat(document.getElementById('valor_total_pedido').value || 0);
        const totalParcelas = parcelas.reduce((sum, p) => sum + p.valor, 0);
        const diferenca = Math.abs(totalPedido - totalParcelas);

        // Tolerância de R$ 0.02 para arredondamentos
        if (diferenca > 0.02) {
            e.preventDefault();
            alert(
                `ERRO: Soma das parcelas (R$ ${formatarValorBR(totalParcelas)}) ` +
                `difere do total do pedido (R$ ${formatarValorBR(totalPedido)}).\n\n` +
                `Diferença: R$ ${formatarValorBR(diferenca)}\n\n` +
                `Ajuste os valores das parcelas.`
            );
            return;
        }

        // Validação 3: Prazo das parcelas
        const parcelasSemPrazo = parcelas.filter(p => !p.prazo_dias || p.prazo_dias <= 0);
        if (parcelasSemPrazo.length > 0) {
            e.preventDefault();
            alert('Todas as parcelas devem ter prazo em dias maior que 0');
            return;
        }
    }

    // Tudo OK: serializar dados
    document.getElementById('itens_json').value = JSON.stringify(itens);
    document.getElementById('parcelas_json').value = JSON.stringify(parcelas);
});

// Função para buscar próximo número de pedido
async function buscarProximoNumero() {
    try {
        const response = await fetch('/motochefe/pedidos/api/proximo-numero');
        const data = await response.json();
        document.getElementById('numero_pedido').value = data.numero;
    } catch (error) {
        console.error('Erro ao buscar próximo número:', error);
        alert('Erro ao gerar próximo número');
    }
}
</script>

<!-- Modal Visualizar Estoque -->
<div class="modal fade" id="modalEstoqueAgrupamento" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-layer-group"></i> Visualizar Estoque de Motos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- FILTROS -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <strong><i class="fas fa-filter"></i> Filtros</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Status:</label>
                                <select id="filtro_status_form" class="form-select form-select-sm">
                                    <option value="">Todos</option>
                                    <option value="DISPONIVEL" selected>Disponível</option>
                                    <option value="RESERVADA">Reservada</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Modelo:</label>
                                <select id="filtro_modelo_form" class="form-select form-select-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Cor:</label>
                                <select id="filtro_cor_form" class="form-select form-select-sm">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Potência:</label>
                                <select id="filtro_potencia_form" class="form-select form-select-sm">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LOADING -->
                <div id="loading_form" class="text-center py-5" style="display:none;">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted">Carregando dados...</p>
                </div>

                <!-- ACCORDIONS -->
                <div id="accordion_form">
                    <!-- Conteúdo gerado por JavaScript -->
                </div>

                <!-- Mensagem vazia -->
                <div id="mensagem_vazio_form" class="alert alert-warning text-center" style="display:none;">
                    <i class="fas fa-exclamation-triangle"></i> Nenhuma moto encontrada com os filtros selecionados.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// JAVASCRIPT - MODAL DE ESTOQUE AGRUPADO (FORMULÁRIO)
// ============================================================================
(function() {
    'use strict';

    const modal = document.getElementById('modalEstoqueAgrupamento');
    if (!modal) return; // Sair se modal não existir

    const accordionContainer = document.getElementById('accordion_form');
    const loadingDiv = document.getElementById('loading_form');
    const mensagemVazio = document.getElementById('mensagem_vazio_form');

    // Elementos de filtro
    const filtroStatus = document.getElementById('filtro_status_form');
    const filtroModelo = document.getElementById('filtro_modelo_form');
    const filtroCor = document.getElementById('filtro_cor_form');
    const filtroPotencia = document.getElementById('filtro_potencia_form');

    // Carregar ao abrir modal
    modal.addEventListener('show.bs.modal', function() {
        carregarOpcoesFiltros();
        carregarDados();
    });

    // Aplicar filtros em tempo real
    [filtroStatus, filtroModelo, filtroCor, filtroPotencia].forEach(elem => {
        if (elem) elem.addEventListener('change', carregarDados);
    });

    // Carregar opções dos filtros
    function carregarOpcoesFiltros() {
        fetch("{{ url_for('motochefe.api_opcoes_filtros') }}")
            .then(res => res.json())
            .then(data => {
                filtroModelo.innerHTML = '<option value="">Todos</option>';
                data.modelos.forEach(modelo => {
                    filtroModelo.innerHTML += `<option value="${modelo}">${modelo}</option>`;
                });

                filtroCor.innerHTML = '<option value="">Todas</option>';
                data.cores.forEach(cor => {
                    filtroCor.innerHTML += `<option value="${cor}">${cor}</option>`;
                });

                filtroPotencia.innerHTML = '<option value="">Todas</option>';
                data.potencias.forEach(pot => {
                    filtroPotencia.innerHTML += `<option value="${pot}">${pot}</option>`;
                });
            })
            .catch(err => console.error('Erro ao carregar opções:', err));
    }

    // Carregar dados agrupados
    function carregarDados() {
        loadingDiv.style.display = 'block';
        accordionContainer.style.display = 'none';
        mensagemVazio.style.display = 'none';

        const params = new URLSearchParams({
            autopropelido_sim: 'true',
            autopropelido_nao: 'true',
            status: filtroStatus.value,
            modelo: filtroModelo.value,
            cor: filtroCor.value,
            potencia: filtroPotencia.value
        });

        fetch(`{{ url_for('motochefe.api_motos_agrupamento') }}?${params}`)
            .then(res => res.json())
            .then(dados => {
                loadingDiv.style.display = 'none';

                if (dados.length === 0) {
                    mensagemVazio.style.display = 'block';
                    return;
                }

                renderizarAccordions(dados);
                accordionContainer.style.display = 'block';
            })
            .catch(err => {
                console.error('Erro ao carregar dados:', err);
                loadingDiv.style.display = 'none';
                mensagemVazio.style.display = 'block';
            });
    }

    // Renderizar accordions
    function renderizarAccordions(dados) {
        let html = '<div class="accordion" id="accordionModelosForm">';

        dados.forEach((modelo, idxModelo) => {
            const modeloId = `modelo_form_${idxModelo}`;

            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${modeloId}">
                            <strong>${modelo.modelo}</strong>
                            <span class="badge bg-info ms-2">${modelo.quantidade} motos</span>
                            <span class="badge bg-success ms-2">R$ ${formatarValorBR(modelo.preco_tabela || 0)}</span>
                            ${modelo.autopropelido ? '<span class="badge bg-warning text-dark ms-1">Autopropelida</span>' : ''}
                        </button>
                    </h2>
                    <div id="${modeloId}" class="accordion-collapse collapse" data-bs-parent="#accordionModelosForm">
                        <div class="accordion-body">
                            ${renderizarCores(modelo.cores, modeloId)}
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        accordionContainer.innerHTML = html;
    }

    // Renderizar Cores
    function renderizarCores(cores, parentId) {
        let html = '<div class="accordion" id="accordion_' + parentId + '">';

        cores.forEach((cor, idxCor) => {
            const corId = `${parentId}_cor_${idxCor}`;

            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${corId}">
                            <i class="fas fa-square" style="color:${getCorHex(cor.cor)}"></i>
                            <strong class="ms-2">${cor.cor}</strong>
                            <span class="badge bg-secondary ms-2">${cor.quantidade} motos</span>
                        </button>
                    </h2>
                    <div id="${corId}" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul class="list-group">
            `;

            cor.potencias.forEach(pot => {
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <strong>${pot.potencia}</strong>
                        <span class="badge bg-info">${pot.quantidade} motos</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="mostrarMotosForm(${JSON.stringify(pot.motos).replace(/"/g, '&quot;')}, '${pot.potencia}', '${cor.cor}')">
                            <i class="fas fa-eye"></i> Ver Chassi
                        </button>
                    </li>
                `;
            });

            html += `
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        return html;
    }

    function getCorHex(cor) {
        const cores = {
            'Preta': '#000000',
            'Branca': '#FFFFFF',
            'Vermelha': '#DC3545',
            'Azul': '#0D6EFD',
            'Verde': '#198754',
            'Amarela': '#FFC107',
            'Laranja': '#FD7E14',
            'Cinza': '#6C757D',
            'Prata': '#ADB5BD'
        };
        return cores[cor] || '#6C757D';
    }

    function formatarValorBR(valor) {
        return parseFloat(valor).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&.').replace('.', ',');
    }

    window.mostrarMotosForm = function(motos, potencia, cor) {
        let html = `
            <div class="modal fade" id="modalListaMotosForm" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-motorcycle"></i> Lista de Motos - ${cor} ${potencia}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Chassi</th>
                                        <th>Motor</th>
                                        <th>Ano</th>
                                        <th>NF</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
        `;

        motos.forEach(moto => {
            const statusClass = moto.status === 'DISPONIVEL' ? 'success' : moto.status === 'RESERVADA' ? 'warning' : 'danger';

            html += `
                <tr>
                    <td><code>${moto.chassi}</code></td>
                    <td><code>${moto.motor}</code></td>
                    <td>${moto.ano || '-'}</td>
                    <td>${moto.nf}</td>
                    <td><span class="badge bg-${statusClass}">${moto.status}</span></td>
                </tr>
            `;
        });

        html += `
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const oldModal = document.getElementById('modalListaMotosForm');
        if (oldModal) oldModal.remove();

        document.body.insertAdjacentHTML('beforeend', html);

        const modalInstance = new bootstrap.Modal(document.getElementById('modalListaMotosForm'));
        modalInstance.show();

        document.getElementById('modalListaMotosForm').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    };
})();
</script>
{% endblock %}
