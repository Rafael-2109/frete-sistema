{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="fas fa-file-invoice"></i>
                {% if pedido %}Editar Pedido{% else %}Novo Pedido de Venda{% endif %}
            </h4>
        </div>
        <div class="card-body">
            <form method="POST" id="formPedido">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="itens_json" id="itens_json"/>
                <input type="hidden" name="parcelas_json" id="parcelas_json"/>
                <input type="hidden" name="valor_total_pedido" id="valor_total_pedido"/>

                <!-- Dados Gerais -->
                <h5 class="mb-3"><i class="fas fa-info-circle"></i> Dados Gerais</h5>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">N¬∫ Pedido *</label>
                        <div class="input-group">
                            <input type="text" name="numero_pedido" id="numero_pedido" class="form-control"
                                   value="{{ pedido.numero_pedido if pedido else '' }}" required
                                   placeholder="Ex: MC 1321">
                            <button type="button" class="btn btn-info" onclick="buscarProximoNumero()" title="Gerar pr√≥ximo n√∫mero">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <small class="text-muted">Campo edit√°vel - Clique no bot√£o para gerar automaticamente</small>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Data Pedido *</label>
                        <input type="date" name="data_pedido" class="form-control"
                               value="{{ pedido.data_pedido.strftime('%Y-%m-%d') if pedido and pedido.data_pedido else today }}" required readonly>
                        <small class="text-muted">Data de cria√ß√£o do pedido (autom√°tica)</small>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Data Expedi√ß√£o</label>
                        <input type="date" name="data_expedicao" class="form-control"
                               value="{{ pedido.data_expedicao.strftime('%Y-%m-%d') if pedido and pedido.data_expedicao else '' }}">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Equipe de Vendas *</label>
                        <select name="equipe_vendas_id" id="sel_equipe" class="form-select" required>
                            <option value="">Selecione...</option>
                            {% for e in equipes %}
                            <option value="{{ e.id }}"
                                    data-permitir-prazo="{{ e.permitir_prazo|lower }}"
                                    data-permitir-parcelamento="{{ e.permitir_parcelamento|lower }}"
                                    data-permitir-montagem="{{ e.permitir_montagem|lower }}">
                                {{ e.equipe_vendas }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Vendedor *</label>
                        <select name="vendedor_id" id="sel_vendedor" class="form-select" required disabled>
                            <option value="">Selecione equipe primeiro...</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Cliente *</label>
                        <select name="cliente_id" id="sel_cliente" class="form-select" required disabled>
                            <option value="">Selecione vendedor primeiro...</option>
                        </select>
                    </div>
                </div>

                <!-- Campo de Prazo (condicional) -->
                <div class="row" id="div_prazo" style="display: none;">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Prazo (dias) *</label>
                        <input type="number" name="prazo_dias" id="input_prazo" class="form-control" min="0" value="0">
                        <small class="text-muted">Dias ap√≥s data de expedi√ß√£o</small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 mb-3" id="div_tipo_frete">
                        <label class="form-label">Tipo Frete</label>
                        <select name="tipo_frete" id="sel_tipo_frete" class="form-select">
                            <option value="">Selecione...</option>
                            <option value="CIF">CIF</option>
                            <option value="FOB">FOB</option>
                        </select>
                        <small class="text-muted">Transportadora ser√° definida ao alocar no embarque</small>
                    </div>
                    <div class="col-md-3 mb-3" id="div_valor_frete" style="display: none;">
                        <label class="form-label">Valor Frete Cliente</label>
                        <input type="number" step="0.01" name="valor_frete_cliente" id="input_frete" class="form-control" value="0">
                        <small class="text-muted">Apenas para CIF</small>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Observa√ß√µes</label>
                    <textarea name="observacoes" class="form-control" rows="2"></textarea>
                </div>

                <hr class="my-4">

                <!-- Adicionar Item -->
                <h5 class="mb-3"><i class="fas fa-motorcycle"></i> Itens do Pedido</h5>
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Modelo</label>
                                <select id="sel_modelo" class="form-select">
                                    <option value="">Selecione...</option>
                                    {% for m in modelos %}
                                    <option value="{{ m.id }}" data-preco="{{ m.preco_tabela }}">
                                        {{ m.nome_modelo }} - {{ m.potencia_motor }} (R$ {{ m.preco_tabela|valor_br }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Cor *</label>
                                <select id="sel_cor" class="form-select" required>
                                    <option value="">Selecione modelo primeiro...</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Quantidade</label>
                                <input type="number" id="txt_qtd" class="form-control" min="1" value="1">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Pre√ßo Venda</label>
                                <input type="number" step="0.01" id="txt_preco" class="form-control">
                            </div>
                        </div>
                        <div id="div_montagem" style="display: none;">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" id="chk_montagem" class="form-check-input">
                                        <label class="form-check-label">Montagem Contratada</label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Valor Montagem</label>
                                    <input type="number" step="0.01" id="txt_valor_montagem" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" class="btn btn-primary" onclick="adicionarItem()">
                                    <i class="fas fa-plus"></i> Adicionar Item
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Itens -->
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Modelo</th>
                            <th>Cor</th>
                            <th>Qtd</th>
                            <th>Pre√ßo Un</th>
                            <th>Montagem</th>
                            <th>Total</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="tbody_itens">
                        <tr id="tr_vazio">
                            <td colspan="7" class="text-center text-muted">Nenhum item adicionado</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="5" class="text-end">TOTAL DO PEDIDO:</th>
                            <th id="td_total">R$ 0,00</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>

                <div id="div_parcelas" style="display: none;">
                    <hr class="my-4">

                    <!-- Parcelamento -->
                    <h5 class="mb-3"><i class="fas fa-calendar-alt"></i> Parcelamento</h5>
                    <div class="card mb-3">
                        <div class="card-body">
                            <button type="button" class="btn btn-sm btn-primary" onclick="adicionarParcela()">
                                <i class="fas fa-plus"></i> Adicionar Parcela
                            </button>
                            <table class="table table-sm mt-3">
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>Valor (R$)</th>
                                        <th>Prazo (dias)</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="tbody_parcelas">
                                    <tr id="tr_parcelas_vazio">
                                        <td colspan="4" class="text-center text-muted">Nenhuma parcela cadastrada</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save"></i> Salvar Pedido
                    </button>
                    <a href="{{ url_for('motochefe.listar_pedidos') }}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Fun√ß√£o helper para formatar valores monet√°rios no padr√£o brasileiro
function formatarValorBR(valor, decimais = 2) {
    if (valor === null || valor === undefined) return '0,00';
    const numero = parseFloat(valor);
    if (isNaN(numero)) return '0,00';

    // Formatar com decimais e substituir separadores
    return numero.toFixed(decimais)
        .replace(/\d(?=(\d{3})+\.)/g, '$&.')  // Adiciona ponto a cada 3 d√≠gitos
        .replace('.', ',');  // Troca ponto por v√≠rgula no decimal
}

let itens = [];
let parcelas = [];
let cliente_crossdocking = false;

// üÜï CASCATA: Equipe ‚Üí Vendedor
document.getElementById('sel_equipe').addEventListener('change', async function() {
    const equipeId = this.value;
    const selVendedor = document.getElementById('sel_vendedor');
    const selCliente = document.getElementById('sel_cliente');

    selVendedor.innerHTML = '<option value="">Carregando...</option>';
    selVendedor.disabled = true;
    selCliente.innerHTML = '<option value="">Selecione vendedor primeiro...</option>';
    selCliente.disabled = true;

    if (!equipeId) {
        selVendedor.innerHTML = '<option value="">Selecione equipe primeiro...</option>';
        return;
    }

    const response = await fetch(`/motochefe/api/vendedores-por-equipe?equipe_id=${equipeId}`);
    const vendedores = await response.json();

    selVendedor.innerHTML = '<option value="">Selecione...</option>';
    vendedores.forEach(v => {
        selVendedor.innerHTML += `<option value="${v.id}">${v.vendedor}</option>`;
    });
    selVendedor.disabled = false;

    const option = this.options[this.selectedIndex];
    const permitirMontagem = option.dataset.permitirMontagem === 'true';
    const permitirPrazo = option.dataset.permitirPrazo === 'true';
    const permitirParcelamento = option.dataset.permitirParcelamento === 'true';

    const divMontagem = document.getElementById('div_montagem');
    if (divMontagem) {
        divMontagem.style.display = permitirMontagem ? 'block' : 'none';
    }

    const divPrazo = document.getElementById('div_prazo');
    const divParcelas = document.getElementById('div_parcelas');

    // L√≥gica de exibi√ß√£o:
    // - permitir_prazo=False: √Ä vista (sem prazo, sem parcelas)
    // - permitir_prazo=True, permitir_parcelamento=False: Prazo √∫nico (1 vencimento)
    // - permitir_prazo=True, permitir_parcelamento=True: Prazo E parcelas (m√∫ltiplos vencimentos)

    if (!permitirPrazo) {
        // √Ä vista: esconde tudo
        if (divPrazo) divPrazo.style.display = 'none';
        if (divParcelas) divParcelas.style.display = 'none';
        // Limpar parcelas
        parcelas = [];
        atualizarTabelaParcelas();
    } else {
        // COM prazo
        if (divPrazo) divPrazo.style.display = 'block';

        if (permitirParcelamento) {
            // COM parcelamento: mostrar se√ß√£o de parcelas
            if (divParcelas) divParcelas.style.display = 'block';
        } else {
            // SEM parcelamento: esconder se√ß√£o, limpar array
            if (divParcelas) divParcelas.style.display = 'none';
            parcelas = [];
            atualizarTabelaParcelas();
        }
    }
});

// üÜï CASCATA: Vendedor ‚Üí Cliente
document.getElementById('sel_vendedor').addEventListener('change', async function() {
    const vendedorId = this.value;
    const selCliente = document.getElementById('sel_cliente');

    selCliente.innerHTML = '<option value="">Carregando...</option>';
    selCliente.disabled = true;

    if (!vendedorId) {
        selCliente.innerHTML = '<option value="">Selecione vendedor primeiro...</option>';
        return;
    }

    const response = await fetch(`/motochefe/api/clientes-por-vendedor?vendedor_id=${vendedorId}`);
    const clientes = await response.json();

    selCliente.innerHTML = '<option value="">Selecione...</option>';
    clientes.forEach(c => {
        selCliente.innerHTML += `<option value="${c.id}" data-crossdocking="${c.crossdocking}">${c.cliente} - ${c.cnpj}</option>`;
    });
    selCliente.disabled = false;
});

// üÜï EVENTO: Cliente ‚Üí CrossDocking
document.getElementById('sel_cliente').addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    cliente_crossdocking = option.dataset.crossdocking === 'true';

    const divTipoFrete = document.getElementById('div_tipo_frete');
    const divValorFrete = document.getElementById('div_valor_frete');

    if (divTipoFrete) {
        divTipoFrete.style.display = cliente_crossdocking ? 'none' : 'block';
    }

    // Se crossdocking=true, ocultar tamb√©m valor frete
    if (cliente_crossdocking && divValorFrete) {
        divValorFrete.style.display = 'none';
    }
});

// üÜï EVENTO: Tipo Frete ‚Üí Valor Frete (exibe apenas se CIF)
document.getElementById('sel_tipo_frete').addEventListener('change', function() {
    const tipoFrete = this.value;
    const divValorFrete = document.getElementById('div_valor_frete');

    if (divValorFrete) {
        divValorFrete.style.display = (tipoFrete === 'CIF') ? 'block' : 'none';

        // Se FOB ou vazio, zerar valor frete
        if (tipoFrete !== 'CIF') {
            document.getElementById('input_frete').value = '0';
            atualizarTabelaItens(); // Recalcular total
        }
    }
});

// Buscar cores ao selecionar modelo
document.getElementById('sel_modelo').addEventListener('change', async function() {
    const modeloId = this.value;
    const precoTabela = this.options[this.selectedIndex]?.dataset.preco || 0;
    document.getElementById('txt_preco').value = precoTabela;

    const selCor = document.getElementById('sel_cor');

    if (!modeloId) {
        selCor.innerHTML = '<option value="">Selecione modelo primeiro...</option>';
        selCor.disabled = true;
        return;
    }

    const response = await fetch(`/motochefe/api/cores-disponiveis?modelo_id=${modeloId}`);
    const cores = await response.json();

    if (cores.length === 0) {
        selCor.innerHTML = '<option value="">Sem estoque dispon√≠vel</option>';
        selCor.disabled = true;
    } else {
        selCor.innerHTML = '<option value="">Selecione...</option>';
        cores.forEach(c => {
            selCor.innerHTML += `<option value="${c.cor}">${c.label}</option>`;
        });
        selCor.disabled = false;
    }
});

// Habilitar campo montagem
document.getElementById('chk_montagem').addEventListener('change', function() {
    document.getElementById('txt_valor_montagem').disabled = !this.checked;
    if (!this.checked) document.getElementById('txt_valor_montagem').value = '';
});

// Adicionar item
function adicionarItem() {
    const selModelo = document.getElementById('sel_modelo');
    const modelo_id = selModelo.value;
    const modelo_nome = selModelo.options[selModelo.selectedIndex]?.text || '';
    const selCor = document.getElementById('sel_cor');
    const cor = selCor.value;
    const quantidade = parseInt(document.getElementById('txt_qtd').value);
    const preco_venda = parseFloat(document.getElementById('txt_preco').value);
    const montagem = document.getElementById('chk_montagem').checked;
    const valor_montagem = montagem ? parseFloat(document.getElementById('txt_valor_montagem').value || 0) : 0;

    if (!modelo_id || !cor || !quantidade || !preco_venda) {
        alert('Preencha todos os campos do item');
        return;
    }

    const item = {
        modelo_id: parseInt(modelo_id),
        modelo_nome: modelo_nome.split(' (')[0],
        cor: cor,
        quantidade: quantidade,
        preco_venda: preco_venda,
        montagem: montagem,
        valor_montagem: valor_montagem,
        total: (preco_venda * quantidade) + (montagem ? valor_montagem * quantidade : 0)
    };

    itens.push(item);
    atualizarTabelaItens();
    limparFormItem();
}

function removerItem(index) {
    itens.splice(index, 1);
    atualizarTabelaItens();
}

function atualizarTabelaItens() {
    const tbody = document.getElementById('tbody_itens');
    const trVazio = document.getElementById('tr_vazio');

    if (itens.length === 0) {
        trVazio.style.display = '';
        tbody.innerHTML = '<tr id="tr_vazio"><td colspan="7" class="text-center text-muted">Nenhum item adicionado</td></tr>';
    } else {
        tbody.innerHTML = itens.map((item, index) => `
            <tr>
                <td>${item.modelo_nome}</td>
                <td>${item.cor}</td>
                <td>${item.quantidade}</td>
                <td>R$ ${formatarValorBR(item.preco_venda)}</td>
                <td>${item.montagem ? 'R$ ' + formatarValorBR(item.valor_montagem) : '-'}</td>
                <td>R$ ${formatarValorBR(item.total)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removerItem(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    const totalItens = itens.reduce((sum, item) => sum + item.total, 0);
    const frete = parseFloat(document.getElementById('input_frete')?.value || 0);
    const totalComFrete = totalItens + frete;

    document.getElementById('td_total').textContent = 'R$ ' + formatarValorBR(totalComFrete);
    document.getElementById('valor_total_pedido').value = totalComFrete.toFixed(2);
}

// Listener no frete
document.getElementById('input_frete').addEventListener('input', atualizarTabelaItens);

function limparFormItem() {
    document.getElementById('sel_modelo').value = '';
    document.getElementById('sel_cor').innerHTML = '<option value="">Selecione modelo primeiro...</option>';
    document.getElementById('sel_cor').disabled = true;
    document.getElementById('txt_qtd').value = '1';
    document.getElementById('txt_preco').value = '';
    document.getElementById('chk_montagem').checked = false;
    document.getElementById('txt_valor_montagem').value = '';
    document.getElementById('txt_valor_montagem').disabled = true;
}

// Parcelas
function adicionarParcela() {
    const numero = parcelas.length + 1;
    const total = parseFloat(document.getElementById('valor_total_pedido').value || 0);

    if (total === 0) {
        alert('Adicione itens ao pedido antes de criar parcelas');
        return;
    }

    const valorPorParcela = (total / numero).toFixed(2);

    // Adicionar nova parcela
    parcelas.push({
        numero: numero,
        valor: parseFloat(valorPorParcela),
        prazo_dias: 30  // Padr√£o 30 dias, EDIT√ÅVEL pelo usu√°rio
    });

    // ‚úÖ RECALCULAR VALORES das parcelas (mant√©m prazo_dias editado)
    parcelas.forEach((p, index) => {
        p.numero = index + 1;
        p.valor = parseFloat(valorPorParcela);
        // N√ÉO recalcular prazo_dias - usu√°rio pode ter editado
    });

    atualizarTabelaParcelas();
}

function removerParcela(index) {
    parcelas.splice(index, 1);
    // Renumerar
    parcelas.forEach((p, i) => p.numero = i + 1);
    atualizarTabelaParcelas();
}

function atualizarTabelaParcelas() {
    const tbody = document.getElementById('tbody_parcelas');
    
    if (parcelas.length === 0) {
        tbody.innerHTML = '<tr id="tr_parcelas_vazio"><td colspan="4" class="text-center text-muted">Nenhuma parcela cadastrada</td></tr>';
    } else {
        tbody.innerHTML = parcelas.map((p, index) => `
            <tr>
                <td>${p.numero}/${parcelas.length}</td>
                <td>
                    <input type="number" step="0.01" class="form-control form-control-sm" 
                           value="${p.valor}" onchange="parcelas[${index}].valor = parseFloat(this.value)">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${p.prazo_dias}" onchange="parcelas[${index}].prazo_dias = parseInt(this.value)">
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removerParcela(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

// Submit com valida√ß√µes
document.getElementById('formPedido').addEventListener('submit', function(e) {
    // Valida√ß√£o 1: Itens
    if (itens.length === 0) {
        e.preventDefault();
        alert('Adicione pelo menos um item ao pedido');
        return;
    }

    // Valida√ß√£o 2: Parcelas (se houver)
    if (parcelas.length > 0) {
        const totalPedido = parseFloat(document.getElementById('valor_total_pedido').value || 0);
        const totalParcelas = parcelas.reduce((sum, p) => sum + p.valor, 0);
        const diferenca = Math.abs(totalPedido - totalParcelas);

        // Toler√¢ncia de R$ 0.02 para arredondamentos
        if (diferenca > 0.02) {
            e.preventDefault();
            alert(
                `ERRO: Soma das parcelas (R$ ${formatarValorBR(totalParcelas)}) ` +
                `difere do total do pedido (R$ ${formatarValorBR(totalPedido)}).\n\n` +
                `Diferen√ßa: R$ ${formatarValorBR(diferenca)}\n\n` +
                `Ajuste os valores das parcelas.`
            );
            return;
        }

        // Valida√ß√£o 3: Prazo das parcelas
        const parcelasSemPrazo = parcelas.filter(p => !p.prazo_dias || p.prazo_dias <= 0);
        if (parcelasSemPrazo.length > 0) {
            e.preventDefault();
            alert('Todas as parcelas devem ter prazo em dias maior que 0');
            return;
        }
    }

    // Tudo OK: serializar dados
    document.getElementById('itens_json').value = JSON.stringify(itens);
    document.getElementById('parcelas_json').value = JSON.stringify(parcelas);
});

// Fun√ß√£o para buscar pr√≥ximo n√∫mero de pedido
async function buscarProximoNumero() {
    try {
        const response = await fetch('/motochefe/pedidos/api/proximo-numero');
        const data = await response.json();
        document.getElementById('numero_pedido').value = data.numero;
    } catch (error) {
        console.error('Erro ao buscar pr√≥ximo n√∫mero:', error);
        alert('Erro ao gerar pr√≥ximo n√∫mero');
    }
}
</script>
{% endblock %}
