{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-motorcycle"></i> Estoque de Motos (Chassi)</h2>
        <div>
            <a href="{{ url_for('motochefe.adicionar_moto') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Adicionar
            </a>
            <a href="{{ url_for('motochefe.listar_avarias') }}" class="btn btn-warning">
                <i class="fas fa-exclamation-triangle"></i> Avarias
            </a>
            <a href="{{ url_for('motochefe.listar_devolucoes') }}" class="btn btn-danger">
                <i class="fas fa-undo"></i> Devoluções
            </a>
            <a href="{{ url_for('motochefe.exportar_motos') }}" class="btn btn-success">
                <i class="fas fa-file-excel"></i> Exportar
            </a>
            <a href="{{ url_for('motochefe.baixar_modelo_motos') }}" class="btn btn-secondary">
                <i class="fas fa-download"></i> Baixar Modelo
            </a>
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalImportar">
                <i class="fas fa-upload"></i> Importar
            </button>
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalAgrupamento">
                <i class="fas fa-layer-group"></i> Visualizar Agrupamento
            </button>
        </div>
    </div>

    <!-- Resumo -->
    <div class="row mb-3">
        <div class="col-md-2">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <h6>Total Motos</h6>
                    <h3>{{ total_motos }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <h6>Disponíveis</h6>
                    <h3>{{ disponiveis }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <h6>Reservadas</h6>
                    <h3>{{ reservadas }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <h6>Vendidas</h6>
                    <h3>{{ vendidas }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <h6>Inativas (Modelo não encontrado)</h6>
                    <h3>{{ inativas }}</h3>
                    {% if inativas > 0 %}
                    <a href="{{ url_for('motochefe.listar_motos', inativas=1) }}" class="btn btn-sm btn-light mt-2">
                        <i class="fas fa-eye"></i> Ver Inativas
                    </a>
                    <a href="{{ url_for('motochefe.exportar_motos_inativas') }}" class="btn btn-sm btn-warning mt-2">
                        <i class="fas fa-file-excel"></i> Exportar
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="GET" class="row g-2">
                <div class="col-md-4">
                    <label class="form-label">Modelo</label>
                    <select name="modelo_id" class="form-select">
                        <option value="">Todos</option>
                        {% for m in modelos %}
                        <option value="{{ m.id }}" {% if modelo_filtro == m.id %}selected{% endif %}>
                            {{ m.nome_modelo }} - {{ m.potencia_motor }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select">
                        <option value="">Todos</option>
                        <option value="DISPONIVEL" {% if status_filtro == 'DISPONIVEL' %}selected{% endif %}>Disponível</option>
                        <option value="RESERVADA" {% if status_filtro == 'RESERVADA' %}selected{% endif %}>Reservada</option>
                        <option value="VENDIDA" {% if status_filtro == 'VENDIDA' %}selected{% endif %}>Vendida</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo</label>
                    <select name="inativas" class="form-select">
                        <option value="0" {% if mostrar_inativas == 0 %}selected{% endif %}>Ativas</option>
                        <option value="1" {% if mostrar_inativas == 1 %}selected{% endif %}>Inativas</option>
                    </select>
                </div>
                <div class="col-md-12 d-flex align-items-end mt-2">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                    <a href="{{ url_for('motochefe.listar_motos') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Limpar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>Chassi</th>
                            <th>Motor</th>
                            <th>Modelo</th>
                            <th>Cor</th>
                            <th>Ano</th>
                            <th>NF Entrada</th>
                            <th>Data Entrada</th>
                            <th>Fornecedor</th>
                            <th>Custo</th>
                            <th>Pallet</th>
                            <th>Status</th>
                            <th>Reservado</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for moto in motos %}
                        {# ✅ TAREFA 2: CSS colorido por status - Avaria=Amarelo, Vendida=Verde, Reservada=Azul, Devolvida=Vermelho #}
                        <tr {% if moto.status == 'AVARIADO' %}class="table-warning"
                            {% elif moto.status == 'VENDIDA' %}class="table-success"
                            {% elif moto.status == 'RESERVADA' %}class="table-info"
                            {% elif moto.status == 'DEVOLVIDO' %}class="table-danger"
                            {% endif %}>
                            <td><code>{{ moto.numero_chassi }}</code></td>
                            <td><code>{{ moto.numero_motor }}</code></td>
                            <td>
                                {% if moto.ativo %}
                                    <strong>{{ moto.modelo.nome_modelo }}</strong><br>
                                    <small class="text-muted">{{ moto.modelo.potencia_motor }}</small>
                                {% else %}
                                    <span class="badge bg-danger">INATIVA</span><br>
                                    <small class="text-danger"><strong>Modelo Rejeitado:</strong> {{ moto.modelo_rejeitado }}</small>
                                {% endif %}
                            </td>
                            <td>{{ moto.cor }}</td>
                            <td>{{ moto.ano_fabricacao or '-' }}</td>
                            <td>{{ moto.nf_entrada }}</td>
                            <td>{{ moto.data_entrada.strftime('%d/%m/%Y') if moto.data_entrada else '-' }}</td>
                            <td>{{ moto.fornecedor }}</td>
                            <td>R$ {{ moto.custo_aquisicao|valor_br }}</td>
                            <td>{{ moto.pallet or '-' }}</td>
                            <td>
                                {% if moto.status == 'DISPONIVEL' %}
                                <span class="badge bg-success">{{ moto.status }}</span>
                                {% elif moto.status == 'RESERVADA' %}
                                <span class="badge bg-warning">{{ moto.status }}</span>
                                {% elif moto.status == 'VENDIDA' %}
                                <span class="badge bg-danger">{{ moto.status }}</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ moto.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if moto.reservado %}
                                <span class="badge bg-warning">Sim</span>
                                {% else %}
                                <span class="badge bg-secondary">Não</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('motochefe.editar_moto', chassi=moto.numero_chassi) }}" class="btn btn-warning">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% if moto.status not in ['AVARIADO', 'DEVOLVIDO'] and not moto.reservado %}
                                    <button type="button" class="btn btn-danger" onclick="abrirModalAvaria('{{ moto.numero_chassi }}')">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </button>
                                    {% endif %}
                                    {% if moto.status != 'VENDIDA' and not moto.reservado %}
                                    <form method="POST" action="{{ url_for('motochefe.remover_moto', chassi=moto.numero_chassi) }}" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-secondary" onclick="return confirm('Confirma remoção?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="13" class="text-center text-muted">Nenhuma moto cadastrada</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            <!-- Paginação -->
            {% if paginacao %}
                {% include 'motochefe/_pagination.html' %}
            {% endif %}
        </div>
        </div>
    </div>
</div>

<!-- Modal Importar -->
<div class="modal fade" id="modalImportar">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5><i class="fas fa-upload"></i> Importar Motos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('motochefe.importar_motos') }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <input type="file" name="arquivo" class="form-control" accept=".xlsx,.xls" required>
                    <div class="alert alert-info mt-2">
                        <small>
                            <strong>Colunas obrigatórias:</strong><br>
                            <code>Chassi</code>, <code>Motor</code>, <code>Modelo</code>, <code>Cor</code>,
                            <code>NF Entrada</code>, <code>Fornecedor</code>, <code>Custo</code><br><br>
                            <strong>Colunas opcionais:</strong><br>
                            <code>Ano</code>, <code>Data NF</code>, <code>Data Entrada</code>, <code>Pallet</code>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-upload"></i> Importar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Visualizar Agrupamento -->
<div class="modal fade" id="modalAgrupamento" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-layer-group"></i> Visualizar Agrupamento de Motos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- FILTROS -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <strong><i class="fas fa-filter"></i> Filtros</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Autopropelido -->
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Autopropelido:</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="filtro_autoprop_sim" checked>
                                    <label class="form-check-label" for="filtro_autoprop_sim">Sim</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="filtro_autoprop_nao" checked>
                                    <label class="form-check-label" for="filtro_autoprop_nao">Não</label>
                                </div>
                            </div>

                            <!-- Toggle de Ordem -->
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Ordem de Agrupamento:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="ordem" id="ordem_cor_potencia" value="cor_potencia" checked>
                                    <label class="form-check-label" for="ordem_cor_potencia">
                                        Modelo → Cor → Potência
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="ordem" id="ordem_potencia_cor" value="potencia_cor">
                                    <label class="form-check-label" for="ordem_potencia_cor">
                                        Modelo → Potência → Cor
                                    </label>
                                </div>
                            </div>

                            <!-- Selects de Filtro -->
                            <div class="col-md-3">
                                <label class="form-label">Status:</label>
                                <select id="filtro_status" class="form-select form-select-sm">
                                    <option value="">Todos</option>
                                    <option value="DISPONIVEL">Disponível</option>
                                    <option value="RESERVADA">Reservada</option>
                                    <option value="VENDIDA">Vendida</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Modelo:</label>
                                <select id="filtro_modelo" class="form-select form-select-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Cor:</label>
                                <select id="filtro_cor" class="form-select form-select-sm">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Potência:</label>
                                <select id="filtro_potencia" class="form-select form-select-sm">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LOADING -->
                <div id="loading_agrupamento" class="text-center py-5" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted">Carregando dados...</p>
                </div>

                <!-- ACCORDIONS -->
                <div id="accordion_agrupamento">
                    <!-- Conteúdo gerado por JavaScript -->
                </div>

                <!-- Mensagem vazia -->
                <div id="mensagem_vazio" class="alert alert-warning text-center" style="display:none;">
                    <i class="fas fa-exclamation-triangle"></i> Nenhuma moto encontrada com os filtros selecionados.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// JAVASCRIPT - MODAL DE AGRUPAMENTO
// ============================================================================
(function() {
    'use strict';

    const modal = document.getElementById('modalAgrupamento');
    const accordionContainer = document.getElementById('accordion_agrupamento');
    const loadingDiv = document.getElementById('loading_agrupamento');
    const mensagemVazio = document.getElementById('mensagem_vazio');

    // Elementos de filtro
    const filtroAutopropSim = document.getElementById('filtro_autoprop_sim');
    const filtroAutopropNao = document.getElementById('filtro_autoprop_nao');
    const filtroStatus = document.getElementById('filtro_status');
    const filtroModelo = document.getElementById('filtro_modelo');
    const filtroCor = document.getElementById('filtro_cor');
    const filtroPotencia = document.getElementById('filtro_potencia');
    const ordemRadios = document.querySelectorAll('input[name="ordem"]');

    // Carregar opções dos selects ao abrir modal
    modal.addEventListener('show.bs.modal', function() {
        carregarOpcoesFiltros();
        carregarDados();
    });

    // Aplicar filtros em tempo real
    [filtroAutopropSim, filtroAutopropNao, filtroStatus, filtroModelo, filtroCor, filtroPotencia].forEach(elem => {
        elem.addEventListener('change', carregarDados);
    });

    ordemRadios.forEach(radio => {
        radio.addEventListener('change', carregarDados);
    });

    // Carregar opções disponíveis para os selects
    function carregarOpcoesFiltros() {
        fetch("{{ url_for('motochefe.api_opcoes_filtros') }}")
            .then(res => res.json())
            .then(data => {
                // Preencher select de modelos
                filtroModelo.innerHTML = '<option value="">Todos</option>';
                data.modelos.forEach(modelo => {
                    filtroModelo.innerHTML += `<option value="${modelo}">${modelo}</option>`;
                });

                // Preencher select de cores
                filtroCor.innerHTML = '<option value="">Todas</option>';
                data.cores.forEach(cor => {
                    filtroCor.innerHTML += `<option value="${cor}">${cor}</option>`;
                });

                // Preencher select de potências
                filtroPotencia.innerHTML = '<option value="">Todas</option>';
                data.potencias.forEach(pot => {
                    filtroPotencia.innerHTML += `<option value="${pot}">${pot}</option>`;
                });
            })
            .catch(err => console.error('Erro ao carregar opções:', err));
    }

    // Carregar dados agrupados
    function carregarDados() {
        // Mostrar loading
        loadingDiv.style.display = 'block';
        accordionContainer.style.display = 'none';
        mensagemVazio.style.display = 'none';

        // Montar query string
        const params = new URLSearchParams({
            autopropelido_sim: filtroAutopropSim.checked ? 'true' : 'false',
            autopropelido_nao: filtroAutopropNao.checked ? 'true' : 'false',
            status: filtroStatus.value,
            modelo: filtroModelo.value,
            cor: filtroCor.value,
            potencia: filtroPotencia.value
        });

        fetch(`{{ url_for('motochefe.api_motos_agrupamento') }}?${params}`)
            .then(res => res.json())
            .then(dados => {
                loadingDiv.style.display = 'none';

                if (dados.length === 0) {
                    mensagemVazio.style.display = 'block';
                    return;
                }

                // Renderizar accordions
                const ordem = document.querySelector('input[name="ordem"]:checked').value;
                renderizarAccordions(dados, ordem);
                accordionContainer.style.display = 'block';
            })
            .catch(err => {
                console.error('Erro ao carregar dados:', err);
                loadingDiv.style.display = 'none';
                mensagemVazio.style.display = 'block';
            });
    }

    // Renderizar accordions baseado na ordem selecionada
    function renderizarAccordions(dados, ordem) {
        let html = '<div class="accordion" id="accordionModelos">';

        dados.forEach((modelo, idxModelo) => {
            const modeloId = `modelo_${idxModelo}`;

            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${modeloId}">
                            <strong>${modelo.modelo}</strong>
                            <span class="badge bg-primary ms-2">${modelo.quantidade} motos</span>
                            ${modelo.autopropelido ? '<span class="badge bg-success ms-1">Autopropelida</span>' : ''}
                        </button>
                    </h2>
                    <div id="${modeloId}" class="accordion-collapse collapse" data-bs-parent="#accordionModelos">
                        <div class="accordion-body">
            `;

            if (ordem === 'cor_potencia') {
                // Modelo → Cor → Potência
                html += renderizarCorPotencia(modelo.cores, modeloId);
            } else {
                // Modelo → Potência → Cor
                html += renderizarPotenciaCor(modelo.cores, modeloId);
            }

            html += `
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        accordionContainer.innerHTML = html;
    }

    // Renderizar: Cor → Potência
    function renderizarCorPotencia(cores, parentId) {
        let html = '<div class="accordion" id="accordion_' + parentId + '">';

        cores.forEach((cor, idxCor) => {
            const corId = `${parentId}_cor_${idxCor}`;

            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${corId}">
                            <i class="fas fa-square" style="color:${getCorHex(cor.cor)}"></i>
                            <strong class="ms-2">${cor.cor}</strong>
                            <span class="badge bg-secondary ms-2">${cor.quantidade} motos</span>
                        </button>
                    </h2>
                    <div id="${corId}" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul class="list-group">
            `;

            cor.potencias.forEach(pot => {
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <strong>${pot.potencia}</strong>
                        <span class="badge bg-info">${pot.quantidade} motos</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="mostrarMotos(${JSON.stringify(pot.motos).replace(/"/g, '&quot;')}, '${pot.potencia}', '${cor.cor}')">
                            <i class="fas fa-eye"></i> Ver Chassi
                        </button>
                    </li>
                `;
            });

            html += `
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        return html;
    }

    // Renderizar: Potência → Cor
    function renderizarPotenciaCor(cores, parentId) {
        // Agrupar por potência primeiro
        const porPotencia = {};

        cores.forEach(cor => {
            cor.potencias.forEach(pot => {
                if (!porPotencia[pot.potencia]) {
                    porPotencia[pot.potencia] = [];
                }
                porPotencia[pot.potencia].push({
                    cor: cor.cor,
                    quantidade: pot.quantidade,
                    motos: pot.motos
                });
            });
        });

        let html = '<div class="accordion" id="accordion_' + parentId + '">';

        Object.keys(porPotencia).sort().forEach((potencia, idxPot) => {
            const potId = `${parentId}_pot_${idxPot}`;
            const totalPot = porPotencia[potencia].reduce((sum, c) => sum + c.quantidade, 0);

            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${potId}">
                            <strong>${potencia}</strong>
                            <span class="badge bg-secondary ms-2">${totalPot} motos</span>
                        </button>
                    </h2>
                    <div id="${potId}" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul class="list-group">
            `;

            porPotencia[potencia].forEach(item => {
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-square" style="color:${getCorHex(item.cor)}"></i>
                            <strong class="ms-2">${item.cor}</strong>
                        </div>
                        <span class="badge bg-info">${item.quantidade} motos</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="mostrarMotos(${JSON.stringify(item.motos).replace(/"/g, '&quot;')}, '${potencia}', '${item.cor}')">
                            <i class="fas fa-eye"></i> Ver Chassi
                        </button>
                    </li>
                `;
            });

            html += `
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        return html;
    }

    // Função auxiliar para cores
    function getCorHex(cor) {
        const cores = {
            'Preta': '#000000',
            'Branca': '#FFFFFF',
            'Vermelha': '#DC3545',
            'Azul': '#0D6EFD',
            'Verde': '#198754',
            'Amarela': '#FFC107',
            'Laranja': '#FD7E14',
            'Cinza': '#6C757D',
            'Prata': '#ADB5BD'
        };
        return cores[cor] || '#6C757D';
    }

    // Tornar função global para onclick
    window.mostrarMotos = function(motos, potencia, cor) {
        let html = `
            <div class="modal fade" id="modalListaMotos" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-motorcycle"></i> Lista de Motos - ${cor} ${potencia}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Chassi</th>
                                        <th>Motor</th>
                                        <th>Ano</th>
                                        <th>NF</th>
                                        <th>Status</th>
                                        <th>Reservado</th>
                                    </tr>
                                </thead>
                                <tbody>
        `;

        motos.forEach(moto => {
            const statusClass = moto.status === 'DISPONIVEL' ? 'success' : moto.status === 'RESERVADA' ? 'warning' : 'danger';

            html += `
                <tr>
                    <td><code>${moto.chassi}</code></td>
                    <td><code>${moto.motor}</code></td>
                    <td>${moto.ano || '-'}</td>
                    <td>${moto.nf}</td>
                    <td><span class="badge bg-${statusClass}">${moto.status}</span></td>
                    <td>${moto.reservado ? '<span class="badge bg-warning">Sim</span>' : 'Não'}</td>
                </tr>
            `;
        });

        html += `
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remover modal anterior se existir
        const oldModal = document.getElementById('modalListaMotos');
        if (oldModal) oldModal.remove();

        // Adicionar novo modal
        document.body.insertAdjacentHTML('beforeend', html);

        // Mostrar modal
        const modalInstance = new bootstrap.Modal(document.getElementById('modalListaMotos'));
        modalInstance.show();

        // Limpar modal ao fechar
        document.getElementById('modalListaMotos').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    };
})();
</script>

<!-- Modal Marcar como Avariada -->
<div class="modal fade" id="modalMarcarAvaria" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="formMarcarAvaria">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Marcar Moto como Avariada</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Chassi:</strong> <span id="chassiAvaria"></span></p>
                    <div class="mb-3">
                        <label class="form-label">Observação da Avaria: <span class="text-danger">*</span></label>
                        <textarea name="observacao" class="form-control" rows="4" required placeholder="Descreva o problema encontrado..."></textarea>
                    </div>
                    <div class="alert alert-warning">
                        <small><i class="fas fa-info-circle"></i> A moto será marcada como <strong>AVARIADA</strong> e ficará indisponível para venda.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle"></i> Marcar como Avariada
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function abrirModalAvaria(chassi) {
    document.getElementById('chassiAvaria').textContent = chassi;
    document.getElementById('formMarcarAvaria').action = `/motochefe/motos/${chassi}/marcar-avariada`;
    const modal = new bootstrap.Modal(document.getElementById('modalMarcarAvaria'));
    modal.show();
}
</script>
{% endblock %}
