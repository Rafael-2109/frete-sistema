{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <h2><i class="fas fa-money-bill-wave"></i> Contas a Receber - Visão por Pedido</h2>
    <hr>

    <!-- RESUMO GERAL -->
    <div class="card mb-4 border-success">
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3">
                    <h5>Total a Receber</h5>
                    <h3 class="text-success">R$ {{ total_geral|valor_br }}</h3>
                </div>
                <div class="col-md-3">
                    <small>Vencidos</small><br>
                    <strong class="text-danger">R$ {{ total_vencidos|valor_br }}</strong>
                </div>
                <div class="col-md-3">
                    <small>Vencendo Hoje</small><br>
                    <strong class="text-warning">R$ {{ total_hoje|valor_br }}</strong>
                </div>
                <div class="col-md-3">
                    <small>A Vencer</small><br>
                    <strong class="text-success">R$ {{ total_a_vencer|valor_br }}</strong>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" action="{{ url_for('motochefe.receber_lote') }}" id="formRecebimento">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="itens_recebimento" id="itens_recebimento"/>
        <input type="hidden" name="data_recebimento" id="data_recebimento_hidden"/>

        <!-- ACCORDION POR PEDIDO -->
        <div class="accordion" id="accordionPedidos">
            {% for pedido_id, dados_pedido in pedidos_agrupados.items() %}

            <div class="accordion-item">
                <h2 class="accordion-header d-flex align-items-center" id="heading-pedido-{{ pedido_id }}">
                    {% if dados_pedido.pedido.saldo_a_receber > 0 %}
                    <button type="button" class="btn btn-sm btn-success ms-2"
                            data-bs-toggle="modal"
                            data-bs-target="#modalReceberPedido{{ pedido_id }}"
                            style="white-space: nowrap;">
                        <i class="fas fa-dollar-sign"></i> Receber
                    </button>
                    {% endif %}      
                    <button class="accordion-button collapsed flex-grow-1" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse-pedido-{{ pedido_id }}" aria-expanded="false">
                        <strong>Pedido {{ dados_pedido.pedido.numero_pedido }}</strong>
                        &nbsp;-&nbsp;
                        {{ dados_pedido.pedido.cliente.cliente if dados_pedido.pedido.cliente else 'Cliente não definido' }}
                        <span class="badge bg-primary ms-2">
                            {{ dados_pedido.parcelas|length }} parcela(s)
                        </span>
                        <span class="badge bg-dark ms-2">
                            Total: R$ {{ dados_pedido.pedido.valor_total_pedido|valor_br }}
                        </span>
                        <span class="badge bg-success ms-2">
                            Saldo: R$ {{ dados_pedido.pedido.saldo_a_receber|valor_br }}
                        </span>
                    </button>
                </h2>
                <div id="collapse-pedido-{{ pedido_id }}" class="accordion-collapse collapse"
                     aria-labelledby="heading-pedido-{{ pedido_id }}">
                    <div class="accordion-body">
                        <!-- ACCORDION POR PARCELA -->
                        <div class="accordion" id="accordionParcelas-{{ pedido_id }}">
                            {% for parcela_num, dados_parcela in dados_pedido.parcelas.items()|sort %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading-parcela-{{ pedido_id }}-{{ parcela_num }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#collapse-parcela-{{ pedido_id }}-{{ parcela_num }}">
                                        <strong>Parcela {{ parcela_num }}</strong>
                                        <span class="badge bg-primary ms-2">
                                            {{ dados_parcela.motos|length }} moto(s)
                                        </span>
                                        {% set total_parcela = namespace(valor=0) %}
                                        {% for chassi, titulos in dados_parcela.motos.items() %}
                                            {% for titulo in titulos %}
                                                {% set total_parcela.valor = total_parcela.valor + titulo.valor_saldo %}
                                            {% endfor %}
                                        {% endfor %}
                                        <span class="badge bg-success ms-2">
                                            Total: R$ {{ total_parcela.valor|valor_br }}
                                        </span>
                                    </button>
                                </h2>
                                <div id="collapse-parcela-{{ pedido_id }}-{{ parcela_num }}"
                                     class="accordion-collapse collapse"
                                     aria-labelledby="heading-parcela-{{ pedido_id }}-{{ parcela_num }}">
                                    <div class="accordion-body">
                                        <!-- ACCORDION POR MOTO -->
                                        <div class="accordion" id="accordionMotos-{{ pedido_id }}-{{ parcela_num }}">
                                            {% for chassi, titulos in dados_parcela.motos.items()|sort %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header d-flex align-items-center" id="heading-moto-{{ pedido_id }}-{{ parcela_num }}-{{ loop.index }}">
                                                    <button class="accordion-button collapsed flex-grow-1" type="button" data-bs-toggle="collapse"
                                                            data-bs-target="#collapse-moto-{{ pedido_id }}-{{ parcela_num }}-{{ loop.index }}">
                                                        <strong>Moto {{ chassi }}</strong>
                                                        <span class="badge bg-primary ms-2">{{ titulos|length }} título(s)</span>
                                                        {% set total_moto = namespace(valor=0) %}
                                                        {% for titulo in titulos %}
                                                            {% set total_moto.valor = total_moto.valor + titulo.valor_saldo %}
                                                        {% endfor %}
                                                        <span class="badge bg-success ms-2">
                                                            Total: R$ {{ total_moto.valor|valor_br }}
                                                        </span>
                                                    </button>
                                                </h2>
                                                <div id="collapse-moto-{{ pedido_id }}-{{ parcela_num }}-{{ loop.index }}"
                                                     class="accordion-collapse collapse"
                                                     aria-labelledby="heading-moto-{{ pedido_id }}-{{ parcela_num }}-{{ loop.index }}">
                                                    <div class="accordion-body">
                                                        <!-- TABELA DE TÍTULOS -->
                                                        <table class="table table-sm table-striped">
                                                            <thead>
                                                                <tr>
                                                                    <th><input type="checkbox" class="form-check-input check-all-moto" data-moto="{{ chassi }}"></th>
                                                                    <th>Tipo</th>
                                                                    <th>Vencimento</th>
                                                                    <th>Saldo</th>
                                                                    <th>Valor a Receber</th>
                                                                    <th>Status</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for titulo in titulos|sort(attribute='ordem_pagamento') %}
                                                                <tr class="{% if titulo.data_vencimento %}{% if titulo.data_vencimento < hoje %}table-danger{% elif titulo.data_vencimento == hoje %}table-warning{% endif %}{% endif %}">
                                                                    <td>
                                                                        <input class="form-check-input item-check"
                                                                               type="checkbox"
                                                                               data-id="{{ titulo.id }}"
                                                                               data-valor-saldo="{{ titulo.valor_saldo }}"
                                                                               data-moto="{{ chassi }}"
                                                                               onchange="handleCheckboxChange(this)">
                                                                    </td>
                                                                    <td>{{ titulo.tipo_titulo }}</td>
                                                                    <td>{{ titulo.data_vencimento|formatar_data_segura or 'Sem vencimento' }}</td>
                                                                    <td><strong>R$ {{ titulo.valor_saldo|valor_br }}</strong></td>
                                                                    <td>
                                                                        <input type="number"
                                                                               class="form-control form-control-sm valor-input"
                                                                               id="valor-{{ titulo.id }}"
                                                                               data-titulo-id="{{ titulo.id }}"
                                                                               step="0.01"
                                                                               min="0.01"
                                                                               max="{{ titulo.valor_saldo }}"
                                                                               value="{{ titulo.valor_saldo }}"
                                                                               style="width: 120px;"
                                                                               disabled>
                                                                    </td>
                                                                    <td><span class="badge bg-{{ 'warning' if titulo.status == 'RASCUNHO' else 'info' }}">{{ titulo.status }}</span></td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if not pedidos_agrupados %}
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle"></i> Não há títulos em aberto no momento.
        </div>
        {% endif %}

        <!-- RODAPÉ FIXO -->
        <div class="card bg-dark text-white sticky-bottom mt-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <strong>Selecionados:</strong> <span id="qtd-selecionados">0</span> títulos
                        | <strong>Total:</strong> R$ <span id="total-selecionados">0,00</span>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label mb-1 small">Empresa Recebedora *</label>
                        <select name="empresa_recebedora_id" class="form-select" required>
                            <option value="">Selecione...</option>
                            {% for empresa in empresas %}
                            <option value="{{ empresa.id }}">
                                {{ empresa.empresa }}
                                {% if empresa.tipo_conta %}({{ empresa.tipo_conta }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label mb-1 small">Data Recebimento</label>
                        <input type="date" class="form-control" id="data_recebimento_input" required>
                    </div>
                    <div class="col-md-3 text-end">
                        <label class="form-label mb-1 small">&nbsp;</label>
                        <button type="submit" class="btn btn-success btn-lg w-100">
                            <i class="fas fa-check-circle"></i> Receber
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- MODAIS DE RECEBIMENTO (FORA DO FORM PRINCIPAL) -->
    {% for pedido_id, dados_pedido in pedidos_agrupados.items() %}
        <!-- Modal Receber Pedido -->
        <div class="modal fade" id="modalReceberPedido{{ pedido_id }}" tabindex="-1">
            <div class="modal-dialog modal-md">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h4 class="modal-title m-0">
                            <i class="fas fa-dollar-sign"></i> Receber - Pedido {{ dados_pedido.pedido.numero_pedido }}
                        </h4>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="POST" action="{{ url_for('motochefe.receber_pedido_contas', pedido_id=pedido_id) }}" id="formRecebimentoPedido{{ pedido_id }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="modal-body p-4">
                            <div class="mb-4 pb-3 border-bottom">
                                <p class="text-muted mb-2 fs-6">Saldo Total:</p>
                                <h3 class="text-success mb-0">R$ {{ dados_pedido.pedido.saldo_a_receber|valor_br }}</h3>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fs-5 mb-2">Empresa Recebedora *</label>
                                <select name="empresa_recebedora_id" class="form-select form-select-md" required>
                                    <option value="">Selecione...</option>
                                    {% for emp in empresas %}
                                    <option value="{{ emp.id }}">{{ emp.empresa }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fs-5 mb-2">Valor Recebido *</label>
                                <input type="number" step="0.01" name="valor_recebido"
                                       class="form-control form-control-md"
                                       value="{{ dados_pedido.pedido.saldo_a_receber }}"
                                       required>
                            </div>
                        </div>
                        <div class="modal-footer p-3">
                            <button type="button" class="btn btn-md btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-md btn-success">
                                <i class="fas fa-check"></i> Confirmar Recebimento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
        document.getElementById('formRecebimentoPedido{{ pedido_id }}').addEventListener('submit', function(event) {
            event.preventDefault();
            const form = event.target;
            const valorRecebido = form.querySelector('input[name="valor_recebido"]').value;
            const empresaSelect = form.querySelector('select[name="empresa_recebedora_id"]');
            const empresaNome = empresaSelect.options[empresaSelect.selectedIndex].text;

            const confirmacao = confirm(
                'Confirmar recebimento do Pedido {{ dados_pedido.pedido.numero_pedido }}?\n\n' +
                'Valor: R$ ' + parseFloat(valorRecebido).toFixed(2).replace('.', ',') + '\n' +
                'Empresa: ' + empresaNome + '\n\n' +
                'Esta ação não poderá ser desfeita.'
            );

            if (confirmacao) {
                form.submit();
            }
        });
        </script>

        <!-- Modais Receber Moto -->
        {% for parcela_num, dados_parcela in dados_pedido.parcelas.items() %}
            {% for chassi, titulos in dados_parcela.motos.items() %}
                {% set total_moto_modal = namespace(valor=0) %}
                {% for titulo in titulos %}
                    {% set total_moto_modal.valor = total_moto_modal.valor + titulo.valor_saldo %}
                {% endfor %}
                {% if total_moto_modal.valor > 0 %}
                <div class="modal fade" id="modalReceberMoto{{ pedido_id }}-{{ chassi|replace('.', '-') }}" tabindex="-1">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h6 class="modal-title m-0">
                                    <i class="fas fa-motorcycle"></i> Receber - Moto {{ chassi }}
                                </h6>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form method="POST" action="{{ url_for('motochefe.receber_moto_contas', pedido_id=pedido_id, chassi=chassi) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="modal-body p-3">
                                    <div class="mb-2 pb-2 border-bottom">
                                        <small class="text-muted">Pedido:</small> <strong>{{ dados_pedido.pedido.numero_pedido }}</strong><br>
                                        <small class="text-muted">Saldo Moto:</small><br>
                                        <h5 class="text-warning mb-0">R$ {{ total_moto_modal.valor|valor_br }}</h5>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small mb-1">Empresa Recebedora *</label>
                                        <select name="empresa_recebedora_id" class="form-select form-select-sm" required>
                                            <option value="">Selecione...</option>
                                            {% for emp in empresas %}
                                            <option value="{{ emp.id }}">{{ emp.empresa }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small mb-1">Valor Recebido *</label>
                                        <input type="number" step="0.01" name="valor_recebido"
                                               class="form-control form-control-sm"
                                               value="{{ total_moto_modal.valor }}"
                                               required>
                                    </div>
                                </div>
                                <div class="modal-footer p-2">
                                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-sm btn-warning">
                                        <i class="fas fa-check"></i> Confirmar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endfor %}

    <!-- Paginação -->
    {% if paginacao %}
        <div class="mt-3">
            {% include 'motochefe/_pagination.html' %}
        </div>
    {% endif %}
</div>

<script>
// Função helper para formatar valores monetários no padrão brasileiro
function formatarValorBR(valor, decimais = 2) {
    if (valor === null || valor === undefined) return '0,00';
    const numero = parseFloat(valor);
    if (isNaN(numero)) return '0,00';

    // Formatar com decimais e substituir separadores
    return numero.toFixed(decimais)
        .replace(/\d(?=(\d{3})+\.)/g, '$&.')  // Adiciona ponto a cada 3 dígitos
        .replace('.', ',');  // Troca ponto por vírgula no decimal
}

// Função para habilitar/desabilitar campo valor quando checkbox é marcado
function handleCheckboxChange(checkbox) {
    const tituloId = checkbox.dataset.id;
    const valorInput = document.getElementById(`valor-${tituloId}`);

    if (checkbox.checked) {
        valorInput.disabled = false;
        valorInput.focus();
    } else {
        valorInput.disabled = true;
        // Restaurar valor original
        valorInput.value = checkbox.dataset.valorSaldo;
    }

    atualizarTotal();
}

function atualizarTotal() {
    const checks = document.querySelectorAll('.item-check:checked');
    let total = 0;

    checks.forEach(c => {
        const tituloId = c.dataset.id;
        const valorInput = document.getElementById(`valor-${tituloId}`);
        const valorReceber = parseFloat(valorInput.value || 0);
        total += valorReceber;
    });

    document.getElementById('qtd-selecionados').textContent = checks.length;
    document.getElementById('total-selecionados').textContent = formatarValorBR(total);
}

// Atualizar total quando valor input mudar
document.querySelectorAll('.valor-input').forEach(input => {
    input.addEventListener('input', atualizarTotal);
});

// Check all por moto
document.querySelectorAll('.check-all-moto').forEach(checkAll => {
    checkAll.addEventListener('change', function() {
        const moto = this.dataset.moto;
        document.querySelectorAll(`.item-check[data-moto="${moto}"]`).forEach(c => {
            c.checked = this.checked;
            handleCheckboxChange(c);
        });
    });
});

document.getElementById('formRecebimento').addEventListener('submit', function(e) {
    e.preventDefault();
    const checks = document.querySelectorAll('.item-check:checked');

    if (checks.length === 0) {
        alert('Selecione ao menos um título');
        return;
    }

    const itens = [];
    let erro = false;

    checks.forEach(c => {
        const tituloId = c.dataset.id;
        const valorInput = document.getElementById(`valor-${tituloId}`);
        const valorReceber = parseFloat(valorInput.value || 0);
        const valorSaldo = parseFloat(c.dataset.valorSaldo || 0);

        // Validar valor
        if (valorReceber <= 0) {
            alert(`Valor a receber deve ser maior que zero (Título #${tituloId})`);
            erro = true;
            return;
        }

        if (valorReceber > valorSaldo) {
            alert(`Valor a receber (R$ ${formatarValorBR(valorReceber)}) não pode ser maior que o saldo (R$ ${formatarValorBR(valorSaldo)}) - Título #${tituloId}`);
            erro = true;
            return;
        }

        itens.push({
            id: tituloId,
            valor: valorReceber.toFixed(2)
        });
    });

    if (erro) return;

    document.getElementById('itens_recebimento').value = JSON.stringify(itens);
    document.getElementById('data_recebimento_hidden').value = document.getElementById('data_recebimento_input').value;
    this.submit();
});
</script>
{% endblock %}
