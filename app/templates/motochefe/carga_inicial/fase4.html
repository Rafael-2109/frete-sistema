{% extends "base.html" %}

{% block title %}Fase 4: Pedidos e Vendas - MotoChefe{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-file-invoice"></i> Fase 4: Importa√ß√£o de Pedidos e Vendas</h2>
            <p class="text-muted">Importa√ß√£o de pedidos com itens (chassis vinculados) e gera√ß√£o autom√°tica de t√≠tulos</p>
        </div>
    </div>

    <!-- Alertas -->
    <div id="alertContainer"></div>

    <!-- INSTRU√á√ïES -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle"></i> Instru√ß√µes Importantes</h5>
                <ol class="mb-0">
                    <li><strong>PR√â-REQUISITO:</strong> Fases 1, 2 e 3 devem ter sido executadas (cadastros base)</li>
                    <li><strong>Modo COMPLETO:</strong> Gera TODOS os t√≠tulos (VENDA + FRETE + MONTAGEM + MOVIMENTACAO)</li>
                    <li><strong>Modo HISTORICO:</strong> Gera apenas VENDA + FRETE (use para importa√ß√£o hist√≥rica)</li>
                    <li><strong>UPSERT ativado:</strong> Pode re-executar sem duplicar pedidos</li>
                    <li><strong>Backup recomendado</strong> antes de executar</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- SELETOR DE MODO -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-cog"></i> Modo de Opera√ß√£o</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">Selecione o modo de importa√ß√£o conforme seu objetivo:</p>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100" id="cardCompleto" style="cursor: pointer; border: 3px solid var(--semantic-success);">
                                <div class="card-body">
                                    <h5 class="text-success"><i class="fas fa-check-circle"></i> COMPLETO (Padr√£o)</h5>
                                    <p class="mb-2"><strong>Quando usar:</strong> Pedidos NOVOS criados pelo sistema</p>
                                    <p class="mb-2"><strong>T√≠tulos gerados:</strong></p>
                                    <ul class="small">
                                        <li>‚úÖ VENDA</li>
                                        <li>‚úÖ FRETE</li>
                                        <li>‚úÖ MONTAGEM (se contratada)</li>
                                        <li>‚úÖ MOVIMENTACAO</li>
                                    </ul>
                                    <p class="mb-0"><strong>T√≠tulos A Pagar:</strong> ‚úÖ SIM (MONTAGEM + MOVIMENTACAO)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100" id="cardHistorico" style="cursor: pointer; border: 1px solid var(--border);">
                                <div class="card-body">
                                    <h5 class="text-muted"><i class="fas fa-history"></i> HISTORICO</h5>
                                    <p class="mb-2"><strong>Quando usar:</strong> Importa√ß√£o de dados hist√≥ricos</p>
                                    <p class="mb-2"><strong>T√≠tulos gerados:</strong></p>
                                    <ul class="small">
                                        <li>‚úÖ VENDA</li>
                                        <li>‚úÖ FRETE</li>
                                        <li>‚ùå MONTAGEM (vir√° da Fase 6)</li>
                                        <li>‚ùå MOVIMENTACAO (vir√° da Fase 7)</li>
                                    </ul>
                                    <p class="mb-0"><strong>T√≠tulos A Pagar:</strong> ‚ùå N√ÉO (vir√£o das Fases 5/6/7)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="modoSelecionado" value="COMPLETO">

                    <div class="alert alert-success mt-3" id="alertModo">
                        <strong>Modo selecionado:</strong> <span id="textoModo">COMPLETO</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- √ÅREA DE UPLOAD -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-file-upload"></i> Upload dos Arquivos Excel</h5>
                </div>
                <div class="card-body">
                    <!-- Bot√£o Download Template -->
                    <div class="mb-4">
                        <a href="{{ url_for('motochefe.download_template', fase='fase4') }}"
                           class="btn btn-success btn-lg">
                            <i class="fas fa-download"></i> Baixar Template Excel
                        </a>
                        <p class="text-muted mt-2 mb-0">
                            <small>O template cont√©m 2 abas: Pedidos + Itens com instru√ß√µes detalhadas</small>
                        </p>
                    </div>

                    <hr>

                    <!-- Formul√°rio de Upload -->
                    <form id="formUpload" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="font-weight-bold">Arquivo de Pedidos (*):</label>
                                <input type="file" class="form-control-file" id="inputPedidos" name="pedidos" accept=".xlsx,.xls" required>
                                <small class="text-muted">Aba: Pedidos</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="font-weight-bold">Arquivo de Itens (*):</label>
                                <input type="file" class="form-control-file" id="inputItens" name="itens" accept=".xlsx,.xls" required>
                                <small class="text-muted">Aba: Itens</small>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg" id="btnImportar">
                            <i class="fas fa-play"></i> Executar Importa√ß√£o
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- RESULTADO DA IMPORTA√á√ÉO -->
    <div class="row mb-4" id="areaResultado" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header" id="resultadoHeader">
                    <h5 class="mb-0" id="resultadoTitulo"></h5>
                </div>
                <div class="card-body" id="resultadoBody">
                    <!-- Conte√∫do din√¢mico -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card:hover {
    box-shadow: 0 4px 8px hsla(0, 0%, 0%, 0.2);
}

#cardCompleto.selected {
    border: 3px solid var(--semantic-success) !important;
}

#cardHistorico.selected {
    border: 3px solid var(--amber-50) !important;
}

.small {
    font-size: 0.9rem;
}
</style>

<script>
let modoAtual = 'COMPLETO';

// ============================================================
// SELE√á√ÉO DE MODO
// ============================================================

document.getElementById('cardCompleto').addEventListener('click', function() {
    selecionarModo('COMPLETO');
});

document.getElementById('cardHistorico').addEventListener('click', function() {
    selecionarModo('HISTORICO');
});

function selecionarModo(modo) {
    modoAtual = modo;
    document.getElementById('modoSelecionado').value = modo;

    // Atualizar visual dos cards
    const successColor = getComputedStyle(document.documentElement).getPropertyValue('--semantic-success').trim() || '#28a745';
    const amberColor = getComputedStyle(document.documentElement).getPropertyValue('--amber-50').trim() || '#ffc107';
    const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#dee2e6';

    if (modo === 'COMPLETO') {
        document.getElementById('cardCompleto').style.border = '3px solid ' + successColor;
        document.getElementById('cardHistorico').style.border = '1px solid ' + borderColor;

        document.getElementById('alertModo').className = 'alert alert-success mt-3';
        document.getElementById('textoModo').textContent = 'COMPLETO - Gera todos os t√≠tulos automaticamente';
    } else {
        document.getElementById('cardCompleto').style.border = '1px solid ' + borderColor;
        document.getElementById('cardHistorico').style.border = '3px solid ' + amberColor;

        document.getElementById('alertModo').className = 'alert alert-warning mt-3';
        document.getElementById('textoModo').textContent = 'HISTORICO - Gera apenas VENDA + FRETE (complementar com Fases 5/6/7)';
    }
}

// ============================================================
// EXECUTAR IMPORTA√á√ÉO
// ============================================================

document.getElementById('formUpload').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData();
    formData.append('pedidos', document.getElementById('inputPedidos').files[0]);
    formData.append('itens', document.getElementById('inputItens').files[0]);
    formData.append('modo', modoAtual);

    const btnImportar = document.getElementById('btnImportar');
    btnImportar.disabled = true;
    btnImportar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando...';

    try {
        const response = await fetch('{{ url_for("motochefe.importar_fase4") }}', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.sucesso) {
            mostrarResultadoSucesso(data);
            mostrarAlerta(data.mensagem, 'success');

            // Limpar formul√°rio
            document.getElementById('formUpload').reset();
        } else {
            mostrarResultadoErro(data);
            mostrarAlerta(data.mensagem, 'danger');
        }
    } catch (error) {
        mostrarAlerta('Erro fatal: ' + error.message, 'danger');
    } finally {
        btnImportar.disabled = false;
        btnImportar.innerHTML = '<i class="fas fa-play"></i> Executar Importa√ß√£o';
    }
});

function mostrarResultadoSucesso(data) {
    const resultadoHeader = document.getElementById('resultadoHeader');
    const resultadoTitulo = document.getElementById('resultadoTitulo');
    const resultadoBody = document.getElementById('resultadoBody');

    resultadoHeader.className = 'card-header bg-success text-white';
    resultadoTitulo.innerHTML = '<i class="fas fa-check-circle"></i> Importa√ß√£o Conclu√≠da com Sucesso!';

    const detalhes = data.detalhes || {};

    let html = '<div class="row">';
    html += '<div class="col-md-6">';
    html += '<h6>üìä Estat√≠sticas da Importa√ß√£o</h6>';
    html += '<ul>';
    html += `<li>Pedidos processados: ${detalhes.total_pedidos || 0}</li>`;
    html += `<li>Pedidos inseridos: ${detalhes.pedidos_inseridos || 0}</li>`;
    html += `<li>Pedidos atualizados: ${detalhes.pedidos_atualizados || 0}</li>`;
    html += `<li>Itens inseridos: ${detalhes.itens_inseridos || 0}</li>`;
    html += `<li>Motos atualizadas: ${detalhes.motos_atualizadas || 0}</li>`;
    html += '</ul></div>';

    html += '<div class="col-md-6">';
    html += '<h6>üí∞ T√≠tulos Criados</h6>';
    html += '<ul>';
    html += `<li>T√≠tulos A Receber: ${detalhes.total_titulos_financeiros || 0}</li>`;
    html += `<li>T√≠tulos A Pagar: ${detalhes.total_titulos_a_pagar || 0}</li>`;
    html += '</ul>';

    if (modoAtual === 'HISTORICO') {
        html += '<div class="alert alert-warning mt-2">';
        html += '<small><strong>‚ö†Ô∏è Modo HISTORICO:</strong> Execute as Fases 5, 6 e 7 para complementar com Comiss√µes, Montagens e Movimenta√ß√µes.</small>';
        html += '</div>';
    }

    html += '</div></div>';

    if (detalhes.avisos && detalhes.avisos.length > 0) {
        html += '<hr><h6>‚ö†Ô∏è Avisos:</h6><ul class="text-warning small">';
        detalhes.avisos.forEach(aviso => {
            html += `<li>${aviso}</li>`;
        });
        html += '</ul>';
    }

    resultadoBody.innerHTML = html;
    document.getElementById('areaResultado').style.display = 'block';
    document.getElementById('areaResultado').scrollIntoView({ behavior: 'smooth' });
}

function mostrarResultadoErro(data) {
    const resultadoHeader = document.getElementById('resultadoHeader');
    const resultadoTitulo = document.getElementById('resultadoTitulo');
    const resultadoBody = document.getElementById('resultadoBody');

    resultadoHeader.className = 'card-header bg-danger text-white';
    resultadoTitulo.innerHTML = '<i class="fas fa-times-circle"></i> Erro na Importa√ß√£o';

    let html = `<p class="text-danger"><strong>${data.mensagem}</strong></p>`;

    if (data.erros && data.erros.length > 0) {
        html += '<hr><h6>Erros encontrados:</h6><ul class="text-danger small">';
        data.erros.forEach(erro => {
            html += `<li>${erro}</li>`;
        });
        html += '</ul>';
    }

    resultadoBody.innerHTML = html;
    document.getElementById('areaResultado').style.display = 'block';
    document.getElementById('areaResultado').scrollIntoView({ behavior: 'smooth' });
}

// ============================================================
// HELPER: ALERTA
// ============================================================

function mostrarAlerta(mensagem, tipo) {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${tipo} alert-dismissible fade show`;
    alert.role = 'alert';
    alert.innerHTML = `
        ${mensagem}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    alertContainer.appendChild(alert);

    // Auto-remover ap√≥s 10 segundos
    setTimeout(() => {
        alert.remove();
    }, 10000);
}
</script>
{% endblock %}
