{% extends "base.html" %}

{% block title %}Claude AI - Intelig√™ncia Artificial{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Principal -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 bg-gradient-primary text-white">
                <div class="card-body py-4">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <div class="d-flex align-items-center">
                                <div class="me-4">
                                    <i class="fas fa-brain fa-3x opacity-75"></i>
                                </div>
                                <div>
                                    <h2 class="mb-1">Nacom Goya IA</h2>
                                    <p class="mb-0 h5 opacity-75">
                                        <i class="fas fa-sparkles me-2"></i>
                                        Powered by Claude 4 Sonnet - Intelig√™ncia Artificial Avan√ßada
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 text-end">
                            <div class="d-flex justify-content-end align-items-center gap-3">
                                <div>
                                    <span id="status-badge" class="badge bg-light text-dark px-3 py-2">
                                        <i class="fas fa-circle-notch fa-spin me-1"></i> Verificando...
                                    </span>
                                </div>
                                <!-- üß† MODOS IA AVAN√áADOS -->
                                {% if current_user.perfil in ['admin', 'administrador'] %}
                                <div class="dropdown">
                                    <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Modos Especiais">
                                        <i class="fas fa-brain me-1"></i> Modos IA
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('claude_ai.admin_free_mode_dashboard') }}">
                                            <i class="fas fa-unlock-alt"></i> Modo Estruturado
                                        </a></li>
                                        <li><a class="dropdown-item fw-bold" href="{{ url_for('claude_ai.true_autonomy_dashboard') }}">
                                            <i class="fas fa-brain"></i> <span class="text-primary">Autonomia REAL</span>
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><small class="dropdown-item-text text-muted px-3">
                                            <i class="fas fa-info-circle"></i> Autonomia Real = Claude decide tudo sozinho
                                        </small></li>
                                    </ul>
                                </div>
                                {% endif %}
                                <button class="btn btn-outline-light" onclick="verificarStatus()" title="Atualizar Status">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- √Årea Principal do Chat -->
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light border-bottom-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üí¨ Conversa com Claude AI</h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="clearChat()" title="Limpar Chat">
                                <i class="fas fa-broom"></i> Limpar
                            </button>
                            <button class="btn btn-outline-primary" onclick="exportarChat()" title="Exportar Chat">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0" style="height: 500px;">
                    <!-- √Årea de Mensagens -->
                    <div id="chat-messages" class="h-100 overflow-auto p-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <!-- Mensagem de boas-vindas -->
                        <div class="message-container mb-4">
                            <div class="d-flex align-items-start">
                                <div class="avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px; min-width: 45px;">
                                    üß†
                                </div>
                                <div class="message-content flex-grow-1">
                                    <div class="bg-white rounded-3 p-4 shadow-sm border-start border-primary border-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0 text-primary">
                                                <i class="fas fa-sparkles me-1"></i>
                                                Claude 4 Sonnet
                                            </h6>
                                            <small class="text-muted">Sistema iniciado</small>
                                        </div>
                                        
                                        <p class="mb-3">
                                            Ol√°! Sou o Claude AI integrado ao seu sistema de fretes com <strong>intelig√™ncia de √∫ltima gera√ß√£o</strong>.
                                        </p>
                                        
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <h6 class="text-primary mb-2">üéØ Capacidades Avan√ßadas:</h6>
                                                <ul class="list-unstyled small">
                                                    <li><i class="fas fa-check-circle text-success me-2"></i>An√°lises complexas e insights profundos</li>
                                                    <li><i class="fas fa-check-circle text-success me-2"></i>Interpreta√ß√£o inteligente de dados</li>
                                                    <li><i class="fas fa-check-circle text-success me-2"></i>Detec√ß√£o de padr√µes e anomalias</li>
                                                    <li><i class="fas fa-check-circle text-success me-2"></i>Previs√µes e tend√™ncias</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="text-primary mb-2">üí° Consultas Inteligentes:</h6>
                                                <ul class="list-unstyled small">
                                                    <li><i class="fas fa-arrow-right text-primary me-2"></i>"Analise entregas por regi√£o"</li>
                                                    <li><i class="fas fa-arrow-right text-primary me-2"></i>"Tend√™ncias √∫ltimos 30 dias"</li>
                                                    <li><i class="fas fa-arrow-right text-primary me-2"></i>"Compare transportadoras"</li>
                                                    <li><i class="fas fa-arrow-right text-primary me-2"></i>"Otimize custos operacionais"</li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-info mt-3 mb-0">
                                            <i class="fas fa-lightbulb me-2"></i>
                                            <strong>Dica:</strong> Seja espec√≠fico em suas consultas para an√°lises mais precisas e insights valiosos!
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- √Årea de Input -->
                <div class="card-footer bg-light">
                    <div class="input-group">
                        <input type="text" id="user-input" class="form-control form-control-lg" 
                               placeholder="Digite sua consulta... (ex: 'Como est√° o desempenho das entregas da regi√£o Sul nos √∫ltimos 15 dias?')" 
                               onkeypress="if(event.key==='Enter') enviarMensagem()">
                        <button class="btn btn-primary btn-lg px-4" onclick="enviarMensagem()" id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- Sugest√µes R√°pidas -->
                    <div class="mt-3">
                        <!-- üß† SUGEST√ïES INTELIGENTES -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted fw-bold">
                                <i class="fas fa-lightbulb me-1"></i>
                                SUGEST√ïES INTELIGENTES
                            </small>
                            <button class="btn btn-outline-secondary btn-sm" onclick="recarregarSugestoes()" title="Atualizar Sugest√µes">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        
                        <div id="intelligent-suggestions" class="d-flex flex-wrap gap-2">
                            <!-- Carregando sugest√µes... -->
                            <div class="suggestion-loading text-center w-100 py-3">
                                <i class="fas fa-brain fa-spin text-primary"></i>
                                <small class="text-muted d-block mt-1">Gerando sugest√µes personalizadas...</small>
                            </div>
                        </div>
                        
                        <!-- Sugest√µes b√°sicas de fallback -->
                        <div id="fallback-suggestions" class="d-none">
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-primary btn-sm suggestion-btn" onclick="usarSugestao('Status do sistema de fretes')">
                                    üìä Status Sistema
                                </button>
                                <button class="btn btn-outline-success btn-sm suggestion-btn" onclick="usarSugestao('Analise o desempenho das entregas por regi√£o nos √∫ltimos 30 dias')">
                                    üéØ An√°lise Regional
                                </button>
                                <button class="btn btn-outline-info btn-sm suggestion-btn" onclick="usarSugestao('Compare o desempenho das transportadoras')">
                                    üìà Comparar Transportadoras
                                </button>
                                <button class="btn btn-outline-warning btn-sm suggestion-btn" onclick="usarSugestao('Identifique gargalos no processo log√≠stico')">
                                    üîç Detectar Gargalos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Painel Lateral - Informa√ß√µes e Estat√≠sticas -->
        <div class="col-lg-4">
            <div class="row g-3">
                <!-- Status do Sistema -->
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-tachometer-alt me-2"></i>Status do Sistema
                            </h6>
                        </div>
                        <div class="card-body" id="system-status">
                            <div class="text-center text-muted">
                                <i class="fas fa-circle-notch fa-spin fa-2x mb-2"></i>
                                <p>Carregando status...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configura√ß√£o da API (se necess√°rio) -->
                <div class="col-12" id="config-panel" style="display: none;">
                    <div class="card shadow-sm border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>Modo Fallback Ativo
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Sistema em Modo Fallback</strong><br>
                                <p class="small mb-0">O sistema est√° operando com respostas b√°sicas. Entre em contato com o suporte t√©cnico se precisar de funcionalidades avan√ßadas.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hist√≥rico Recente -->
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-history me-2"></i>Consultas Recentes
                            </h6>
                        </div>
                        <div class="card-body" id="recent-queries">
                            <p class="text-muted text-center">
                                <i class="fas fa-clock"></i> Suas consultas aparecer√£o aqui
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estilos Personalizados -->
<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.message-container {
    animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.suggestion-btn {
    transition: all 0.3s ease;
}

.suggestion-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

#chat-messages {
    scroll-behavior: smooth;
}

#chat-messages::-webkit-scrollbar {
    width: 8px;
}

#chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

#chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

#chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.avatar {
    font-size: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card {
    border: none;
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
</style>

<!-- JavaScript -->
<script>
let claudeRealMode = false;
let chatHistory = [];

// Verificar status ao carregar
document.addEventListener('DOMContentLoaded', function() {
    verificarStatus();
    carregarStatusSistema();
    carregarSugestoesInteligentes(); // üß† Carregar sugest√µes inteligentes
});

function verificarStatus() {
    fetch('/claude-ai/real/status')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('status-badge');
            const configPanel = document.getElementById('config-panel');
            
            if (data.modo_real && data.client_conectado) {
                badge.className = 'badge bg-success px-3 py-2';
                badge.innerHTML = '<i class="fas fa-check-circle me-1"></i> Claude 4 Sonnet Ativo';
                configPanel.style.display = 'none';
                claudeRealMode = true;
            } else {
                badge.className = 'badge bg-warning text-dark px-3 py-2';
                badge.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i> Modo Fallback';
                configPanel.style.display = 'block';
                claudeRealMode = false;
            }
        })
        .catch(error => {
            const badge = document.getElementById('status-badge');
            badge.className = 'badge bg-danger px-3 py-2';
            badge.innerHTML = '<i class="fas fa-times-circle me-1"></i> Erro de Conex√£o';
            console.error('Erro:', error);
        });
}

function carregarStatusSistema() {
    const statusDiv = document.getElementById('system-status');
    
    // üöÄ CARREGAR M√âTRICAS REAIS DO POSTGRESQL
    statusDiv.innerHTML = `
        <div class="row g-2 text-center">
            <div class="col-6">
                <div class="p-2 bg-success bg-opacity-10 rounded">
                    <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                    <small class="text-muted d-block">Uptime</small>
                </div>
            </div>
            <div class="col-6">
                <div class="p-2 bg-info bg-opacity-10 rounded">
                    <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                    <small class="text-muted d-block">Resposta</small>
                </div>
            </div>
            <div class="col-6">
                <div class="p-2 bg-primary bg-opacity-10 rounded">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <small class="text-muted d-block">Consultas hoje</small>
                </div>
            </div>
            <div class="col-6">
                <div class="p-2 bg-warning bg-opacity-10 rounded">
                    <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
                    <small class="text-muted d-block">Satisfa√ß√£o</small>
                </div>
            </div>
        </div>
    `;
    
    // Buscar m√©tricas reais da API
    fetch('/claude-ai/api/metricas-reais')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.metricas) {
                const metricas = data.metricas;
                
                // Calcular valores para exibi√ß√£o
                const uptime = metricas.sistema?.uptime_percentual || 0;
                const tempoResposta = metricas.performance?.tempo_resposta_db || 0;
                const consultasHoje = metricas.claude_ai?.sessoes_hoje || 0;
                const satisfacao = metricas.claude_ai?.satisfacao_media || 0;
                
                // Atualizar interface com dados reais
                statusDiv.innerHTML = `
                    <div class="row g-2 text-center">
                        <div class="col-6">
                            <div class="p-2 bg-success bg-opacity-10 rounded">
                                <h6 class="mb-0 text-success">${uptime}%</h6>
                                <small class="text-muted">Uptime</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-info bg-opacity-10 rounded">
                                <h6 class="mb-0 text-info">${tempoResposta}ms</h6>
                                <small class="text-muted">Resposta</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-primary bg-opacity-10 rounded">
                                <h6 class="mb-0 text-primary">${consultasHoje}</h6>
                                <small class="text-muted">Consultas hoje</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-warning bg-opacity-10 rounded">
                                <h6 class="mb-0 text-warning">${satisfacao.toFixed(1)}/5</h6>
                                <small class="text-muted">Satisfa√ß√£o</small>
                            </div>
                        </div>
                    </div>
                `;
                
                console.log('‚úÖ M√©tricas reais carregadas:', metricas);
            } else {
                throw new Error(data.error || 'Erro ao carregar m√©tricas');
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar m√©tricas reais:', error);
            // Fallback para dados b√°sicos
            statusDiv.innerHTML = `
                <div class="row g-2 text-center">
                    <div class="col-12">
                        <div class="p-2 bg-warning bg-opacity-10 rounded">
                            <small class="text-muted">‚ö†Ô∏è M√©tricas indispon√≠veis</small>
                        </div>
                    </div>
                </div>
            `;
        });
}

function usarSugestao(texto) {
    document.getElementById('user-input').value = texto;
    enviarMensagem();
}

function enviarMensagem() {
    const input = document.getElementById('user-input');
    const query = input.value.trim();
    
    if (!query) return;
    
    // Adicionar mensagem do usu√°rio
    adicionarMensagem('user', query);
    input.value = '';
    
    // Mostrar loading
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Adicionar ao hist√≥rico
    adicionarAoHistorico(query);
    
    // Enviar para Claude real
    const csrfToken = getCSRFToken();
    console.log('üîí CSRF Token:', csrfToken ? 'Presente' : 'Ausente');
    
    fetch('/claude-ai/real', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-CSRF-Token': csrfToken,  // Header alternativo
            'HTTP_X_CSRF_TOKEN': csrfToken  // Header alternativo para produ√ß√£o
        },
        body: JSON.stringify({
            query: query,
            csrf_token: csrfToken  // Incluir no body tamb√©m
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            adicionarMensagem('claude', data.response);
        } else {
            adicionarMensagem('error', 'Erro: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        adicionarMensagem('error', 'Erro de conex√£o: ' + error.message);
    })
    .finally(() => {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
    });
}

function adicionarMensagem(type, content) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-container mb-4';
    
    const timestamp = new Date().toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    let avatar, userName, bgClass, borderClass;
    
    if (type === 'user') {
        avatar = 'üë§';
        userName = 'Voc√™';
        bgClass = 'bg-primary text-white';
        borderClass = 'border-primary';
    } else if (type === 'claude') {
        avatar = 'üß†';
        userName = claudeRealMode ? 'Claude 4 Sonnet' : 'Claude Fallback';
        bgClass = 'bg-success text-white';
        borderClass = 'border-success';
    } else {
        avatar = '‚ö†Ô∏è';
        userName = 'Sistema';
        bgClass = 'bg-danger text-white';
        borderClass = 'border-danger';
    }
    
    messageDiv.innerHTML = `
        <div class="d-flex align-items-start ${type === 'user' ? 'flex-row-reverse' : ''}">
            <div class="avatar ${bgClass} rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px; min-width: 45px;">
                ${avatar}
            </div>
            <div class="message-content flex-grow-1">
                <div class="bg-white rounded-3 p-3 shadow-sm border-start ${borderClass} border-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">${userName}</h6>
                        <small class="text-muted">${timestamp}</small>
                    </div>
                    <div class="message-text">
                        ${formatMessage(content)}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    chatHistory.push({type, content, timestamp});
}

function formatMessage(text) {
    return text
        // ‚úÖ CORRE√á√ÉO: Processar links em Markdown PRIMEIRO
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="btn btn-success btn-sm me-2" target="_blank"><i class="fas fa-download me-1"></i>$1</a>')
        // Processar URLs simples tamb√©m
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" class="text-primary" target="_blank">$1</a>')
        // Processar caminhos de arquivo locais
        .replace(/\/static\/reports\/([^<\s]+)/g, '<a href="/static/reports/$1" class="btn btn-primary btn-sm me-2" target="_blank"><i class="fas fa-file-excel me-1"></i>Baixar Relat√≥rio</a>')
        // Formata√ß√£o de texto
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/### (.*?)$/gm, '<h6 class="text-primary">$1</h6>')
        .replace(/## (.*?)$/gm, '<h5 class="text-primary">$1</h5>')
        .replace(/# (.*?)$/gm, '<h4 class="text-primary">$1</h4>')
        .replace(/```([\s\S]*?)```/g, '<pre class="bg-light p-3 rounded border"><code>$1</code></pre>')
        .replace(/`(.*?)`/g, '<code class="bg-light px-2 py-1 rounded">$1</code>')
        // Processar emojis de status
        .replace(/‚úÖ/g, '<i class="fas fa-check-circle text-success"></i>')
        .replace(/‚ùå/g, '<i class="fas fa-times-circle text-danger"></i>')
        .replace(/‚ö†Ô∏è/g, '<i class="fas fa-exclamation-triangle text-warning"></i>')
        .replace(/üìä/g, '<i class="fas fa-chart-bar text-info"></i>')
        .replace(/üìà/g, '<i class="fas fa-chart-line text-success"></i>')
        .replace(/üìã/g, '<i class="fas fa-clipboard text-primary"></i>')
        .replace(/üîó/g, '<i class="fas fa-link text-info"></i>')
        .replace(/üí∞/g, '<i class="fas fa-dollar-sign text-success"></i>')
        .replace(/üìÖ/g, '<i class="fas fa-calendar text-primary"></i>')
        .replace(/\n/g, '<br>');
}

function adicionarAoHistorico(query) {
    const recentQueries = document.getElementById('recent-queries');
    const queryItem = document.createElement('div');
    queryItem.className = 'mb-2 p-2 bg-light rounded cursor-pointer';
    queryItem.innerHTML = `
        <small class="text-muted d-block">${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</small>
        <div class="text-truncate">${query}</div>
    `;
    queryItem.onclick = () => {
        document.getElementById('user-input').value = query;
    };
    
    recentQueries.prepend(queryItem);
    
    // Manter apenas as 5 consultas mais recentes
    const items = recentQueries.children;
    if (items.length > 5) {
        recentQueries.removeChild(items[items.length - 1]);
    }
}

function clearChat() {
    if (confirm('Tem certeza que deseja limpar todo o hist√≥rico do chat?')) {
        document.getElementById('chat-messages').innerHTML = '';
        chatHistory = [];
        location.reload();
    }
}

function exportarChat() {
    const data = {
        timestamp: new Date().toISOString(),
        user: '{{ current_user.nome }}',
        chat_history: chatHistory
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `claude-chat-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function getCSRFToken() {
    // Buscar token CSRF de m√∫ltiplas formas para compatibilidade
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }
    
    // Fallback: buscar em cookies ou outros lugares
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        if (cookie.trim().startsWith('csrf_token=')) {
            return cookie.split('=')[1];
        }
    }
    
    // Se n√£o encontrar, tentar gerar via Flask
    console.warn('‚ö†Ô∏è Token CSRF n√£o encontrado, usando fallback');
    return '';
}

// Enter para enviar
document.getElementById('user-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        enviarMensagem();
    }
});

// üß† SISTEMA DE SUGEST√ïES INTELIGENTES

function carregarSugestoesInteligentes() {
    const suggestionsContainer = document.getElementById('intelligent-suggestions');
    const fallbackContainer = document.getElementById('fallback-suggestions');
    
    // Mostrar loading
    showSuggestionsLoading();
    
    const csrfToken = getCSRFToken();
    fetch('/claude-ai/api/suggestions', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-CSRF-Token': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.suggestions && data.suggestions.length > 0) {
            // Renderizar sugest√µes inteligentes
            renderSugestoes(data.suggestions, data.user_profile);
            console.log('üß† Sugest√µes inteligentes carregadas:', data.suggestions.length, 'para perfil:', data.user_profile);
        } else {
            // Fallback para sugest√µes b√°sicas
            showFallbackSuggestions();
            console.warn('‚ö†Ô∏è Usando sugest√µes de fallback:', data.error || 'Nenhuma sugest√£o dispon√≠vel');
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar sugest√µes:', error);
        showFallbackSuggestions();
    });
}

function renderSugestoes(suggestions, userProfile) {
    const container = document.getElementById('intelligent-suggestions');
    const fallbackContainer = document.getElementById('fallback-suggestions');
    
    // Esconder fallback e loading
    fallbackContainer.classList.add('d-none');
    
    // Limpar container
    container.innerHTML = '';
    
    // Categorias de cores para diferentes tipos de sugest√µes
    const categoryColors = {
        'vendedor_diario': 'primary',
        'vendedor_problemas': 'warning',
        'vendedor_oportunidade': 'info',
        'financeiro_urgente': 'danger',
        'financeiro_analise': 'success',
        'operacional_urgente': 'danger',
        'operacional_diario': 'primary',
        'admin_dashboard': 'dark',
        'contextual_comparacao': 'secondary',
        'contextual_cliente': 'info',
        // üß† NOVAS CATEGORIAS BASEADAS EM DADOS REAIS
        'data_maior_cliente': 'warning',
        'data_top_clientes': 'primary',
        'data_agendamento_urgente': 'danger',
        'data_entregas_atrasadas': 'danger',
        'data_entregas_proximas': 'warning',
        'data_embarques_pendentes': 'info',
        'data_faturas_vencimento': 'warning',
        'basic': 'outline-secondary'
    };
    
    // Renderizar cada sugest√£o
    suggestions.forEach((suggestion, index) => {
        const color = categoryColors[suggestion.category] || 'outline-primary';
        const priority = suggestion.priority || 3;
        
        const suggestionBtn = document.createElement('button');
        suggestionBtn.className = `btn btn-${color} btn-sm suggestion-btn me-2 mb-2`;
        suggestionBtn.style.animationDelay = `${index * 100}ms`;
        suggestionBtn.style.animation = 'fadeInUp 0.5s ease-out forwards';
        suggestionBtn.style.opacity = '0';
        
        // Estilo baseado na prioridade
        if (priority >= 4) {
            suggestionBtn.classList.add('fw-bold');
        }
        
        suggestionBtn.innerHTML = `
            <span class="me-1">${suggestion.icon}</span>
            ${suggestion.text}
        `;
        
        suggestionBtn.title = suggestion.description;
        suggestionBtn.onclick = () => usarSugestaoInteligente(suggestion);
        
        container.appendChild(suggestionBtn);
    });
    
    // Adicionar indicador de perfil
    const profileIndicator = document.createElement('small');
    profileIndicator.className = 'text-muted d-block mt-2';
    profileIndicator.innerHTML = `
        <i class="fas fa-user-tag me-1"></i>
        Sugest√µes personalizadas para: <strong>${userProfile}</strong>
    `;
    container.appendChild(profileIndicator);
}

function usarSugestaoInteligente(suggestion) {
    // Preencher input com a sugest√£o
    document.getElementById('user-input').value = suggestion.text;
    
    // Enviar mensagem
    enviarMensagem();
    
    // Registrar feedback positivo (usu√°rio usou a sugest√£o)
    registrarFeedbackSugestao(suggestion.text, true);
    
    // Log para analytics
    console.log('üéØ Sugest√£o utilizada:', suggestion.text, 'Categoria:', suggestion.category);
}

function registrarFeedbackSugestao(suggestionText, helpful = true) {
    const csrfToken = getCSRFToken();
    fetch('/claude-ai/api/suggestions/feedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({
            suggestion: suggestionText,
            helpful: helpful,
            csrf_token: csrfToken
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('üìä Feedback registrado:', suggestionText, helpful ? '√∫til' : 'n√£o √∫til');
        }
    })
    .catch(error => {
        console.warn('‚ö†Ô∏è Erro ao registrar feedback:', error);
    });
}

function recarregarSugestoes() {
    console.log('üîÑ Recarregando sugest√µes inteligentes...');
    carregarSugestoesInteligentes();
}

function showSuggestionsLoading() {
    const container = document.getElementById('intelligent-suggestions');
    container.innerHTML = `
        <div class="suggestion-loading text-center w-100 py-3">
            <i class="fas fa-brain fa-spin text-primary"></i>
            <small class="text-muted d-block mt-1">Gerando sugest√µes personalizadas...</small>
        </div>
    `;
}

function showFallbackSuggestions() {
    const container = document.getElementById('intelligent-suggestions');
    const fallbackContainer = document.getElementById('fallback-suggestions');
    
    container.innerHTML = `
        <div class="alert alert-warning alert-sm p-2 w-100">
            <i class="fas fa-exclamation-triangle me-1"></i>
            <small>Usando sugest√µes b√°sicas</small>
        </div>
    `;
    
    fallbackContainer.classList.remove('d-none');
}

// üë• SISTEMA DE FEEDBACK REAL (CORRIGIDO)
function adicionarBotoesFeedback(messageElement, consulta, resposta) {
    if (messageElement.querySelector('.feedback-buttons')) {
        return; // J√° tem bot√µes
    }
    
    const feedbackDiv = document.createElement('div');
    feedbackDiv.className = 'feedback-buttons mt-2';
    feedbackDiv.innerHTML = `
        <div class="feedback-section">
            <small class="text-muted">Esta resposta foi √∫til?</small><br>
            <button class="btn btn-sm btn-success me-1" onclick="enviarFeedback('positive', this, '${consulta.substring(0, 100)}', '${resposta.substring(0, 200)}')">
                üëç Sim
            </button>
            <button class="btn btn-sm btn-warning me-1" onclick="enviarFeedback('improvement', this, '${consulta.substring(0, 100)}', '${resposta.substring(0, 200)}')">
                üìù Pode melhorar
            </button>
            <button class="btn btn-sm btn-danger me-1" onclick="enviarFeedback('negative', this, '${consulta.substring(0, 100)}', '${resposta.substring(0, 200)}')">
                üëé N√£o
            </button>
            <div class="feedback-details mt-2" style="display: none;">
                <textarea class="form-control" placeholder="Opcional: Como posso melhorar?" rows="2"></textarea>
                <button class="btn btn-sm btn-primary mt-1" onclick="enviarFeedbackDetalhado(this)">
                    Enviar Feedback
                </button>
            </div>
        </div>
    `;
    
    messageElement.appendChild(feedbackDiv);
}

function enviarFeedback(tipo, botao, consulta, resposta) {
    const feedbackSection = botao.closest('.feedback-section');
    const detailsDiv = feedbackSection.querySelector('.feedback-details');
    
    if (tipo === 'improvement' || tipo === 'negative') {
        detailsDiv.style.display = 'block';
        detailsDiv.dataset.feedbackType = tipo;
    } else {
        // Feedback positivo direto
        enviarFeedbackParaServidor(tipo, '', consulta, resposta);
        feedbackSection.innerHTML = '<small class="text-success">‚úÖ Obrigado pelo feedback!</small>';
    }
}

function enviarFeedbackDetalhado(botao) {
    const detailsDiv = botao.closest('.feedback-details');
    const feedbackSection = botao.closest('.feedback-section');
    const tipo = detailsDiv.dataset.feedbackType;
    const detalhes = detailsDiv.querySelector('textarea').value;
    const consulta = feedbackSection.closest('.message').dataset.consulta || '';
    const resposta = feedbackSection.closest('.message').dataset.resposta || '';
    
    enviarFeedbackParaServidor(tipo, detalhes, consulta, resposta);
    feedbackSection.innerHTML = '<small class="text-success">‚úÖ Obrigado pelo feedback detalhado!</small>';
}

function enviarFeedbackParaServidor(tipo, detalhes, consulta, resposta) {
    fetch('/claude-ai/api/advanced-feedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            query: consulta,
            response: resposta,
            feedback_text: detalhes || `Feedback ${tipo}`,
            feedback_type: tipo,
            session_id: Date.now().toString()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Feedback enviado com sucesso:', data);
        } else {
            console.error('‚ùå Erro ao enviar feedback:', data);
        }
    })
    .catch(error => {
        console.error('‚ùå Erro na requisi√ß√£o de feedback:', error);
    });
}

// Vari√°vel para armazenar √∫ltima mensagem do usu√°rio
let lastUserMessage = "";

</script>
{% endblock %} 