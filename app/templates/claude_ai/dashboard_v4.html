{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header v4.0 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <h2 class="mb-2">
                        ü§ñ <strong>MCP v4.0</strong> - Sistema Inteligente Avan√ßado
                        {% if mcp_available %}
                            <span class="badge badge-success ms-2">‚úÖ ATIVO</span>
                        {% else %}
                            <span class="badge badge-danger ms-2">‚ùå INDISPON√çVEL</span>
                        {% endif %}
                    </h2>
                    <p class="mb-1">Model Context Protocol com IA, Cache Redis e NLP avan√ßado</p>
                    <small class="text-muted">Dashboard em tempo real - Atualizado automaticamente</small>
                </div>
            </div>
        </div>
    </div>

    {% if mcp_available and metrics.ai_infrastructure %}
    <!-- M√©tricas v4.0 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-primary">{{ metrics.requests_processed }}</h4>
                    <p class="mb-1">Requisi√ß√µes</p>
                    <small class="text-muted">Total processadas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-success">{{ metrics.intents_classified }}</h4>
                    <p class="mb-1">Inten√ß√µes</p>
                    <small class="text-muted">Classificadas via NLP</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-info">{{ metrics.cache_hits }}</h4>
                    <p class="mb-1">Cache Hits</p>
                    <small class="text-muted">{{ metrics.cache_misses }} misses</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-warning">{{ metrics.uptime }}</h4>
                    <p class="mb-1">Uptime</p>
                    <small class="text-muted">Servidor ativo</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Status dos Componentes -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>üß† Componentes IA</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <span class="badge badge-success">‚úÖ NLP Processor</span><br>
                            <small class="text-muted">Classifica√ß√£o autom√°tica</small>
                        </div>
                        <div class="col-6">
                            <span class="badge badge-success">‚úÖ Context Manager</span><br>
                            <small class="text-muted">Gerenciamento de conversas</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <span class="badge badge-info">üîÑ Cache Inteligente</span><br>
                            <small class="text-muted">Fallback mem√≥ria ativo</small>
                        </div>
                        <div class="col-6">
                            <span class="badge badge-success">‚úÖ Analytics Engine</span><br>
                            <small class="text-muted">An√°lise de tend√™ncias</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>‚ö° Ferramentas Dispon√≠veis</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <span class="badge badge-primary mb-1">status_sistema</span>
                            <span class="badge badge-primary mb-1">consultar_fretes</span>
                            <span class="badge badge-primary mb-1">consultar_pedidos</span>
                            <span class="badge badge-primary mb-1">consultar_embarques</span>
                            <span class="badge badge-primary mb-1">consultar_transportadoras</span>
                        </div>
                    </div>
                    <hr>
                    <p class="text-success mb-1"><strong>üöÄ Novidades v4.0:</strong></p>
                    <div class="row">
                        <div class="col-12">
                            <span class="badge badge-success mb-1">analisar_tendencias</span>
                            <span class="badge badge-success mb-1">detectar_anomalias</span>
                            <span class="badge badge-success mb-1">otimizar_rotas</span>
                            <span class="badge badge-success mb-1">previsao_custos</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teste Interativo -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>üß™ Teste Interativo MCP v4.0</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="testQuery">Digite uma consulta em linguagem natural:</label>
                        <input type="text" class="form-control" id="testQuery" 
                               placeholder="Ex: Como est√£o os pedidos do Assai? ou An√°lise de tend√™ncias">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="testMCPv4()">
                        üöÄ Testar MCP v4.0
                    </button>
                    <button type="button" class="btn btn-secondary ms-2" onclick="clearTest()">
                        üßπ Limpar
                    </button>
                    
                    <div id="testResult" class="mt-3" style="display: none;">
                        <h6>üìä Resultado:</h6>
                        <div class="alert alert-info">
                            <pre id="resultContent" style="white-space: pre-wrap; margin: 0;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- MCP v4.0 Indispon√≠vel -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning">
                <h5>‚ö†Ô∏è MCP v4.0 Temporariamente Indispon√≠vel</h5>
                <p>O servidor MCP v4.0 com IA avan√ßada n√£o est√° dispon√≠vel no momento.</p>
                
                <h6>Poss√≠veis causas:</h6>
                <ul>
                    <li>Depend√™ncias de IA n√£o instaladas</li>
                    <li>Erro na inicializa√ß√£o do servidor</li>
                    <li>Problema na infraestrutura</li>
                </ul>
                
                <h6>Solu√ß√µes:</h6>
                <ul>
                    <li>Instalar depend√™ncias: <code>pip install -r requirements_ai.txt</code></li>
                    <li>Verificar logs do sistema</li>
                    <li>Usar <a href="{{ url_for('claude_ai.dashboard_mcp') }}">MCP v3.1</a> como alternativa</li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Footer -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <p class="mb-1">
                        <strong>MCP v4.0</strong> - Model Context Protocol com Intelig√™ncia Artificial
                    </p>
                    <small class="text-muted">
                        Sistema desenvolvido para an√°lise inteligente de dados de fretes ‚Ä¢
                        <a href="{{ url_for('claude_ai.dashboard_mcp') }}">Dashboard v3.1</a> ‚Ä¢
                        <a href="{{ url_for('claude_ai.chat_page') }}">Chat Claude AI</a>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Fun√ß√£o para obter CSRF token
function getCSRFToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    return metaTag ? metaTag.getAttribute('content') : '';
}

// Fun√ß√£o para testar MCP v4.0
async function testMCPv4() {
    const query = document.getElementById('testQuery').value.trim();
    
    if (!query) {
        alert('Digite uma consulta primeiro!');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '‚è≥ Processando...';
        button.disabled = true;
        
        const response = await fetch('/claude-ai/api/v4/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ query: query })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('resultContent').textContent = data.response;
            document.getElementById('testResult').style.display = 'block';
            
            // Scroll para o resultado
            document.getElementById('testResult').scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('Erro: ' + data.error);
        }
        
    } catch (error) {
        console.error('Erro na consulta:', error);
        alert('Erro na comunica√ß√£o com o servidor');
        
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Fun√ß√£o para limpar teste
function clearTest() {
    document.getElementById('testQuery').value = '';
    document.getElementById('testResult').style.display = 'none';
}

// Permitir Enter para testar
document.getElementById('testQuery').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        testMCPv4();
    }
});

// Auto-refresh m√©tricas a cada 30 segundos
{% if mcp_available %}
setInterval(function() {
    location.reload();
}, 30000);
{% endif %}

// Exemplos de queries
const exemplos = [
    "Status do sistema",
    "Como est√£o os pedidos do Assai?",
    "An√°lise de tend√™ncias",
    "Detectar anomalias",
    "Transportadoras cadastradas",
    "Embarques ativos"
];

// Adicionar placeholder din√¢mico
let exemploIndex = 0;
setInterval(function() {
    const input = document.getElementById('testQuery');
    if (input && !input.value) {
        input.placeholder = `Ex: ${exemplos[exemploIndex]}`;
        exemploIndex = (exemploIndex + 1) % exemplos.length;
    }
}, 3000);
</script>

{% endblock %} 