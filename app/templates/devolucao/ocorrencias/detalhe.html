{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>{{ ocorrencia.numero_ocorrencia }}</h2>
            <p class="text-muted mb-0">
                Aberta em {{ ocorrencia.data_abertura.strftime('%d/%m/%Y %H:%M') }}
                por {{ ocorrencia.criado_por }}
            </p>
        </div>
        <div>
            <a href="{{ url_for('devolucao.devolucao_ocorrencia.index') }}" class="btn btn-outline-secondary">
                Voltar
            </a>
        </div>
    </div>

    <!-- Status Geral -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <strong>Status:</strong>
                    <span class="badge fs-6 bg-{{ 'warning' if ocorrencia.status == 'ABERTA' else 'info' if ocorrencia.status == 'EM_ANALISE' else 'success' }}">
                        {{ ocorrencia.status }}
                    </span>
                </div>
                <div class="col-md-3">
                    <strong>Destino:</strong>
                    <span class="badge fs-6 bg-{{ 'secondary' if ocorrencia.destino == 'INDEFINIDO' else 'primary' if ocorrencia.destino == 'RETORNO' else 'info' }}">
                        {{ ocorrencia.destino or 'INDEFINIDO' }}
                    </span>
                </div>
                <div class="col-md-3">
                    <strong>Localizacao:</strong>
                    <span class="badge fs-6 bg-secondary">{{ ocorrencia.localizacao_atual or 'CLIENTE' }}</span>
                </div>
                <div class="col-md-3">
                    {% if ocorrencia.data_resolucao %}
                    <strong>Resolvida em:</strong>
                    {{ ocorrencia.data_resolucao.strftime('%d/%m/%Y') }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Info da NFD -->
    {% if nfd %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Dados da NFD</h6>
            <a href="{{ url_for('devolucao.devolucao_ai.pagina_resolver_nfd', nfd_id=nfd.id) }}"
               class="btn btn-sm btn-info">
                Resolver Produtos
            </a>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>Numero NFD:</strong><br>
                    {{ nfd.numero_nfd }}
                </div>
                <div class="col-md-3">
                    <strong>NF(s) de Venda Referenciadas:</strong>
                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="abrirModalEditarNFs()" title="Editar NFs de venda">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <br>
                    <div id="lista-nfs-referenciadas">
                    {% if nfs_referenciadas %}
                        {% for nf_ref in nfs_referenciadas %}
                            {% if nf_ref.entrega_id %}
                                <a href="{{ url_for('monitoramento.visualizar_entrega', id=nf_ref.entrega_id) }}"
                                   class="btn btn-sm btn-outline-primary me-1 mb-1"
                                   title="Ver entrega no monitoramento">
                                    NF {{ nf_ref.numero_nf }}
                                </a>
                            {% else %}
                                <span class="badge bg-secondary me-1 mb-1">
                                    NF {{ nf_ref.numero_nf }}
                                    <small>(sem entrega)</small>
                                </span>
                            {% endif %}
                        {% endfor %}
                    {% elif nfd.numero_nf_venda %}
                        <span class="text-muted">{{ nfd.numero_nf_venda }}</span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <strong>Motivo:</strong><br>
                    <span class="badge bg-{{ 'danger' if nfd.motivo == 'AVARIA' else 'warning' if nfd.motivo == 'FALTA' else 'info' }}">
                        {{ nfd.motivo }}
                    </span>
                </div>
                <div class="col-md-3">
                    <strong>Valor Total:</strong><br>
                    {% if nfd.valor_total %}
                    R$ {{ "%.2f"|format(nfd.valor_total) }}
                    {% else %}
                    -
                    {% endif %}
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <strong>Cliente/Emitente:</strong><br>
                    {{ nfd.nome_emitente or (entrega.cliente if entrega else '-') }}
                    {% if nfd.cnpj_emitente %}
                    <br><small class="text-muted">CNPJ: {{ nfd.cnpj_emitente }}</small>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <strong>Motivo extraído por IA:</strong><br>
                    {{ nfd.descricao_motivo or '-' }}
                </div>
            </div>
            {% if nfd.chave_nfd %}
            <div class="row mt-3">
                <div class="col-12">
                    <strong>Chave de Acesso:</strong><br>
                    <code>{{ nfd.chave_nfd }}</code>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Abas: Logistica | Comercial | Anexos | Frete | Descarte -->
    <ul class="nav nav-tabs mb-3" id="ocorrencia-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="logistica-tab" data-bs-toggle="tab" href="#logistica" role="tab">
                Logistica
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="comercial-tab" data-bs-toggle="tab" href="#comercial" role="tab">
                Comercial
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="anexos-tab" data-bs-toggle="tab" href="#anexos" role="tab">
                Anexos ({{ anexos|length }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="frete-tab" data-bs-toggle="tab" href="#frete" role="tab">
                Frete Retorno {% if fretes %}({{ fretes|length }}){% endif %}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="descarte-tab" data-bs-toggle="tab" href="#descarte" role="tab">
                Descarte {% if descartes %}({{ descartes|length }}){% endif %}
            </a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- ABA LOGISTICA -->
        <div class="tab-pane fade show active" id="logistica" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Secao Logistica</h6>
                    <button type="button" class="btn btn-sm btn-primary" onclick="salvarLogistica()">
                        Salvar Alteracoes
                    </button>
                </div>
                <div class="card-body">
                    <form id="form-logistica">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Destino</label>
                                <select class="form-select" name="destino" id="destino">
                                    {% for valor, descricao in opcoes_destino %}
                                    <option value="{{ valor }}" {% if ocorrencia.destino == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Localizacao Atual</label>
                                <select class="form-select" name="localizacao_atual" id="localizacao_atual">
                                    {% for valor, descricao in opcoes_localizacao %}
                                    <option value="{{ valor }}" {% if ocorrencia.localizacao_atual == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Previsao Retorno</label>
                                <input type="date" class="form-control" name="data_previsao_retorno"
                                       value="{{ ocorrencia.data_previsao_retorno.strftime('%Y-%m-%d') if ocorrencia.data_previsao_retorno else '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Data/Hora Chegada CD</label>
                                <input type="datetime-local" class="form-control" name="data_chegada_cd"
                                       value="{{ ocorrencia.data_chegada_cd.strftime('%Y-%m-%dT%H:%M') if ocorrencia.data_chegada_cd else '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Recebido Por</label>
                                <input type="text" class="form-control" name="recebido_por"
                                       value="{{ ocorrencia.recebido_por or '' }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observacoes Logistica</label>
                            <textarea class="form-control" name="observacoes_logistica" rows="3">{{ ocorrencia.observacoes_logistica or '' }}</textarea>
                        </div>
                    </form>
                    <div id="feedback-logistica" class="alert d-none"></div>
                </div>
            </div>
        </div>

        <!-- ABA COMERCIAL -->
        <div class="tab-pane fade" id="comercial" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Secao Comercial</h6>
                    <button type="button" class="btn btn-sm btn-primary" onclick="salvarComercial()">
                        Salvar Alteracoes
                    </button>
                </div>
                <div class="card-body">
                    <form id="form-comercial">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status" id="status_comercial">
                                    {% for valor, descricao in opcoes_status %}
                                    <option value="{{ valor }}" {% if ocorrencia.status == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Categoria</label>
                                <select class="form-select" name="categoria">
                                    <option value="">Selecione...</option>
                                    {% for valor, descricao in opcoes_categoria %}
                                    <option value="{{ valor }}" {% if ocorrencia.categoria == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Subcategoria</label>
                                <select class="form-select" name="subcategoria">
                                    <option value="">Selecione...</option>
                                    {% for valor, descricao in opcoes_subcategoria %}
                                    <option value="{{ valor }}" {% if ocorrencia.subcategoria == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Responsavel</label>
                                <select class="form-select" name="responsavel">
                                    {% for valor, descricao in opcoes_responsavel %}
                                    <option value="{{ valor }}" {% if ocorrencia.responsavel == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Origem</label>
                                <select class="form-select" name="origem">
                                    {% for valor, descricao in opcoes_origem %}
                                    <option value="{{ valor }}" {% if ocorrencia.origem == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Momento da Devolucao</label>
                                <select class="form-select" name="momento_devolucao">
                                    {% for valor, descricao in opcoes_momento_devolucao %}
                                    <option value="{{ valor }}" {% if ocorrencia.momento_devolucao == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Autorizado Por</label>
                                <input type="text" class="form-control" name="autorizado_por"
                                       value="{{ ocorrencia.autorizado_por or '' }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descricao Comercial</label>
                            <textarea class="form-control" name="descricao_comercial" rows="3">{{ ocorrencia.descricao_comercial or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Desfecho</label>
                            <textarea class="form-control" name="desfecho" rows="3">{{ ocorrencia.desfecho or '' }}</textarea>
                        </div>
                    </form>
                    <div id="feedback-comercial" class="alert d-none"></div>
                </div>
            </div>
        </div>

        <!-- ABA ANEXOS -->
        <div class="tab-pane fade" id="anexos" role="tabpanel">
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Novo Anexo</h6>
                </div>
                <div class="card-body">
                    <form id="form-upload-anexo" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Arquivo</label>
                                <input type="file" class="form-control" name="arquivo" id="arquivo-anexo" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tipo</label>
                                <select class="form-select" name="tipo" id="tipo-anexo">
                                    <option value="DOCUMENTO">Documento</option>
                                    <option value="EMAIL">Email (.msg/.eml)</option>
                                    <option value="FOTO">Foto</option>
                                    <option value="PLANILHA">Planilha</option>
                                    <option value="OUTROS">Outros</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Descricao</label>
                                <input type="text" class="form-control" name="descricao" placeholder="Opcional...">
                            </div>
                            <div class="col-md-2 mb-3 d-flex align-items-end">
                                <button type="button" class="btn btn-primary w-100" onclick="uploadAnexo()">
                                    <span class="spinner-border spinner-border-sm d-none" id="spinner-upload"></span>
                                    Enviar
                                </button>
                            </div>
                        </div>
                    </form>
                    <div id="feedback-anexo" class="alert d-none mt-2"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Anexos Existentes</h6>
                </div>
                <div class="card-body">
                    <div id="lista-anexos">
                        {% if anexos %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Nome</th>
                                        <th>Tamanho</th>
                                        <th>Adicionado em</th>
                                        <th>Por</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for anexo in anexos %}
                                    <tr id="anexo-row-{{ anexo.id }}">
                                        <td>
                                            <span class="badge bg-{{ 'info' if anexo.tipo == 'EMAIL' else 'success' if anexo.tipo == 'FOTO' else 'warning' if anexo.tipo == 'PLANILHA' else 'secondary' }}">
                                                {{ anexo.tipo }}
                                            </span>
                                        </td>
                                        <td>
                                            {{ anexo.nome_original }}
                                            {% if anexo.descricao %}
                                            <br><small class="text-muted">{{ anexo.descricao }}</small>
                                            {% endif %}
                                        </td>
                                        <td><small>{{ anexo.tamanho_kb }} KB</small></td>
                                        <td><small>{{ anexo.criado_em.strftime('%d/%m/%Y %H:%M') }}</small></td>
                                        <td><small>{{ anexo.criado_por }}</small></td>
                                        <td>
                                            <a href="/devolucao/ocorrencias/api/{{ ocorrencia.id }}/anexos/{{ anexo.id }}/download"
                                               class="btn btn-sm btn-outline-primary"> <i class="bi bi-download"></i> Download</a>
                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                    onclick="excluirAnexo({{ anexo.id }}, '{{ anexo.nome_original }}')"
                                                    > <i class="bi bi-trash"></i> Excluir</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center mb-0">Nenhum anexo</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA FRETE RETORNO -->
        <div class="tab-pane fade" id="frete" role="tabpanel">
            <!-- Formulario de Novo Frete -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center"
                     data-bs-toggle="collapse" data-bs-target="#form-frete-collapse"
                     style="cursor: pointer;" role="button">
                    <h6 class="mb-0"><i class="bi bi-plus-lg me-2"></i>Nova Cotacao de Frete</h6>
                    <i class="bi bi-chevron-down collapse-icon"></i>
                </div>
                <div class="collapse" id="form-frete-collapse">
                    <div class="card-body">
                        <form id="form-novo-frete">
                            <input type="hidden" name="transportadora_id" id="transportadora_id">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Transportadora</label>
                                    <select class="form-select" name="transportadora_nome" id="select-transportadora" required>
                                        <option value="">Carregando...</option>
                                    </select>
                                </div>
                                <div class="col-md-1 mb-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="estimarFreteRetorno()" id="btn-estimar-retorno" disabled title="Selecione uma transportadora">
                                        <i class="bi bi-calculator"></i> Estimar
                                    </button>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Valor Cotado</label>
                                    <input type="number" step="0.01" class="form-control" name="valor_cotado" id="valor_cotado" placeholder="0.00" required>
                                    <small id="info-estimativa" class="text-muted d-none"></small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Peso (kg)</label>
                                    <div class="input-group">
                                        <input type="number" step="0.001" class="form-control" name="peso_kg" id="peso_kg" placeholder="0.000">
                                        <button type="button" class="btn btn-outline-secondary" onclick="calcularPeso()" title="Calcular peso automaticamente">
                                            <i class="bi bi-calculator"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Data Cotacao</label>
                                    <input type="date" class="form-control" name="data_cotacao">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Coleta Prevista</label>
                                    <input type="date" class="form-control" name="data_coleta_prevista">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Local de Coleta</label>
                                    <input type="text" class="form-control" name="local_coleta" id="local_coleta"
                                           value="{{ entrega.cliente if entrega and entrega.cliente else (nfd.nome_emitente if nfd else '') }}"
                                           placeholder="Ex: CD Atacadao, Loja Assai...">
                                    <small class="text-muted">Nome do local onde sera feita a coleta</small>
                                </div>
                                <div class="col-md-1 mb-3">
                                    <label class="form-label">UF Orig.</label>
                                    <select class="form-select" name="uf_origem" id="uf_origem" required>
                                        <option value="">...</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Cidade Origem</label>
                                    <select class="form-select" name="cidade_origem" id="cidade_origem" required>
                                        <option value="">Selecione UF</option>
                                    </select>
                                </div>
                                <div class="col-md-1 mb-3">
                                    <label class="form-label">UF Dest.</label>
                                    <select class="form-select" name="uf_destino" id="uf_destino" required>
                                        <option value="">...</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Cidade Destino</label>
                                    <select class="form-select" name="cidade_destino" id="cidade_destino" required>
                                        <option value="">Selecione UF</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Observacoes</label>
                                    <input type="text" class="form-control" name="observacoes" placeholder="Opcional">
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="criarFrete()">
                                <span class="spinner-border spinner-border-sm d-none" id="spinner-frete"></span>
                                Criar Cotacao
                            </button>
                        </form>
                        <div id="feedback-frete" class="alert d-none mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Lista de Fretes -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Cotacoes de Frete</h6>
                </div>
                <div class="card-body">
                    <div id="lista-fretes">
                        {% if fretes %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Transportadora</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>Rota</th>
                                        <th>Data Cotacao</th>
                                        <th>Acoes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for frete in fretes %}
                                    <tr id="frete-row-{{ frete.id }}">
                                        <td>{{ frete.transportadora_nome }}</td>
                                        <td>R$ {{ "%.2f"|format(frete.valor_cotado) }}</td>
                                        <td>
                                            <select class="form-select form-select-sm status-frete" data-frete-id="{{ frete.id }}" style="width: auto;">
                                                <option value="COTADO" {% if frete.status == 'COTADO' %}selected{% endif %}>Cotado</option>
                                                <option value="APROVADO" {% if frete.status == 'APROVADO' %}selected{% endif %}>Aprovado</option>
                                                <option value="COLETADO" {% if frete.status == 'COLETADO' %}selected{% endif %}>Coletado</option>
                                                <option value="ENTREGUE" {% if frete.status == 'ENTREGUE' %}selected{% endif %}>Entregue</option>
                                                <option value="CANCELADO" {% if frete.status == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                                            </select>
                                        </td>
                                        <td>
                                            {% if frete.local_coleta %}<small class="text-muted">{{ frete.local_coleta }}</small><br>{% endif %}
                                            {{ frete.cidade_origem }}/{{ frete.uf_origem }} → {{ frete.cidade_destino }}/{{ frete.uf_destino }}
                                        </td>
                                        <td>{{ frete.data_cotacao.strftime('%d/%m/%Y') if frete.data_cotacao else '-' }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="excluirFrete({{ frete.id }})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center mb-0">Nenhuma cotacao de frete registrada</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA DESCARTE -->
        <div class="tab-pane fade" id="descarte" role="tabpanel">
            <!-- Formulario de Novo Descarte -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center"
                     data-bs-toggle="collapse" data-bs-target="#form-descarte-collapse"
                     style="cursor: pointer;" role="button">
                    <h6 class="mb-0"><i class="bi bi-plus-lg me-2"></i>Autorizar Descarte</h6>
                    <i class="bi bi-chevron-down collapse-icon"></i>
                </div>
                <div class="collapse" id="form-descarte-collapse">
                    <div class="card-body">
                        <form id="form-novo-descarte">
                            <!-- Empresa Autorizada a Descartar (obrigatorio para compliance) -->
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong>Importante:</strong> Informe a empresa autorizada a realizar o descarte antes de gerar o termo.
                            </div>
                            <div class="row">
                                <div class="col-md-5 mb-3">
                                    <label class="form-label">Empresa Autorizada <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="empresa_autorizada_nome" placeholder="Razao Social da empresa" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">CNPJ/CPF <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="empresa_autorizada_documento" placeholder="00.000.000/0000-00" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Tipo</label>
                                    <select class="form-select" name="empresa_autorizada_tipo">
                                        <option value="TRANSPORTADOR">Transportador</option>
                                        <option value="CLIENTE">Cliente</option>
                                    </select>
                                </div>
                            </div>
                            <hr class="my-3">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Motivo do Descarte <span class="text-danger">*</span></label>
                                    <select class="form-select" name="motivo_descarte" required>
                                        <option value="">Selecione...</option>
                                        <option value="CUSTO_ALTO">Custo de frete maior que valor da mercadoria</option>
                                        <option value="PERECIVEIS">Produtos pereciveis/vencidos</option>
                                        <option value="AVARIA_TOTAL">Avaria total - sem condicoes de retorno</option>
                                        <option value="CONTAMINACAO">Contaminacao/risco sanitario</option>
                                        <option value="CLIENTE_SOLICITOU">Cliente solicitou o descarte</option>
                                        <option value="OUTROS">Outros</option>
                                    </select>
                                    <small class="text-muted">Para controle interno (nao aparece no termo)</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Valor Total da Mercadoria</label>
                                    <input type="number" step="0.01" class="form-control" name="valor_mercadoria" id="valor_mercadoria_descarte" placeholder="R$ 0.00" readonly>
                                    <small class="text-muted">Calculado automaticamente dos itens</small>
                                </div>
                            </div>

                            <!-- Itens da NFD para Descarte -->
                            {% if linhas %}
                            <div class="mb-3">
                                <label class="form-label"><strong>Itens para Descarte</strong></label>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 30%;">Produto</th>
                                                <th class="text-center" style="width: 10%;">Qtd NFD</th>
                                                <th class="text-end" style="width: 12%;">Valor NFD</th>
                                                <th class="text-center" style="width: 15%;">Qtd Descarte (un)</th>
                                                <th class="text-center" style="width: 15%;">Qtd Descarte (cx)</th>
                                                <th class="text-end" style="width: 18%;">Valor Descarte</th>
                                            </tr>
                                        </thead>
                                        <tbody id="itens-descarte">
                                            {% for linha in linhas %}
                                            <tr data-linha-id="{{ linha.id }}"
                                                data-qtd-por-caixa="{{ linha.qtd_por_caixa or 1 }}"
                                                data-valor-unitario="{{ linha.valor_unitario or 0 }}"
                                                data-qtd-original="{{ linha.quantidade or 0 }}">
                                                <td>
                                                    <small class="text-muted">{{ linha.codigo_produto_interno or linha.codigo_produto_cliente or '-' }}</small><br>
                                                    {{ linha.descricao_produto_interno or linha.descricao_produto_cliente or 'Produto nao resolvido' }}
                                                </td>
                                                <td class="text-center">{{ "%.0f"|format(linha.quantidade or 0) }} {{ linha.unidade_medida or 'UN' }}</td>
                                                <td class="text-end">R$ {{ "%.2f"|format(linha.valor_total or 0) }}</td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm text-center qtd-un-descarte"
                                                           value="{{ linha.quantidade|int }}" step="1" min="0"
                                                           onchange="atualizarQtdDescarte(this, 'un')">
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm text-center qtd-cx-descarte"
                                                           value="{{ ((linha.quantidade or 0) / (linha.qtd_por_caixa or 1))|round(2) }}" step="0.01" min="0"
                                                           onchange="atualizarQtdDescarte(this, 'cx')">
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm text-end valor-descarte-linha"
                                                           value="{{ linha.valor_total or 0 }}" step="0.01" readonly>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr class="border-top-2">
                                                <td colspan="5" class="text-end"><strong class="text-body">TOTAL:</strong></td>
                                                <td class="text-end"><strong id="total-valor-descarte" class="text-body">R$ 0.00</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> Nenhum item de produto encontrado na NFD.
                            </div>
                            {% endif %}

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Descricao do Motivo</label>
                                    <textarea class="form-control" name="descricao_motivo" rows="2" placeholder="Detalhe o motivo do descarte..."></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="tem-custo-descarte" name="tem_custo">
                                        <label class="form-check-label" for="tem-custo-descarte">
                                            Tem custo de descarte?
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3 custo-descarte-fields d-none">
                                    <label class="form-label">Valor do Descarte</label>
                                    <input type="number" step="0.01" class="form-control" name="valor_descarte" placeholder="R$ 0.00">
                                </div>
                                <div class="col-md-6 mb-3 custo-descarte-fields d-none">
                                    <label class="form-label">Fornecedor do Descarte</label>
                                    <input type="text" class="form-control" name="fornecedor_descarte" placeholder="Empresa de descarte">
                                </div>
                            </div>
                            <button type="button" class="btn btn-warning" onclick="criarDescarte()">
                                <span class="spinner-border spinner-border-sm d-none" id="spinner-descarte"></span>
                                Autorizar Descarte
                            </button>
                        </form>
                        <div id="feedback-descarte" class="alert d-none mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Lista de Descartes -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Descartes Autorizados</h6>
                </div>
                <div class="card-body">
                    <div id="lista-descartes">
                        {% if descartes %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Termo</th>
                                        <th>Empresa Autorizada</th>
                                        <th>Valor Merc.</th>
                                        <th>Status</th>
                                        <th>Autorizado em</th>
                                        <th>Documentos</th>
                                        <th>Acoes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for desc in descartes %}
                                    <tr id="descarte-row-{{ desc.id }}">
                                        <td>{{ desc.numero_termo or '-' }}</td>
                                        <td>
                                            {% if desc.empresa_autorizada_nome %}
                                            <strong>{{ desc.empresa_autorizada_nome }}</strong><br>
                                            <small class="text-muted">{{ desc.empresa_autorizada_documento or '-' }}</small>
                                            <span class="badge bg-info">{{ 'Transp.' if desc.empresa_autorizada_tipo == 'TRANSPORTADOR' else 'Cliente' }}</span>
                                            {% else %}
                                            <span class="text-warning"><i class="bi bi-exclamation-triangle"></i> Nao informada</span>
                                            {% endif %}
                                        </td>
                                        <td>{% if desc.valor_mercadoria %}R$ {{ "%.2f"|format(desc.valor_mercadoria) }}{% else %}-{% endif %}</td>
                                        <td>
                                            <select class="form-select form-select-sm status-descarte" data-descarte-id="{{ desc.id }}" style="width: auto;">
                                                <option value="AUTORIZADO" {% if desc.status == 'AUTORIZADO' %}selected{% endif %}>Autorizado</option>
                                                <option value="TERMO_ENVIADO" {% if desc.status == 'TERMO_ENVIADO' %}selected{% endif %}>Termo Enviado</option>
                                                <option value="TERMO_RETORNADO" {% if desc.status == 'TERMO_RETORNADO' %}selected{% endif %}>Termo Retornado</option>
                                                <option value="DESCARTADO" {% if desc.status == 'DESCARTADO' %}selected{% endif %}>Descartado</option>
                                                <option value="CANCELADO" {% if desc.status == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                                            </select>
                                        </td>
                                        <td>{{ desc.data_autorizacao.strftime('%d/%m/%Y') if desc.data_autorizacao else '-' }}</td>
                                        <td>
                                            <div class="btn-group-vertical btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadTermoDescarte({{ desc.id }})" title="Baixar termo">
                                                    <i class="bi bi-download"></i> Download
                                                </button>
                                                <button type="button" class="btn btn-outline-info btn-sm" onclick="imprimirTermoDescarte({{ desc.id }})" title="Imprimir termo">
                                                    <i class="bi bi-printer"></i> Imprimir
                                                </button>
                                                <button type="button" class="btn btn-outline-success btn-sm" onclick="uploadTermoDescarte({{ desc.id }}, 'termo_assinado')" title="Importar termo assinado">
                                                    <i class="bi bi-upload"></i> Importar
                                                    {% if desc.termo_assinado_path %}<span class="badge bg-success ms-1">OK</span>{% endif %}
                                                </button>
                                            </div>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="excluirDescarte({{ desc.id }})" title="Excluir descarte">
                                                <i class="bi bi-trash"></i>Excluir Descarte
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center mb-0">Nenhum descarte autorizado</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Upload Termo Descarte -->
<div class="modal fade" id="modal-upload-termo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload de Documento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-upload-termo" enctype="multipart/form-data">
                    <input type="hidden" id="upload-descarte-id" name="descarte_id">
                    <input type="hidden" id="upload-tipo-documento" name="tipo_documento">
                    <div class="mb-3">
                        <label class="form-label">Arquivo</label>
                        <input type="file" class="form-control" name="arquivo" id="arquivo-termo" required>
                        <small class="text-muted">PDF, imagem ou documento</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="enviarTermoDescarte()">
                    <span class="spinner-border spinner-border-sm d-none" id="spinner-upload-termo"></span>
                    Enviar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar NFs de Venda -->
<div class="modal fade" id="modal-editar-nfs" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar NFs de Venda Referenciadas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Lista de NFs existentes -->
                <div class="mb-3">
                    <label class="form-label fw-bold">NFs Vinculadas:</label>
                    <div id="lista-nfs-modal">
                        <span class="text-muted">Carregando...</span>
                    </div>
                </div>

                <hr>

                <!-- Formulário para adicionar nova NF -->
                <h6>Adicionar Nova NF de Venda</h6>
                <form id="form-adicionar-nf">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Número NF *</label>
                            <input type="text" class="form-control" id="nova-nf-numero" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Série</label>
                            <input type="text" class="form-control" id="nova-nf-serie" value="1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Chave de Acesso (44 dígitos)</label>
                        <input type="text" class="form-control" id="nova-nf-chave" maxlength="44" pattern="[0-9]{44}" placeholder="Opcional">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="adicionarNF()">
                    <span class="spinner-border spinner-border-sm d-none" id="spinner-add-nf"></span>
                    Adicionar NF
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilo para ícone de collapse rotacionar quando aberto */
.collapse-icon {
    transition: transform 0.2s ease;
}
[data-bs-toggle="collapse"][aria-expanded="true"] .collapse-icon,
[data-bs-toggle="collapse"]:not(.collapsed) .collapse-icon {
    transform: rotate(180deg);
}
/* Destacar header ao passar o mouse - usa variavel do tema */
.card-header[role="button"]:hover {
    background-color: var(--bg-light);
}
</style>

<script>
const ocorrenciaId = {{ ocorrencia.id }};
const nfdId = {{ nfd.id }};

// Valores pre-definidos da origem (cliente/emitente da NFD)
const ufOrigemPreset = '{{ entrega.uf if entrega and entrega.uf else (nfd.uf_emitente if nfd and nfd.uf_emitente else "") }}';
const cidadeOrigemPreset = '{{ entrega.municipio if entrega and entrega.municipio else (nfd.municipio_emitente if nfd and nfd.municipio_emitente else "") }}';

// =========================================================================
// Carregar Dados ao Iniciar
// =========================================================================
document.addEventListener('DOMContentLoaded', function() {
    carregarTransportadoras();
    carregarUFs();
    // Calcular peso automaticamente (silencioso)
    calcularPesoAuto();
});

// =========================================================================
// Carregar UFs e Cidades
// =========================================================================
async function carregarUFs() {
    try {
        const response = await fetch('/devolucao/frete/api/ufs');
        const result = await response.json();

        if (result.sucesso) {
            const selectOrigem = document.getElementById('uf_origem');
            const selectDestino = document.getElementById('uf_destino');

            // Preencher UF Origem
            selectOrigem.innerHTML = '<option value="">UF</option>';
            result.ufs.forEach(uf => {
                const option = document.createElement('option');
                option.value = uf;
                option.textContent = uf;
                if (uf === ufOrigemPreset) option.selected = true;
                selectOrigem.appendChild(option);
            });

            // Preencher UF Destino (pre-selecionar SP - CD Nacom)
            selectDestino.innerHTML = '<option value="">UF</option>';
            result.ufs.forEach(uf => {
                const option = document.createElement('option');
                option.value = uf;
                option.textContent = uf;
                if (uf === 'SP') option.selected = true;
                selectDestino.appendChild(option);
            });

            // Carregar cidades se UFs pre-selecionados
            if (ufOrigemPreset) {
                await carregarCidades('uf_origem', 'cidade_origem', cidadeOrigemPreset);
            }
            await carregarCidades('uf_destino', 'cidade_destino', 'Santana de Parnaiba');

            // Event listeners para mudanca de UF
            selectOrigem.addEventListener('change', function() {
                carregarCidades('uf_origem', 'cidade_origem');
            });

            selectDestino.addEventListener('change', function() {
                carregarCidades('uf_destino', 'cidade_destino');
            });
        }
    } catch (error) {
        console.error('Erro ao carregar UFs:', error);
    }
}

async function carregarCidades(ufSelectId, cidadeSelectId, cidadePreset = null) {
    const ufSelect = document.getElementById(ufSelectId);
    const cidadeSelect = document.getElementById(cidadeSelectId);
    const uf = ufSelect.value;

    if (!uf) {
        cidadeSelect.innerHTML = '<option value="">Selecione UF</option>';
        return;
    }

    try {
        cidadeSelect.innerHTML = '<option value="">Carregando...</option>';

        const response = await fetch(`/devolucao/frete/api/cidades/${uf}`);
        const result = await response.json();

        if (result.sucesso) {
            cidadeSelect.innerHTML = '<option value="">Selecione...</option>';
            result.cidades.forEach(cidade => {
                const option = document.createElement('option');
                option.value = cidade.nome;
                option.textContent = cidade.nome;
                // Pre-selecionar cidade se corresponder (ignorando acentos)
                if (cidadePreset && normalizeStr(cidade.nome) === normalizeStr(cidadePreset)) {
                    option.selected = true;
                }
                cidadeSelect.appendChild(option);
            });
        } else {
            cidadeSelect.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    } catch (error) {
        console.error('Erro ao carregar cidades:', error);
        cidadeSelect.innerHTML = '<option value="">Erro ao carregar</option>';
    }
}

function normalizeStr(str) {
    if (!str) return '';
    return str.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .trim();
}

// =========================================================================
// Carregar Transportadoras no Select
// =========================================================================

async function carregarTransportadoras() {
    const select = document.getElementById('select-transportadora');
    if (!select) return;

    try {
        const response = await fetch('/devolucao/frete/api/transportadoras');
        const result = await response.json();

        if (result.sucesso) {
            select.innerHTML = '<option value="">Selecione...</option>';
            result.transportadoras.forEach(t => {
                const option = document.createElement('option');
                option.value = t.nome;
                option.dataset.id = t.id;
                option.dataset.cidade = t.cidade;
                option.dataset.uf = t.uf;
                option.textContent = `${t.nome} (${t.cidade}/${t.uf})`;
                select.appendChild(option);
            });

            // Ao selecionar, atualiza o campo hidden com o ID e habilita botao estimar
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const transportadoraId = selectedOption.dataset.id || '';
                document.getElementById('transportadora_id').value = transportadoraId;

                // Habilitar/desabilitar botao estimar
                const btnEstimar = document.getElementById('btn-estimar-retorno');
                if (transportadoraId) {
                    btnEstimar.disabled = false;
                    btnEstimar.title = 'Estimar frete de retorno';
                } else {
                    btnEstimar.disabled = true;
                    btnEstimar.title = 'Selecione uma transportadora';
                }
            });
        } else {
            select.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    } catch (error) {
        console.error('Erro ao carregar transportadoras:', error);
        select.innerHTML = '<option value="">Erro ao carregar</option>';
    }
}

// =========================================================================
// Calcular Peso Automaticamente (com alert de detalhes)
// =========================================================================
async function calcularPeso() {
    const pesoInput = document.getElementById('peso_kg');

    try {
        const response = await fetch(`/devolucao/frete/api/${ocorrenciaId}/calcular-peso`);
        const result = await response.json();

        if (result.sucesso) {
            pesoInput.value = result.peso_total.toFixed(3);

            // Mostrar detalhes em um alert se tiver mais de um produto
            if (result.detalhes && result.detalhes.length > 0) {
                let mensagem = `Peso total: ${result.peso_total.toFixed(3)} kg\n\nDetalhes:\n`;
                result.detalhes.forEach(d => {
                    mensagem += `- ${d.codigo}: ${d.quantidade} x ${d.peso_unitario.toFixed(3)} = ${d.peso_total.toFixed(3)} kg`;
                    if (!d.cadastro_encontrado) {
                        mensagem += ' (sem cadastro)';
                    }
                    mensagem += '\n';
                });
                alert(mensagem);
            }
        } else {
            alert(result.erro || 'Erro ao calcular peso');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao calcular peso. Verifique se os produtos estao resolvidos.');
    }
}

// =========================================================================
// Calcular Peso Automatico (silencioso - sem alert)
// =========================================================================
async function calcularPesoAuto() {
    const pesoInput = document.getElementById('peso_kg');

    try {
        const response = await fetch(`/devolucao/frete/api/${ocorrenciaId}/calcular-peso`);
        const result = await response.json();

        if (result.sucesso && result.peso_total > 0) {
            pesoInput.value = result.peso_total.toFixed(3);
            console.log(`[Peso Auto] Peso calculado: ${result.peso_total.toFixed(3)} kg`);
        }
    } catch (error) {
        console.log('[Peso Auto] Erro ao calcular peso automaticamente:', error);
    }
}

// =========================================================================
// Estimar Frete de Retorno (50%)
// =========================================================================
async function estimarFreteRetorno() {
    const transportadoraId = document.getElementById('transportadora_id').value;
    const ufOrigem = document.getElementById('uf_origem').value;
    const btnEstimar = document.getElementById('btn-estimar-retorno');
    const infoEstimativa = document.getElementById('info-estimativa');
    const valorCotado = document.getElementById('valor_cotado');
    const pesoKg = document.getElementById('peso_kg');

    if (!transportadoraId) {
        alert('Selecione uma transportadora');
        return;
    }

    if (!ufOrigem) {
        alert('Selecione a UF de origem');
        return;
    }

    // Desabilitar botao durante requisicao
    const textoOriginal = btnEstimar.innerHTML;
    btnEstimar.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btnEstimar.disabled = true;

    try {
        const response = await fetch(`/devolucao/frete/api/${ocorrenciaId}/estimar-retorno`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
            },
            body: JSON.stringify({
                transportadora_id: parseInt(transportadoraId),
                uf_origem: ufOrigem
            })
        });

        const result = await response.json();

        if (result.sucesso) {
            // Preencher valor cotado
            valorCotado.value = result.valor_estimado.toFixed(2);

            // Preencher peso se estiver vazio
            if (!pesoKg.value || pesoKg.value === '0') {
                pesoKg.value = result.peso_kg.toFixed(3);
            }

            // Mostrar info de % NF e R$/KG
            infoEstimativa.innerHTML = `<i class="bi bi-info-circle"></i> ${result.percentual_nf.toFixed(1)}% NF | R$ ${result.valor_por_kg.toFixed(2)}/kg`;
            infoEstimativa.classList.remove('d-none');
            infoEstimativa.classList.add('text-success');

            // Alert com detalhes
            alert(`Estimativa de Frete de Retorno (50%):\n\n` +
                  `Transportadora: ${result.transportadora}\n` +
                  `Tabela: ${result.tabela}\n` +
                  `Rota: ${result.rota}\n\n` +
                  `Peso: ${result.peso_kg.toFixed(3)} kg\n` +
                  `Valor NF: R$ ${result.valor_nf.toFixed(2)}\n\n` +
                  `Frete Integral: R$ ${result.valor_integral.toFixed(2)}\n` +
                  `Frete Retorno (${result.desconto}): R$ ${result.valor_estimado.toFixed(2)}\n\n` +
                  `% sobre NF: ${result.percentual_nf.toFixed(2)}%\n` +
                  `R$/kg: R$ ${result.valor_por_kg.toFixed(2)}`);
        } else {
            alert(result.erro || 'Erro ao estimar frete');
            infoEstimativa.classList.add('d-none');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao estimar frete. Tente novamente.');
    } finally {
        // Restaurar botao
        btnEstimar.innerHTML = textoOriginal;
        btnEstimar.disabled = false;
    }
}

function salvarLogistica() {
    const form = document.getElementById('form-logistica');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    fetch(`/devolucao/ocorrencias/api/${ocorrenciaId}/logistica`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        const feedback = document.getElementById('feedback-logistica');
        if (result.sucesso) {
            feedback.className = 'alert alert-success';
            feedback.textContent = result.mensagem || 'Salvo com sucesso';
        } else {
            feedback.className = 'alert alert-danger';
            feedback.textContent = result.erro || 'Erro ao salvar';
        }
        feedback.classList.remove('d-none');
        setTimeout(() => feedback.classList.add('d-none'), 3000);
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar. Tente novamente.');
    });
}

function salvarComercial() {
    const form = document.getElementById('form-comercial');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    fetch(`/devolucao/ocorrencias/api/${ocorrenciaId}/comercial`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        const feedback = document.getElementById('feedback-comercial');
        if (result.sucesso) {
            feedback.className = 'alert alert-success';
            feedback.textContent = result.mensagem || 'Salvo com sucesso';
        } else {
            feedback.className = 'alert alert-danger';
            feedback.textContent = result.erro || 'Erro ao salvar';
        }
        feedback.classList.remove('d-none');
        setTimeout(() => feedback.classList.add('d-none'), 3000);
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar. Tente novamente.');
    });
}

// =========================================================================
// Funcoes de Anexos
// =========================================================================

function uploadAnexo() {
    const form = document.getElementById('form-upload-anexo');
    const fileInput = document.getElementById('arquivo-anexo');
    const spinner = document.getElementById('spinner-upload');
    const feedback = document.getElementById('feedback-anexo');

    if (!fileInput.files.length) {
        feedback.className = 'alert alert-warning';
        feedback.textContent = 'Selecione um arquivo';
        feedback.classList.remove('d-none');
        return;
    }

    const formData = new FormData(form);

    // Mostrar loading
    spinner.classList.remove('d-none');
    feedback.classList.add('d-none');

    fetch(`/devolucao/ocorrencias/api/${ocorrenciaId}/anexos`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            feedback.className = 'alert alert-success';
            feedback.textContent = result.mensagem || 'Anexo enviado com sucesso';
            feedback.classList.remove('d-none');

            // Limpar formulario
            form.reset();

            // Recarregar pagina para mostrar novo anexo
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            feedback.className = 'alert alert-danger';
            feedback.textContent = result.erro || 'Erro ao enviar anexo';
            feedback.classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        feedback.className = 'alert alert-danger';
        feedback.textContent = 'Erro de conexao. Tente novamente.';
        feedback.classList.remove('d-none');
    })
    .finally(() => {
        spinner.classList.add('d-none');
    });
}

function excluirAnexo(anexoId, nomeAnexo) {
    if (!confirm(`Deseja excluir o anexo "${nomeAnexo}"?`)) {
        return;
    }

    fetch(`/devolucao/ocorrencias/api/${ocorrenciaId}/anexos/${anexoId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            // Remover linha da tabela
            const row = document.getElementById(`anexo-row-${anexoId}`);
            if (row) {
                row.remove();
            }

            // Feedback
            const feedback = document.getElementById('feedback-anexo');
            if (feedback) {
                feedback.className = 'alert alert-success';
                feedback.textContent = result.mensagem || 'Anexo excluido';
                feedback.classList.remove('d-none');
                setTimeout(() => feedback.classList.add('d-none'), 3000);
            }
        } else {
            alert(result.erro || 'Erro ao excluir anexo');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    });
}

// =========================================================================
// Funcoes de Frete
// =========================================================================

function criarFrete() {
    const form = document.getElementById('form-novo-frete');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    const spinner = document.getElementById('spinner-frete');
    const feedback = document.getElementById('feedback-frete');

    // Validar campos obrigatorios
    if (!data.transportadora_nome || !data.valor_cotado) {
        feedback.className = 'alert alert-warning';
        feedback.textContent = 'Preencha a transportadora e o valor cotado';
        feedback.classList.remove('d-none');
        return;
    }

    // Adicionar transportadora_id
    data.transportadora_id = document.getElementById('transportadora_id').value || null;

    spinner.classList.remove('d-none');
    feedback.classList.add('d-none');

    fetch(`/devolucao/frete/api/${ocorrenciaId}/fretes`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            feedback.className = 'alert alert-success';
            feedback.textContent = result.mensagem || 'Cotacao criada com sucesso';
            feedback.classList.remove('d-none');
            form.reset();
            setTimeout(() => location.reload(), 1000);
        } else {
            feedback.className = 'alert alert-danger';
            feedback.textContent = result.erro || 'Erro ao criar cotacao';
            feedback.classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        feedback.className = 'alert alert-danger';
        feedback.textContent = 'Erro de conexao. Tente novamente.';
        feedback.classList.remove('d-none');
    })
    .finally(() => {
        spinner.classList.add('d-none');
    });
}

function excluirFrete(freteId) {
    if (!confirm('Deseja excluir esta cotacao de frete?')) {
        return;
    }

    fetch(`/devolucao/frete/api/frete/${freteId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            const row = document.getElementById(`frete-row-${freteId}`);
            if (row) row.remove();
        } else {
            alert(result.erro || 'Erro ao excluir frete');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    });
}

// Event listeners para status do frete
document.querySelectorAll('.status-frete').forEach(select => {
    select.addEventListener('change', function() {
        const freteId = this.dataset.freteId;
        const novoStatus = this.value;

        fetch(`/devolucao/frete/api/frete/${freteId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
            },
            body: JSON.stringify({ status: novoStatus })
        })
        .then(response => response.json())
        .then(result => {
            if (!result.sucesso) {
                alert(result.erro || 'Erro ao atualizar status');
                location.reload();
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro de conexao');
            location.reload();
        });
    });
});

// =========================================================================
// Funcoes de Descarte
// =========================================================================

// Toggle campos de custo
document.getElementById('tem-custo-descarte')?.addEventListener('change', function() {
    const fields = document.querySelectorAll('.custo-descarte-fields');
    fields.forEach(field => {
        if (this.checked) {
            field.classList.remove('d-none');
        } else {
            field.classList.add('d-none');
        }
    });
});

// =========================================================================
// Descarte - Funcoes de Quantidade e Termo
// =========================================================================

// Atualizar quantidades e valores do descarte
function atualizarQtdDescarte(input, tipo) {
    const row = input.closest('tr');
    const qtdPorCaixa = parseFloat(row.dataset.qtdPorCaixa) || 1;
    const valorUnitario = parseFloat(row.dataset.valorUnitario) || 0;
    const qtdOriginal = parseFloat(row.dataset.qtdOriginal) || 0;

    const inputUn = row.querySelector('.qtd-un-descarte');
    const inputCx = row.querySelector('.qtd-cx-descarte');
    const inputValor = row.querySelector('.valor-descarte-linha');

    let qtdUnidades;

    if (tipo === 'un') {
        qtdUnidades = parseFloat(inputUn.value) || 0;
        // Limitar ao maximo da NFD
        if (qtdUnidades > qtdOriginal) {
            qtdUnidades = qtdOriginal;
            inputUn.value = qtdUnidades;
        }
        // Calcular caixas
        inputCx.value = (qtdUnidades / qtdPorCaixa).toFixed(2);
    } else {
        // Converter caixas para unidades
        const qtdCaixas = parseFloat(inputCx.value) || 0;
        qtdUnidades = qtdCaixas * qtdPorCaixa;
        // Limitar ao maximo da NFD
        if (qtdUnidades > qtdOriginal) {
            qtdUnidades = qtdOriginal;
            inputCx.value = (qtdUnidades / qtdPorCaixa).toFixed(2);
        }
        inputUn.value = Math.round(qtdUnidades);
    }

    // Calcular valor
    const valorLinha = qtdUnidades * valorUnitario;
    inputValor.value = valorLinha.toFixed(2);

    // Atualizar total
    calcularTotalDescarte();
}

// Calcular total do descarte
function calcularTotalDescarte() {
    let total = 0;
    document.querySelectorAll('.valor-descarte-linha').forEach(input => {
        total += parseFloat(input.value) || 0;
    });

    const totalElement = document.getElementById('total-valor-descarte');
    if (totalElement) {
        totalElement.textContent = `R$ ${total.toFixed(2)}`;
    }

    const valorMercadoriaInput = document.getElementById('valor_mercadoria_descarte');
    if (valorMercadoriaInput) {
        valorMercadoriaInput.value = total.toFixed(2);
    }
}

// Download do termo de descarte
function downloadTermoDescarte(descarteId) {
    window.open(`/devolucao/frete/api/descarte/${descarteId}/termo/download`, '_blank');
}

// Imprimir termo de descarte
function imprimirTermoDescarte(descarteId) {
    const printWindow = window.open(`/devolucao/frete/api/descarte/${descarteId}/termo/imprimir`, '_blank');
    printWindow.onload = function() {
        printWindow.print();
    };
}

// Inicializar total ao carregar pagina
document.addEventListener('DOMContentLoaded', function() {
    calcularTotalDescarte();
});

function criarDescarte() {
    const form = document.getElementById('form-novo-descarte');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    const spinner = document.getElementById('spinner-descarte');
    const feedback = document.getElementById('feedback-descarte');

    // Converter checkbox
    data.tem_custo = document.getElementById('tem-custo-descarte').checked;

    // Validar campos obrigatorios - Empresa Autorizada (compliance)
    if (!data.empresa_autorizada_nome || data.empresa_autorizada_nome.trim() === '') {
        feedback.className = 'alert alert-warning';
        feedback.textContent = 'Informe o nome da empresa autorizada a descartar';
        feedback.classList.remove('d-none');
        return;
    }

    if (!data.empresa_autorizada_documento || data.empresa_autorizada_documento.trim() === '') {
        feedback.className = 'alert alert-warning';
        feedback.textContent = 'Informe o CNPJ/CPF da empresa autorizada';
        feedback.classList.remove('d-none');
        return;
    }

    if (!data.motivo_descarte) {
        feedback.className = 'alert alert-warning';
        feedback.textContent = 'Selecione o motivo do descarte';
        feedback.classList.remove('d-none');
        return;
    }

    spinner.classList.remove('d-none');
    feedback.classList.add('d-none');

    fetch(`/devolucao/frete/api/${ocorrenciaId}/descartes`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            feedback.className = 'alert alert-success';
            feedback.textContent = result.mensagem || 'Descarte autorizado';
            feedback.classList.remove('d-none');
            form.reset();
            setTimeout(() => location.reload(), 1000);
        } else {
            feedback.className = 'alert alert-danger';
            feedback.textContent = result.erro || 'Erro ao autorizar descarte';
            feedback.classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        feedback.className = 'alert alert-danger';
        feedback.textContent = 'Erro de conexao. Tente novamente.';
        feedback.classList.remove('d-none');
    })
    .finally(() => {
        spinner.classList.add('d-none');
    });
}

function excluirDescarte(descarteId) {
    if (!confirm('Deseja excluir este descarte?')) {
        return;
    }

    fetch(`/devolucao/frete/api/descarte/${descarteId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            const row = document.getElementById(`descarte-row-${descarteId}`);
            if (row) row.remove();
        } else {
            alert(result.erro || 'Erro ao excluir descarte');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    });
}

// Event listeners para status do descarte
document.querySelectorAll('.status-descarte').forEach(select => {
    select.addEventListener('change', function() {
        const descarteId = this.dataset.descarteId;
        const novoStatus = this.value;

        fetch(`/devolucao/frete/api/descarte/${descarteId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
            },
            body: JSON.stringify({ status: novoStatus })
        })
        .then(response => response.json())
        .then(result => {
            if (!result.sucesso) {
                alert(result.erro || 'Erro ao atualizar status');
                location.reload();
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro de conexao');
            location.reload();
        });
    });
});

// =========================================================================
// Funcoes de Upload de Termo
// =========================================================================

function uploadTermoDescarte(descarteId, tipo) {
    document.getElementById('upload-descarte-id').value = descarteId;
    document.getElementById('upload-tipo-documento').value = tipo;
    document.getElementById('arquivo-termo').value = '';

    // Atualizar titulo do modal
    const titulos = {
        'termo': 'Upload do Termo de Descarte',
        'termo_assinado': 'Upload do Termo Assinado',
        'comprovante': 'Upload do Comprovante de Descarte'
    };
    document.querySelector('#modal-upload-termo .modal-title').textContent = titulos[tipo] || 'Upload de Documento';

    const modal = new bootstrap.Modal(document.getElementById('modal-upload-termo'));
    modal.show();
}

function enviarTermoDescarte() {
    const form = document.getElementById('form-upload-termo');
    const fileInput = document.getElementById('arquivo-termo');
    const spinner = document.getElementById('spinner-upload-termo');
    const descarteId = document.getElementById('upload-descarte-id').value;
    const tipo = document.getElementById('upload-tipo-documento').value;

    if (!fileInput.files.length) {
        alert('Selecione um arquivo');
        return;
    }

    const formData = new FormData();
    formData.append('arquivo', fileInput.files[0]);

    spinner.classList.remove('d-none');

    fetch(`/devolucao/frete/api/descarte/${descarteId}/upload/${tipo}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            bootstrap.Modal.getInstance(document.getElementById('modal-upload-termo')).hide();
            location.reload();
        } else {
            alert(result.erro || 'Erro ao enviar arquivo');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    })
    .finally(() => {
        spinner.classList.add('d-none');
    });
}

// =========================================================================
// Funcoes para Editar NFs de Venda Referenciadas
// =========================================================================

function abrirModalEditarNFs() {
    carregarNFsReferenciadas();
    const modal = new bootstrap.Modal(document.getElementById('modal-editar-nfs'));
    modal.show();
}

function carregarNFsReferenciadas() {
    const container = document.getElementById('lista-nfs-modal');
    container.innerHTML = '<span class="text-muted">Carregando...</span>';

    fetch(`/devolucao/vinculacao/api/${nfdId}/nfs-referenciadas`)
        .then(response => response.json())
        .then(result => {
            if (result.sucesso && result.nfs_referenciadas && result.nfs_referenciadas.length > 0) {
                let html = '<ul class="list-group">';
                result.nfs_referenciadas.forEach(nf => {
                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <strong>NF ${nf.numero_nf}</strong>
                                ${nf.serie_nf ? `<small class="text-muted">(Série ${nf.serie_nf})</small>` : ''}
                                <br>
                                <small class="text-muted">Origem: ${nf.origem || 'N/A'}</small>
                            </span>
                            <button class="btn btn-sm btn-outline-danger" onclick="removerNF(${nf.id})" title="Remover NF">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </li>
                    `;
                });
                html += '</ul>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<span class="text-muted">Nenhuma NF de venda vinculada</span>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar NFs:', error);
            container.innerHTML = '<span class="text-danger">Erro ao carregar NFs</span>';
        });
}

function adicionarNF() {
    const numero = document.getElementById('nova-nf-numero').value.trim();
    const serie = document.getElementById('nova-nf-serie').value.trim() || '1';
    const chave = document.getElementById('nova-nf-chave').value.trim();
    const spinner = document.getElementById('spinner-add-nf');

    if (!numero) {
        alert('Informe o numero da NF');
        return;
    }

    spinner.classList.remove('d-none');

    fetch(`/devolucao/vinculacao/api/${nfdId}/nfs-referenciadas`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: JSON.stringify({
            numero_nf: numero,
            serie_nf: serie,
            chave_nf: chave || null,
            origem: 'MANUAL'
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            // Limpar formulario
            document.getElementById('nova-nf-numero').value = '';
            document.getElementById('nova-nf-chave').value = '';
            // Recarregar lista
            carregarNFsReferenciadas();
            atualizarListaNFsNaTela();
        } else {
            alert(result.erro || 'Erro ao adicionar NF');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    })
    .finally(() => {
        spinner.classList.add('d-none');
    });
}

function removerNF(refId) {
    if (!confirm('Confirma remover esta NF de venda?')) {
        return;
    }

    fetch(`/devolucao/vinculacao/api/${nfdId}/nfs-referenciadas/${refId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            carregarNFsReferenciadas();
            atualizarListaNFsNaTela();
        } else {
            alert(result.erro || 'Erro ao remover NF');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    });
}

function atualizarListaNFsNaTela() {
    // Atualiza a lista de NFs na tela principal (fora do modal)
    fetch(`/devolucao/vinculacao/api/${nfdId}/nfs-referenciadas`)
        .then(response => response.json())
        .then(result => {
            const container = document.getElementById('lista-nfs-referenciadas');
            if (result.sucesso && result.nfs_referenciadas && result.nfs_referenciadas.length > 0) {
                let html = '';
                result.nfs_referenciadas.forEach(nf => {
                    html += `<span class="badge bg-secondary me-1 mb-1">NF ${nf.numero_nf}</span>`;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = '<span class="text-muted">-</span>';
            }
        });
}
</script>
{% endblock %}
