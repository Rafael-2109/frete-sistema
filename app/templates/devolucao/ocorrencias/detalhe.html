{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Header compacto -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-0 d-inline">{{ ocorrencia.numero_ocorrencia }}</h4>
            <small class="text-muted ms-3">Sincronizada em {{ ocorrencia.data_abertura.strftime('%d/%m/%Y %H:%M') }}</small>
        </div>
        <div>
            <a href="{{ url_for('devolucao.devolucao_ocorrencia.index') }}" class="btn btn-sm btn-outline-secondary">
                Voltar
            </a>
        </div>
    </div>

    <!-- Info da NFD -->
    {% if nfd %}
    <div class="card mb-3">
        <div class="card-header py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h6 class="mb-0">Dados da NFD</h6>
                    <small class="text-muted">|</small>
                    <small class="text-muted">Status:</small>
                    <span class="badge bg-{{ 'warning' if ocorrencia.status == 'ABERTA' else 'info' if ocorrencia.status == 'EM_ANALISE' else 'success' }}">
                        {{ ocorrencia.status }}
                    </span>
                    <small class="text-muted">Destino:</small>
                    <span class="badge bg-{{ 'secondary' if ocorrencia.destino == 'INDEFINIDO' else 'primary' if ocorrencia.destino == 'RETORNO' else 'info' }}">
                        {{ ocorrencia.destino or 'INDEFINIDO' }}
                    </span>
                    <small class="text-muted">Local:</small>
                    <span class="badge bg-secondary">{{ ocorrencia.localizacao_atual or 'CLIENTE' }}</span>
                    {% if ocorrencia.data_resolucao %}
                    <small class="text-success ms-2">Resolvida {{ ocorrencia.data_resolucao.strftime('%d/%m/%Y') }}</small>
                    {% endif %}
                </div>
                <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('devolucao.devolucao_ocorrencia.download_pdf', nfd_id=nfd.id) }}"
                       class="btn btn-outline-danger" title="Baixar PDF da NFD" target="_blank">
                        <i class="bi bi-file-earmark-pdf"></i> PDF
                    </a>
                    <a href="{{ url_for('devolucao.devolucao_ocorrencia.download_xml', nfd_id=nfd.id) }}"
                       class="btn btn-outline-secondary" title="Baixar XML da NFD" target="_blank">
                        <i class="bi bi-file-earmark-code"></i> XML
                    </a>
                    <button type="button" class="btn btn-info" onclick="resolverTodosComIA()">
                        <i class="bi bi-cpu"></i> Resolver Produtos
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body py-2">
            <div class="row mb-2">
                <div class="col-md-2">
                    <small class="text-muted">NFD</small><br>
                    <strong>{{ nfd.numero_nfd }}</strong>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Emissao</small><br>
                    {% if nfd.data_emissao %}
                    {{ nfd.data_emissao.strftime('%d/%m/%Y') }}
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Motivo</small><br>
                    <span class="badge bg-{{ 'danger' if nfd.motivo == 'AVARIA' else 'warning' if nfd.motivo == 'FALTA' else 'info' }}">
                        {{ nfd.motivo }}
                    </span>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Valor</small><br>
                    {% if nfd.valor_total %}
                    <strong>R$ {{ "%.2f"|format(nfd.valor_total) }}</strong>
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Transportadora</small><br>
                    {% if transportadoras %}
                    <i class="bi bi-truck text-info"></i>
                    {% for t in transportadoras %}{{ t }}{% if not loop.last %}, {% endif %}{% endfor %}
                    {% else %}
                    -
                    {% endif %}
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-md-4">
                    <small class="text-muted">Cliente/Emitente</small><br>
                    {{ nfd.nome_emitente or (entrega.cliente if entrega else '-') }}
                    {% if nfd.cnpj_emitente %}
                    <br><small class="text-muted">CNPJ: {{ nfd.cnpj_emitente|formatar_cnpj }}</small>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Motivo (IA)</small>
                    {% if nfd.confianca_motivo %}
                    <span class="badge bg-{{ 'success' if nfd.confianca_motivo >= 0.8 else 'warning' if nfd.confianca_motivo >= 0.5 else 'danger' }} ms-1" style="font-size: 0.65rem;">
                        {{ "%.0f"|format(nfd.confianca_motivo * 100) }}%
                    </span>
                    {% endif %}
                    <br>
                    {% if nfd.descricao_motivo %}
                    <span data-bs-toggle="tooltip" title="{{ nfd.descricao_motivo }}">
                        {{ nfd.descricao_motivo[:60] }}{% if nfd.descricao_motivo|length > 60 %}...{% endif %}
                    </span>
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Info Complementar</small><br>
                    {% if nfd.info_complementar %}
                    <span data-bs-toggle="tooltip" data-bs-html="true" title="{{ nfd.info_complementar|e }}">
                        {{ nfd.info_complementar[:50] }}{% if nfd.info_complementar|length > 50 %}...{% endif %}
                    </span>
                    {% else %}
                    -
                    {% endif %}
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <small class="text-muted">NF(s) de Venda Referenciadas</small>
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 py-0" onclick="abrirModalEditarNFs()" title="Editar NFs">
                        <i class="fas fa-edit"></i>
                    </button>
                    <div id="lista-nfs-referenciadas" class="mt-1">
                    {% if nfs_referenciadas %}
                        {% for nf_ref in nfs_referenciadas %}
                            {% if nf_ref.entrega_id %}
                                <a href="{{ url_for('monitoramento.visualizar_entrega', id=nf_ref.entrega_id) }}"
                                   class="btn btn-sm btn-outline-primary me-1 mb-1"
                                   title="Ver entrega no monitoramento">
                                    NF {{ nf_ref.numero_nf }}{% if nf_ref.data_entrega %} - Ent: {{ nf_ref.data_entrega.strftime('%d/%m/%Y') }}{% endif %}
                                </a>
                            {% else %}
                                <span class="badge bg-secondary me-1 mb-1">
                                    NF {{ nf_ref.numero_nf }}
                                    <small>(sem entrega)</small>
                                </span>
                            {% endif %}
                        {% endfor %}
                    {% elif nfd.numero_nf_venda %}
                        <span class="text-muted">{{ nfd.numero_nf_venda }}</span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                    </div>
                </div>
            </div>
            {% if nfd.chave_nfd %}
            <div class="row mt-2">
                <div class="col-12">
                    <small class="text-muted">Chave:</small>
                    <code class="ms-1" style="font-size: 0.75rem;">{{ nfd.chave_nfd }}</code>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Abas: Logistica | Comercial | Anexos | Frete | Descarte -->
    <ul class="nav nav-tabs mb-3" id="ocorrencia-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="logistica-tab" data-bs-toggle="tab" href="#logistica" role="tab">
                Logistica
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="comercial-tab" data-bs-toggle="tab" href="#comercial" role="tab">
                Comercial
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="anexos-tab" data-bs-toggle="tab" href="#anexos" role="tab">
                Anexos ({{ anexos|length }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="frete-tab" data-bs-toggle="tab" href="#frete" role="tab">
                Frete Retorno {% if fretes %}({{ fretes|length }}){% endif %}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="produtos-tab" data-bs-toggle="tab" href="#produtos" role="tab">
                Produtos {% if linhas %}({{ linhas|length }}){% endif %}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="descarte-tab" data-bs-toggle="tab" href="#descarte" role="tab">
                Descarte {% if descartes %}({{ descartes|length }}){% endif %}
            </a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- ABA LOGISTICA -->
        <div class="tab-pane fade show active" id="logistica" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Secao Logistica</h6>
                    <button type="button" class="btn btn-sm btn-primary" onclick="salvarLogistica()">
                        Salvar Alteracoes
                    </button>
                </div>
                <div class="card-body">
                    <form id="form-logistica">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Destino</label>
                                <select class="form-select" name="destino" id="destino">
                                    {% for valor, descricao in opcoes_destino %}
                                    <option value="{{ valor }}" {% if ocorrencia.destino == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Localizacao Atual</label>
                                <select class="form-select" name="localizacao_atual" id="localizacao_atual">
                                    {% for valor, descricao in opcoes_localizacao %}
                                    <option value="{{ valor }}" {% if ocorrencia.localizacao_atual == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Previsao Retorno</label>
                                <input type="date" class="form-control" name="data_previsao_retorno"
                                       value="{{ ocorrencia.data_previsao_retorno.strftime('%Y-%m-%d') if ocorrencia.data_previsao_retorno else '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Data/Hora Chegada CD</label>
                                <input type="datetime-local" class="form-control" name="data_chegada_cd"
                                       value="{{ ocorrencia.data_chegada_cd.strftime('%Y-%m-%dT%H:%M') if ocorrencia.data_chegada_cd else '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Recebido Por</label>
                                <input type="text" class="form-control" name="recebido_por"
                                       value="{{ ocorrencia.recebido_por or '' }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observacoes Logistica</label>
                            <textarea class="form-control" name="observacoes_logistica" rows="3">{{ ocorrencia.observacoes_logistica or '' }}</textarea>
                        </div>
                    </form>
                    <div id="feedback-logistica" class="alert d-none"></div>
                </div>
            </div>
        </div>

        <!-- ABA COMERCIAL -->
        <div class="tab-pane fade" id="comercial" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Secao Comercial</h6>
                    <button type="button" class="btn btn-sm btn-primary" onclick="salvarComercial()">
                        Salvar Alteracoes
                    </button>
                </div>
                <div class="card-body">
                    <form id="form-comercial">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status" id="status_comercial">
                                    {% for valor, descricao in opcoes_status %}
                                    <option value="{{ valor }}" {% if ocorrencia.status == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Categoria</label>
                                <select class="form-select" name="categoria">
                                    <option value="">Selecione...</option>
                                    {% for valor, descricao in opcoes_categoria %}
                                    <option value="{{ valor }}" {% if ocorrencia.categoria == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Subcategoria</label>
                                <select class="form-select" name="subcategoria">
                                    <option value="">Selecione...</option>
                                    {% for valor, descricao in opcoes_subcategoria %}
                                    <option value="{{ valor }}" {% if ocorrencia.subcategoria == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Responsavel</label>
                                <select class="form-select" name="responsavel">
                                    {% for valor, descricao in opcoes_responsavel %}
                                    <option value="{{ valor }}" {% if ocorrencia.responsavel == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Origem</label>
                                <select class="form-select" name="origem">
                                    {% for valor, descricao in opcoes_origem %}
                                    <option value="{{ valor }}" {% if ocorrencia.origem == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Momento da Devolucao</label>
                                <select class="form-select" name="momento_devolucao">
                                    {% for valor, descricao in opcoes_momento_devolucao %}
                                    <option value="{{ valor }}" {% if ocorrencia.momento_devolucao == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Autorizado Por</label>
                                <input type="text" class="form-control" name="autorizado_por"
                                       value="{{ ocorrencia.autorizado_por or '' }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descricao Comercial</label>
                            <textarea class="form-control" name="descricao_comercial" rows="3">{{ ocorrencia.descricao_comercial or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Desfecho</label>
                            <textarea class="form-control" name="desfecho" rows="3">{{ ocorrencia.desfecho or '' }}</textarea>
                        </div>
                    </form>
                    <div id="feedback-comercial" class="alert d-none"></div>
                </div>
            </div>
        </div>

        <!-- ABA ANEXOS -->
        <div class="tab-pane fade" id="anexos" role="tabpanel">
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Novo Anexo</h6>
                </div>
                <div class="card-body">
                    <form id="form-upload-anexo" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Arquivo</label>
                                <input type="file" class="form-control" name="arquivo" id="arquivo-anexo" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tipo</label>
                                <select class="form-select" name="tipo" id="tipo-anexo">
                                    <option value="DOCUMENTO">Documento</option>
                                    <option value="EMAIL">Email (.msg/.eml)</option>
                                    <option value="FOTO">Foto</option>
                                    <option value="PLANILHA">Planilha</option>
                                    <option value="OUTROS">Outros</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Descricao</label>
                                <input type="text" class="form-control" name="descricao" placeholder="Opcional...">
                            </div>
                            <div class="col-md-2 mb-3 d-flex align-items-end">
                                <button type="button" class="btn btn-primary w-100" onclick="uploadAnexo()">
                                    <span class="spinner-border spinner-border-sm d-none" id="spinner-upload"></span>
                                    Enviar
                                </button>
                            </div>
                        </div>
                    </form>
                    <div id="feedback-anexo" class="alert d-none mt-2"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Anexos Existentes</h6>
                </div>
                <div class="card-body">
                    <div id="lista-anexos">
                        {% if anexos %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Nome</th>
                                        <th>Tamanho</th>
                                        <th>Adicionado em</th>
                                        <th>Por</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for anexo in anexos %}
                                    <tr id="anexo-row-{{ anexo.id }}">
                                        <td>
                                            <span class="badge bg-{{ 'info' if anexo.tipo == 'EMAIL' else 'success' if anexo.tipo == 'FOTO' else 'warning' if anexo.tipo == 'PLANILHA' else 'secondary' }}">
                                                {{ anexo.tipo }}
                                            </span>
                                        </td>
                                        <td>
                                            {{ anexo.nome_original }}
                                            {% if anexo.descricao %}
                                            <br><small class="text-muted">{{ anexo.descricao }}</small>
                                            {% endif %}
                                        </td>
                                        <td><small>{{ anexo.tamanho_kb }} KB</small></td>
                                        <td><small>{{ anexo.criado_em.strftime('%d/%m/%Y %H:%M') }}</small></td>
                                        <td><small>{{ anexo.criado_por }}</small></td>
                                        <td>
                                            <a href="/devolucao/ocorrencias/api/{{ ocorrencia.id }}/anexos/{{ anexo.id }}/download"
                                               class="btn btn-sm btn-outline-primary"> <i class="bi bi-download"></i> Download</a>
                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                    onclick="excluirAnexo({{ anexo.id }}, '{{ anexo.nome_original }}')"
                                                    > <i class="bi bi-trash"></i> Excluir</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center mb-0">Nenhum anexo</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA FRETE RETORNO -->
        <div class="tab-pane fade" id="frete" role="tabpanel">
            <!-- Formulario de Novo Frete -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center"
                     data-bs-toggle="collapse" data-bs-target="#form-frete-collapse"
                     style="cursor: pointer;" role="button">
                    <h6 class="mb-0"><i class="bi bi-plus-lg me-2"></i>Nova Cotacao de Frete</h6>
                    <i class="bi bi-chevron-down collapse-icon"></i>
                </div>
                <div class="collapse" id="form-frete-collapse">
                    <div class="card-body">
                        <form id="form-novo-frete">
                            <input type="hidden" name="transportadora_id" id="transportadora_id">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Transportadora</label>
                                    <select class="form-select" name="transportadora_nome" id="select-transportadora" required>
                                        <option value="">Carregando...</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3 d-flex align-items-end gap-1">
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="estimarFreteRetorno()" id="btn-estimar-retorno" disabled title="Selecione uma transportadora">
                                        <i class="bi bi-calculator"></i> Estimar
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm d-none" onclick="abrirModalDetalhesFrete()" id="btn-ver-detalhes" title="Ver detalhes do calculo">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Valor Cotado</label>
                                    <input type="number" step="0.01" class="form-control" name="valor_cotado" id="valor_cotado" placeholder="0.00" required>
                                    <small id="info-estimativa" class="text-muted d-none"></small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Peso (kg)</label>
                                    <div class="input-group">
                                        <input type="number" step="0.001" class="form-control" name="peso_kg" id="peso_kg" placeholder="0.000">
                                        <button type="button" class="btn btn-outline-secondary" onclick="calcularPeso()" title="Calcular peso automaticamente">
                                            <i class="bi bi-calculator"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Data Cotacao</label>
                                    <input type="date" class="form-control" name="data_cotacao">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Coleta Prevista</label>
                                    <input type="date" class="form-control" name="data_coleta_prevista">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Local de Coleta</label>
                                    <input type="text" class="form-control" name="local_coleta" id="local_coleta"
                                           value="{{ entrega.cliente if entrega and entrega.cliente else (nfd.nome_emitente if nfd else '') }}"
                                           placeholder="Ex: CD Atacadao, Loja Assai...">
                                    <small class="text-muted">Nome do local onde sera feita a coleta</small>
                                </div>
                                <div class="col-md-1 mb-3">
                                    <label class="form-label">UF Orig.</label>
                                    <select class="form-select" name="uf_origem" id="uf_origem" required>
                                        <option value="">...</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Cidade Origem</label>
                                    <select class="form-select" name="cidade_origem" id="cidade_origem" required>
                                        <option value="">Selecione UF</option>
                                    </select>
                                </div>
                                <div class="col-md-1 mb-3">
                                    <label class="form-label">UF Dest.</label>
                                    <select class="form-select" name="uf_destino" id="uf_destino" required>
                                        <option value="">...</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Cidade Destino</label>
                                    <select class="form-select" name="cidade_destino" id="cidade_destino" required>
                                        <option value="">Selecione UF</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Observacoes</label>
                                    <input type="text" class="form-control" name="observacoes" placeholder="Opcional">
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="criarFrete()">
                                <span class="spinner-border spinner-border-sm d-none" id="spinner-frete"></span>
                                Criar Cotacao
                            </button>
                        </form>
                        <div id="feedback-frete" class="alert d-none mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Lista de Fretes -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Cotacoes de Frete</h6>
                </div>
                <div class="card-body">
                    <div id="lista-fretes">
                        {% if fretes %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Transportadora</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>Rota</th>
                                        <th>Data Cotacao</th>
                                        <th>Acoes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for frete in fretes %}
                                    <tr id="frete-row-{{ frete.id }}">
                                        <td>{{ frete.transportadora_nome }}</td>
                                        <td>R$ {{ "%.2f"|format(frete.valor_cotado) }}</td>
                                        <td>
                                            <select class="form-select form-select-sm status-frete" data-frete-id="{{ frete.id }}" style="width: auto;">
                                                <option value="COTADO" {% if frete.status == 'COTADO' %}selected{% endif %}>Cotado</option>
                                                <option value="APROVADO" {% if frete.status == 'APROVADO' %}selected{% endif %}>Aprovado</option>
                                                <option value="COLETADO" {% if frete.status == 'COLETADO' %}selected{% endif %}>Coletado</option>
                                                <option value="ENTREGUE" {% if frete.status == 'ENTREGUE' %}selected{% endif %}>Entregue</option>
                                                <option value="CANCELADO" {% if frete.status == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                                            </select>
                                        </td>
                                        <td>
                                            {% if frete.local_coleta %}<small class="text-muted">{{ frete.local_coleta }}</small><br>{% endif %}
                                            {{ frete.cidade_origem }}/{{ frete.uf_origem }} â†’ {{ frete.cidade_destino }}/{{ frete.uf_destino }}
                                        </td>
                                        <td>{{ frete.data_cotacao.strftime('%d/%m/%Y') if frete.data_cotacao else '-' }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="excluirFrete({{ frete.id }})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center mb-0">Nenhuma cotacao de frete registrada</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA PRODUTOS -->
        <div class="tab-pane fade" id="produtos" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0 d-inline">Produtos da NFD</h6>
                        {% if linhas %}
                        <span class="badge bg-success ms-2">{{ linhas|selectattr('produto_resolvido')|list|length }} resolvidas</span>
                        <span class="badge bg-warning">{{ linhas|rejectattr('produto_resolvido')|list|length }} pendentes</span>
                        {% endif %}
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-info" id="btn-comparar-nf" onclick="toggleComparacaoNF()">
                            <i class="bi bi-arrow-left-right"></i> Comparar com NF de venda
                        </button>
                        <button type="button" class="btn btn-sm btn-info" onclick="resolverTodosComIA()">
                            <i class="bi bi-cpu"></i> Resolver Produtos
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Tabela de Produtos NFD -->
                    <div id="tabela-produtos-nfd">
                        {% if linhas %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Produto Cliente</th>
                                        <th>Qtd NFD</th>
                                        <th>Nosso Codigo</th>
                                        <th>Qtd Conv.</th>
                                        <th class="text-end">Valor</th>
                                        <th class="text-end">Peso (kg)</th>
                                        <th>Status</th>
                                        <th>Acoes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set ns = namespace(total_valor=0, total_peso=0) %}
                                    {% for linha in linhas %}
                                    {% set valor_linha = (linha.valor_unitario or 0) * (linha.quantidade or 0) %}
                                    {% set ns.total_valor = ns.total_valor + valor_linha %}
                                    {% set ns.total_peso = ns.total_peso + (linha.peso_bruto or 0) %}
                                    <tr id="prod-linha-{{ linha.id }}" class="{{ 'table-success' if linha.produto_resolvido else '' }}">
                                        <td>{{ linha.numero_item or loop.index }}</td>
                                        <td>
                                            <code>{{ linha.codigo_produto_cliente or '-' }}</code>
                                            <br><small class="text-muted">{{ linha.descricao_produto_cliente or '-' }}</small>
                                        </td>
                                        <td>{{ linha.quantidade }} {{ linha.unidade_medida }}</td>
                                        <td id="prod-nosso-{{ linha.id }}">
                                            {% if linha.codigo_produto_interno %}
                                            <strong class="text-primary">{{ linha.codigo_produto_interno }}</strong>
                                            <br><small class="text-muted">{{ linha.descricao_produto_interno or '' }}</small>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td id="prod-qtd-{{ linha.id }}">
                                            {% if linha.quantidade_convertida %}
                                            <span class="badge bg-success">{{ "%.3f"|format(linha.quantidade_convertida|float) }} cx</span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end" id="prod-valor-{{ linha.id }}">
                                            {% if linha.valor_unitario %}
                                            R$ {{ "%.2f"|format(valor_linha) }}
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end" id="prod-peso-{{ linha.id }}">
                                            {% if linha.peso_bruto %}
                                            {{ "%.2f"|format(linha.peso_bruto|float) }}
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td id="prod-status-{{ linha.id }}">
                                            {% if linha.produto_resolvido %}
                                            <span class="badge bg-success">Resolvido</span>
                                            {% else %}
                                            <span class="badge bg-warning">Pendente</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if not linha.produto_resolvido %}
                                            <button class="btn btn-sm btn-outline-info py-0 px-2"
                                                    onclick="abrirModalResolverProduto({{ linha.id }}, '{{ linha.codigo_produto_cliente|e }}', '{{ linha.descricao_produto_cliente|e }}', {{ linha.quantidade|default(0) }}, '{{ linha.unidade_medida|default('')|e }}')"
                                                    title="Resolver com IA">
                                                <i class="bi bi-magic"></i> Resolver
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-primary py-0 px-2 btn-editar-produto"
                                                    data-linha-id="{{ linha.id }}"
                                                    data-codigo-cliente="{{ linha.codigo_produto_cliente|default('', true) }}"
                                                    data-descricao-cliente="{{ linha.descricao_produto_cliente|default('', true) }}"
                                                    data-quantidade="{{ linha.quantidade|default(0) }}"
                                                    data-unidade="{{ linha.unidade_medida|default('', true) }}"
                                                    data-codigo-interno="{{ linha.codigo_produto_interno|default('', true) }}"
                                                    data-descricao-interna="{{ linha.descricao_produto_interno|default('', true) }}"
                                                    data-qtd-convertida="{{ linha.quantidade_convertida|default('', true) }}"
                                                    data-fator-conversao="{{ linha.qtd_por_caixa|default('', true) }}"
                                                    title="Editar produto">
                                                <i class="bi bi-pencil"></i> Editar
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="5" class="text-end"><strong>Total:</strong></td>
                                        <td class="text-end"><strong>R$ {{ "%.2f"|format(ns.total_valor) }}</strong></td>
                                        <td class="text-end"><strong>{{ "%.2f"|format(ns.total_peso) }} kg</strong></td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center my-4">Nenhum produto na NFD</p>
                        {% endif %}
                    </div>

                    <!-- Tabela de Comparacao com NF de Venda (oculta inicialmente) -->
                    <div id="tabela-comparacao-nf" class="d-none">
                        <div class="alert alert-info m-3 mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Comparando produtos da NFD com as NFs de venda referenciadas
                        </div>
                        <div id="loading-comparacao" class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-2">Buscando dados das NFs de venda...</p>
                        </div>
                        <div id="resultado-comparacao" class="d-none">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 80px;">Codigo</th>
                                            <th style="width: 35%;">Descricao</th>
                                            <th style="width: 100px;" class="text-end">Qtd Vendida</th>
                                            <th style="width: 100px;" class="text-end">Qtd Devolvida</th>
                                            <th style="width: 80px;" class="text-end">% Devol.</th>
                                            <th style="width: 100px;" class="text-end">Preco Venda</th>
                                            <th style="width: 100px;" class="text-end">Preco Devol.</th>
                                            <th style="width: 100px;" class="text-end">Valor Devol.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-comparacao"></tbody>
                                    <tfoot class="table-light" id="tfoot-comparacao"></tfoot>
                                </table>
                            </div>
                            <div id="nfs-nao-encontradas" class="alert alert-warning m-3 d-none">
                                <strong>NFs de venda nao encontradas no sistema:</strong>
                                <span id="lista-nfs-nao-encontradas"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA DESCARTE -->
        <div class="tab-pane fade" id="descarte" role="tabpanel">
            <!-- Formulario de Novo Descarte -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center"
                     data-bs-toggle="collapse" data-bs-target="#form-descarte-collapse"
                     style="cursor: pointer;" role="button">
                    <h6 class="mb-0"><i class="bi bi-plus-lg me-2"></i>Autorizar Descarte</h6>
                    <i class="bi bi-chevron-down collapse-icon"></i>
                </div>
                <div class="collapse" id="form-descarte-collapse">
                    <div class="card-body">
                        <form id="form-novo-descarte">
                            <!-- Empresa Autorizada a Descartar (obrigatorio para compliance) -->
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong>Importante:</strong> Informe a empresa autorizada a realizar o descarte antes de gerar o termo.
                            </div>
                            <div class="row">
                                <div class="col-md-5 mb-3">
                                    <label class="form-label">Empresa Autorizada <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="empresa_autorizada_nome" placeholder="Razao Social da empresa" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">CNPJ/CPF <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="empresa_autorizada_documento" placeholder="00.000.000/0000-00" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Tipo</label>
                                    <select class="form-select" name="empresa_autorizada_tipo">
                                        <option value="TRANSPORTADOR">Transportador</option>
                                        <option value="CLIENTE">Cliente</option>
                                    </select>
                                </div>
                            </div>
                            <hr class="my-3">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Motivo do Descarte <span class="text-danger">*</span></label>
                                    <select class="form-select" name="motivo_descarte" required>
                                        <option value="">Selecione...</option>
                                        <option value="CUSTO_ALTO">Custo de frete maior que valor da mercadoria</option>
                                        <option value="PERECIVEIS">Produtos pereciveis/vencidos</option>
                                        <option value="AVARIA_TOTAL">Avaria total - sem condicoes de retorno</option>
                                        <option value="CONTAMINACAO">Contaminacao/risco sanitario</option>
                                        <option value="CLIENTE_SOLICITOU">Cliente solicitou o descarte</option>
                                        <option value="OUTROS">Outros</option>
                                    </select>
                                    <small class="text-muted">Para controle interno (nao aparece no termo)</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Valor Total da Mercadoria</label>
                                    <input type="number" step="0.01" class="form-control" name="valor_mercadoria" id="valor_mercadoria_descarte" placeholder="R$ 0.00" readonly>
                                    <small class="text-muted">Calculado automaticamente dos itens</small>
                                </div>
                            </div>

                            <!-- Itens da NFD para Descarte -->
                            {% if linhas %}
                            <div class="mb-3">
                                <label class="form-label"><strong>Itens para Descarte</strong></label>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 30%;">Produto</th>
                                                <th class="text-center" style="width: 10%;">Qtd NFD</th>
                                                <th class="text-end" style="width: 12%;">Valor NFD</th>
                                                <th class="text-center" style="width: 15%;">Qtd Descarte (un)</th>
                                                <th class="text-center" style="width: 15%;">Qtd Descarte (cx)</th>
                                                <th class="text-end" style="width: 18%;">Valor Descarte</th>
                                            </tr>
                                        </thead>
                                        <tbody id="itens-descarte">
                                            {% for linha in linhas %}
                                            <tr data-linha-id="{{ linha.id }}"
                                                data-qtd-por-caixa="{{ linha.qtd_por_caixa or 1 }}"
                                                data-valor-unitario="{{ linha.valor_unitario or 0 }}"
                                                data-qtd-original="{{ linha.quantidade or 0 }}">
                                                <td>
                                                    <small class="text-muted">{{ linha.codigo_produto_interno or linha.codigo_produto_cliente or '-' }}</small><br>
                                                    {{ linha.descricao_produto_interno or linha.descricao_produto_cliente or 'Produto nao resolvido' }}
                                                </td>
                                                <td class="text-center">{{ "%.0f"|format(linha.quantidade or 0) }} {{ linha.unidade_medida or 'UN' }}</td>
                                                <td class="text-end">R$ {{ "%.2f"|format(linha.valor_total or 0) }}</td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm text-center qtd-un-descarte"
                                                           value="{{ linha.quantidade|int }}" step="1" min="0"
                                                           onchange="atualizarQtdDescarte(this, 'un')">
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm text-center qtd-cx-descarte"
                                                           value="{{ ((linha.quantidade or 0) / (linha.qtd_por_caixa or 1))|round(2) }}" step="0.01" min="0"
                                                           onchange="atualizarQtdDescarte(this, 'cx')">
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm text-end valor-descarte-linha"
                                                           value="{{ linha.valor_total or 0 }}" step="0.01" readonly>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr class="border-top-2">
                                                <td colspan="5" class="text-end"><strong class="text-body">TOTAL:</strong></td>
                                                <td class="text-end"><strong id="total-valor-descarte" class="text-body">R$ 0.00</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> Nenhum item de produto encontrado na NFD.
                            </div>
                            {% endif %}

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Descricao do Motivo</label>
                                    <textarea class="form-control" name="descricao_motivo" rows="2" placeholder="Detalhe o motivo do descarte..."></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="tem-custo-descarte" name="tem_custo">
                                        <label class="form-check-label" for="tem-custo-descarte">
                                            Tem custo de descarte?
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3 custo-descarte-fields d-none">
                                    <label class="form-label">Valor do Descarte</label>
                                    <input type="number" step="0.01" class="form-control" name="valor_descarte" placeholder="R$ 0.00">
                                </div>
                                <div class="col-md-6 mb-3 custo-descarte-fields d-none">
                                    <label class="form-label">Fornecedor do Descarte</label>
                                    <input type="text" class="form-control" name="fornecedor_descarte" placeholder="Empresa de descarte">
                                </div>
                            </div>
                            <button type="button" class="btn btn-warning" onclick="criarDescarte()">
                                <span class="spinner-border spinner-border-sm d-none" id="spinner-descarte"></span>
                                Autorizar Descarte
                            </button>
                        </form>
                        <div id="feedback-descarte" class="alert d-none mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Lista de Descartes -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Descartes Autorizados</h6>
                </div>
                <div class="card-body">
                    <div id="lista-descartes">
                        {% if descartes %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Termo</th>
                                        <th>Empresa Autorizada</th>
                                        <th>Valor Merc.</th>
                                        <th>Status</th>
                                        <th>Autorizado em</th>
                                        <th>Documentos</th>
                                        <th>Acoes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for desc in descartes %}
                                    <tr id="descarte-row-{{ desc.id }}">
                                        <td>{{ desc.numero_termo or '-' }}</td>
                                        <td>
                                            {% if desc.empresa_autorizada_nome %}
                                            <strong>{{ desc.empresa_autorizada_nome }}</strong><br>
                                            <small class="text-muted">{{ desc.empresa_autorizada_documento or '-' }}</small>
                                            <span class="badge bg-info">{{ 'Transp.' if desc.empresa_autorizada_tipo == 'TRANSPORTADOR' else 'Cliente' }}</span>
                                            {% else %}
                                            <span class="text-warning"><i class="bi bi-exclamation-triangle"></i> Nao informada</span>
                                            {% endif %}
                                        </td>
                                        <td>{% if desc.valor_mercadoria %}R$ {{ "%.2f"|format(desc.valor_mercadoria) }}{% else %}-{% endif %}</td>
                                        <td>
                                            <select class="form-select form-select-sm status-descarte" data-descarte-id="{{ desc.id }}" style="width: auto;">
                                                <option value="AUTORIZADO" {% if desc.status == 'AUTORIZADO' %}selected{% endif %}>Autorizado</option>
                                                <option value="TERMO_ENVIADO" {% if desc.status == 'TERMO_ENVIADO' %}selected{% endif %}>Termo Enviado</option>
                                                <option value="TERMO_RETORNADO" {% if desc.status == 'TERMO_RETORNADO' %}selected{% endif %}>Termo Retornado</option>
                                                <option value="DESCARTADO" {% if desc.status == 'DESCARTADO' %}selected{% endif %}>Descartado</option>
                                                <option value="CANCELADO" {% if desc.status == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                                            </select>
                                        </td>
                                        <td>{{ desc.data_autorizacao.strftime('%d/%m/%Y') if desc.data_autorizacao else '-' }}</td>
                                        <td>
                                            <div class="btn-group-vertical btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadTermoDescarte({{ desc.id }})" title="Baixar termo">
                                                    <i class="bi bi-download"></i> Download
                                                </button>
                                                <button type="button" class="btn btn-outline-info btn-sm" onclick="imprimirTermoDescarte({{ desc.id }})" title="Imprimir termo">
                                                    <i class="bi bi-printer"></i> Imprimir
                                                </button>
                                                <button type="button" class="btn btn-outline-success btn-sm" onclick="uploadTermoDescarte({{ desc.id }}, 'termo_assinado')" title="Importar termo assinado">
                                                    <i class="bi bi-upload"></i> Importar
                                                    {% if desc.termo_assinado_path %}<span class="badge bg-success ms-1">OK</span>{% endif %}
                                                </button>
                                            </div>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="excluirDescarte({{ desc.id }})" title="Excluir descarte">
                                                <i class="bi bi-trash"></i>Excluir Descarte
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center mb-0">Nenhum descarte autorizado</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Resolver Todos com IA -->
<div class="modal fade" id="modal-resolver-todos" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resolver Todas as Linhas com IA</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" id="btn-fechar-resolver-todos"></button>
            </div>
            <div class="modal-body">
                <!-- Loading -->
                <div id="resolver-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                    <p class="mt-3">Consultando IA para todas as linhas pendentes...</p>
                    <p class="text-muted small">Isso pode levar alguns segundos</p>
                </div>
                <!-- Resultado -->
                <div id="resolver-resultado" class="d-none">
                    <!-- Resumo -->
                    <div class="alert alert-info mb-3" id="resolver-resumo"></div>
                    <!-- Opcoes -->
                    <div class="mb-2 d-flex justify-content-between align-items-center">
                        <div>
                            <input type="checkbox" id="resolver-selecionar-todos" class="form-check-input me-1" onchange="toggleSelecionarTodosResolver()">
                            <label for="resolver-selecionar-todos" class="form-check-label small">Selecionar todos</label>
                        </div>
                        <div>
                            <input type="checkbox" id="resolver-gravar-depara" class="form-check-input me-1" checked>
                            <label for="resolver-gravar-depara" class="form-check-label small">Gravar De-Para</label>
                        </div>
                    </div>
                    <!-- Tabela de resultados -->
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 30px;"></th>
                                    <th>Produto Cliente</th>
                                    <th>Nosso Produto</th>
                                    <th class="text-center">Qtd NFD</th>
                                    <th class="text-center">Conversao</th>
                                    <th class="text-center">Confianca</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="resolver-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Aplicando -->
                <div id="resolver-aplicando" class="d-none text-center py-5">
                    <div class="spinner-border text-success" style="width: 3rem; height: 3rem;"></div>
                    <p class="mt-3">Aplicando resolucoes...</p>
                    <p class="text-muted small" id="resolver-aplicando-progresso">0/0</p>
                </div>
            </div>
            <div class="modal-footer d-none" id="resolver-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" id="btn-aplicar-resolucoes" onclick="aplicarResolucoesSelecionadas()">
                    <i class="bi bi-check-circle"></i> Aplicar Selecionadas (<span id="count-selecionadas">0</span>)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Upload Termo Descarte -->
<div class="modal fade" id="modal-upload-termo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload de Documento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-upload-termo" enctype="multipart/form-data">
                    <input type="hidden" id="upload-descarte-id" name="descarte_id">
                    <input type="hidden" id="upload-tipo-documento" name="tipo_documento">
                    <div class="mb-3">
                        <label class="form-label">Arquivo</label>
                        <input type="file" class="form-control" name="arquivo" id="arquivo-termo" required>
                        <small class="text-muted">PDF, imagem ou documento</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="enviarTermoDescarte()">
                    <span class="spinner-border spinner-border-sm d-none" id="spinner-upload-termo"></span>
                    Enviar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar NFs de Venda -->
<div class="modal fade" id="modal-editar-nfs" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar NFs de Venda Referenciadas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Lista de NFs existentes -->
                <div class="mb-3">
                    <label class="form-label fw-bold">NFs Vinculadas:</label>
                    <div id="lista-nfs-modal">
                        <span class="text-muted">Carregando...</span>
                    </div>
                </div>

                <hr>

                <!-- FormulÃ¡rio para adicionar nova NF -->
                <h6>Adicionar Nova NF de Venda</h6>
                <form id="form-adicionar-nf">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">NÃºmero NF *</label>
                            <input type="text" class="form-control" id="nova-nf-numero" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">SÃ©rie</label>
                            <input type="text" class="form-control" id="nova-nf-serie" value="1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Chave de Acesso (44 dÃ­gitos)</label>
                        <input type="text" class="form-control" id="nova-nf-chave" maxlength="44" pattern="[0-9]{44}" placeholder="Opcional">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="adicionarNF()">
                    <span class="spinner-border spinner-border-sm d-none" id="spinner-add-nf"></span>
                    Adicionar NF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Resolver/Editar Produto -->
<div class="modal fade" id="modal-produto" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-produto-titulo">Resolver Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Info do produto do cliente -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Produto do Cliente:</label>
                    <div id="modal-produto-cliente-info" class="alert alert-light"></div>
                </div>

                <!-- Sugestoes da IA (apenas no modo resolver) -->
                <div id="modal-sugestoes-ia" class="mb-3 d-none">
                    <label class="form-label fw-bold">Sugestoes da IA:</label>
                    <div id="modal-sugestoes-lista">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm"></div>
                            <span class="ms-2">Consultando IA...</span>
                        </div>
                    </div>
                </div>

                <hr>

                <!-- Formulario de edicao -->
                <form id="form-produto">
                    <input type="hidden" id="prod-linha-id">
                    <div class="row">
                        <div class="col-md-5 mb-3">
                            <label class="form-label">Nosso Codigo *</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="prod-nosso-codigo"
                                       placeholder="Digite codigo ou nome..."
                                       autocomplete="off" oninput="buscarProdutosAba(this.value)">
                                <div id="autocomplete-produtos-aba" class="dropdown-menu w-100" style="max-height: 250px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        <div class="col-md-7 mb-3">
                            <label class="form-label">Descricao</label>
                            <input type="text" class="form-control" id="prod-nosso-descricao" readonly>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Qtd Original</label>
                            <input type="text" class="form-control" id="prod-qtd-original" readonly>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Fator Conversao</label>
                            <input type="number" step="0.01" class="form-control" id="prod-fator-conversao"
                                   placeholder="Ex: 12" onchange="calcularQtdConvertida()">
                            <small class="text-muted">UN/CX</small>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Qtd Convertida</label>
                            <input type="number" step="0.01" class="form-control" id="prod-qtd-convertida"
                                   placeholder="Caixas" readonly>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Peso (kg)</label>
                            <input type="number" step="0.01" class="form-control" id="prod-peso" readonly>
                        </div>
                    </div>
                    <div id="prod-info-extra" class="alert alert-light d-none">
                        <small>
                            <strong>Embalagem:</strong> <span id="prod-info-embalagem">-</span> |
                            <strong>Materia:</strong> <span id="prod-info-materia">-</span> |
                            <strong>Peso/CX:</strong> <span id="prod-info-peso-cx">-</span> kg
                        </small>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="prod-gravar-depara" checked>
                        <label class="form-check-label" for="prod-gravar-depara">
                            Gravar no De-Para para uso futuro
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarProduto()">
                    <span class="spinner-border spinner-border-sm d-none" id="spinner-salvar-prod"></span>
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalhes do Calculo de Frete -->
<div class="modal fade" id="modal-detalhes-frete" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calculator me-2"></i>Detalhamento do Calculo de Frete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <small class="text-muted">
                        <strong>Transportadora:</strong> <span id="det-transportadora">-</span><br>
                        <strong>Tabela:</strong> <span id="det-tabela">-</span><br>
                        <strong>Rota:</strong> <span id="det-rota">-</span>
                    </small>
                </div>
                <table class="table table-sm table-bordered mb-0">
                    <tbody>
                        <tr>
                            <td>Frete Peso</td>
                            <td class="text-end" id="det-frete-peso">-</td>
                        </tr>
                        <tr>
                            <td>GRIS</td>
                            <td class="text-end" id="det-gris">-</td>
                        </tr>
                        <tr>
                            <td>ADV</td>
                            <td class="text-end" id="det-adv">-</td>
                        </tr>
                        <tr>
                            <td>RCA</td>
                            <td class="text-end" id="det-rca">-</td>
                        </tr>
                        <tr>
                            <td>Pedagio</td>
                            <td class="text-end" id="det-pedagio">-</td>
                        </tr>
                        <tr>
                            <td>TAS</td>
                            <td class="text-end" id="det-tas">-</td>
                        </tr>
                        <tr>
                            <td>Despacho</td>
                            <td class="text-end" id="det-despacho">-</td>
                        </tr>
                        <tr>
                            <td>CTe</td>
                            <td class="text-end" id="det-cte">-</td>
                        </tr>
                        <tr class="table-secondary">
                            <td><strong>Subtotal</strong></td>
                            <td class="text-end" id="det-subtotal"><strong>-</strong></td>
                        </tr>
                        <tr>
                            <td>ICMS (<span id="det-icms-perc">0</span>%)</td>
                            <td class="text-end" id="det-icms">-</td>
                        </tr>
                        <tr class="table-primary">
                            <td><strong>TOTAL</strong></td>
                            <td class="text-end" id="det-total"><strong>-</strong></td>
                        </tr>
                    </tbody>
                </table>
                <small class="text-muted d-none" id="det-frete-minimo">
                    <i class="bi bi-info-circle"></i> Frete minimo aplicado
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilo para Ã­cone de collapse rotacionar quando aberto */
.collapse-icon {
    transition: transform 0.2s ease;
}
[data-bs-toggle="collapse"][aria-expanded="true"] .collapse-icon,
[data-bs-toggle="collapse"]:not(.collapsed) .collapse-icon {
    transform: rotate(180deg);
}
/* Destacar header ao passar o mouse - usa variavel do tema */
.card-header[role="button"]:hover {
    background-color: var(--bg-light);
}
</style>

{% endblock %}

{% block scripts %}
<!-- Variaveis de contexto do template -->
<script>
const ocorrenciaId = {{ ocorrencia.id }};
const nfdId = {{ nfd.id }};
const ufOrigemPreset = '{{ entrega.uf if entrega and entrega.uf else (nfd.uf_emitente if nfd and nfd.uf_emitente else "") }}';
const cidadeOrigemPreset = '{{ entrega.municipio if entrega and entrega.municipio else (nfd.municipio_emitente if nfd and nfd.municipio_emitente else "") }}';
const PREFIXO_CNPJ = '{{ nfd.prefixo_cnpj_emitente or "" }}';
</script>
<!-- Script modularizado -->
<script src="{{ url_for('static', filename='js/devolucao/ocorrencia-detalhe.js') }}?v=1"></script>
{% endblock %}
