{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Header compacto -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-0 d-inline">{{ ocorrencia.numero_ocorrencia }}</h4>
            <small class="text-muted ms-3">Sincronizada em {{ ocorrencia.data_abertura.strftime('%d/%m/%Y %H:%M') }}</small>
        </div>
        <div>
            <a href="{{ url_for('devolucao.devolucao_ocorrencia.index') }}" class="btn btn-sm btn-outline-secondary">
                Voltar
            </a>
        </div>
    </div>

    <!-- Info da NFD -->
    {% if nfd %}
    <div class="card mb-3">
        <div class="card-header py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h6 class="mb-0">Dados da NFD</h6>
                    <small class="text-muted">|</small>
                    <small class="text-muted">Status:</small>
                    <span class="badge bg-{{ 'warning' if ocorrencia.status == 'ABERTA' else 'info' if ocorrencia.status == 'EM_ANALISE' else 'success' }}">
                        {{ ocorrencia.status }}
                    </span>
                    <small class="text-muted">Destino:</small>
                    <span class="badge bg-{{ 'secondary' if ocorrencia.destino == 'INDEFINIDO' else 'primary' if ocorrencia.destino == 'RETORNO' else 'info' }}">
                        {{ ocorrencia.destino or 'INDEFINIDO' }}
                    </span>
                    <small class="text-muted">Local:</small>
                    <span class="badge bg-secondary">{{ ocorrencia.localizacao_atual or 'CLIENTE' }}</span>
                    {% if ocorrencia.data_resolucao %}
                    <small class="text-success ms-2">Resolvida {{ ocorrencia.data_resolucao.strftime('%d/%m/%Y') }}</small>
                    {% endif %}
                </div>
                <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('devolucao.devolucao_ocorrencia.download_pdf', nfd_id=nfd.id) }}"
                       class="btn btn-outline-danger" title="Baixar PDF da NFD" target="_blank">
                        <i class="bi bi-file-earmark-pdf"></i> PDF
                    </a>
                    <a href="{{ url_for('devolucao.devolucao_ocorrencia.download_xml', nfd_id=nfd.id) }}"
                       class="btn btn-outline-secondary" title="Baixar XML da NFD" target="_blank">
                        <i class="bi bi-file-earmark-code"></i> XML
                    </a>
                    <button type="button" class="btn btn-info" onclick="resolverTodosComIA()">
                        <i class="bi bi-cpu"></i> Resolver Produtos
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body py-2">
            <div class="row mb-2">
                <div class="col-md-2">
                    <small class="text-muted">NFD</small><br>
                    <strong>{{ nfd.numero_nfd }}</strong>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Emissao</small><br>
                    {% if nfd.data_emissao %}
                    {{ nfd.data_emissao.strftime('%d/%m/%Y') }}
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Motivo</small><br>
                    <span class="badge bg-{{ 'danger' if nfd.motivo == 'AVARIA' else 'warning' if nfd.motivo == 'FALTA' else 'info' }}">
                        {{ nfd.motivo }}
                    </span>
                </div>
                <div class="col-md-2">
                    <small class="text-muted">Valor</small><br>
                    {% if nfd.valor_total %}
                    <strong>R$ {{ "%.2f"|format(nfd.valor_total) }}</strong>
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Transportadora</small><br>
                    {% if transportadoras %}
                    <i class="bi bi-truck text-info"></i>
                    {% for t in transportadoras %}{{ t }}{% if not loop.last %}, {% endif %}{% endfor %}
                    {% else %}
                    -
                    {% endif %}
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-md-4">
                    <small class="text-muted">Cliente/Emitente</small><br>
                    {{ nfd.nome_emitente or (entrega.cliente if entrega else '-') }}
                    {% if nfd.cnpj_emitente %}
                    <br><small class="text-muted">CNPJ: {{ nfd.cnpj_emitente|formatar_cnpj }}</small>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Motivo (IA)</small>
                    {% if nfd.confianca_motivo %}
                    <span class="badge bg-{{ 'success' if nfd.confianca_motivo >= 0.8 else 'warning' if nfd.confianca_motivo >= 0.5 else 'danger' }} ms-1" style="font-size: 0.65rem;">
                        {{ "%.0f"|format(nfd.confianca_motivo * 100) }}%
                    </span>
                    {% endif %}
                    <br>
                    {% if nfd.descricao_motivo %}
                    <span data-bs-toggle="tooltip" title="{{ nfd.descricao_motivo }}">
                        {{ nfd.descricao_motivo[:60] }}{% if nfd.descricao_motivo|length > 60 %}...{% endif %}
                    </span>
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Info Complementar</small><br>
                    {% if nfd.info_complementar %}
                    <span data-bs-toggle="tooltip" data-bs-html="true" title="{{ nfd.info_complementar|e }}">
                        {{ nfd.info_complementar[:50] }}{% if nfd.info_complementar|length > 50 %}...{% endif %}
                    </span>
                    {% else %}
                    -
                    {% endif %}
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <small class="text-muted">NF(s) de Venda Referenciadas</small>
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 py-0" onclick="abrirModalEditarNFs()" title="Editar NFs">
                        <i class="fas fa-edit"></i>
                    </button>
                    <div id="lista-nfs-referenciadas" class="mt-1">
                    {% if nfs_referenciadas %}
                        {% for nf_ref in nfs_referenciadas %}
                            {% if nf_ref.entrega_id %}
                                <a href="{{ url_for('monitoramento.visualizar_entrega', id=nf_ref.entrega_id) }}"
                                   class="btn btn-sm btn-outline-primary me-1 mb-1"
                                   title="Ver entrega no monitoramento">
                                    NF {{ nf_ref.numero_nf }}{% if nf_ref.data_entrega %} - Ent: {{ nf_ref.data_entrega.strftime('%d/%m/%Y') }}{% endif %}
                                </a>
                            {% else %}
                                <span class="badge bg-secondary me-1 mb-1">
                                    NF {{ nf_ref.numero_nf }}
                                    <small>(sem entrega)</small>
                                </span>
                            {% endif %}
                        {% endfor %}
                    {% elif nfd.numero_nf_venda %}
                        <span class="text-muted">{{ nfd.numero_nf_venda }}</span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                    </div>
                </div>
            </div>
            {% if nfd.chave_nfd %}
            <div class="row mt-2">
                <div class="col-12">
                    <small class="text-muted">Chave:</small>
                    <code class="ms-1" style="font-size: 0.75rem;">{{ nfd.chave_nfd }}</code>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Abas: Logistica | Comercial | Anexos | Frete | Descarte -->
    <ul class="nav nav-tabs mb-3" id="ocorrencia-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="logistica-tab" data-bs-toggle="tab" href="#logistica" role="tab">
                Logistica
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="comercial-tab" data-bs-toggle="tab" href="#comercial" role="tab">
                Comercial
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="anexos-tab" data-bs-toggle="tab" href="#anexos" role="tab">
                Anexos ({{ anexos|length }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="frete-tab" data-bs-toggle="tab" href="#frete" role="tab">
                Frete Retorno {% if fretes %}({{ fretes|length }}){% endif %}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="produtos-tab" data-bs-toggle="tab" href="#produtos" role="tab">
                Produtos {% if linhas %}({{ linhas|length }}){% endif %}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="descarte-tab" data-bs-toggle="tab" href="#descarte" role="tab">
                Descarte {% if descartes %}({{ descartes|length }}){% endif %}
            </a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- ABA LOGISTICA -->
        <div class="tab-pane fade show active" id="logistica" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Secao Logistica</h6>
                    <button type="button" class="btn btn-sm btn-primary" onclick="salvarLogistica()">
                        Salvar Alteracoes
                    </button>
                </div>
                <div class="card-body">
                    <form id="form-logistica">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Destino</label>
                                <select class="form-select" name="destino" id="destino">
                                    {% for valor, descricao in opcoes_destino %}
                                    <option value="{{ valor }}" {% if ocorrencia.destino == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Localizacao Atual</label>
                                <select class="form-select" name="localizacao_atual" id="localizacao_atual">
                                    {% for valor, descricao in opcoes_localizacao %}
                                    <option value="{{ valor }}" {% if ocorrencia.localizacao_atual == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Previsao Retorno</label>
                                <input type="date" class="form-control" name="data_previsao_retorno"
                                       value="{{ ocorrencia.data_previsao_retorno.strftime('%Y-%m-%d') if ocorrencia.data_previsao_retorno else '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Data/Hora Chegada CD</label>
                                <input type="datetime-local" class="form-control" name="data_chegada_cd"
                                       value="{{ ocorrencia.data_chegada_cd.strftime('%Y-%m-%dT%H:%M') if ocorrencia.data_chegada_cd else '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Recebido Por</label>
                                <input type="text" class="form-control" name="recebido_por"
                                       value="{{ ocorrencia.recebido_por or '' }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observacoes Logistica</label>
                            <textarea class="form-control" name="observacoes_logistica" rows="3">{{ ocorrencia.observacoes_logistica or '' }}</textarea>
                        </div>
                    </form>
                    <div id="feedback-logistica" class="alert d-none"></div>
                </div>
            </div>
        </div>

        <!-- ABA COMERCIAL -->
        <div class="tab-pane fade" id="comercial" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Secao Comercial</h6>
                    <button type="button" class="btn btn-sm btn-primary" onclick="salvarComercial()">
                        Salvar Alteracoes
                    </button>
                </div>
                <div class="card-body">
                    <form id="form-comercial">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status" id="status_comercial">
                                    {% for valor, descricao in opcoes_status %}
                                    <option value="{{ valor }}" {% if ocorrencia.status == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Categoria</label>
                                <select class="form-select" name="categoria">
                                    <option value="">Selecione...</option>
                                    {% for valor, descricao in opcoes_categoria %}
                                    <option value="{{ valor }}" {% if ocorrencia.categoria == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Subcategoria</label>
                                <select class="form-select" name="subcategoria">
                                    <option value="">Selecione...</option>
                                    {% for valor, descricao in opcoes_subcategoria %}
                                    <option value="{{ valor }}" {% if ocorrencia.subcategoria == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Responsavel</label>
                                <select class="form-select" name="responsavel">
                                    {% for valor, descricao in opcoes_responsavel %}
                                    <option value="{{ valor }}" {% if ocorrencia.responsavel == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Origem</label>
                                <select class="form-select" name="origem">
                                    {% for valor, descricao in opcoes_origem %}
                                    <option value="{{ valor }}" {% if ocorrencia.origem == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Momento da Devolucao</label>
                                <select class="form-select" name="momento_devolucao">
                                    {% for valor, descricao in opcoes_momento_devolucao %}
                                    <option value="{{ valor }}" {% if ocorrencia.momento_devolucao == valor %}selected{% endif %}>
                                        {{ descricao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Autorizado Por</label>
                                <input type="text" class="form-control" name="autorizado_por"
                                       value="{{ ocorrencia.autorizado_por or '' }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descricao Comercial</label>
                            <textarea class="form-control" name="descricao_comercial" rows="3">{{ ocorrencia.descricao_comercial or '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Desfecho</label>
                            <textarea class="form-control" name="desfecho" rows="3">{{ ocorrencia.desfecho or '' }}</textarea>
                        </div>
                    </form>
                    <div id="feedback-comercial" class="alert d-none"></div>
                </div>
            </div>
        </div>

        <!-- ABA ANEXOS -->
        <div class="tab-pane fade" id="anexos" role="tabpanel">
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Novo Anexo</h6>
                </div>
                <div class="card-body">
                    <form id="form-upload-anexo" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Arquivo</label>
                                <input type="file" class="form-control" name="arquivo" id="arquivo-anexo" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tipo</label>
                                <select class="form-select" name="tipo" id="tipo-anexo">
                                    <option value="DOCUMENTO">Documento</option>
                                    <option value="EMAIL">Email (.msg/.eml)</option>
                                    <option value="FOTO">Foto</option>
                                    <option value="PLANILHA">Planilha</option>
                                    <option value="OUTROS">Outros</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Descricao</label>
                                <input type="text" class="form-control" name="descricao" placeholder="Opcional...">
                            </div>
                            <div class="col-md-2 mb-3 d-flex align-items-end">
                                <button type="button" class="btn btn-primary w-100" onclick="uploadAnexo()">
                                    <span class="spinner-border spinner-border-sm d-none" id="spinner-upload"></span>
                                    Enviar
                                </button>
                            </div>
                        </div>
                    </form>
                    <div id="feedback-anexo" class="alert d-none mt-2"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Anexos Existentes</h6>
                </div>
                <div class="card-body">
                    <div id="lista-anexos">
                        {% if anexos %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Nome</th>
                                        <th>Tamanho</th>
                                        <th>Adicionado em</th>
                                        <th>Por</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for anexo in anexos %}
                                    <tr id="anexo-row-{{ anexo.id }}">
                                        <td>
                                            <span class="badge bg-{{ 'info' if anexo.tipo == 'EMAIL' else 'success' if anexo.tipo == 'FOTO' else 'warning' if anexo.tipo == 'PLANILHA' else 'secondary' }}">
                                                {{ anexo.tipo }}
                                            </span>
                                        </td>
                                        <td>
                                            {{ anexo.nome_original }}
                                            {% if anexo.descricao %}
                                            <br><small class="text-muted">{{ anexo.descricao }}</small>
                                            {% endif %}
                                        </td>
                                        <td><small>{{ anexo.tamanho_kb }} KB</small></td>
                                        <td><small>{{ anexo.criado_em.strftime('%d/%m/%Y %H:%M') }}</small></td>
                                        <td><small>{{ anexo.criado_por }}</small></td>
                                        <td>
                                            <a href="/devolucao/ocorrencias/api/{{ ocorrencia.id }}/anexos/{{ anexo.id }}/download"
                                               class="btn btn-sm btn-outline-primary"> <i class="bi bi-download"></i> Download</a>
                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                    onclick="excluirAnexo({{ anexo.id }}, '{{ anexo.nome_original }}')"
                                                    > <i class="bi bi-trash"></i> Excluir</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center mb-0">Nenhum anexo</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA FRETE RETORNO -->
        <div class="tab-pane fade" id="frete" role="tabpanel">
            <!-- Formulario de Novo Frete -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center"
                     data-bs-toggle="collapse" data-bs-target="#form-frete-collapse"
                     style="cursor: pointer;" role="button">
                    <h6 class="mb-0"><i class="bi bi-plus-lg me-2"></i>Nova Cotacao de Frete</h6>
                    <i class="bi bi-chevron-down collapse-icon"></i>
                </div>
                <div class="collapse" id="form-frete-collapse">
                    <div class="card-body">
                        <form id="form-novo-frete">
                            <input type="hidden" name="transportadora_id" id="transportadora_id">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Transportadora</label>
                                    <select class="form-select" name="transportadora_nome" id="select-transportadora" required>
                                        <option value="">Carregando...</option>
                                    </select>
                                </div>
                                <div class="col-md-1 mb-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="estimarFreteRetorno()" id="btn-estimar-retorno" disabled title="Selecione uma transportadora">
                                        <i class="bi bi-calculator"></i> Estimar
                                    </button>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Valor Cotado</label>
                                    <input type="number" step="0.01" class="form-control" name="valor_cotado" id="valor_cotado" placeholder="0.00" required>
                                    <small id="info-estimativa" class="text-muted d-none"></small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Peso (kg)</label>
                                    <div class="input-group">
                                        <input type="number" step="0.001" class="form-control" name="peso_kg" id="peso_kg" placeholder="0.000">
                                        <button type="button" class="btn btn-outline-secondary" onclick="calcularPeso()" title="Calcular peso automaticamente">
                                            <i class="bi bi-calculator"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Data Cotacao</label>
                                    <input type="date" class="form-control" name="data_cotacao">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Coleta Prevista</label>
                                    <input type="date" class="form-control" name="data_coleta_prevista">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Local de Coleta</label>
                                    <input type="text" class="form-control" name="local_coleta" id="local_coleta"
                                           value="{{ entrega.cliente if entrega and entrega.cliente else (nfd.nome_emitente if nfd else '') }}"
                                           placeholder="Ex: CD Atacadao, Loja Assai...">
                                    <small class="text-muted">Nome do local onde sera feita a coleta</small>
                                </div>
                                <div class="col-md-1 mb-3">
                                    <label class="form-label">UF Orig.</label>
                                    <select class="form-select" name="uf_origem" id="uf_origem" required>
                                        <option value="">...</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Cidade Origem</label>
                                    <select class="form-select" name="cidade_origem" id="cidade_origem" required>
                                        <option value="">Selecione UF</option>
                                    </select>
                                </div>
                                <div class="col-md-1 mb-3">
                                    <label class="form-label">UF Dest.</label>
                                    <select class="form-select" name="uf_destino" id="uf_destino" required>
                                        <option value="">...</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Cidade Destino</label>
                                    <select class="form-select" name="cidade_destino" id="cidade_destino" required>
                                        <option value="">Selecione UF</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Observacoes</label>
                                    <input type="text" class="form-control" name="observacoes" placeholder="Opcional">
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="criarFrete()">
                                <span class="spinner-border spinner-border-sm d-none" id="spinner-frete"></span>
                                Criar Cotacao
                            </button>
                        </form>
                        <div id="feedback-frete" class="alert d-none mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Lista de Fretes -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Cotacoes de Frete</h6>
                </div>
                <div class="card-body">
                    <div id="lista-fretes">
                        {% if fretes %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Transportadora</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>Rota</th>
                                        <th>Data Cotacao</th>
                                        <th>Acoes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for frete in fretes %}
                                    <tr id="frete-row-{{ frete.id }}">
                                        <td>{{ frete.transportadora_nome }}</td>
                                        <td>R$ {{ "%.2f"|format(frete.valor_cotado) }}</td>
                                        <td>
                                            <select class="form-select form-select-sm status-frete" data-frete-id="{{ frete.id }}" style="width: auto;">
                                                <option value="COTADO" {% if frete.status == 'COTADO' %}selected{% endif %}>Cotado</option>
                                                <option value="APROVADO" {% if frete.status == 'APROVADO' %}selected{% endif %}>Aprovado</option>
                                                <option value="COLETADO" {% if frete.status == 'COLETADO' %}selected{% endif %}>Coletado</option>
                                                <option value="ENTREGUE" {% if frete.status == 'ENTREGUE' %}selected{% endif %}>Entregue</option>
                                                <option value="CANCELADO" {% if frete.status == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                                            </select>
                                        </td>
                                        <td>
                                            {% if frete.local_coleta %}<small class="text-muted">{{ frete.local_coleta }}</small><br>{% endif %}
                                            {{ frete.cidade_origem }}/{{ frete.uf_origem }} â†’ {{ frete.cidade_destino }}/{{ frete.uf_destino }}
                                        </td>
                                        <td>{{ frete.data_cotacao.strftime('%d/%m/%Y') if frete.data_cotacao else '-' }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="excluirFrete({{ frete.id }})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center mb-0">Nenhuma cotacao de frete registrada</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA PRODUTOS -->
        <div class="tab-pane fade" id="produtos" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0 d-inline">Produtos da NFD</h6>
                        {% if linhas %}
                        <span class="badge bg-success ms-2">{{ linhas|selectattr('produto_resolvido')|list|length }} resolvidas</span>
                        <span class="badge bg-warning">{{ linhas|rejectattr('produto_resolvido')|list|length }} pendentes</span>
                        {% endif %}
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-info" id="btn-comparar-nf" onclick="toggleComparacaoNF()">
                            <i class="bi bi-arrow-left-right"></i> Comparar com NF de venda
                        </button>
                        <button type="button" class="btn btn-sm btn-info" onclick="resolverTodosComIA()">
                            <i class="bi bi-cpu"></i> Resolver Produtos
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Tabela de Produtos NFD -->
                    <div id="tabela-produtos-nfd">
                        {% if linhas %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Produto Cliente</th>
                                        <th>Qtd NFD</th>
                                        <th>Nosso Codigo</th>
                                        <th>Qtd Conv.</th>
                                        <th class="text-end">Valor</th>
                                        <th class="text-end">Peso (kg)</th>
                                        <th>Status</th>
                                        <th>Acoes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set ns = namespace(total_valor=0, total_peso=0) %}
                                    {% for linha in linhas %}
                                    {% set valor_linha = (linha.valor_unitario or 0) * (linha.quantidade or 0) %}
                                    {% set ns.total_valor = ns.total_valor + valor_linha %}
                                    {% set ns.total_peso = ns.total_peso + (linha.peso_bruto or 0) %}
                                    <tr id="prod-linha-{{ linha.id }}" class="{{ 'table-success' if linha.produto_resolvido else '' }}">
                                        <td>{{ linha.numero_item or loop.index }}</td>
                                        <td>
                                            <code>{{ linha.codigo_produto_cliente or '-' }}</code>
                                            <br><small class="text-muted">{{ linha.descricao_produto_cliente or '-' }}</small>
                                        </td>
                                        <td>{{ linha.quantidade }} {{ linha.unidade_medida }}</td>
                                        <td id="prod-nosso-{{ linha.id }}">
                                            {% if linha.codigo_produto_interno %}
                                            <strong class="text-primary">{{ linha.codigo_produto_interno }}</strong>
                                            <br><small class="text-muted">{{ linha.descricao_produto_interno or '' }}</small>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td id="prod-qtd-{{ linha.id }}">
                                            {% if linha.quantidade_convertida %}
                                            <span class="badge bg-success">{{ "%.2f"|format(linha.quantidade_convertida|float) }} cx</span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end" id="prod-valor-{{ linha.id }}">
                                            {% if linha.valor_unitario %}
                                            R$ {{ "%.2f"|format(valor_linha) }}
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end" id="prod-peso-{{ linha.id }}">
                                            {% if linha.peso_bruto %}
                                            {{ "%.2f"|format(linha.peso_bruto|float) }}
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td id="prod-status-{{ linha.id }}">
                                            {% if linha.produto_resolvido %}
                                            <span class="badge bg-success">Resolvido</span>
                                            {% else %}
                                            <span class="badge bg-warning">Pendente</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if not linha.produto_resolvido %}
                                            <button class="btn btn-sm btn-outline-info py-0 px-2"
                                                    onclick="abrirModalResolverProduto({{ linha.id }}, '{{ linha.codigo_produto_cliente|e }}', '{{ linha.descricao_produto_cliente|e }}', {{ linha.quantidade|default(0) }}, '{{ linha.unidade_medida|default('')|e }}')"
                                                    title="Resolver com IA">
                                                <i class="bi bi-magic"></i> Resolver
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-primary py-0 px-2 btn-editar-produto"
                                                    data-linha-id="{{ linha.id }}"
                                                    data-codigo-cliente="{{ linha.codigo_produto_cliente|default('', true) }}"
                                                    data-descricao-cliente="{{ linha.descricao_produto_cliente|default('', true) }}"
                                                    data-quantidade="{{ linha.quantidade|default(0) }}"
                                                    data-unidade="{{ linha.unidade_medida|default('', true) }}"
                                                    data-codigo-interno="{{ linha.codigo_produto_interno|default('', true) }}"
                                                    data-descricao-interna="{{ linha.descricao_produto_interno|default('', true) }}"
                                                    data-qtd-convertida="{{ linha.quantidade_convertida|default('', true) }}"
                                                    data-fator-conversao="{{ linha.qtd_por_caixa|default('', true) }}"
                                                    title="Editar produto">
                                                <i class="bi bi-pencil"></i> Editar
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="5" class="text-end"><strong>Total:</strong></td>
                                        <td class="text-end"><strong>R$ {{ "%.2f"|format(ns.total_valor) }}</strong></td>
                                        <td class="text-end"><strong>{{ "%.2f"|format(ns.total_peso) }} kg</strong></td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center my-4">Nenhum produto na NFD</p>
                        {% endif %}
                    </div>

                    <!-- Tabela de Comparacao com NF de Venda (oculta inicialmente) -->
                    <div id="tabela-comparacao-nf" class="d-none">
                        <div class="alert alert-info m-3 mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Comparando produtos da NFD com as NFs de venda referenciadas
                        </div>
                        <div id="loading-comparacao" class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-2">Buscando dados das NFs de venda...</p>
                        </div>
                        <div id="resultado-comparacao" class="d-none">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 80px;">Codigo</th>
                                            <th style="width: 35%;">Descricao</th>
                                            <th style="width: 100px;" class="text-end">Qtd Vendida</th>
                                            <th style="width: 100px;" class="text-end">Qtd Devolvida</th>
                                            <th style="width: 80px;" class="text-end">% Devol.</th>
                                            <th style="width: 100px;" class="text-end">Preco Venda</th>
                                            <th style="width: 100px;" class="text-end">Preco Devol.</th>
                                            <th style="width: 100px;" class="text-end">Valor Devol.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-comparacao"></tbody>
                                    <tfoot class="table-light" id="tfoot-comparacao"></tfoot>
                                </table>
                            </div>
                            <div id="nfs-nao-encontradas" class="alert alert-warning m-3 d-none">
                                <strong>NFs de venda nao encontradas no sistema:</strong>
                                <span id="lista-nfs-nao-encontradas"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA DESCARTE -->
        <div class="tab-pane fade" id="descarte" role="tabpanel">
            <!-- Formulario de Novo Descarte -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center"
                     data-bs-toggle="collapse" data-bs-target="#form-descarte-collapse"
                     style="cursor: pointer;" role="button">
                    <h6 class="mb-0"><i class="bi bi-plus-lg me-2"></i>Autorizar Descarte</h6>
                    <i class="bi bi-chevron-down collapse-icon"></i>
                </div>
                <div class="collapse" id="form-descarte-collapse">
                    <div class="card-body">
                        <form id="form-novo-descarte">
                            <!-- Empresa Autorizada a Descartar (obrigatorio para compliance) -->
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong>Importante:</strong> Informe a empresa autorizada a realizar o descarte antes de gerar o termo.
                            </div>
                            <div class="row">
                                <div class="col-md-5 mb-3">
                                    <label class="form-label">Empresa Autorizada <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="empresa_autorizada_nome" placeholder="Razao Social da empresa" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">CNPJ/CPF <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="empresa_autorizada_documento" placeholder="00.000.000/0000-00" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Tipo</label>
                                    <select class="form-select" name="empresa_autorizada_tipo">
                                        <option value="TRANSPORTADOR">Transportador</option>
                                        <option value="CLIENTE">Cliente</option>
                                    </select>
                                </div>
                            </div>
                            <hr class="my-3">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Motivo do Descarte <span class="text-danger">*</span></label>
                                    <select class="form-select" name="motivo_descarte" required>
                                        <option value="">Selecione...</option>
                                        <option value="CUSTO_ALTO">Custo de frete maior que valor da mercadoria</option>
                                        <option value="PERECIVEIS">Produtos pereciveis/vencidos</option>
                                        <option value="AVARIA_TOTAL">Avaria total - sem condicoes de retorno</option>
                                        <option value="CONTAMINACAO">Contaminacao/risco sanitario</option>
                                        <option value="CLIENTE_SOLICITOU">Cliente solicitou o descarte</option>
                                        <option value="OUTROS">Outros</option>
                                    </select>
                                    <small class="text-muted">Para controle interno (nao aparece no termo)</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Valor Total da Mercadoria</label>
                                    <input type="number" step="0.01" class="form-control" name="valor_mercadoria" id="valor_mercadoria_descarte" placeholder="R$ 0.00" readonly>
                                    <small class="text-muted">Calculado automaticamente dos itens</small>
                                </div>
                            </div>

                            <!-- Itens da NFD para Descarte -->
                            {% if linhas %}
                            <div class="mb-3">
                                <label class="form-label"><strong>Itens para Descarte</strong></label>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 30%;">Produto</th>
                                                <th class="text-center" style="width: 10%;">Qtd NFD</th>
                                                <th class="text-end" style="width: 12%;">Valor NFD</th>
                                                <th class="text-center" style="width: 15%;">Qtd Descarte (un)</th>
                                                <th class="text-center" style="width: 15%;">Qtd Descarte (cx)</th>
                                                <th class="text-end" style="width: 18%;">Valor Descarte</th>
                                            </tr>
                                        </thead>
                                        <tbody id="itens-descarte">
                                            {% for linha in linhas %}
                                            <tr data-linha-id="{{ linha.id }}"
                                                data-qtd-por-caixa="{{ linha.qtd_por_caixa or 1 }}"
                                                data-valor-unitario="{{ linha.valor_unitario or 0 }}"
                                                data-qtd-original="{{ linha.quantidade or 0 }}">
                                                <td>
                                                    <small class="text-muted">{{ linha.codigo_produto_interno or linha.codigo_produto_cliente or '-' }}</small><br>
                                                    {{ linha.descricao_produto_interno or linha.descricao_produto_cliente or 'Produto nao resolvido' }}
                                                </td>
                                                <td class="text-center">{{ "%.0f"|format(linha.quantidade or 0) }} {{ linha.unidade_medida or 'UN' }}</td>
                                                <td class="text-end">R$ {{ "%.2f"|format(linha.valor_total or 0) }}</td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm text-center qtd-un-descarte"
                                                           value="{{ linha.quantidade|int }}" step="1" min="0"
                                                           onchange="atualizarQtdDescarte(this, 'un')">
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm text-center qtd-cx-descarte"
                                                           value="{{ ((linha.quantidade or 0) / (linha.qtd_por_caixa or 1))|round(2) }}" step="0.01" min="0"
                                                           onchange="atualizarQtdDescarte(this, 'cx')">
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm text-end valor-descarte-linha"
                                                           value="{{ linha.valor_total or 0 }}" step="0.01" readonly>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr class="border-top-2">
                                                <td colspan="5" class="text-end"><strong class="text-body">TOTAL:</strong></td>
                                                <td class="text-end"><strong id="total-valor-descarte" class="text-body">R$ 0.00</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> Nenhum item de produto encontrado na NFD.
                            </div>
                            {% endif %}

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Descricao do Motivo</label>
                                    <textarea class="form-control" name="descricao_motivo" rows="2" placeholder="Detalhe o motivo do descarte..."></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="tem-custo-descarte" name="tem_custo">
                                        <label class="form-check-label" for="tem-custo-descarte">
                                            Tem custo de descarte?
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3 custo-descarte-fields d-none">
                                    <label class="form-label">Valor do Descarte</label>
                                    <input type="number" step="0.01" class="form-control" name="valor_descarte" placeholder="R$ 0.00">
                                </div>
                                <div class="col-md-6 mb-3 custo-descarte-fields d-none">
                                    <label class="form-label">Fornecedor do Descarte</label>
                                    <input type="text" class="form-control" name="fornecedor_descarte" placeholder="Empresa de descarte">
                                </div>
                            </div>
                            <button type="button" class="btn btn-warning" onclick="criarDescarte()">
                                <span class="spinner-border spinner-border-sm d-none" id="spinner-descarte"></span>
                                Autorizar Descarte
                            </button>
                        </form>
                        <div id="feedback-descarte" class="alert d-none mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Lista de Descartes -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Descartes Autorizados</h6>
                </div>
                <div class="card-body">
                    <div id="lista-descartes">
                        {% if descartes %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Termo</th>
                                        <th>Empresa Autorizada</th>
                                        <th>Valor Merc.</th>
                                        <th>Status</th>
                                        <th>Autorizado em</th>
                                        <th>Documentos</th>
                                        <th>Acoes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for desc in descartes %}
                                    <tr id="descarte-row-{{ desc.id }}">
                                        <td>{{ desc.numero_termo or '-' }}</td>
                                        <td>
                                            {% if desc.empresa_autorizada_nome %}
                                            <strong>{{ desc.empresa_autorizada_nome }}</strong><br>
                                            <small class="text-muted">{{ desc.empresa_autorizada_documento or '-' }}</small>
                                            <span class="badge bg-info">{{ 'Transp.' if desc.empresa_autorizada_tipo == 'TRANSPORTADOR' else 'Cliente' }}</span>
                                            {% else %}
                                            <span class="text-warning"><i class="bi bi-exclamation-triangle"></i> Nao informada</span>
                                            {% endif %}
                                        </td>
                                        <td>{% if desc.valor_mercadoria %}R$ {{ "%.2f"|format(desc.valor_mercadoria) }}{% else %}-{% endif %}</td>
                                        <td>
                                            <select class="form-select form-select-sm status-descarte" data-descarte-id="{{ desc.id }}" style="width: auto;">
                                                <option value="AUTORIZADO" {% if desc.status == 'AUTORIZADO' %}selected{% endif %}>Autorizado</option>
                                                <option value="TERMO_ENVIADO" {% if desc.status == 'TERMO_ENVIADO' %}selected{% endif %}>Termo Enviado</option>
                                                <option value="TERMO_RETORNADO" {% if desc.status == 'TERMO_RETORNADO' %}selected{% endif %}>Termo Retornado</option>
                                                <option value="DESCARTADO" {% if desc.status == 'DESCARTADO' %}selected{% endif %}>Descartado</option>
                                                <option value="CANCELADO" {% if desc.status == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                                            </select>
                                        </td>
                                        <td>{{ desc.data_autorizacao.strftime('%d/%m/%Y') if desc.data_autorizacao else '-' }}</td>
                                        <td>
                                            <div class="btn-group-vertical btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadTermoDescarte({{ desc.id }})" title="Baixar termo">
                                                    <i class="bi bi-download"></i> Download
                                                </button>
                                                <button type="button" class="btn btn-outline-info btn-sm" onclick="imprimirTermoDescarte({{ desc.id }})" title="Imprimir termo">
                                                    <i class="bi bi-printer"></i> Imprimir
                                                </button>
                                                <button type="button" class="btn btn-outline-success btn-sm" onclick="uploadTermoDescarte({{ desc.id }}, 'termo_assinado')" title="Importar termo assinado">
                                                    <i class="bi bi-upload"></i> Importar
                                                    {% if desc.termo_assinado_path %}<span class="badge bg-success ms-1">OK</span>{% endif %}
                                                </button>
                                            </div>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="excluirDescarte({{ desc.id }})" title="Excluir descarte">
                                                <i class="bi bi-trash"></i>Excluir Descarte
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center mb-0">Nenhum descarte autorizado</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Resolver Todos com IA -->
<div class="modal fade" id="modal-resolver-todos" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resolver Todas as Linhas com IA</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" id="btn-fechar-resolver-todos"></button>
            </div>
            <div class="modal-body">
                <!-- Loading -->
                <div id="resolver-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                    <p class="mt-3">Consultando IA para todas as linhas pendentes...</p>
                    <p class="text-muted small">Isso pode levar alguns segundos</p>
                </div>
                <!-- Resultado -->
                <div id="resolver-resultado" class="d-none">
                    <!-- Resumo -->
                    <div class="alert alert-info mb-3" id="resolver-resumo"></div>
                    <!-- Opcoes -->
                    <div class="mb-2 d-flex justify-content-between align-items-center">
                        <div>
                            <input type="checkbox" id="resolver-selecionar-todos" class="form-check-input me-1" onchange="toggleSelecionarTodosResolver()">
                            <label for="resolver-selecionar-todos" class="form-check-label small">Selecionar todos</label>
                        </div>
                        <div>
                            <input type="checkbox" id="resolver-gravar-depara" class="form-check-input me-1" checked>
                            <label for="resolver-gravar-depara" class="form-check-label small">Gravar De-Para</label>
                        </div>
                    </div>
                    <!-- Tabela de resultados -->
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 30px;"></th>
                                    <th>Produto Cliente</th>
                                    <th>Nosso Produto</th>
                                    <th class="text-center">Qtd NFD</th>
                                    <th class="text-center">Conversao</th>
                                    <th class="text-center">Confianca</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="resolver-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Aplicando -->
                <div id="resolver-aplicando" class="d-none text-center py-5">
                    <div class="spinner-border text-success" style="width: 3rem; height: 3rem;"></div>
                    <p class="mt-3">Aplicando resolucoes...</p>
                    <p class="text-muted small" id="resolver-aplicando-progresso">0/0</p>
                </div>
            </div>
            <div class="modal-footer d-none" id="resolver-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" id="btn-aplicar-resolucoes" onclick="aplicarResolucoesSelecionadas()">
                    <i class="bi bi-check-circle"></i> Aplicar Selecionadas (<span id="count-selecionadas">0</span>)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Upload Termo Descarte -->
<div class="modal fade" id="modal-upload-termo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload de Documento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-upload-termo" enctype="multipart/form-data">
                    <input type="hidden" id="upload-descarte-id" name="descarte_id">
                    <input type="hidden" id="upload-tipo-documento" name="tipo_documento">
                    <div class="mb-3">
                        <label class="form-label">Arquivo</label>
                        <input type="file" class="form-control" name="arquivo" id="arquivo-termo" required>
                        <small class="text-muted">PDF, imagem ou documento</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="enviarTermoDescarte()">
                    <span class="spinner-border spinner-border-sm d-none" id="spinner-upload-termo"></span>
                    Enviar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar NFs de Venda -->
<div class="modal fade" id="modal-editar-nfs" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar NFs de Venda Referenciadas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Lista de NFs existentes -->
                <div class="mb-3">
                    <label class="form-label fw-bold">NFs Vinculadas:</label>
                    <div id="lista-nfs-modal">
                        <span class="text-muted">Carregando...</span>
                    </div>
                </div>

                <hr>

                <!-- FormulÃ¡rio para adicionar nova NF -->
                <h6>Adicionar Nova NF de Venda</h6>
                <form id="form-adicionar-nf">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">NÃºmero NF *</label>
                            <input type="text" class="form-control" id="nova-nf-numero" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">SÃ©rie</label>
                            <input type="text" class="form-control" id="nova-nf-serie" value="1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Chave de Acesso (44 dÃ­gitos)</label>
                        <input type="text" class="form-control" id="nova-nf-chave" maxlength="44" pattern="[0-9]{44}" placeholder="Opcional">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="adicionarNF()">
                    <span class="spinner-border spinner-border-sm d-none" id="spinner-add-nf"></span>
                    Adicionar NF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Resolver/Editar Produto -->
<div class="modal fade" id="modal-produto" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-produto-titulo">Resolver Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Info do produto do cliente -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Produto do Cliente:</label>
                    <div id="modal-produto-cliente-info" class="alert alert-light"></div>
                </div>

                <!-- Sugestoes da IA (apenas no modo resolver) -->
                <div id="modal-sugestoes-ia" class="mb-3 d-none">
                    <label class="form-label fw-bold">Sugestoes da IA:</label>
                    <div id="modal-sugestoes-lista">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm"></div>
                            <span class="ms-2">Consultando IA...</span>
                        </div>
                    </div>
                </div>

                <hr>

                <!-- Formulario de edicao -->
                <form id="form-produto">
                    <input type="hidden" id="prod-linha-id">
                    <div class="row">
                        <div class="col-md-5 mb-3">
                            <label class="form-label">Nosso Codigo *</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="prod-nosso-codigo"
                                       placeholder="Digite codigo ou nome..."
                                       autocomplete="off" oninput="buscarProdutosAba(this.value)">
                                <div id="autocomplete-produtos-aba" class="dropdown-menu w-100" style="max-height: 250px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        <div class="col-md-7 mb-3">
                            <label class="form-label">Descricao</label>
                            <input type="text" class="form-control" id="prod-nosso-descricao" readonly>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Qtd Original</label>
                            <input type="text" class="form-control" id="prod-qtd-original" readonly>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Fator Conversao</label>
                            <input type="number" step="0.01" class="form-control" id="prod-fator-conversao"
                                   placeholder="Ex: 12" onchange="calcularQtdConvertida()">
                            <small class="text-muted">UN/CX</small>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Qtd Convertida</label>
                            <input type="number" step="0.01" class="form-control" id="prod-qtd-convertida"
                                   placeholder="Caixas" readonly>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Peso (kg)</label>
                            <input type="number" step="0.01" class="form-control" id="prod-peso" readonly>
                        </div>
                    </div>
                    <div id="prod-info-extra" class="alert alert-light d-none">
                        <small>
                            <strong>Embalagem:</strong> <span id="prod-info-embalagem">-</span> |
                            <strong>Materia:</strong> <span id="prod-info-materia">-</span> |
                            <strong>Peso/CX:</strong> <span id="prod-info-peso-cx">-</span> kg
                        </small>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="prod-gravar-depara" checked>
                        <label class="form-check-label" for="prod-gravar-depara">
                            Gravar no De-Para para uso futuro
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarProduto()">
                    <span class="spinner-border spinner-border-sm d-none" id="spinner-salvar-prod"></span>
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilo para Ã­cone de collapse rotacionar quando aberto */
.collapse-icon {
    transition: transform 0.2s ease;
}
[data-bs-toggle="collapse"][aria-expanded="true"] .collapse-icon,
[data-bs-toggle="collapse"]:not(.collapsed) .collapse-icon {
    transform: rotate(180deg);
}
/* Destacar header ao passar o mouse - usa variavel do tema */
.card-header[role="button"]:hover {
    background-color: var(--bg-light);
}
</style>

<script>
const ocorrenciaId = {{ ocorrencia.id }};
const nfdId = {{ nfd.id }};

// Valores pre-definidos da origem (cliente/emitente da NFD)
const ufOrigemPreset = '{{ entrega.uf if entrega and entrega.uf else (nfd.uf_emitente if nfd and nfd.uf_emitente else "") }}';
const cidadeOrigemPreset = '{{ entrega.municipio if entrega and entrega.municipio else (nfd.municipio_emitente if nfd and nfd.municipio_emitente else "") }}';

// =========================================================================
// Carregar Dados ao Iniciar
// =========================================================================
document.addEventListener('DOMContentLoaded', function() {
    carregarTransportadoras();
    carregarUFs();
    // Calcular peso automaticamente (silencioso)
    calcularPesoAuto();
    // Inicializar tooltips do Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });
});

// =========================================================================
// Carregar UFs e Cidades
// =========================================================================
async function carregarUFs() {
    try {
        const response = await fetch('/devolucao/frete/api/ufs');
        const result = await response.json();

        if (result.sucesso) {
            const selectOrigem = document.getElementById('uf_origem');
            const selectDestino = document.getElementById('uf_destino');

            // Preencher UF Origem
            selectOrigem.innerHTML = '<option value="">UF</option>';
            result.ufs.forEach(uf => {
                const option = document.createElement('option');
                option.value = uf;
                option.textContent = uf;
                if (uf === ufOrigemPreset) option.selected = true;
                selectOrigem.appendChild(option);
            });

            // Preencher UF Destino (pre-selecionar SP - CD Nacom)
            selectDestino.innerHTML = '<option value="">UF</option>';
            result.ufs.forEach(uf => {
                const option = document.createElement('option');
                option.value = uf;
                option.textContent = uf;
                if (uf === 'SP') option.selected = true;
                selectDestino.appendChild(option);
            });

            // Carregar cidades se UFs pre-selecionados
            if (ufOrigemPreset) {
                await carregarCidades('uf_origem', 'cidade_origem', cidadeOrigemPreset);
            }
            await carregarCidades('uf_destino', 'cidade_destino', 'Santana de Parnaiba');

            // Event listeners para mudanca de UF
            selectOrigem.addEventListener('change', function() {
                carregarCidades('uf_origem', 'cidade_origem');
            });

            selectDestino.addEventListener('change', function() {
                carregarCidades('uf_destino', 'cidade_destino');
            });
        }
    } catch (error) {
        console.error('Erro ao carregar UFs:', error);
    }
}

async function carregarCidades(ufSelectId, cidadeSelectId, cidadePreset = null) {
    const ufSelect = document.getElementById(ufSelectId);
    const cidadeSelect = document.getElementById(cidadeSelectId);
    const uf = ufSelect.value;

    if (!uf) {
        cidadeSelect.innerHTML = '<option value="">Selecione UF</option>';
        return;
    }

    try {
        cidadeSelect.innerHTML = '<option value="">Carregando...</option>';

        const response = await fetch(`/devolucao/frete/api/cidades/${uf}`);
        const result = await response.json();

        if (result.sucesso) {
            cidadeSelect.innerHTML = '<option value="">Selecione...</option>';
            result.cidades.forEach(cidade => {
                const option = document.createElement('option');
                option.value = cidade.nome;
                option.textContent = cidade.nome;
                // Pre-selecionar cidade se corresponder (ignorando acentos)
                if (cidadePreset && normalizeStr(cidade.nome) === normalizeStr(cidadePreset)) {
                    option.selected = true;
                }
                cidadeSelect.appendChild(option);
            });
        } else {
            cidadeSelect.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    } catch (error) {
        console.error('Erro ao carregar cidades:', error);
        cidadeSelect.innerHTML = '<option value="">Erro ao carregar</option>';
    }
}

function normalizeStr(str) {
    if (!str) return '';
    return str.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .trim();
}

// =========================================================================
// Carregar Transportadoras no Select
// =========================================================================

async function carregarTransportadoras() {
    const select = document.getElementById('select-transportadora');
    if (!select) return;

    try {
        const response = await fetch('/devolucao/frete/api/transportadoras');
        const result = await response.json();

        if (result.sucesso) {
            select.innerHTML = '<option value="">Selecione...</option>';
            result.transportadoras.forEach(t => {
                const option = document.createElement('option');
                option.value = t.nome;
                option.dataset.id = t.id;
                option.dataset.cidade = t.cidade;
                option.dataset.uf = t.uf;
                option.textContent = `${t.nome} (${t.cidade}/${t.uf})`;
                select.appendChild(option);
            });

            // Ao selecionar, atualiza o campo hidden com o ID e habilita botao estimar
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const transportadoraId = selectedOption.dataset.id || '';
                document.getElementById('transportadora_id').value = transportadoraId;

                // Habilitar/desabilitar botao estimar
                const btnEstimar = document.getElementById('btn-estimar-retorno');
                if (transportadoraId) {
                    btnEstimar.disabled = false;
                    btnEstimar.title = 'Estimar frete de retorno';
                } else {
                    btnEstimar.disabled = true;
                    btnEstimar.title = 'Selecione uma transportadora';
                }
            });
        } else {
            select.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    } catch (error) {
        console.error('Erro ao carregar transportadoras:', error);
        select.innerHTML = '<option value="">Erro ao carregar</option>';
    }
}

// =========================================================================
// Calcular Peso Automaticamente (com alert de detalhes)
// =========================================================================
async function calcularPeso() {
    const pesoInput = document.getElementById('peso_kg');

    try {
        const response = await fetch(`/devolucao/frete/api/${ocorrenciaId}/calcular-peso`);
        const result = await response.json();

        if (result.sucesso) {
            pesoInput.value = result.peso_total.toFixed(3);

            // Mostrar detalhes em um alert se tiver mais de um produto
            if (result.detalhes && result.detalhes.length > 0) {
                let mensagem = `Peso total: ${result.peso_total.toFixed(3)} kg\n\nDetalhes:\n`;
                result.detalhes.forEach(d => {
                    mensagem += `- ${d.codigo}: ${d.quantidade} x ${d.peso_unitario.toFixed(3)} = ${d.peso_total.toFixed(3)} kg`;
                    if (!d.cadastro_encontrado) {
                        mensagem += ' (sem cadastro)';
                    }
                    mensagem += '\n';
                });
                alert(mensagem);
            }
        } else {
            alert(result.erro || 'Erro ao calcular peso');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao calcular peso. Verifique se os produtos estao resolvidos.');
    }
}

// =========================================================================
// Calcular Peso Automatico (silencioso - sem alert)
// =========================================================================
async function calcularPesoAuto() {
    const pesoInput = document.getElementById('peso_kg');

    try {
        const response = await fetch(`/devolucao/frete/api/${ocorrenciaId}/calcular-peso`);
        const result = await response.json();

        if (result.sucesso && result.peso_total > 0) {
            pesoInput.value = result.peso_total.toFixed(3);
            console.log(`[Peso Auto] Peso calculado: ${result.peso_total.toFixed(3)} kg`);
        }
    } catch (error) {
        console.log('[Peso Auto] Erro ao calcular peso automaticamente:', error);
    }
}

// =========================================================================
// Estimar Frete de Retorno (50%)
// =========================================================================
async function estimarFreteRetorno() {
    const transportadoraId = document.getElementById('transportadora_id').value;
    const ufOrigem = document.getElementById('uf_origem').value;
    const btnEstimar = document.getElementById('btn-estimar-retorno');
    const infoEstimativa = document.getElementById('info-estimativa');
    const valorCotado = document.getElementById('valor_cotado');
    const pesoKg = document.getElementById('peso_kg');

    if (!transportadoraId) {
        alert('Selecione uma transportadora');
        return;
    }

    if (!ufOrigem) {
        alert('Selecione a UF de origem');
        return;
    }

    // Desabilitar botao durante requisicao
    const textoOriginal = btnEstimar.innerHTML;
    btnEstimar.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btnEstimar.disabled = true;

    try {
        const response = await fetch(`/devolucao/frete/api/${ocorrenciaId}/estimar-retorno`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
            },
            body: JSON.stringify({
                transportadora_id: parseInt(transportadoraId),
                uf_origem: ufOrigem
            })
        });

        const result = await response.json();

        if (result.sucesso) {
            // Preencher valor cotado
            valorCotado.value = result.valor_estimado.toFixed(2);

            // Preencher peso se estiver vazio
            if (!pesoKg.value || pesoKg.value === '0') {
                pesoKg.value = result.peso_kg.toFixed(3);
            }

            // Mostrar info de % NF e R$/KG
            infoEstimativa.innerHTML = `<i class="bi bi-info-circle"></i> ${result.percentual_nf.toFixed(1)}% NF | R$ ${result.valor_por_kg.toFixed(2)}/kg`;
            infoEstimativa.classList.remove('d-none');
            infoEstimativa.classList.add('text-success');

            // Alert com detalhes
            alert(`Estimativa de Frete de Retorno (50%):\n\n` +
                  `Transportadora: ${result.transportadora}\n` +
                  `Tabela: ${result.tabela}\n` +
                  `Rota: ${result.rota}\n\n` +
                  `Peso: ${result.peso_kg.toFixed(3)} kg\n` +
                  `Valor NF: R$ ${result.valor_nf.toFixed(2)}\n\n` +
                  `Frete Integral: R$ ${result.valor_integral.toFixed(2)}\n` +
                  `Frete Retorno (${result.desconto}): R$ ${result.valor_estimado.toFixed(2)}\n\n` +
                  `% sobre NF: ${result.percentual_nf.toFixed(2)}%\n` +
                  `R$/kg: R$ ${result.valor_por_kg.toFixed(2)}`);
        } else {
            alert(result.erro || 'Erro ao estimar frete');
            infoEstimativa.classList.add('d-none');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao estimar frete. Tente novamente.');
    } finally {
        // Restaurar botao
        btnEstimar.innerHTML = textoOriginal;
        btnEstimar.disabled = false;
    }
}

function salvarLogistica() {
    const form = document.getElementById('form-logistica');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    fetch(`/devolucao/ocorrencias/api/${ocorrenciaId}/logistica`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        const feedback = document.getElementById('feedback-logistica');
        if (result.sucesso) {
            feedback.className = 'alert alert-success';
            feedback.textContent = result.mensagem || 'Salvo com sucesso';
        } else {
            feedback.className = 'alert alert-danger';
            feedback.textContent = result.erro || 'Erro ao salvar';
        }
        feedback.classList.remove('d-none');
        setTimeout(() => feedback.classList.add('d-none'), 3000);
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar. Tente novamente.');
    });
}

function salvarComercial() {
    const form = document.getElementById('form-comercial');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    fetch(`/devolucao/ocorrencias/api/${ocorrenciaId}/comercial`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        const feedback = document.getElementById('feedback-comercial');
        if (result.sucesso) {
            feedback.className = 'alert alert-success';
            feedback.textContent = result.mensagem || 'Salvo com sucesso';
        } else {
            feedback.className = 'alert alert-danger';
            feedback.textContent = result.erro || 'Erro ao salvar';
        }
        feedback.classList.remove('d-none');
        setTimeout(() => feedback.classList.add('d-none'), 3000);
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar. Tente novamente.');
    });
}

// =========================================================================
// Funcoes de Anexos
// =========================================================================

function uploadAnexo() {
    const form = document.getElementById('form-upload-anexo');
    const fileInput = document.getElementById('arquivo-anexo');
    const spinner = document.getElementById('spinner-upload');
    const feedback = document.getElementById('feedback-anexo');

    if (!fileInput.files.length) {
        feedback.className = 'alert alert-warning';
        feedback.textContent = 'Selecione um arquivo';
        feedback.classList.remove('d-none');
        return;
    }

    const formData = new FormData(form);

    // Mostrar loading
    spinner.classList.remove('d-none');
    feedback.classList.add('d-none');

    fetch(`/devolucao/ocorrencias/api/${ocorrenciaId}/anexos`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            feedback.className = 'alert alert-success';
            feedback.textContent = result.mensagem || 'Anexo enviado com sucesso';
            feedback.classList.remove('d-none');

            // Limpar formulario
            form.reset();

            // Recarregar pagina para mostrar novo anexo
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            feedback.className = 'alert alert-danger';
            feedback.textContent = result.erro || 'Erro ao enviar anexo';
            feedback.classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        feedback.className = 'alert alert-danger';
        feedback.textContent = 'Erro de conexao. Tente novamente.';
        feedback.classList.remove('d-none');
    })
    .finally(() => {
        spinner.classList.add('d-none');
    });
}

function excluirAnexo(anexoId, nomeAnexo) {
    if (!confirm(`Deseja excluir o anexo "${nomeAnexo}"?`)) {
        return;
    }

    fetch(`/devolucao/ocorrencias/api/${ocorrenciaId}/anexos/${anexoId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            // Remover linha da tabela
            const row = document.getElementById(`anexo-row-${anexoId}`);
            if (row) {
                row.remove();
            }

            // Feedback
            const feedback = document.getElementById('feedback-anexo');
            if (feedback) {
                feedback.className = 'alert alert-success';
                feedback.textContent = result.mensagem || 'Anexo excluido';
                feedback.classList.remove('d-none');
                setTimeout(() => feedback.classList.add('d-none'), 3000);
            }
        } else {
            alert(result.erro || 'Erro ao excluir anexo');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    });
}

// =========================================================================
// Funcoes de Frete
// =========================================================================

function criarFrete() {
    const form = document.getElementById('form-novo-frete');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    const spinner = document.getElementById('spinner-frete');
    const feedback = document.getElementById('feedback-frete');

    // Validar campos obrigatorios
    if (!data.transportadora_nome || !data.valor_cotado) {
        feedback.className = 'alert alert-warning';
        feedback.textContent = 'Preencha a transportadora e o valor cotado';
        feedback.classList.remove('d-none');
        return;
    }

    // Adicionar transportadora_id
    data.transportadora_id = document.getElementById('transportadora_id').value || null;

    spinner.classList.remove('d-none');
    feedback.classList.add('d-none');

    fetch(`/devolucao/frete/api/${ocorrenciaId}/fretes`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            feedback.className = 'alert alert-success';
            feedback.textContent = result.mensagem || 'Cotacao criada com sucesso';
            feedback.classList.remove('d-none');
            form.reset();
            setTimeout(() => location.reload(), 1000);
        } else {
            feedback.className = 'alert alert-danger';
            feedback.textContent = result.erro || 'Erro ao criar cotacao';
            feedback.classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        feedback.className = 'alert alert-danger';
        feedback.textContent = 'Erro de conexao. Tente novamente.';
        feedback.classList.remove('d-none');
    })
    .finally(() => {
        spinner.classList.add('d-none');
    });
}

function excluirFrete(freteId) {
    if (!confirm('Deseja excluir esta cotacao de frete?')) {
        return;
    }

    fetch(`/devolucao/frete/api/frete/${freteId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            const row = document.getElementById(`frete-row-${freteId}`);
            if (row) row.remove();
        } else {
            alert(result.erro || 'Erro ao excluir frete');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    });
}

// Event listeners para status do frete
document.querySelectorAll('.status-frete').forEach(select => {
    select.addEventListener('change', function() {
        const freteId = this.dataset.freteId;
        const novoStatus = this.value;

        fetch(`/devolucao/frete/api/frete/${freteId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
            },
            body: JSON.stringify({ status: novoStatus })
        })
        .then(response => response.json())
        .then(result => {
            if (!result.sucesso) {
                alert(result.erro || 'Erro ao atualizar status');
                location.reload();
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro de conexao');
            location.reload();
        });
    });
});

// =========================================================================
// Funcoes de Descarte
// =========================================================================

// Toggle campos de custo
document.getElementById('tem-custo-descarte')?.addEventListener('change', function() {
    const fields = document.querySelectorAll('.custo-descarte-fields');
    fields.forEach(field => {
        if (this.checked) {
            field.classList.remove('d-none');
        } else {
            field.classList.add('d-none');
        }
    });
});

// =========================================================================
// Descarte - Funcoes de Quantidade e Termo
// =========================================================================

// Atualizar quantidades e valores do descarte
function atualizarQtdDescarte(input, tipo) {
    const row = input.closest('tr');
    const qtdPorCaixa = parseFloat(row.dataset.qtdPorCaixa) || 1;
    const valorUnitario = parseFloat(row.dataset.valorUnitario) || 0;
    const qtdOriginal = parseFloat(row.dataset.qtdOriginal) || 0;

    const inputUn = row.querySelector('.qtd-un-descarte');
    const inputCx = row.querySelector('.qtd-cx-descarte');
    const inputValor = row.querySelector('.valor-descarte-linha');

    let qtdUnidades;

    if (tipo === 'un') {
        qtdUnidades = parseFloat(inputUn.value) || 0;
        // Limitar ao maximo da NFD
        if (qtdUnidades > qtdOriginal) {
            qtdUnidades = qtdOriginal;
            inputUn.value = qtdUnidades;
        }
        // Calcular caixas
        inputCx.value = (qtdUnidades / qtdPorCaixa).toFixed(2);
    } else {
        // Converter caixas para unidades
        const qtdCaixas = parseFloat(inputCx.value) || 0;
        qtdUnidades = qtdCaixas * qtdPorCaixa;
        // Limitar ao maximo da NFD
        if (qtdUnidades > qtdOriginal) {
            qtdUnidades = qtdOriginal;
            inputCx.value = (qtdUnidades / qtdPorCaixa).toFixed(2);
        }
        inputUn.value = Math.round(qtdUnidades);
    }

    // Calcular valor
    const valorLinha = qtdUnidades * valorUnitario;
    inputValor.value = valorLinha.toFixed(2);

    // Atualizar total
    calcularTotalDescarte();
}

// Calcular total do descarte
function calcularTotalDescarte() {
    let total = 0;
    document.querySelectorAll('.valor-descarte-linha').forEach(input => {
        total += parseFloat(input.value) || 0;
    });

    const totalElement = document.getElementById('total-valor-descarte');
    if (totalElement) {
        totalElement.textContent = `R$ ${total.toFixed(2)}`;
    }

    const valorMercadoriaInput = document.getElementById('valor_mercadoria_descarte');
    if (valorMercadoriaInput) {
        valorMercadoriaInput.value = total.toFixed(2);
    }
}

// Download do termo de descarte
function downloadTermoDescarte(descarteId) {
    window.open(`/devolucao/frete/api/descarte/${descarteId}/termo/download`, '_blank');
}

// Imprimir termo de descarte
function imprimirTermoDescarte(descarteId) {
    const printWindow = window.open(`/devolucao/frete/api/descarte/${descarteId}/termo/imprimir`, '_blank');
    printWindow.onload = function() {
        printWindow.print();
    };
}

// Inicializar total ao carregar pagina
document.addEventListener('DOMContentLoaded', function() {
    calcularTotalDescarte();
});

function criarDescarte() {
    const form = document.getElementById('form-novo-descarte');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    const spinner = document.getElementById('spinner-descarte');
    const feedback = document.getElementById('feedback-descarte');

    // Converter checkbox
    data.tem_custo = document.getElementById('tem-custo-descarte').checked;

    // Validar campos obrigatorios - Empresa Autorizada (compliance)
    if (!data.empresa_autorizada_nome || data.empresa_autorizada_nome.trim() === '') {
        feedback.className = 'alert alert-warning';
        feedback.textContent = 'Informe o nome da empresa autorizada a descartar';
        feedback.classList.remove('d-none');
        return;
    }

    if (!data.empresa_autorizada_documento || data.empresa_autorizada_documento.trim() === '') {
        feedback.className = 'alert alert-warning';
        feedback.textContent = 'Informe o CNPJ/CPF da empresa autorizada';
        feedback.classList.remove('d-none');
        return;
    }

    if (!data.motivo_descarte) {
        feedback.className = 'alert alert-warning';
        feedback.textContent = 'Selecione o motivo do descarte';
        feedback.classList.remove('d-none');
        return;
    }

    spinner.classList.remove('d-none');
    feedback.classList.add('d-none');

    fetch(`/devolucao/frete/api/${ocorrenciaId}/descartes`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            feedback.className = 'alert alert-success';
            feedback.textContent = result.mensagem || 'Descarte autorizado';
            feedback.classList.remove('d-none');
            form.reset();
            setTimeout(() => location.reload(), 1000);
        } else {
            feedback.className = 'alert alert-danger';
            feedback.textContent = result.erro || 'Erro ao autorizar descarte';
            feedback.classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        feedback.className = 'alert alert-danger';
        feedback.textContent = 'Erro de conexao. Tente novamente.';
        feedback.classList.remove('d-none');
    })
    .finally(() => {
        spinner.classList.add('d-none');
    });
}

function excluirDescarte(descarteId) {
    if (!confirm('Deseja excluir este descarte?')) {
        return;
    }

    fetch(`/devolucao/frete/api/descarte/${descarteId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            const row = document.getElementById(`descarte-row-${descarteId}`);
            if (row) row.remove();
        } else {
            alert(result.erro || 'Erro ao excluir descarte');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    });
}

// Event listeners para status do descarte
document.querySelectorAll('.status-descarte').forEach(select => {
    select.addEventListener('change', function() {
        const descarteId = this.dataset.descarteId;
        const novoStatus = this.value;

        fetch(`/devolucao/frete/api/descarte/${descarteId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
            },
            body: JSON.stringify({ status: novoStatus })
        })
        .then(response => response.json())
        .then(result => {
            if (!result.sucesso) {
                alert(result.erro || 'Erro ao atualizar status');
                location.reload();
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro de conexao');
            location.reload();
        });
    });
});

// =========================================================================
// Funcoes de Upload de Termo
// =========================================================================

function uploadTermoDescarte(descarteId, tipo) {
    document.getElementById('upload-descarte-id').value = descarteId;
    document.getElementById('upload-tipo-documento').value = tipo;
    document.getElementById('arquivo-termo').value = '';

    // Atualizar titulo do modal
    const titulos = {
        'termo': 'Upload do Termo de Descarte',
        'termo_assinado': 'Upload do Termo Assinado',
        'comprovante': 'Upload do Comprovante de Descarte'
    };
    document.querySelector('#modal-upload-termo .modal-title').textContent = titulos[tipo] || 'Upload de Documento';

    const modal = new bootstrap.Modal(document.getElementById('modal-upload-termo'));
    modal.show();
}

function enviarTermoDescarte() {
    const form = document.getElementById('form-upload-termo');
    const fileInput = document.getElementById('arquivo-termo');
    const spinner = document.getElementById('spinner-upload-termo');
    const descarteId = document.getElementById('upload-descarte-id').value;
    const tipo = document.getElementById('upload-tipo-documento').value;

    if (!fileInput.files.length) {
        alert('Selecione um arquivo');
        return;
    }

    const formData = new FormData();
    formData.append('arquivo', fileInput.files[0]);

    spinner.classList.remove('d-none');

    fetch(`/devolucao/frete/api/descarte/${descarteId}/upload/${tipo}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            bootstrap.Modal.getInstance(document.getElementById('modal-upload-termo')).hide();
            location.reload();
        } else {
            alert(result.erro || 'Erro ao enviar arquivo');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    })
    .finally(() => {
        spinner.classList.add('d-none');
    });
}

// =========================================================================
// Funcoes para Editar NFs de Venda Referenciadas
// =========================================================================

function abrirModalEditarNFs() {
    carregarNFsReferenciadas();
    const modal = new bootstrap.Modal(document.getElementById('modal-editar-nfs'));
    modal.show();
}

function carregarNFsReferenciadas() {
    const container = document.getElementById('lista-nfs-modal');
    container.innerHTML = '<span class="text-muted">Carregando...</span>';

    fetch(`/devolucao/vinculacao/api/${nfdId}/nfs-referenciadas`)
        .then(response => response.json())
        .then(result => {
            if (result.sucesso && result.nfs_referenciadas && result.nfs_referenciadas.length > 0) {
                let html = '<ul class="list-group">';
                result.nfs_referenciadas.forEach(nf => {
                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <strong>NF ${nf.numero_nf}</strong>
                                ${nf.serie_nf ? `<small class="text-muted">(SÃ©rie ${nf.serie_nf})</small>` : ''}
                                <br>
                                <small class="text-muted">Origem: ${nf.origem || 'N/A'}</small>
                            </span>
                            <button class="btn btn-sm btn-outline-danger" onclick="removerNF(${nf.id})" title="Remover NF">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </li>
                    `;
                });
                html += '</ul>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<span class="text-muted">Nenhuma NF de venda vinculada</span>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar NFs:', error);
            container.innerHTML = '<span class="text-danger">Erro ao carregar NFs</span>';
        });
}

function adicionarNF() {
    const numero = document.getElementById('nova-nf-numero').value.trim();
    const serie = document.getElementById('nova-nf-serie').value.trim() || '1';
    const chave = document.getElementById('nova-nf-chave').value.trim();
    const spinner = document.getElementById('spinner-add-nf');

    if (!numero) {
        alert('Informe o numero da NF');
        return;
    }

    spinner.classList.remove('d-none');

    fetch(`/devolucao/vinculacao/api/${nfdId}/nfs-referenciadas`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: JSON.stringify({
            numero_nf: numero,
            serie_nf: serie,
            chave_nf: chave || null,
            origem: 'MANUAL'
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            // Limpar formulario
            document.getElementById('nova-nf-numero').value = '';
            document.getElementById('nova-nf-chave').value = '';
            // Recarregar lista
            carregarNFsReferenciadas();
            atualizarListaNFsNaTela();
        } else {
            alert(result.erro || 'Erro ao adicionar NF');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    })
    .finally(() => {
        spinner.classList.add('d-none');
    });
}

function removerNF(refId) {
    if (!confirm('Confirma remover esta NF de venda?')) {
        return;
    }

    fetch(`/devolucao/vinculacao/api/${nfdId}/nfs-referenciadas/${refId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            carregarNFsReferenciadas();
            atualizarListaNFsNaTela();
        } else {
            alert(result.erro || 'Erro ao remover NF');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    });
}

function atualizarListaNFsNaTela() {
    // Atualiza a lista de NFs na tela principal (fora do modal)
    fetch(`/devolucao/vinculacao/api/${nfdId}/nfs-referenciadas`)
        .then(response => response.json())
        .then(result => {
            const container = document.getElementById('lista-nfs-referenciadas');
            if (result.sucesso && result.nfs_referenciadas && result.nfs_referenciadas.length > 0) {
                let html = '';
                result.nfs_referenciadas.forEach(nf => {
                    html += `<span class="badge bg-secondary me-1 mb-1">NF ${nf.numero_nf}</span>`;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = '<span class="text-muted">-</span>';
            }
        });
}

// =========================================================================
// ABA PRODUTOS - Toggle Comparacao NF de Venda
// =========================================================================

let modoComparacao = false;
let dadosComparacao = null;
let produtoSelecionadoInfo = null;
let timeoutBuscaProd = null;
const PREFIXO_CNPJ = '{{ nfd.prefixo_cnpj_emitente or "" }}';

function toggleComparacaoNF() {
    const btn = document.getElementById('btn-comparar-nf');
    const tabelaNFD = document.getElementById('tabela-produtos-nfd');
    const tabelaComparacao = document.getElementById('tabela-comparacao-nf');

    modoComparacao = !modoComparacao;

    if (modoComparacao) {
        // Mostrar comparacao
        btn.innerHTML = '<i class="bi bi-list-ul"></i> Ver qtds da NFD';
        btn.classList.remove('btn-outline-info');
        btn.classList.add('btn-info');
        tabelaNFD.classList.add('d-none');
        tabelaComparacao.classList.remove('d-none');

        // Carregar dados se ainda nao carregou
        if (!dadosComparacao) {
            carregarComparacaoNF();
        }
    } else {
        // Voltar para tabela NFD
        btn.innerHTML = '<i class="bi bi-arrow-left-right"></i> Comparar com NF de venda';
        btn.classList.remove('btn-info');
        btn.classList.add('btn-outline-info');
        tabelaNFD.classList.remove('d-none');
        tabelaComparacao.classList.add('d-none');
    }
}

async function carregarComparacaoNF() {
    const loading = document.getElementById('loading-comparacao');
    const resultado = document.getElementById('resultado-comparacao');

    loading.classList.remove('d-none');
    resultado.classList.add('d-none');

    try {
        const response = await fetch(`/devolucao/ocorrencias/api/${ocorrenciaId}/comparar-nf-venda`);
        const data = await response.json();

        if (data.sucesso) {
            dadosComparacao = data;
            renderizarComparacao(data);
        } else {
            document.getElementById('tbody-comparacao').innerHTML = `
                <tr><td colspan="8" class="text-center text-danger">${data.erro || 'Erro ao carregar dados'}</td></tr>
            `;
        }
    } catch (error) {
        console.error('Erro:', error);
        document.getElementById('tbody-comparacao').innerHTML = `
            <tr><td colspan="8" class="text-center text-danger">Erro de conexao: ${error.message}</td></tr>
        `;
    } finally {
        loading.classList.add('d-none');
        resultado.classList.remove('d-none');
    }
}

function renderizarComparacao(data) {
    const tbody = document.getElementById('tbody-comparacao');
    const tfoot = document.getElementById('tfoot-comparacao');
    let html = '';
    let totalValorDevol = 0;

    if (data.produtos && data.produtos.length > 0) {
        data.produtos.forEach(p => {
            // Usar mais precisÃ£o no cÃ¡lculo
            const qtdDevolvida = parseFloat(p.qtd_devolvida) || 0;
            const qtdVendida = parseFloat(p.qtd_vendida) || 0;
            const precoDevol = parseFloat(p.preco_devolvido) || parseFloat(p.preco_venda) || 0;

            const percDevol = qtdVendida > 0 ? ((qtdDevolvida / qtdVendida) * 100).toFixed(1) : '-';
            const valorDevol = qtdDevolvida * precoDevol;
            totalValorDevol += valorDevol;

            const percClass = parseFloat(percDevol) > 100 ? 'text-danger' :
                              parseFloat(percDevol) > 50 ? 'text-warning' : 'text-success';

            html += `
                <tr>
                    <td><code>${p.codigo || '-'}</code></td>
                    <td>${p.descricao || '-'}</td>
                    <td class="text-end">${qtdVendida ? qtdVendida.toFixed(4) : '-'}</td>
                    <td class="text-end">${qtdDevolvida ? qtdDevolvida.toFixed(4) : '-'}</td>
                    <td class="text-end ${percClass}">${percDevol}%</td>
                    <td class="text-end">${p.preco_venda ? 'R$ ' + parseFloat(p.preco_venda).toFixed(2) : '-'}</td>
                    <td class="text-end">${p.preco_devolvido ? 'R$ ' + parseFloat(p.preco_devolvido).toFixed(2) : '-'}</td>
                    <td class="text-end"><strong>R$ ${valorDevol.toFixed(2)}</strong></td>
                </tr>
            `;
        });
    } else {
        html = '<tr><td colspan="8" class="text-center text-muted">Nenhum produto encontrado para comparar</td></tr>';
    }

    tbody.innerHTML = html;

    // Footer com totais
    tfoot.innerHTML = `
        <tr>
            <td colspan="7" class="text-end"><strong>Total Valor Devolucao:</strong></td>
            <td class="text-end"><strong>R$ ${totalValorDevol.toFixed(2)}</strong></td>
        </tr>
    `;

    // NFs nao encontradas
    if (data.nfs_nao_encontradas && data.nfs_nao_encontradas.length > 0) {
        document.getElementById('nfs-nao-encontradas').classList.remove('d-none');
        document.getElementById('lista-nfs-nao-encontradas').textContent = data.nfs_nao_encontradas.join(', ');
    } else {
        document.getElementById('nfs-nao-encontradas').classList.add('d-none');
    }
}

// =========================================================================
// ABA PRODUTOS - Modal Resolver/Editar
// =========================================================================

function abrirModalResolverProduto(linhaId, codigoCliente, descricaoCliente, quantidade, unidade) {
    // Modo resolver - mostra sugestoes da IA
    document.getElementById('modal-produto-titulo').textContent = 'Resolver Produto';
    document.getElementById('modal-sugestoes-ia').classList.remove('d-none');
    document.getElementById('prod-linha-id').value = linhaId;

    // Info do produto cliente
    document.getElementById('modal-produto-cliente-info').innerHTML = `
        <code>${codigoCliente || '-'}</code> - ${descricaoCliente || '-'}
        <br><small class="text-muted">Qtd: ${quantidade || '-'} ${unidade || ''}</small>
    `;

    // Limpar campos
    document.getElementById('prod-nosso-codigo').value = '';
    document.getElementById('prod-nosso-descricao').value = '';
    document.getElementById('prod-qtd-original').value = `${quantidade || ''} ${unidade || ''}`;
    document.getElementById('prod-fator-conversao').value = '';
    document.getElementById('prod-qtd-convertida').value = '';
    document.getElementById('prod-peso').value = '';
    document.getElementById('prod-info-extra').classList.add('d-none');
    produtoSelecionadoInfo = null;

    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modal-produto'));
    modal.show();

    // Buscar sugestoes da IA
    buscarSugestoesIA(linhaId, codigoCliente, descricaoCliente, quantidade, unidade);
}

function abrirModalEditarProduto(linhaId, codigoCliente, descricaoCliente, quantidade, unidade, codigoInterno, descricaoInterna, qtdConvertida, fatorConversao) {
    // Modo editar - sem sugestoes da IA
    document.getElementById('modal-produto-titulo').textContent = 'Editar Produto';
    document.getElementById('modal-sugestoes-ia').classList.add('d-none');
    document.getElementById('prod-linha-id').value = linhaId;

    // Info do produto cliente
    document.getElementById('modal-produto-cliente-info').innerHTML = `
        <code>${codigoCliente || '-'}</code> - ${descricaoCliente || '-'}
        <br><small class="text-muted">Qtd: ${quantidade || '-'} ${unidade || ''}</small>
    `;

    // Preencher campos com valores existentes
    document.getElementById('prod-nosso-codigo').value = codigoInterno || '';
    document.getElementById('prod-nosso-descricao').value = descricaoInterna || '';
    document.getElementById('prod-qtd-original').value = `${quantidade || ''} ${unidade || ''}`;
    document.getElementById('prod-fator-conversao').value = fatorConversao || '';
    document.getElementById('prod-qtd-convertida').value = qtdConvertida || '';
    document.getElementById('prod-peso').value = '';
    document.getElementById('prod-info-extra').classList.add('d-none');
    produtoSelecionadoInfo = null;

    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modal-produto'));
    modal.show();
}

// Event listener para botÃµes de editar produto (usando data attributes)
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.btn-editar-produto').forEach(btn => {
        btn.addEventListener('click', function() {
            const linhaId = this.dataset.linhaId;
            const codigoCliente = this.dataset.codigoCliente || '';
            const descricaoCliente = this.dataset.descricaoCliente || '';
            const quantidade = parseFloat(this.dataset.quantidade) || 0;
            const unidade = this.dataset.unidade || '';
            const codigoInterno = this.dataset.codigoInterno || '';
            const descricaoInterna = this.dataset.descricaoInterna || '';
            const qtdConvertida = this.dataset.qtdConvertida ? parseFloat(this.dataset.qtdConvertida) : null;
            const fatorConversao = this.dataset.fatorConversao ? parseFloat(this.dataset.fatorConversao) : null;

            abrirModalEditarProduto(linhaId, codigoCliente, descricaoCliente, quantidade, unidade, codigoInterno, descricaoInterna, qtdConvertida, fatorConversao);
        });
    });
});

async function buscarSugestoesIA(linhaId, codigoCliente, descricaoCliente, quantidade, unidade) {
    const container = document.getElementById('modal-sugestoes-lista');
    container.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm"></div>
            <span class="ms-2">Consultando IA...</span>
        </div>
    `;

    try {
        const response = await fetch('/devolucao/ai/api/resolver-produto', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prefixo_cnpj: PREFIXO_CNPJ,
                codigo_cliente: codigoCliente,
                descricao_cliente: descricaoCliente,
                quantidade: quantidade,
                unidade_cliente: unidade
            })
        });

        const data = await response.json();

        if (data.sucesso && data.sugestao_principal) {
            renderizarSugestoesModal(data, quantidade);
        } else {
            container.innerHTML = `
                <div class="alert alert-warning mb-0">
                    Nenhuma sugestao encontrada. Preencha manualmente.
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro:', error);
        container.innerHTML = `
            <div class="alert alert-danger mb-0">
                Erro ao consultar IA: ${error.message}
            </div>
        `;
    }
}

function renderizarSugestoesModal(data, quantidade) {
    const container = document.getElementById('modal-sugestoes-lista');
    const confiancaClass = data.confianca >= 0.9 ? 'bg-success' :
                           data.confianca >= 0.5 ? 'bg-warning' : 'bg-danger';

    let html = `
        <div class="mb-2">
            <span class="badge ${confiancaClass}">${(data.confianca * 100).toFixed(0)}% confianca</span>
            ${data.metodo_resolucao ? `<span class="badge bg-secondary ms-1">${data.metodo_resolucao}</span>` : ''}
        </div>
        <div class="list-group">
    `;

    // Sugestao principal
    const sp = data.sugestao_principal;
    html += criarItemSugestao(sp, quantidade, true);

    // Outras sugestoes
    if (data.outras_sugestoes && data.outras_sugestoes.length > 0) {
        data.outras_sugestoes.forEach(s => {
            html += criarItemSugestao(s, quantidade, false);
        });
    }

    html += '</div>';
    container.innerHTML = html;

    // Selecionar sugestao principal automaticamente
    selecionarSugestaoModal(sp.codigo, sp.nome, sp.qtd_por_caixa, sp.qtd_convertida_caixas, sp.peso_calculado, quantidade);
}

function criarItemSugestao(sugestao, quantidade, principal) {
    const s = sugestao;
    return `
        <button type="button" class="list-group-item list-group-item-action ${principal ? 'active' : ''}"
                onclick="selecionarSugestaoModal('${s.codigo}', '${(s.nome || '').replace(/'/g, "\\'")}', ${s.qtd_por_caixa || 'null'}, ${s.qtd_convertida_caixas || 'null'}, ${s.peso_calculado || 'null'}, ${quantidade || 'null'})">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${s.codigo}</strong>
                    <br><small>${s.nome || ''}</small>
                </div>
                <div class="text-end">
                    ${s.qtd_por_caixa ? `<span class="badge bg-info">${s.qtd_por_caixa} un/cx</span>` : ''}
                    ${s.qtd_convertida_caixas ? `<br><small class="text-success">${quantidade} un â†’ ${s.qtd_convertida_caixas} cx</small>` : ''}
                </div>
            </div>
        </button>
    `;
}

function selecionarSugestaoModal(codigo, nome, qtdPorCaixa, qtdConvertida, peso, qtdOriginal) {
    document.getElementById('prod-nosso-codigo').value = codigo;
    document.getElementById('prod-nosso-descricao').value = nome;
    document.getElementById('prod-fator-conversao').value = qtdPorCaixa || '';
    document.getElementById('prod-qtd-convertida').value = qtdConvertida || '';
    document.getElementById('prod-peso').value = peso || '';

    produtoSelecionadoInfo = {
        codigo: codigo,
        nome: nome,
        qtd_por_caixa: qtdPorCaixa,
        qtd_convertida: qtdConvertida,
        peso: peso
    };

    // Atualizar visual da lista
    document.querySelectorAll('#modal-sugestoes-lista .list-group-item').forEach(el => {
        el.classList.remove('active');
        if (el.querySelector('strong')?.textContent === codigo) {
            el.classList.add('active');
        }
    });
}

// =========================================================================
// ABA PRODUTOS - Autocomplete de Produtos
// =========================================================================

async function buscarProdutosAba(query) {
    if (timeoutBuscaProd) clearTimeout(timeoutBuscaProd);

    if (!query || query.length < 2) {
        document.getElementById('autocomplete-produtos-aba').classList.remove('show');
        return;
    }

    timeoutBuscaProd = setTimeout(async () => {
        try {
            const response = await fetch(`/devolucao/ai/api/produtos/buscar?q=${encodeURIComponent(query)}&limit=15`);
            const data = await response.json();

            const dropdown = document.getElementById('autocomplete-produtos-aba');

            if (data.sucesso && data.produtos.length > 0) {
                let html = '';
                data.produtos.forEach(p => {
                    html += `
                        <a class="dropdown-item" href="#"
                           onclick="selecionarProdutoAba('${p.codigo}', '${(p.nome || '').replace(/'/g, "\\'")}', '${p.embalagem || ''}', '${p.materia_prima || ''}', ${p.peso_bruto || 'null'}); return false;">
                            <strong>${p.codigo}</strong>
                            <br><small class="text-muted">${p.nome}</small>
                        </a>
                    `;
                });
                dropdown.innerHTML = html;
                dropdown.classList.add('show');
            } else {
                dropdown.innerHTML = '<span class="dropdown-item text-muted">Nenhum produto encontrado</span>';
                dropdown.classList.add('show');
            }
        } catch (error) {
            console.error('Erro ao buscar produtos:', error);
        }
    }, 300);
}

function selecionarProdutoAba(codigo, nome, embalagem, materia, pesoBruto) {
    document.getElementById('prod-nosso-codigo').value = codigo;
    document.getElementById('prod-nosso-descricao').value = nome;
    document.getElementById('autocomplete-produtos-aba').classList.remove('show');

    // Mostrar info extra
    document.getElementById('prod-info-extra').classList.remove('d-none');
    document.getElementById('prod-info-embalagem').textContent = embalagem || '-';
    document.getElementById('prod-info-materia').textContent = materia || '-';
    document.getElementById('prod-info-peso-cx').textContent = pesoBruto || '-';

    produtoSelecionadoInfo = {
        codigo: codigo,
        nome: nome,
        peso_bruto: pesoBruto
    };

    // Recalcular peso se tiver qtd convertida
    calcularQtdConvertida();
}

function calcularQtdConvertida() {
    const qtdOriginalStr = document.getElementById('prod-qtd-original').value;
    const fator = parseFloat(document.getElementById('prod-fator-conversao').value);

    if (!qtdOriginalStr || !fator || fator <= 0) return;

    // Extrair numero da string "123 UN"
    const qtdMatch = qtdOriginalStr.match(/[\d.,]+/);
    if (!qtdMatch) return;

    const qtdOriginal = parseFloat(qtdMatch[0].replace(',', '.'));
    const qtdConvertida = qtdOriginal / fator;

    document.getElementById('prod-qtd-convertida').value = qtdConvertida.toFixed(2);

    // Calcular peso se tiver info do produto
    if (produtoSelecionadoInfo && produtoSelecionadoInfo.peso_bruto) {
        const peso = qtdConvertida * produtoSelecionadoInfo.peso_bruto;
        document.getElementById('prod-peso').value = peso.toFixed(2);
    }
}

// =========================================================================
// ABA PRODUTOS - Salvar Produto
// =========================================================================

async function salvarProduto() {
    const linhaId = document.getElementById('prod-linha-id').value;
    const codigo = document.getElementById('prod-nosso-codigo').value;
    const descricao = document.getElementById('prod-nosso-descricao').value;
    const fatorConversao = document.getElementById('prod-fator-conversao').value;
    const qtdConvertida = document.getElementById('prod-qtd-convertida').value;
    const gravarDepara = document.getElementById('prod-gravar-depara').checked;

    if (!codigo) {
        alert('Informe o nosso codigo');
        return;
    }

    const spinner = document.getElementById('spinner-salvar-prod');
    spinner.classList.remove('d-none');

    try {
        const response = await fetch(`/devolucao/ai/api/linha/${linhaId}/confirmar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                codigo_interno: codigo,
                descricao_interno: descricao,
                gravar_depara: gravarDepara,
                qtd_por_caixa: fatorConversao ? parseInt(fatorConversao) : null,
                quantidade_convertida: qtdConvertida ? parseFloat(qtdConvertida) : null
            })
        });

        const data = await response.json();

        if (data.sucesso) {
            // Atualizar linha na tabela
            const row = document.getElementById(`prod-linha-${linhaId}`);
            if (row) {
                row.classList.add('table-success');

                // Nosso codigo
                document.getElementById(`prod-nosso-${linhaId}`).innerHTML = `
                    <strong class="text-primary">${codigo}</strong>
                    <br><small class="text-muted">${descricao}</small>
                `;

                // Qtd convertida
                if (data.quantidade_convertida) {
                    document.getElementById(`prod-qtd-${linhaId}`).innerHTML = `
                        <span class="badge bg-success">${data.quantidade_convertida.toFixed(2)} cx</span>
                    `;
                }

                // Peso
                if (data.peso_bruto) {
                    document.getElementById(`prod-peso-${linhaId}`).innerHTML = `
                        <span class="badge bg-info">${data.peso_bruto.toFixed(2)} kg</span>
                    `;
                }

                // Status
                document.getElementById(`prod-status-${linhaId}`).innerHTML = `
                    <span class="badge bg-success">Resolvido</span>
                `;
            }

            bootstrap.Modal.getInstance(document.getElementById('modal-produto')).hide();
        } else {
            alert('Erro: ' + (data.erro || 'Falha ao salvar'));
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro de conexao: ' + error.message);
    } finally {
        spinner.classList.add('d-none');
    }
}

// Fechar dropdown ao clicar fora
document.addEventListener('click', function(e) {
    if (!e.target.closest('#prod-nosso-codigo') && !e.target.closest('#autocomplete-produtos-aba')) {
        document.getElementById('autocomplete-produtos-aba')?.classList.remove('show');
    }
});

// =========================================================================
// RESOLVER TODOS COM IA
// =========================================================================

// Armazena resultados para aplicar depois
let resultadosResolverTodos = [];

async function resolverTodosComIA() {
    const modal = new bootstrap.Modal(document.getElementById('modal-resolver-todos'));
    const loading = document.getElementById('resolver-loading');
    const resultado = document.getElementById('resolver-resultado');
    const aplicando = document.getElementById('resolver-aplicando');
    const footer = document.getElementById('resolver-footer');
    const resumo = document.getElementById('resolver-resumo');
    const tbody = document.getElementById('resolver-tbody');

    // Reset estado
    loading.classList.remove('d-none');
    resultado.classList.add('d-none');
    aplicando.classList.add('d-none');
    footer.classList.add('d-none');
    tbody.innerHTML = '';
    resultadosResolverTodos = [];
    document.getElementById('resolver-selecionar-todos').checked = false;
    atualizarContadorSelecionadas();

    modal.show();

    try {
        const response = await fetch(`/devolucao/ai/api/nfd/${nfdId}/resolver-linhas`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ auto_gravar_depara: false })
        });

        const data = await response.json();

        loading.classList.add('d-none');
        resultado.classList.remove('d-none');
        footer.classList.remove('d-none');

        if (data.sucesso) {
            // Armazenar resultados
            resultadosResolverTodos = data.linhas || [];

            // Resumo
            resumo.innerHTML = `
                <strong>Sugestoes encontradas!</strong> Selecione as linhas que deseja aplicar.<br>
                Total: ${data.total_linhas || 0} linhas |
                <span class="text-success">Auto (>=90%): ${data.resolvidas_auto || 0}</span> |
                <span class="text-warning">Confirmar: ${data.requerem_confirmacao || 0}</span> |
                <span class="text-danger">Nao identificadas: ${data.nao_identificadas || 0}</span>
            `;

            // Tabela de resultados com checkbox
            if (resultadosResolverTodos.length > 0) {
                resultadosResolverTodos.forEach((r, index) => {
                    const confianca = r.confianca || 0;
                    const confiancaClass = confianca >= 0.9 ? 'text-success' :
                                          confianca >= 0.5 ? 'text-warning' : 'text-danger';
                    const temSugestao = r.sugestao && r.sugestao.codigo;
                    const statusClass = r.status === 'AUTO_RESOLVIDO' ? 'bg-success' :
                                        r.status === 'REQUER_CONFIRMACAO' ? 'bg-warning' : 'bg-secondary';
                    const statusText = r.status === 'AUTO_RESOLVIDO' ? 'Auto (>=90%)' :
                                       r.status === 'REQUER_CONFIRMACAO' ? 'Confirmar' : 'Nao identificado';

                    // Checkbox habilitado apenas se tem sugestao
                    const checkboxHtml = temSugestao ?
                        `<input type="checkbox" class="form-check-input resolver-checkbox" data-index="${index}" onchange="atualizarContadorSelecionadas()" ${confianca >= 0.9 ? 'checked' : ''}>` :
                        `<span class="text-muted">-</span>`;

                    // Quantidade e unidade da NFD
                    const qtdNfd = r.quantidade ? parseFloat(r.quantidade).toFixed(2) : '-';
                    const unidade = r.unidade_cliente || '';

                    // Conversao (se houver)
                    let conversaoHtml = '-';
                    if (temSugestao && r.sugestao.qtd_por_caixa) {
                        const fator = r.sugestao.qtd_por_caixa;
                        const qtdConv = r.sugestao.qtd_convertida_caixas;
                        conversaoHtml = `<small class="text-info">Ã· ${fator}</small>`;
                        if (qtdConv) {
                            conversaoHtml += `<br><strong class="text-success">${parseFloat(qtdConv).toFixed(2)} cx</strong>`;
                        }
                    }

                    tbody.innerHTML += `
                        <tr id="resolver-row-${index}" class="${temSugestao && confianca >= 0.9 ? 'table-success' : ''}">
                            <td class="text-center">${checkboxHtml}</td>
                            <td>
                                <code>${r.codigo_cliente || '-'}</code>
                                <br><small class="text-muted">${(r.descricao_cliente || '-').substring(0, 50)}</small>
                            </td>
                            <td>
                                ${temSugestao ? `<strong class="text-primary">${r.sugestao.codigo}</strong>` : '-'}
                                ${temSugestao ? `<br><small class="text-muted">${(r.sugestao.nome || '').substring(0, 50)}</small>` : ''}
                            </td>
                            <td class="text-center">
                                <strong>${qtdNfd}</strong>
                                ${unidade ? `<br><small class="text-muted">${unidade}</small>` : ''}
                            </td>
                            <td class="text-center">
                                ${conversaoHtml}
                            </td>
                            <td class="text-center ${confiancaClass}">
                                ${confianca ? (confianca * 100).toFixed(0) + '%' : '-'}
                            </td>
                            <td>
                                <span class="badge ${statusClass}" id="resolver-status-${index}">${statusText}</span>
                            </td>
                        </tr>
                    `;
                });
                atualizarContadorSelecionadas();
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhuma linha pendente para processar</td></tr>';
            }
        } else {
            resumo.innerHTML = `<span class="text-danger"><strong>Erro:</strong> ${data.erro || 'Erro ao processar'}</span>`;
            resumo.classList.remove('alert-info');
            resumo.classList.add('alert-danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        loading.classList.add('d-none');
        resultado.classList.remove('d-none');
        footer.classList.remove('d-none');
        resumo.innerHTML = `<span class="text-danger"><strong>Erro de conexao:</strong> ${error.message}</span>`;
        resumo.classList.remove('alert-info');
        resumo.classList.add('alert-danger');
    }
}

function toggleSelecionarTodosResolver() {
    const checked = document.getElementById('resolver-selecionar-todos').checked;
    document.querySelectorAll('.resolver-checkbox').forEach(cb => {
        cb.checked = checked;
    });
    atualizarContadorSelecionadas();
}

function atualizarContadorSelecionadas() {
    const count = document.querySelectorAll('.resolver-checkbox:checked').length;
    document.getElementById('count-selecionadas').textContent = count;
    document.getElementById('btn-aplicar-resolucoes').disabled = count === 0;
}

async function aplicarResolucoesSelecionadas() {
    const checkboxes = document.querySelectorAll('.resolver-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Selecione ao menos uma linha para aplicar');
        return;
    }

    const gravarDepara = document.getElementById('resolver-gravar-depara').checked;
    const resultado = document.getElementById('resolver-resultado');
    const aplicando = document.getElementById('resolver-aplicando');
    const footer = document.getElementById('resolver-footer');
    const progresso = document.getElementById('resolver-aplicando-progresso');

    // Ocultar resultado e mostrar progresso
    resultado.classList.add('d-none');
    footer.classList.add('d-none');
    aplicando.classList.remove('d-none');

    let aplicadas = 0;
    let erros = 0;
    const total = checkboxes.length;

    for (const cb of checkboxes) {
        const index = parseInt(cb.dataset.index);
        const r = resultadosResolverTodos[index];

        if (!r || !r.sugestao || !r.sugestao.codigo) continue;

        progresso.textContent = `${aplicadas + erros + 1}/${total}`;

        try {
            const response = await fetch(`/devolucao/ai/api/linha/${r.linha_id}/confirmar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    codigo_interno: r.sugestao.codigo,
                    descricao_interno: r.sugestao.nome || '',
                    gravar_depara: gravarDepara,
                    qtd_por_caixa: r.sugestao.qtd_por_caixa || null,
                    quantidade_convertida: r.sugestao.qtd_convertida_caixas || null
                })
            });

            const data = await response.json();

            if (data.sucesso) {
                aplicadas++;
                // Atualizar status na tabela do modal
                const statusEl = document.getElementById(`resolver-status-${index}`);
                if (statusEl) {
                    statusEl.className = 'badge bg-success';
                    statusEl.textContent = 'Aplicado';
                }
                // Atualizar linha na tabela principal
                atualizarLinhaProdutoNaTabela(r.linha_id, r.sugestao.codigo, r.sugestao.nome, data.quantidade_convertida, data.peso_bruto);
            } else {
                erros++;
                const statusEl = document.getElementById(`resolver-status-${index}`);
                if (statusEl) {
                    statusEl.className = 'badge bg-danger';
                    statusEl.textContent = 'Erro';
                }
            }
        } catch (error) {
            console.error(`Erro ao aplicar linha ${r.linha_id}:`, error);
            erros++;
        }
    }

    // Mostrar resultado final
    aplicando.classList.add('d-none');
    resultado.classList.remove('d-none');
    footer.classList.remove('d-none');

    const resumo = document.getElementById('resolver-resumo');
    resumo.className = erros === 0 ? 'alert alert-success mb-3' : 'alert alert-warning mb-3';
    resumo.innerHTML = `
        <strong>Aplicacao concluida!</strong><br>
        <span class="text-success">Aplicadas: ${aplicadas}</span> |
        <span class="text-danger">Erros: ${erros}</span>
    `;

    // Desmarcar checkboxes aplicados
    checkboxes.forEach(cb => {
        cb.checked = false;
        cb.disabled = true;
    });
    atualizarContadorSelecionadas();
}

function atualizarLinhaProdutoNaTabela(linhaId, codigo, descricao, qtdConvertida, peso) {
    // Atualiza a linha na tabela principal de produtos (fora do modal)
    const row = document.getElementById(`prod-linha-${linhaId}`);
    if (row) {
        row.classList.add('table-success');

        // Nosso codigo
        const nossoEl = document.getElementById(`prod-nosso-${linhaId}`);
        if (nossoEl) {
            nossoEl.innerHTML = `
                <strong class="text-primary">${codigo}</strong>
                <br><small class="text-muted">${descricao || ''}</small>
            `;
        }

        // Qtd convertida
        if (qtdConvertida) {
            const qtdEl = document.getElementById(`prod-qtd-${linhaId}`);
            if (qtdEl) {
                qtdEl.innerHTML = `<span class="badge bg-success">${parseFloat(qtdConvertida).toFixed(2)} cx</span>`;
            }
        }

        // Peso
        if (peso) {
            const pesoEl = document.getElementById(`prod-peso-${linhaId}`);
            if (pesoEl) {
                pesoEl.innerHTML = `<span class="badge bg-info">${parseFloat(peso).toFixed(2)} kg</span>`;
            }
        }

        // Status
        const statusEl = document.getElementById(`prod-status-${linhaId}`);
        if (statusEl) {
            statusEl.innerHTML = `<span class="badge bg-success">Resolvido</span>`;
        }
    }
}
</script>
{% endblock %}
