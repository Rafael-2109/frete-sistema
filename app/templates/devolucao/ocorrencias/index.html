{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Ocorrencias de Devolucao</h2>
            <p class="text-muted mb-0">Gerenciamento de ocorrencias para Comercial e Logistica</p>
        </div>
        <div>
            <!-- Dropdown de Sincronizacao -->
            <div class="btn-group me-2">
                <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Sincronizar NFDs
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item" href="#" onclick="sincronizarRapido(); return false;">
                            Ultimos 60 minutos
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" onclick="sincronizarDias(7); return false;">
                            Ultimos 7 dias
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" onclick="sincronizarDias(30); return false;">
                            Ultimos 30 dias
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalSincPeriodo">
                            Por periodo...
                        </a>
                    </li>
                </ul>
            </div>
            <a href="{{ url_for('devolucao.devolucao_ai.pagina_depara') }}" class="btn btn-info me-2">
                De-Para de Produtos
            </a>
            <a href="{{ url_for('monitoramento.listar_entregas') }}" class="btn btn-outline-secondary">
                Voltar ao Monitoramento
            </a>
        </div>
    </div>

    <!-- Cards de Estatisticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-primary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Total</h6>
                    <h2 class="mb-0">{{ stats.total }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-warning">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Abertas</h6>
                    <h2 class="mb-0">{{ stats.abertas }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-info">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Em Analise</h6>
                    <h2 class="mb-0">{{ stats.em_analise }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-success">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Resolvidas</h6>
                    <h2 class="mb-0">{{ stats.resolvidas }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0">Filtros</h6>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('devolucao.devolucao_ocorrencia.index') }}">
                <div class="row">
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            {% for valor, descricao in opcoes_status %}
                            <option value="{{ valor }}" {% if filtros.status == valor %}selected{% endif %}>
                                {{ descricao }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Destino</label>
                        <select name="destino" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            {% for valor, descricao in opcoes_destino %}
                            <option value="{{ valor }}" {% if filtros.destino == valor %}selected{% endif %}>
                                {{ descricao }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Categoria</label>
                        <select name="categoria" class="form-select form-select-sm">
                            <option value="">Todas</option>
                            {% for valor, descricao in opcoes_categoria %}
                            <option value="{{ valor }}" {% if filtros.categoria == valor %}selected{% endif %}>
                                {{ descricao }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Responsavel</label>
                        <select name="responsavel" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            {% for valor, descricao in opcoes_responsavel %}
                            <option value="{{ valor }}" {% if filtros.responsavel == valor %}selected{% endif %}>
                                {{ descricao }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Data Inicio</label>
                        <input type="date" name="data_inicio" class="form-control form-control-sm"
                               value="{{ filtros.data_inicio }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Data Fim</label>
                        <input type="date" name="data_fim" class="form-control form-control-sm"
                               value="{{ filtros.data_fim }}">
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-2">
                        <label class="form-label">CNPJ Cliente</label>
                        <input type="text" name="cnpj" class="form-control form-control-sm"
                               placeholder="CNPJ ou parte..."
                               value="{{ filtros.cnpj }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Transp. Entrega</label>
                        <select name="transportadora" class="form-select form-select-sm">
                            <option value="">Todas</option>
                            {% for transp in lista_transportadoras %}
                            <option value="{{ transp }}" {% if filtros.transportadora == transp %}selected{% endif %}>
                                {{ transp[:30] }}{% if transp|length > 30 %}...{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Transp. Retorno</label>
                        <select name="transportadora_retorno" class="form-select form-select-sm">
                            <option value="">Todas</option>
                            {% for transp in lista_transportadoras_retorno %}
                            <option value="{{ transp }}" {% if filtros.transportadora_retorno == transp %}selected{% endif %}>
                                {{ transp[:25] }}{% if transp|length > 25 %}...{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Prev. Retorno</label>
                        <input type="date" name="data_retorno" class="form-control form-control-sm"
                               value="{{ filtros.data_retorno }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Busca</label>
                        <input type="text" name="busca" class="form-control form-control-sm"
                               placeholder="OC, NFD, cliente..."
                               value="{{ filtros.busca }}">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm me-2">Filtrar</button>
                        <a href="{{ url_for('devolucao.devolucao_ocorrencia.index') }}" class="btn btn-outline-secondary btn-sm">
                            Limpar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela de Ocorrencias -->
    <div class="card">
        <div class="card-body p-0">
            {% if ocorrencias %}
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Ocorrencia</th>
                            <th>NFD</th>
                            <th>Cliente</th>
                            <th>Transp. Retorno</th>
                            <th>Valor</th>
                            <th>Devolucao</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for oc in ocorrencias %}
                        <tr>
                            <!-- Coluna 1: Ocorrencia (com status monitoramento acima) -->
                            <td>
                                {# Linha 1: Status Monitoramento (acima do número) #}
                                {% set status_monit = oc.nf_devolucao.status_monitoramento if oc.nf_devolucao else None %}
                                {% if status_monit %}
                                    {% if status_monit == 'Devolvida' %}
                                        <span class="badge bg-danger badge-sm" title="Status monitoramento">{{ status_monit }}</span>
                                    {% elif status_monit == 'Cancelada' %}
                                        <span class="badge bg-warning text-dark badge-sm" title="Status monitoramento">{{ status_monit }}</span>
                                    {% elif status_monit == 'Troca de NF' %}
                                        <span class="badge bg-info badge-sm" title="Status monitoramento">{{ status_monit }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary badge-sm">{{ status_monit }}</span>
                                    {% endif %}
                                    <br>
                                {% endif %}
                                {# Linha 2: Número da Ocorrência #}
                                <a href="{{ url_for('devolucao.devolucao_ocorrencia.detalhe', ocorrencia_id=oc.id) }}"
                                   class="fw-bold text-decoration-none">
                                    {{ oc.numero_ocorrencia }}
                                </a>
                                {# Linha 3: Motivo (se existir) #}
                                {% if oc.nf_devolucao and oc.nf_devolucao.motivo %}
                                <br>
                                <span class="badge bg-{{ 'danger' if oc.nf_devolucao.motivo == 'AVARIA' else 'warning' if oc.nf_devolucao.motivo == 'FALTA' else 'info' }} badge-sm">
                                    {{ oc.nf_devolucao.motivo }}
                                </span>
                                {% endif %}
                            </td>
                            <!-- Coluna 2: NFD - Formato: NF|NFD - ##### - Status -->
                            <td>
                                {% if oc.nf_devolucao %}
                                    {% set tipo_doc = oc.nf_devolucao.tipo_documento or 'NFD' %}
                                    {% set numero = oc.nf_devolucao.numero_nfd or oc.nf_devolucao.numero_nf_venda or '?' %}

                                    {# Linha 1: Formato unificado - NF|NFD - ##### - Status #}
                                    <strong>
                                        <span class="text-{{ 'primary' if tipo_doc == 'NFD' else 'secondary' }}">{{ tipo_doc }}</span>
                                        <span class="text-muted mx-1">-</span>
                                        {{ numero }}
                                        <span class="text-muted mx-1">-</span>
                                        {# Status baseado no tipo de documento #}
                                        {% if tipo_doc == 'NFD' %}
                                            {% if oc.nf_devolucao.odoo_status_codigo == '06' %}
                                                <span class="badge bg-success badge-sm" title="Status Odoo: {{ oc.nf_devolucao.odoo_status_descricao or 'Concluído' }}{% if oc.nf_devolucao.data_entrada %} | Entrada: {{ oc.nf_devolucao.data_entrada|formatar_data_segura }}{% endif %}">Entrada OK</span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark badge-sm" title="Status Odoo: {{ oc.nf_devolucao.odoo_status_descricao or 'Pendente' }} | Aguardando entrada física">Pendente</span>
                                            {% endif %}
                                        {% else %}
                                            {# NF de venda - verificar se foi revertida #}
                                            {% if oc.nf_devolucao.status_odoo == 'Revertida' %}
                                                <span class="badge bg-danger badge-sm" title="NF revertida no Odoo">Reversão</span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark badge-sm" title="Pendente de reversão">Pendente</span>
                                            {% endif %}
                                        {% endif %}
                                    </strong>

                                    {# Linha 2: NFs Referenciadas #}
                                    {% if oc.nfs_referenciadas %}
                                    <br>
                                    <small class="text-muted" data-bs-toggle="tooltip" data-bs-html="true"
                                           title="{% for d in oc.dados_entregas %}NF: {{ d.numero_nf }} | {{ d.transportadora or '-' }} | {{ d.data_entrega|formatar_data_segura or '-' }}<br>{% endfor %}">
                                        Ref: NF {% for nf in oc.nfs_referenciadas[:3] %}{{ nf.numero_nf }}{% if not loop.last %}, {% endif %}{% endfor %}{% if oc.nfs_referenciadas|length > 3 %} + {{ oc.nfs_referenciadas|length - 3 }} mais{% endif %}
                                    </small>
                                    {% elif oc.nf_devolucao.numero_nf_venda and tipo_doc == 'NFD' %}
                                    <br><small class="text-muted">Ref: NF {{ oc.nf_devolucao.numero_nf_venda }}</small>
                                    {% endif %}

                                    {# Linha 3: Transportadora NF venda #}
                                    {% set transportadoras = oc.dados_entregas|selectattr('transportadora')|map(attribute='transportadora')|unique|list %}
                                    {% if transportadoras %}
                                    <br>
                                    <small class="text-info" data-bs-toggle="tooltip" data-bs-html="true"
                                           title="{% for d in oc.dados_entregas if d.transportadora %}{{ d.numero_nf }}: {{ d.transportadora }}<br>{% endfor %}">
                                        <i class="bi bi-truck"></i> {{ transportadoras[0][:18] }}{% if transportadoras[0]|length > 18 %}...{% endif %}{% if transportadoras|length > 1 %} + {{ transportadoras|length - 1 }}{% endif %}
                                    </small>
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <!-- Coluna 3: Cliente + CNPJ + UF-Cidade -->
                            <td>
                                {% if oc.nf_devolucao and oc.nf_devolucao.nome_emitente %}
                                {{ oc.nf_devolucao.nome_emitente[:25] }}{% if oc.nf_devolucao.nome_emitente|length > 25 %}...{% endif %}
                                <br><small class="text-muted">{{ oc.nf_devolucao.cnpj_emitente|formatar_cnpj if oc.nf_devolucao.cnpj_emitente else '' }}</small>
                                {# Linha 3: UF-Cidade #}
                                {% if oc.nf_devolucao.uf_emitente or oc.nf_devolucao.municipio_emitente %}
                                <br><small class="text-secondary"><i class="bi bi-geo-alt"></i> {{ oc.nf_devolucao.uf_emitente or '' }}{% if oc.nf_devolucao.uf_emitente and oc.nf_devolucao.municipio_emitente %}-{% endif %}{{ oc.nf_devolucao.municipio_emitente[:15] if oc.nf_devolucao.municipio_emitente else '' }}{% if oc.nf_devolucao.municipio_emitente and oc.nf_devolucao.municipio_emitente|length > 15 %}...{% endif %}</small>
                                {% endif %}
                                {% elif oc.nf_devolucao and oc.nf_devolucao.entrega_monitorada %}
                                {{ oc.nf_devolucao.entrega_monitorada.cliente[:25] }}{% if oc.nf_devolucao.entrega_monitorada.cliente|length > 25 %}...{% endif %}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <!-- Coluna 4: Transp. Retorno + Entrega Prevista + % Descartado -->
                            <td>
                                {% if oc.frete_retorno %}
                                <small class="text-primary" data-bs-toggle="tooltip" title="{{ oc.frete_retorno.transportadora_nome }}">
                                    <i class="bi bi-truck"></i> {{ oc.frete_retorno.transportadora_nome[:18] }}{% if oc.frete_retorno.transportadora_nome|length > 18 %}...{% endif %}
                                </small>
                                {% if oc.frete_retorno.data_coleta_prevista %}
                                <br><small class="text-muted">
                                    Prev: {{ oc.frete_retorno.data_coleta_prevista|formatar_data_segura }}
                                </small>
                                {% endif %}
                                {% endif %}
                                {% if oc.percentual_descarte %}
                                <br><small class="text-danger">
                                    {{ "%.1f"|format(oc.percentual_descarte) }}% Descartado
                                </small>
                                {% endif %}
                                {% if not oc.frete_retorno and not oc.percentual_descarte %}
                                <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                            <!-- Coluna 5: Valor + #/# prod + Status -->
                            <td>
                                {% if oc.nf_devolucao and oc.nf_devolucao.valor_total %}
                                <strong>R$ {{ "%.2f"|format(oc.nf_devolucao.valor_total|float) }}</strong>
                                {% set total_linhas = oc.nf_devolucao.linhas.count() %}
                                {% set resolvidas = oc.nf_devolucao.linhas.filter_by(produto_resolvido=True).count() %}
                                <br>
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-{{ 'success' if resolvidas == total_linhas and total_linhas > 0 else 'warning' if resolvidas > 0 else 'secondary' }} me-1">
                                        {{ resolvidas }}/{{ total_linhas }} prod
                                    </span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1"
                                            onclick="abrirModalProdutos({{ oc.nf_devolucao.id }}, '{{ oc.numero_ocorrencia }}')"
                                            title="Ver produtos">
                                        <i class="bi bi-box-seam"></i>
                                    </button>
                                </div>
                                {# Linha 3: Status #}
                                <span class="badge bg-{{ 'warning' if oc.status == 'ABERTA' else 'info' if oc.status == 'EM_ANALISE' else 'success' }}">
                                    {{ 'Pendente' if oc.status in ['ABERTA', 'EM_ANALISE'] else 'Resolvida' }}
                                </span>
                                {% if oc.destino and oc.destino != 'INDEFINIDO' %}
                                <small class="text-muted ms-1">{{ oc.destino }}</small>
                                {% endif %}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <!-- Coluna 6: Botoes + Data NFD + Data Entrega -->
                            <td>
                                {# Linha 1: Botoes #}
                                <div class="btn-group btn-group-sm mb-1">
                                    <a href="{{ url_for('devolucao.devolucao_ocorrencia.detalhe', ocorrencia_id=oc.id) }}"
                                       class="btn btn-outline-primary" title="Ver detalhes">
                                        Ver
                                    </a>
                                    {% if oc.nf_devolucao %}
                                    {% if oc.nf_devolucao.nfd_xml_path %}
                                    <a href="{{ url_for('devolucao.devolucao_ocorrencia.download_xml', nfd_id=oc.nf_devolucao.id) }}"
                                       class="btn btn-outline-secondary" title="Download XML" target="_blank">
                                        XML
                                    </a>
                                    {% endif %}
                                    {% if oc.nf_devolucao.nfd_pdf_path %}
                                    <a href="{{ url_for('devolucao.devolucao_ocorrencia.download_pdf', nfd_id=oc.nf_devolucao.id) }}"
                                       class="btn btn-outline-danger" title="Download PDF" target="_blank">
                                        PDF
                                    </a>
                                    {% endif %}
                                    {% endif %}
                                </div>
                                {# Linha 2: Data NFD #}
                                <br>
                                {% if oc.nf_devolucao and oc.nf_devolucao.data_emissao %}
                                <small data-bs-toggle="tooltip" title="{{ oc.nf_devolucao.data_emissao|formatar_data_hora_brasil }}">
                                    {{ oc.nf_devolucao.data_emissao|formatar_data_segura }}
                                </small>
                                {% elif oc.nf_devolucao and oc.nf_devolucao.data_registro %}
                                <small data-bs-toggle="tooltip" title="{{ oc.nf_devolucao.data_registro|formatar_data_hora_brasil }}">
                                    {{ oc.nf_devolucao.data_registro|formatar_data_segura }}
                                </small>
                                {% else %}
                                <small class="text-muted">-</small>
                                {% endif %}
                                {# Linha 3: Data Entrega #}
                                {% set datas_entrega = oc.dados_entregas|selectattr('data_entrega')|map(attribute='data_entrega')|list|sort %}
                                {% if datas_entrega %}
                                <br>
                                <small class="text-success" data-bs-toggle="tooltip" data-bs-html="true"
                                       title="{% for d in oc.dados_entregas if d.data_entrega %}NF {{ d.numero_nf }}: {{ d.data_entrega|formatar_data_segura }}<br>{% endfor %}">
                                    Ent: {{ datas_entrega[0]|formatar_data_segura }}{% if datas_entrega|length > 1 and datas_entrega[0].date() != datas_entrega[-1].date() %} - {{ datas_entrega[-1]|formatar_data_segura }}{% endif %}
                                </small>
                                {% elif oc.data_entrega_monitoramento %}
                                <br>
                                <small class="text-success">
                                    Ent: {{ oc.data_entrega_monitoramento|formatar_data_segura }}
                                </small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginacao -->
            {% if pagination.pages > 1 %}
            <nav aria-label="Paginacao">
                <ul class="pagination justify-content-center mb-0">
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('devolucao.devolucao_ocorrencia.index', page=pagination.prev_num, **filtros) }}">
                            Anterior
                        </a>
                    </li>
                    {% endif %}

                    {% for p in pagination.iter_pages() %}
                        {% if p %}
                        <li class="page-item {% if p == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('devolucao.devolucao_ocorrencia.index', page=p, **filtros) }}">
                                {{ p }}
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('devolucao.devolucao_ocorrencia.index', page=pagination.next_num, **filtros) }}">
                            Proximo
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="text-center py-5">
                <p class="text-muted mb-0">Nenhuma ocorrencia encontrada</p>
                {% if filtros.busca or filtros.status or filtros.destino or filtros.categoria or filtros.cnpj or filtros.transportadora %}
                <a href="{{ url_for('devolucao.devolucao_ocorrencia.index') }}" class="btn btn-link">
                    Limpar filtros
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Sincronizacao por Periodo -->
<div class="modal fade" id="modalSincPeriodo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sincronizar NFDs por Periodo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Data Inicio</label>
                    <input type="date" id="sinc-data-inicio" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Data Fim</label>
                    <input type="date" id="sinc-data-fim" class="form-control">
                </div>
                <div class="alert alert-info">
                    A sincronizacao ira buscar NFDs de devolucao (finnfe=4) no Odoo
                    e importar automaticamente para o sistema.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="sincronizarPeriodo()">
                    Sincronizar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Produtos da NFD -->
<div class="modal fade" id="modalProdutos" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Produtos - <span id="modal-ocorrencia-numero"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="loading-produtos" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
                <div id="lista-produtos" class="d-none">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Codigo Cliente</th>
                                <th>Descricao</th>
                                <th>Qtd</th>
                                <th>UN</th>
                                <th>Codigo Interno</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-produtos"></tbody>
                    </table>
                </div>
                <div id="erro-produtos" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast de Feedback -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastSinc" class="toast" role="alert">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitulo">Sincronizacao</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMensagem"></div>
    </div>
</div>

<!-- Overlay de Loading (bloqueia tela durante sincronizacao) -->
<div id="loadingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100"
     style="background: rgba(0,0,0,0.7); z-index: 9999;">
    <div class="d-flex flex-column justify-content-center align-items-center h-100 text-white">
        <div class="spinner-border spinner-border-lg mb-3" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <h4 id="loadingTitulo">Sincronizando com Odoo...</h4>
        <p id="loadingMensagem" class="text-center opacity-75">Aguarde, este processo pode demorar alguns minutos.<br>Nao feche ou atualize a pagina.</p>
        <div class="progress mt-3" style="width: 300px; height: 8px;">
            <div id="loadingProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 100%"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const API_SINC = '/devolucao/vinculacao/api';

// =========================================================================
// FUNCOES DE LOADING OVERLAY (bloqueia tela durante sincronizacao)
// =========================================================================
function mostrarLoading(titulo, mensagem) {
    document.getElementById('loadingTitulo').textContent = titulo || 'Sincronizando...';
    document.getElementById('loadingMensagem').innerHTML = mensagem || 'Aguarde, este processo pode demorar alguns minutos.<br>Nao feche ou atualize a pagina.';
    document.getElementById('loadingOverlay').classList.remove('d-none');
    // Prevenir scroll
    document.body.style.overflow = 'hidden';
}

function esconderLoading() {
    document.getElementById('loadingOverlay').classList.add('d-none');
    document.body.style.overflow = '';
}

function mostrarToast(titulo, mensagem, sucesso = true) {
    const toast = document.getElementById('toastSinc');
    document.getElementById('toastTitulo').textContent = titulo;
    document.getElementById('toastMensagem').innerHTML = mensagem;
    toast.classList.remove('bg-success', 'bg-danger', 'text-white');
    if (sucesso) {
        toast.classList.add('bg-success', 'text-white');
    } else {
        toast.classList.add('bg-danger', 'text-white');
    }
    new bootstrap.Toast(toast).show();
}

// =========================================================================
// FUNCOES DE SINCRONIZACAO (com loading overlay)
// =========================================================================
async function sincronizarRapido() {
    try {
        mostrarLoading('Sincronizando NFDs', 'Buscando NFDs dos ultimos 60 minutos...<br>Aguarde, nao feche a pagina.');

        const response = await fetch(`${API_SINC}/sincronizar/incremental`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        esconderLoading();

        if (data.sucesso) {
            let msg = `<strong>Sucesso!</strong><br>`;
            msg += `Processadas: ${data.nfds_processadas}<br>`;
            msg += `Novas: ${data.nfds_novas}<br>`;
            msg += `Orfas: ${data.nfds_orfas}<br>`;
            msg += `Ocorrencias criadas: ${data.ocorrencias_criadas}`;
            mostrarToast('Sincronizacao Concluida', msg, true);

            if (data.nfds_novas > 0 || data.ocorrencias_criadas > 0) {
                setTimeout(() => location.reload(), 2000);
            }
        } else {
            mostrarToast('Erro', data.erro || 'Erro na sincronizacao', false);
        }
    } catch (error) {
        esconderLoading();
        mostrarToast('Erro', error.message, false);
    }
}

async function sincronizarDias(dias) {
    try {
        mostrarLoading('Sincronizando NFDs', `Buscando NFDs dos ultimos ${dias} dias...<br>Este processo pode demorar alguns minutos.<br><strong>Nao feche ou atualize a pagina.</strong>`);

        const response = await fetch(`${API_SINC}/sincronizar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dias_retroativos: dias })
        });

        const data = await response.json();
        esconderLoading();

        if (data.sucesso) {
            let msg = `<strong>Sucesso!</strong><br>`;
            msg += `Processadas: ${data.nfds_processadas}<br>`;
            msg += `Novas: ${data.nfds_novas}<br>`;
            msg += `Orfas: ${data.nfds_orfas}<br>`;
            msg += `Ocorrencias criadas: ${data.ocorrencias_criadas}`;
            if (data.erros && data.erros > 0) {
                msg += `<br><span class="text-warning">Erros: ${data.erros}</span>`;
            }
            mostrarToast('Sincronizacao Concluida', msg, true);

            if (data.nfds_novas > 0 || data.ocorrencias_criadas > 0) {
                setTimeout(() => location.reload(), 2000);
            }
        } else {
            mostrarToast('Erro', data.erro || 'Erro na sincronizacao', false);
        }
    } catch (error) {
        esconderLoading();
        mostrarToast('Erro', error.message, false);
    }
}

async function sincronizarPeriodo() {
    const dataInicio = document.getElementById('sinc-data-inicio').value;
    const dataFim = document.getElementById('sinc-data-fim').value;

    if (!dataInicio || !dataFim) {
        alert('Informe o periodo completo');
        return;
    }

    try {
        bootstrap.Modal.getInstance(document.getElementById('modalSincPeriodo')).hide();
        mostrarLoading('Sincronizando NFDs', `Buscando NFDs de ${dataInicio} ate ${dataFim}...<br>Este processo pode demorar varios minutos.<br><strong>Nao feche ou atualize a pagina.</strong>`);

        const response = await fetch(`${API_SINC}/sincronizar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data_inicio: dataInicio,
                data_fim: dataFim
            })
        });

        const data = await response.json();
        esconderLoading();

        if (data.sucesso) {
            let msg = `<strong>Sucesso!</strong><br>`;
            msg += `Processadas: ${data.nfds_processadas}<br>`;
            msg += `Novas: ${data.nfds_novas}<br>`;
            msg += `Orfas: ${data.nfds_orfas}<br>`;
            msg += `Ocorrencias criadas: ${data.ocorrencias_criadas}`;
            if (data.erros && data.erros > 0) {
                msg += `<br><span class="text-warning">Erros: ${data.erros}</span>`;
            }
            mostrarToast('Sincronizacao Concluida', msg, true);

            if (data.nfds_novas > 0 || data.ocorrencias_criadas > 0) {
                setTimeout(() => location.reload(), 2000);
            }
        } else {
            mostrarToast('Erro', data.erro || 'Erro na sincronizacao', false);
        }
    } catch (error) {
        esconderLoading();
        mostrarToast('Erro', error.message, false);
    }
}

// Preencher data atual no modal e inicializar tooltips
document.addEventListener('DOMContentLoaded', function() {
    const hoje = new Date().toISOString().split('T')[0];
    const mesPassado = new Date();
    mesPassado.setMonth(mesPassado.getMonth() - 1);

    document.getElementById('sinc-data-inicio').value = mesPassado.toISOString().split('T')[0];
    document.getElementById('sinc-data-fim').value = hoje;

    // Inicializar tooltips do Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
