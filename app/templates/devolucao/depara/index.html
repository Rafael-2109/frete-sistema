{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>De-Para de Produtos</h2>
            <p class="text-muted mb-0">Mapeamento de codigos de produtos por cliente com IA</p>
        </div>
        <div>
            <button class="btn btn-outline-success me-2" data-bs-toggle="modal" data-bs-target="#modalImportarDePara">
                <i class="bi bi-upload"></i> Importar XLSX
            </button>
            <button class="btn btn-outline-primary me-2" onclick="exportarDePara()">
                <i class="bi bi-download"></i> Exportar XLSX
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovoDePara">
                Novo De-Para
            </button>
        </div>
    </div>

    <!-- Cards de Estatisticas -->
    <div class="row mb-4" id="cards-stats">
        <div class="col-md-3">
            <div class="card border-left-primary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Total De-Para</h6>
                    <h2 class="mb-0" id="stat-total">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-info">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Auto (IA)</h6>
                    <h2 class="mb-0" id="stat-haiku">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-secondary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Manual</h6>
                    <h2 class="mb-0" id="stat-manual">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-warning">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Linhas Pendentes</h6>
                    <h2 class="mb-0" id="stat-pendentes">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros e Busca -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0">Buscar De-Para</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Prefixo CNPJ (8 digitos)</label>
                    <input type="text" id="filtro-prefixo" class="form-control form-control-sm"
                           placeholder="Ex: 93209760" maxlength="8">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Codigo Cliente</label>
                    <input type="text" id="filtro-codigo-cliente" class="form-control form-control-sm"
                           placeholder="Buscar...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Nosso Codigo</label>
                    <input type="text" id="filtro-nosso-codigo" class="form-control form-control-sm"
                           placeholder="Buscar...">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary btn-sm me-2" onclick="buscarDePara(1)">
                        Buscar
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="limparFiltros()">
                        Limpar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela De-Para -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Mapeamentos Cadastrados</h6>
            <div class="d-flex align-items-center gap-3">
                <select id="per-page" class="form-select form-select-sm" style="width: auto;" onchange="buscarDePara(1)">
                    <option value="25">25 por página</option>
                    <option value="50" selected>50 por página</option>
                    <option value="100">100 por página</option>
                </select>
                <span class="badge bg-secondary" id="count-resultados">0 registros</span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Prefixo CNPJ</th>
                            <th>Grupo</th>
                            <th>Codigo Cliente</th>
                            <th>Descricao Cliente</th>
                            <th>Nosso Codigo</th>
                            <th>Descricao Nosso</th>
                            <th>Fator</th>
                            <th>Acoes</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-depara">
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                Carregando mapeamentos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Paginacao -->
        <div class="card-footer d-flex justify-content-between align-items-center" id="paginacao-container" style="display: none !important;">
            <div class="text-muted small" id="paginacao-info">
                Mostrando 0-0 de 0 registros
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0" id="paginacao-nav">
                </ul>
            </nav>
        </div>
    </div>

    <!-- Teste de Resolucao -->
    <div class="card mt-4">
        <div class="card-header">
            <h6 class="mb-0">Testar Resolucao com IA</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Prefixo CNPJ</label>
                    <input type="text" id="teste-prefixo" class="form-control form-control-sm"
                           placeholder="93209760" maxlength="8">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Codigo Produto</label>
                    <input type="text" id="teste-codigo" class="form-control form-control-sm"
                           placeholder="7896...">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Descricao Produto</label>
                    <input type="text" id="teste-descricao" class="form-control form-control-sm"
                           placeholder="AZEITONA VERDE FATIADA...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-info btn-sm w-100" onclick="testarResolucao()">
                        Resolver com IA
                    </button>
                </div>
            </div>

            <!-- Resultado do teste -->
            <div id="resultado-teste" class="mt-3" style="display: none;">
                <hr>
                <h6>Resultado da Resolucao:</h6>
                <div id="resultado-conteudo"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo De-Para -->
<div class="modal fade" id="modalNovoDePara" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo De-Para</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-novo-depara">
                    <div class="mb-3">
                        <label class="form-label">Prefixo CNPJ *</label>
                        <input type="text" name="prefixo_cnpj" class="form-control"
                               required maxlength="8" placeholder="8 primeiros digitos">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nome do Grupo</label>
                        <input type="text" name="nome_grupo" class="form-control"
                               placeholder="Ex: Atacadao, Carrefour...">
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Codigo Cliente *</label>
                                <input type="text" name="codigo_cliente" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nosso Codigo *</label>
                                <input type="text" name="nosso_codigo" class="form-control" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Descricao Cliente</label>
                                <input type="text" name="descricao_cliente" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Descricao Nosso</label>
                                <input type="text" name="descricao_nosso" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Fator Conversao</label>
                                <input type="number" name="fator_conversao" class="form-control"
                                       value="1" step="0.0001">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Unidade Cliente</label>
                                <input type="text" name="unidade_medida_cliente" class="form-control"
                                       placeholder="CXA, UN...">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Unidade Nossa</label>
                                <input type="text" name="unidade_medida_nosso" class="form-control"
                                       placeholder="UN, CX...">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarDePara()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Importar De-Para -->
<div class="modal fade" id="modalImportarDePara" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Importar De-Para via XLSX</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Colunas obrigatorias:</strong>
                    <ul class="mb-0 mt-2">
                        <li><code>codigo_cliente</code></li>
                        <li><code>prefixo_cnpj</code> (8 digitos)</li>
                        <li><code>nosso_codigo</code></li>
                    </ul>
                    <small class="text-muted">Descricoes serao buscadas automaticamente do cadastro.</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Arquivo XLSX</label>
                    <input type="file" id="arquivo-importacao" class="form-control" accept=".xlsx,.xls">
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="atualizar-existentes">
                    <label class="form-check-label" for="atualizar-existentes">
                        Atualizar registros existentes
                    </label>
                </div>

                <!-- Resultado da importacao -->
                <div id="resultado-importacao" style="display: none;">
                    <hr>
                    <h6>Resultado:</h6>
                    <div id="importacao-conteudo"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" onclick="importarDePara()" id="btn-importar">
                    Importar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const API_BASE = '/devolucao/ai/api';
let paginaAtual = 1;
let totalPaginas = 1;

// Carregar estatisticas e registros ao iniciar
document.addEventListener('DOMContentLoaded', function() {
    carregarEstatisticas();
    // Carregar todos os De-Para automaticamente
    buscarDePara(1);
});

async function carregarEstatisticas() {
    try {
        const response = await fetch(`${API_BASE}/estatisticas`);
        const data = await response.json();

        if (data.sucesso) {
            document.getElementById('stat-total').textContent = data.estatisticas.depara.total;
            document.getElementById('stat-haiku').textContent = data.estatisticas.depara.auto_haiku;
            document.getElementById('stat-manual').textContent = data.estatisticas.depara.manual;
            document.getElementById('stat-pendentes').textContent = data.estatisticas.linhas.pendentes;
        }
    } catch (error) {
        console.error('Erro ao carregar estatisticas:', error);
    }
}

async function buscarDePara(page = 1) {
    const prefixo = document.getElementById('filtro-prefixo').value;
    const codigoCliente = document.getElementById('filtro-codigo-cliente').value;
    const nossoCodigo = document.getElementById('filtro-nosso-codigo').value;
    const perPage = document.getElementById('per-page').value;

    let url = `${API_BASE}/depara?page=${page}&per_page=${perPage}`;
    if (prefixo) url += `&prefixo_cnpj=${prefixo}`;
    if (codigoCliente) url += `&codigo_cliente=${codigoCliente}`;
    if (nossoCodigo) url += `&nosso_codigo=${nossoCodigo}`;

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.sucesso) {
            paginaAtual = data.page;
            totalPaginas = data.total_pages;

            renderizarTabela(data.depara);
            renderizarPaginacao(data);
            document.getElementById('count-resultados').textContent = `${data.total} registros`;
        } else {
            alert('Erro: ' + data.erro);
        }
    } catch (error) {
        console.error('Erro ao buscar:', error);
        alert('Erro ao buscar De-Para');
    }
}

function renderizarPaginacao(data) {
    const container = document.getElementById('paginacao-container');
    const infoEl = document.getElementById('paginacao-info');
    const navEl = document.getElementById('paginacao-nav');

    if (data.total === 0) {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'flex';

    // Info de registros
    const inicio = (data.page - 1) * data.per_page + 1;
    const fim = Math.min(data.page * data.per_page, data.total);
    infoEl.textContent = `Mostrando ${inicio}-${fim} de ${data.total} registros`;

    // Botoes de paginacao
    let html = '';

    // Botao Anterior
    html += `
        <li class="page-item ${!data.has_prev ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="irParaPagina(${data.page - 1}); return false;">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
    `;

    // Numeros das paginas
    const maxPaginas = 5;
    let inicio_pag = Math.max(1, data.page - Math.floor(maxPaginas / 2));
    let fim_pag = Math.min(data.total_pages, inicio_pag + maxPaginas - 1);

    if (fim_pag - inicio_pag < maxPaginas - 1) {
        inicio_pag = Math.max(1, fim_pag - maxPaginas + 1);
    }

    if (inicio_pag > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="irParaPagina(1); return false;">1</a></li>`;
        if (inicio_pag > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }

    for (let i = inicio_pag; i <= fim_pag; i++) {
        html += `
            <li class="page-item ${i === data.page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="irParaPagina(${i}); return false;">${i}</a>
            </li>
        `;
    }

    if (fim_pag < data.total_pages) {
        if (fim_pag < data.total_pages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="irParaPagina(${data.total_pages}); return false;">${data.total_pages}</a></li>`;
    }

    // Botao Proximo
    html += `
        <li class="page-item ${!data.has_next ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="irParaPagina(${data.page + 1}); return false;">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
    `;

    navEl.innerHTML = html;
}

function irParaPagina(page) {
    if (page < 1 || page > totalPaginas) return;
    buscarDePara(page);
}

function renderizarTabela(items) {
    const tbody = document.getElementById('tabela-depara');

    if (items.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    Nenhum registro encontrado
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = items.map(item => `
        <tr>
            <td><code>${item.prefixo_cnpj}</code></td>
            <td>${item.nome_grupo || '-'}</td>
            <td><strong>${item.codigo_cliente}</strong></td>
            <td class="text-muted small">${item.descricao_cliente || '-'}</td>
            <td><strong class="text-primary">${item.nosso_codigo}</strong></td>
            <td class="text-muted small">${item.descricao_nosso || '-'}</td>
            <td>${item.fator_conversao}</td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="excluirDePara(${item.id})">
                    Excluir
                </button>
            </td>
        </tr>
    `).join('');
}

function limparFiltros() {
    document.getElementById('filtro-prefixo').value = '';
    document.getElementById('filtro-codigo-cliente').value = '';
    document.getElementById('filtro-nosso-codigo').value = '';
    // Recarregar todos os registros (volta para pagina 1)
    buscarDePara(1);
}

async function testarResolucao() {
    const prefixo = document.getElementById('teste-prefixo').value;
    const codigo = document.getElementById('teste-codigo').value;
    const descricao = document.getElementById('teste-descricao').value;

    if (!descricao && !codigo) {
        alert('Informe ao menos o codigo ou descricao do produto');
        return;
    }

    const resultadoDiv = document.getElementById('resultado-teste');
    const conteudoDiv = document.getElementById('resultado-conteudo');

    conteudoDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Consultando IA...</div>';
    resultadoDiv.style.display = 'block';

    try {
        const response = await fetch(`${API_BASE}/resolver-produto`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prefixo_cnpj: prefixo,
                codigo_cliente: codigo,
                descricao_cliente: descricao
            })
        });

        const data = await response.json();

        if (data.sucesso) {
            const confiancaClass = data.confianca >= 0.9 ? 'text-success' :
                                   data.confianca >= 0.5 ? 'text-warning' : 'text-danger';
            const confiancaText = (data.confianca * 100).toFixed(0) + '%';

            let html = `
                <div class="alert ${data.requer_confirmacao ? 'alert-warning' : 'alert-success'}">
                    <strong>Confianca: <span class="${confiancaClass}">${confiancaText}</span></strong>
                    ${data.requer_confirmacao ? '<span class="badge bg-warning ms-2">Requer Confirmacao</span>' : ''}
                </div>
            `;

            if (data.sugestao_principal) {
                html += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6 class="card-title">Sugestao Principal</h6>
                            <p class="mb-1">
                                <strong>${data.sugestao_principal.codigo}</strong> - ${data.sugestao_principal.nome}
                            </p>
                            <small class="text-muted">${data.sugestao_principal.justificativa}</small>
                        </div>
                    </div>
                `;
            }

            if (data.outras_sugestoes && data.outras_sugestoes.length > 0) {
                html += '<h6 class="mt-3">Outras Opcoes:</h6><ul class="list-group">';
                data.outras_sugestoes.forEach(s => {
                    html += `
                        <li class="list-group-item d-flex justify-content-between">
                            <span>${s.codigo} - ${s.nome}</span>
                            <span class="badge bg-secondary">${(s.confianca * 100).toFixed(0)}%</span>
                        </li>
                    `;
                });
                html += '</ul>';
            }

            conteudoDiv.innerHTML = html;
        } else {
            conteudoDiv.innerHTML = `<div class="alert alert-danger">Erro: ${data.erro}</div>`;
        }
    } catch (error) {
        console.error('Erro:', error);
        conteudoDiv.innerHTML = `<div class="alert alert-danger">Erro ao consultar IA</div>`;
    }
}

async function salvarDePara() {
    const form = document.getElementById('form-novo-depara');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
        const response = await fetch(`${API_BASE}/depara`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.sucesso) {
            alert('De-Para salvo com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('modalNovoDePara')).hide();
            form.reset();
            carregarEstatisticas();
        } else {
            alert('Erro: ' + result.erro);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar De-Para');
    }
}

async function excluirDePara(id) {
    if (!confirm('Deseja realmente excluir este De-Para?')) return;

    try {
        const response = await fetch(`${API_BASE}/depara/${id}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.sucesso) {
            buscarDePara(); // Recarregar tabela
            carregarEstatisticas();
        } else {
            alert('Erro: ' + result.erro);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao excluir');
    }
}

async function importarDePara() {
    const fileInput = document.getElementById('arquivo-importacao');
    const atualizarExistentes = document.getElementById('atualizar-existentes').checked;
    const resultadoDiv = document.getElementById('resultado-importacao');
    const conteudoDiv = document.getElementById('importacao-conteudo');
    const btnImportar = document.getElementById('btn-importar');

    if (!fileInput.files.length) {
        alert('Selecione um arquivo XLSX');
        return;
    }

    const formData = new FormData();
    formData.append('arquivo', fileInput.files[0]);
    formData.append('atualizar_existentes', atualizarExistentes);

    btnImportar.disabled = true;
    btnImportar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Importando...';
    conteudoDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Processando...</div>';
    resultadoDiv.style.display = 'block';

    try {
        const response = await fetch(`${API_BASE}/depara/importar`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.sucesso) {
            let html = `
                <div class="alert alert-success">
                    <strong>Importacao concluida!</strong>
                </div>
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between">
                        Criados <span class="badge bg-success">${result.criados}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        Atualizados <span class="badge bg-info">${result.atualizados}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        Ignorados <span class="badge bg-secondary">${result.ignorados}</span>
                    </li>
                </ul>
            `;

            if (result.erros && result.erros.length > 0) {
                html += `
                    <div class="alert alert-warning mt-3">
                        <strong>Erros (${result.erros.length}):</strong>
                        <ul class="mb-0 small">
                            ${result.erros.slice(0, 10).map(e => `<li>${e}</li>`).join('')}
                            ${result.erros.length > 10 ? `<li>... e mais ${result.erros.length - 10}</li>` : ''}
                        </ul>
                    </div>
                `;
            }

            conteudoDiv.innerHTML = html;
            carregarEstatisticas();
        } else {
            conteudoDiv.innerHTML = `<div class="alert alert-danger">Erro: ${result.erro}</div>`;
        }
    } catch (error) {
        console.error('Erro:', error);
        conteudoDiv.innerHTML = `<div class="alert alert-danger">Erro ao importar arquivo</div>`;
    } finally {
        btnImportar.disabled = false;
        btnImportar.innerHTML = 'Importar';
    }
}

async function exportarDePara() {
    const prefixo = document.getElementById('filtro-prefixo').value;

    let url = `${API_BASE}/depara/exportar`;
    if (prefixo) url += `?prefixo_cnpj=${prefixo}`;

    try {
        const response = await fetch(url);

        if (!response.ok) {
            const result = await response.json();
            alert('Erro: ' + result.erro);
            return;
        }

        // Download do arquivo
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `depara_produtos_${new Date().toISOString().slice(0,10)}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(downloadUrl);
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao exportar De-Para');
    }
}
</script>
{% endblock %}
