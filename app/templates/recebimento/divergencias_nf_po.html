{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-exclamation-triangle text-warning me-2"></i>Divergencias NF x PO</h2>
            <p class="text-muted mb-0">Pendencias de vinculacao entre NF-e e Pedidos de Compra</p>
        </div>
        <div>
            <a href="{{ url_for('recebimento_views.validacoes_nf_po') }}" class="btn btn-outline-info me-2">
                <i class="fas fa-list"></i> Ver Validacoes
            </a>
            <button type="button" class="btn btn-outline-primary" id="btnExecutarValidacao" onclick="executarValidacao()">
                <i class="fas fa-sync-alt"></i> Executar Validação
            </button>
        </div>
    </div>

    <!-- Cards de Estatisticas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-left-warning">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Pendentes</h6>
                    <h2 class="mb-0 text-warning">{{ stats.pendente }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-success">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Aprovadas</h6>
                    <h2 class="mb-0 text-success">{{ stats.aprovada }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-danger">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Rejeitadas</h6>
                    <h2 class="mb-0 text-danger">{{ stats.rejeitada }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h6>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('recebimento_views.divergencias_nf_po') }}">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            <option value="pendente" {% if filtros.status == 'pendente' %}selected{% endif %}>Pendentes</option>
                            <option value="aprovada" {% if filtros.status == 'aprovada' %}selected{% endif %}>Aprovadas</option>
                            <option value="rejeitada" {% if filtros.status == 'rejeitada' %}selected{% endif %}>Rejeitadas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tipo Divergencia</label>
                        <select name="tipo" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            {% for tipo in tipos_divergencia %}
                            <option value="{{ tipo.valor }}" {% if filtros.tipo == tipo.valor %}selected{% endif %}>
                                {{ tipo.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">CNPJ Fornecedor</label>
                        <input type="text" name="cnpj" class="form-control form-control-sm"
                               value="{{ filtros.cnpj }}" placeholder="Digite o CNPJ...">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm me-2">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <a href="{{ url_for('recebimento_views.divergencias_nf_po') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-times"></i> Limpar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">Data / NF</th>
                            <th>Empresa</th>
                            <th>Fornecedor</th>
                            <th>Produto</th>
                            <th class="text-center">Qtd</th>
                            <th class="text-center">Preco</th>
                            <th class="text-center">Valor</th>
                            <th class="text-center">Tipo/Status</th>
                            <th>NF vs PO</th>
                            <th class="text-center" style="width: 180px;">Acoes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr data-id="{{ item.id }}"
                            data-numero-nf="{{ item.numero_nf or '' }}"
                            data-qtd-nf="{{ item.qtd_nf or '' }}"
                            data-preco-nf="{{ item.preco_nf or '' }}"
                            data-um-nf="{{ item.um_nf or '' }}"
                            data-fator-conversao="{{ item.fator_conversao or 1 }}"
                            data-cod-produto-fornecedor="{{ item.cod_produto_fornecedor or '' }}"
                            data-nome-produto="{{ item.nome_produto or '' }}"
                            data-razao-fornecedor="{{ item.razao_fornecedor or '' }}"
                            data-cnpj-fornecedor="{{ item.cnpj_fornecedor or '' }}"
                            data-tipo-divergencia="{{ item.tipo_divergencia }}"
                            data-valor-nf="{{ item.valor_nf or '' }}"
                            data-valor-po="{{ item.valor_po or '' }}"
                            data-odoo-po-name="{{ item.odoo_po_name or '' }}">
                            <!-- Data / NF -->
                            <td class="text-center">
                                <small class="text-muted">{{ item.data_nf.strftime('%d/%m/%Y') if item.data_nf else 'N/A' }}</small>
                                <br><strong class="text-primary">{{ item.numero_nf or '-' }}</strong>
                                <br>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ odoo_base_url }}#id={{ item.odoo_dfe_id }}&model=l10n_br_ciel_it_account.dfe&view_type=form"
                                       target="_blank"
                                       class="btn btn-outline-secondary btn-sm"
                                       title="Abrir no Odoo">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-outline-secondary btn-sm"
                                            onclick="downloadXml({{ item.odoo_dfe_id }})"
                                            title="Download XML">
                                        <i class="fas fa-file-code"></i>
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-secondary btn-sm"
                                            onclick="downloadPdf({{ item.odoo_dfe_id }})"
                                            title="Download DANFE">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                </div>
                            </td>
                            <!-- Empresa Compradora -->
                            <td>
                                <strong>{{ (item.razao_empresa_compradora or 'N/A')|truncate(20) }}</strong>
                                <br><small class="text-muted">{{ item.cnpj_empresa_compradora|formatar_cnpj if item.cnpj_empresa_compradora else '-' }}</small>
                            </td>
                            <!-- Fornecedor -->
                            <td>
                                <strong>{{ (item.razao_fornecedor or 'N/A')|truncate(20) }}</strong>
                                <br><small class="text-muted">{{ item.cnpj_fornecedor|formatar_cnpj if item.cnpj_fornecedor else '-' }}</small>
                            </td>
                            <!-- Produto -->
                            <td>
                                <code>{{ item.cod_produto_fornecedor or 'N/A' }}</code>
                                {% if item.cod_produto_interno %}
                                <i class="fas fa-arrow-right text-muted mx-1"></i>
                                <code class="text-success">{{ item.cod_produto_interno }}</code>
                                {% endif %}
                                <br><small class="text-muted">{{ item.nome_produto or 'N/A' }}</small>
                            </td>
                            <!-- Qtd -->
                            <td class="text-center" style="font-size: 0.85em;">
                                {% if item.qtd_nf %}
                                    {% if item.cod_produto_interno and item.fator_conversao and item.fator_conversao > 1 %}
                                    {# Item com De-Para e fator > 1: mostra NF original e Odoo convertido #}
                                    {# qtd_nf JA ESTA CONVERTIDO, entao NF original = qtd_nf / fator #}
                                    <div><small class="text-muted">NF:</small> <strong>{{ (item.qtd_nf / item.fator_conversao)|numero_br(3) }}</strong> <small>{{ item.um_nf or '' }}</small></div>
                                    <div><small class="text-muted">Odoo:</small> <strong class="text-success">{{ item.qtd_nf|numero_br(3) }}</strong> <small>UN</small></div>
                                    {% else %}
                                    {# Sem De-Para ou fator = 1: mostra apenas valor #}
                                    <strong>{{ item.qtd_nf|numero_br(3) }}</strong>
                                    {% if item.um_nf %}<small class="text-muted">{{ item.um_nf }}</small>{% endif %}
                                    {% endif %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <!-- Preco -->
                            <td class="text-center" style="font-size: 0.85em;">
                                {% if item.preco_nf %}
                                    {% if item.cod_produto_interno and item.fator_conversao and item.fator_conversao > 1 %}
                                    {# Item com De-Para e fator > 1: mostra NF original e convertido #}
                                    {# preco_nf JA ESTA CONVERTIDO, entao NF original = preco_nf * fator #}
                                    <div><small class="text-muted">NF:</small> <strong>R$ {{ (item.preco_nf * item.fator_conversao)|numero_br(4) }}</strong></div>
                                    <div><small class="text-muted">Odoo:</small> <strong class="text-success">R$ {{ item.preco_nf|numero_br(4) }}</strong></div>
                                    {% else %}
                                    {# Sem De-Para ou fator = 1: mostra apenas valor #}
                                    <strong>R$ {{ item.preco_nf|numero_br(4) }}</strong>
                                    {% endif %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <!-- Valor Total -->
                            <td class="text-center" style="font-size: 0.85em;">
                                {% if item.qtd_nf and item.preco_nf %}
                                {# Valor total = qtd original NF * preco original NF #}
                                {# Se tem fator: (qtd_nf/fator) * (preco_nf*fator) = qtd_nf * preco_nf #}
                                <strong class="text-primary">R$ {{ (item.qtd_nf * item.preco_nf)|numero_br(2) }}</strong>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <!-- Tipo + Status (agrupados) -->
                            <td class="text-center">
                                <!-- Tipo Divergencia -->
                                {% if item.tipo_divergencia == 'sem_depara' %}
                                <span class="badge bg-secondary">Sem De-Para</span>
                                {% elif item.tipo_divergencia == 'sem_po' %}
                                <span class="badge bg-secondary">Sem PO</span>
                                {% elif item.tipo_divergencia == 'preco' %}
                                <span class="badge bg-danger">Preco</span>
                                {% elif item.tipo_divergencia == 'quantidade' %}
                                <span class="badge bg-warning text-dark">Quantidade</span>
                                {% elif item.tipo_divergencia == 'data_entrega' %}
                                <span class="badge bg-warning text-dark">Data</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ item.tipo_divergencia }}</span>
                                {% endif %}
                                <br>
                                <!-- Status -->
                                {% if item.status == 'pendente' %}
                                <span class="badge bg-warning text-dark mt-1">Pendente</span>
                                {% elif item.status == 'aprovada' %}
                                <span class="badge bg-success mt-1">Aprovada</span>
                                {% elif item.status == 'rejeitada' %}
                                <span class="badge bg-danger mt-1">Rejeitada</span>
                                {% else %}
                                <span class="badge bg-secondary mt-1">{{ item.status }}</span>
                                {% endif %}
                            </td>
                            <!-- NF vs PO (NF acima, PO abaixo) -->
                            <td>
                                <div>
                                    <small class="text-muted">NF:</small>
                                    <strong>{{ item.valor_nf or 'N/A' }}</strong>
                                </div>
                                <div>
                                    <small class="text-muted">PO:</small>
                                    <strong>{{ item.valor_po or 'N/A' }}</strong>
                                </div>
                                {% if item.diferenca_percentual %}
                                <small class="text-danger">Dif: {{ item.diferenca_percentual }}%</small>
                                {% endif %}
                                {% if item.odoo_po_name %}
                                <br><small class="text-muted">{{ item.odoo_po_name }}</small>
                                {% endif %}
                            </td>
                            <!-- Acoes (controlado por tipo de divergencia) -->
                            <td class="text-center">
                                {% if item.status == 'pendente' %}
                                {# Definir quais tipos podem ser aprovados manualmente #}
                                {% set pode_aprovar = item.tipo_divergencia in ['quantidade_tolerancia', 'data_entrega'] %}

                                <div class="btn-group btn-group-sm">
                                    {# TIPO: sem_depara - Mostrar apenas botao Criar De-Para #}
                                    {% if item.tipo_divergencia == 'sem_depara' %}
                                    <button class="btn btn-primary" onclick="criarDepara({{ item.id }})"
                                            title="Criar De-Para para este produto">
                                        <i class="fas fa-exchange-alt"></i> De-Para
                                    </button>

                                    {# TIPO: sem_po - Mostrar botao Ver POs e link Odoo #}
                                    {% elif item.tipo_divergencia == 'sem_po' %}
                                    <button class="btn btn-info" onclick="verPosCandidatos({{ item.odoo_dfe_id }})"
                                            title="Ver POs candidatos do fornecedor">
                                        <i class="fas fa-search"></i> Ver POs
                                    </button>
                                    <a href="{{ odoo_base_url }}#action=395&model=purchase.order&view_type=list"
                                       target="_blank"
                                       class="btn btn-outline-secondary"
                                       title="Criar PO no Odoo">
                                        <i class="fas fa-plus"></i>
                                    </a>

                                    {# TIPO: preco - Mostrar Ver POs e link Odoo #}
                                    {% elif item.tipo_divergencia == 'preco' %}
                                    <button class="btn btn-info btn-sm" onclick="verPosCandidatos({{ item.odoo_dfe_id }})"
                                            title="Ver POs candidatos">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    {% if item.odoo_po_id %}
                                    <a href="{{ odoo_base_url }}#id={{ item.odoo_po_id }}&model=purchase.order&view_type=form"
                                       target="_blank"
                                       class="btn btn-outline-secondary btn-sm"
                                       title="Editar PO no Odoo">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}

                                    {# TIPO: quantidade (>10%) - Mostrar Ver POs e link Odoo #}
                                    {% elif item.tipo_divergencia == 'quantidade' %}
                                    <button class="btn btn-info btn-sm" onclick="verPosCandidatos({{ item.odoo_dfe_id }})"
                                            title="Ver POs candidatos">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    {% if item.odoo_po_id %}
                                    <a href="{{ odoo_base_url }}#id={{ item.odoo_po_id }}&model=purchase.order&view_type=form"
                                       target="_blank"
                                       class="btn btn-outline-secondary btn-sm"
                                       title="Editar PO no Odoo">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}

                                    {# TIPOS APROVAVEIS: quantidade_tolerancia, data_entrega #}
                                    {% elif pode_aprovar %}
                                    <button class="btn btn-success" onclick="abrirModalAprovar({{ item.id }})"
                                            title="Aprovar divergencia">
                                        <i class="fas fa-check"></i> Aprovar
                                    </button>
                                    <button class="btn btn-danger" onclick="rejeitarDivergencia({{ item.id }})"
                                            title="Rejeitar">
                                        <i class="fas fa-times"></i>
                                    </button>

                                    {# OUTROS TIPOS - Fallback #}
                                    {% else %}
                                    <button class="btn btn-outline-secondary" disabled
                                            title="Este tipo de divergencia requer acao especifica">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                {% else %}
                                <small class="text-muted">
                                    {{ item.resolucao }}<br>
                                    {% if item.resolvido_por %}por {{ item.resolvido_por }}{% endif %}
                                </small>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center text-muted py-4">
                                <i class="fas fa-check-circle fa-3x mb-3 d-block text-success"></i>
                                Nenhuma divergencia encontrada
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Paginacao -->
    {% if paginacao.pages > 1 %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if paginacao.page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page={{ paginacao.page - 1 }}&status={{ filtros.status }}&tipo={{ filtros.tipo }}&cnpj={{ filtros.cnpj }}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            {% for p in range(1, paginacao.pages + 1) %}
            <li class="page-item {% if p == paginacao.page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}&status={{ filtros.status }}&tipo={{ filtros.tipo }}&cnpj={{ filtros.cnpj }}">{{ p }}</a>
            </li>
            {% endfor %}

            {% if paginacao.page < paginacao.pages %}
            <li class="page-item">
                <a class="page-link" href="?page={{ paginacao.page + 1 }}&status={{ filtros.status }}&tipo={{ filtros.tipo }}&cnpj={{ filtros.cnpj }}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Modal Criar De-Para -->
<div class="modal fade" id="modalCriarDepara" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Criar De-Para</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="divergenciaId">

                <!-- Dados da NF (readonly) -->
                <div class="card mb-3 border-secondary">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Dados da NF (Origem)</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">Codigo Fornecedor:</small></p>
                                <p class="fw-bold" id="nfCodProdutoFornecedor">-</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">Descricao:</small></p>
                                <p class="fw-bold" id="nfNomeProduto">-</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <p class="mb-1"><small class="text-muted">Quantidade:</small></p>
                                <p class="fw-bold text-primary" id="nfQuantidade">-</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1"><small class="text-muted">Preco Unitario:</small></p>
                                <p class="fw-bold text-primary" id="nfPreco">-</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1"><small class="text-muted">UM Fornecedor:</small></p>
                                <p class="fw-bold" id="nfUmFornecedor">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulario De-Para -->
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-arrow-right me-2"></i>Produto Interno (Destino)</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Codigo Produto Interno *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="codProdutoInternoModal" required
                                       placeholder="Digite o codigo interno...">
                                <button class="btn btn-outline-secondary" type="button" onclick="buscarProdutoOdooModal()">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                            <small class="text-muted">Digite o codigo e clique em Buscar para validar</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Nome Produto</label>
                            <input type="text" class="form-control" id="nomeProdutoInternoModal" readonly>
                        </div>

                        <input type="hidden" id="odooProductIdModal">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">UM Fornecedor</label>
                                    <input type="text" class="form-control" id="umFornecedorModal" readonly>
                                    <small class="text-muted">Preenchido automaticamente da NF</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fator Conversao</label>
                                    <input type="number" class="form-control" id="fatorConversaoModal" value="1" step="0.0001" min="0.0001">
                                    <small class="text-muted">Ex: 1000 se UM=Milhar</small>
                                </div>
                            </div>
                        </div>

                        <!-- Simulacao de Conversao -->
                        <div class="alert alert-secondary mb-3" id="simulacaoConversao" style="display: none;">
                            <h6 class="alert-heading"><i class="fas fa-calculator me-2"></i>Simulacao da Conversao</h6>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">Quantidade Original:</small>
                                    <p class="mb-0 fw-bold" id="simQtdOriginal">-</p>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Quantidade Convertida:</small>
                                    <p class="mb-0 fw-bold text-success" id="simQtdConvertida">-</p>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <small class="text-muted">Preco Original:</small>
                                    <p class="mb-0 fw-bold" id="simPrecoOriginal">-</p>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Preco Convertido:</small>
                                    <p class="mb-0 fw-bold text-success" id="simPrecoConvertido">-</p>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Justificativa</label>
                            <textarea class="form-control" id="justificativaModal" rows="2"
                                      placeholder="Motivo da criacao do De-Para..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarCriarDepara()">
                    <i class="fas fa-exchange-alt"></i> Criar De-Para
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver POs Candidatos -->
<div class="modal fade" id="modalPosCandidatos" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-shopping-cart me-2"></i>POs Candidatos para esta NF</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Dados da NF -->
                <div class="card mb-3">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Dados da NF</h6>
                        <span class="badge bg-primary" id="posNfNumero">-</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">Comprado por:</small>
                                <p class="fw-bold mb-0" id="posEmpresa">-</p>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Fornecedor:</small>
                                <p class="fw-bold mb-0" id="posFornecedor">-</p>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Data Emissao:</small>
                                <p class="fw-bold mb-0" id="posDataEmissao">-</p>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Valor Total:</small>
                                <p class="fw-bold mb-0 text-primary" id="posValorTotal">-</p>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Itens:</small>
                                <p class="fw-bold mb-0" id="posQtdItens">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumo do Match -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card border-primary h-100">
                            <div class="card-body text-center py-2">
                                <small class="text-muted d-block">Itens NF</small>
                                <span class="fs-4 fw-bold text-primary" id="resumoItensNf">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success h-100">
                            <div class="card-body text-center py-2">
                                <small class="text-muted d-block">Com De-Para</small>
                                <span class="fs-4 fw-bold text-success" id="resumoItensDepara">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-info h-100">
                            <div class="card-body text-center py-2">
                                <small class="text-muted d-block">Com PO Match</small>
                                <span class="fs-4 fw-bold text-info" id="resumoItensComPo">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning h-100">
                            <div class="card-body text-center py-2">
                                <small class="text-muted d-block">POs Candidatos</small>
                                <span class="fs-4 fw-bold text-warning" id="resumoPosCandidatos">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Itens da NF -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Itens da NF (valores originais e convertidos)</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th rowspan="2">#</th>
                                        <th rowspan="2">Cod Forn</th>
                                        <th rowspan="2">Descricao</th>
                                        <th colspan="2" class="text-center bg-light">Original (NF)</th>
                                        <th colspan="2" class="text-center bg-info text-white">Convertido</th>
                                        <th rowspan="2">De-Para</th>
                                        <th rowspan="2">Match</th>
                                    </tr>
                                    <tr>
                                        <th class="text-end">Qtd</th>
                                        <th class="text-end">Preco</th>
                                        <th class="text-end">Qtd</th>
                                        <th class="text-end">Preco</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaItensNf">
                                    <tr><td colspan="9" class="text-center py-3">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- POs Candidatos com Comparacao -->
                <div class="card">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>POs Candidatos - Comparacao NF vs PO</h6>
                        <small class="badge bg-dark">Tolerancia: 5%</small>
                    </div>
                    <div class="card-body p-0">
                        <div id="listaPosCandidatos" style="max-height: 450px; overflow-y: auto;">
                            <div class="text-center py-3">Carregando...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Aprovar Divergencia -->
<div class="modal fade" id="modalAprovar" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Confirmar Aprovacao</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="aprovarDivergenciaId">

                <!-- Resumo da Divergencia -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Resumo da Divergencia</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">NF:</small></p>
                                <p class="fw-bold" id="aprovarNumeroNf">-</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">Tipo Divergencia:</small></p>
                                <p id="aprovarTipoDivergencia">-</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <p class="mb-1"><small class="text-muted">Fornecedor:</small></p>
                                <p class="fw-bold" id="aprovarFornecedor">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Produto -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-box me-2"></i>Produto</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">Codigo Fornecedor:</small></p>
                                <p class="fw-bold" id="aprovarCodFornecedor">-</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">Codigo Interno:</small></p>
                                <p class="fw-bold" id="aprovarCodInterno">-</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <p class="mb-1"><small class="text-muted">Nome:</small></p>
                                <p class="fw-bold" id="aprovarNomeProduto">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparacao NF vs PO -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-balance-scale me-2"></i>NF vs PO</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 border-end">
                                <h6 class="text-center text-primary">Valor NF</h6>
                                <p class="text-center fw-bold fs-5" id="aprovarValorNf">-</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-center text-secondary">Valor PO</h6>
                                <p class="text-center fw-bold fs-5" id="aprovarValorPo">-</p>
                            </div>
                        </div>
                        <div class="row" id="aprovarDiferencaRow" style="display: none;">
                            <div class="col-12 text-center">
                                <span class="badge bg-danger fs-6" id="aprovarDiferenca">-</span>
                            </div>
                        </div>
                        <div class="row mt-2" id="aprovarPoNameRow" style="display: none;">
                            <div class="col-12 text-center">
                                <small class="text-muted">PO: <span id="aprovarPoName">-</span></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Justificativa -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Justificativa da Aprovacao *</label>
                    <textarea class="form-control" id="aprovarJustificativa" rows="3"
                              placeholder="Informe o motivo da aprovacao..." required></textarea>
                    <small class="text-muted">A justificativa e obrigatoria para aprovacao</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmarAprovar()">
                    <i class="fas fa-check"></i> Confirmar Aprovacao
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript externo -->
<script src="{{ url_for('static', filename='js/recebimento/divergencias_nf_po.js') }}"></script>
{% endblock %}
