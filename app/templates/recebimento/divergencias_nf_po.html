{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-exclamation-triangle text-warning me-2"></i>Divergencias NF x PO</h2>
            <p class="text-muted mb-0">Pendencias de vinculacao entre NF-e e Pedidos de Compra</p>
        </div>
        <div>
            <a href="{{ url_for('recebimento_views.validacoes_nf_po') }}" class="btn btn-outline-info me-2">
                <i class="fas fa-list"></i> Ver Validacoes
            </a>
            <button type="button" class="btn btn-outline-primary" id="btnExecutarValidacao"
                    data-bs-toggle="modal" data-bs-target="#modalValidacao">
                <i class="fas fa-sync-alt"></i> Executar Validação
            </button>
        </div>
    </div>

    <!-- Cards de Estatisticas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-left-warning">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Pendentes</h6>
                    <h2 class="mb-0 text-warning">{{ stats.pendente }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-success">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Aprovadas</h6>
                    <h2 class="mb-0 text-success">{{ stats.aprovada }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-danger">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Rejeitadas</h6>
                    <h2 class="mb-0 text-danger">{{ stats.rejeitada }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h6>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('recebimento_views.divergencias_nf_po') }}">
                <div class="row g-2">
                    <!-- Linha 1: Status, Tipo, NF, CNPJ Fornecedor -->
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            <option value="pendente" {% if filtros.status == 'pendente' %}selected{% endif %}>Pendentes</option>
                            <option value="aprovada" {% if filtros.status == 'aprovada' %}selected{% endif %}>Aprovadas</option>
                            <option value="rejeitada" {% if filtros.status == 'rejeitada' %}selected{% endif %}>Rejeitadas</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Tipo Divergencia</label>
                        <select name="tipo" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            {% for tipo in tipos_divergencia %}
                            <option value="{{ tipo.valor }}" {% if filtros.tipo == tipo.valor %}selected{% endif %}>
                                {{ tipo.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">NF</label>
                        <input type="text" name="numero_nf" class="form-control form-control-sm"
                               value="{{ filtros.numero_nf }}" placeholder="Numero...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">CNPJ Fornecedor</label>
                        <input type="text" name="cnpj" class="form-control form-control-sm"
                               value="{{ filtros.cnpj }}" placeholder="CNPJ...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Nome Fornecedor</label>
                        <input type="text" name="nome_fornecedor" class="form-control form-control-sm"
                               value="{{ filtros.nome_fornecedor }}" placeholder="Razao social...">
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <!-- Linha 2: Produto (autocomplete), Empresa, Botoes -->
                    <div class="col-md-4">
                        <label class="form-label">Produto (Codigo/Nome)</label>
                        <div class="position-relative">
                            <input type="text" name="cod_produto" id="filtro_produto"
                                   class="form-control form-control-sm"
                                   value="{{ filtros.cod_produto }}"
                                   placeholder="Digite codigo ou nome..."
                                   autocomplete="off">
                            <div id="autocomplete_produtos" class="list-group position-absolute w-100 shadow-sm"
                                 style="z-index: 1050; display: none; max-height: 250px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Empresa</label>
                        <select name="empresa" class="form-select form-select-sm">
                            <option value="">Todas</option>
                            {% for e in empresas_opcoes %}
                            <option value="{{ e.cnpj }}" {% if filtros.empresa == e.cnpj %}selected{% endif %}>
                                {{ e.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-5 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm me-2">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <a href="{{ url_for('recebimento_views.divergencias_nf_po') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-times"></i> Limpar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">Data / NF</th>
                            <th>Empresa</th>
                            <th>Fornecedor</th>
                            <th>Produto</th>
                            <th class="text-center">Qtd</th>
                            <th class="text-center">Preco</th>
                            <th class="text-center">Valor</th>
                            <th class="text-center">Tipo/Status</th>
                            <th>NF vs PO</th>
                            <th class="text-center" style="width: 180px;">Acoes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr data-id="{{ item.id }}"
                            data-numero-nf="{{ item.numero_nf or '' }}"
                            data-qtd-nf="{{ item.qtd_nf or '' }}"
                            data-preco-nf="{{ item.preco_nf or '' }}"
                            data-um-nf="{{ item.um_nf or '' }}"
                            data-fator-conversao="{{ item.fator_conversao or 1 }}"
                            data-cod-produto-fornecedor="{{ item.cod_produto_fornecedor or '' }}"
                            data-nome-produto="{{ item.nome_produto or '' }}"
                            data-razao-fornecedor="{{ item.razao_fornecedor or '' }}"
                            data-cnpj-fornecedor="{{ item.cnpj_fornecedor or '' }}"
                            data-tipo-divergencia="{{ item.tipo_divergencia }}"
                            data-valor-nf="{{ item.valor_nf or '' }}"
                            data-valor-po="{{ item.valor_po or '' }}"
                            data-odoo-po-name="{{ item.odoo_po_name or '' }}">
                            <!-- Data / NF -->
                            <td class="text-center">
                                <small class="text-muted">{{ item.data_nf|formatar_data_segura or 'N/A' }}</small>
                                <br><strong class="text-primary">{{ item.numero_nf or '-' }}</strong>
                                <br>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ odoo_base_url }}#id={{ item.odoo_dfe_id }}&model=l10n_br_ciel_it_account.dfe&view_type=form"
                                       target="_blank"
                                       class="btn btn-outline-secondary btn-sm"
                                       title="Abrir no Odoo">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-outline-secondary btn-sm"
                                            onclick="downloadXml({{ item.odoo_dfe_id }})"
                                            title="Download XML">
                                        <i class="fas fa-file-code"></i>
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-secondary btn-sm"
                                            onclick="downloadPdf({{ item.odoo_dfe_id }})"
                                            title="Download DANFE">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                </div>
                            </td>
                            <!-- Empresa Compradora -->
                            <td>
                                <strong>{{ (item.razao_empresa_compradora or 'N/A')|truncate(20) }}</strong>
                                <br><small class="text-muted">{{ item.cnpj_empresa_compradora|formatar_cnpj if item.cnpj_empresa_compradora else '-' }}</small>
                            </td>
                            <!-- Fornecedor -->
                            <td>
                                <strong>{{ (item.razao_fornecedor or 'N/A')|truncate(20) }}</strong>
                                <br><small class="text-muted">{{ item.cnpj_fornecedor|formatar_cnpj if item.cnpj_fornecedor else '-' }}</small>
                            </td>
                            <!-- Produto -->
                            <td>
                                <code>{{ item.cod_produto_fornecedor or 'N/A' }}</code>
                                {% if item.cod_produto_interno %}
                                <i class="fas fa-arrow-right text-muted mx-1"></i>
                                <code class="text-success">{{ item.cod_produto_interno }}</code>
                                {% endif %}
                                <br>
                                {# Se tem De-Para com nome interno, exibir nome interno em verde #}
                                {# Senao, exibir nome do produto da NF (fornecedor) #}
                                <small class="{% if item.nome_produto_interno %}text-success{% else %}text-muted{% endif %}">
                                    {{ item.nome_produto_interno or item.nome_produto or 'N/A' }}
                                </small>
                            </td>
                            <!-- Qtd -->
                            <td class="text-center" style="font-size: 0.85em;">
                                {% if item.qtd_nf %}
                                    {% if item.cod_produto_interno and item.fator_conversao and item.fator_conversao > 1 %}
                                    {# Item com De-Para e fator > 1: mostra NF original e Odoo convertido #}
                                    {# qtd_nf JA ESTA CONVERTIDO, entao NF original = qtd_nf / fator #}
                                    <div><small class="text-muted">NF:</small> <strong>{{ (item.qtd_nf / item.fator_conversao)|numero_br(3) }}</strong> <small>{{ item.um_nf or '' }}</small></div>
                                    <div><small class="text-muted">Odoo:</small> <strong class="text-success">{{ item.qtd_nf|numero_br(3) }}</strong> <small>UN</small></div>
                                    {% else %}
                                    {# Sem De-Para ou fator = 1: mostra apenas valor #}
                                    <strong>{{ item.qtd_nf|numero_br(3) }}</strong>
                                    {% if item.um_nf %}<small class="text-muted">{{ item.um_nf }}</small>{% endif %}
                                    {% endif %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <!-- Preco -->
                            <td class="text-center" style="font-size: 0.85em;">
                                {% if item.preco_nf %}
                                    {% if item.cod_produto_interno and item.fator_conversao and item.fator_conversao > 1 %}
                                    {# Item com De-Para e fator > 1: mostra NF original e convertido #}
                                    {# preco_nf JA ESTA CONVERTIDO, entao NF original = preco_nf * fator #}
                                    <div><small class="text-muted">NF:</small> <strong>R$ {{ (item.preco_nf * item.fator_conversao)|numero_br(4) }}</strong></div>
                                    <div><small class="text-muted">Odoo:</small> <strong class="text-success">R$ {{ item.preco_nf|numero_br(4) }}</strong></div>
                                    {% else %}
                                    {# Sem De-Para ou fator = 1: mostra apenas valor #}
                                    <strong>R$ {{ item.preco_nf|numero_br(4) }}</strong>
                                    {% endif %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <!-- Valor Total -->
                            <td class="text-center" style="font-size: 0.85em;">
                                {% if item.qtd_nf and item.preco_nf %}
                                {# Valor total = qtd original NF * preco original NF #}
                                {# Se tem fator: (qtd_nf/fator) * (preco_nf*fator) = qtd_nf * preco_nf #}
                                <strong class="text-primary">R$ {{ (item.qtd_nf * item.preco_nf)|numero_br(2) }}</strong>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <!-- Tipo + Status (agrupados) -->
                            <td class="text-center">
                                {% if item.situacao_dfe_odoo in ['CANCELADA', 'INUTILIZADA'] %}
                                {# NF Cancelada/Inutilizada na SEFAZ - Exibir como Rejeitado #}
                                <span class="badge bg-danger">
                                    <i class="fas fa-ban me-1"></i>NF {{ item.situacao_dfe_odoo }}
                                </span>
                                <br>
                                <span class="badge bg-danger mt-1">Rejeitado</span>
                                <br>
                                <small class="text-danger">NF {{ item.situacao_dfe_odoo }} na SEFAZ</small>
                                {% else %}
                                <!-- Tipo Divergencia -->
                                {% if item.tipo_divergencia == 'sem_depara' %}
                                <span class="badge bg-secondary">Sem De-Para</span>
                                {% elif item.tipo_divergencia == 'sem_po' %}
                                <span class="badge bg-secondary">Sem PO</span>
                                {% elif item.tipo_divergencia == 'preco' %}
                                <span class="badge bg-danger">Preco</span>
                                {% elif item.tipo_divergencia == 'quantidade' %}
                                <span class="badge bg-warning text-dark">Quantidade</span>
                                {% elif item.tipo_divergencia == 'data_entrega' %}
                                <span class="badge bg-warning text-dark">Data</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ item.tipo_divergencia }}</span>
                                {% endif %}
                                <br>
                                <!-- Status -->
                                {% if item.status == 'pendente' %}
                                <span class="badge bg-warning text-dark mt-1">Pendente</span>
                                {% elif item.status == 'aprovada' %}
                                <span class="badge bg-success mt-1">Aprovada</span>
                                {% elif item.status == 'rejeitada' %}
                                <span class="badge bg-danger mt-1">Rejeitada</span>
                                {% elif item.status == 'bloqueado' %}
                                <span class="badge bg-danger mt-1">Bloqueado</span>
                                {% else %}
                                <span class="badge bg-secondary mt-1">{{ item.status }}</span>
                                {% endif %}
                                {% endif %}
                            </td>
                            <!-- NF vs PO (NF acima, PO abaixo) -->
                            <td>
                                <div>
                                    <small class="text-muted">NF:</small>
                                    <strong>{{ item.valor_nf or 'N/A' }}</strong>
                                </div>
                                <div>
                                    <small class="text-muted">PO:</small>
                                    <strong>{{ item.valor_po or 'N/A' }}</strong>
                                </div>
                                {% if item.diferenca_percentual %}
                                <small class="text-danger">Dif: {{ item.diferenca_percentual }}%</small>
                                {% endif %}
                                {% if item.odoo_po_name %}
                                <br><small class="text-muted">{{ item.odoo_po_name }}</small>
                                {% endif %}
                            </td>
                            <!-- Acoes (controlado por tipo de divergencia) -->
                            <td class="text-center">
                                {% if item.situacao_dfe_odoo in ['CANCELADA', 'INUTILIZADA'] %}
                                {# NF Cancelada/Inutilizada - Sem acoes disponiveis #}
                                <small class="text-danger">
                                    <i class="fas fa-ban me-1"></i>NF {{ item.situacao_dfe_odoo }}<br>
                                    Nao pode ser lancada
                                </small>
                                {% elif item.status == 'pendente' %}
                                {# Definir quais tipos podem ser aprovados manualmente #}
                                {% set pode_aprovar = item.tipo_divergencia in ['quantidade_tolerancia', 'data_entrega'] %}

                                <div class="btn-group btn-group-sm">
                                    {# TIPO: sem_depara - Mostrar apenas botao Criar De-Para #}
                                    {% if item.tipo_divergencia == 'sem_depara' %}
                                    <button class="btn btn-primary" onclick="criarDepara({{ item.id }})"
                                            title="Criar De-Para para este produto">
                                        <i class="fas fa-exchange-alt"></i> De-Para
                                    </button>

                                    {# TIPO: sem_po - Mostrar botao Ver POs e link Odoo #}
                                    {% elif item.tipo_divergencia == 'sem_po' %}
                                    <button class="btn btn-info" onclick="verPosCandidatos({{ item.odoo_dfe_id }})"
                                            title="Ver POs candidatos do fornecedor">
                                        <i class="fas fa-search"></i> Ver POs
                                    </button>
                                    <a href="{{ odoo_base_url }}#action=395&model=purchase.order&view_type=list"
                                       target="_blank"
                                       class="btn btn-outline-secondary"
                                       title="Criar PO no Odoo">
                                        <i class="fas fa-plus"></i>
                                    </a>

                                    {# TIPO: preco - Mostrar Ver POs e link Odoo #}
                                    {% elif item.tipo_divergencia == 'preco' %}
                                    <button class="btn btn-info btn-sm" onclick="verPosCandidatos({{ item.odoo_dfe_id }})"
                                            title="Ver POs candidatos">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    {% if item.odoo_po_id %}
                                    <a href="{{ odoo_base_url }}#id={{ item.odoo_po_id }}&model=purchase.order&view_type=form"
                                       target="_blank"
                                       class="btn btn-outline-secondary btn-sm"
                                       title="Editar PO no Odoo">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}

                                    {# TIPO: quantidade (>10%) - Mostrar Ver POs e link Odoo #}
                                    {% elif item.tipo_divergencia == 'quantidade' %}
                                    <button class="btn btn-info btn-sm" onclick="verPosCandidatos({{ item.odoo_dfe_id }})"
                                            title="Ver POs candidatos">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    {% if item.odoo_po_id %}
                                    <a href="{{ odoo_base_url }}#id={{ item.odoo_po_id }}&model=purchase.order&view_type=form"
                                       target="_blank"
                                       class="btn btn-outline-secondary btn-sm"
                                       title="Editar PO no Odoo">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}

                                    {# TIPOS APROVAVEIS: quantidade_tolerancia, data_entrega #}
                                    {% elif pode_aprovar %}
                                    <button class="btn btn-success" onclick="abrirModalAprovar({{ item.id }})"
                                            title="Aprovar divergencia">
                                        <i class="fas fa-check"></i> Aprovar
                                    </button>
                                    <button class="btn btn-danger" onclick="rejeitarDivergencia({{ item.id }})"
                                            title="Rejeitar">
                                        <i class="fas fa-times"></i>
                                    </button>

                                    {# OUTROS TIPOS - Fallback #}
                                    {% else %}
                                    <button class="btn btn-outline-secondary" disabled
                                            title="Este tipo de divergencia requer acao especifica">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                {% else %}
                                <small class="text-muted">
                                    {{ item.resolucao }}<br>
                                    {% if item.resolvido_por %}por {{ item.resolvido_por }}{% endif %}
                                </small>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center text-muted py-4">
                                <i class="fas fa-check-circle fa-3x mb-3 d-block text-success"></i>
                                Nenhuma divergencia encontrada
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Paginacao -->
    {% if paginacao.pages > 1 %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if paginacao.page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page={{ paginacao.page - 1 }}&status={{ filtros.status }}&tipo={{ filtros.tipo }}&cnpj={{ filtros.cnpj }}&numero_nf={{ filtros.numero_nf }}&nome_fornecedor={{ filtros.nome_fornecedor }}&cod_produto={{ filtros.cod_produto }}&empresa={{ filtros.empresa }}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            {% for p in range(1, paginacao.pages + 1) %}
            <li class="page-item {% if p == paginacao.page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}&status={{ filtros.status }}&tipo={{ filtros.tipo }}&cnpj={{ filtros.cnpj }}&numero_nf={{ filtros.numero_nf }}&nome_fornecedor={{ filtros.nome_fornecedor }}&cod_produto={{ filtros.cod_produto }}&empresa={{ filtros.empresa }}">{{ p }}</a>
            </li>
            {% endfor %}

            {% if paginacao.page < paginacao.pages %}
            <li class="page-item">
                <a class="page-link" href="?page={{ paginacao.page + 1 }}&status={{ filtros.status }}&tipo={{ filtros.tipo }}&cnpj={{ filtros.cnpj }}&numero_nf={{ filtros.numero_nf }}&nome_fornecedor={{ filtros.nome_fornecedor }}&cod_produto={{ filtros.cod_produto }}&empresa={{ filtros.empresa }}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

{% include 'recebimento/_modals_divergencias.html' %}

<!-- Modal Executar Validacao (com periodo De/Ate) -->
<div class="modal fade" id="modalValidacao" tabindex="-1" aria-labelledby="modalValidacaoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalValidacaoLabel">
                    <i class="fas fa-sync-alt text-primary me-2"></i>Executar Validação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">
                    O sistema buscará DFEs de compra (NF-e) modificados no período selecionado
                    e executará as validações Fase 1 (Fiscal) e Fase 2 (NF×PO).
                </p>
                <div class="row g-3">
                    <div class="col-6">
                        <label class="form-label">De</label>
                        <input type="date" class="form-control" id="validacaoDataDe">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Até</label>
                        <input type="date" class="form-control" id="validacaoDataAte">
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Período máximo: 90 dias. Limite: 100 DFEs por execução.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarValidacao" onclick="confirmarValidacao()">
                    <i class="fas fa-play"></i> Executar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript externo -->
<script src="{{ url_for('static', filename='js/recebimento/divergencias_shared.js') }}"></script>
<script src="{{ url_for('static', filename='js/recebimento/divergencias_nf_po.js') }}"></script>
{% endblock %}
