{% extends 'base.html' %}

{% block content %}
{# Styles moved to app/static/css/modules/_recebimento.css #}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-file-invoice text-warning me-2"></i>Validacao de Primeira Compra</h2>
            <p class="text-muted mb-0">Produtos/fornecedores sem historico fiscal - Validacao manual obrigatoria</p>
        </div>
        <div>
            <button type="button" class="btn btn-outline-primary" onclick="limparEAtualizar()" id="btnAtualizar">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
        </div>
    </div>

    <!-- Cards de Estatisticas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-left-warning">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Pendentes</h6>
                    <h2 class="mb-0 text-warning">{{ stats.pendente }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-success">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Validados</h6>
                    <h2 class="mb-0 text-success">{{ stats.validado }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-danger">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Rejeitados</h6>
                    <h2 class="mb-0 text-danger">{{ stats.rejeitado }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h6>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('recebimento_views.primeira_compra') }}">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            <option value="pendente" {% if filtros.status == 'pendente' %}selected{% endif %}>Pendentes</option>
                            <option value="validado" {% if filtros.status == 'validado' %}selected{% endif %}>Validados</option>
                            <option value="rejeitado" {% if filtros.status == 'rejeitado' %}selected{% endif %}>Rejeitados</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">CNPJ Fornecedor</label>
                        <input type="text" name="cnpj" class="form-control form-control-sm"
                               value="{{ filtros.cnpj }}" placeholder="Digite o CNPJ...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Produto</label>
                        <input type="text" name="produto" class="form-control form-control-sm"
                               value="{{ filtros.produto }}" placeholder="Codigo ou nome...">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm me-2">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <a href="{{ url_for('recebimento_views.primeira_compra') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-times"></i> Limpar
                        </a>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-3">
                        <label class="form-label">Fornecedor</label>
                        <input type="text" name="nome_fornecedor" class="form-control form-control-sm"
                               value="{{ filtros.nome_fornecedor }}" placeholder="Nome do fornecedor...">
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Paginacao Superior -->
    {% if paginacao.pages > 1 %}
    <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="text-muted">
            Exibindo <strong>{{ ((paginacao.page - 1) * paginacao.per_page) + 1 }}</strong> -
            <strong>{{ ((paginacao.page - 1) * paginacao.per_page) + paginacao.items|length }}</strong>
            de <strong>{{ paginacao.total }}</strong>
        </span>
        <span class="badge bg-info">Pagina {{ paginacao.page }} de {{ paginacao.pages }}</span>
    </div>
    {% endif %}

    <!-- Tabela Compacta -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle mb-0" id="tabelaPrimeiraCompra">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 100px;">NF</th>
                            <th>Empresa</th>
                            <th>Fornecedor</th>
                            <th>Produto</th>
                            <th class="text-end" style="width: 90px;">Qtd</th>
                            <th class="text-end" style="width: 110px;">Valor Total</th>
                            <th class="text-center" style="width: 90px;">NCM</th>
                            <th class="text-center" style="width: 60px;">CFOP</th>
                            <th class="text-center" style="width: 110px;">ICMS</th>
                            <th class="text-center" style="width: 90px;">Status</th>
                            <th class="text-center" style="width: 130px;">Acoes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set ns = namespace(last_dfe_id='', color_idx=0, is_first=true) %}
                        {% for item in paginacao.items %}
                        {% if item.odoo_dfe_id != ns.last_dfe_id %}
                            {% if not ns.is_first %}
                            <!-- Linha separadora entre NFs -->
                            <tr class="rec-nf-separator"><td colspan="11"></td></tr>
                            {% endif %}
                            {% set ns.color_idx = (ns.color_idx + 1) % 2 %}
                            {% set ns.last_dfe_id = item.odoo_dfe_id %}
                            {% set ns.is_first = false %}
                        {% endif %}
                        <tr data-item-id="{{ item.id }}" class="{{ 'rec-row-blue rec-border-blue' if ns.color_idx == 0 else 'rec-row-gray rec-border-gray' }}">
                            <td>
                                <a href="{{ url_for('validacao_fiscal.obter_pdf_nf', dfe_id=item.odoo_dfe_id) }}"
                                   target="_blank" class="text-primary fw-bold" title="Ver PDF da NF">
                                    <i class="fas fa-file-pdf text-danger me-1"></i>{{ item.numero_nf or item.odoo_dfe_id }}
                                </a>
                                {% if item.serie_nf %}
                                <br><small class="text-muted">Série: {{ item.serie_nf }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ item.razao_empresa_compradora|truncate(25) if item.razao_empresa_compradora else 'N/A' }}</small>
                                <br><small class="text-muted">{{ item.cnpj_empresa_compradora|formatar_cnpj if item.cnpj_empresa_compradora else '-' }}</small>
                            </td>
                            <td>
                                <span title="{{ item.razao_fornecedor }}">{{ item.razao_fornecedor|truncate(30) }}</span>
                                <br><small class="text-muted">{{ item.cnpj_fornecedor|formatar_cnpj }} -
                                    {% if item.regime_tributario == '1' or item.regime_tributario == '2' %}
                                    <span class="badge bg-info">Simples</span>
                                    {% elif item.regime_tributario == '3' %}
                                    <span class="badge bg-secondary">Regime Normal</span>
                                    {% else %}
                                    <span class="text-muted">N/I</span>
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                <strong>{{ item.cod_produto }}</strong>
                                <br><small class="text-muted" title="{{ item.nome_produto }}">{{ item.nome_produto|truncate(30) }}</small>
                            </td>
                            <td class="text-end">
                                {% if item.quantidade %}
                                {{ item.quantidade|numero_br(2) }}
                                <small class="text-muted">{{ item.unidade_medida or 'UN' }}</small>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if item.valor_total %}
                                <strong>R$ {{ item.valor_total|numero_br(2) }}</strong>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="text-center"><code>{{ item.ncm or '-' }}</code></td>
                            <td class="text-center"><code>{{ item.cfop or '-' }}</code></td>
                            <td class="text-center small">
                                {% if item.aliquota_icms is not none %}
                                <div><span class="badge bg-secondary">{{ item.aliquota_icms }}%</span></div>
                                {% if item.reducao_bc_icms %}
                                <div class="text-info" title="Redução BC ICMS">Red: {{ item.reducao_bc_icms }}%</div>
                                {% endif %}
                                {% if item.valor_icms %}
                                <div class="text-success">R$ {{ item.valor_icms|numero_br(2) }}</div>
                                {% endif %}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if item.status == 'pendente' %}
                                <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pendente</span>
                                {% elif item.status == 'validado' %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> Validado</span>
                                {% elif item.status == 'rejeitado' %}
                                <span class="badge bg-danger"><i class="fas fa-times"></i> Rejeitado</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if item.status == 'pendente' %}
                                <button type="button" class="btn btn-sm btn-outline-primary"
                                        onclick="abrirModalDetalhes({{ item.id }})"
                                        title="Ver detalhes e validar">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-success"
                                        onclick="validarRapido({{ item.id }})"
                                        title="Validar rapidamente">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger"
                                        onclick="abrirModalRejeitar({{ item.id }})"
                                        title="Rejeitar">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                        onclick="abrirModalDetalhes({{ item.id }})"
                                        title="Ver detalhes">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="11" class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>
                                <span class="text-muted">Nenhum registro de primeira compra encontrado</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Paginacao Inferior -->
    {% if paginacao.pages > 1 %}
    <nav class="mt-3 d-flex justify-content-center">
        <ul class="pagination">
            <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('recebimento_views.primeira_compra', page=1, **filtros) }}">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('recebimento_views.primeira_compra', page=paginacao.page-1, **filtros) }}">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>

            {% for p in paginacao.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if p %}
                    <li class="page-item {% if p == paginacao.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('recebimento_views.primeira_compra', page=p, **filtros) }}">{{ p }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('recebimento_views.primeira_compra', page=paginacao.page+1, **filtros) }}">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('recebimento_views.primeira_compra', page=paginacao.pages, **filtros) }}">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Modal Detalhes / Validacao -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">
                    <i class="fas fa-file-invoice me-2"></i>Detalhes da Primeira Compra
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetalhesBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Carregando...</p>
                </div>
            </div>
            <div class="modal-footer" id="modalDetalhesFooter">
                <!-- Botoes dinamicos -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Rejeitar -->
<div class="modal fade" id="modalRejeitar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-times-circle me-2"></i>Rejeitar Primeira Compra</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rejeitarItemId">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Ao rejeitar, a NF sera bloqueada e precisara de tratamento manual.
                </div>
                <div class="mb-3">
                    <label class="form-label">Motivo da Rejeicao <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="rejeitarMotivo" rows="3"
                              placeholder="Descreva o motivo da rejeicao..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarRejeicao()">
                    <i class="fas fa-times"></i> Rejeitar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dados JSON para JS -->
<script id="dadosItens" type="application/json">
{{ itens_json|safe if itens_json else '[]' }}
</script>

{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    // Cache de dados
    let itensData = {};
    try {
        const dados = JSON.parse(document.getElementById('dadosItens').textContent || '[]');
        dados.forEach(item => itensData[item.id] = item);
    } catch(e) {
        console.error('Erro ao carregar dados:', e);
    }

    // Modal instances
    let modalDetalhes, modalRejeitar;

    document.addEventListener('DOMContentLoaded', function() {
        modalDetalhes = new bootstrap.Modal(document.getElementById('modalDetalhes'));
        modalRejeitar = new bootstrap.Modal(document.getElementById('modalRejeitar'));
    });

    // Abrir modal de detalhes
    window.abrirModalDetalhes = function(itemId) {
        const item = itensData[itemId];
        if (!item) {
            alert('Item nao encontrado');
            return;
        }

        const body = document.getElementById('modalDetalhesBody');
        const footer = document.getElementById('modalDetalhesFooter');

        // Renderizar conteudo
        body.innerHTML = renderizarDetalhes(item);

        // Footer com botoes
        if (item.status === 'pendente') {
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-danger" onclick="abrirModalRejeitar(${item.id}); modalDetalhes.hide();">
                    <i class="fas fa-times"></i> Rejeitar
                </button>
                <button type="button" class="btn btn-success" onclick="validarItem(${item.id})">
                    <i class="fas fa-check"></i> Validar e Criar Perfil
                </button>
            `;
        } else {
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            `;
        }

        modalDetalhes.show();
    };

    // Funcoes auxiliares de formatacao
    const formatarValor = (v, decimais=2) => {
        if (v === null || v === undefined || v === '') return '-';
        const num = parseFloat(v);
        if (isNaN(num)) return '-';
        return num.toLocaleString('pt-BR', {minimumFractionDigits: decimais, maximumFractionDigits: decimais});
    };

    const formatarCnpj = (cnpj) => {
        if (!cnpj) return '-';
        const n = cnpj.replace(/\D/g, '');
        if (n.length !== 14) return cnpj;
        return n.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
    };

    const formatarRegime = (crt) => {
        if (!crt) return '<span class="badge bg-light text-dark ms-1">N/I</span>';
        if (crt === '1' || crt === '2') return '<span class="badge bg-info ms-1">Simples</span>';
        if (crt === '3') return '<span class="badge bg-warning text-dark ms-1">Regime Normal</span>';
        return '<span class="badge bg-light text-dark ms-1">CRT ' + crt + '</span>';
    };

    // Renderizar detalhes do item - FOCADO EM DECISAO
    function renderizarDetalhes(item) {
        const totalImpostos = (parseFloat(item.valor_icms || 0) + parseFloat(item.valor_icms_st || 0) + parseFloat(item.valor_ipi || 0));

        return `
            <!-- SECAO 1: O QUE VOCE ESTA VALIDANDO (Contexto Rapido) -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-header py-2 bg-warning text-dark d-flex justify-content-between align-items-center">
                            <strong><i class="fas fa-question-circle me-2"></i>O QUE VOCE ESTA VALIDANDO</strong>
                            <a href="/api/recebimento/dfe/${item.odoo_dfe_id}/pdf" target="_blank"
                               class="btn btn-sm btn-danger" title="Abrir PDF da NF">
                                <i class="fas fa-file-pdf me-1"></i>Ver DANFE
                            </a>
                        </div>
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-2 border-end">
                                    <small class="text-muted d-block">NF</small>
                                    <strong class="fs-5">${item.numero_nf || item.odoo_dfe_id}</strong>
                                    ${item.serie_nf ? '<small class="text-muted"> (Série ' + item.serie_nf + ')</small>' : ''}
                                </div>
                                <div class="col-md-3 border-end">
                                    <small class="text-muted d-block">Comprado por</small>
                                    <strong>${item.razao_empresa_compradora || 'N/A'}</strong>
                                    <small class="d-block text-muted">${formatarCnpj(item.cnpj_empresa_compradora)}</small>
                                </div>
                                <div class="col-md-4 border-end">
                                    <small class="text-muted d-block">Fornecedor</small>
                                    <strong>${item.razao_fornecedor || '-'}</strong>
                                    <small class="d-block">${formatarCnpj(item.cnpj_fornecedor)}
                                        <span class="badge bg-secondary ms-1">${item.uf_fornecedor || '-'}</span>
                                        ${formatarRegime(item.regime_tributario)}
                                    </small>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted d-block">Produto</small>
                                    <code class="fs-5">${item.cod_produto}</code>
                                    <small class="d-block text-muted">${item.nome_produto || ''}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECAO 2: DADOS FISCAIS A VALIDAR (Foco da Decisao) -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-header py-2 bg-primary text-white">
                            <strong><i class="fas fa-check-circle me-2"></i>DADOS FISCAIS A VALIDAR</strong>
                            <small class="d-block">Estes dados serao salvos como baseline para proximas compras deste produto/fornecedor</small>
                        </div>
                        <div class="card-body">
                            <!-- Linha 1: NCM, CFOP, CST -->
                            <div class="row text-center mb-3">
                                <div class="col-md-4">
                                    <div class="border rounded p-2 bg-light">
                                        <small class="text-muted d-block fw-bold">NCM</small>
                                        <code class="fs-3 text-primary">${item.ncm || '-'}</code>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="border rounded p-2 bg-light">
                                        <small class="text-muted d-block fw-bold">CFOP</small>
                                        <code class="fs-3 text-primary">${item.cfop || '-'}</code>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="border rounded p-2 bg-light">
                                        <small class="text-muted d-block fw-bold">CST ICMS</small>
                                        <code class="fs-3 text-primary">${item.cst_icms || '-'}</code>
                                    </div>
                                </div>
                            </div>
                            <!-- Linha 2: Aliquotas -->
                            <div class="row text-center">
                                <div class="col">
                                    <div class="border rounded p-2">
                                        <small class="text-muted d-block">ICMS</small>
                                        <span class="badge bg-primary fs-4">${formatarValor(item.aliquota_icms)}%</span>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="border rounded p-2">
                                        <small class="text-muted d-block">Red. BC ICMS</small>
                                        <span class="badge bg-info fs-4">${item.reducao_bc_icms ? formatarValor(item.reducao_bc_icms) + '%' : '-'}</span>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="border rounded p-2">
                                        <small class="text-muted d-block">ICMS ST</small>
                                        <span class="badge bg-secondary fs-4">${formatarValor(item.aliquota_icms_st)}%</span>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="border rounded p-2">
                                        <small class="text-muted d-block">IPI</small>
                                        <span class="badge bg-warning text-dark fs-4">${formatarValor(item.aliquota_ipi)}%</span>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="border rounded p-2">
                                        <small class="text-muted d-block">PIS/COFINS</small>
                                        <span class="badge bg-secondary fs-6">${formatarValor(item.aliquota_pis)}% / ${formatarValor(item.aliquota_cofins)}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECAO 3: HISTORICO (Contexto para Decisao) -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header py-2 bg-light d-flex justify-content-between align-items-center">
                            <strong><i class="fas fa-history me-2"></i>HISTORICO DO PRODUTO</strong>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="buscarHistorico('${item.cod_produto}')" id="btnBuscarHistorico">
                                <i class="fas fa-search"></i> Buscar Historico
                            </button>
                        </div>
                        <div class="card-body py-2" id="historicoContainer">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Primeira compra deste produto com este fornecedor.</strong>
                                Clique em "Buscar Historico" para ver se existe perfil fiscal deste produto com outros fornecedores.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECAO 4: VALORES DA NF (Informativo) - Colapsavel -->
            <div class="accordion" id="accordionDetalhes">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseValores">
                            <i class="fas fa-calculator me-2"></i>Valores da NF (Detalhes)
                        </button>
                    </h2>
                    <div id="collapseValores" class="accordion-collapse collapse" data-bs-parent="#accordionDetalhes">
                        <div class="accordion-body">
                            <div class="row text-center">
                                <div class="col-md-3 border-end">
                                    <small class="text-muted d-block">Quantidade</small>
                                    <span class="h5">${formatarValor(item.quantidade, 4)} ${item.unidade_medida || 'UN'}</span>
                                </div>
                                <div class="col-md-3 border-end">
                                    <small class="text-muted d-block">Valor Unitario</small>
                                    <span class="h5">R$ ${formatarValor(item.valor_unitario, 4)}</span>
                                </div>
                                <div class="col-md-3 border-end">
                                    <small class="text-muted d-block">Valor Total</small>
                                    <span class="h5 text-success fw-bold">R$ ${formatarValor(item.valor_total)}</span>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted d-block">Total Impostos</small>
                                    <span class="h5 text-danger fw-bold">R$ ${formatarValor(totalImpostos)}</span>
                                </div>
                            </div>
                            <hr>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Imposto</th>
                                            <th>CST</th>
                                            <th class="text-center">Alíquota</th>
                                            <th class="text-end">Base Cálculo</th>
                                            <th class="text-end">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <th>ICMS</th>
                                            <td><code>${item.cst_icms || '-'}</code></td>
                                            <td class="text-center"><span class="badge bg-primary">${formatarValor(item.aliquota_icms)}%</span></td>
                                            <td class="text-end">R$ ${formatarValor(item.bc_icms)}</td>
                                            <td class="text-end text-danger fw-bold">R$ ${formatarValor(item.valor_icms)}</td>
                                        </tr>
                                        ${item.reducao_bc_icms ? `
                                        <tr class="table-info">
                                            <th class="text-info ps-4">↳ Red. BC ICMS</th>
                                            <td>-</td>
                                            <td class="text-center"><span class="badge bg-info">${formatarValor(item.reducao_bc_icms)}%</span></td>
                                            <td class="text-end">-</td>
                                            <td class="text-end text-muted">
                                                ICMS Final: ${formatarValor(item.aliquota_icms * (1 - item.reducao_bc_icms/100))}%
                                            </td>
                                        </tr>
                                        ` : ''}
                                        <tr>
                                            <th>ICMS ST</th>
                                            <td>-</td>
                                            <td class="text-center"><span class="badge bg-secondary">${formatarValor(item.aliquota_icms_st)}%</span></td>
                                            <td class="text-end">R$ ${formatarValor(item.bc_icms_st)}</td>
                                            <td class="text-end text-danger fw-bold">R$ ${formatarValor(item.valor_icms_st)}</td>
                                        </tr>
                                        <tr>
                                            <th>IPI</th>
                                            <td>-</td>
                                            <td class="text-center"><span class="badge bg-info">${formatarValor(item.aliquota_ipi)}%</span></td>
                                            <td class="text-end">-</td>
                                            <td class="text-end text-danger fw-bold">R$ ${formatarValor(item.valor_ipi)}</td>
                                        </tr>
                                        <tr>
                                            <th>PIS</th>
                                            <td><code>${item.cst_pis || '-'}</code></td>
                                            <td class="text-center"><span class="badge bg-secondary">${formatarValor(item.aliquota_pis)}%</span></td>
                                            <td class="text-end">R$ ${formatarValor(item.bc_pis)}</td>
                                            <td class="text-end text-danger fw-bold">R$ ${formatarValor(item.valor_pis || 0)}</td>
                                        </tr>
                                        <tr>
                                            <th>COFINS</th>
                                            <td><code>${item.cst_cofins || '-'}</code></td>
                                            <td class="text-center"><span class="badge bg-secondary">${formatarValor(item.aliquota_cofins)}%</span></td>
                                            <td class="text-end">R$ ${formatarValor(item.bc_cofins)}</td>
                                            <td class="text-end text-danger fw-bold">R$ ${formatarValor(item.valor_cofins || 0)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            ${item.observacao ? `
            <div class="alert alert-info mt-3 mb-0">
                <strong><i class="fas fa-comment me-2"></i>Observacao:</strong> ${item.observacao}
            </div>
            ` : ''}

            ${item.validado_por ? `
            <div class="alert alert-secondary mt-3 mb-0">
                <small>
                    <i class="fas fa-user me-1"></i> ${item.status === 'validado' ? 'Validado' : 'Rejeitado'} por
                    <strong>${item.validado_por}</strong>
                    ${item.validado_em ? ' em ' + new Date(item.validado_em).toLocaleString('pt-BR') : ''}
                </small>
            </div>
            ` : ''}
        `;
    }

    // Buscar historico do produto (perfis fiscais existentes)
    window.buscarHistorico = function(codProduto) {
        const container = document.getElementById('historicoContainer');
        const btn = document.getElementById('btnBuscarHistorico');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Buscando...';

        fetch(`/api/recebimento/perfis-fiscais?cod_produto=${encodeURIComponent(codProduto)}`)
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> Buscar Historico';

                if (data.itens && data.itens.length > 0) {
                    let html = `
                        <div class="alert alert-warning mb-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Encontrados ${data.itens.length} perfil(is) fiscal(is) deste produto com outros fornecedores:</strong>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fornecedor</th>
                                        <th>NCM</th>
                                        <th>CFOP</th>
                                        <th>ICMS</th>
                                        <th>IPI</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    data.itens.forEach(p => {
                        const cfops = p.cfop_esperados ? JSON.parse(p.cfop_esperados).join(', ') : '-';
                        html += `
                            <tr>
                                <td>${formatarCnpj(p.cnpj_fornecedor)}</td>
                                <td><code>${p.ncm_esperado || '-'}</code></td>
                                <td><code>${cfops}</code></td>
                                <td>${p.aliquota_icms_esperada || '-'}%</td>
                                <td>${p.aliquota_ipi_esperada || '-'}%</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Nenhum perfil fiscal encontrado para este produto.</strong>
                            Este e realmente o primeiro cadastro fiscal deste produto no sistema.
                        </div>
                    `;
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> Buscar Historico';
                container.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-times-circle me-2"></i> Erro ao buscar historico: ${err.message}
                    </div>
                `;
            });
    }

    // Validar item rapidamente
    window.validarRapido = function(itemId) {
        if (!confirm('Confirma validacao e criacao do perfil fiscal para este produto/fornecedor?')) return;
        validarItem(itemId);
    };

    // Validar item
    window.validarItem = function(itemId) {
        const btn = event.target;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        fetch(`/api/recebimento/primeira-compra/${itemId}/validar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({observacao: ''})
        })
        .then(r => r.json())
        .then(data => {
            if (data.sucesso) {
                if (typeof toastr !== 'undefined') {
                    toastr.success('Primeira compra validada! Perfil fiscal criado.');
                }
                setTimeout(() => location.reload(), 500);
            } else {
                alert('Erro: ' + data.mensagem);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        })
        .catch(e => {
            alert('Erro de conexao');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        });
    };

    // Abrir modal de rejeitar
    window.abrirModalRejeitar = function(itemId) {
        document.getElementById('rejeitarItemId').value = itemId;
        document.getElementById('rejeitarMotivo').value = '';
        modalRejeitar.show();
    };

    // Confirmar rejeicao
    window.confirmarRejeicao = function() {
        const itemId = document.getElementById('rejeitarItemId').value;
        const motivo = document.getElementById('rejeitarMotivo').value.trim();

        if (!motivo) {
            alert('Informe o motivo da rejeicao');
            return;
        }

        const btn = event.target;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Rejeitando...';

        fetch(`/api/recebimento/primeira-compra/${itemId}/rejeitar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({observacao: motivo})
        })
        .then(r => r.json())
        .then(data => {
            if (data.sucesso) {
                if (typeof toastr !== 'undefined') {
                    toastr.success('Primeira compra rejeitada');
                }
                setTimeout(() => location.reload(), 500);
            } else {
                alert('Erro: ' + data.mensagem);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        })
        .catch(e => {
            alert('Erro de conexao');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        });
    };

    function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    }

})();

// Função para limpar órfãos e atualizar a página
function limparEAtualizar() {
    const btn = document.getElementById('btnAtualizar');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Verificando...';

    // Primeiro limpa registros órfãos (que já têm perfil fiscal)
    fetch('/api/recebimento/primeira-compra/limpar-orfaos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.sucesso && data.removidos > 0) {
            if (typeof toastr !== 'undefined') {
                toastr.info(`${data.removidos} registro(s) órfão(s) removido(s)`);
            }
        }
        // Recarrega a página após a limpeza
        setTimeout(() => location.reload(), 300);
    })
    .catch(e => {
        console.error('Erro ao limpar órfãos:', e);
        // Mesmo com erro, recarrega a página
        location.reload();
    });
}
</script>
{% endblock %}
