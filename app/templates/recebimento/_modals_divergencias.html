{# Partial: Modais compartilhados entre Divergencias NF x PO e Validacoes NF x PO #}

<!-- Modal Criar De-Para -->
<div class="modal fade" id="modalCriarDepara" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Criar De-Para</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="divergenciaId">

                <!-- Dados da NF (readonly) -->
                <div class="card mb-3 border-secondary">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Dados da NF (Origem)</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">Codigo Fornecedor:</small></p>
                                <p class="fw-bold" id="nfCodProdutoFornecedor">-</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">Descricao:</small></p>
                                <p class="fw-bold" id="nfNomeProduto">-</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <p class="mb-1"><small class="text-muted">Quantidade:</small></p>
                                <p class="fw-bold text-primary" id="nfQuantidade">-</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1"><small class="text-muted">Preco Unitario:</small></p>
                                <p class="fw-bold text-primary" id="nfPreco">-</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1"><small class="text-muted">UM Fornecedor:</small></p>
                                <p class="fw-bold" id="nfUmFornecedor">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulario De-Para -->
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-arrow-right me-2"></i>Produto Interno (Destino)</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Codigo Produto Interno *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="codProdutoInternoModal" required
                                       placeholder="Digite o codigo interno...">
                                <button class="btn btn-outline-secondary" type="button" onclick="buscarProdutoOdooModal()">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                            <small class="text-muted">Digite o codigo e clique em Buscar para validar</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Nome Produto</label>
                            <input type="text" class="form-control" id="nomeProdutoInternoModal" readonly>
                        </div>

                        <input type="hidden" id="odooProductIdModal">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">UM Fornecedor</label>
                                    <input type="text" class="form-control" id="umFornecedorModal" readonly>
                                    <small class="text-muted">Preenchido automaticamente da NF</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fator Conversao</label>
                                    <input type="number" class="form-control" id="fatorConversaoModal" value="1" step="0.0001" min="0.0001">
                                    <small class="text-muted">Ex: 1000 se UM=Milhar</small>
                                </div>
                            </div>
                        </div>

                        <!-- Simulacao de Conversao -->
                        <div class="alert alert-secondary mb-3" id="simulacaoConversao" style="display: none;">
                            <h6 class="alert-heading"><i class="fas fa-calculator me-2"></i>Simulacao da Conversao</h6>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">Quantidade Original:</small>
                                    <p class="mb-0 fw-bold" id="simQtdOriginal">-</p>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Quantidade Convertida:</small>
                                    <p class="mb-0 fw-bold text-success" id="simQtdConvertida">-</p>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <small class="text-muted">Preco Original:</small>
                                    <p class="mb-0 fw-bold" id="simPrecoOriginal">-</p>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Preco Convertido:</small>
                                    <p class="mb-0 fw-bold text-success" id="simPrecoConvertido">-</p>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Justificativa</label>
                            <textarea class="form-control" id="justificativaModal" rows="2"
                                      placeholder="Motivo da criacao do De-Para..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarCriarDepara()">
                    <i class="fas fa-exchange-alt"></i> Criar De-Para
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver POs Candidatos -->
<div class="modal fade" id="modalPosCandidatos" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-shopping-cart me-2"></i>POs Candidatos para esta NF</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Dados da NF -->
                <div class="card mb-3">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Dados da NF</h6>
                        <span class="badge bg-primary" id="posNfNumero">-</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">Comprado por:</small>
                                <p class="fw-bold mb-0" id="posEmpresa">-</p>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Fornecedor:</small>
                                <p class="fw-bold mb-0" id="posFornecedor">-</p>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Data Emissao:</small>
                                <p class="fw-bold mb-0" id="posDataEmissao">-</p>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Valor Total:</small>
                                <p class="fw-bold mb-0 text-primary" id="posValorTotal">-</p>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Itens:</small>
                                <p class="fw-bold mb-0" id="posQtdItens">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumo do Match -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card border-primary h-100">
                            <div class="card-body text-center py-2">
                                <small class="text-muted d-block">Itens NF</small>
                                <span class="fs-4 fw-bold text-primary" id="resumoItensNf">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success h-100">
                            <div class="card-body text-center py-2">
                                <small class="text-muted d-block">Com De-Para</small>
                                <span class="fs-4 fw-bold text-success" id="resumoItensDepara">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-info h-100">
                            <div class="card-body text-center py-2">
                                <small class="text-muted d-block">Com PO Match</small>
                                <span class="fs-4 fw-bold text-info" id="resumoItensComPo">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning h-100">
                            <div class="card-body text-center py-2">
                                <small class="text-muted d-block">POs Candidatos</small>
                                <span class="fs-4 fw-bold text-warning" id="resumoPosCandidatos">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Itens da NF -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Itens da NF (valores originais e convertidos)</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th rowspan="2">#</th>
                                        <th rowspan="2">Cod Forn</th>
                                        <th rowspan="2">Descricao</th>
                                        <th colspan="2" class="text-center bg-light">Original (NF)</th>
                                        <th colspan="2" class="text-center bg-info text-white">Convertido</th>
                                        <th rowspan="2">De-Para</th>
                                        <th rowspan="2">Match</th>
                                    </tr>
                                    <tr>
                                        <th class="text-end">Qtd</th>
                                        <th class="text-end">Preco</th>
                                        <th class="text-end">Qtd</th>
                                        <th class="text-end">Preco</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaItensNf">
                                    <tr><td colspan="9" class="text-center py-3">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- POs Candidatos com Comparacao -->
                <div class="card">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>POs Candidatos - Comparacao NF vs PO</h6>
                        <small class="badge bg-dark">Tolerancia: Qtd 10% | Preco 0%</small>
                    </div>
                    <div class="card-body p-0">
                        <div id="listaPosCandidatos" style="max-height: 450px; overflow-y: auto;">
                            <div class="text-center py-3">Carregando...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Aprovar Divergencia -->
<div class="modal fade" id="modalAprovar" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Confirmar Aprovacao</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="aprovarDivergenciaId">

                <!-- Resumo da Divergencia -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Resumo da Divergencia</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">NF:</small></p>
                                <p class="fw-bold" id="aprovarNumeroNf">-</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">Tipo Divergencia:</small></p>
                                <p id="aprovarTipoDivergencia">-</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <p class="mb-1"><small class="text-muted">Fornecedor:</small></p>
                                <p class="fw-bold" id="aprovarFornecedor">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Produto -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-box me-2"></i>Produto</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">Codigo Fornecedor:</small></p>
                                <p class="fw-bold" id="aprovarCodFornecedor">-</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><small class="text-muted">Codigo Interno:</small></p>
                                <p class="fw-bold" id="aprovarCodInterno">-</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <p class="mb-1"><small class="text-muted">Nome:</small></p>
                                <p class="fw-bold" id="aprovarNomeProduto">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparacao NF vs PO -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-balance-scale me-2"></i>NF vs PO</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 border-end">
                                <h6 class="text-center text-primary">Valor NF</h6>
                                <p class="text-center fw-bold fs-5" id="aprovarValorNf">-</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-center text-secondary">Valor PO</h6>
                                <p class="text-center fw-bold fs-5" id="aprovarValorPo">-</p>
                            </div>
                        </div>
                        <div class="row" id="aprovarDiferencaRow" style="display: none;">
                            <div class="col-12 text-center">
                                <span class="badge bg-danger fs-6" id="aprovarDiferenca">-</span>
                            </div>
                        </div>
                        <div class="row mt-2" id="aprovarPoNameRow" style="display: none;">
                            <div class="col-12 text-center">
                                <small class="text-muted">PO: <span id="aprovarPoName">-</span></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Justificativa -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Justificativa da Aprovacao *</label>
                    <textarea class="form-control" id="aprovarJustificativa" rows="3"
                              placeholder="Informe o motivo da aprovacao..." required></textarea>
                    <small class="text-muted">A justificativa e obrigatoria para aprovacao</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmarAprovar()">
                    <i class="fas fa-check"></i> Confirmar Aprovacao
                </button>
            </div>
        </div>
    </div>
</div>
