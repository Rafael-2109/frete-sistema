{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-clipboard-check text-info me-2"></i>Validacoes NF x PO</h2>
            <p class="text-muted mb-0">Status de validacao de NF-e contra Pedidos de Compra</p>
        </div>
        <div>
            <a href="{{ url_for('recebimento_views.divergencias_nf_po') }}" class="btn btn-outline-warning me-2">
                <i class="fas fa-exclamation-triangle"></i> Ver Divergencias
            </a>
            <a href="{{ url_for('recebimento_views.depara_fornecedor') }}" class="btn btn-outline-primary me-2">
                <i class="fas fa-exchange-alt"></i> De-Para
            </a>
            <button type="button" class="btn btn-outline-primary" id="btnExecutarValidacao" onclick="executarValidacao()">
                <i class="fas fa-sync-alt"></i> Executar Validação
            </button>
        </div>
    </div>

    <!-- Cards de Estatisticas -->
    <div class="row mb-4">
        <div class="col">
            <div class="card border-left-secondary">
                <div class="card-body py-2">
                    <h6 class="text-muted text-uppercase small mb-1">Pendentes</h6>
                    <h3 class="mb-0 text-secondary">{{ stats.pendente }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card border-left-success">
                <div class="card-body py-2">
                    <h6 class="text-muted text-uppercase small mb-1">Aprovados</h6>
                    <h3 class="mb-0 text-success">{{ stats.aprovado }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card border-left-warning">
                <div class="card-body py-2">
                    <h6 class="text-muted text-uppercase small mb-1">Bloqueados</h6>
                    <h3 class="mb-0 text-warning">{{ stats.bloqueado }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card border-left-info">
                <div class="card-body py-2">
                    <h6 class="text-muted text-uppercase small mb-1">Consolidados</h6>
                    <h3 class="mb-0 text-info">{{ stats.consolidado }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card border-left-dark">
                <div class="card-body py-2">
                    <h6 class="text-muted text-uppercase small mb-1">
                        <i class="fas fa-check-circle"></i> Finaliz. Odoo
                    </h6>
                    <h3 class="mb-0 text-dark">{{ stats.finalizado_odoo }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h6>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('recebimento_views.validacoes_nf_po') }}">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            {% for s in status_opcoes %}
                            <option value="{{ s.valor }}" {% if filtros.status == s.valor %}selected{% endif %}>
                                {{ s.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CNPJ Fornecedor</label>
                        <input type="text" name="cnpj" class="form-control form-control-sm"
                               value="{{ filtros.cnpj }}" placeholder="Digite o CNPJ...">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm me-2">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <a href="{{ url_for('recebimento_views.validacoes_nf_po') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-times"></i> Limpar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 100px;">Data / NF</th>
                            <th>Empresa</th>
                            <th>Fornecedor</th>
                            <th class="text-end">Valor</th>
                            <th class="text-center">Itens</th>
                            <th class="text-center">Status</th>
                            <th>PO Consolidado</th>
                            <th class="text-center" style="width: 150px;">Acoes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr data-id="{{ item.id }}">
                            <td class="text-center">
                                <small class="text-muted">{{ item.data_nf.strftime('%d/%m/%Y') if item.data_nf else 'N/A' }}</small>
                                <br><strong class="text-primary">{{ item.numero_nf or item.odoo_dfe_id }}</strong>
                            </td>
                            <td>
                                <strong>{{ (item.razao_empresa_compradora or 'N/A')|truncate(25) }}</strong>
                                <br><small class="text-muted">{{ item.cnpj_empresa_compradora|formatar_cnpj if item.cnpj_empresa_compradora else '-' }}</small>
                            </td>
                            <td>
                                <strong>{{ item.razao_fornecedor or 'N/A' }}</strong>
                                <br><small class="text-muted">{{ item.cnpj_fornecedor|formatar_cnpj if item.cnpj_fornecedor else '-' }}</small>
                            </td>
                            <td class="text-end">
                                {% if item.valor_total_nf %}
                                R$ {{ '{:,.2f}'.format(item.valor_total_nf).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <span class="badge bg-primary">{{ item.total_itens or 0 }}</span>
                                {% if item.itens_match %}
                                <br><small class="text-success">{{ item.itens_match }} OK</small>
                                {% endif %}
                                {% if item.itens_sem_depara %}
                                <br><small class="text-danger">{{ item.itens_sem_depara }} s/De-Para</small>
                                {% endif %}
                                {% if item.itens_sem_po %}
                                <br><small class="text-warning">{{ item.itens_sem_po }} s/PO</small>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if item.status == 'pendente' %}
                                <span class="badge bg-secondary">Pendente</span>
                                {% elif item.status == 'validando' %}
                                <span class="badge bg-info">Validando</span>
                                {% elif item.status == 'aprovado' %}
                                <span class="badge bg-success">Aprovado</span>
                                {% elif item.status == 'bloqueado' %}
                                <span class="badge bg-warning text-dark">Bloqueado</span>
                                {% elif item.status == 'consolidado' %}
                                <span class="badge bg-primary">Consolidado</span>
                                {% elif item.status == 'finalizado_odoo' %}
                                <span class="badge bg-dark" title="DFE ja possui PO vinculado no Odoo">
                                    <i class="fas fa-check-circle me-1"></i>Finalizado Odoo
                                </span>
                                {% elif item.status == 'erro' %}
                                <span class="badge bg-danger">Erro</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ item.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.po_consolidado_name %}
                                <a href="#" class="text-info fw-bold">{{ item.po_consolidado_name }}</a>
                                {% if item.consolidado_em %}
                                <br><small class="text-muted">{{ item.consolidado_em.strftime('%d/%m %H:%M') }}</small>
                                {% endif %}
                                {% elif item.status == 'finalizado_odoo' and item.odoo_po_vinculado_name %}
                                <span class="text-dark fw-bold" title="PO vinculado no Odoo">
                                    <i class="fas fa-link me-1"></i>{{ item.odoo_po_vinculado_name }}
                                </span>
                                <br><small class="text-muted">Vinculado no Odoo</small>
                                {% elif item.status == 'finalizado_odoo' and item.odoo_po_fiscal_name %}
                                <span class="text-dark fw-bold" title="PO fiscal vinculado no Odoo">
                                    <i class="fas fa-link me-1"></i>{{ item.odoo_po_fiscal_name }}
                                </span>
                                <br><small class="text-muted">PO Fiscal (Odoo)</small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-info" onclick="verDetalhes({{ item.id }})"
                                        title="Ver detalhes">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if item.status == 'pendente' %}
                                <button class="btn btn-sm btn-primary" onclick="validarNf({{ item.odoo_dfe_id }})"
                                        title="Validar">
                                    <i class="fas fa-play"></i>
                                </button>
                                {% elif item.status == 'aprovado' %}
                                <a href="{{ url_for('recebimento_views.preview_consolidacao', validacao_id=item.id) }}"
                                   class="btn btn-sm btn-success" title="Ver Preview e Consolidar">
                                    <i class="fas fa-compress-arrows-alt"></i>
                                </a>
                                {% elif item.status == 'consolidado' %}
                                <button class="btn btn-sm btn-outline-warning" onclick="reverterConsolidacao({{ item.id }})"
                                        title="Reverter">
                                    <i class="fas fa-undo"></i>
                                </button>
                                {% elif item.status == 'finalizado_odoo' %}
                                <span class="text-muted" title="DFE finalizado - nao requer acao">
                                    <i class="fas fa-check-double"></i>
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                Nenhuma validacao encontrada
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Paginacao -->
    {% if paginacao.pages > 1 %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if paginacao.page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page={{ paginacao.page - 1 }}&status={{ filtros.status }}&cnpj={{ filtros.cnpj }}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            {% for p in range(1, paginacao.pages + 1) %}
            <li class="page-item {% if p == paginacao.page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}&status={{ filtros.status }}&cnpj={{ filtros.cnpj }}">{{ p }}</a>
            </li>
            {% endfor %}

            {% if paginacao.page < paginacao.pages %}
            <li class="page-item">
                <a class="page-link" href="?page={{ paginacao.page + 1 }}&status={{ filtros.status }}&cnpj={{ filtros.cnpj }}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Modal Detalhes -->
<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Validacao</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetalhesBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
const modalDetalhes = new bootstrap.Modal(document.getElementById('modalDetalhes'));

function verDetalhes(id) {
    document.getElementById('modalDetalhesBody').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    `;
    modalDetalhes.show();

    fetch(`/api/recebimento/validacoes-nf-po/${id}`)
        .then(r => r.json())
        .then(data => {
            if (data.sucesso) {
                renderizarDetalhes(data);
            } else {
                document.getElementById('modalDetalhesBody').innerHTML = `
                    <div class="alert alert-danger">Erro: ${data.erro}</div>
                `;
            }
        });
}

function renderizarDetalhes(data) {
    const v = data.validacao;
    const matches = data.matches;
    const divergencias = data.divergencias;

    let html = `
        <div class="row mb-4">
            <div class="col-md-6">
                <h6>Dados da NF</h6>
                <table class="table table-sm">
                    <tr><td>Numero:</td><td><strong>${v.numero_nf || v.odoo_dfe_id}</strong></td></tr>
                    <tr><td>Data:</td><td>${v.data_nf || 'N/A'}</td></tr>
                    <tr><td>Valor:</td><td>R$ ${v.valor_total_nf?.toFixed(2) || 'N/A'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Fornecedor</h6>
                <table class="table table-sm">
                    <tr><td>Razao:</td><td><strong>${v.razao_fornecedor || 'N/A'}</strong></td></tr>
                    <tr><td>CNPJ:</td><td>${v.cnpj_fornecedor}</td></tr>
                </table>
            </div>
        </div>
    `;

    // Mostrar informacao especial se status for finalizado_odoo
    if (v.status === 'finalizado_odoo') {
        html += `
            <div class="alert alert-dark mb-4">
                <h6 class="mb-2"><i class="fas fa-check-circle me-2"></i>DFE Finalizado no Odoo</h6>
                <p class="mb-0">Este DFE ja possui PO vinculado diretamente no Odoo e nao requer validacao manual.</p>
                <table class="table table-sm table-borderless mt-2 mb-0">
                    ${v.odoo_po_vinculado_name ? `<tr><td><strong>PO Vinculado:</strong></td><td>${v.odoo_po_vinculado_name} (ID: ${v.odoo_po_vinculado_id})</td></tr>` : ''}
                    ${v.odoo_po_fiscal_name ? `<tr><td><strong>PO Fiscal:</strong></td><td>${v.odoo_po_fiscal_name} (ID: ${v.odoo_po_fiscal_id})</td></tr>` : ''}
                    ${v.pos_vinculados_importados_em ? `<tr><td><strong>Importado em:</strong></td><td>${v.pos_vinculados_importados_em}</td></tr>` : ''}
                </table>
            </div>
        `;

        // Nao mostrar tabela de matches se nao houver
        if (matches.length === 0) {
            document.getElementById('modalDetalhesBody').innerHTML = html;
            return;
        }
    }

    html += `<h6>Resultado do Match (${matches.length} itens)</h6>
        <table class="table table-sm table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Produto</th>
                    <th class="text-end">Qtd NF</th>
                    <th class="text-end">Preco NF</th>
                    <th>PO</th>
                    <th class="text-end">Qtd PO</th>
                    <th class="text-center">Status</th>
                </tr>
            </thead>
            <tbody>
    `;

    for (const m of matches) {
        let statusBadge = '';
        if (m.status_match === 'match') {
            statusBadge = '<span class="badge bg-success">Match</span>';
        } else if (m.status_match === 'sem_depara') {
            statusBadge = '<span class="badge bg-secondary">Sem De-Para</span>';
        } else if (m.status_match === 'sem_po') {
            statusBadge = '<span class="badge bg-warning">Sem PO</span>';
        } else {
            statusBadge = `<span class="badge bg-danger">${m.status_match}</span>`;
        }

        html += `
            <tr>
                <td>
                    <code>${m.cod_produto_fornecedor || 'N/A'}</code>
                    ${m.cod_produto_interno ? `<i class="fas fa-arrow-right mx-1"></i><code class="text-success">${m.cod_produto_interno}</code>` : ''}
                    <br><small>${m.nome_produto || ''}</small>
                </td>
                <td class="text-end">${m.qtd_nf?.toFixed(2) || 'N/A'}</td>
                <td class="text-end">${m.preco_nf?.toFixed(4) || 'N/A'}</td>
                <td>${m.odoo_po_name || '-'}</td>
                <td class="text-end">${m.qtd_po?.toFixed(2) || '-'}</td>
                <td class="text-center">${statusBadge}</td>
            </tr>
        `;
    }

    html += '</tbody></table>';

    if (divergencias.length > 0) {
        html += `
            <h6 class="mt-4">Divergencias (${divergencias.length})</h6>
            <table class="table table-sm table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Tipo</th>
                        <th>Produto</th>
                        <th>NF</th>
                        <th>PO</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
        `;

        for (const d of divergencias) {
            html += `
                <tr>
                    <td><span class="badge bg-warning">${d.tipo_divergencia}</span></td>
                    <td>${d.nome_produto || d.cod_produto_fornecedor}</td>
                    <td>${d.valor_nf || 'N/A'}</td>
                    <td>${d.valor_po || 'N/A'}</td>
                    <td>${d.status}</td>
                </tr>
            `;
        }

        html += '</tbody></table>';
    }

    document.getElementById('modalDetalhesBody').innerHTML = html;
}

function validarNf(dfeId) {
    if (!confirm('Validar esta NF contra os POs do fornecedor?')) return;

    fetch(`/api/recebimento/validar-nf-po/${dfeId}`, {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.status === 'aprovado') {
                alert('NF aprovada! Todos os itens com match.');
            } else if (data.status === 'bloqueado') {
                alert('NF bloqueada: ' + data.mensagem);
            } else {
                alert('Erro: ' + data.mensagem);
            }
            location.reload();
        });
}

function consolidarPos(validacaoId) {
    if (!confirm('Consolidar os POs desta NF?\n\nEsta acao ira:\n- Unificar POs em 1 principal\n- Criar POs de saldo se necessario\n- Cancelar POs vazios')) return;

    fetch(`/api/recebimento/consolidar-pos/${validacaoId}`, {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.sucesso) {
                alert(`Consolidacao concluida!\n\nPO principal: ${data.po_consolidado_name}\nSaldos criados: ${data.pos_saldo_criados?.length || 0}`);
                location.reload();
            } else {
                alert('Erro: ' + data.erro);
            }
        });
}

function reverterConsolidacao(validacaoId) {
    if (!confirm('ATENCAO: Reverter consolidacao?\n\nEsta acao pode nao ser 100% reversivel.')) return;

    fetch(`/api/recebimento/reverter-consolidacao/${validacaoId}`, {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.sucesso) {
                alert('Consolidacao revertida!');
                location.reload();
            } else {
                alert('Erro: ' + data.erro);
            }
        });
}

// =============================================================================
// EXECUTAR VALIDACAO (como o scheduler faz)
// =============================================================================

function executarValidacao() {
    const btn = document.getElementById('btnExecutarValidacao');
    const originalHtml = btn.innerHTML;

    // Mostrar loading
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executando...';
    btn.disabled = true;

    fetch('/api/recebimento/executar-validacao', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.sucesso) {
            const res = data.resultado || {};
            const msg = [
                'Validacao executada com sucesso!',
                '',
                `DFEs processados: ${res.dfes_processados || 0}`,
                `Fase 1 - Aprovados: ${res.fase1_fiscal?.dfes_aprovados || 0}`,
                `Fase 1 - Bloqueados: ${res.fase1_fiscal?.dfes_bloqueados || 0}`,
                `Fase 2 - Aprovados: ${res.fase2_nf_po?.dfes_aprovados || 0}`,
                `Fase 2 - Bloqueados: ${res.fase2_nf_po?.dfes_bloqueados || 0}`
            ].join('\n');
            alert(msg);
            location.reload();
        } else {
            alert('Erro: ' + (data.erro || 'Erro desconhecido'));
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    })
    .catch(err => {
        alert('Erro de conexao: ' + err.message);
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    });
}
</script>
{% endblock %}
