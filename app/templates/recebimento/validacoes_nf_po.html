{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-clipboard-check text-info me-2"></i>Validacoes NF x PO</h2>
            <p class="text-muted mb-0">Status de validacao de NF-e contra Pedidos de Compra</p>
        </div>
        <div>
            <a href="{{ url_for('recebimento_fisico_views.index') }}" class="btn btn-outline-success me-2">
                <i class="fas fa-boxes"></i> Recebimento Físico
            </a>
            <a href="{{ url_for('recebimento_views.divergencias_nf_po') }}" class="btn btn-outline-warning me-2">
                <i class="fas fa-exclamation-triangle"></i> Ver Divergencias
            </a>
            <a href="{{ url_for('recebimento_views.depara_fornecedor') }}" class="btn btn-outline-primary me-2">
                <i class="fas fa-exchange-alt"></i> De-Para
            </a>
            <button type="button" class="btn btn-outline-primary" id="btnExecutarValidacao" data-bs-toggle="modal" data-bs-target="#modalValidacao">
                <i class="fas fa-sync-alt"></i> Executar Validação
            </button>
        </div>
    </div>

    <!-- Cards de Estatisticas -->
    <div class="row mb-4">
        <div class="col">
            <div class="card border-left-secondary">
                <div class="card-body py-2">
                    <h6 class="text-muted text-uppercase small mb-1">Pendentes</h6>
                    <h3 class="mb-0 text-secondary">{{ stats.pendente }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card border-left-success">
                <div class="card-body py-2">
                    <h6 class="text-muted text-uppercase small mb-1">Aprovados</h6>
                    <h3 class="mb-0 text-success">{{ stats.aprovado }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card border-left-warning">
                <div class="card-body py-2">
                    <h6 class="text-muted text-uppercase small mb-1">Bloqueados</h6>
                    <h3 class="mb-0 text-warning">{{ stats.bloqueado }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card border-left-info">
                <div class="card-body py-2">
                    <h6 class="text-muted text-uppercase small mb-1">Consolidados</h6>
                    <h3 class="mb-0 text-info">{{ stats.consolidado }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card border-left-dark">
                <div class="card-body py-2">
                    <h6 class="text-muted text-uppercase small mb-1">
                        <i class="fas fa-check-circle"></i> Finaliz. Odoo
                    </h6>
                    <h3 class="mb-0 text-dark">{{ stats.finalizado_odoo }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h6>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('recebimento_views.validacoes_nf_po') }}">
                <div class="row g-2">
                    <!-- Linha 1: Status, NF, CNPJ Fornecedor, Nome Fornecedor -->
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            {% for s in status_opcoes %}
                            <option value="{{ s.valor }}" {% if filtros.status == s.valor %}selected{% endif %}>
                                {{ s.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">NF</label>
                        <input type="text" name="numero_nf" class="form-control form-control-sm"
                               value="{{ filtros.numero_nf }}" placeholder="Numero...">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">CNPJ Fornecedor</label>
                        <input type="text" name="cnpj" class="form-control form-control-sm"
                               value="{{ filtros.cnpj }}" placeholder="CNPJ...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Nome Fornecedor</label>
                        <input type="text" name="nome_fornecedor" class="form-control form-control-sm"
                               value="{{ filtros.nome_fornecedor }}" placeholder="Razao social...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Empresa</label>
                        <select name="empresa" class="form-select form-select-sm">
                            <option value="">Todas</option>
                            {% for e in empresas_opcoes %}
                            <option value="{{ e.cnpj }}" {% if filtros.empresa == e.cnpj %}selected{% endif %}>
                                {{ e.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <!-- Linha 2: PO + Botoes -->
                    <div class="col-md-2">
                        <label class="form-label">PO</label>
                        <input type="text" name="po_name" class="form-control form-control-sm"
                               value="{{ filtros.po_name }}" placeholder="Nome PO...">
                    </div>
                    <div class="col-md-10 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm me-2">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <a href="{{ url_for('recebimento_views.validacoes_nf_po') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-times"></i> Limpar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 100px;">Data / NF</th>
                            <th>Empresa</th>
                            <th>Fornecedor</th>
                            <th class="text-end">Valor</th>
                            <th class="text-center">Itens</th>
                            <th>PO Origem</th>
                            <th class="text-center">Status</th>
                            <th>PO Consolidado</th>
                            <th class="text-center" style="width: 150px;">Acoes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr data-id="{{ item.id }}">
                            {% set tem_divergencias = (item.itens_sem_depara or 0) + (item.itens_sem_po or 0) + (item.itens_preco_diverge or 0) + (item.itens_data_diverge or 0) + (item.itens_qtd_diverge or 0) %}
                            <td class="text-center">
                                <small class="text-muted">{{ item.data_nf|formatar_data_segura or 'N/A' }}</small>
                                <br><strong class="text-primary">{{ item.numero_nf or item.odoo_dfe_id }}</strong>
                            </td>
                            <td{% if tem_divergencias > 0 %} class="rec-expandable" onclick="toggleDivergencias({{ item.id }})"{% endif %}>
                                <strong>{{ (item.razao_empresa_compradora or 'N/A')|truncate(25) }}</strong>
                                <br><small class="text-muted">{{ item.cnpj_empresa_compradora|formatar_cnpj if item.cnpj_empresa_compradora else '-' }}</small>
                            </td>
                            <td{% if tem_divergencias > 0 %} class="rec-expandable" onclick="toggleDivergencias({{ item.id }})"{% endif %}>
                                <strong>{{ item.razao_fornecedor or 'N/A' }}</strong>
                                <br><small class="text-muted">{{ item.cnpj_fornecedor|formatar_cnpj if item.cnpj_fornecedor else '-' }}</small>
                            </td>
                            <td class="text-end{% if tem_divergencias > 0 %} rec-expandable{% endif %}"{% if tem_divergencias > 0 %} onclick="toggleDivergencias({{ item.id }})"{% endif %}>
                                {% if item.valor_total_nf %}
                                R$ {{ '{:,.2f}'.format(item.valor_total_nf).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                            <td class="text-center{% if tem_divergencias > 0 %} rec-expandable{% endif %}"{% if tem_divergencias > 0 %} onclick="toggleDivergencias({{ item.id }})"{% endif %}>
                                <span class="badge bg-primary">{{ item.total_itens or 0 }}</span>
                                {% if item.itens_match %}
                                <br><small class="text-success">{{ item.itens_match }} OK</small>
                                {% endif %}
                                {% if tem_divergencias > 0 %}
                                <div class="rec-expand-indicator mt-1">
                                    {% if item.itens_sem_depara %}
                                    <small class="text-danger d-block">{{ item.itens_sem_depara }} s/De-Para</small>
                                    {% endif %}
                                    {% if item.itens_sem_po %}
                                    <small class="text-warning d-block">{{ item.itens_sem_po }} s/PO</small>
                                    {% endif %}
                                    {% if item.itens_preco_diverge %}
                                    <small class="text-danger d-block">{{ item.itens_preco_diverge }} preco</small>
                                    {% endif %}
                                    {% if item.itens_qtd_diverge %}
                                    <small class="text-warning d-block">{{ item.itens_qtd_diverge }} qtd</small>
                                    {% endif %}
                                    {% if item.itens_data_diverge %}
                                    <small class="text-warning d-block">{{ item.itens_data_diverge }} data</small>
                                    {% endif %}
                                    <i class="fas fa-chevron-down rec-chevron"></i>
                                </div>
                                {% else %}
                                    {% if item.itens_sem_depara %}
                                    <br><small class="text-danger">{{ item.itens_sem_depara }} s/De-Para</small>
                                    {% endif %}
                                    {% if item.itens_sem_po %}
                                    <br><small class="text-warning">{{ item.itens_sem_po }} s/PO</small>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {% set pos_origem = pos_origem_map.get(item.id, []) %}
                                {% if pos_origem %}
                                    {% for po in pos_origem %}
                                    <a href="https://odoo.nacomgoya.com.br/web#id={{ po.id }}&model=purchase.order&view_type=form"
                                       target="_blank" class="badge bg-secondary me-1 text-decoration-none">
                                        {{ po.name }} <i class="fas fa-external-link-alt ms-1" style="font-size: 0.6rem;"></i>
                                    </a>
                                    {% endfor %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if item.status == 'pendente' %}
                                <span class="badge bg-secondary">Pendente</span>
                                {% elif item.status == 'validando' %}
                                <span class="badge bg-info">Validando</span>
                                {% elif item.status == 'aprovado' %}
                                <span class="badge bg-success">Aprovado</span>
                                {% elif item.status == 'bloqueado' %}
                                <span class="badge bg-warning text-dark">Bloqueado</span>
                                {# NOVO: Badge de situacao NF quando CANCELADA/INUTILIZADA #}
                                {% if item.situacao_dfe_odoo in ['CANCELADA', 'INUTILIZADA'] %}
                                <br><span class="badge bg-danger mt-1" title="NF {{ item.situacao_dfe_odoo }} na SEFAZ">
                                    <i class="fas fa-ban me-1"></i>NF - {{ item.situacao_dfe_odoo }}
                                </span>
                                {% endif %}
                                {% elif item.status == 'consolidado' %}
                                <span class="badge bg-primary">Consolidado</span>
                                {% elif item.status == 'finalizado_odoo' %}
                                <span class="badge bg-success" title="DFE ja possui PO vinculado no Odoo">
                                    <i class="fas fa-check-circle me-1"></i>Finalizado Odoo
                                </span>
                                {% elif item.status == 'erro' %}
                                <span class="badge bg-danger">Erro</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ item.status }}</span>
                                {% endif %}

                                {# Badge de Recebimento Fisico #}
                                {% set receb = recebimentos_map.get(item.id) %}
                                {% set po_id = item.po_consolidado_id or item.odoo_po_vinculado_id %}
                                {% set picking = pickings_map.get(po_id) if po_id and not receb else None %}

                                {% if receb %}
                                    {% if receb.odoo_status == 'done' or receb.status == 'processado' %}
                                    <br><span class="badge bg-success mt-1" title="Recebido em {{ receb.processado_em|formatar_data_hora_brasil or '-' }}">
                                        <i class="fas fa-check-double me-1"></i>Recebido
                                    </span>
                                    {% elif receb.status == 'processando' %}
                                    <br><span class="badge bg-info mt-1">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Processando
                                    </span>
                                    {% elif receb.status == 'erro' %}
                                    <br><span class="badge bg-danger mt-1" title="{{ receb.erro_mensagem[:50] if receb.erro_mensagem else 'Erro no processamento' }}">
                                        <i class="fas fa-exclamation-circle me-1"></i>Erro Receb.
                                    </span>
                                    {% elif receb.status == 'pendente' %}
                                    <br><span class="badge bg-warning text-dark mt-1">
                                        <i class="fas fa-clock me-1"></i>Aguard. Receb.
                                    </span>
                                    {% endif %}
                                {% elif picking %}
                                    {% if picking.state == 'done' %}
                                    <br><span class="badge bg-success mt-1" title="{{ picking.odoo_picking_name }}">
                                        <i class="fas fa-check-double me-1"></i>Recebido
                                    </span>
                                    {% elif picking.state == 'assigned' %}
                                    <br><span class="badge bg-primary mt-1" title="{{ picking.odoo_picking_name }}">
                                        <i class="fas fa-box-open me-1"></i>Pronto Receber
                                    </span>
                                    {% elif picking.state in ['waiting', 'confirmed'] %}
                                    <br><span class="badge bg-secondary mt-1" title="{{ picking.odoo_picking_name }}">
                                        <i class="fas fa-hourglass-half me-1"></i>Aguard. Estoque
                                    </span>
                                    {% endif %}
                                {% elif item.status in ['consolidado', 'finalizado_odoo'] %}
                                    <br><span class="badge bg-light text-muted mt-1 border">
                                        <i class="fas fa-hourglass-start me-1"></i>Sem Picking
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.po_consolidado_name %}
                                <a href="https://odoo.nacomgoya.com.br/web#id={{ item.po_consolidado_id }}&model=purchase.order&view_type=form"
                                   target="_blank" class="text-info fw-bold text-decoration-none">
                                    {{ item.po_consolidado_name }} <i class="fas fa-external-link-alt ms-1" style="font-size: 0.6rem;"></i>
                                </a>
                                {% if item.consolidado_em %}
                                <br><small class="text-muted">{{ item.consolidado_em|formatar_data_hora_brasil }}</small>
                                {% endif %}
                                {% elif item.status == 'finalizado_odoo' and item.odoo_po_vinculado_name %}
                                <a href="https://odoo.nacomgoya.com.br/web#id={{ item.odoo_po_vinculado_id }}&model=purchase.order&view_type=form"
                                   target="_blank" class="text-dark fw-bold text-decoration-none">
                                    <i class="fas fa-link me-1"></i>{{ item.odoo_po_vinculado_name }} <i class="fas fa-external-link-alt ms-1" style="font-size: 0.6rem;"></i>
                                </a>
                                <br><small class="text-muted">Vinculado no Odoo</small>
                                {% elif item.status == 'finalizado_odoo' and item.odoo_po_fiscal_name %}
                                <a href="https://odoo.nacomgoya.com.br/web#id={{ item.odoo_po_fiscal_id }}&model=purchase.order&view_type=form"
                                   target="_blank" class="text-dark fw-bold text-decoration-none">
                                    <i class="fas fa-link me-1"></i>{{ item.odoo_po_fiscal_name }} <i class="fas fa-external-link-alt ms-1" style="font-size: 0.6rem;"></i>
                                </a>
                                <br><small class="text-muted">PO Fiscal (Odoo)</small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-info" onclick="verDetalhes({{ item.id }})"
                                        title="Ver detalhes">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {# Botao Recebimento Fisico - apenas se picking pronto para receber #}
                                {% if picking and picking.state == 'assigned' and (not receb or receb.status not in ['processado', 'processando']) %}
                                <a href="{{ url_for('recebimento_fisico_views.index') }}?company_id={{ picking.company_id }}&filtro_nf={{ item.numero_nf or picking.odoo_picking_name }}"
                                   class="btn btn-sm btn-outline-success"
                                   title="Ir para Recebimento Físico"
                                   target="_blank">
                                    <i class="fas fa-boxes"></i>
                                </a>
                                {% endif %}
                                {% if item.status == 'pendente' %}
                                <button class="btn btn-sm btn-primary" onclick="validarNf({{ item.odoo_dfe_id }})"
                                        title="Validar">
                                    <i class="fas fa-play"></i>
                                </button>
                                {% elif item.status == 'aprovado' %}
                                <a href="{{ url_for('recebimento_views.preview_consolidacao', validacao_id=item.id) }}"
                                   class="btn btn-sm btn-success" title="Ver Preview e Consolidar">
                                    <i class="fas fa-compress-arrows-alt"></i>
                                </a>
                                {% elif item.status == 'consolidado' %}
                                <button class="btn btn-sm btn-outline-warning" onclick="reverterConsolidacao({{ item.id }})"
                                        title="Reverter">
                                    <i class="fas fa-undo"></i>
                                </button>
                                {% elif item.status == 'finalizado_odoo' %}
                                <span class="text-muted" title="DFE finalizado - nao requer acao">
                                    <i class="fas fa-check-double"></i>
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {# Sub-row accordion para divergencias inline #}
                        {% if tem_divergencias > 0 %}
                        <tr class="rec-divergencias-row d-none" id="divRow-{{ item.id }}">
                            <td colspan="9" class="p-0 border-0">
                                <div id="divBody-{{ item.id }}"></div>
                            </td>
                        </tr>
                        {% endif %}
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                Nenhuma validacao encontrada
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Paginacao -->
    {% if paginacao.pages > 1 %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if paginacao.page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page={{ paginacao.page - 1 }}&status={{ filtros.status }}&cnpj={{ filtros.cnpj }}&numero_nf={{ filtros.numero_nf }}&nome_fornecedor={{ filtros.nome_fornecedor }}&empresa={{ filtros.empresa }}&po_name={{ filtros.po_name }}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            {% for p in range(1, paginacao.pages + 1) %}
            <li class="page-item {% if p == paginacao.page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}&status={{ filtros.status }}&cnpj={{ filtros.cnpj }}&numero_nf={{ filtros.numero_nf }}&nome_fornecedor={{ filtros.nome_fornecedor }}&empresa={{ filtros.empresa }}&po_name={{ filtros.po_name }}">{{ p }}</a>
            </li>
            {% endfor %}

            {% if paginacao.page < paginacao.pages %}
            <li class="page-item">
                <a class="page-link" href="?page={{ paginacao.page + 1 }}&status={{ filtros.status }}&cnpj={{ filtros.cnpj }}&numero_nf={{ filtros.numero_nf }}&nome_fornecedor={{ filtros.nome_fornecedor }}&empresa={{ filtros.empresa }}&po_name={{ filtros.po_name }}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Modal Executar Validacao (com periodo De/Ate) -->
<div class="modal fade" id="modalValidacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sync-alt text-primary me-2"></i>Executar Validação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">
                    O sistema buscará DFEs de compra (NF-e) modificados no período selecionado
                    e executará as validações Fase 1 (Fiscal) e Fase 2 (NF×PO).
                </p>
                <div class="row g-3">
                    <div class="col-6">
                        <label class="form-label">De</label>
                        <input type="date" class="form-control" id="validacaoDataDe">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Até</label>
                        <input type="date" class="form-control" id="validacaoDataAte">
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Período máximo: 90 dias. Limite: 100 DFEs por execução.
                    </small>
                </div>
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-clock me-2"></i>
                    <strong>Nota:</strong> Esta operação inclui sincronização completa de POs, alocações e pickings.
                    Pode levar 2-3 minutos.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarValidacao" onclick="confirmarValidacao()">
                    <i class="fas fa-play"></i> Executar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalhes -->
<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Validacao</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetalhesBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% include 'recebimento/_modals_divergencias.html' %}

<!-- JavaScript externo -->
<script src="{{ url_for('static', filename='js/recebimento/divergencias_shared.js') }}"></script>
<script src="{{ url_for('static', filename='js/recebimento/validacoes_nf_po.js') }}"></script>
{% endblock %}
