{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-object-group text-primary me-2"></i>Preview de SPLIT/Consolidação</h2>
            <p class="text-muted mb-0">Revise as ações antes de aprovar a operação</p>
        </div>
        <div>
            <a href="{{ url_for('recebimento_views.validacoes_nf_po') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Info da NF -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Dados da NF-e</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>Numero NF:</strong>
                    <p class="mb-0">{{ validacao.numero_nf or validacao.odoo_dfe_id }}</p>
                </div>
                <div class="col-md-3">
                    <strong>Data:</strong>
                    <p class="mb-0">{{ validacao.data_nf.strftime('%d/%m/%Y') if validacao.data_nf else 'N/A' }}</p>
                </div>
                <div class="col-md-3">
                    <strong>Fornecedor:</strong>
                    <p class="mb-0">{{ validacao.razao_fornecedor or 'N/A' }}</p>
                </div>
                <div class="col-md-3">
                    <strong>CNPJ:</strong>
                    <p class="mb-0">{{ validacao.cnpj_fornecedor }}</p>
                </div>
            </div>
        </div>
    </div>

    {% if preview.erro %}
    <!-- Erro no Preview -->
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Erro ao gerar preview:</strong> {{ preview.erro }}
    </div>
    {% else %}

    <!-- Explicação da Operação -->
    <div class="alert alert-info mb-4">
        <h5><i class="fas fa-info-circle me-2"></i>Como funciona o SPLIT/Consolidação</h5>
        <p class="mb-2">Esta operação irá:</p>
        <ol class="mb-0">
            <li><strong>Criar um novo PO Conciliador</strong> que casará 100% com a NF</li>
            <li><strong>Reduzir as quantidades</strong> nos POs originais (ficarão como SALDO para futuras entregas)</li>
            <li><strong>Vincular a NF</strong> ao PO Conciliador criado</li>
        </ol>
    </div>

    <!-- Resumo Visual -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h5 class="text-success"><i class="fas fa-plus-square"></i></h5>
                    <h3 class="mb-0">PO Conciliador</h3>
                    <small class="text-muted">Será criado NOVO</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="text-primary"><i class="fas fa-shopping-cart"></i></h5>
                    <h3 class="mb-0">{{ preview.resumo.pos_originais_envolvidos }}</h3>
                    <small class="text-muted">POs Originais</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="text-warning"><i class="fas fa-boxes"></i></h5>
                    <h3 class="mb-0">{{ preview.resumo.pos_com_saldo }}</h3>
                    <small class="text-muted">POs com Saldo</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="text-info"><i class="fas fa-list"></i></h5>
                    <h3 class="mb-0">{{ preview.resumo.itens_no_conciliador }}</h3>
                    <small class="text-muted">Itens no Conciliador</small>
                </div>
            </div>
        </div>
    </div>

    <!-- PO Conciliador (NOVO) -->
    <div class="card mb-4 border-success">
        <div class="card-header bg-success text-white">
            <h6 class="mb-0">
                <i class="fas fa-plus-square me-2"></i>
                PO CONCILIADOR (será criado)
                <span class="badge bg-light text-success ms-2">NOVO</span>
            </h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Produto</th>
                            <th class="text-center">Qtd</th>
                            <th class="text-end">Preço Unit.</th>
                            <th class="text-end">Valor</th>
                            <th>Origem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if preview.po_conciliador and preview.po_conciliador.itens %}
                        {% for item in preview.po_conciliador.itens %}
                        <tr>
                            <td>
                                <strong>{{ item.cod_produto }}</strong>
                                <br><small class="text-muted">{{ (item.nome_produto or '')[:50] }}{% if (item.nome_produto or '')|length > 50 %}...{% endif %}</small>
                            </td>
                            <td class="text-center">{{ item.qtd|int }} un</td>
                            <td class="text-end">R$ {{ "%.4f"|format(item.preco) }}</td>
                            <td class="text-end">R$ {{ "%.2f"|format(item.valor) }}</td>
                            <td><span class="badge bg-secondary">{{ item.po_origem }}</span></td>
                        </tr>
                        {% endfor %}
                        <tr class="table-success">
                            <td colspan="3"><strong>TOTAL DO PO CONCILIADOR</strong></td>
                            <td class="text-end"><strong>R$ {{ "%.2f"|format(preview.po_conciliador.valor) }}</strong></td>
                            <td></td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- POs Originais (ficarão com SALDO) -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h6 class="mb-0">
                <i class="fas fa-boxes me-2"></i>
                POs ORIGINAIS (ficarão com SALDO)
            </h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>PO Original</th>
                            <th>Produto</th>
                            <th class="text-center">Qtd Original</th>
                            <th class="text-center">Usado na NF</th>
                            <th class="text-center">SALDO</th>
                            <th class="text-center">Data Prevista</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for po in preview.pos_originais %}
                        {% for item in po.itens %}
                        <tr>
                            {% if loop.first %}
                            <td rowspan="{{ po.itens|length }}">
                                <strong class="text-primary">{{ po.po_name }}</strong>
                            </td>
                            {% endif %}
                            <td>
                                <strong>{{ item.cod_produto }}</strong>
                                <br><small class="text-muted">{{ (item.nome_produto or '')[:40] }}{% if (item.nome_produto or '')|length > 40 %}...{% endif %}</small>
                            </td>
                            <td class="text-center">{{ item.qtd_original|int }} un</td>
                            <td class="text-center text-danger">-{{ item.qtd_usada|int }} un</td>
                            <td class="text-center">
                                {% if item.qtd_saldo > 0 %}
                                <strong class="text-warning">{{ item.qtd_saldo|int }} un</strong>
                                {% else %}
                                <span class="text-muted">0 un</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {{ item.data_po or '-' }}
                            </td>
                            <td class="text-center">
                                {% if item.qtd_saldo > 0 %}
                                <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> SALDO</span>
                                {% else %}
                                <span class="badge bg-secondary"><i class="fas fa-check"></i> Zerado</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Lista de Ações -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h6 class="mb-0"><i class="fas fa-list-ol me-2"></i>Ações que Serão Executadas no Odoo ({{ preview.acoes|length }} ações)</h6>
        </div>
        <div class="card-body">
            <div class="rec-timeline">
                {% for acao in preview.acoes %}
                <div class="rec-timeline-item d-flex mb-3">
                    <div class="timeline-marker me-3">
                        <span class="badge bg-{{ acao.cor }} rounded-circle" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                            <i class="{{ acao.icone }}"></i>
                        </span>
                    </div>
                    <div class="timeline-content flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>{{ acao.tipo|replace('_', ' ')|title }}</strong>
                                <p class="text-muted mb-0">{{ acao.descricao }}</p>
                            </div>
                            <span class="badge bg-{{ acao.cor }}">{{ loop.index }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Alerta -->
    <div class="alert alert-warning">
        <h5><i class="fas fa-exclamation-triangle me-2"></i>Atenção!</h5>
        <ul class="mb-0">
            <li>Ao confirmar, um <strong>NOVO PO Conciliador</strong> será criado no Odoo.</li>
            <li>Os POs originais terão suas quantidades <strong>REDUZIDAS</strong> para o saldo restante.</li>
            <li>A NF será vinculada ao PO Conciliador criado.</li>
            <li>Esta operação pode ser parcialmente revertida se necessário.</li>
        </ul>
    </div>

    <!-- Botões de Ação -->
    <div class="d-flex justify-content-end gap-3">
        <a href="{{ url_for('recebimento_views.validacoes_nf_po') }}" class="btn btn-lg btn-outline-secondary">
            <i class="fas fa-times me-2"></i>Cancelar
        </a>
        <button type="button" class="btn btn-lg btn-success" onclick="confirmarConsolidacao()">
            <i class="fas fa-check me-2"></i>Confirmar SPLIT/Consolidação
        </button>
    </div>

    {% endif %}
</div>

{# Styles moved to app/static/css/modules/_recebimento.css #}

<script>
function confirmarConsolidacao() {
    if (!confirm('CONFIRMAÇÃO FINAL\n\nVocê tem certeza que deseja executar o SPLIT/Consolidação?\n\n• Um NOVO PO Conciliador será criado\n• Os POs originais terão quantidades reduzidas\n• A NF será vinculada ao novo PO')) {
        return;
    }

    // Mostrar loading
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processando...';

    fetch('/api/recebimento/consolidar-pos/{{ validacao.id }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
        },
        body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
        if (data.sucesso) {
            alert('SPLIT/Consolidação realizada com sucesso!\n\nPO Conciliador criado: ' + data.po_consolidado_name);
            window.location.href = '{{ url_for("recebimento_views.validacoes_nf_po") }}';
        } else {
            alert('Erro na operação: ' + (data.erro || 'Erro desconhecido'));
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Confirmar SPLIT/Consolidação';
        }
    })
    .catch(err => {
        alert('Erro ao comunicar com o servidor: ' + err);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Confirmar SPLIT/Consolidação';
    });
}
</script>
{% endblock %}
