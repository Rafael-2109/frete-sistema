{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-barcode text-primary me-2"></i>Cadastro NCM - IBS/CBS</h2>
            <p class="text-muted mb-0">Reforma Tributaria 2026 - NCMs validados pelo departamento fiscal</p>
        </div>
        <div>
            <button type="button" class="btn btn-success" onclick="abrirModalNovo()">
                <i class="fas fa-plus me-1"></i> Novo NCM
            </button>
            <button type="button" class="btn btn-outline-primary ms-2" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
        </div>
    </div>

    <!-- Cards de Estatisticas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-left-primary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Total Cadastrados</h6>
                    <h2 class="mb-0">{{ stats.total }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-success">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Ativos</h6>
                    <h2 class="mb-0">{{ stats.ativos }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-secondary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Inativos</h6>
                    <h2 class="mb-0">{{ stats.inativos }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Informacao sobre aliquotas CTe -->
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle me-2"></i>
        <strong>CTe:</strong> Aliquotas FIXAS - CST=000, cClassTrib=000001, pIBSUF=0.10%, pIBSMun=0.00%, pCBS=0.90% (sem reducao).
        <br>
        <strong>NF-e:</strong> Aliquotas por NCM (4 primeiros digitos) conforme cadastro abaixo, COM reducao quando aplicavel.
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h6>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('recebimento_views.ncm_ibscbs') }}">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">NCM ou Descricao</label>
                        <input type="text" name="ncm" class="form-control form-control-sm"
                               value="{{ filtros.ncm }}" placeholder="Digite o NCM ou descricao...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select name="apenas_ativos" class="form-select form-select-sm">
                            <option value="1" {% if filtros.apenas_ativos %}selected{% endif %}>Apenas Ativos</option>
                            <option value="0" {% if not filtros.apenas_ativos %}selected{% endif %}>Todos</option>
                        </select>
                    </div>
                    <div class="col-md-5 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-sm me-2">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                        <a href="{{ url_for('recebimento_views.ncm_ibscbs') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-times"></i> Limpar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela de NCMs -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 80px;">NCM</th>
                            <th>Descricao</th>
                            <th style="width: 80px;" class="text-center">CST</th>
                            <th style="width: 100px;" class="text-center">ClassTrib</th>
                            <th style="width: 80px;" class="text-center">IBS UF</th>
                            <th style="width: 80px;" class="text-center">IBS Mun</th>
                            <th style="width: 80px;" class="text-center">CBS</th>
                            <th style="width: 80px;" class="text-center">Reducao</th>
                            <th style="width: 70px;">Status</th>
                            <th style="width: 100px;">Acoes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in paginacao.items %}
                        <tr>
                            <td>
                                <code class="fs-6 fw-bold">{{ item.ncm_prefixo }}</code>
                            </td>
                            <td>
                                <span title="{{ item.descricao_ncm }}">
                                    {{ item.descricao_ncm[:80] + '...' if item.descricao_ncm and item.descricao_ncm|length > 80 else item.descricao_ncm or '-' }}
                                </span>
                            </td>
                            <td class="text-center">
                                <code>{{ item.cst_esperado or '-' }}</code>
                            </td>
                            <td class="text-center">
                                <code>{{ item.class_trib_codigo or '-' }}</code>
                            </td>
                            <td class="text-center">
                                {% if item.aliquota_ibs_uf is not none %}
                                <span class="badge bg-primary">{{ item.aliquota_ibs_uf }}%</span>
                                {% else %}-{% endif %}
                            </td>
                            <td class="text-center">
                                {% if item.aliquota_ibs_mun is not none %}
                                <span class="badge bg-info">{{ item.aliquota_ibs_mun }}%</span>
                                {% else %}-{% endif %}
                            </td>
                            <td class="text-center">
                                {% if item.aliquota_cbs is not none %}
                                <span class="badge bg-success">{{ item.aliquota_cbs }}%</span>
                                {% else %}-{% endif %}
                            </td>
                            <td class="text-center">
                                {% if item.reducao_aliquota and item.reducao_aliquota > 0 %}
                                <span class="badge bg-warning text-dark">{{ item.reducao_aliquota }}%</span>
                                {% else %}-{% endif %}
                            </td>
                            <td>
                                {% if item.ativo %}
                                <span class="badge bg-success">Ativo</span>
                                {% else %}
                                <span class="badge bg-secondary">Inativo</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary"
                                            onclick="abrirModalEditar({{ item.id }})"
                                            title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% if item.ativo %}
                                    <button type="button" class="btn btn-outline-danger"
                                            onclick="confirmarExcluir({{ item.id }}, '{{ item.ncm_prefixo }}')"
                                            title="Desativar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>
                                <span class="text-muted">Nenhum NCM cadastrado</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Paginacao -->
    {% if paginacao.pages > 1 %}
    <nav class="mt-3 d-flex justify-content-center">
        <ul class="pagination">
            <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('recebimento_views.ncm_ibscbs', page=1, **filtros) }}">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('recebimento_views.ncm_ibscbs', page=paginacao.page-1, **filtros) }}">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>

            {% for p in paginacao.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if p %}
                    <li class="page-item {% if p == paginacao.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('recebimento_views.ncm_ibscbs', page=p, **filtros) }}">{{ p }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('recebimento_views.ncm_ibscbs', page=paginacao.page+1, **filtros) }}">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('recebimento_views.ncm_ibscbs', page=paginacao.pages, **filtros) }}">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Modal Cadastro/Edicao -->
<div class="modal fade" id="modalNCM" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('recebimento_views.ncm_ibscbs_salvar') }}">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalNCMTitle">
                        <i class="fas fa-barcode me-2"></i>Cadastrar NCM IBS/CBS
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="ncm-id">

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">NCM Prefixo (4 digitos) <span class="text-danger">*</span></label>
                            <input type="text" name="ncm_prefixo" id="ncm-prefixo" class="form-control"
                                   maxlength="4" pattern="\d{4}" required
                                   placeholder="Ex: 2005">
                            <small class="text-muted">4 primeiros digitos do NCM</small>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Descricao</label>
                            <input type="text" name="descricao_ncm" id="ncm-descricao" class="form-control"
                                   placeholder="Ex: Conservas de produtos hortícolas">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">CST Esperado</label>
                            <input type="text" name="cst_esperado" id="ncm-cst" class="form-control"
                                   placeholder="Ex: 200">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Classificacao Tributaria</label>
                            <input type="text" name="class_trib_codigo" id="ncm-classtrib" class="form-control"
                                   placeholder="Ex: 200034">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Reducao Aliquota (%)</label>
                            <input type="text" name="reducao_aliquota" id="ncm-reducao" class="form-control"
                                   inputmode="decimal"
                                   placeholder="Ex: 60,00">
                            <small class="text-muted">Usado para calcular pAliqEfet</small>
                        </div>
                    </div>

                    <hr>
                    <h6 class="text-muted mb-3"><i class="fas fa-percent me-2"></i>Aliquotas Esperadas</h6>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">IBS UF (%)</label>
                            <input type="text" name="aliquota_ibs_uf" id="ncm-ibs-uf" class="form-control"
                                   inputmode="decimal"
                                   placeholder="Ex: 0,10">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">IBS Municipio (%)</label>
                            <input type="text" name="aliquota_ibs_mun" id="ncm-ibs-mun" class="form-control"
                                   inputmode="decimal"
                                   placeholder="Ex: 0,00">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">CBS (%)</label>
                            <input type="text" name="aliquota_cbs" id="ncm-cbs" class="form-control"
                                   inputmode="decimal"
                                   placeholder="Ex: 0,90">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Observacao</label>
                        <textarea name="observacao" id="ncm-observacao" class="form-control" rows="2"
                                  placeholder="Observacoes adicionais..."></textarea>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" name="ativo" id="ncm-ativo" class="form-check-input" value="1" checked>
                        <label class="form-check-label" for="ncm-ativo">NCM Ativo</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Confirmar Exclusao -->
<div class="modal fade" id="modalExcluir" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Desativacao
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja desativar o NCM <strong id="excluir-ncm"></strong>?</p>
                <p class="text-muted small">O NCM sera desativado e nao sera mais utilizado para validacao.</p>
            </div>
            <div class="modal-footer">
                <form method="POST" id="formExcluir">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i> Desativar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Atualizacao Odoo -->
<div class="modal fade" id="modalOdoo" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-cloud-upload-alt me-2"></i>Atualizar NCMs no Odoo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Mensagem de sucesso do salvamento local -->
                <div class="alert alert-success mb-3" id="odoo-msg-sucesso">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="odoo-msg-texto">NCM salvo com sucesso no sistema local!</span>
                </div>

                <!-- Informacoes do padrao cadastrado -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="mb-0"><i class="fas fa-cog me-2"></i>Padrao Cadastrado - Prefixo <code id="odoo-prefixo" class="text-white"></code></h6>
                    </div>
                    <div class="card-body py-2">
                        <div class="row small">
                            <div class="col-md-2">
                                <strong>CST:</strong> <span id="odoo-padrao-cst">-</span>
                            </div>
                            <div class="col-md-2">
                                <strong>ClassTrib:</strong> <span id="odoo-padrao-classtrib">-</span>
                            </div>
                            <div class="col-md-2">
                                <strong>IBS UF:</strong> <span id="odoo-padrao-ibs-uf">-</span>%
                            </div>
                            <div class="col-md-2">
                                <strong>IBS Mun:</strong> <span id="odoo-padrao-ibs-mun">-</span>%
                            </div>
                            <div class="col-md-2">
                                <strong>CBS:</strong> <span id="odoo-padrao-cbs">-</span>%
                            </div>
                            <div class="col-md-2">
                                <strong>Reducao:</strong> <span id="odoo-padrao-reducao">-</span>%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pergunta -->
                <div class="alert alert-warning">
                    <i class="fas fa-question-circle me-2"></i>
                    <strong>Deseja atualizar os NCM abaixo com prefixo <code id="odoo-prefixo-pergunta"></code> no Odoo?</strong>
                </div>

                <!-- Loading -->
                <div id="odoo-loading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted">Buscando NCMs no Odoo...</p>
                </div>

                <!-- Erro -->
                <div id="odoo-erro" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="odoo-erro-texto"></span>
                </div>

                <!-- Nenhum NCM -->
                <div id="odoo-vazio" class="alert alert-info" style="display: none;">
                    <i class="fas fa-info-circle me-2"></i>
                    Nenhum NCM encontrado com este prefixo no Odoo.
                </div>

                <!-- Tabela de NCMs do Odoo -->
                <div id="odoo-tabela-container" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">
                            <span id="odoo-total">0</span> NCM(s) encontrado(s) no Odoo
                        </span>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="odoo-selecionar-todos" checked>
                            <label class="form-check-label small" for="odoo-selecionar-todos">Selecionar todos</label>
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-bordered table-hover align-middle mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 40px;" class="text-center">
                                        <i class="fas fa-check"></i>
                                    </th>
                                    <th style="width: 100px;">NCM</th>
                                    <th>Descricao</th>
                                    <th style="width: 60px;" class="text-center">CST</th>
                                    <th style="width: 80px;" class="text-center">ClassTrib</th>
                                    <th style="width: 70px;" class="text-center">IBS UF</th>
                                    <th style="width: 70px;" class="text-center">IBS Mun</th>
                                    <th style="width: 60px;" class="text-center">CBS</th>
                                    <th style="width: 70px;" class="text-center">Reducao</th>
                                </tr>
                            </thead>
                            <tbody id="odoo-tabela-body">
                                <!-- Preenchido via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Resultado da atualizacao -->
                <div id="odoo-resultado" class="alert alert-success" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="odoo-resultado-texto"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btn-odoo-fechar">
                    <i class="fas fa-times me-1"></i> Fechar
                </button>
                <button type="button" class="btn btn-outline-secondary" id="btn-odoo-pular" onclick="pularAtualizacaoOdoo()">
                    <i class="fas fa-forward me-1"></i> Pular
                </button>
                <button type="button" class="btn btn-success" id="btn-odoo-atualizar" onclick="atualizarNcmsOdoo()">
                    <i class="fas fa-cloud-upload-alt me-1"></i> Atualizar Selecionados no Odoo
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    // Dados dos itens (serializado do backend)
    const itensData = {{ itens_json|safe }};

    // Modais
    let modalNCM = null;
    let modalExcluir = null;
    let modalOdoo = null;

    // Estado do padrao salvo (usado para atualizar no Odoo)
    let ncmSalvo = null;
    let ncmsOdoo = [];

    document.addEventListener('DOMContentLoaded', function() {
        modalNCM = new bootstrap.Modal(document.getElementById('modalNCM'));
        modalExcluir = new bootstrap.Modal(document.getElementById('modalExcluir'));
        modalOdoo = new bootstrap.Modal(document.getElementById('modalOdoo'));

        // Interceptar submit do form para usar AJAX
        document.querySelector('#modalNCM form').addEventListener('submit', function(e) {
            e.preventDefault();
            salvarNcmAjax();
        });

        // Checkbox selecionar todos
        document.getElementById('odoo-selecionar-todos').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#odoo-tabela-body input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = this.checked);
        });

        // Verificar se tem parametro cadastrar na URL para abrir modal automaticamente
        const urlParams = new URLSearchParams(window.location.search);
        const prefixoCadastrar = urlParams.get('cadastrar');
        if (prefixoCadastrar && /^\d{4}$/.test(prefixoCadastrar)) {
            // Abrir modal de cadastro com prefixo pre-preenchido
            setTimeout(function() {
                abrirModalNovoPrefixo(prefixoCadastrar);
            }, 300);
        }
    });

    // Abrir modal para novo NCM com prefixo pre-preenchido (usado via parametro URL)
    function abrirModalNovoPrefixo(prefixo) {
        document.getElementById('modalNCMTitle').innerHTML = '<i class="fas fa-barcode me-2"></i>Cadastrar NCM IBS/CBS';
        document.getElementById('ncm-id').value = '';
        document.getElementById('ncm-prefixo').value = prefixo;
        document.getElementById('ncm-prefixo').setAttribute('readonly', 'readonly');  // Bloqueado pois vem de pendencia
        document.getElementById('ncm-descricao').value = '';
        document.getElementById('ncm-cst').value = '';
        document.getElementById('ncm-classtrib').value = '';
        document.getElementById('ncm-reducao').value = '';
        document.getElementById('ncm-ibs-uf').value = '';
        document.getElementById('ncm-ibs-mun').value = '';
        document.getElementById('ncm-cbs').value = '';
        document.getElementById('ncm-observacao').value = '';
        document.getElementById('ncm-ativo').checked = true;
        modalNCM.show();

        // Focar no proximo campo (descricao) apos abrir modal
        setTimeout(function() {
            document.getElementById('ncm-descricao').focus();
        }, 500);
    }

    // Helper para formatar número BR (vírgula como separador decimal)
    function formatarBR(valor) {
        if (valor === null || valor === undefined || valor === '') return '';
        return parseFloat(valor).toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Abrir modal para novo NCM
    window.abrirModalNovo = function() {
        document.getElementById('modalNCMTitle').innerHTML = '<i class="fas fa-barcode me-2"></i>Cadastrar NCM IBS/CBS';
        document.getElementById('ncm-id').value = '';
        document.getElementById('ncm-prefixo').value = '';
        document.getElementById('ncm-prefixo').removeAttribute('readonly');
        document.getElementById('ncm-descricao').value = '';
        document.getElementById('ncm-cst').value = '';
        document.getElementById('ncm-classtrib').value = '';
        document.getElementById('ncm-reducao').value = '';
        document.getElementById('ncm-ibs-uf').value = '';
        document.getElementById('ncm-ibs-mun').value = '';
        document.getElementById('ncm-cbs').value = '';
        document.getElementById('ncm-observacao').value = '';
        document.getElementById('ncm-ativo').checked = true;
        modalNCM.show();
    };

    // Abrir modal para editar NCM
    window.abrirModalEditar = function(id) {
        const item = itensData.find(i => i.id === id);
        if (!item) {
            toastr.error('NCM nao encontrado');
            return;
        }

        document.getElementById('modalNCMTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Editar NCM IBS/CBS';
        document.getElementById('ncm-id').value = item.id;
        document.getElementById('ncm-prefixo').value = item.ncm_prefixo;
        document.getElementById('ncm-prefixo').setAttribute('readonly', 'readonly');
        document.getElementById('ncm-descricao').value = item.descricao_ncm || '';
        document.getElementById('ncm-cst').value = item.cst_esperado || '';
        document.getElementById('ncm-classtrib').value = item.class_trib_codigo || '';
        document.getElementById('ncm-reducao').value = formatarBR(item.reducao_aliquota);
        document.getElementById('ncm-ibs-uf').value = formatarBR(item.aliquota_ibs_uf);
        document.getElementById('ncm-ibs-mun').value = formatarBR(item.aliquota_ibs_mun);
        document.getElementById('ncm-cbs').value = formatarBR(item.aliquota_cbs);
        document.getElementById('ncm-observacao').value = item.observacao || '';
        document.getElementById('ncm-ativo').checked = item.ativo;
        modalNCM.show();
    };

    // Confirmar exclusao
    window.confirmarExcluir = function(id, ncm) {
        document.getElementById('excluir-ncm').textContent = ncm;
        document.getElementById('formExcluir').action = `/operacional/compras/ncm-ibscbs/${id}/excluir`;
        modalExcluir.show();
    };

    // Salvar NCM via AJAX
    async function salvarNcmAjax() {
        const dados = {
            id: document.getElementById('ncm-id').value || null,
            ncm_prefixo: document.getElementById('ncm-prefixo').value,
            descricao_ncm: document.getElementById('ncm-descricao').value,
            cst_esperado: document.getElementById('ncm-cst').value,
            class_trib_codigo: document.getElementById('ncm-classtrib').value,
            reducao_aliquota: document.getElementById('ncm-reducao').value || null,
            aliquota_ibs_uf: document.getElementById('ncm-ibs-uf').value || null,
            aliquota_ibs_mun: document.getElementById('ncm-ibs-mun').value || null,
            aliquota_cbs: document.getElementById('ncm-cbs').value || null,
            observacao: document.getElementById('ncm-observacao').value,
            ativo: document.getElementById('ncm-ativo').checked
        };

        try {
            // Salvar no sistema local
            const response = await fetch('/operacional/compras/ncm-ibscbs/salvar-ajax', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dados)
            });

            const result = await response.json();

            if (!result.sucesso) {
                toastr.error(result.mensagem);
                return;
            }

            // Guardar dados do NCM salvo
            ncmSalvo = result.ncm;

            // Fechar modal de cadastro
            modalNCM.hide();

            // Abrir modal do Odoo
            abrirModalOdoo(result.mensagem);

        } catch (error) {
            console.error('Erro ao salvar:', error);
            toastr.error('Erro ao salvar NCM');
        }
    }

    // Abrir modal do Odoo e buscar NCMs
    async function abrirModalOdoo(mensagemSucesso) {
        // Resetar estado do modal
        document.getElementById('odoo-msg-texto').textContent = mensagemSucesso;
        document.getElementById('odoo-prefixo').textContent = ncmSalvo.ncm_prefixo;
        document.getElementById('odoo-prefixo-pergunta').textContent = ncmSalvo.ncm_prefixo;

        // Preencher dados do padrao
        document.getElementById('odoo-padrao-cst').textContent = ncmSalvo.cst_esperado || '-';
        document.getElementById('odoo-padrao-classtrib').textContent = ncmSalvo.class_trib_codigo || '-';
        document.getElementById('odoo-padrao-ibs-uf').textContent = ncmSalvo.aliquota_ibs_uf ?? '-';
        document.getElementById('odoo-padrao-ibs-mun').textContent = ncmSalvo.aliquota_ibs_mun ?? '-';
        document.getElementById('odoo-padrao-cbs').textContent = ncmSalvo.aliquota_cbs ?? '-';
        document.getElementById('odoo-padrao-reducao').textContent = ncmSalvo.reducao_aliquota ?? '-';

        // Resetar estados visuais
        document.getElementById('odoo-loading').style.display = 'block';
        document.getElementById('odoo-erro').style.display = 'none';
        document.getElementById('odoo-vazio').style.display = 'none';
        document.getElementById('odoo-tabela-container').style.display = 'none';
        document.getElementById('odoo-resultado').style.display = 'none';
        document.getElementById('btn-odoo-atualizar').style.display = 'inline-block';
        document.getElementById('btn-odoo-pular').style.display = 'inline-block';
        document.getElementById('odoo-tabela-body').innerHTML = '';

        // Mostrar modal
        modalOdoo.show();

        // Buscar NCMs no Odoo
        try {
            const response = await fetch(`/operacional/compras/ncm-ibscbs/buscar-odoo/${ncmSalvo.ncm_prefixo}`);
            const result = await response.json();

            document.getElementById('odoo-loading').style.display = 'none';

            if (!result.sucesso) {
                document.getElementById('odoo-erro').style.display = 'block';
                document.getElementById('odoo-erro-texto').textContent = result.mensagem;
                return;
            }

            ncmsOdoo = result.ncms || [];

            if (ncmsOdoo.length === 0) {
                document.getElementById('odoo-vazio').style.display = 'block';
                document.getElementById('btn-odoo-atualizar').style.display = 'none';
                return;
            }

            // Preencher tabela
            document.getElementById('odoo-total').textContent = ncmsOdoo.length;
            preencherTabelaOdoo(ncmsOdoo);
            document.getElementById('odoo-tabela-container').style.display = 'block';

        } catch (error) {
            console.error('Erro ao buscar NCMs no Odoo:', error);
            document.getElementById('odoo-loading').style.display = 'none';
            document.getElementById('odoo-erro').style.display = 'block';
            document.getElementById('odoo-erro-texto').textContent = 'Erro ao conectar com o Odoo';
        }
    }

    // Preencher tabela de NCMs do Odoo
    function preencherTabelaOdoo(ncms) {
        const tbody = document.getElementById('odoo-tabela-body');
        tbody.innerHTML = '';

        ncms.forEach(ncm => {
            // Verificar se valores sao diferentes do padrao
            const cstDiferente = ncm.cst !== ncmSalvo.cst_esperado;
            const classtribDiferente = ncm.classtrib_codigo !== ncmSalvo.class_trib_codigo;
            const ibsUfDiferente = parseFloat(ncm.ibs_uf) !== parseFloat(ncmSalvo.aliquota_ibs_uf);
            const ibsMunDiferente = parseFloat(ncm.ibs_mun) !== parseFloat(ncmSalvo.aliquota_ibs_mun);
            const cbsDiferente = parseFloat(ncm.cbs) !== parseFloat(ncmSalvo.aliquota_cbs);
            const reducaoDiferente = parseFloat(ncm.reducao) !== parseFloat(ncmSalvo.reducao_aliquota);

            const temDiferenca = cstDiferente || classtribDiferente || ibsUfDiferente || ibsMunDiferente || cbsDiferente || reducaoDiferente;

            const tr = document.createElement('tr');
            if (temDiferenca) {
                tr.classList.add('table-warning');
            }

            tr.innerHTML = `
                <td class="text-center">
                    <input type="checkbox" class="form-check-input ncm-checkbox" value="${ncm.id}" checked>
                </td>
                <td><code class="fw-bold">${ncm.codigo || '-'}</code></td>
                <td class="small" title="${ncm.name || ''}">${(ncm.name || '-').substring(0, 50)}${(ncm.name || '').length > 50 ? '...' : ''}</td>
                <td class="text-center ${cstDiferente ? 'text-danger fw-bold' : ''}">
                    ${ncm.cst || '-'}
                </td>
                <td class="text-center ${classtribDiferente ? 'text-danger fw-bold' : ''}">
                    ${ncm.classtrib_codigo || '-'}
                </td>
                <td class="text-center ${ibsUfDiferente ? 'text-danger fw-bold' : ''}">
                    ${ncm.ibs_uf ?? '-'}
                </td>
                <td class="text-center ${ibsMunDiferente ? 'text-danger fw-bold' : ''}">
                    ${ncm.ibs_mun ?? '-'}
                </td>
                <td class="text-center ${cbsDiferente ? 'text-danger fw-bold' : ''}">
                    ${ncm.cbs ?? '-'}
                </td>
                <td class="text-center ${reducaoDiferente ? 'text-danger fw-bold' : ''}">
                    ${ncm.reducao ?? '-'}
                </td>
            `;

            tbody.appendChild(tr);
        });

        // Marcar selecionar todos
        document.getElementById('odoo-selecionar-todos').checked = true;
    }

    // Atualizar NCMs selecionados no Odoo
    window.atualizarNcmsOdoo = async function() {
        const checkboxes = document.querySelectorAll('#odoo-tabela-body input[type="checkbox"]:checked');
        const ncmIds = Array.from(checkboxes).map(cb => cb.value);

        if (ncmIds.length === 0) {
            toastr.warning('Selecione pelo menos um NCM para atualizar');
            return;
        }

        const btnAtualizar = document.getElementById('btn-odoo-atualizar');
        const btnOriginalHtml = btnAtualizar.innerHTML;
        btnAtualizar.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Atualizando...';
        btnAtualizar.disabled = true;

        try {
            const response = await fetch('/operacional/compras/ncm-ibscbs/atualizar-odoo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ncm_ids: ncmIds,
                    novos_valores: {
                        cst_esperado: ncmSalvo.cst_esperado,
                        class_trib_codigo: ncmSalvo.class_trib_codigo,
                        aliquota_ibs_uf: ncmSalvo.aliquota_ibs_uf,
                        aliquota_ibs_mun: ncmSalvo.aliquota_ibs_mun,
                        aliquota_cbs: ncmSalvo.aliquota_cbs,
                        reducao_aliquota: ncmSalvo.reducao_aliquota
                    }
                })
            });

            const result = await response.json();

            if (result.sucesso) {
                document.getElementById('odoo-resultado').style.display = 'block';
                document.getElementById('odoo-resultado-texto').textContent = result.mensagem;
                document.getElementById('btn-odoo-atualizar').style.display = 'none';
                document.getElementById('btn-odoo-pular').style.display = 'none';
                toastr.success(result.mensagem);

                // Recarregar pagina apos 2 segundos
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                toastr.error(result.mensagem);
                btnAtualizar.innerHTML = btnOriginalHtml;
                btnAtualizar.disabled = false;
            }

        } catch (error) {
            console.error('Erro ao atualizar NCMs no Odoo:', error);
            toastr.error('Erro ao atualizar NCMs no Odoo');
            btnAtualizar.innerHTML = btnOriginalHtml;
            btnAtualizar.disabled = false;
        }
    };

    // Pular atualizacao do Odoo
    window.pularAtualizacaoOdoo = function() {
        modalOdoo.hide();
        toastr.info('NCM salvo no sistema local. Atualizacao no Odoo ignorada.');
        location.reload();
    };
})();
</script>
{% endblock %}
