{% extends "base.html" %}

{% block title %}Upload de Canhotos em Lote{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2>üìÑ Upload de Canhotos em Lote</h2>
            <p class="text-muted">Anexe m√∫ltiplos canhotos de uma vez. Os arquivos ser√£o identificados pelo n√∫mero da NF
                no nome do arquivo.</p>

            <!-- Instru√ß√µes -->
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle"></i> Como usar:</h5>
                <ul>
                    <li><strong>Nome dos arquivos:</strong> Deve conter o n√∫mero da NF (ex: <code>133526.jpeg</code>,
                        <code>NF_135260.png</code>)</li>
                    <li><strong>Formatos aceitos:</strong> JPG, PNG, PDF</li>
                    <li><strong>Processamento:</strong> O sistema extrair√° automaticamente o n√∫mero da NF do nome do
                        arquivo</li>
                    <li><strong>Duplicatas:</strong> Se j√° existir um canhoto para a NF, ele ser√° substitu√≠do</li>
                </ul>
            </div>

            <!-- Formul√°rio de Upload -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-upload"></i> Selecionar Canhotos</h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="form-group">
                            <label for="canhotos">Arquivos de Canhoto:</label>
                            <input type="file" class="form-control-file" id="canhotos" name="canhotos" multiple
                                accept=".jpg,.jpeg,.jfif,.png,.pdf" required>
                            <small class="form-text text-muted">
                                Selecione m√∫ltiplos arquivos de uma vez. Formatos: JPG, JFIF, PNG, PDF
                            </small>
                        </div>

                        <!-- Pr√©-visualiza√ß√£o dos arquivos selecionados -->
                        <div id="preview-container" class="mt-3" style="display: none;">
                            <h6>Arquivos selecionados:</h6>
                            <div id="file-list" class="mb-3"></div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-upload"></i> Fazer Upload dos Canhotos
                        </button>

                        <a href="{{ url_for('monitoramento.listar_entregas') }}" class="btn btn-secondary ml-2">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </a>
                    </form>
                </div>
            </div>

            <!-- Exemplos -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-lightbulb"></i> Exemplos de Nomes de Arquivo</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">‚úÖ Nomes V√°lidos:</h6>
                            <ul>
                                <li><code>133526.jpeg</code> ‚Üí NF 133526</li>
                                <li><code>NF_135260.png</code> ‚Üí NF 135260</li>
                                <li><code>canhoto_142789.pdf</code> ‚Üí NF 142789</li>
                                <li><code>entrega-128456-canhoto.jpg</code> ‚Üí NF 128456</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger">‚ùå Nomes Inv√°lidos:</h6>
                            <ul>
                                <li><code>canhoto.jpeg</code> (sem n√∫mero)</li>
                                <li><code>arquivo_abc.png</code> (sem n√∫mero)</li>
                                <li><code>documento.pdf</code> (sem n√∫mero)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('canhotos').addEventListener('change', function (e) {
        const files = e.target.files;
        const previewContainer = document.getElementById('preview-container');
        const fileList = document.getElementById('file-list');

        if (files.length > 0) {
            previewContainer.style.display = 'block';
            fileList.innerHTML = '';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileName = file.name;

                // Extrair n√∫mero da NF
                const nameWithoutExt = fileName.split('.')[0];
                const numbers = nameWithoutExt.match(/\d+/);
                const nfNumber = numbers ? numbers[0] : 'N√£o encontrado';

                // Criar elemento de preview
                const fileItem = document.createElement('div');
                fileItem.className = 'border p-2 mb-2 rounded';

                const statusClass = numbers ? 'text-success' : 'text-danger';
                const statusIcon = numbers ? '‚úÖ' : '‚ùå';

                fileItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${fileName}</strong>
                        <small class="d-block ${statusClass}">
                            ${statusIcon} NF identificada: ${nfNumber}
                        </small>
                    </div>
                    <span class="badge bg-secondary">${(file.size / 1024).toFixed(1)} KB</span>
                </div>
            `;

                fileList.appendChild(fileItem);
            }
        } else {
            previewContainer.style.display = 'none';
        }
    });
</script>
{% endblock %}