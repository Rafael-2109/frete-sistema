{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex flex-column mb-3">
      <h2>Entrega NF {{ entrega.numero_nf }} - {{ entrega.cliente }}</h2>
      <h6>Vendedor: {{ entrega.vendedor or '‚Äî' }}</h6>
  
      {% if entrega.transportadora and entrega.transportadora != '-' %}
        <h6>
          Transportadora: {{ entrega.transportadora }}
          {% if entrega.lead_time is not none %}
            - Lead Time {{ entrega.lead_time }} Dias √öteis
          {% endif %}
        </h6>
      {% else %}
        <h6>Transportadora: ‚Äî</h6>
      {% endif %}
    </div>

    <div>
      <a href="{{ url_for('monitoramento.listar_entregas', **request.args) }}" class="btn btn-secondary">Voltar</a>
      <a href="{{ url_for('monitoramento.visualizar_historico', id=entrega.id) }}" class="btn btn-outline-info">Hist√≥rico</a>
      <a href="{{ url_for('monitoramento.visualizar_arquivos', id=entrega.id) }}" class="btn btn-outline-dark">Arquivos</a>
    </div>

  {% if ocorrencias_devolucao %}
  <div class="alert alert-warning mt-3 mb-2">
    <strong>Esta entrega possui {{ ocorrencias_devolucao|length }} devolucao(oes):</strong>
    <div class="mt-2">
      {% for ocorr in ocorrencias_devolucao %}
        <a href="{{ url_for('devolucao.devolucao_ocorrencia.detalhe', ocorrencia_id=ocorr.id) }}"
           class="btn btn-sm btn-{{ 'danger' if ocorr.status == 'ABERTA' else 'warning' if ocorr.status == 'EM_ANALISE' else 'success' }} me-2 mb-1"
           title="Clique para ver detalhes da devolucao">
          NFD {{ ocorr.numero_nfd }} <span class="badge bg-light text-dark">{{ ocorr.status }}</span>
        </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <ul class="nav nav-tabs mb-4" id="tabs-entrega" role="tablist">
    <li class="nav-item"><a class="nav-link active" id="log-tab" data-bs-toggle="tab" href="#log" role="tab">Acompanhamento</a></li>
    <li class="nav-item"><a class="nav-link" id="evento-tab" data-bs-toggle="tab" href="#evento" role="tab">Eventos</a></li>
    <li class="nav-item"><a class="nav-link" id="custo-tab" data-bs-toggle="tab" href="#custo" role="tab">Custos</a></li>
    <li class="nav-item"><a class="nav-link" id="agenda-tab" data-bs-toggle="tab" href="#agenda" role="tab">Agendamentos</a></li>
    <li class="nav-item"><a class="nav-link" id="pendencias-tab" data-bs-toggle="tab" href="#pendencias" role="tab">üí∞ Pend√™ncias</a></li>
    <li class="nav-item"><a class="nav-link" id="finalizacao-tab" data-bs-toggle="tab" href="#finalizacao" role="tab">Finaliza√ß√£o</a></li>
    <li class="nav-item"><a class="nav-link" id="comentarios-tab" data-bs-toggle="tab" href="#comentarios" role="tab">üí¨ Coment√°rios</a></li>

  </ul>

  <div class="tab-content">

    <div class="tab-pane fade" id="comentarios" role="tabpanel">
      <h5>Coment√°rios da Entrega</h5>
    
      <!-- Formul√°rio coment√°rio -->
      <form method="POST" 
            action="{{ url_for('monitoramento.adicionar_comentario', id=entrega.id) }}"
            enctype="multipart/form-data">  <!-- IMPORTANTE -->
          {{ form.hidden_tag() }}
          {{ form.texto(class="form-control", placeholder="Novo coment√°rio") }}
          {{ form.resposta_a_id }}

          <!-- Campo para arquivo -->
          {{ form.arquivo(class="form-control mt-2") }}

          <button class="btn btn-primary mt-2">Enviar</button>
      </form>

    
      <hr>
    
      {% for comentario in comentarios %}
      <div class="card mb-2">
        <div class="card-body">
          <strong>{{ comentario.autor }}</strong> ({{ comentario.criado_em | formatar_data_hora_brasil }}):<br>
          {{ comentario.texto }}
    
          <!-- Aqui, se houver "arquivo" associado ao coment√°rio, mostre link para download -->
          {% if comentario.arquivo %}
            <br><br>
            <strong>Anexo:</strong>
            <a href="{{ comentario.arquivo | file_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
              üìé {{ comentario.arquivo.split('/')[-1] if '/' in comentario.arquivo else comentario.arquivo }}
            </a>
          {% endif %}
    
          <button class="btn btn-sm btn-link" onclick="responder({{ comentario.id }})">Responder</button>
          
          {% for resposta in comentario.respostas %}
            <div class="card mt-2 ms-4 bg-light">
              <div class="card-body">
                <strong>{{ resposta.autor }}</strong> ({{ resposta.criado_em | formatar_data_hora_brasil }}):<br>
                {{ resposta.texto }}
    
                {% if resposta.arquivo %}
                  <br><br>
                  <strong>Anexo:</strong>
                  <a href="{{ resposta.arquivo | file_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                    üìé {{ resposta.arquivo.split('/')[-1] if '/' in resposta.arquivo else resposta.arquivo }}
                  </a>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
    
    </div>
    
    <script>
      function responder(comentario_id) {
        document.querySelector('input[name="resposta_a_id"]').value = comentario_id;
        document.querySelector('textarea[name="texto"]').placeholder = 'Responder coment√°rio...';
        document.querySelector('textarea[name="texto"]').focus();
      }
      
      function responderPendencia(pendencia_id) {
        document.getElementById('pendencia_id').value = pendencia_id;
        document.getElementById('resposta-pendencia').style.display = 'block';
        document.getElementById('resposta_logistica').focus();
      }
      
      function cancelarResposta() {
        document.getElementById('resposta-pendencia').style.display = 'none';
        document.getElementById('resposta_logistica').value = '';
      }
      
      function confirmarAgendamentoVisualizar(agendamentoId) {
        if (!confirm('Confirmar este agendamento?')) return;
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/monitoramento/confirmar_agendamento/${agendamentoId}`;
        
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
      }
    </script>

    <!-- LOG -->
    <div class="tab-pane fade show active" id="log" role="tabpanel">
      {% if feedback == 'log' %}<div class="alert alert-success">‚úîÔ∏è Log registrado com sucesso.</div>{% endif %}
      <h5>Registros de Acompanhamento</h5>
      <ul class="list-group mb-3">
        {% for log in entrega.logs %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ log.tipo|capitalize }}</strong> por {{ log.autor }} em {{ log.data_hora | formatar_data_hora_brasil }}<br>
            {{ log.descricao }}
            {% if log.lembrete_para %}<br><span class="badge bg-warning text-dark">Lembrete: {{ log.lembrete_para | formatar_data_hora_brasil }}</span>{% endif %}
          </div>
          <form method="POST" action="{{ url_for('monitoramento.excluir_log', log_id=log.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-sm btn-outline-danger">Excluir</button>
          </form>
        </li>
        {% endfor %}
      </ul>
      <form method="POST" action="{{ url_for('monitoramento.adicionar_log', id=entrega.id) }}">
        {{ form_log.hidden_tag() }}
        {{ form_log.descricao.label }} {{ form_log.descricao(class="form-control") }}
        {{ form_log.tipo.label }} {{ form_log.tipo(class="form-select mt-2") }}
        {{ form_log.lembrete_para.label }} {{ form_log.lembrete_para(class="form-control mt-2") }}
        {{ form_log.submit_log(class="btn btn-primary mt-3") }}
      </form>
    </div>

    <!-- Repita essa estrutura claramente para EVENTOS, CUSTOS e AGENDAMENTOS -->
      <!-- EVENTOS -->
      <div class="tab-pane fade" id="evento" role="tabpanel">
        {% if feedback == 'evento' %}<div class="alert alert-success">‚úîÔ∏è Evento registrado com sucesso.</div>{% endif %}

        <h5>Eventos registrados</h5>
        <ul class="list-group mb-3">
          {% for ev in entrega.eventos %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ ev.tipo_evento|capitalize }}</strong> | Motorista: {{ ev.motorista }}<br>
              Chegada: {{ ev.data_hora_chegada }} | Sa√≠da: {{ ev.data_hora_saida }}<br>
              {{ ev.observacao|safe }}
              <em>Criado por {{ ev.autor }} em {{ ev.criado_em | formatar_data_hora_brasil }}</em>
            </div>
            <form method="POST" action="{{ url_for('monitoramento.excluir_evento', evento_id=ev.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger">Excluir</button>
            </form>
          </li>
          {% endfor %}
        </ul>

        <form method="POST" action="{{ url_for('monitoramento.adicionar_evento', id=entrega.id) }}">
          {{ form_evento.hidden_tag() }}
          <div class="row">
            <div class="col-md-6">{{ form_evento.data_hora_chegada.label }} {{ form_evento.data_hora_chegada(class="form-control") }}</div>
            <div class="col-md-6">{{ form_evento.hora_chegada.label }} {{ form_evento.hora_chegada(class="form-control") }}</div>
            <div class="col-md-6">{{ form_evento.data_hora_saida.label }} {{ form_evento.data_hora_saida(class="form-control") }}</div>
            <div class="col-md-6">{{ form_evento.hora_saida.label }} {{ form_evento.hora_saida(class="form-control") }}</div>
          </div>
          {{ form_evento.motorista.label }} {{ form_evento.motorista(class="form-control mt-2") }}
          {{ form_evento.tipo_evento.label }} {{ form_evento.tipo_evento(class="form-select mt-2") }}
          {{ form_evento.observacao.label }} {{ form_evento.observacao(class="form-control mt-2") }}
          {{ form_evento.submit_evento(class="btn btn-primary mt-3") }}
        </form>
      </div>
      <!-- CUSTOS -->
      <div class="tab-pane fade" id="custo" role="tabpanel">
        {% if feedback == 'custo' %}<div class="alert alert-success">‚úîÔ∏è Custo registrado com sucesso.</div>{% endif %}

        <h5>Custos associados</h5>
        <ul class="list-group mb-3">
          {% for custo in entrega.custos_extras %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ custo.tipo }}</strong>: R$ {{ '%.2f' | format(custo.valor) }}<br>{{ custo.motivo }}
            </div>
            <form method="POST" action="{{ url_for('monitoramento.excluir_custo', custo_id=custo.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger">Excluir</button>
            </form>
          </li>
          {% endfor %}
        </ul>

        <form method="POST" action="{{ url_for('monitoramento.adicionar_custo', id=entrega.id) }}">
          {{ form_custo.hidden_tag() }}
          {{ form_custo.tipo.label }} {{ form_custo.tipo(class="form-select") }}
          {{ form_custo.valor.label }} {{ form_custo.valor(class="form-control") }}
          {{ form_custo.motivo.label }} {{ form_custo.motivo(class="form-control") }}
          {{ form_custo.submit_custo(class="btn btn-primary mt-3") }}
        </form>
      </div>
      <!-- AGENDAMENTOS -->
      <div class="tab-pane fade" id="agenda" role="tabpanel">
        {% if feedback == 'agendamento' %}<div class="alert alert-success">‚úîÔ∏è Agendamento registrado com sucesso.</div>{% endif %}

        <h5>Agendamentos realizados</h5>
        <ul class="list-group mb-3">
          {% for ag in entrega.agendamentos %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <strong>Data:</strong> 
                  {% if ag.data_agendada %}
                    {{ ag.data_agendada|formatar_data_segura }}
                  {% else %}
                    -
                  {% endif %}
                  <strong>Hora:</strong> 
                  {% if ag.hora_agendada %}
                    {{ ag.hora_agendada|formatar_data_hora_brasil }}
                  {% else %}
                    -
                  {% endif %}
                  {% if ag.status == 'confirmado' %}
                    <span class="badge bg-primary">‚úÖ Confirmado</span>
                  {% else %}
                    <span class="badge bg-warning">‚è≥ Aguardando</span>
                  {% endif %}
                </div>
                
                <div>
                  <strong>Forma:</strong> {{ ag.forma_agendamento }} | <strong>Contato:</strong> {{ ag.contato_agendamento }}<br>
                  <strong>Protocolo:</strong> {{ ag.protocolo_agendamento | formatar_protocolo }}<br>
                  <strong>Motivo:</strong> {{ ag.motivo or '-' }}<br>
                  <strong>Observa√ß√£o:</strong> {{ ag.observacao or '-' }}<br>
                  <em>Criado por {{ ag.autor }} em {{ ag.criado_em | formatar_data_hora_brasil }}</em>
                  
                  {% if ag.status == 'confirmado' and ag.confirmado_por %}
                    <br><em class="text-success">Confirmado por {{ ag.confirmado_por }} em {{ ag.confirmado_em | formatar_data_hora_brasil }}</em>
                    {% if ag.observacoes_confirmacao %}
                      <br><strong>Obs. Confirma√ß√£o:</strong> {{ ag.observacoes_confirmacao }}
                    {% endif %}
                  {% endif %}
                </div>
              </div>
              
              <div class="d-flex flex-column gap-2">
                {% set ultimo_agendamento = entrega.agendamentos | sort(attribute='criado_em') | last %}
                {% if ag.id == ultimo_agendamento.id and ag.status == 'aguardando' %}
                  <button class="btn btn-sm btn-success" onclick="confirmarAgendamentoVisualizar({{ ag.id }})">
                    ‚úÖ Confirmar
                  </button>
                {% endif %}
                
                <form method="POST" action="{{ url_for('monitoramento.excluir_agendamento', agendamento_id=ag.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Excluir este agendamento?')">Excluir</button>
                </form>
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>

        <form method="POST" action="{{ url_for('monitoramento.adicionar_agendamento', id=entrega.id) }}">
          {{ form_agendamento.hidden_tag() }}
          <input type="hidden" name="form_type" value="agendamento">
          <div class="row">
            <div class="col-md-6">{{ form_agendamento.data_agendada.label }} {{ form_agendamento.data_agendada(class="form-control") }}</div>
            <div class="col-md-6">{{ form_agendamento.hora_agendada.label }} {{ form_agendamento.hora_agendada(class="form-control") }}</div>
          </div>
          {{ form_agendamento.forma_agendamento.label }} {{ form_agendamento.forma_agendamento(class="form-select mt-2") }}
          {{ form_agendamento.contato_agendamento.label }} {{ form_agendamento.contato_agendamento(class="form-control") }}
          {{ form_agendamento.protocolo_agendamento.label }} {{ form_agendamento.protocolo_agendamento(class="form-control") }}
          {{ form_agendamento.motivo.label }} {{ form_agendamento.motivo(class="form-control") }}
          {{ form_agendamento.observacao.label }} {{ form_agendamento.observacao(class="form-control") }}
          
          <div class="form-check mt-3">
            {{ form_agendamento.criar_confirmado(class="form-check-input") }}
            {{ form_agendamento.criar_confirmado.label(class="form-check-label") }}
          </div>
          
          {{ form_agendamento.submit_agendamento(class="btn btn-primary mt-3") }}
        </form>
        
      </div>

    <!-- PEND√äNCIAS FINANCEIRAS -->
    <div class="tab-pane fade" id="pendencias" role="tabpanel">
      {% if feedback == 'pendencia' %}<div class="alert alert-success">‚úîÔ∏è Pend√™ncia registrada com sucesso.</div>{% endif %}

      <h5>Pend√™ncias Financeiras</h5>
      <ul class="list-group mb-3">
        {% for pendencia in entrega.pendencias_financeiras %}
        <li class="list-group-item">
          <div class="row">
            <div class="col-md-8">
              <strong>Pend√™ncia criada em:</strong> {{ pendencia.criado_em | formatar_data_hora_brasil }}<br>
              <strong>Por:</strong> {{ pendencia.criado_por }}<br>
              <strong>Observa√ß√£o:</strong> {{ pendencia.observacao or '-' }}<br>
              
              {% if pendencia.respondida_em %}
                {% if pendencia.resposta_excluida_em %}
                  <!-- Resposta foi apagada - mostra hist√≥rico -->
                  <div class="mt-2 p-2 bg-warning bg-opacity-10 rounded">
                    <strong>üìù Respondida originalmente em:</strong> {{ pendencia.respondida_em | formatar_data_hora_brasil }}<br>
                    <strong>Por:</strong> {{ pendencia.respondida_por }}<br>
                    <strong>Resposta original:</strong> {{ pendencia.resposta_logistica }}<br>
                    <hr class="my-2">
                    <strong>üóëÔ∏è Resposta apagada em:</strong> {{ pendencia.resposta_excluida_em | formatar_data_hora_brasil }}<br>
                    <strong>Por:</strong> {{ pendencia.resposta_excluida_por }}<br>
                    <span class="badge bg-warning">‚è≥ Aguardando Nova Resposta</span>
                  </div>
                {% else %}
                  <!-- Resposta ativa -->
                  <div class="mt-2 p-2 bg-success bg-opacity-10 rounded">
                    <strong>‚úÖ Respondida em:</strong> {{ pendencia.respondida_em | formatar_data_hora_brasil }}<br>
                    <strong>Por:</strong> {{ pendencia.respondida_por }}<br>
                    <strong>Resposta:</strong> {{ pendencia.resposta_logistica }}
                  </div>
                {% endif %}
              {% else %}
                <span class="badge bg-warning">‚è≥ Aguardando Resposta</span>
              {% endif %}
            </div>
            <div class="col-md-4 text-end">
              {% if not pendencia.respondida_em or pendencia.resposta_excluida_em %}
                <!-- Sem resposta ou resposta apagada - pode responder -->
                <button class="btn btn-sm btn-success" onclick="responderPendencia({{ pendencia.id }})">
                  {% if pendencia.resposta_excluida_em %}Nova {% endif %}Resposta
                </button>
              {% else %}
                <!-- Tem resposta ativa - pode apagar a resposta -->
                <form method="POST" action="{{ url_for('monitoramento.apagar_resposta_pendencia', pendencia_id=pendencia.id) }}" class="d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn btn-sm btn-outline-warning" onclick="return confirm('Tem certeza que deseja apagar esta resposta? O hist√≥rico ser√° mantido.')">
                    üóëÔ∏è Apagar Resposta
                  </button>
                </form>
              {% endif %}
              <div class="mt-1">
                <small class="text-muted">üìã Pend√™ncia permanente</small>
              </div>
            </div>
          </div>
        </li>
        {% endfor %}
        
        {% if not entrega.pendencias_financeiras %}
        <li class="list-group-item text-muted text-center">
          Nenhuma pend√™ncia financeira registrada
        </li>
        {% endif %}
      </ul>

      <!-- Formul√°rio para responder pend√™ncia -->
      <div id="resposta-pendencia" style="display: none;" class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0">Responder Pend√™ncia Financeira</h6>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('monitoramento.responder_pendencia', id=entrega.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="pendencia_id" id="pendencia_id">
            
            <div class="mb-3">
              <label for="resposta_logistica" class="form-label">Resposta da Log√≠stica</label>
              <textarea name="resposta_logistica" id="resposta_logistica" class="form-control" rows="3" required></textarea>
            </div>
            
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-success">Enviar Resposta</button>
              <button type="button" class="btn btn-secondary" onclick="cancelarResposta()">Cancelar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Formul√°rio para nova pend√™ncia -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Registrar Nova Pend√™ncia Financeira</h6>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('monitoramento.adicionar_pendencia', id=entrega.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="mb-3">
              <label for="observacao_pendencia" class="form-label">Observa√ß√£o da Pend√™ncia</label>
              <textarea name="observacao" id="observacao_pendencia" class="form-control" rows="3" required placeholder="Descreva a pend√™ncia financeira..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-warning">Registrar Pend√™ncia</button>
          </form>
        </div>
      </div>
    </div>

    <!-- FINALIZA√á√ÉO -->
    <div class="tab-pane fade" id="finalizacao" role="tabpanel">
      <h5>Finalizar entrega</h5>

      {% if entrega.teve_devolucao %}
      <div class="alert alert-warning mb-3">
        <strong>Atencao:</strong> Esta entrega possui devolucao(oes) registrada(s).
        <button type="button" class="btn btn-sm btn-outline-warning ms-2" onclick="abrirModalNfd({{ entrega.id }})">
          Ver/Editar NFDs
        </button>
        {% if ocorrencias_devolucao %}
        <div class="mt-2">
          <strong>NFDs de Devolucao:</strong>
          {% for ocorr in ocorrencias_devolucao %}
            <a href="{{ url_for('devolucao.devolucao_ocorrencia.detalhe', ocorrencia_id=ocorr.id) }}"
               class="btn btn-sm btn-{{ 'danger' if ocorr.status == 'ABERTA' else 'warning' if ocorr.status == 'EM_ANALISE' else 'success' }} ms-1"
               title="Motivo: {{ ocorr.motivo or 'N/A' }} | Destino: {{ ocorr.destino or 'Indefinido' }}">
              NFD {{ ocorr.numero_nfd }}
              <span class="badge bg-light text-dark">{{ ocorr.status }}</span>
            </a>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}

{% if entrega.finalizado_em %}
<div class="alert alert-info">
  <strong>Finalizada em:</strong> {{ (entrega.data_hora_entrega_realizada if entrega.data_hora_entrega_realizada else entrega.finalizado_em)|formatar_data_hora_brasil or '-' }}<br>
  <strong>Status:</strong> {{ entrega.status_finalizacao }}<br>
  <strong>Por:</strong> {{ entrega.finalizado_por }}<br>
  <strong>Registrado em:</strong> {{ entrega.finalizado_em | formatar_data_hora_brasil }}<br>
  <form method="post" action="{{ url_for('monitoramento.remover_finalizacao', id=entrega.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button class="btn btn-sm btn-outline-danger">Excluir Finalizacao</button>
  </form>
</div>
      {% else %}
      <form id="form-finalizacao" method="POST" action="{{ url_for('monitoramento.finalizar_entrega', id=entrega.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Campo original (necessario) -->
        <div class="mb-3">
            <label>Data e Hora da Entrega</label>
            <input type="datetime-local" name="data_hora_entrega" class="form-control" id="data_hora_entrega">
        </div>

        <!-- Novos campos -->
        <div class="mb-3">
            <label>Status Finalizacao</label>
            <select name="status_finalizacao" class="form-control" id="status_finalizacao">
                <option value="">Selecione o Status</option>
                <option value="Cancelada">Cancelada</option>
                <option value="Devolvida">Devolvida</option>
                <option value="Troca de NF">Troca de NF</option>
                <option value="Sinistro">Sinistro</option>
            </select>
        </div>

        <div class="mb-3">
            <label>Nova NF (apenas se houver troca)</label>
            <input type="text" name="nova_nf" class="form-control" placeholder="Nova NF (se houver)">
        </div>

        <!-- Botao que abre modal de confirmacao -->
        <button type="button" class="btn btn-success" onclick="confirmarFinalizacao({{ entrega.id }})">
          Finalizar Entrega
        </button>
    </form>

      {% endif %}
    </div>

  </div>
</div>

<!-- Modal de Confirmacao de Finalizacao -->
<div class="modal fade" id="modal-confirmar-finalizacao" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Finalizar Entrega</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p class="fs-5 text-center mb-4">Houve devolucao nesta entrega?</p>
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-warning btn-lg" id="btn-registrar-nfd">
            Sim, Registrar NFD
          </button>
          <button type="button" class="btn btn-success btn-lg" id="btn-sem-devolucao">
            Nao, Finalizar sem Devolucao
          </button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para registro de NFD -->
<div class="modal fade" id="modal-nfd" tabindex="-1" aria-labelledby="modal-nfd-label" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <!-- Conteudo carregado dinamicamente -->
      <div class="modal-body text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Variavel global para armazenar entrega_id
let entregaIdAtual = null;

// Funcao chamada ao clicar em "Finalizar Entrega"
function confirmarFinalizacao(entregaId) {
    entregaIdAtual = entregaId;

    // Fechar modal de NFD se estiver aberto
    const modalNfdEl = document.getElementById('modal-nfd');
    const modalNfd = bootstrap.Modal.getInstance(modalNfdEl);
    if (modalNfd) modalNfd.hide();

    // Abrir modal de confirmacao
    const modalConfirmar = new bootstrap.Modal(document.getElementById('modal-confirmar-finalizacao'));
    modalConfirmar.show();
}

// Botao "Sim, Registrar NFD"
document.getElementById('btn-registrar-nfd').addEventListener('click', function() {
    // Fechar modal de confirmacao
    const modalConfirmar = bootstrap.Modal.getInstance(document.getElementById('modal-confirmar-finalizacao'));
    modalConfirmar.hide();

    // Abrir modal de NFD
    setTimeout(() => {
        abrirModalNfd(entregaIdAtual);
    }, 300);
});

// Botao "Nao, Finalizar sem Devolucao"
document.getElementById('btn-sem-devolucao').addEventListener('click', function() {
    // Fechar modal de confirmacao
    const modalConfirmar = bootstrap.Modal.getInstance(document.getElementById('modal-confirmar-finalizacao'));
    modalConfirmar.hide();

    // Submeter formulario de finalizacao
    document.getElementById('form-finalizacao').submit();
});

// Funcao para abrir o modal de NFD
function abrirModalNfd(entregaId) {
    entregaIdAtual = entregaId;
    const modal = new bootstrap.Modal(document.getElementById('modal-nfd'));
    const modalContent = document.querySelector('#modal-nfd .modal-content');

    // Mostrar loading
    modalContent.innerHTML = `
        <div class="modal-body text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    `;

    // Abrir modal
    modal.show();

    // Carregar conteudo
    fetch('/devolucao/registro/modal/' + entregaId)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao carregar modal');
            }
            return response.text();
        })
        .then(html => {
            modalContent.innerHTML = html;
        })
        .catch(error => {
            console.error('Erro:', error);
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h5 class="modal-title">Erro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        Erro ao carregar o formulario de devolucao. Tente novamente.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            `;
        });
}

// =========================================================================
// Funcoes do Modal de NFD (movidas do template do modal)
// =========================================================================

// Registrar nova NFD
function registrarNfd() {
    const form = document.getElementById('form-registrar-nfd');
    const btnRegistrar = document.querySelector('#modal-nfd #btn-registrar-nfd-submit');
    const spinner = btnRegistrar ? btnRegistrar.querySelector('.spinner-border') : null;
    const feedback = document.getElementById('nfd-feedback');

    // Validar formulario
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }

    // Coletar dados
    const formData = new FormData(form);
    const data = {
        entrega_id: parseInt(formData.get('entrega_id')),
        numero_nfd: formData.get('numero_nfd').trim(),
        motivo: formData.get('motivo'),
        descricao_motivo: formData.get('descricao_motivo').trim(),
        numero_nf_venda: formData.get('numero_nf_venda')
    };

    // Mostrar loading
    if (btnRegistrar) btnRegistrar.disabled = true;
    if (spinner) spinner.classList.remove('d-none');
    if (feedback) feedback.classList.add('d-none');

    // Enviar requisicao
    fetch('/devolucao/registro/api/registrar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Sucesso
            if (feedback) {
                feedback.className = 'alert alert-success';
                feedback.innerHTML = `
                    <strong>NFD registrada!</strong><br>
                    NFD: ${result.numero_nfd}<br>
                    Ocorrencia: ${result.numero_ocorrencia}
                `;
                feedback.classList.remove('d-none');
            }

            // Limpar formulario
            form.reset();
            form.classList.remove('was-validated');

            // Recarregar modal apos 1.5s para mostrar a nova NFD
            setTimeout(() => {
                carregarModalNfd(data.entrega_id);
            }, 1500);
        } else {
            // Erro
            if (feedback) {
                feedback.className = 'alert alert-danger';
                feedback.textContent = result.error || 'Erro ao registrar NFD';
                feedback.classList.remove('d-none');
            }
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        if (feedback) {
            feedback.className = 'alert alert-danger';
            feedback.textContent = 'Erro de conexao. Tente novamente.';
            feedback.classList.remove('d-none');
        }
    })
    .finally(() => {
        if (btnRegistrar) btnRegistrar.disabled = false;
        if (spinner) spinner.classList.add('d-none');
    });
}

// Excluir NFD
function excluirNfd(nfdId, numeroNfd) {
    if (!confirm(`Deseja excluir a NFD ${numeroNfd}?`)) {
        return;
    }

    fetch(`/devolucao/registro/api/${nfdId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Remover linha da tabela
            const row = document.getElementById(`nfd-row-${nfdId}`);
            if (row) {
                row.remove();
            }

            // Mostrar feedback
            const feedback = document.getElementById('nfd-feedback');
            if (feedback) {
                feedback.className = 'alert alert-success';
                feedback.textContent = `NFD ${numeroNfd} excluida com sucesso!`;
                feedback.classList.remove('d-none');

                setTimeout(() => {
                    feedback.classList.add('d-none');
                }, 3000);
            }
        } else {
            alert(result.error || 'Erro ao excluir NFD');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexao. Tente novamente.');
    });
}

// Funcao para recarregar o modal de NFD
function carregarModalNfd(entregaId) {
    const modalContent = document.querySelector('#modal-nfd .modal-content');
    if (modalContent) {
        fetch(`/devolucao/registro/modal/${entregaId}`)
            .then(response => response.text())
            .then(html => {
                modalContent.innerHTML = html;
            })
            .catch(error => {
                console.error('Erro ao recarregar modal:', error);
            });
    }
}

// Analisar descricao com Claude Haiku para extrair motivo
function analisarDescricao() {
    const descricao = document.getElementById('descricao_motivo').value.trim();
    const btnAnalisar = document.getElementById('btn-analisar');
    const resultadoDiv = document.getElementById('resultado-analise');
    const conteudoDiv = document.getElementById('analise-conteudo');
    const selectMotivo = document.getElementById('motivo');

    if (!descricao) {
        alert('Digite uma descricao para analisar');
        return;
    }

    // Mostrar loading
    btnAnalisar.disabled = true;
    btnAnalisar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Analisando...';
    resultadoDiv.classList.add('d-none');

    fetch('/devolucao/ai/api/extrair-observacao', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
        },
        body: JSON.stringify({ texto: descricao })
    })
    .then(response => response.json())
    .then(data => {
        btnAnalisar.disabled = false;
        btnAnalisar.innerHTML = 'Analisar com IA';

        if (data.sucesso) {
            const confianca = (data.confianca * 100).toFixed(0);
            let html = `<p class="mb-1">Confianca: <strong>${confianca}%</strong></p>`;

            if (data.numero_nf_venda) {
                html += `<p class="mb-1">NF Venda: <strong>${data.numero_nf_venda}</strong></p>`;
            }

            if (data.motivo_sugerido) {
                html += `<p class="mb-1">Motivo: <strong>${data.motivo_sugerido}</strong>`;
                html += ` <button type="button" class="btn btn-sm btn-success ms-2" onclick="aplicarMotivo('${data.motivo_sugerido}')">Aplicar</button></p>`;
            }

            if (data.descricao_motivo) {
                html += `<p class="mb-0 text-muted small">${data.descricao_motivo}</p>`;
            }

            conteudoDiv.innerHTML = html;
            resultadoDiv.classList.remove('d-none');

            // Se confianca alta, aplicar automaticamente
            if (data.confianca >= 0.9 && data.motivo_sugerido) {
                aplicarMotivo(data.motivo_sugerido);
            }
        } else {
            conteudoDiv.innerHTML = `<p class="text-danger mb-0">Erro: ${data.erro || 'Nao foi possivel analisar'}</p>`;
            resultadoDiv.classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        btnAnalisar.disabled = false;
        btnAnalisar.innerHTML = 'Analisar com IA';
        alert('Erro ao analisar. Tente novamente.');
    });
}

// Aplicar motivo sugerido pela IA
function aplicarMotivo(motivo) {
    const selectMotivo = document.getElementById('motivo');
    if (selectMotivo) {
        // Verificar se o motivo existe nas opcoes
        const opcao = Array.from(selectMotivo.options).find(opt => opt.value === motivo);
        if (opcao) {
            selectMotivo.value = motivo;
            // Visual feedback
            selectMotivo.classList.add('border-success');
            setTimeout(() => selectMotivo.classList.remove('border-success'), 2000);
        }
    }
}
</script>
{% endblock %}
