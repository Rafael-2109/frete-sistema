{% extends 'base.html' %}

{% block extra_css %}
<style>
/* üéØ PAGINA√á√ÉO H√çBRIDA - FUNCIONA EM QUALQUER NAVEGADOR */
#hybrid-pagination {
  position: relative !important; /* Come√ßa normal */
  background: #ffffff !important;
  border-bottom: 2px solid #28a745 !important;
  box-shadow: 0 3px 15px rgba(0,0,0,0.2) !important;
  padding: 8px 0 !important;
  margin: 0 !important;
  transition: all 0.3s ease !important;
  z-index: 104 !important; /* ABAIXO do navbar (1050) */
}

/* üîí QUANDO GRUDADO (via JavaScript) */
#hybrid-pagination.is-stuck {
  position: fixed !important;
  top: 56px !important; /* Abaixo do navbar */
  left: 0 !important;
  right: 0 !important;
  width: 100% !important;
  border: 3px solid #dc3545 !important; /* Borda vermelha quando grudado */
  background: #f8f9fa !important; /* Fundo ligeiramente diferente */
  transform: translateY(0) !important;
  z-index: 104 !important; /* ABAIXO do navbar (1050) */
}

/* üé® Estilos da pagina√ß√£o h√≠brida */
#hybrid-pagination .container-fluid {
  max-width: none !important;
  padding: 0 15px !important;
}

#hybrid-pagination .pagination {
  margin: 0 !important;
  padding: 0 !important;
  display: flex !important;
}

#hybrid-pagination .page-link {
  color: #28a745 !important;
  background-color: #ffffff !important;
  border: 2px solid #28a745 !important;
  padding: 8px 16px !important;
  margin: 0 2px !important;
  font-weight: 600 !important;
  text-decoration: none !important;
  border-radius: 6px !important;
  transition: all 0.2s ease !important;
}

#hybrid-pagination .page-item.active .page-link {
  background-color: #28a745 !important;
  color: #ffffff !important;
  border-color: #28a745 !important;
}

#hybrid-pagination .page-link:hover {
  background-color: #218838 !important;
  color: #ffffff !important;
  border-color: #218838 !important;
  transform: scale(1.05) !important;
}

/* ‚úÖ ESPA√áAMENTOS NORMAIS - SEM MARGEM FIXA */
.filters-offset {
  margin-top: 0 !important; /* Normal, sem espa√ßo fixo */
  padding-top: 10px !important;
}

.pagination-offset {
  margin-top: 20px !important; /* Espa√ßo normal para a tabela */
  padding-top: 10px !important;
}

/* FOR√áA ESPEC√çFICA PARA O BODY */
body {
  padding-top: 0 !important;
}

/* ‚úÖ FILTROS COM POSICIONAMENTO NORMAL */
.bg-light {
  margin-top: 0 !important; /* Posi√ß√£o normal no fluxo */
  position: relative !important;
  z-index: 103 !important; /* Abaixo da pagina√ß√£o mas acima do conte√∫do */
}

/* ‚úÖ RESPONSIVIDADE PARA H√çBRIDA */
@media (max-width: 768px) {
  #hybrid-pagination .col-md-4 {
    margin-top: 10px !important;
    text-align: center !important;
  }
  
  #hybrid-pagination .pagination {
    justify-content: center !important;
    flex-wrap: wrap !important;
  }
  
  #hybrid-pagination .page-link {
    font-size: 0.8rem !important;
    padding: 6px 12px !important;
  }
  
  /* ‚úÖ QUANDO GRUDADO NO MOBILE */
  #hybrid-pagination.is-stuck {
    top: 50px !important; /* Um pouco menos no mobile */
  }
  
  .pagination-offset {
    margin-top: 25px !important;
    padding-top: 15px !important;
  }
}

/* Indicador visual de loading */
.pagination-loading {
  opacity: 0.6;
  pointer-events: none;
}

/* Melhorias nas colunas sticky da tabela */
.sticky-col, .sticky-col-2, .sticky-col-3 {
  position: sticky;
  background: #fff !important;
  box-shadow: 2px 0 5px rgba(0,0,0,0.1);
  border-right: 2px solid #e9ecef !important;
}

.sticky-col {
  left: 0;
  z-index: 11;
  min-width: 120px;
}

.sticky-col-2 {
  left: 120px; /* Largura da coluna anterior */
  z-index: 10;
  min-width: 140px;
}

.sticky-col-3 {
  left: 260px; /* Largura das duas colunas anteriores */
  z-index: 9;
  min-width: 200px;
}

/* Efeitos hover na tabela */
.table-hover tbody tr:hover {
  background-color: rgba(0,123,255,0.05) !important;
  transform: scale(1.001);
  transition: all 0.2s ease;
}

/* Loading states */
.table.loading {
  opacity: 0.7;
  pointer-events: none;
}

/* Melhorias nos badges de status */
.badge {
  font-size: 0.75rem;
  font-weight: 500;
  letter-spacing: 0.3px;
}

/* Anima√ß√£o suave para mudan√ßas de p√°gina */
.page-transition {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* üîß CORRE√á√ÉO PARA CONFLITOS DO STYLE.CSS */
.pagination-container {
  /* Remove qualquer overflow que possa impedir sticky */
  overflow: visible !important;
  /* Remove white-space que pode causar problemas */
  white-space: normal !important;
  /* Garante que o container seja relativo */
  position: relative !important;
}

.pagination-container .table-responsive {
  /* Temporariamente remove overflow para esta p√°gina */
  overflow: visible !important;
}

/* ‚úÖ PAGINA√á√ÉO SIMPLES - SEM BURACO */
.sticky-pagination-simple {
  background: #ffffff !important;
  border-bottom: 2px solid #28a745 !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
  margin: 0 !important;
  padding: 0 !important;
}

/* üéØ INDICADOR VISUAL QUANDO GRUDADA */
.sticky-pagination-simple.stuck {
  border-color: #dc3545 !important;
  background: #ffe6e6 !important;
  box-shadow: 0 5px 20px rgba(220, 53, 69, 0.3) !important;
}

/* üìã CABE√áALHO DA TABELA STICKY */
.table thead th {
  position: -webkit-sticky !important; /* Safari */
  position: sticky !important;
  top: 90px !important; /* Abaixo da pagina√ß√£o */
  z-index: 102 !important; /* Abaixo da pagina√ß√£o (1040) mas acima do conte√∫do */
  background: #212529 !important; /* Fundo escuro (table-dark) */
  color: #ffffff !important;
  border-bottom: 2px solid #28a745 !important;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
}

/* üìã CORRE√á√ÉO PARA COLUNAS STICKY DA TABELA */
.table thead th.sticky-col,
.table thead th.sticky-col-2,
.table thead th.sticky-col-3 {
  z-index: 102 !important; /* Ligeiramente maior que headers normais */
  background: #212529 !important;
}

/* üìã AJUSTE PARA C√âLULAS DO BODY COM STICKY COLUMNS */
.table tbody td.sticky-col,
.table tbody td.sticky-col-2,
.table tbody td.sticky-col-3 {
  background: #ffffff !important;
  /* z-index j√° definido nas classes acima (1015, 1014, 1013) */
}

/* üé® MELHORIAS NOS BOT√ïES DE DATA */
.btn-sm.btn-info,
.btn-sm.btn-primary {
  line-height: 1.2 !important;
  padding: 8px 12px !important;
  font-weight: 500 !important;
}

.btn-sm.btn-info small,
.btn-sm.btn-primary small {
  display: block;
  font-size: 0.7rem !important;
  opacity: 0.9;
  margin-top: 2px;
}

/* Hover effects */
.btn-sm.btn-info:hover,
.btn-sm.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  transition: all 0.2s ease;
}

.btn-sm.btn-warning:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(255,193,7,0.4);
  transition: all 0.2s ease;
}
</style>
{% endblock %}

{% block content %}

<!-- üîß CONTAINER COM CORRE√á√ïES PARA STICKY -->
<div class="pagination-container">

<!-- 1) Se quiser um fundo claro s√≥ para os filtros, use algo como: -->
<div class="bg-light py-2">
  <div class="container-fluid">
    <!-- ‚úÖ FILTROS COM PERSIST√äNCIA - Mant√©m valores anteriores -->
    <form method="get" class="row g-1 align-items-end" id="form-filtros">
    <!-- Campos hidden para manter status e agrupamento -->
    {% if request.args.get('status') %}
      <input type="hidden" name="status" value="{{ request.args.get('status') }}">
    {% endif %}
    {% if request.args.get('agrupar') %}
      <input type="hidden" name="agrupar" value="{{ request.args.get('agrupar') }}">
    {% endif %}
    <div class="col-md-2">
      <label class="form-label">Nota Fiscal</label>
      <input type="text" name="numero_nf" class="form-control" placeholder="Nota Fiscal" 
             value="{{ request.args.get('numero_nf', '') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Transportadora</label>
      <input type="text" name="transportadora" class="form-control" placeholder="Transportadora" 
             value="{{ request.args.get('transportadora', '') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Cliente</label>
      <input type="text" name="cliente" class="form-control" placeholder="Cliente" 
             value="{{ request.args.get('cliente', '') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">CNPJ</label>
      <input type="text" name="cnpj_cliente" class="form-control" placeholder="CNPJ" 
             value="{{ request.args.get('cnpj_cliente', '') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Vendedor</label>
      <select name="vendedor" class="form-select">
        <option value="">Todos os vendedores</option>
        {% for vendedor in vendedores_unicos %}
          <option value="{{ vendedor }}" {% if request.args.get('vendedor') == vendedor %}selected{% endif %}>
            {{ vendedor }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-1">
      <label class="form-label">UF</label>
      <input type="text" name="uf" class="form-control" placeholder="UF" 
             value="{{ request.args.get('uf', '') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Protocolo</label>
      <input type="text" name="protocolo" class="form-control" placeholder="Protocolo" 
             value="{{ request.args.get('protocolo', '') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Data Emiss√£o</label>
      <input type="date" name="data_emissao" class="form-control" 
             value="{{ request.args.get('data_emissao', '') }}" id="data_emissao">
    </div>
    <div class="col-md-2">
      <label class="form-label">Data Embarque</label>
      <input type="date" name="data_embarque" class="form-control" 
             value="{{ request.args.get('data_embarque', '') }}" id="data_embarque">
    </div>
    <div class="col-md-2">
      <label class="form-label">Data Entrega Prevista</label>
      <input type="date" name="data_entrega_prevista" class="form-control" 
             value="{{ request.args.get('data_entrega_prevista', '') }}" id="data_entrega_prevista">
    </div>
    <div class="col-md-2">
      <label class="form-label">Entrega Realizada Em</label>
      <input type="date" name="data_entrega" class="form-control" 
             value="{{ request.args.get('data_entrega', '') }}" id="data_entrega">
    </div>  

    <div class="col-md-3">
      <div class="form-check mt-4">
          <input class="form-check-input" type="checkbox"
                 name="agrupar" value="status" id="agrupar"
               {% if agrupar %}checked{% endif %}>
          <label class="form-check-label fw-bold {% if agrupar %}text-primary{% endif %}" 
                 for="agrupar">
          Agrupar por Status
        </label>
      </div>
    </div>

    <div class="col-md-3 text-end">
      <a href="?status=pendencia_financeira"
         class="btn {% if request.args.get('status') == 'pendencia_financeira' %}btn-dark{% else %}btn-outline-dark{% endif %}">
         ‚ö†Ô∏è Pend√™ncia Financeira
      </a>
      <button type="submit" class="btn btn-primary">Buscar</button>
        <a href="{{ url_for('monitoramento.listar_entregas') }}" class="btn btn-secondary">
          Limpar
        </a>
    </div>
  </form>

    <!-- Bot√µes de filtro r√°pido e a√ß√µes -->
    <div class="d-flex flex-wrap gap-2 mt-3 justify-content-between align-items-center">
      <div class="d-flex flex-wrap gap-2">
        <a href="{{ url_for('monitoramento.listar_entregas') }}" 
           class="btn {% if not request.args.get('status') %}btn-dark{% else %}btn-outline-dark{% endif %}">
          üìã Todas
        </a>
        <a href="?status=no_prazo" 
           class="btn {% if request.args.get('status') == 'no_prazo' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
          ‚ö™ No Prazo
        </a>
        <a href="?status=atrasada" 
           class="btn {% if request.args.get('status') == 'atrasada' %}btn-danger{% else %}btn-outline-danger{% endif %}">
          üî¥ Atrasadas {% if contadores.atrasadas %}({{ contadores.atrasadas }}){% endif %}
        </a>
        <a href="?status=sem_previsao" 
           class="btn {% if request.args.get('status') == 'sem_previsao' %}btn-warning{% else %}btn-outline-warning{% endif %}">
          üü° Sem Previs√£o {% if contadores.sem_previsao %}({{ contadores.sem_previsao }}){% endif %}
        </a>
        <a href="?status=entregue" 
           class="btn {% if request.args.get('status') == 'entregue' %}btn-success{% else %}btn-outline-success{% endif %}">
          ‚úÖ Entregues
        </a>
        <a href="?status=sem_agendamento" 
           class="btn {% if request.args.get('status') == 'sem_agendamento' %}btn-warning{% else %}btn-outline-warning{% endif %}">
          ‚ö†Ô∏è Agend. Pendente {% if contadores.sem_agendamento %}({{ contadores.sem_agendamento }}){% endif %}
        </a>
        <a href="?status=com_comentarios" 
           class="btn {% if request.args.get('status') == 'com_comentarios' %}btn-info{% else %}btn-outline-info{% endif %}">
          üí¨ Coment√°rios em NFs
        </a>    
        <a href="?status=reagendar" 
           class="btn {% if request.args.get('status') == 'reagendar' %}btn-danger{% else %}btn-outline-danger{% endif %}">
          üîÅ Reagendar {% if contadores.reagendar %}({{ contadores.reagendar }}){% endif %}
        </a>
        <!-- ‚úÖ NOVOS FILTROS DE STATUS ESPEC√çFICOS (s√≥ aparecem quando sem filtro principal) -->
        {% if not request.args.get('status') or request.args.get('status') in ['troca_nf', 'cancelada', 'devolvida', 'nf_cd'] %}
        <a href="?status=troca_nf" 
           class="btn {% if request.args.get('status') == 'troca_nf' %}btn-info{% else %}btn-outline-info{% endif %}">
          üîÑ Troca de NF
        </a>
        <a href="?status=cancelada" 
           class="btn {% if request.args.get('status') == 'cancelada' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
          ‚ùå Cancelada
        </a>
        <a href="?status=devolvida" 
           class="btn {% if request.args.get('status') == 'devolvida' %}btn-warning{% else %}btn-outline-warning{% endif %}">
          üì¶ Devolvida
        </a>
        <a href="?status=nf_cd" 
           class="btn {% if request.args.get('status') == 'nf_cd' %}btn-primary{% else %}btn-outline-primary{% endif %}">
          üè¢ NF no CD {% if contadores.nf_cd %}({{ contadores.nf_cd }}){% endif %}
        </a>
        {% endif %}
      </div>
      
      <!-- Bot√µes de A√ß√£o -->
      <div class="d-flex gap-2">
        {% if current_user.perfil != 'vendedor' %}
        <a href="{{ url_for('monitoramento.upload_canhotos_lote') }}" 
           class="btn btn-primary" 
           title="Upload de m√∫ltiplos canhotos de uma vez">
          <i class="fas fa-upload"></i> Upload Canhotos
        </a>
        {% endif %}
        <a href="{{ url_for('monitoramento.exportar_entregas') }}" 
           class="btn btn-success" 
           title="Exportar dados do monitoramento para Excel">
          <i class="fas fa-file-excel"></i> Exportar Excel
        </a>
      </div>
    </div>

  </div>
</div>

<!-- ‚úÖ PAGINA√á√ÉO STICKY ULTRA-SIMPLES -->
{% if not agrupar and paginacao and paginacao.pages > 1 %}
{% set args_no_page = request.args.copy() %}
{% if 'page' in args_no_page %}
  {% set _ = args_no_page.pop('page') %}
{% endif %}

<div id="sticky-pagination" class="sticky-pagination-simple">
  <div class="container-fluid">
    <div class="row align-items-center py-1">
      <div class="col-md-8">
        <nav>
          <ul class="pagination pagination-sm mb-0">
            <!-- Primeira p√°gina -->
            <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('monitoramento.listar_entregas', page=1, **args_no_page) }}">
                <i class="fas fa-angle-double-left"></i> Primeira
              </a>
            </li>

            <!-- Anterior -->
            <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('monitoramento.listar_entregas', page=paginacao.prev_num, **args_no_page) }}">
                <i class="fas fa-angle-left"></i> Anterior
              </a>
            </li>

            <!-- P√°ginas ao redor -->
            {% for p in range(paginacao.page - 2, paginacao.page + 3) if p > 0 and p <= paginacao.pages %}
              <li class="page-item {% if p == paginacao.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('monitoramento.listar_entregas', page=p, **args_no_page) }}">
                  {{ p }}
                </a>
              </li>
            {% endfor %}

            <!-- Pr√≥xima -->
            <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('monitoramento.listar_entregas', page=paginacao.next_num, **args_no_page) }}">
                Pr√≥xima <i class="fas fa-angle-right"></i>
              </a>
            </li>

            <!-- √öltima -->
            <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('monitoramento.listar_entregas', page=paginacao.pages, **args_no_page) }}">
                √öltima <i class="fas fa-angle-double-right"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
      
      <!-- ‚ú® INFORMA√á√ïES R√ÅPIDAS -->
      <div class="col-md-4 text-end">
        <div class="d-flex flex-column">
          <small class="text-muted">
            <i class="fas fa-list"></i>
            Registros <strong>{{ (paginacao.page - 1) * paginacao.per_page + 1 }}‚Äì{{ (paginacao.page - 1) * paginacao.per_page + paginacao.items|length }}</strong>
            de <strong>{{ paginacao.total }}</strong>
            <i class="fas fa-file-alt"></i> 
            P√°gina <strong>{{ paginacao.page }}</strong> de <strong>{{ paginacao.pages }}</strong>
          </small>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- TABELA -->
<div class="container-fluid mt-1 pagination-offset">

  <!-- Exemplo: barra de rolagem horizontal -->
  <div class="table-responsive">
  {% if agrupar %}
      <!-- Modo Acorde√£o (agrupar por status) -->
    <div class="accordion" id="accordionEntregas">
      {% for status, grupo in entregas_agrupadas.items() %}
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#grupo{{ loop.index }}">
            {{ status }} ({{ grupo|length }})
          </button>
        </h2>
        <div id="grupo{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionEntregas">
          <div class="accordion-body p-0">
            <table class="table table-hover table-bordered m-0">
              {% set current_sort = request.args.get('sort', '') %}
              {% set current_dir = request.args.get('direction', 'asc') %}

              <thead>
                <tr>
                  <!-- NF -->
                  <th>
                    {% if current_sort == 'numero_nf' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=numero_nf&direction={{ next_dir }}">NF</a>
                  </th>

                  <!-- CNPJ -->
                  <th>
                    {% if current_sort == 'cnpj_cliente' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=cnpj_cliente&direction={{ next_dir }}">CNPJ</a>
                  </th>

                  <!-- Cliente -->
                  <th>
                    {% if current_sort == 'cliente' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=cliente&direction={{ next_dir }}">Cliente</a>
                  </th>

                  <!-- Transportadora -->
                  <th>
                    {% if current_sort == 'transportadora' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=transportadora&direction={{ next_dir }}">Transportadora</a>
                  </th>

                  <!-- UF -->
                  <th>
                    {% if current_sort == 'uf' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=uf&direction={{ next_dir }}">UF</a>
                  </th>
                  
                  <!-- Munic√≠pio -->
                  <th>
                    {% if current_sort == 'municipio' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=municipio&direction={{ next_dir }}">Munic√≠pio</a>
                  </th>

                  <!-- Faturamento -->
                  <th>
                    {% if current_sort == 'data_faturamento' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=data_faturamento&direction={{ next_dir }}">Faturamento</a>
                  </th>

                  <!-- Embarque -->
                  <th>
                    {% if current_sort == 'data_embarque' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=data_embarque&direction={{ next_dir }}">Embarque</a>
                  </th>

                  <!-- Agendamento -->
                  <th>
                    <!-- Se voc√™ tiver um campo "data_agendamento" no model ou algo similar -->
                    {% if current_sort == 'data_agendamento' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=data_agendamento&direction={{ next_dir }}">Agendamento</a>
                  </th>

                  <!-- Prevista -->
                  <th>
                    {% if current_sort == 'data_entrega_prevista' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=data_entrega_prevista&direction={{ next_dir }}">Prevista</a>
                  </th>

                  <!-- Status -->
                  <th>Status</th>
                  <!-- Alertas -->
                  <th>Alertas</th>
                  <!-- A√ß√µes -->
                  <th>A√ß√µes</th>
                </tr>
              </thead>

              <tbody>
                {% for e in grupo %}
                <tr>
                  <td>
                    <small class="text-muted">{{ e.num_pedido or 'N/A' }}</small><br>
                    {{ e.numero_nf }}<br>
                    <small class="text-muted">{{ 'R$ {:,.2f}'.format(e.valor_nf).replace(',', 'X').replace('.', ',').replace('X', '.') if e.valor_nf else 'N/A' }}</small>
                  </td>
                  <td>{{ e.cnpj_cliente }}</td>
                  <td>
                    {{ e.cliente }}<br>
                    <small class="text-muted">üë§ {{ e.vendedor or 'N√£o informado' }}</small>
                  </td>
                  <td>
                    {% if e.incoterm or e.modalidade %}
                      <small class="text-muted">{{ e.incoterm or '' }}{% if e.incoterm and e.modalidade %} - {% endif %}{{ e.modalidade or '' }}</small><br>
                    {% endif %}
                    {{ e.transportadora }}
                  </td>
                  <td>{{ e.uf }}</td>
                  <td>{{ e.municipio }}</td>
                  <td>{{ e.data_faturamento | formatar_data_segura if e.data_faturamento else '-' }}</td>
                  <td>{{ e.data_embarque | formatar_data_segura if e.data_embarque else '-' }}</td>
                                     <td>
                     {% if e.data_agenda %}
                       {% set ultimo_agendamento = e.agendamentos | sort(attribute='criado_em') | last if e.agendamentos else None %}
                       {% if ultimo_agendamento and ultimo_agendamento.status == 'confirmado' %}
                         <button class="btn btn-sm btn-primary w-100 text-white" onclick="agendarEntrega('{{ e.id }}', '{{ e.numero_nf }}')">
                           üìÖ {{ e.data_agenda | formatar_data_segura }}
                           {% if ultimo_agendamento.protocolo_agendamento %}
                             <br><small>üìã {{ ultimo_agendamento.protocolo_agendamento }}</small>
                           {% endif %}
                           <br><small>‚úÖ Confirmado</small>
                         </button>
                       {% else %}
                         <div class="d-flex align-items-center gap-1">
                           <button class="btn btn-sm btn-warning flex-grow-1" onclick="agendarEntrega('{{ e.id }}', '{{ e.numero_nf }}')">
                             üìÖ {{ e.data_agenda | formatar_data_segura }}
                             {% if ultimo_agendamento and ultimo_agendamento.protocolo_agendamento %}
                               <br><small>üìã {{ ultimo_agendamento.protocolo_agendamento }}</small>
                             {% endif %}
                             <br><small>‚è≥ Aguardando</small>
                           </button>
                           {% if ultimo_agendamento and ultimo_agendamento.status == 'aguardando' %}
                             <button class="btn btn-sm btn-success" onclick="confirmarAgendamento('{{ ultimo_agendamento.id }}')">
                               ‚úÖ
                             </button>
                           {% endif %}
                         </div>
                       {% endif %}
                     {% else %}
                       <button class="btn btn-sm btn-warning w-100" onclick="agendarEntrega('{{ e.id }}', '{{ e.numero_nf }}')">
                         ‚ûï Agendar
                       </button>
                     {% endif %}
                   </td>
                                     <td>
                     {% if e.data_entrega_prevista %}
                       <button class="btn btn-sm btn-primary w-100 text-white" onclick="alterarDataPrevista('{{ e.id }}', '{{ e.numero_nf }}', '{{ e.data_entrega_prevista }}')">
                         üìÖ {{ e.data_entrega_prevista | formatar_data_segura }}
                       </button>
                     {% else %}
                       <button class="btn btn-sm btn-warning w-100" onclick="alterarDataPrevista('{{ e.id }}', '{{ e.numero_nf }}', '')">
                         ‚ûï Definir Data
                       </button>
                     {% endif %}
                   </td>
                  <td>
                    {% if e.entregue and e.data_hora_entrega_realizada %}
                      <span class="badge bg-success entregue-popup"
                            data-entrega="{{ e.data_hora_entrega_realizada | formatar_data_hora_brasil }}">
                        Entregue
                      </span>
                    {% elif e.entregue %}
                      <span class="badge bg-success">Entregue</span>
                    {% elif e.data_entrega_prevista and e.data_entrega_prevista < current_date %}
                      <span class="badge bg-danger">Atrasada</span>
                    {% elif e.data_entrega_prevista %}
                      <span class="badge bg-light text-dark">No Prazo</span>
                    {% else %}
                      <span class="badge bg-secondary">Sem Previs√£o</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="d-flex flex-column gap-1">
                      {% set pendencias_abertas = [] %}
                      {% for p in e.pendencias_financeiras %}
                        {% if not p.respondida_em or p.resposta_excluida_em %}
                          {% set _ = pendencias_abertas.append(p) %}
                        {% endif %}
                      {% endfor %}
                      {% if pendencias_abertas %}
                        {% set pendencia = pendencias_abertas[0] %}
                        <button class="btn btn-sm btn-danger pendencia-btn"
                                data-nf="{{ e.numero_nf }}"
                                data-observacao="{{ pendencia.observacao }}">
                          Pend. Financ.
                        </button>
                      {% endif %}
                      
                      {% if e.cnpj_cliente in contatos_agendamento and e.agendamentos|length == 0 and contatos_agendamento[e.cnpj_cliente].forma and contatos_agendamento[e.cnpj_cliente].forma != '' and contatos_agendamento[e.cnpj_cliente].forma != 'SEM AGENDAMENTO' and not e.status_finalizacao %}
                        <span class="badge bg-danger">‚ö†Ô∏è Agend. Pendente</span>
                      {% endif %}
                      
                      {% if e.reagendar %}
                        <span class="badge bg-danger">üîÅ Reagendar</span>
                      {% endif %}
                      
                      {% if e.possui_comentarios %}
                        <span class="badge bg-info">üí¨ Coment√°rios</span>
                      {% endif %}
                    </div>
                  </td>
                  <td class="d-flex flex-nowrap align-items-center gap-2">
                    <a href="{{ url_for('monitoramento.visualizar_entrega', id=e.id, **request.args) }}"
                       class="btn btn-sm btn-outline-primary">
                      Info
                    </a>
                    <form method="post" action="{{ url_for('monitoramento.toggle_reagendar', id=e.id, **request.args) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      {% if e.reagendar %}
                        <button class="btn btn-sm btn-outline-danger reagendar-btn">
                          <span class="text-curto">Reagenda</span>
                          <span class="text-completo">Cancelar</span>
                        </button>
                      {% else %}
                        <button class="btn btn-sm btn-outline-warning reagendar-btn">
                          <span class="text-curto">Reagenda</span>
                          <span class="text-completo">Marcar</span>
                        </button>
                      {% endif %}
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            </div>
          </div>
        </div>
        {% endfor %}
      </div>

  {% else %}
     <!-- SE N√ÉO AGRUPAR, tabela normal -->

      <table class="table table-hover table-bordered align-middle">

      {% set current_sort = request.args.get('sort', '') %}
      {% set current_dir = request.args.get('direction', 'asc') %}

      <thead>
        <tr>
          <!-- NF -->
          <th class="sticky-col">
            {% if current_sort == 'numero_nf' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            {% set url_params = request.args.copy() %}
            {% set _ = url_params.update({'sort': 'numero_nf', 'direction': next_dir}) %}
            <a href="?{{ url_params | urlencode }}">NF</a>
          </th>

          <!-- Cliente -->
          <th class="sticky-col-2">
            {% if current_sort == 'cliente' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            <a href="?sort=cliente&direction={{ next_dir }}">Cliente</a>
          </th>

          <!-- Transportadora -->
          <th>
            {% if current_sort == 'transportadora' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            <a href="?sort=transportadora&direction={{ next_dir }}">Transportadora</a>
          </th>

          <!-- Faturamento -->
          <th>
            {% if current_sort == 'data_faturamento' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            <a href="?sort=data_faturamento&direction={{ next_dir }}">Faturamento</a>
          </th>

          <!-- Embarque -->
          <th>
            {% if current_sort == 'data_embarque' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            <a href="?sort=data_embarque&direction={{ next_dir }}">Embarque</a>
          </th>

          <!-- Agendamento -->
          <th>
            <!-- Se voc√™ tiver um campo "data_agendamento" no model ou algo similar -->
            {% if current_sort == 'data_agenda' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            <a href="?sort=data_agenda&direction={{ next_dir }}">Agendamento</a>
          </th>

          <!-- Prevista -->
          <th>
            {% if current_sort == 'data_entrega_prevista' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            <a href="?sort=data_entrega_prevista&direction={{ next_dir }}">Prevista</a>
          </th>

          <!-- Status -->
          <th>Status</th>
          <!-- Alertas -->
          <th>Alertas</th>
          <!-- A√ß√µes -->
          <th>A√ß√µes</th>
        </tr>
      </thead>

      <tbody>
        {% for e in entregas %}
        <tr>
          <td class="sticky-col">
            {% if e.comentarios_pendentes(current_user.nome) > 0 %}
              <span class="badge bg-info" style="cursor:pointer;">
                üí¨ {{ e.comentarios_pendentes(current_user.nome) }}
              </span>
            {% endif %}
            <small class="text-muted">{{ e.num_pedido or 'N/A' }}</small><br>
            {{ e.numero_nf }}<br>
            <small class="text-muted">{{ 'R$ {:,.2f}'.format(e.valor_nf).replace(',', 'X').replace('.', ',').replace('X', '.') if e.valor_nf else 'N/A' }}</small>
          </td>
          <td class="sticky-col-2">
            <small class="text-muted">{{ e.cnpj_cliente }}</small><br>
            {{ e.cliente }}<br>
            <small class="text-muted">üë§ {{ e.vendedor or 'N√£o informado' }}</small>
          </td>
          <td>
            {% if e.incoterm or e.modalidade %}
              <small class="text-muted">{{ e.incoterm or '' }}{% if e.incoterm and e.modalidade %} - {% endif %}{{ e.modalidade or '' }}</small><br>
            {% endif %}
            {{ e.transportadora }}<br>
            <small class="text-muted">{{ e.uf }} - {{ e.municipio }}</small>
          </td>
          <td>{{ e.data_faturamento | formatar_data_segura if e.data_faturamento else '-' }}</td>
          <td>{{ e.data_embarque | formatar_data_segura if e.data_embarque else '-' }}</td>
          <td>
            {% if e.data_agenda %}
              {% set ultimo_agendamento = e.agendamentos | sort(attribute='criado_em') | last if e.agendamentos else None %}
              {% if ultimo_agendamento and ultimo_agendamento.status == 'confirmado' %}
                <button class="btn btn-sm btn-primary w-100 text-white" onclick="agendarEntrega('{{ e.id }}', '{{ e.numero_nf }}')">
                  üìÖ {{ e.data_agenda | formatar_data_segura }}
                  {% if ultimo_agendamento.protocolo_agendamento %}
                    <br><small>üìã {{ ultimo_agendamento.protocolo_agendamento }}</small>
                  {% endif %}
                  <br><small>‚úÖ Confirmado</small>
                </button>
              {% else %}
                <div class="d-flex align-items-center gap-1">
                  <button class="btn btn-sm btn-warning flex-grow-1" onclick="agendarEntrega('{{ e.id }}', '{{ e.numero_nf }}')">
                    üìÖ {{ e.data_agenda | formatar_data_segura }}
                    {% if ultimo_agendamento and ultimo_agendamento.protocolo_agendamento %}
                      <br><small>üìã {{ ultimo_agendamento.protocolo_agendamento }}</small>
                    {% endif %}
                    <br><small>‚è≥ Aguardando</small>
                  </button>
                  {% if ultimo_agendamento and ultimo_agendamento.status == 'aguardando' %}
                    <button class="btn btn-sm btn-success" onclick="confirmarAgendamento('{{ ultimo_agendamento.id }}')">
                      ‚úÖ
                    </button>
                  {% endif %}
                </div>
              {% endif %}
            {% else %}
              <button class="btn btn-sm btn-warning w-100" onclick="agendarEntrega('{{ e.id }}', '{{ e.numero_nf }}')">
                ‚ûï Agendar
              </button>
            {% endif %}
          </td>
          <td>
            {% if e.data_entrega_prevista %}
              <button class="btn btn-sm btn-primary w-100 text-white" onclick="alterarDataPrevista('{{ e.id }}', '{{ e.numero_nf }}', '{{ e.data_entrega_prevista }}')">
                üìÖ {{ e.data_entrega_prevista | formatar_data_segura }}
              </button>
            {% else %}
              <button class="btn btn-sm btn-warning w-100" onclick="alterarDataPrevista('{{ e.id }}', '{{ e.numero_nf }}', '')">
                ‚ûï Definir Data
              </button>
            {% endif %}
          </td>
          <td>
            {% if e.nf_cd %}
                <span class="badge bg-info">NF no CD</span>

            {% elif e.status_finalizacao == "Troca de NF" and e.nova_nf %}
                <a href="?numero_nf={{ e.nova_nf }}" class="btn btn-sm btn-info">
                  Nova NF {{ e.nova_nf }}
                </a>
            {% elif e.status_finalizacao == "Entregue" %}
            <span class="badge bg-success entregue-popup" 
                  data-entrega={{ e.data_hora_entrega_realizada | formatar_data_hora_brasil if e.data_hora_entrega_realizada else '-' }}
                  style="cursor:pointer;"
                  tabindex="0">
              Entregue
              </span>
              
              <!-- üìÑ STATUS/BOT√ÉO DO CANHOTO -->
              <div class="mt-1">
                {% if e.possui_canhoto %}
                  <a href="{{ url_for('monitoramento.visualizar_canhoto', id=e.id) }}" 
                     class="badge bg-success text-decoration-none" 
                     title="Visualizar canhoto anexado"
                     target="_blank">
                    üìÑ Canhoto OK
                  </a>
                {% else %}
                  <span class="badge bg-light text-dark upload-canhoto-btn" 
                        data-entrega-id="{{ e.id }}"
                        data-numero-nf="{{ e.numero_nf }}"
                        title="Anexar canhoto da entrega"
                        style="cursor: pointer;">
                    üìÑ S/ canhoto
                  </span>
                {% endif %}
              </div>
            {% elif e.status_finalizacao %}
                <span class="badge bg-dark">{{ e.status_finalizacao }}</span>
            {% elif e.data_entrega_prevista and e.data_entrega_prevista < current_date %}
                <span class="badge bg-danger">Atrasada</span>
            {% elif e.data_entrega_prevista %}
            <span class="badge bg-light text-dark">No Prazo</span>
            {% else %}
              <span class="badge bg-warning text-dark">Sem Previs√£o</span>
            {% endif %}
            </td>
            
          <td>
            <div class="d-flex flex-column gap-1">
              {% set pendencias_abertas = [] %}
              {% for p in e.pendencias_financeiras %}
                {% if not p.respondida_em or p.resposta_excluida_em %}
                  {% set _ = pendencias_abertas.append(p) %}
                {% endif %}
              {% endfor %}
              {% if pendencias_abertas %}
                {% set pendencia = pendencias_abertas[0] %}
                <button class="btn btn-sm btn-danger pendencia-btn"
                        data-nf="{{ e.numero_nf }}"
                        data-observacao="{{ pendencia.observacao }}">
                  Pend. Financ.
                </button>
              {% endif %}
              
              {% if e.cnpj_cliente in contatos_agendamento and e.agendamentos|length == 0 and contatos_agendamento[e.cnpj_cliente].forma and contatos_agendamento[e.cnpj_cliente].forma != '' and contatos_agendamento[e.cnpj_cliente].forma != 'SEM AGENDAMENTO' and not e.status_finalizacao %}
                <span class="badge bg-danger">‚ö†Ô∏è Agend. Pendente</span>
              {% endif %}
              
              {% if e.reagendar %}
                <span class="badge bg-danger">üîÅ Reagendar</span>
              {% endif %}
              
              {% if e.possui_comentarios %}
                <span class="badge bg-info">üí¨ Coment√°rios</span>
              {% endif %}
            </div>
          </td>
          <td class="d-flex flex-nowrap align-items-center gap-2">
            <a href="{{ url_for('monitoramento.visualizar_entrega', id=e.id, **request.args) }}"
               class="btn btn-sm btn-outline-primary">
               Info
            </a>
            <form method="post" action="{{ url_for('monitoramento.toggle_reagendar', id=e.id, **request.args) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              {% if e.reagendar %}
                <button class="btn btn-sm btn-outline-danger reagendar-btn">
                  <span class="text-curto">Reagenda</span>
                  <span class="text-completo">Cancelar</span>
                </button>
              {% else %}
                <button class="btn btn-sm btn-outline-warning reagendar-btn">
                  <span class="text-curto">Reagenda</span>
                  <span class="text-completo">Marcar</span>
                </button>
              {% endif %}
            </form>
          </td>
        </tr>
        {% endfor %}

      </tbody>
    </table>
  {% endif %}
</div>








<!-- ===========================
     MODAL PARA PEND√äNCIA FINANCEIRA
     =========================== -->
<div class="modal fade" id="pendenciaModal" tabindex="-1" aria-labelledby="pendenciaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      
      <!-- Cabe√ßalho do Modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="pendenciaModalLabel">Pend√™ncia Financeira</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Corpo do Modal -->
      <div class="modal-body">
        <p>
          <strong>NF:</strong>
          <span id="nf-modal"></span>
        </p>
        <p>
          <strong>Observa√ß√£o Financeiro:</strong><br>
          <span id="observacao-modal"></span>
        </p>
        <div class="mb-3">
          <textarea id="resposta-logistica" class="form-control" rows="5" placeholder="Resposta Log√≠stica"></textarea>
        </div>
      </div>

      <!-- Rodap√© do Modal -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmar-resposta">
          Confirmar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     MODAL PARA ALTERAR DATA PREVISTA
     =========================== -->
<div class="modal fade" id="dataPrevistaModal" tabindex="-1" aria-labelledby="dataPrevistaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      
      <!-- Cabe√ßalho do Modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="dataPrevistaModalLabel">üìÖ Alterar Data de Entrega Prevista</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Corpo do Modal -->
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>NF:</strong> <span id="nf-data-modal"></span></p>
            
            <form id="form-data-prevista">
              <div class="mb-3">
                <label for="nova-data-prevista" class="form-label">Nova Data de Entrega Prevista</label>
                <input type="date" id="nova-data-prevista" class="form-control" required>
              </div>
              
              <div class="mb-3">
                <label for="motivo-alteracao" class="form-label">Motivo da Altera√ß√£o</label>
                <textarea id="motivo-alteracao" class="form-control" rows="3" placeholder="Descreva o motivo da altera√ß√£o..." required></textarea>
              </div>
            </form>
          </div>
          
          <div class="col-md-6">
            <h6>üìã Hist√≥rico de Altera√ß√µes</h6>
            <div id="historico-data-prevista" class="border p-2" style="height: 200px; overflow-y: auto;">
              <div class="text-center text-muted">
                <i class="fas fa-spinner fa-spin"></i> Carregando hist√≥rico...
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Rodap√© do Modal -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmar-data-prevista">
          üíæ Salvar Altera√ß√£o
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     MODAL PARA UPLOAD DE CANHOTO
     =========================== -->
<div class="modal fade" id="canhotoModal" tabindex="-1" aria-labelledby="canhotoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      
      <!-- Cabe√ßalho do Modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="canhotoModalLabel">üìÑ Anexar Canhoto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Corpo do Modal -->
      <div class="modal-body">
        <p>
          <strong>NF:</strong>
          <span id="nf-canhoto-modal"></span>
        </p>
        
        <form id="form-upload-canhoto" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="arquivo-canhoto" class="form-label">Arquivo do Canhoto</label>
            <input type="file" 
                   class="form-control" 
                   id="arquivo-canhoto" 
                   name="canhoto" 
                   accept=".jpg,.jpeg,.png,.pdf"
                   required>
            <div class="form-text">
              Formatos aceitos: JPG, PNG, PDF (m√°x. 10MB)
            </div>
          </div>
          
          <!-- Preview do arquivo selecionado -->
          <div id="preview-canhoto" class="mt-2" style="display: none;">
            <div class="alert alert-info">
              <strong>Arquivo selecionado:</strong> <span id="nome-arquivo-canhoto"></span>
              <br>
              <small>Tamanho: <span id="tamanho-arquivo-canhoto"></span></small>
            </div>
          </div>
        </form>
      </div>

      <!-- Rodap√© do Modal -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmar-upload-canhoto">
          üìÑ Anexar Canhoto
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     MODAL PARA AGENDAMENTO R√ÅPIDO
     =========================== -->
<div class="modal fade" id="agendamentoModal" tabindex="-1" aria-labelledby="agendamentoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      
      <!-- Cabe√ßalho do Modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="agendamentoModalLabel">üìÖ Agendamento R√°pido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Corpo do Modal -->
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>NF:</strong> <span id="nf-agendamento-modal"></span></p>
            
            <form id="form-agendamento-rapido">
              <div class="row">
                <div class="col-md-6">
                  <label for="data-agendada" class="form-label">Data Agendada</label>
                  <input type="date" id="data-agendada" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label for="hora-agendada" class="form-label">Hora Agendada</label>
                  <input type="time" id="hora-agendada" class="form-control">
                </div>
              </div>
              
              <div class="row mt-3">
                <div class="col-md-6">
                  <label for="forma-agendamento" class="form-label">Forma</label>
                  <select id="forma-agendamento" class="form-select" required>
                    <option value="">Selecione...</option>
                    <option value="Portal">Portal</option>
                    <option value="Telefone">Telefone</option>
                    <option value="E-mail">E-mail</option>
                    <option value="WhatsApp">WhatsApp</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="protocolo-agendamento" class="form-label">Protocolo</label>
                  <input type="text" id="protocolo-agendamento" class="form-control" placeholder="Protocolo...">
                </div>
              </div>
              
              <div class="mt-3">
                <label for="motivo-agendamento" class="form-label">Motivo</label>
                <textarea id="motivo-agendamento" class="form-control" rows="3" placeholder="Motivo do agendamento..."></textarea>
              </div>
              
              <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" id="criar-confirmado">
                <label class="form-check-label" for="criar-confirmado">
                  ‚úÖ Criar agenda j√° confirmada
                </label>
              </div>
            </form>
            
            <!-- √Årea de confirma√ß√£o do √∫ltimo agendamento -->
            <div id="confirmar-ultimo-agendamento" class="mt-3" style="display: none;">
              <hr>
              <h6>üéØ Confirmar √öltimo Agendamento</h6>
              <div id="detalhes-ultimo-agendamento"></div>
              <div class="mt-2">
                <label for="observacoes-confirmacao" class="form-label">Observa√ß√µes da Confirma√ß√£o</label>
                <textarea id="observacoes-confirmacao" class="form-control" rows="2" placeholder="Observa√ß√µes sobre a confirma√ß√£o..."></textarea>
              </div>
              <button type="button" class="btn btn-success btn-sm mt-2" id="btn-confirmar-ultimo">
                ‚úÖ Confirmar Agendamento
              </button>
            </div>
          </div>
          
          <div class="col-md-6">
            <h6>üìã Hist√≥rico de Agendamentos</h6>
            <div id="historico-agendamentos" class="border p-2" style="height: 400px; overflow-y: auto;">
              <div class="text-center text-muted">
                <i class="fas fa-spinner fa-spin"></i> Carregando hist√≥rico...
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Rodap√© do Modal -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmar-agendamento">
          üìÖ Criar Agendamento
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- ‚úÖ SCRIPT B√ÅSICO -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ===========================
  // PRESERVAR FILTROS NOS LINKS DE ORDENA√á√ÉO
  // ===========================
  const currentUrl = new URL(window.location);
  
  // Para todos os links de ordena√ß√£o na tabela
  document.querySelectorAll('th a').forEach(link => {
    const linkUrl = new URL(link.href, window.location.origin);
    
    // Preserva todos os par√¢metros atuais exceto sort e direction
    currentUrl.searchParams.forEach((value, key) => {
      if (key !== 'sort' && key !== 'direction' && key !== 'page') {
        linkUrl.searchParams.set(key, value);
      }
    });
    
    // Atualiza o href do link
    link.href = linkUrl.toString();
  });
  
  const stickyPagination = document.getElementById('sticky-pagination');
  
  if (stickyPagination) {
    // üîß FOR√áA estilos para garantir que sticky funcione
    stickyPagination.style.setProperty('position', 'sticky', 'important');
    stickyPagination.style.setProperty('top', '0px', 'important');
    stickyPagination.style.setProperty('z-index', '104', 'important');
    stickyPagination.style.setProperty('background', '#ffffff', 'important');
    
    // For√ßa o parent a ter overflow visible
    let parent = stickyPagination.parentElement;
    while (parent && parent !== document.body) {
      parent.style.setProperty('overflow', 'visible', 'important');
      parent = parent.parentElement;
    }
    
    // Observer para detectar quando a pagina√ß√£o est√° grudada (sem logs)
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.intersectionRatio < 1) {
          // Pagina√ß√£o est√° grudada (n√£o completamente vis√≠vel)
          stickyPagination.classList.add('stuck');
        } else {
          // Pagina√ß√£o est√° solta (completamente vis√≠vel)
          stickyPagination.classList.remove('stuck');
        }
      },
      { threshold: 1 } // Detecta quando 100% do elemento est√° vis√≠vel
    );
    
    observer.observe(stickyPagination);
  }
  });

  // ===========================
  // AUTO SUBMIT PARA CAMPOS DE DATA (APENAS FILTROS)
  // ===========================
  
  // Seleciona APENAS os campos de data do formul√°rio de filtros (n√£o dos modais)
  const camposDataFiltros = document.querySelectorAll('#form-filtros input[type="date"]');
  
  // Fun√ß√£o para auto submit
  function autoSubmitFiltros() {
    // Encontra o formul√°rio pai
    const form = this.closest('form');
    if (form && form.id === 'form-filtros') {
      form.submit();
    }
  }
  
  // Adiciona auto submit APENAS para os campos de filtro
  camposDataFiltros.forEach(campo => {
    campo.addEventListener('change', autoSubmitFiltros);
  });
</script>
<!-- ===========================
     SCRIPTS ESPEC√çFICOS
     =========================== -->

<!-- Exemplo de popover para 'Entregue' (n√£o tem a ver com o modal) -->
<script>
  document.querySelectorAll('.entregue-popup').forEach(item => {
  item.style.cursor = 'pointer';
  item.addEventListener('click', function(event) {
    const dataEntrega = event.target.getAttribute('data-entrega');

    // Se j√° existir um popover aberto, "dispose" para fechar
    if (window.currentPopover) {
      window.currentPopover.dispose();
    }

    // Instancia o popover, mas agora com container: 'body'
    window.currentPopover = new bootstrap.Popover(event.target, {
      container: 'body',                  // importante para n√£o "cortar" dentro de div com overflow
      content: 'Entregue em: ' + dataEntrega,
      placement: 'top',
      trigger: 'focus'
    });
    window.currentPopover.show();
  });
});

</script>

<script>
  // 1. Pega o token CSRF do <meta name="csrf-token">
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  // 2. Instancia os modais do Bootstrap (uma vez s√≥)
  const pendenciaModal = new bootstrap.Modal(document.getElementById('pendenciaModal'));
  const agendamentoModal = new bootstrap.Modal(document.getElementById('agendamentoModal'), {
    backdrop: 'static',  // Impede fechamento ao clicar fora
    keyboard: true       // Permite Esc para fechar
  });
  const dataPrevistaModal = new bootstrap.Modal(document.getElementById('dataPrevistaModal'), {
    backdrop: 'static',  // Impede fechamento ao clicar fora
    keyboard: true       // Permite Esc para fechar
  });
  const canhotoModal = new bootstrap.Modal(document.getElementById('canhotoModal'), {
    backdrop: 'static',  // Impede fechamento ao clicar fora
    keyboard: true       // Permite Esc para fechar
  });

  // Event listeners para melhorar UX dos modais
  document.getElementById('agendamentoModal').addEventListener('shown.bs.modal', function () {
    // Foca no primeiro campo quando modal abrir
    document.getElementById('data-agendada').focus();
  });

  document.getElementById('dataPrevistaModal').addEventListener('shown.bs.modal', function () {
    // Foca no campo de data quando modal abrir
    document.getElementById('nova-data-prevista').focus();
  });

  document.getElementById('canhotoModal').addEventListener('shown.bs.modal', function () {
    // Foca no campo de arquivo quando modal abrir
    document.getElementById('arquivo-canhoto').focus();
  });

  // Ao clicar no bot√£o .pendencia-btn, abrimos o modal
  document.querySelectorAll('.pendencia-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const nf = this.dataset.nf;
      const observacao = this.dataset.observacao;

      // Preenche campos do modal
      document.getElementById('nf-modal').textContent = nf;
      document.getElementById('observacao-modal').textContent = observacao;
      document.getElementById('resposta-logistica').value = '';

      // Armazena a NF no bot√£o "Confirmar"
      document.getElementById('confirmar-resposta').setAttribute('data-nf', nf);

      // Abre o modal
      pendenciaModal.show();
    });
  });

  // Ao clicar no bot√£o Confirmar do modal
  document.getElementById('confirmar-resposta').addEventListener('click', function() {
    const nf = this.getAttribute('data-nf');
    const resposta = document.getElementById('resposta-logistica').value;

    fetch(`/financeiro/pendencias/${nf}/responder`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({ resposta: resposta })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        alert('Resposta salva com sucesso!');
        pendenciaModal.hide();
        location.reload();
      } else {
        alert('Erro ao salvar resposta.');
      }
    })
    .catch(err => {
      console.error("Erro no modal de pend√™ncias:", err);
      alert("Erro na requisi√ß√£o ao servidor.");
    });
  });

  // ===========================
  // FUNCIONALIDADE DE UPLOAD DE CANHOTO
  // ===========================
  
  // Event listener para bot√µes de upload de canhoto
  document.querySelectorAll('.upload-canhoto-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const entregaId = this.dataset.entregaId;
      const numeroNf = this.dataset.numeroNf;
      
      // Preenche campos do modal
      document.getElementById('nf-canhoto-modal').textContent = numeroNf;
      document.getElementById('confirmar-upload-canhoto').setAttribute('data-entrega-id', entregaId);
      
      // Limpa formul√°rio
      document.getElementById('form-upload-canhoto').reset();
      document.getElementById('preview-canhoto').style.display = 'none';
      
      // Abre o modal
      canhotoModal.show();
    });
  });
  
  // Preview do arquivo selecionado
  document.getElementById('arquivo-canhoto').addEventListener('change', function() {
    const file = this.files[0];
    const previewDiv = document.getElementById('preview-canhoto');
    
    if (file) {
      document.getElementById('nome-arquivo-canhoto').textContent = file.name;
      document.getElementById('tamanho-arquivo-canhoto').textContent = (file.size / 1024).toFixed(1) + ' KB';
      previewDiv.style.display = 'block';
    } else {
      previewDiv.style.display = 'none';
    }
  });
  
  // Confirmar upload do canhoto
  document.getElementById('confirmar-upload-canhoto').addEventListener('click', function() {
    const entregaId = this.getAttribute('data-entrega-id');
    const fileInput = document.getElementById('arquivo-canhoto');
    const file = fileInput.files[0];
    
    if (!file) {
      alert('Por favor, selecione um arquivo.');
      return;
    }
    
    // Validar tamanho (m√°x 10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('Arquivo muito grande. O tamanho m√°ximo √© 10MB.');
      return;
    }
    
    // Validar extens√£o
    const extensao = file.name.split('.').pop().toLowerCase();
    if (!['jpg', 'jpeg', 'png', 'pdf'].includes(extensao)) {
      alert('Formato n√£o permitido. Use apenas JPG, PNG ou PDF.');
      return;
    }
    
    // Criar FormData para envio
    const formData = new FormData();
    formData.append('canhoto', file);
    
    // Desabilita bot√£o durante upload
    const btn = this;
    const textOriginal = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    btn.disabled = true;
    
    // Enviar arquivo
    fetch(`/monitoramento/${entregaId}/upload_canhoto`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        canhotoModal.hide();
        location.reload(); // Recarrega para mostrar o novo status
      } else {
        alert('Erro: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Erro no upload:', error);
      alert('Erro ao enviar arquivo. Tente novamente.');
    })
    .finally(() => {
      // Reabilita bot√£o
      btn.innerHTML = textOriginal;
      btn.disabled = false;
    });
  });

  // ===========================
  // NOVO: FUNCIONALIDADE DE AGENDAMENTO R√ÅPIDO
  // ===========================
  window.agendarEntrega = function(entregaId, numeroNf) {
    document.getElementById('nf-agendamento-modal').textContent = numeroNf;
    document.getElementById('confirmar-agendamento').setAttribute('data-entrega-id', entregaId);
    
    // Limpa formul√°rio
    document.getElementById('form-agendamento-rapido').reset();
    document.getElementById('criar-confirmado').checked = false;
    
    // Carrega hist√≥rico de agendamentos
    carregarHistoricoAgendamentos(entregaId);
    
    // Usa a inst√¢ncia global do modal
    agendamentoModal.show();
  };

  // Carregar hist√≥rico de agendamentos
  function carregarHistoricoAgendamentos(entregaId) {
    const historicoDiv = document.getElementById('historico-agendamentos');
    const confirmarUltimoDiv = document.getElementById('confirmar-ultimo-agendamento');
    
    historicoDiv.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Carregando hist√≥rico...</div>';
    
    fetch(`/monitoramento/${entregaId}/historico_agendamentos`)
    .then(response => response.json())
    .then(data => {
      if (data.agendamentos && data.agendamentos.length > 0) {
        let html = '';
        let ultimoAguardando = null;
        
        data.agendamentos.forEach((agendamento, index) => {
          const statusBadge = agendamento.status === 'confirmado' 
            ? '<span class="badge bg-primary">‚úÖ Confirmado</span>'
            : '<span class="badge bg-warning">‚è≥ Aguardando</span>';
          
          // Identifica o √∫ltimo agendamento aguardando
          if (index === 0 && agendamento.status === 'aguardando') {
            ultimoAguardando = agendamento;
          }
          
          html += `
            <div class="border-bottom pb-2 mb-2">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>${agendamento.data_agendada}</strong>
                  ${agendamento.hora_agendada ? ' √†s ' + agendamento.hora_agendada : ''}
                  <br><small class="text-muted">üìã ${agendamento.protocolo_agendamento || 'Sem protocolo'}</small>
                  <br><small class="text-muted">Por ${agendamento.autor} - ${agendamento.criado_em}</small>
                  ${agendamento.status === 'confirmado' && agendamento.confirmado_por ? 
                    `<br><small class="text-success">Confirmado por ${agendamento.confirmado_por} em ${agendamento.confirmado_em}</small>` : ''}
                </div>
                <div>${statusBadge}</div>
              </div>
              ${agendamento.motivo ? `<small><strong>Motivo:</strong> ${agendamento.motivo}</small><br>` : ''}
              ${agendamento.observacoes_confirmacao ? `<small><strong>Obs. Confirma√ß√£o:</strong> ${agendamento.observacoes_confirmacao}</small>` : ''}
            </div>
          `;
        });
        
        historicoDiv.innerHTML = html;
        
        // Mostra √°rea de confirma√ß√£o se h√° agendamento aguardando
        if (ultimoAguardando) {
          document.getElementById('detalhes-ultimo-agendamento').innerHTML = `
            <p><strong>Data:</strong> ${ultimoAguardando.data_agendada}${ultimoAguardando.hora_agendada ? ' √†s ' + ultimoAguardando.hora_agendada : ''}</p>
            <p><strong>Protocolo:</strong> ${ultimoAguardando.protocolo_agendamento || 'Sem protocolo'}</p>
            <p><strong>Forma:</strong> ${ultimoAguardando.forma_agendamento}</p>
          `;
          document.getElementById('btn-confirmar-ultimo').setAttribute('data-agendamento-id', ultimoAguardando.id);
          confirmarUltimoDiv.style.display = 'block';
        } else {
          confirmarUltimoDiv.style.display = 'none';
        }
      } else {
        historicoDiv.innerHTML = '<div class="text-center text-muted">Nenhum agendamento registrado</div>';
        confirmarUltimoDiv.style.display = 'none';
      }
    })
    .catch(err => {
      console.error('Erro ao carregar hist√≥rico:', err);
      historicoDiv.innerHTML = '<div class="text-center text-danger">Erro ao carregar hist√≥rico</div>';
    });
  }

  // Confirmar agendamento
  document.getElementById('confirmar-agendamento').addEventListener('click', function() {
    const entregaId = this.getAttribute('data-entrega-id');
    const formData = new FormData();
    
    formData.append('csrf_token', csrfToken);
    formData.append('data_agendada', document.getElementById('data-agendada').value);
    formData.append('hora_agendada', document.getElementById('hora-agendada').value);
    formData.append('forma_agendamento', document.getElementById('forma-agendamento').value);
    formData.append('protocolo_agendamento', document.getElementById('protocolo-agendamento').value);
    formData.append('motivo', document.getElementById('motivo-agendamento').value);
    formData.append('criar_confirmado', document.getElementById('criar-confirmado').checked ? 'y' : '');

    fetch(`/monitoramento/${entregaId}/adicionar_agendamento`, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        alert('‚úÖ Agendamento registrado com sucesso!');
        location.reload();
      } else {
        alert('‚ùå Erro ao registrar agendamento.');
      }
    })
    .catch(err => {
      console.error('Erro:', err);
      alert('‚ùå Erro na requisi√ß√£o.');
    });
  });

  // Confirmar √∫ltimo agendamento no modal
  document.getElementById('btn-confirmar-ultimo').addEventListener('click', function() {
    const agendamentoId = this.getAttribute('data-agendamento-id');
    const observacoes = document.getElementById('observacoes-confirmacao').value;
    
    const formData = new FormData();
    formData.append('csrf_token', csrfToken);
    formData.append('observacoes_confirmacao', observacoes);

    fetch(`/monitoramento/confirmar_agendamento/${agendamentoId}`, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        alert('‚úÖ Agendamento confirmado com sucesso!');
        location.reload();
      } else {
        alert('‚ùå Erro ao confirmar agendamento.');
      }
    })
    .catch(err => {
      console.error('Erro:', err);
      alert('‚ùå Erro na requisi√ß√£o.');
    });
  });

  // Fun√ß√£o para confirmar agendamento diretamente da listagem
  window.confirmarAgendamento = function(agendamentoId) {
    if (!confirm('Confirmar este agendamento?')) return;
    
    const formData = new FormData();
    formData.append('csrf_token', csrfToken);

    fetch(`/monitoramento/confirmar_agendamento/${agendamentoId}`, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        alert('‚úÖ Agendamento confirmado com sucesso!');
        location.reload();
      } else {
        alert('‚ùå Erro ao confirmar agendamento.');
      }
    })
    .catch(err => {
      console.error('Erro:', err);
      alert('‚ùå Erro na requisi√ß√£o.');
    });
  };

  // ===========================
  // NOVO: FUNCIONALIDADE DE ALTERAR DATA PREVISTA
  // ===========================
  window.alterarDataPrevista = function(entregaId, numeroNf, dataAtual) {
    document.getElementById('nf-data-modal').textContent = numeroNf;
    document.getElementById('confirmar-data-prevista').setAttribute('data-entrega-id', entregaId);
    
    // Preenche data atual se existir
    if (dataAtual) {
      document.getElementById('nova-data-prevista').value = dataAtual;
    }
    
    // Carrega hist√≥rico
    carregarHistoricoDataPrevista(entregaId);
    
    // Usa a inst√¢ncia global do modal
    dataPrevistaModal.show();
  };

  // Carregar hist√≥rico de altera√ß√µes
  function carregarHistoricoDataPrevista(entregaId) {
    const historicoDiv = document.getElementById('historico-data-prevista');
    historicoDiv.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Carregando hist√≥rico...</div>';
    
    fetch(`/monitoramento/${entregaId}/historico_data_prevista`)
    .then(response => response.json())
    .then(data => {
      if (data.historico && data.historico.length > 0) {
        let html = '';
        data.historico.forEach(item => {
          html += `
            <div class="border-bottom pb-2 mb-2">
              <small class="text-muted">${item.data_alteracao}</small><br>
              <strong>De:</strong> ${item.data_anterior || 'N√£o definida'}<br>
              <strong>Para:</strong> ${item.data_nova}<br>
              <strong>Por:</strong> ${item.alterado_por}<br>
              <strong>Motivo:</strong> ${item.motivo}
            </div>
          `;
        });
        historicoDiv.innerHTML = html;
      } else {
        historicoDiv.innerHTML = '<div class="text-center text-muted">Nenhuma altera√ß√£o registrada</div>';
      }
    })
    .catch(err => {
      console.error('Erro ao carregar hist√≥rico:', err);
      historicoDiv.innerHTML = '<div class="text-center text-danger">Erro ao carregar hist√≥rico</div>';
    });
  }

  // Confirmar altera√ß√£o de data prevista
  document.getElementById('confirmar-data-prevista').addEventListener('click', function() {
    const entregaId = this.getAttribute('data-entrega-id');
    const novaData = document.getElementById('nova-data-prevista').value;
    const motivo = document.getElementById('motivo-alteracao').value;
    
    if (!novaData || !motivo) {
      alert('‚ùå Data e motivo s√£o obrigat√≥rios!');
      return;
    }

    const formData = new FormData();
    formData.append('csrf_token', csrfToken);
    formData.append('nova_data_prevista', novaData);
    formData.append('motivo_alteracao', motivo);

    fetch(`/monitoramento/${entregaId}/alterar_data_prevista`, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        alert('‚úÖ Data de entrega prevista alterada com sucesso!');
        location.reload();
      } else {
        alert('‚ùå Erro ao alterar data.');
      }
    })
    .catch(err => {
      console.error('Erro:', err);
      alert('‚ùå Erro na requisi√ß√£o.');
    });
  });
</script>
{% endblock %}
</div> <!-- fim pagination-container -->

