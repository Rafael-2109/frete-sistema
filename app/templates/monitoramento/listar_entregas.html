{% extends 'base.html' %}

{% block extra_css %}
<style>
/* üéØ PAGINA√á√ÉO H√çBRIDA - FUNCIONA EM QUALQUER NAVEGADOR */
#hybrid-pagination {
  position: relative !important; /* Come√ßa normal */
  background: #ffffff !important;
  border-bottom: 2px solid #28a745 !important;
  box-shadow: 0 3px 15px rgba(0,0,0,0.2) !important;
  padding: 8px 0 !important;
  margin: 0 !important;
  transition: all 0.3s ease !important;
  z-index: 104 !important; /* ABAIXO do navbar (1050) */
}

/* üîí QUANDO GRUDADO (via JavaScript) */
#hybrid-pagination.is-stuck {
  position: fixed !important;
  top: 56px !important; /* Abaixo do navbar */
  left: 0 !important;
  right: 0 !important;
  width: 100% !important;
  border: 3px solid #dc3545 !important; /* Borda vermelha quando grudado */
  background: #f8f9fa !important; /* Fundo ligeiramente diferente */
  transform: translateY(0) !important;
  z-index: 104 !important; /* ABAIXO do navbar (1050) */
}

/* üé® Estilos da pagina√ß√£o h√≠brida */
#hybrid-pagination .container-fluid {
  max-width: none !important;
  padding: 0 15px !important;
}

#hybrid-pagination .pagination {
  margin: 0 !important;
  padding: 0 !important;
  display: flex !important;
}

#hybrid-pagination .page-link {
  color: #28a745 !important;
  background-color: #ffffff !important;
  border: 2px solid #28a745 !important;
  padding: 8px 16px !important;
  margin: 0 2px !important;
  font-weight: 600 !important;
  text-decoration: none !important;
  border-radius: 6px !important;
  transition: all 0.2s ease !important;
}

#hybrid-pagination .page-item.active .page-link {
  background-color: #28a745 !important;
  color: #ffffff !important;
  border-color: #28a745 !important;
}

#hybrid-pagination .page-link:hover {
  background-color: #218838 !important;
  color: #ffffff !important;
  border-color: #218838 !important;
  transform: scale(1.05) !important;
}

/* ‚úÖ ESPA√áAMENTOS NORMAIS - SEM MARGEM FIXA */
.filters-offset {
  margin-top: 0 !important; /* Normal, sem espa√ßo fixo */
  padding-top: 10px !important;
}

.pagination-offset {
  margin-top: 20px !important; /* Espa√ßo normal para a tabela */
  padding-top: 10px !important;
}

/* FOR√áA ESPEC√çFICA PARA O BODY */
body {
  padding-top: 0 !important;
}

/* ‚úÖ FILTROS COM POSICIONAMENTO NORMAL */
.bg-light {
  margin-top: 0 !important; /* Posi√ß√£o normal no fluxo */
  position: relative !important;
  z-index: 103 !important; /* Abaixo da pagina√ß√£o mas acima do conte√∫do */
}

/* üéØ ESTILOS DA NOVA NAVBAR DE FILTROS */
#navbarFiltros {
  background: transparent;
}

/* Estilo melhorado para a navbar de filtros */
nav.navbar.navbar-light {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  border-radius: 10px !important;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2) !important;
}

/* üî• FOR√áAR GRADIENTE ROXO NO TEMA LIGHT */
[data-theme="light"] nav.navbar.navbar-light {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2) !important;
}

/* üåô ADAPTA√á√ÉO PARA TEMA DARK */
[data-theme="dark"] nav.navbar.navbar-light {
  background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%) !important;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5) !important;
}

[data-theme="dark"] .bg-light {
  background-color: #22262e !important;
}

[data-theme="dark"] .table {
  background-color: #22262e;
  color: #e4e6eb;
}

[data-theme="dark"] .table-striped tbody tr:nth-of-type(odd) {
  background-color: #262a32;
}

[data-theme="dark"] .table-hover tbody tr:hover {
  background-color: #2d3139;
}

[data-theme="dark"] .sticky-col,
[data-theme="dark"] .sticky-col-2,
[data-theme="dark"] .sticky-col-3 {
  background: #22262e !important;
  box-shadow: 2px 0 5px rgba(0,0,0,0.3);
  border-right: 2px solid #3a3f47 !important;
}

[data-theme="dark"] .btn-outline-secondary,
[data-theme="dark"] .btn-outline-danger,
[data-theme="dark"] .btn-outline-warning,
[data-theme="dark"] .btn-outline-success,
[data-theme="dark"] .btn-outline-info,
[data-theme="dark"] .btn-outline-primary,
[data-theme="dark"] .btn-outline-dark {
  background-color: #2d3139;
  border-color: #3a3f47;
  color: #e4e6eb;
}

[data-theme="dark"] .btn-outline-secondary:hover,
[data-theme="dark"] .btn-outline-danger:hover,
[data-theme="dark"] .btn-outline-warning:hover,
[data-theme="dark"] .btn-outline-success:hover,
[data-theme="dark"] .btn-outline-info:hover,
[data-theme="dark"] .btn-outline-primary:hover,
[data-theme="dark"] .btn-outline-dark:hover {
  background-color: #383d47;
  border-color: #4a5057;
}

/* Brand da navbar - SEMPRE BRANCO por causa do fundo roxo */
nav.navbar .navbar-brand {
  color: white !important;
  font-weight: 600;
}

/* Links da navbar - SEMPRE BRANCO por causa do fundo roxo/escuro */
nav.navbar .nav-link {
  color: white !important;
  font-weight: 500;
  transition: all 0.3s ease;
  border-radius: 5px;
  padding: 8px 15px !important;
}

/* üî• CORRE√á√ÉO: For√ßar cores escuras para textos no tema LIGHT */
[data-theme="light"] .table {
  color: #212529 !important;
}

[data-theme="light"] .text-muted {
  color: #6c757d !important;
}

[data-theme="light"] .dropdown-item {
  color: #212529 !important;
}

[data-theme="light"] .form-control,
[data-theme="light"] .form-select {
  color: #212529 !important;
  background-color: #ffffff !important;
}

[data-theme="light"] h1, 
[data-theme="light"] h2, 
[data-theme="light"] h3, 
[data-theme="light"] h4, 
[data-theme="light"] h5, 
[data-theme="light"] h6 {
  color: #212529 !important;
}

[data-theme="light"] label {
  color: #495057 !important;
}

[data-theme="light"] .card-body {
  color: #212529 !important;
}

/* Hover nos links */
nav.navbar .nav-link:hover {
  background: rgba(255, 255, 255, 0.2);
  color: white !important;
}

/* Link ativo/selecionado */
nav.navbar .nav-link.fw-bold {
  background: rgba(255, 255, 255, 0.25);
  color: white !important;
}

/* Dropdown menus */
.dropdown-menu {
  border-radius: 10px;
  box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
  border: none;
  padding: 10px 5px;
  min-width: 250px;
  animation: fadeInDropdown 0.3s ease;
}

@keyframes fadeInDropdown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Items do dropdown */
.dropdown-item {
  border-radius: 5px;
  padding: 10px 15px;
  margin: 2px 5px;
  transition: all 0.2s ease;
  font-weight: 500;
}

.dropdown-item:hover {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white !important;
  transform: translateX(5px);
}

.dropdown-item.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white !important;
}

/* Badges nos dropdowns */
.dropdown-item .badge {
  font-size: 0.75rem;
  padding: 3px 6px;
}

/* Badges de contadores na navbar */
nav.navbar .badge.rounded-pill {
  font-size: 0.7rem;
  padding: 3px 8px;
  margin-left: 5px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
  100% {
    transform: scale(1);
  }
}

/* Divider personalizado */
.dropdown-divider {
  border-color: rgba(102, 126, 234, 0.2);
  margin: 8px 10px;
}

/* Bot√£o toggle para mobile */
.navbar-toggler {
  border: 2px solid rgba(255, 255, 255, 0.5);
  padding: 4px 8px;
}

.navbar-toggler-icon {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.9%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
}

/* Bot√£o limpar filtro */
nav.navbar .nav-link.text-danger {
  color: #ffc107 !important;
  font-weight: 600;
}

nav.navbar .nav-link.text-danger:hover {
  background: rgba(255, 193, 7, 0.2);
  color: #ffeb3b !important;
}

/* Badge do status atual */
nav.navbar .navbar-brand .badge.bg-primary {
  background: rgba(255, 255, 255, 0.3) !important;
  font-size: 0.8rem;
  padding: 5px 10px;
  border-radius: 15px;
}

/* Responsividade melhorada */
@media (max-width: 992px) {
  nav.navbar .navbar-collapse {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }
  
  nav.navbar .navbar-collapse .nav-link {
    color: #667eea !important;
    border-bottom: 1px solid rgba(102, 126, 234, 0.1);
    margin: 5px 0;
  }
  
  nav.navbar .navbar-collapse .nav-link:hover {
    background: rgba(102, 126, 234, 0.1);
  }
  
  .dropdown-menu {
    position: static !important;
    transform: none !important;
    box-shadow: none;
    background: rgba(102, 126, 234, 0.05);
    margin: 10px 0;
  }
}

/* ‚úÖ RESPONSIVIDADE PARA H√çBRIDA */
@media (max-width: 768px) {
  #hybrid-pagination .col-md-4 {
    margin-top: 10px !important;
    text-align: center !important;
  }
  
  #hybrid-pagination .pagination {
    justify-content: center !important;
    flex-wrap: wrap !important;
  }
  
  #hybrid-pagination .page-link {
    font-size: 0.8rem !important;
    padding: 6px 12px !important;
  }
  
  /* ‚úÖ QUANDO GRUDADO NO MOBILE */
  #hybrid-pagination.is-stuck {
    top: 50px !important; /* Um pouco menos no mobile */
  }
  
  .pagination-offset {
    margin-top: 25px !important;
    padding-top: 15px !important;
  }
}

/* Indicador visual de loading */
.pagination-loading {
  opacity: 0.6;
  pointer-events: none;
}

/* Melhorias nas colunas sticky da tabela */
.sticky-col, .sticky-col-2, .sticky-col-3 {
  position: sticky;
  background: #fff !important;
  box-shadow: 2px 0 5px rgba(0,0,0,0.1);
  border-right: 2px solid #e9ecef !important;
}

.sticky-col {
  left: 0;
  z-index: 11;
  min-width: 120px;
}

.sticky-col-2 {
  left: 120px; /* Largura da coluna anterior */
  z-index: 10;
  min-width: 140px;
}

.sticky-col-3 {
  left: 260px; /* Largura das duas colunas anteriores */
  z-index: 9;
  min-width: 200px;
}

/* Efeitos hover na tabela */
.table-hover tbody tr:hover {
  background-color: rgba(0,123,255,0.05) !important;
  transform: scale(1.001);
  transition: all 0.2s ease;
}

/* Loading states */
.table.loading {
  opacity: 0.7;
  pointer-events: none;
}

/* Melhorias nos badges de status */
.badge {
  font-size: 0.75rem;
  font-weight: 500;
  letter-spacing: 0.3px;
}

/* Anima√ß√£o suave para mudan√ßas de p√°gina */
.page-transition {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* üîß CORRE√á√ÉO PARA CONFLITOS DO STYLE.CSS */
.pagination-container {
  /* Remove qualquer overflow que possa impedir sticky */
  overflow: visible !important;
  /* Remove white-space que pode causar problemas */
  white-space: normal !important;
  /* Garante que o container seja relativo */
  position: relative !important;
}

.pagination-container .table-responsive {
  /* Temporariamente remove overflow para esta p√°gina */
  overflow: visible !important;
}

/* ‚úÖ PAGINA√á√ÉO SIMPLES - SEM BURACO */
.sticky-pagination-simple {
  background: #ffffff !important;
  border-bottom: 2px solid #28a745 !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
  margin: 0 !important;
  padding: 0 !important;
}

/* üéØ INDICADOR VISUAL QUANDO GRUDADA */
.sticky-pagination-simple.stuck {
  border-color: #dc3545 !important;
  background: #ffe6e6 !important;
  box-shadow: 0 5px 20px rgba(220, 53, 69, 0.3) !important;
}

/* üìã CABE√áALHO DA TABELA STICKY */
.table thead th {
  position: -webkit-sticky !important; /* Safari */
  position: sticky !important;
  top: 90px !important; /* Abaixo da pagina√ß√£o */
  z-index: 102 !important; /* Abaixo da pagina√ß√£o (1040) mas acima do conte√∫do */
  background: #212529 !important; /* Fundo escuro (table-dark) */
  color: #ffffff !important;
  border-bottom: 2px solid #28a745 !important;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
}

/* üìã CORRE√á√ÉO PARA COLUNAS STICKY DA TABELA */
.table thead th.sticky-col,
.table thead th.sticky-col-2,
.table thead th.sticky-col-3 {
  z-index: 102 !important; /* Ligeiramente maior que headers normais */
  background: #212529 !important;
}

/* üìã AJUSTE PARA C√âLULAS DO BODY COM STICKY COLUMNS */
.table tbody td.sticky-col,
.table tbody td.sticky-col-2,
.table tbody td.sticky-col-3 {
  background: #ffffff !important;
  /* z-index j√° definido nas classes acima (1015, 1014, 1013) */
}

/* üé® MELHORIAS NOS BOT√ïES DE DATA */
.btn-sm.btn-info,
.btn-sm.btn-primary {
  line-height: 1.2 !important;
  padding: 8px 12px !important;
  font-weight: 500 !important;
}

.btn-sm.btn-info small,
.btn-sm.btn-primary small {
  display: block;
  font-size: 0.7rem !important;
  opacity: 0.9;
  margin-top: 2px;
}

/* Hover effects */
.btn-sm.btn-info:hover,
.btn-sm.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  transition: all 0.2s ease;
}

.btn-sm.btn-warning:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(255,193,7,0.4);
  transition: all 0.2s ease;
}
</style>
{% endblock %}

{% block content %}

<!-- üîß CONTAINER COM CORRE√á√ïES PARA STICKY -->
<div class="pagination-container">

<!-- 1) Se quiser um fundo claro s√≥ para os filtros, use algo como: -->
<div class="bg-light py-2">
  <div class="container-fluid">
    <!-- ‚úÖ FILTROS COM PERSIST√äNCIA - Mant√©m valores anteriores -->
    <form method="get" class="row g-1 align-items-end" id="form-filtros">
    <!-- Campos hidden para manter status e agrupamento -->
    {% if request.args.get('status') %}
      <input type="hidden" name="status" value="{{ request.args.get('status') }}">
    {% endif %}
    {% if request.args.get('agrupar') %}
      <input type="hidden" name="agrupar" value="{{ request.args.get('agrupar') }}">
    {% endif %}
    <div class="col-md-2">
      <label class="form-label">Nota Fiscal</label>
      <input type="text" name="numero_nf" class="form-control" placeholder="Nota Fiscal" 
             value="{{ request.args.get('numero_nf', '') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Transportadora</label>
      <input type="text" name="transportadora" class="form-control" placeholder="Transportadora" 
             value="{{ request.args.get('transportadora', '') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Cliente</label>
      <input type="text" name="cliente" class="form-control" placeholder="Cliente" 
             value="{{ request.args.get('cliente', '') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">CNPJ</label>
      <input type="text" name="cnpj_cliente" class="form-control" placeholder="CNPJ" 
             value="{{ request.args.get('cnpj_cliente', '') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Vendedor</label>
      <select name="vendedor" class="form-select">
        <option value="">Todos os vendedores</option>
        {% for vendedor in vendedores_unicos %}
          <option value="{{ vendedor }}" {% if request.args.get('vendedor') == vendedor %}selected{% endif %}>
            {{ vendedor }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-1">
      <label class="form-label">UF</label>
      <input type="text" name="uf" class="form-control" placeholder="UF" 
             value="{{ request.args.get('uf', '') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Protocolo</label>
      <input type="text" name="protocolo" class="form-control" placeholder="Protocolo" 
             value="{{ request.args.get('protocolo', '') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Data Emiss√£o</label>
      <input type="date" name="data_emissao" class="form-control" 
             value="{{ request.args.get('data_emissao', '') }}" id="data_emissao">
    </div>
    <div class="col-md-2">
      <label class="form-label">Data Embarque</label>
      <input type="date" name="data_embarque" class="form-control" 
             value="{{ request.args.get('data_embarque', '') }}" id="data_embarque">
    </div>
    <div class="col-md-2">
      <label class="form-label">Data Entrega Prevista</label>
      <input type="date" name="data_entrega_prevista" class="form-control" 
             value="{{ request.args.get('data_entrega_prevista', '') }}" id="data_entrega_prevista">
    </div>
    <div class="col-md-2">
      <label class="form-label">Entrega Realizada Em</label>
      <input type="date" name="data_entrega" class="form-control" 
             value="{{ request.args.get('data_entrega', '') }}" id="data_entrega">
    </div>  

    <div class="text-center">
      <button type="submit" class="btn btn-primary">Buscar</button>
        <a href="{{ url_for('monitoramento.listar_entregas') }}" class="btn btn-secondary">
          Limpar
        </a>
        {% if current_user.perfil != 'vendedor' %}
        <a href="{{ url_for('monitoramento.upload_canhotos_lote') }}" 
           class="btn btn-primary" 
           title="Upload de m√∫ltiplos canhotos de uma vez">
          <i class="fas fa-upload"></i> Upload Canhotos
        </a>
        {% endif %}
        <a href="{{ url_for('monitoramento.exportar_entregas') }}" 
           class="btn btn-success" 
           title="Exportar dados do monitoramento para Excel">
          <i class="fas fa-file-excel"></i> Exportar Excel
        </a>
    </div>
  </form>

    <!-- üéØ NOVA NAVBAR DE FILTROS CATEGORIZADOS -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border rounded shadow-sm mt-3 p-2">
      <div class="container-fluid">
        <!-- T√≠tulo/Brand da navbar de filtros -->
        <span class="navbar-brand mb-0 h6">
          <i class="fas fa-filter text-primary"></i> Filtros R√°pidos
          {% if request.args.get('status') %}
            <span class="badge bg-primary ms-2">{{ request.args.get('status')|replace('_', ' ')|title }}</span>
          {% endif %}
        </span>

        <!-- Bot√£o toggle para mobile -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarFiltros">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Conte√∫do colaps√°vel da navbar -->
        <div class="collapse navbar-collapse" id="navbarFiltros">
          <ul class="navbar-nav ms-auto">
            
            <!-- üìã Visualizar Todos -->
            <li class="nav-item">
              <a href="{{ url_for('monitoramento.listar_entregas') }}" 
                 class="nav-link {% if not request.args.get('status') %}fw-bold text-dark{% endif %}">
                <i class="fas fa-list"></i> Ver Todas
              </a>
            </li>

            <!-- üöö DROPDOWN: Status de Entrega -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="dropdownEntrega" role="button" 
                 data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-truck"></i> Status Entrega
                {% set total_entrega = (contadores.atrasadas or 0) + (contadores.sem_previsao or 0) %}
                {% if total_entrega > 0 %}
                  <span class="badge bg-danger rounded-pill">{{ total_entrega }}</span>
                {% endif %}
              </a>
              <ul class="dropdown-menu" aria-labelledby="dropdownEntrega">
                <li>
                  <a class="dropdown-item {% if request.args.get('status') == 'no_prazo' %}active{% endif %}" 
                     href="?status=no_prazo">
                    <span class="badge bg-secondary me-2">‚ö™</span> No Prazo
                  </a>
                </li>
                <li>
                  <a class="dropdown-item {% if request.args.get('status') == 'atrasada' %}active{% endif %}" 
                     href="?status=atrasada">
                    <span class="badge bg-danger me-2">üî¥</span> Atrasadas
                    {% if contadores.atrasadas %}
                      <span class="badge bg-danger float-end">{{ contadores.atrasadas }}</span>
                    {% endif %}
                  </a>
                </li>
                <li>
                  <a class="dropdown-item {% if request.args.get('status') == 'sem_previsao' %}active{% endif %}" 
                     href="?status=sem_previsao">
                    <span class="badge bg-warning me-2">üü°</span> Sem Previs√£o
                    {% if contadores.sem_previsao %}
                      <span class="badge bg-warning text-dark float-end">{{ contadores.sem_previsao }}</span>
                    {% endif %}
                  </a>
                </li>
                <li>
                  <a class="dropdown-item {% if request.args.get('status') == 'entregue' %}active{% endif %}" 
                     href="?status=entregue">
                    <span class="badge bg-success me-2">‚úÖ</span> Entregues
                  </a>
                </li>
              </ul>
            </li>

            <!-- üìÖ DROPDOWN: Agendamento -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="dropdownAgendamento" role="button" 
                 data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-calendar-alt"></i> Agendamento
                {% set total_agend = (contadores.sem_agendamento or 0) + (contadores.ag_aprovacao or 0) + (contadores.reagendar or 0) %}
                {% if total_agend > 0 %}
                  <span class="badge bg-warning text-dark rounded-pill">{{ total_agend }}</span>
                {% endif %}
              </a>
              <ul class="dropdown-menu" aria-labelledby="dropdownAgendamento">
                <li>
                  <a class="dropdown-item {% if request.args.get('status') == 'sem_agendamento' %}active{% endif %}" 
                     href="?status=sem_agendamento">
                    <span class="badge bg-warning me-2">‚ö†Ô∏è</span> Agend. Pendente
                    {% if contadores.sem_agendamento %}
                      <span class="badge bg-warning text-dark float-end">{{ contadores.sem_agendamento }}</span>
                    {% endif %}
                  </a>
                </li>
                <li>
                  <a class="dropdown-item {% if request.args.get('status') == 'ag_aprovacao' %}active{% endif %}" 
                     href="?status=ag_aprovacao">
                    <span class="badge bg-info me-2">‚è≥</span> Aguardando Aprova√ß√£o
                    {% if contadores.ag_aprovacao %}
                      <span class="badge bg-info float-end">{{ contadores.ag_aprovacao }}</span>
                    {% endif %}
                  </a>
                </li>
                <li>
                  <a class="dropdown-item {% if request.args.get('status') == 'reagendar' %}active{% endif %}" 
                     href="?status=reagendar">
                    <span class="badge bg-danger me-2">üîÅ</span> Reagendar
                    {% if contadores.reagendar %}
                      <span class="badge bg-danger float-end">{{ contadores.reagendar }}</span>
                    {% endif %}
                  </a>
                </li>
              </ul>
            </li>

            <!-- üìù DROPDOWN: Status Especiais -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="dropdownEspeciais" role="button" 
                 data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-exclamation-circle"></i> Status Especiais
                {% if contadores.nf_cd %}
                  <span class="badge bg-primary rounded-pill">{{ contadores.nf_cd }}</span>
                {% endif %}
              </a>
              <ul class="dropdown-menu" aria-labelledby="dropdownEspeciais">
                <li>
                  <a class="dropdown-item {% if request.args.get('status') == 'com_comentarios' %}active{% endif %}" 
                     href="?status=com_comentarios">
                    <span class="badge bg-info me-2">üí¨</span> Com Coment√°rios
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item {% if request.args.get('status') == 'troca_nf' %}active{% endif %}" 
                     href="?status=troca_nf">
                    <span class="badge bg-info me-2">üîÑ</span> Troca de NF
                  </a>
                </li>
                <li>
                  <a class="dropdown-item {% if request.args.get('status') == 'cancelada' %}active{% endif %}" 
                     href="?status=cancelada">
                    <span class="badge bg-secondary me-2">‚ùå</span> Cancelada
                  </a>
                </li>
                <li>
                  <a class="dropdown-item {% if request.args.get('status') == 'devolvida' %}active{% endif %}" 
                     href="?status=devolvida">
                    <span class="badge bg-warning me-2">üì¶</span> Devolvida
                  </a>
                </li>
                <li>
                  <a class="dropdown-item {% if request.args.get('status') == 'nf_cd' %}active{% endif %}" 
                     href="?status=nf_cd">
                    <span class="badge bg-primary me-2">üè¢</span> NF no CD
                    {% if contadores.nf_cd %}
                      <span class="badge bg-primary float-end">{{ contadores.nf_cd }}</span>
                    {% endif %}
                  </a>
                </li>
              </ul>
            </li>

            <!-- üîç Indicador de Filtro Ativo -->
            {% if request.args.get('status') %}
            <li class="nav-item ms-3">
              <a href="{{ url_for('monitoramento.listar_entregas') }}" 
                 class="nav-link text-danger" title="Limpar filtro">
                <i class="fas fa-times-circle"></i> Limpar
              </a>
            </li>
            {% endif %}

          </ul>
        </div>
      </div>
    </nav>
  </div>
</div>

<!-- ‚úÖ PAGINA√á√ÉO STICKY ULTRA-SIMPLES -->
{% if not agrupar and paginacao and paginacao.pages > 1 %}
{% set args_no_page = request.args.copy() %}
{% if 'page' in args_no_page %}
  {% set _ = args_no_page.pop('page') %}
{% endif %}

<div id="sticky-pagination" class="sticky-pagination-simple">
  <div class="container-fluid">
    <div class="row align-items-center py-1">
      <div class="col-md-8">
        <nav>
          <ul class="pagination pagination-sm mb-0">
            <!-- Primeira p√°gina -->
            <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('monitoramento.listar_entregas', page=1, **args_no_page) }}">
                <i class="fas fa-angle-double-left"></i> Primeira
              </a>
            </li>

            <!-- Anterior -->
            <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('monitoramento.listar_entregas', page=paginacao.prev_num, **args_no_page) }}">
                <i class="fas fa-angle-left"></i> Anterior
              </a>
            </li>

            <!-- P√°ginas ao redor -->
            {% for p in range(paginacao.page - 2, paginacao.page + 3) if p > 0 and p <= paginacao.pages %}
              <li class="page-item {% if p == paginacao.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('monitoramento.listar_entregas', page=p, **args_no_page) }}">
                  {{ p }}
                </a>
              </li>
            {% endfor %}

            <!-- Pr√≥xima -->
            <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('monitoramento.listar_entregas', page=paginacao.next_num, **args_no_page) }}">
                Pr√≥xima <i class="fas fa-angle-right"></i>
              </a>
            </li>

            <!-- √öltima -->
            <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('monitoramento.listar_entregas', page=paginacao.pages, **args_no_page) }}">
                √öltima <i class="fas fa-angle-double-right"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
      
      <!-- ‚ú® INFORMA√á√ïES R√ÅPIDAS -->
      <div class="col-md-4 text-end">
        <div class="d-flex flex-column">
          <small class="text-muted">
            <i class="fas fa-list"></i>
            Registros <strong>{{ (paginacao.page - 1) * paginacao.per_page + 1 }}‚Äì{{ (paginacao.page - 1) * paginacao.per_page + paginacao.items|length }}</strong>
            de <strong>{{ paginacao.total }}</strong>
            <i class="fas fa-file-alt"></i> 
            P√°gina <strong>{{ paginacao.page }}</strong> de <strong>{{ paginacao.pages }}</strong>
          </small>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- TABELA -->
<div class="container-fluid mt-1 pagination-offset">

  <!-- Exemplo: barra de rolagem horizontal -->
  <div class="table-responsive">
  {% if agrupar %}
      <!-- Modo Acorde√£o (agrupar por status) -->
    <div class="accordion" id="accordionEntregas">
      {% for status, grupo in entregas_agrupadas.items() %}
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#grupo{{ loop.index }}">
            {{ status }} ({{ grupo|length }})
          </button>
        </h2>
        <div id="grupo{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionEntregas">
          <div class="accordion-body p-0">
            <table class="table table-hover table-bordered m-0">
              {% set current_sort = request.args.get('sort', '') %}
              {% set current_dir = request.args.get('direction', 'asc') %}

              <thead>
                <tr>
                  <!-- NF -->
                  <th>
                    {% if current_sort == 'numero_nf' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=numero_nf&direction={{ next_dir }}">NF</a>
                  </th>

                  <!-- CNPJ -->
                  <th>
                    {% if current_sort == 'cnpj_cliente' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=cnpj_cliente&direction={{ next_dir }}">CNPJ</a>
                  </th>

                  <!-- Cliente -->
                  <th>
                    {% if current_sort == 'cliente' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=cliente&direction={{ next_dir }}">Cliente</a>
                  </th>

                  <!-- Transportadora -->
                  <th>
                    {% if current_sort == 'transportadora' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=transportadora&direction={{ next_dir }}">Transportadora</a>
                  </th>

                  <!-- UF -->
                  <th>
                    {% if current_sort == 'uf' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=uf&direction={{ next_dir }}">UF</a>
                  </th>
                  
                  <!-- Munic√≠pio -->
                  <th>
                    {% if current_sort == 'municipio' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=municipio&direction={{ next_dir }}">Munic√≠pio</a>
                  </th>

                  <!-- Faturamento -->
                  <th>
                    {% if current_sort == 'data_faturamento' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=data_faturamento&direction={{ next_dir }}">Faturamento</a>
                  </th>

                  <!-- Embarque -->
                  <th>
                    {% if current_sort == 'data_embarque' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=data_embarque&direction={{ next_dir }}">Embarque</a>
                  </th>

                  <!-- Agendamento -->
                  <th>
                    <!-- Se voc√™ tiver um campo "data_agendamento" no model ou algo similar -->
                    {% if current_sort == 'data_agendamento' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=data_agendamento&direction={{ next_dir }}">Agendamento</a>
                  </th>

                  <!-- Prevista -->
                  <th>
                    {% if current_sort == 'data_entrega_prevista' and current_dir == 'asc' %}
                      {% set next_dir = 'desc' %}
                    {% else %}
                      {% set next_dir = 'asc' %}
                    {% endif %}
                    <a href="?sort=data_entrega_prevista&direction={{ next_dir }}">Prevista</a>
                  </th>

                  <!-- Status -->
                  <th>Status</th>
                  <!-- Alertas -->
                  <th>Alertas</th>
                  <!-- A√ß√µes -->
                  <th>A√ß√µes</th>
                </tr>
              </thead>

              <tbody>
                {% for e in grupo %}
                <tr>
                  <td>
                    <small class="text-muted">{{ e.num_pedido or 'N/A' }}</small><br>
                    {{ e.numero_nf }}<br>
                    <small class="text-muted">{{ 'R$ {:,.2f}'.format(e.valor_nf).replace(',', 'X').replace('.', ',').replace('X', '.') if e.valor_nf else 'N/A' }}</small>
                  </td>
                  <td>{{ e.cnpj_cliente }}</td>
                  <td>
                    {{ e.cliente }}<br>
                    <small class="text-muted">üë§ {{ e.vendedor or 'N√£o informado' }}</small>
                  </td>
                  <td>
                    {% if e.incoterm or e.modalidade %}
                      <small class="text-muted">{{ e.incoterm or '' }}{% if e.incoterm and e.modalidade %} - {% endif %}{{ e.modalidade or '' }}</small><br>
                    {% endif %}
                    {{ e.transportadora }}
                  </td>
                  <td>{{ e.uf }}</td>
                  <td>{{ e.municipio }}</td>
                  <td>{{ e.data_faturamento | formatar_data_segura if e.data_faturamento else '-' }}</td>
                  <td>{{ e.data_embarque | formatar_data_segura if e.data_embarque else '-' }}</td>
                                     <td>
                     {% if e.data_agenda %}
                       {% set ultimo_agendamento = e.agendamentos | sort(attribute='criado_em') | last if e.agendamentos else None %}
                       {% if ultimo_agendamento and ultimo_agendamento.status == 'confirmado' %}
                         <button class="btn btn-sm btn-primary w-100 text-white" onclick="agendarEntrega('{{ e.id }}', '{{ e.numero_nf }}')">
                           üìÖ {{ e.data_agenda | formatar_data_segura }}
                           {% if ultimo_agendamento.protocolo_agendamento %}
                             <br><small>üìã {{ ultimo_agendamento.protocolo_agendamento }}</small>
                           {% endif %}
                           <br><small>‚úÖ Confirmado</small>
                         </button>
                       {% else %}
                         <div class="d-flex align-items-center gap-1">
                           <button class="btn btn-sm btn-warning flex-grow-1" onclick="agendarEntrega('{{ e.id }}', '{{ e.numero_nf }}')">
                             üìÖ {{ e.data_agenda | formatar_data_segura }}
                             {% if ultimo_agendamento and ultimo_agendamento.protocolo_agendamento %}
                               <br><small>üìã {{ ultimo_agendamento.protocolo_agendamento }}</small>
                             {% endif %}
                             <br><small>‚è≥ Aguardando</small>
                           </button>
                           {% if ultimo_agendamento and ultimo_agendamento.status == 'aguardando' %}
                             <button class="btn btn-sm btn-success" onclick="confirmarAgendamento('{{ ultimo_agendamento.id }}')">
                               ‚úÖ
                             </button>
                           {% endif %}
                         </div>
                       {% endif %}
                     {% else %}
                       <button class="btn btn-sm btn-warning w-100" onclick="agendarEntrega('{{ e.id }}', '{{ e.numero_nf }}')">
                         ‚ûï Agendar
                       </button>
                     {% endif %}
                   </td>
                                     <td>
                     {% if e.data_entrega_prevista %}
                       <button class="btn btn-sm btn-primary w-100 text-white" onclick="alterarDataPrevista('{{ e.id }}', '{{ e.numero_nf }}', '{{ e.data_entrega_prevista }}')">
                         üìÖ {{ e.data_entrega_prevista | formatar_data_segura }}
                       </button>
                     {% else %}
                       <button class="btn btn-sm btn-warning w-100" onclick="alterarDataPrevista('{{ e.id }}', '{{ e.numero_nf }}', '')">
                         ‚ûï Definir Data
                       </button>
                     {% endif %}
                   </td>
                  <td>
                    {% if e.entregue and e.data_hora_entrega_realizada %}
                      <span class="badge bg-success entregue-popup"
                            data-entrega="{{ e.data_hora_entrega_realizada | formatar_data_hora_brasil }}">
                        Entregue
                      </span>
                    {% elif e.entregue %}
                      <span class="badge bg-success">Entregue</span>
                    {% elif e.data_entrega_prevista and e.data_entrega_prevista < current_date %}
                      <span class="badge bg-danger">Atrasada</span>
                    {% elif e.data_entrega_prevista %}
                      <span class="badge bg-light text-dark">No Prazo</span>
                    {% else %}
                      <span class="badge bg-secondary">Sem Previs√£o</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="d-flex flex-column gap-1">
                      {% set pendencias_abertas = [] %}
                      {% for p in e.pendencias_financeiras %}
                        {% if not p.respondida_em or p.resposta_excluida_em %}
                          {% set _ = pendencias_abertas.append(p) %}
                        {% endif %}
                      {% endfor %}
                      {% if pendencias_abertas %}
                        {% set pendencia = pendencias_abertas[0] %}
                        <button class="btn btn-sm btn-danger pendencia-btn"
                                data-nf="{{ e.numero_nf }}"
                                data-observacao="{{ pendencia.observacao }}">
                          Pend. Financ.
                        </button>
                      {% endif %}
                      
                      {# ‚úÖ CORRIGIDO: Verificar agendamento pendente com CNPJ limpo #}
                      {% set cnpj_limpo = e.cnpj_cliente.replace('.', '').replace('-', '').replace('/', '') if e.cnpj_cliente else '' %}
                      {% set contato = contatos_agendamento.get(cnpj_limpo) or contatos_agendamento.get(e.cnpj_cliente) %}
                      {% if contato and e.agendamentos|length == 0 and contato.forma and contato.forma != '' and contato.forma != 'SEM AGENDAMENTO' and not e.status_finalizacao %}
                        <span class="badge bg-danger">‚ö†Ô∏è Agend. Pendente</span>
                      {% endif %}
                      
                      {% if e.reagendar %}
                        <span class="badge bg-danger">üîÅ Reagendar</span>
                      {% endif %}
                      
                      {% if e.possui_comentarios %}
                        <span class="badge bg-info">üí¨ Coment√°rios</span>
                      {% endif %}
                    </div>
                  </td>
                  <td class="d-flex flex-nowrap align-items-center gap-2">
                    <a href="{{ url_for('monitoramento.visualizar_entrega', id=e.id, **request.args) }}"
                       class="btn btn-sm btn-outline-primary">
                      Info
                    </a>
                    <form method="post" action="{{ url_for('monitoramento.toggle_reagendar', id=e.id, **request.args) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      {% if e.reagendar %}
                        <button class="btn btn-sm btn-outline-danger reagendar-btn">
                          <span class="text-curto">Reagenda</span>
                          <span class="text-completo">Cancelar</span>
                        </button>
                      {% else %}
                        <button class="btn btn-sm btn-outline-warning reagendar-btn">
                          <span class="text-curto">Reagenda</span>
                          <span class="text-completo">Marcar</span>
                        </button>
                      {% endif %}
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            </div>
          </div>
        </div>
        {% endfor %}
      </div>

  {% else %}
     <!-- SE N√ÉO AGRUPAR, tabela normal -->

      <table class="table table-hover table-bordered align-middle">

      {% set current_sort = request.args.get('sort', '') %}
      {% set current_dir = request.args.get('direction', 'asc') %}

      <thead>
        <tr>
          <!-- NF -->
          <th class="sticky-col">
            {% if current_sort == 'numero_nf' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            {% set url_params = request.args.copy() %}
            {% set _ = url_params.update({'sort': 'numero_nf', 'direction': next_dir}) %}
            <a href="?{{ url_params | urlencode }}">NF</a>
          </th>

          <!-- Cliente -->
          <th class="sticky-col-2">
            {% if current_sort == 'cliente' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            <a href="?sort=cliente&direction={{ next_dir }}">Cliente</a>
          </th>

          <!-- Transportadora -->
          <th>
            {% if current_sort == 'transportadora' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            <a href="?sort=transportadora&direction={{ next_dir }}">Transportadora</a>
          </th>

          <!-- Faturamento -->
          <th>
            {% if current_sort == 'data_faturamento' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            <a href="?sort=data_faturamento&direction={{ next_dir }}">Faturamento</a>
          </th>

          <!-- Embarque -->
          <th>
            {% if current_sort == 'data_embarque' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            <a href="?sort=data_embarque&direction={{ next_dir }}">Embarque</a>
          </th>

          <!-- Agendamento -->
          <th>
            <!-- Se voc√™ tiver um campo "data_agendamento" no model ou algo similar -->
            {% if current_sort == 'data_agenda' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            <a href="?sort=data_agenda&direction={{ next_dir }}">Agendamento</a>
          </th>

          <!-- Prevista -->
          <th>
            {% if current_sort == 'data_entrega_prevista' and current_dir == 'asc' %}
              {% set next_dir = 'desc' %}
            {% else %}
              {% set next_dir = 'asc' %}
            {% endif %}
            <a href="?sort=data_entrega_prevista&direction={{ next_dir }}">Prevista</a>
          </th>

          <!-- Status -->
          <th>Status</th>
          <!-- Alertas -->
          <th>Alertas</th>
          <!-- A√ß√µes -->
          <th>A√ß√µes</th>
        </tr>
      </thead>

      <tbody>
        {% for e in entregas %}
        <tr>
          <td class="sticky-col">
            {% if e.comentarios_pendentes(current_user.nome) > 0 %}
              <span class="badge bg-info" style="cursor:pointer;">
                üí¨ {{ e.comentarios_pendentes(current_user.nome) }}
              </span>
            {% endif %}
            <small class="text-muted">{{ e.num_pedido or 'N/A' }}</small><br>
            {{ e.numero_nf }}<br>
            <small class="text-muted">{{ 'R$ {:,.2f}'.format(e.valor_nf).replace(',', 'X').replace('.', ',').replace('X', '.') if e.valor_nf else 'N/A' }}</small>
          </td>
          <td class="sticky-col-2">
            <small class="text-muted">{{ e.cnpj_cliente }}</small><br>
            {{ e.cliente }}<br>
            <small class="text-muted">üë§ {{ e.vendedor or 'N√£o informado' }}</small>
          </td>
          <td>
            {% if e.incoterm or e.modalidade %}
              <small class="text-muted">{{ e.incoterm or '' }}{% if e.incoterm and e.modalidade %} - {% endif %}{{ e.modalidade or '' }}</small><br>
            {% endif %}
            {{ e.transportadora }}<br>
            <small class="text-muted">{{ e.uf }} - {{ e.municipio }}</small>
          </td>
          <td>{{ e.data_faturamento | formatar_data_segura if e.data_faturamento else '-' }}</td>
          <td>{{ e.data_embarque | formatar_data_segura if e.data_embarque else '-' }}</td>
          <td>
            {% if e.data_agenda %}
              {% set ultimo_agendamento = e.agendamentos | sort(attribute='criado_em') | last if e.agendamentos else None %}
              {% if ultimo_agendamento and ultimo_agendamento.status == 'confirmado' %}
                <button class="btn btn-sm btn-primary w-100 text-white" onclick="agendarEntrega('{{ e.id }}', '{{ e.numero_nf }}')">
                  üìÖ {{ e.data_agenda | formatar_data_segura }}
                  {% if ultimo_agendamento.protocolo_agendamento %}
                    <br><small>üìã {{ ultimo_agendamento.protocolo_agendamento }}</small>
                  {% endif %}
                  <br><small>‚úÖ Confirmado</small>
                </button>
              {% else %}
                <div class="d-flex align-items-center gap-1">
                  <button class="btn btn-sm btn-warning flex-grow-1" onclick="agendarEntrega('{{ e.id }}', '{{ e.numero_nf }}')">
                    üìÖ {{ e.data_agenda | formatar_data_segura }}
                    {% if ultimo_agendamento and ultimo_agendamento.protocolo_agendamento %}
                      <br><small>üìã {{ ultimo_agendamento.protocolo_agendamento }}</small>
                    {% endif %}
                    <br><small>‚è≥ Aguardando</small>
                  </button>
                  {% if ultimo_agendamento and ultimo_agendamento.status == 'aguardando' %}
                    <button class="btn btn-sm btn-success" onclick="confirmarAgendamento('{{ ultimo_agendamento.id }}')">
                      ‚úÖ
                    </button>
                  {% endif %}
                </div>
              {% endif %}
            {% else %}
              <button class="btn btn-sm btn-warning w-100" onclick="agendarEntrega('{{ e.id }}', '{{ e.numero_nf }}')">
                ‚ûï Agendar
              </button>
            {% endif %}
          </td>
          <td>
            {% if e.data_entrega_prevista %}
              <button class="btn btn-sm btn-primary w-100 text-white" onclick="alterarDataPrevista('{{ e.id }}', '{{ e.numero_nf }}', '{{ e.data_entrega_prevista }}')">
                üìÖ {{ e.data_entrega_prevista | formatar_data_segura }}
              </button>
            {% else %}
              <button class="btn btn-sm btn-warning w-100" onclick="alterarDataPrevista('{{ e.id }}', '{{ e.numero_nf }}', '')">
                ‚ûï Definir Data
              </button>
            {% endif %}
          </td>
          <td>
            {% if e.nf_cd %}
                <span class="badge bg-info">NF no CD</span>

            {% elif e.status_finalizacao == "Troca de NF" and e.nova_nf %}
                <a href="?numero_nf={{ e.nova_nf }}" class="btn btn-sm btn-info">
                  Nova NF {{ e.nova_nf }}
                </a>
            {% elif e.status_finalizacao == "Entregue" %}
            <span class="badge bg-success entregue-popup" 
                  data-entrega={{ e.data_hora_entrega_realizada | formatar_data_hora_brasil if e.data_hora_entrega_realizada else '-' }}
                  style="cursor:pointer;"
                  tabindex="0">
              Entregue
              </span>
              
              <!-- üìÑ STATUS/BOT√ÉO DO CANHOTO -->
              <div class="mt-1">
                {% if e.possui_canhoto %}
                  <a href="{{ url_for('monitoramento.visualizar_canhoto', id=e.id) }}" 
                     class="badge bg-success text-decoration-none" 
                     title="Visualizar canhoto anexado"
                     target="_blank">
                    üìÑ Canhoto OK
                  </a>
                {% else %}
                  <span class="badge bg-light text-dark upload-canhoto-btn" 
                        data-entrega-id="{{ e.id }}"
                        data-numero-nf="{{ e.numero_nf }}"
                        title="Anexar canhoto da entrega"
                        style="cursor: pointer;">
                    üìÑ S/ canhoto
                  </span>
                {% endif %}
              </div>
            {% elif e.status_finalizacao %}
                <span class="badge bg-dark">{{ e.status_finalizacao }}</span>
            {% elif e.data_entrega_prevista and e.data_entrega_prevista < current_date %}
                <span class="badge bg-danger">Atrasada</span>
            {% elif e.data_entrega_prevista %}
            <span class="badge bg-light text-dark">No Prazo</span>
            {% else %}
              <span class="badge bg-warning text-dark">Sem Previs√£o</span>
            {% endif %}
            </td>
            
          <td>
            <div class="d-flex flex-column gap-1">
              {% set pendencias_abertas = [] %}
              {% for p in e.pendencias_financeiras %}
                {% if not p.respondida_em or p.resposta_excluida_em %}
                  {% set _ = pendencias_abertas.append(p) %}
                {% endif %}
              {% endfor %}
              {% if pendencias_abertas %}
                {% set pendencia = pendencias_abertas[0] %}
                <button class="btn btn-sm btn-danger pendencia-btn"
                        data-nf="{{ e.numero_nf }}"
                        data-observacao="{{ pendencia.observacao }}">
                  Pend. Financ.
                </button>
              {% endif %}
              
              {# ‚úÖ CORRIGIDO: Verificar agendamento pendente com CNPJ limpo #}
              {% set cnpj_limpo = e.cnpj_cliente.replace('.', '').replace('-', '').replace('/', '') if e.cnpj_cliente else '' %}
              {% set contato = contatos_agendamento.get(cnpj_limpo) or contatos_agendamento.get(e.cnpj_cliente) %}
              {% if contato and e.agendamentos|length == 0 and contato.forma and contato.forma != '' and contato.forma != 'SEM AGENDAMENTO' and not e.status_finalizacao %}
                <span class="badge bg-danger">‚ö†Ô∏è Agend. Pendente</span>
              {% endif %}
              
              {% if e.reagendar %}
                <span class="badge bg-danger">üîÅ Reagendar</span>
              {% endif %}
              
              {% if e.possui_comentarios %}
                <span class="badge bg-info">üí¨ Coment√°rios</span>
              {% endif %}
            </div>
          </td>
          <td class="d-flex flex-nowrap align-items-center gap-2">
            <a href="{{ url_for('monitoramento.visualizar_entrega', id=e.id, **request.args) }}"
               class="btn btn-sm btn-outline-primary">
               Info
            </a>
            <form method="post" action="{{ url_for('monitoramento.toggle_reagendar', id=e.id, **request.args) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              {% if e.reagendar %}
                <button class="btn btn-sm btn-outline-danger reagendar-btn">
                  <span class="text-curto">Reagenda</span>
                  <span class="text-completo">Cancelar</span>
                </button>
              {% else %}
                <button class="btn btn-sm btn-outline-warning reagendar-btn">
                  <span class="text-curto">Reagenda</span>
                  <span class="text-completo">Marcar</span>
                </button>
              {% endif %}
            </form>
          </td>
        </tr>
        {% endfor %}

      </tbody>
    </table>
  {% endif %}
</div>








<!-- ===========================
     MODAL PARA PEND√äNCIA FINANCEIRA
     =========================== -->
<div class="modal fade" id="pendenciaModal" tabindex="-1" aria-labelledby="pendenciaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      
      <!-- Cabe√ßalho do Modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="pendenciaModalLabel">Pend√™ncia Financeira</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Corpo do Modal -->
      <div class="modal-body">
        <p>
          <strong>NF:</strong>
          <span id="nf-modal"></span>
        </p>
        <p>
          <strong>Observa√ß√£o Financeiro:</strong><br>
          <span id="observacao-modal"></span>
        </p>
        <div class="mb-3">
          <textarea id="resposta-logistica" class="form-control" rows="5" placeholder="Resposta Log√≠stica"></textarea>
        </div>
      </div>

      <!-- Rodap√© do Modal -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmar-resposta">
          Confirmar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     MODAL PARA ALTERAR DATA PREVISTA
     =========================== -->
<div class="modal fade" id="dataPrevistaModal" tabindex="-1" aria-labelledby="dataPrevistaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      
      <!-- Cabe√ßalho do Modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="dataPrevistaModalLabel">üìÖ Alterar Data de Entrega Prevista</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Corpo do Modal -->
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>NF:</strong> <span id="nf-data-modal"></span></p>
            
            <form id="form-data-prevista">
              <div class="mb-3">
                <label for="nova-data-prevista" class="form-label">Nova Data de Entrega Prevista</label>
                <input type="date" id="nova-data-prevista" class="form-control" required>
              </div>
              
              <div class="mb-3">
                <label for="motivo-alteracao" class="form-label">Motivo da Altera√ß√£o</label>
                <textarea id="motivo-alteracao" class="form-control" rows="3" placeholder="Descreva o motivo da altera√ß√£o..." required></textarea>
              </div>
            </form>
          </div>
          
          <div class="col-md-6">
            <h6>üìã Hist√≥rico de Altera√ß√µes</h6>
            <div id="historico-data-prevista" class="border p-2" style="height: 200px; overflow-y: auto;">
              <div class="text-center text-muted">
                <i class="fas fa-spinner fa-spin"></i> Carregando hist√≥rico...
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Rodap√© do Modal -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmar-data-prevista">
          üíæ Salvar Altera√ß√£o
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     MODAL PARA UPLOAD DE CANHOTO
     =========================== -->
<div class="modal fade" id="canhotoModal" tabindex="-1" aria-labelledby="canhotoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      
      <!-- Cabe√ßalho do Modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="canhotoModalLabel">üìÑ Anexar Canhoto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Corpo do Modal -->
      <div class="modal-body">
        <p>
          <strong>NF:</strong>
          <span id="nf-canhoto-modal"></span>
        </p>
        
        <form id="form-upload-canhoto" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="arquivo-canhoto" class="form-label">Arquivo do Canhoto</label>
            <input type="file" 
                   class="form-control" 
                   id="arquivo-canhoto" 
                   name="canhoto" 
                   accept=".jpg,.jpeg,.png,.pdf"
                   required>
            <div class="form-text">
              Formatos aceitos: JPG, PNG, PDF (m√°x. 10MB)
            </div>
          </div>
          
          <!-- Preview do arquivo selecionado -->
          <div id="preview-canhoto" class="mt-2" style="display: none;">
            <div class="alert alert-info">
              <strong>Arquivo selecionado:</strong> <span id="nome-arquivo-canhoto"></span>
              <br>
              <small>Tamanho: <span id="tamanho-arquivo-canhoto"></span></small>
            </div>
          </div>
        </form>
      </div>

      <!-- Rodap√© do Modal -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmar-upload-canhoto">
          üìÑ Anexar Canhoto
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     MODAL PARA AGENDAMENTO R√ÅPIDO
     =========================== -->
<div class="modal fade" id="agendamentoModal" tabindex="-1" aria-labelledby="agendamentoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      
      <!-- Cabe√ßalho do Modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="agendamentoModalLabel">üìÖ Agendamento R√°pido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Corpo do Modal -->
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>NF:</strong> <span id="nf-agendamento-modal"></span></p>
            <p><strong>Cliente:</strong> <span id="cliente-agendamento-modal"></span></p>
            <p><strong>CNPJ:</strong> <span id="cnpj-agendamento-modal"></span></p>
            
            <!-- Bot√µes de Portal (aparece apenas para clientes com portal) -->
            <div id="botoes-portal" style="display: none;" class="mb-3">
              <div class="alert alert-info">
                <strong>üåê Portal Dispon√≠vel:</strong> <span id="nome-portal"></span>
              </div>
              <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary" id="btn-agendar-portal">
                  üìÖ Agendar no Portal
                </button>
                <button type="button" class="btn btn-info" id="btn-verificar-protocolo">
                  üîç Verificar Protocolo no Portal
                </button>
              </div>
              <hr>
            </div>
            
            <!-- Mensagem para portais n√£o dispon√≠veis -->
            <div id="portal-indisponivel" style="display: none;" class="mb-3">
              <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Portal n√£o dispon√≠vel:</strong> <span id="mensagem-portal"></span>
              </div>
            </div>
            
            <form id="form-agendamento-rapido">
              <div class="row">
                <div class="col-md-6">
                  <label for="data-agendada" class="form-label">Data Agendada</label>
                  <input type="date" id="data-agendada" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label for="hora-agendada" class="form-label">Hora Agendada</label>
                  <input type="time" id="hora-agendada" class="form-control">
                </div>
              </div>
              
              <div class="row mt-3">
                <div class="col-md-6">
                  <label for="forma-agendamento" class="form-label">Forma</label>
                  <select id="forma-agendamento" class="form-select">
                    <option value="">Selecione...</option>
                    <option value="Portal">Portal</option>
                    <option value="Telefone">Telefone</option>
                    <option value="E-mail">E-mail</option>
                    <option value="WhatsApp">WhatsApp</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="protocolo-agendamento" class="form-label">Protocolo</label>
                  <input type="text" id="protocolo-agendamento" class="form-control" placeholder="Protocolo (opcional)...">
                </div>
              </div>
              
              <div class="mt-3">
                <label for="motivo-agendamento" class="form-label">Motivo</label>
                <textarea id="motivo-agendamento" class="form-control" rows="3" placeholder="Motivo do agendamento..."></textarea>
              </div>
              
              <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" id="criar-confirmado">
                <label class="form-check-label" for="criar-confirmado">
                  ‚úÖ Criar agenda j√° confirmada
                </label>
              </div>
            </form>
            
            <!-- √Årea de confirma√ß√£o do √∫ltimo agendamento -->
            <div id="confirmar-ultimo-agendamento" class="mt-3" style="display: none;">
              <hr>
              <h6>üéØ Confirmar √öltimo Agendamento</h6>
              <div id="detalhes-ultimo-agendamento"></div>
              <div class="mt-2">
                <label for="observacoes-confirmacao" class="form-label">Observa√ß√µes da Confirma√ß√£o</label>
                <textarea id="observacoes-confirmacao" class="form-control" rows="2" placeholder="Observa√ß√µes sobre a confirma√ß√£o..."></textarea>
              </div>
              <button type="button" class="btn btn-success btn-sm mt-2" id="btn-confirmar-ultimo">
                ‚úÖ Confirmar Agendamento
              </button>
            </div>
          </div>
          
          <div class="col-md-6">
            <h6>üìã Hist√≥rico de Agendamentos</h6>
            <div id="historico-agendamentos" class="border p-2" style="height: 400px; overflow-y: auto;">
              <div class="text-center text-muted">
                <i class="fas fa-spinner fa-spin"></i> Carregando hist√≥rico...
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Rodap√© do Modal -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmar-agendamento">
          üìÖ Criar Agendamento
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- ‚úÖ SCRIPT B√ÅSICO -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ===========================
  // PRESERVAR FILTROS NOS LINKS DE ORDENA√á√ÉO
  // ===========================
  const currentUrl = new URL(window.location);
  
  // Para todos os links de ordena√ß√£o na tabela
  document.querySelectorAll('th a').forEach(link => {
    const linkUrl = new URL(link.href, window.location.origin);
    
    // Preserva todos os par√¢metros atuais exceto sort e direction
    currentUrl.searchParams.forEach((value, key) => {
      if (key !== 'sort' && key !== 'direction' && key !== 'page') {
        linkUrl.searchParams.set(key, value);
      }
    });
    
    // Atualiza o href do link
    link.href = linkUrl.toString();
  });
  
  const stickyPagination = document.getElementById('sticky-pagination');
  
  if (stickyPagination) {
    // üîß FOR√áA estilos para garantir que sticky funcione
    stickyPagination.style.setProperty('position', 'sticky', 'important');
    stickyPagination.style.setProperty('top', '0px', 'important');
    stickyPagination.style.setProperty('z-index', '104', 'important');
    stickyPagination.style.setProperty('background', '#ffffff', 'important');
    
    // For√ßa o parent a ter overflow visible
    let parent = stickyPagination.parentElement;
    while (parent && parent !== document.body) {
      parent.style.setProperty('overflow', 'visible', 'important');
      parent = parent.parentElement;
    }
    
    // Observer para detectar quando a pagina√ß√£o est√° grudada (sem logs)
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.intersectionRatio < 1) {
          // Pagina√ß√£o est√° grudada (n√£o completamente vis√≠vel)
          stickyPagination.classList.add('stuck');
        } else {
          // Pagina√ß√£o est√° solta (completamente vis√≠vel)
          stickyPagination.classList.remove('stuck');
        }
      },
      { threshold: 1 } // Detecta quando 100% do elemento est√° vis√≠vel
    );
    
    observer.observe(stickyPagination);
  }
  });

  // ===========================
  // AUTO SUBMIT PARA CAMPOS DE DATA (APENAS FILTROS)
  // ===========================
  
  // Seleciona APENAS os campos de data do formul√°rio de filtros (n√£o dos modais)
  const camposDataFiltros = document.querySelectorAll('#form-filtros input[type="date"]');
  
  // Fun√ß√£o para auto submit
  function autoSubmitFiltros() {
    // Encontra o formul√°rio pai
    const form = this.closest('form');
    if (form && form.id === 'form-filtros') {
      form.submit();
    }
  }
  
  // Adiciona auto submit APENAS para os campos de filtro
  camposDataFiltros.forEach(campo => {
    campo.addEventListener('change', autoSubmitFiltros);
  });
</script>
<!-- ===========================
     SCRIPTS ESPEC√çFICOS
     =========================== -->

<!-- Exemplo de popover para 'Entregue' (n√£o tem a ver com o modal) -->
<script>
  document.querySelectorAll('.entregue-popup').forEach(item => {
  item.style.cursor = 'pointer';
  item.addEventListener('click', function(event) {
    const dataEntrega = event.target.getAttribute('data-entrega');

    // Se j√° existir um popover aberto, "dispose" para fechar
    if (window.currentPopover) {
      window.currentPopover.dispose();
    }

    // Instancia o popover, mas agora com container: 'body'
    window.currentPopover = new bootstrap.Popover(event.target, {
      container: 'body',                  // importante para n√£o "cortar" dentro de div com overflow
      content: 'Entregue em: ' + dataEntrega,
      placement: 'top',
      trigger: 'focus'
    });
    window.currentPopover.show();
  });
});

</script>

<script>
  // 1. Pega o token CSRF do <meta name="csrf-token">
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  // 2. Instancia os modais do Bootstrap (uma vez s√≥)
  const pendenciaModal = new bootstrap.Modal(document.getElementById('pendenciaModal'));
  const agendamentoModal = new bootstrap.Modal(document.getElementById('agendamentoModal'), {
    backdrop: 'static',  // Impede fechamento ao clicar fora
    keyboard: true       // Permite Esc para fechar
  });
  const dataPrevistaModal = new bootstrap.Modal(document.getElementById('dataPrevistaModal'), {
    backdrop: 'static',  // Impede fechamento ao clicar fora
    keyboard: true       // Permite Esc para fechar
  });
  const canhotoModal = new bootstrap.Modal(document.getElementById('canhotoModal'), {
    backdrop: 'static',  // Impede fechamento ao clicar fora
    keyboard: true       // Permite Esc para fechar
  });

  // Event listeners para melhorar UX dos modais
  document.getElementById('agendamentoModal').addEventListener('shown.bs.modal', function () {
    // Foca no primeiro campo quando modal abrir
    document.getElementById('data-agendada').focus();
  });

  document.getElementById('dataPrevistaModal').addEventListener('shown.bs.modal', function () {
    // Foca no campo de data quando modal abrir
    document.getElementById('nova-data-prevista').focus();
  });

  document.getElementById('canhotoModal').addEventListener('shown.bs.modal', function () {
    // Foca no campo de arquivo quando modal abrir
    document.getElementById('arquivo-canhoto').focus();
  });

  // Ao clicar no bot√£o .pendencia-btn, abrimos o modal
  document.querySelectorAll('.pendencia-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const nf = this.dataset.nf;
      const observacao = this.dataset.observacao;

      // Preenche campos do modal
      document.getElementById('nf-modal').textContent = nf;
      document.getElementById('observacao-modal').textContent = observacao;
      document.getElementById('resposta-logistica').value = '';

      // Armazena a NF no bot√£o "Confirmar"
      document.getElementById('confirmar-resposta').setAttribute('data-nf', nf);

      // Abre o modal
      pendenciaModal.show();
    });
  });

  // Ao clicar no bot√£o Confirmar do modal
  document.getElementById('confirmar-resposta').addEventListener('click', function() {
    const nf = this.getAttribute('data-nf');
    const resposta = document.getElementById('resposta-logistica').value;

    fetch(`/financeiro/pendencias/${nf}/responder`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({ resposta: resposta })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        alert('Resposta salva com sucesso!');
        pendenciaModal.hide();
        location.reload();
      } else {
        alert('Erro ao salvar resposta.');
      }
    })
    .catch(err => {
      console.error("Erro no modal de pend√™ncias:", err);
      alert("Erro na requisi√ß√£o ao servidor.");
    });
  });

  // ===========================
  // FUNCIONALIDADE DE UPLOAD DE CANHOTO
  // ===========================
  
  // Event listener para bot√µes de upload de canhoto
  document.querySelectorAll('.upload-canhoto-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const entregaId = this.dataset.entregaId;
      const numeroNf = this.dataset.numeroNf;
      
      // Preenche campos do modal
      document.getElementById('nf-canhoto-modal').textContent = numeroNf;
      document.getElementById('confirmar-upload-canhoto').setAttribute('data-entrega-id', entregaId);
      
      // Limpa formul√°rio
      document.getElementById('form-upload-canhoto').reset();
      document.getElementById('preview-canhoto').style.display = 'none';
      
      // Abre o modal
      canhotoModal.show();
    });
  });
  
  // Preview do arquivo selecionado
  document.getElementById('arquivo-canhoto').addEventListener('change', function() {
    const file = this.files[0];
    const previewDiv = document.getElementById('preview-canhoto');
    
    if (file) {
      document.getElementById('nome-arquivo-canhoto').textContent = file.name;
      document.getElementById('tamanho-arquivo-canhoto').textContent = (file.size / 1024).toFixed(1) + ' KB';
      previewDiv.style.display = 'block';
    } else {
      previewDiv.style.display = 'none';
    }
  });
  
  // Confirmar upload do canhoto
  document.getElementById('confirmar-upload-canhoto').addEventListener('click', function() {
    const entregaId = this.getAttribute('data-entrega-id');
    const fileInput = document.getElementById('arquivo-canhoto');
    const file = fileInput.files[0];
    
    if (!file) {
      alert('Por favor, selecione um arquivo.');
      return;
    }
    
    // Validar tamanho (m√°x 10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('Arquivo muito grande. O tamanho m√°ximo √© 10MB.');
      return;
    }
    
    // Validar extens√£o
    const extensao = file.name.split('.').pop().toLowerCase();
    if (!['jpg', 'jpeg', 'png', 'pdf'].includes(extensao)) {
      alert('Formato n√£o permitido. Use apenas JPG, PNG ou PDF.');
      return;
    }
    
    // Criar FormData para envio
    const formData = new FormData();
    formData.append('canhoto', file);
    
    // Desabilita bot√£o durante upload
    const btn = this;
    const textOriginal = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    btn.disabled = true;
    
    // Enviar arquivo
    fetch(`/monitoramento/${entregaId}/upload_canhoto`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        canhotoModal.hide();
        location.reload(); // Recarrega para mostrar o novo status
      } else {
        alert('Erro: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Erro no upload:', error);
      alert('Erro ao enviar arquivo. Tente novamente.');
    })
    .finally(() => {
      // Reabilita bot√£o
      btn.innerHTML = textOriginal;
      btn.disabled = false;
    });
  });

  // ===========================
  // NOVO: FUNCIONALIDADE DE AGENDAMENTO R√ÅPIDO
  // ===========================
  window.agendarEntrega = function(entregaId, numeroNf) {
    document.getElementById('nf-agendamento-modal').textContent = numeroNf;
    document.getElementById('confirmar-agendamento').setAttribute('data-entrega-id', entregaId);
    
    // Buscar dados da entrega para verificar portal
    fetch(`/monitoramento/api/entrega/${entregaId}`)
    .then(response => response.json())
    .then(data => {
      if (data.entrega) {
        // Preencher dados do cliente
        document.getElementById('cliente-agendamento-modal').textContent = data.entrega.cliente || '';
        document.getElementById('cnpj-agendamento-modal').textContent = data.entrega.cnpj_cliente || '';
        
        // Verificar se cliente tem portal usando prefixo CNPJ
        const cnpj = data.entrega.cnpj_cliente || '';
        const cnpjLimpo = cnpj.replace(/\D/g, '');
        const prefixoCnpj = cnpjLimpo.substring(0, 8);
        
        // Resetar displays
        document.getElementById('botoes-portal').style.display = 'none';
        document.getElementById('portal-indisponivel').style.display = 'none';
        
        // Verificar grupos empresariais
        if (['93209765', '75315333', '00063960'].includes(prefixoCnpj)) {
          // Cliente Atacad√£o
          document.getElementById('botoes-portal').style.display = 'block';
          document.getElementById('nome-portal').textContent = 'Portal Atacad√£o';
          
          // Configurar bot√µes para Atacad√£o
          document.getElementById('btn-agendar-portal').onclick = function() {
            // Chamar fun√ß√£o ass√≠ncrona simplificada
            agendarNoPortalAtacadaoSimples(entregaId, numeroNf);
          };
          document.getElementById('btn-verificar-protocolo').onclick = function() {
            verificarProtocoloNoPortal(entregaId);
          };
          
        } else if (prefixoCnpj === '01157555') {
          // Cliente Tenda
          document.getElementById('portal-indisponivel').style.display = 'block';
          document.getElementById('mensagem-portal').textContent = 'Portal do Tenda ainda n√£o dispon√≠vel';
          
        } else if (prefixoCnpj === '06057223') {
          // Cliente Assa√≠
          document.getElementById('portal-indisponivel').style.display = 'block';
          document.getElementById('mensagem-portal').textContent = 'Portal do Assa√≠ ainda n√£o dispon√≠vel';
        }
      }
    })
    .catch(error => {
      console.error('Erro ao buscar dados da entrega:', error);
    });
    
    // Limpa formul√°rio
    document.getElementById('form-agendamento-rapido').reset();
    document.getElementById('criar-confirmado').checked = false;
    
    // Carrega hist√≥rico de agendamentos
    carregarHistoricoAgendamentos(entregaId);
    
    // Usa a inst√¢ncia global do modal
    agendamentoModal.show();
  };
  
  // Fun√ß√£o simplificada para agendar no Portal Atacad√£o (apenas data)
  function agendarNoPortalAtacadaoSimples(entregaId, numeroNf) {
    // Mostrar modal simplificado
    $('#modalAgendamentoPortal').modal('show');
    $('#modalAgendamentoPortal #entrega_id_portal').val(entregaId);
    $('#modalAgendamentoPortal #numero_nf_portal').val(numeroNf);
    
    // Preencher informa√ß√µes da NF no modal
    $('#modalAgendamentoPortal .nf-info').html(`
      <div class="alert alert-info">
        <strong>NF: ${numeroNf}</strong> - Agendamento R√°pido no Portal Atacad√£o
      </div>
    `);
    
    // Limpar e configurar formul√°rio
    $('#formAgendamentoPortal')[0].reset();
    $('#formAgendamentoPortal #entrega_id_portal').val(entregaId);
    $('#formAgendamentoPortal #numero_nf_portal').val(numeroNf);
    
    // Definir data m√≠nima como hoje
    const hoje = new Date().toISOString().split('T')[0];
    $('#data_agendamento_portal').attr('min', hoje).val(hoje);
  }
  
  // Manter fun√ß√£o antiga para compatibilidade (caso seja chamada de outro lugar)
  function agendarNoPortalAtacadao(entregaId, numeroNf) {
    agendarNoPortalAtacadaoSimples(entregaId, numeroNf);
  }
  
  // Fun√ß√£o para verificar protocolo no portal
  function verificarProtocoloNoPortal(entregaId) {
    // Buscar o protocolo do √∫ltimo agendamento carregado
    fetch(`/monitoramento/${entregaId}/historico_agendamentos`)
    .then(response => response.json())
    .then(data => {
      if (data.agendamentos && data.agendamentos.length > 0) {
        // Pegar o protocolo do agendamento mais recente
        const ultimoAgendamento = data.agendamentos[0];
        const protocolo = ultimoAgendamento.protocolo_agendamento;
        
        if (!protocolo) {
          alert('‚ùå Este agendamento n√£o possui protocolo registrado.');
          return;
        }
        
        // Buscar separacao_lote_id da entrega
        fetch(`/monitoramento/api/entrega/${entregaId}/dados`)
        .then(response => response.json())
        .then(entregaData => {
          if (!entregaData.separacao_lote_id) {
            alert('‚ùå Esta entrega n√£o possui lote de separa√ß√£o associado.');
            return;
          }
          
          // Mostrar loading
          const btn = document.getElementById('btn-verificar-protocolo');
          const textoOriginal = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Verificando...';
          
          // Chamar API de verifica√ß√£o de protocolo (URL correta com prefixo do blueprint)
          fetch('/portal/atacadao/api/verificar-protocolo-portal', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
              protocolo: protocolo,
              lote_id: entregaData.separacao_lote_id
            })
          })
          .then(response => response.json())
          .then(result => {
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
            
            if (result.success) {
              let mensagem = `üìã Protocolo: ${result.protocolo}\n`;
              mensagem += `üìä Status: ${result.status_text || 'N√£o identificado'}\n`;
              
              if (result.agendamento_confirmado) {
                mensagem += `‚úÖ Agendamento CONFIRMADO\n`;
                if (result.data_aprovada) {
                  mensagem += `üìÖ Data aprovada: ${result.data_aprovada}\n`;
                }
                
                // üÜï Se confirmou, mostrar mensagem de sucesso e recarregar ap√≥s mostrar modal
                if (result.status_text && result.status_text.includes('Aguardando check-in')) {
                  setTimeout(() => {
                    if (confirm('‚úÖ Agendamento confirmado automaticamente no sistema!\n\nDeseja recarregar a p√°gina para ver as atualiza√ß√µes?')) {
                      location.reload();
                    }
                  }, 2000);
                }
              } else {
                mensagem += `‚è≥ Aguardando aprova√ß√£o\n`;
              }
              
              if (result.produtos_portal && result.produtos_portal.length > 0) {
                mensagem += `\nüì¶ Produtos no portal: ${result.produtos_portal.length}\n`;
                result.produtos_portal.forEach(prod => {
                  mensagem += `  - ${prod.codigo}: ${prod.mercadoria} (Qtd: ${prod.quantidade})\n`;
                });
              }
              
              if (result.divergencias && result.divergencias.length > 0) {
                mensagem += `\n‚ö†Ô∏è Diverg√™ncias encontradas:\n`;
                result.divergencias.forEach(div => {
                  mensagem += `  - ${div}\n`;
                });
              }
              
              // Mostrar resultado em modal melhor
              mostrarResultadoVerificacao(result);
            } else {
              alert(`‚ùå ${result.message || 'Erro ao verificar protocolo'}`);
            }
          })
          .catch(error => {
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
            console.error('Erro ao verificar protocolo:', error);
            alert('‚ùå Erro ao verificar protocolo no portal');
          });
        })
        .catch(error => {
          console.error('Erro ao buscar dados da entrega:', error);
          alert('‚ùå Erro ao buscar dados da entrega');
        });
      } else {
        alert('‚ùå Nenhum agendamento encontrado para esta entrega.');
      }
    })
    .catch(error => {
      console.error('Erro ao buscar hist√≥rico:', error);
      alert('‚ùå Erro ao buscar hist√≥rico de agendamentos');
    });
  }
  
  // Fun√ß√£o para mostrar resultado da verifica√ß√£o em formato mais amig√°vel
  function mostrarResultadoVerificacao(resultado) {
    // Criar modal ou div com resultado formatado
    let html = '<div class="modal fade" id="resultadoVerificacaoModal" tabindex="-1">';
    html += '<div class="modal-dialog modal-lg"><div class="modal-content">';
    html += '<div class="modal-header">';
    html += '<h5 class="modal-title">üîç Resultado da Verifica√ß√£o no Portal</h5>';
    html += '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>';
    html += '</div><div class="modal-body">';
    
    // Status do agendamento
    html += '<div class="alert ' + (resultado.agendamento_confirmado ? 'alert-success' : 'alert-warning') + '">';
    html += '<h6>üìã Protocolo: ' + resultado.protocolo + '</h6>';
    html += '<p class="mb-1">Status no Portal: <strong>' + (resultado.status_text || 'N√£o identificado') + '</strong></p>';
    if (resultado.agendamento_confirmado) {
      html += '<p class="mb-0">‚úÖ <strong>Agendamento CONFIRMADO</strong>';
      if (resultado.data_aprovada) {
        html += ' para <strong>' + resultado.data_aprovada + '</strong>';
      }
      html += '</p>';
      
      // üÜï Adicionar informa√ß√£o sobre atualiza√ß√£o autom√°tica
      if (resultado.status_text && resultado.status_text.includes('Aguardando check-in')) {
        html += '<hr class="my-2">';
        html += '<p class="mb-0 text-success"><small>‚úÖ O agendamento foi automaticamente confirmado no sistema!</small></p>';
        html += '<p class="mb-0 text-success"><small>üìä Status atualizado de "Aguardando" para "Confirmado"</small></p>';
      }
    } else {
      // Apenas mostrar linha adicional se for "Aguardando aprova√ß√£o" especificamente
      if (resultado.status_text && resultado.status_text.includes('Aguardando aprova√ß√£o')) {
        html += '<p class="mb-0">‚è≥ <strong>Aguardando aprova√ß√£o</strong></p>';
        html += '<p class="mb-0"><small>O agendamento ainda n√£o foi aprovado no portal do cliente.</small></p>';
      }
      // Para outros status, n√£o adicionar nada - o status_text j√° est√° sendo mostrado acima
    }
    html += '</div>';
    
    // Produtos
    if (resultado.produtos_unificados && resultado.produtos_unificados.length > 0) {
      html += '<h6>üì¶ Compara√ß√£o de Produtos:</h6>';
      html += '<table class="table table-sm">';
      html += '<thead><tr><th>C√≥digo</th><th>Descri√ß√£o</th><th>Qtd Sistema</th><th>Qtd Portal</th><th>Diferen√ßa</th></tr></thead>';
      html += '<tbody>';
      resultado.produtos_unificados.forEach(prod => {
        const temDivergencia = prod.tem_divergencia;
        html += '<tr class="' + (temDivergencia ? 'table-warning' : '') + '">';
        html += '<td>' + prod.codigo_nosso + '</td>';
        html += '<td>' + prod.descricao_nossa + '</td>';
        html += '<td>' + prod.qtd_separacao.toFixed(2) + '</td>';
        html += '<td>' + prod.qtd_agendamento.toFixed(2) + '</td>';
        html += '<td>' + (temDivergencia ? '<span class="text-danger">' + prod.diferenca.toFixed(2) + '</span>' : '‚úÖ') + '</td>';
        html += '</tr>';
      });
      html += '</tbody></table>';
    }
    
    // Produtos n√£o mapeados
    if (resultado.produtos_nao_mapeados && resultado.produtos_nao_mapeados.length > 0) {
      html += '<div class="alert alert-warning">';
      html += '<h6>‚ö†Ô∏è Produtos sem DE-PARA configurado:</h6>';
      resultado.produtos_nao_mapeados.forEach(prod => {
        html += '<p class="mb-1">' + prod.codigo_atacadao + ' - ' + prod.descricao + ' (Qtd: ' + prod.quantidade + ')</p>';
      });
      html += '</div>';
    }
    
    html += '</div><div class="modal-footer">';
    html += '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>';
    html += '</div></div></div></div>';
    
    // Adicionar modal ao body e mostrar
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = html;
    document.body.appendChild(modalContainer);
    
    const modal = new bootstrap.Modal(document.getElementById('resultadoVerificacaoModal'));
    modal.show();
    
    // Remover modal do DOM ap√≥s fechar
    document.getElementById('resultadoVerificacaoModal').addEventListener('hidden.bs.modal', function() {
      modalContainer.remove();
    });
  }

  // Carregar hist√≥rico de agendamentos
  function carregarHistoricoAgendamentos(entregaId) {
    const historicoDiv = document.getElementById('historico-agendamentos');
    const confirmarUltimoDiv = document.getElementById('confirmar-ultimo-agendamento');
    
    historicoDiv.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Carregando hist√≥rico...</div>';
    
    fetch(`/monitoramento/${entregaId}/historico_agendamentos`)
    .then(response => response.json())
    .then(data => {
      if (data.agendamentos && data.agendamentos.length > 0) {
        let html = '';
        let ultimoAguardando = null;
        
        data.agendamentos.forEach((agendamento, index) => {
          const statusBadge = agendamento.status === 'confirmado' 
            ? '<span class="badge bg-primary">‚úÖ Confirmado</span>'
            : '<span class="badge bg-warning">‚è≥ Aguardando</span>';
          
          // Identifica o √∫ltimo agendamento aguardando
          if (index === 0 && agendamento.status === 'aguardando') {
            ultimoAguardando = agendamento;
          }
          
          html += `
            <div class="border-bottom pb-2 mb-2">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>${agendamento.data_agendada}</strong>
                  ${agendamento.hora_agendada ? ' √†s ' + agendamento.hora_agendada : ''}
                  <br><small class="text-muted">üìã ${agendamento.protocolo_agendamento || 'Sem protocolo'}</small>
                  <br><small class="text-muted">Por ${agendamento.autor} - ${agendamento.criado_em}</small>
                  ${agendamento.status === 'confirmado' && agendamento.confirmado_por ? 
                    `<br><small class="text-success">Confirmado por ${agendamento.confirmado_por} em ${agendamento.confirmado_em}</small>` : ''}
                </div>
                <div>${statusBadge}</div>
              </div>
              ${agendamento.motivo ? `<small><strong>Motivo:</strong> ${agendamento.motivo}</small><br>` : ''}
              ${agendamento.observacoes_confirmacao ? `<small><strong>Obs. Confirma√ß√£o:</strong> ${agendamento.observacoes_confirmacao}</small>` : ''}
            </div>
          `;
        });
        
        historicoDiv.innerHTML = html;
        
        // Mostra √°rea de confirma√ß√£o se h√° agendamento aguardando
        if (ultimoAguardando) {
          document.getElementById('detalhes-ultimo-agendamento').innerHTML = `
            <p><strong>Data:</strong> ${ultimoAguardando.data_agendada}${ultimoAguardando.hora_agendada ? ' √†s ' + ultimoAguardando.hora_agendada : ''}</p>
            <p><strong>Protocolo:</strong> ${ultimoAguardando.protocolo_agendamento || 'Sem protocolo'}</p>
            <p><strong>Forma:</strong> ${ultimoAguardando.forma_agendamento}</p>
          `;
          document.getElementById('btn-confirmar-ultimo').setAttribute('data-agendamento-id', ultimoAguardando.id);
          confirmarUltimoDiv.style.display = 'block';
        } else {
          confirmarUltimoDiv.style.display = 'none';
        }
      } else {
        historicoDiv.innerHTML = '<div class="text-center text-muted">Nenhum agendamento registrado</div>';
        confirmarUltimoDiv.style.display = 'none';
      }
    })
    .catch(err => {
      console.error('Erro ao carregar hist√≥rico:', err);
      historicoDiv.innerHTML = '<div class="text-center text-danger">Erro ao carregar hist√≥rico</div>';
    });
  }

  // Confirmar agendamento
  document.getElementById('confirmar-agendamento').addEventListener('click', function() {
    const entregaId = this.getAttribute('data-entrega-id');
    const formData = new FormData();
    
    formData.append('csrf_token', csrfToken);
    formData.append('data_agendada', document.getElementById('data-agendada').value);
    formData.append('hora_agendada', document.getElementById('hora-agendada').value);
    formData.append('forma_agendamento', document.getElementById('forma-agendamento').value);
    formData.append('protocolo_agendamento', document.getElementById('protocolo-agendamento').value);
    formData.append('motivo', document.getElementById('motivo-agendamento').value);
    formData.append('criar_confirmado', document.getElementById('criar-confirmado').checked ? 'y' : '');

    fetch(`/monitoramento/${entregaId}/adicionar_agendamento`, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        alert('‚úÖ Agendamento registrado com sucesso!');
        location.reload();
      } else {
        alert('‚ùå Erro ao registrar agendamento.');
      }
    })
    .catch(err => {
      console.error('Erro:', err);
      alert('‚ùå Erro na requisi√ß√£o.');
    });
  });

  // Confirmar √∫ltimo agendamento no modal
  document.getElementById('btn-confirmar-ultimo').addEventListener('click', function() {
    const agendamentoId = this.getAttribute('data-agendamento-id');
    const observacoes = document.getElementById('observacoes-confirmacao').value;
    
    const formData = new FormData();
    formData.append('csrf_token', csrfToken);
    formData.append('observacoes_confirmacao', observacoes);

    fetch(`/monitoramento/confirmar_agendamento/${agendamentoId}`, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        alert('‚úÖ Agendamento confirmado com sucesso!');
        location.reload();
      } else {
        alert('‚ùå Erro ao confirmar agendamento.');
      }
    })
    .catch(err => {
      console.error('Erro:', err);
      alert('‚ùå Erro na requisi√ß√£o.');
    });
  });

  // Fun√ß√£o para confirmar agendamento diretamente da listagem
  window.confirmarAgendamento = function(agendamentoId) {
    if (!confirm('Confirmar este agendamento?')) return;
    
    const formData = new FormData();
    formData.append('csrf_token', csrfToken);

    fetch(`/monitoramento/confirmar_agendamento/${agendamentoId}`, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        alert('‚úÖ Agendamento confirmado com sucesso!');
        location.reload();
      } else {
        alert('‚ùå Erro ao confirmar agendamento.');
      }
    })
    .catch(err => {
      console.error('Erro:', err);
      alert('‚ùå Erro na requisi√ß√£o.');
    });
  };

  // ===========================
  // NOVO: FUNCIONALIDADE DE ALTERAR DATA PREVISTA
  // ===========================
  window.alterarDataPrevista = function(entregaId, numeroNf, dataAtual) {
    document.getElementById('nf-data-modal').textContent = numeroNf;
    document.getElementById('confirmar-data-prevista').setAttribute('data-entrega-id', entregaId);
    
    // Preenche data atual se existir
    if (dataAtual) {
      document.getElementById('nova-data-prevista').value = dataAtual;
    }
    
    // Carrega hist√≥rico
    carregarHistoricoDataPrevista(entregaId);
    
    // Usa a inst√¢ncia global do modal
    dataPrevistaModal.show();
  };

  // Carregar hist√≥rico de altera√ß√µes
  function carregarHistoricoDataPrevista(entregaId) {
    const historicoDiv = document.getElementById('historico-data-prevista');
    historicoDiv.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Carregando hist√≥rico...</div>';
    
    fetch(`/monitoramento/${entregaId}/historico_data_prevista`)
    .then(response => response.json())
    .then(data => {
      if (data.historico && data.historico.length > 0) {
        let html = '';
        data.historico.forEach(item => {
          html += `
            <div class="border-bottom pb-2 mb-2">
              <small class="text-muted">${item.data_alteracao}</small><br>
              <strong>De:</strong> ${item.data_anterior || 'N√£o definida'}<br>
              <strong>Para:</strong> ${item.data_nova}<br>
              <strong>Por:</strong> ${item.alterado_por}<br>
              <strong>Motivo:</strong> ${item.motivo}
            </div>
          `;
        });
        historicoDiv.innerHTML = html;
      } else {
        historicoDiv.innerHTML = '<div class="text-center text-muted">Nenhuma altera√ß√£o registrada</div>';
      }
    })
    .catch(err => {
      console.error('Erro ao carregar hist√≥rico:', err);
      historicoDiv.innerHTML = '<div class="text-center text-danger">Erro ao carregar hist√≥rico</div>';
    });
  }

  // Confirmar altera√ß√£o de data prevista
  document.getElementById('confirmar-data-prevista').addEventListener('click', function() {
    const entregaId = this.getAttribute('data-entrega-id');
    const novaData = document.getElementById('nova-data-prevista').value;
    const motivo = document.getElementById('motivo-alteracao').value;
    
    if (!novaData || !motivo) {
      alert('‚ùå Data e motivo s√£o obrigat√≥rios!');
      return;
    }

    const formData = new FormData();
    formData.append('csrf_token', csrfToken);
    formData.append('nova_data_prevista', novaData);
    formData.append('motivo_alteracao', motivo);

    fetch(`/monitoramento/${entregaId}/alterar_data_prevista`, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        alert('‚úÖ Data de entrega prevista alterada com sucesso!');
        location.reload();
      } else {
        alert('‚ùå Erro ao alterar data.');
      }
    })
    .catch(err => {
      console.error('Erro:', err);
      alert('‚ùå Erro na requisi√ß√£o.');
    });
  });

  // Fun√ß√£o para processar agendamento no portal de forma ass√≠ncrona simplificada
  $('#formAgendamentoPortal').on('submit', function(e) {
    e.preventDefault();
    
    const entregaId = $('#entrega_id_portal').val();
    const numeroNf = $('#numero_nf_portal').val();
    const dataAgendamento = $('#data_agendamento_portal').val();
    
    // Validar data
    if (!dataAgendamento) {
      Swal.fire('Aten√ß√£o', 'Por favor, selecione uma data de agendamento', 'warning');
      return;
    }
    
    // Fechar modal
    $('#modalAgendamentoPortal').modal('hide');
    
    // Chamar fun√ß√£o ass√≠ncrona j√° existente
    if (typeof agendarNoPortalAtacadaoAsync === 'function') {
      // Temporariamente setar o valor no elemento para a fun√ß√£o async capturar
      const tempInput = document.getElementById('data-agendamento-portal');
      if (!tempInput) {
        // Criar input tempor√°rio se n√£o existir
        const input = document.createElement('input');
        input.type = 'hidden';
        input.id = 'data-agendamento-portal';
        input.value = dataAgendamento;
        document.body.appendChild(input);
      } else {
        tempInput.value = dataAgendamento;
      }
      
      // Chamar fun√ß√£o async
      agendarNoPortalAtacadaoAsync(entregaId, numeroNf);
      
      // Mostrar notifica√ß√£o
      Swal.fire({
        title: 'Agendamento Enviado!',
        html: `
          <p><strong>NF ${numeroNf}</strong></p>
          <p>Data: ${new Date(dataAgendamento + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
          <p>O agendamento est√° sendo processado em segundo plano.</p>
          <p>Voc√™ receber√° uma notifica√ß√£o quando for conclu√≠do.</p>
        `,
        icon: 'info',
        timer: 5000,
        timerProgressBar: true
      });
    } else {
      // Fallback: chamar API diretamente se fun√ß√£o n√£o estiver dispon√≠vel
      $.ajax({
        url: '/portal/api/solicitar-agendamento-nf-async',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          numero_nf: numeroNf,
          entrega_id: entregaId,
          data_agendamento: dataAgendamento
        }),
        success: function(response) {
          if (response.success) {
            Swal.fire({
              title: 'Agendamento Solicitado!',
              text: response.message || 'Processando em segundo plano...',
              icon: 'success',
              timer: 3000
            });
          } else {
            Swal.fire('Erro', response.message, 'error');
          }
        },
        error: function(xhr) {
          const response = xhr.responseJSON || {};
          Swal.fire('Erro', response.message || 'Erro ao processar agendamento', 'error');
        }
      });
    }
  });
</script>
<script src="{{ url_for('static', filename='js/portal-async-integration.js') }}"></script>
<!-- Modal de Agendamento no Portal -->
<div class="modal fade" id="modalAgendamentoPortal" tabindex="-1" aria-labelledby="modalAgendamentoPortalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalAgendamentoPortalLabel">
          <i class="fas fa-calendar-plus"></i> Agendar no Portal Atacad√£o
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="nf-info"></div>
        
        <form id="formAgendamentoPortal">
          <input type="hidden" id="entrega_id_portal" name="entrega_id">
          <input type="hidden" id="numero_nf_portal" name="numero_nf">
          
          <div class="row">
            <div class="col-12">
              <div class="form-group">
                <label for="data_agendamento_portal">
                  <i class="fas fa-calendar-alt"></i> Data de Agendamento *
                </label>
                <input type="date" class="form-control form-control-lg" id="data_agendamento_portal" required>
                <small class="form-text text-muted">
                  Selecione a data desejada para o agendamento no portal Atacad√£o
                </small>
              </div>
            </div>
          </div>
          
          <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle"></i> 
            <strong>Agendamento Ass√≠ncrono:</strong> 
            O agendamento ser√° processado em segundo plano. 
            Voc√™ receber√° uma notifica√ß√£o quando for conclu√≠do.
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> 
            <strong>Importante:</strong> Certifique-se de que o Chrome est√° rodando com debug e voc√™ j√° fez login no portal Atacad√£o.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="submit" form="formAgendamentoPortal" class="btn btn-primary">
          <i class="fas fa-rocket"></i> Solicitar Agendamento
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
</div> <!-- fim pagination-container -->

