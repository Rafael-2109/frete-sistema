<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>Frete Sistema</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

  <!-- Design System Nacom Goya -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-overrides.css') }}?v=6">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}?v=6">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/financeiro/premium-effects.css') }}?v=6">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=6">

  <!-- Previne flash de tema incorreto -->
  <script>
    (function() {
      var saved = localStorage.getItem('nacom-theme');
      var theme = saved || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      document.documentElement.setAttribute('data-bs-theme', theme);
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <!-- Bloco para CSS adicional das p√°ginas -->
  {% block extra_css %}{% endblock %}
</head>

<body>

  {% if current_user.is_authenticated %}
  <nav class="navbar navbar-expand-lg nc-navbar">
    <div class="container-fluid">
      {% if not is_comercial_only %}
      <a class="navbar-brand" href="{% if current_user.sistema_motochefe and not current_user.sistema_logistica %}{{ url_for('motochefe.dashboard_motochefe') }}{% else %}{{ url_for('main.dashboard') }}{% endif %}">
        {% if current_user.sistema_motochefe and not current_user.sistema_logistica %}
        <i class="fas fa-motorcycle"></i> <span>Sistema MotoChefe</span>
        {% else %}
        <i class="fas fa-truck"></i> <span>Log√≠stica Nacom Goya</span>
        {% endif %}
      </a>
      {% else %}
      <span class="navbar-brand"><i class="fas fa-briefcase"></i> <span>Comercial Nacom Goya</span></span>
      {% endif %}
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">

          <!-- Dropdown MotoChefe -->
          {% if current_user.is_authenticated and current_user.pode_acessar_motochefe() %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarMotochefe" role="button"
               data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-motorcycle"></i> MotoChefe
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarMotochefe">
                <li><h6 class="dropdown-header"><i class="fas fa-address-book"></i> Cadastros B√°sicos</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_equipes') }}">
                    <i class="fas fa-users"></i> Equipes de Vendas
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_crossdocking') }}">
                    <i class="fas fa-truck-loading"></i> CrossDocking
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_vendedores') }}">
                    <i class="fas fa-user-tie"></i> Vendedores
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_transportadoras') }}">
                    <i class="fas fa-truck"></i> Transportadoras
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_clientes') }}">
                    <i class="fas fa-building"></i> Clientes
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_empresas') }}">
                    <i class="fas fa-industry"></i> Empresas de Faturamento
                </a></li>

                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header"><i class="fas fa-box"></i> Produtos e Estoque</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_modelos') }}">
                    <i class="fas fa-list"></i> Modelos de Motos
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_motos') }}">
                    <i class="fas fa-motorcycle"></i> Estoque de Motos (Chassi)
                </a></li>

                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header"><i class="fas fa-shopping-cart"></i> Vendas</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_pedidos') }}">
                    <i class="fas fa-file-invoice"></i> Pedidos de Venda
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_titulos') }}">
                    <i class="fas fa-receipt"></i> T√≠tulos a Receber
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_comissoes') }}">
                    <i class="fas fa-hand-holding-usd"></i> Comiss√µes
                </a></li>

                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header"><i class="fas fa-truck-loading"></i> Log√≠stica</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_embarques') }}">
                    <i class="fas fa-shipping-fast"></i> Embarques
                </a></li>

                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header"><i class="fas fa-dollar-sign"></i> Financeiro</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.extrato_financeiro') }}">
                    <i class="fas fa-file-invoice-dollar"></i> Extrato Financeiro
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_contas_a_pagar') }}">
                    <i class="fas fa-hand-holding-usd"></i> Contas a Pagar
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_contas_a_receber') }}">
                    <i class="fas fa-money-bill-wave"></i> Contas a Receber
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_titulos_a_pagar_route') }}">
                    <i class="fas fa-file-invoice"></i> T√≠tulos a Pagar
                </a></li>

                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header"><i class="fas fa-cog"></i> Operacional</h6></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.custos_operacionais') }}">
                    <i class="fas fa-dollar-sign"></i> Custos Operacionais
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('motochefe.listar_despesas') }}">
                    <i class="fas fa-wallet"></i> Despesas Mensais
                </a></li>
            </ul>
          </li>
          {% endif %}

          {# üÜï Link DIRETO na barra: Confirma√ß√£o de Pedidos #}
          {% if current_user.is_authenticated and current_user.pode_acessar_motochefe() %}
          <li class="nav-item">
            <a class="nav-link {% if count_pendentes_motochefe > 0 %}text-warning{% endif %}"
               href="{{ url_for('motochefe.confirmacao_pedidos') }}"
               title="Confirma√ß√£o de Pedidos - A√ß√µes pendentes de aprova√ß√£o">
                <i class="fas fa-tasks"></i> Confirma√ß√£o
                {% if count_pendentes_motochefe and count_pendentes_motochefe > 0 %}
                <span class="badge bg-danger rounded-pill">{{ count_pendentes_motochefe }}</span>
                {% endif %}
            </a>
          </li>
          {% endif %}

          <!-- OPERACIONAL - Fluxo principal do dia a dia -->
          {% if not is_comercial_only %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="menuOperacional" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-tasks"></i> Operacional
            </a>
            <ul class="dropdown-menu">
              <li>
                <h6 class="dropdown-header">üì¶ Pedidos e Separa√ß√£o</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('pedidos.lista_pedidos') }}">
                  <i class="fas fa-list-alt"></i> Lista de Pedidos
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('separacao.listar') }}">
                  <i class="fas fa-boxes"></i> Separa√ß√£o
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('separacao.importar') }}">
                  <i class="fas fa-upload"></i> Importar Separa√ß√£o
                </a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">üöõ Embarques</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('embarques.listar_embarques') }}">
                  <i class="fas fa-shipping-fast"></i> Listar Embarques
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('portaria.dashboard') }}">
                  <i class="fas fa-truck"></i> Controle de Portaria
                </a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">üìã Monitoramento</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('rastreamento.tela_monitoramento') }}">
                  <i class="fas fa-satellite-dish text-success"></i> <strong>Rastreamento GPS</strong>
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('monitoramento.listar_entregas') }}">
                  <i class="fas fa-eye"></i> Entregas Monitoradas
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('devolucao.devolucao_ocorrencia.index') }}">
                  <i class="fas fa-undo-alt"></i> Ocorr√™ncias de Devolu√ß√£o
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('pallet.index') }}">
                  <i class="fas fa-pallet"></i> Controle de Pallets
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('portaria.historico') }}">
                  <i class="fas fa-history"></i> Hist√≥rico da Portaria
                </a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">üìä Relat√≥rios</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('metricas.dashboard_metricas') }}">
                  <i class="fas fa-chart-bar text-info"></i> Dashboard de M√©tricas
                </a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">üõí Compras</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('recebimento_views.central_compras') }}">
                  <i class="fas fa-shopping-cart text-primary"></i> <strong>Central Compras</strong>
                </a></li>
            </ul>
          </li>
          {% endif %}

          <!-- FINANCEIRO - Gest√£o financeira -->
          {% if not is_comercial_only and current_user.is_authenticated and (current_user.tem_permissao('fretes') or
          current_user.tem_permissao('financeiro') or current_user.tem_permissao('faturamento') or
          current_user.pode_acessar_financeiro() or current_user.perfil == 'administrador') %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="menuFinanceiro" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-dollar-sign"></i> Financeiro
            </a>
            <ul class="dropdown-menu">
              <!-- Dashboard Central -->
              <li><a class="dropdown-item" href="{{ url_for('financeiro.dashboard') }}">
                  <i class="fas fa-landmark text-primary"></i> <strong>Central Financeira</strong>
                </a></li>
              <li><hr class="dropdown-divider"></li>
              {% if current_user.tem_permissao('fretes') or current_user.pode_acessar_financeiro() or
              current_user.perfil == 'administrador' %}
              <li>
                <h6 class="dropdown-header">üí∞ Fretes</h6>
              </li>
              {% if current_user.tem_permissao('fretes', 'visualizar') or current_user.pode_acessar_financeiro() or
              current_user.perfil == 'administrador' %}
              <li><a class="dropdown-item" href="{{ url_for('fretes.index') }}">
                  <i class="fas fa-tachometer-alt"></i> Dashboard Fretes
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('fretes.listar_fretes') }}">
                  <i class="fas fa-list"></i> Listar Fretes
                </a></li>
              {% endif %}
              {% if current_user.tem_permissao('fretes', 'lancar') or current_user.pode_editar('fretes') or
              current_user.perfil == 'administrador' %}
              <li><a class="dropdown-item" href="{{ url_for('fretes.lancar_cte') }}">
                  <i class="fas fa-plus-circle"></i> Lan√ßar CTe
                </a></li>
              {% endif %}
              {% if current_user.tem_permissao('fretes', 'aprovar') or current_user.perfil in ['administrador',
              'financeiro', 'gerente_comercial'] %}
              <li><a class="dropdown-item" href="{{ url_for('fretes.listar_aprovacoes') }}">
                  <i class="fas fa-check-circle"></i> Aprova√ß√µes
                </a></li>
              {% endif %}
              {% if current_user.tem_permissao('fretes', 'faturas') or current_user.pode_acessar_financeiro() or
              current_user.perfil == 'administrador' %}
              <li><a class="dropdown-item" href="{{ url_for('fretes.listar_faturas') }}">
                  <i class="fas fa-file-pdf"></i> Faturas de Frete
                </a></li>
              {% endif %}
              {% endif %}
        

              {# ================================================================= #}
              {# CENTRAL FISCAL - Hub com cards                                    #}
              {# ================================================================= #}
              {% if current_user.tem_permissao('financeiro', 'pendencias') or current_user.pode_acessar_financeiro() or
              current_user.perfil == 'administrador' %}
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="{{ url_for('recebimento_views.central_fiscal') }}">
                  <i class="fas fa-file-invoice text-info"></i> <strong>Central Fiscal</strong>
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('pallet_v2.dashboard.index') }}">
                  <i class="fas fa-pallet text-warning"></i> Gest√£o de Pallets
                </a></li>
              {% endif %}

            </ul>
          </li>
          {% endif %}


          <!-- CADASTROS - Dados mestres -->
          {% if not is_comercial_only and current_user.is_authenticated and (current_user.tem_permissao('cadastros') or
          current_user.tem_permissao('transportadoras') or current_user.tem_permissao('tabelas') or
          current_user.pode_editar_cadastros() or current_user.perfil == 'administrador') %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="menuCadastros" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-database"></i> Cadastros
            </a>
            <ul class="dropdown-menu">
              {% if current_user.tem_permissao('cadastros') or current_user.pode_editar_cadastros() or
              current_user.perfil == 'administrador' %}
              <li>
                <h6 class="dropdown-header">‚öôÔ∏è Cadastros</h6>
              </li>
              {% if current_user.tem_permissao('transportadoras', 'editar') or current_user.pode_editar_cadastros() or
              current_user.perfil == 'administrador' %}
              <li><a class="dropdown-item" href="{{ url_for('transportadoras.cadastrar_transportadora') }}">
                  <i class="fas fa-truck"></i> Transportadoras
                </a></li>
              {% endif %}
              {% if current_user.tem_permissao('portaria', 'motoristas') or current_user.pode_editar_cadastros() or
              current_user.perfil == 'administrador' %}
              <li><a class="dropdown-item" href="{{ url_for('portaria.cadastrar_motorista') }}">
                  <i class="fas fa-user-plus"></i> Cadastrar Motorista
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('portaria.listar_motoristas') }}">
                  <i class="fas fa-users"></i> Listar Motoristas
                </a></li>
              {% endif %}
              {% if current_user.tem_permissao('localidades', 'editar') or current_user.pode_editar_cadastros() or
              current_user.perfil == 'administrador' %}
              <li><a class="dropdown-item" href="{{ url_for('localidades.cadastrar_cidade') }}">
                  <i class="fas fa-map-marker-alt"></i> Cidades
                </a></li>
              {% endif %}
              {% if current_user.tem_permissao('veiculos', 'administrar') or current_user.pode_editar_cadastros() or
              current_user.perfil == 'administrador' %}
              <li><a class="dropdown-item" href="{{ url_for('veiculos.admin_veiculos') }}">
                  <i class="fas fa-truck"></i> Administrar Ve√≠culos
                </a></li>
              {% endif %}
              {% if current_user.tem_permissao('agendamento', 'visualizar') or current_user.pode_editar_cadastros() or
              current_user.perfil == 'administrador' %}
              <li><a class="dropdown-item" href="{{ url_for('cadastros_agendamento.listar_contatos') }}">
                  <i class="fas fa-calendar-alt"></i> Agendamento
                </a></li>
              {% endif %}
              {% endif %}
              {% if current_user.tem_permissao('tabelas') or current_user.pode_acessar_financeiro() or
              current_user.perfil == 'administrador' %}
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">üìä Tabelas de Frete</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('tabelas.cadastrar_tabela_frete') }}">
                  <i class="fas fa-table"></i> Cadastro de Tabelas
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('tabelas.importar_tabela_frete') }}">
                  <i class="fas fa-upload"></i> Importar Tabelas
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('tabelas.historico_tabelas') }}">
                  <i class="fas fa-history"></i> Hist√≥rico de Tabelas
                </a></li>
              {% endif %}
            </ul>
          </li>
          {% endif %}

          {% if not is_comercial_only %}
          <!-- CONSULTAS - Informa√ß√µes e an√°lises -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="menuConsultas" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-search"></i> Consultas
            </a>
            <ul class="dropdown-menu">
              <li>
                <h6 class="dropdown-header">üîç Consultas</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('fretes.listar_fretes') }}">
                  <i class="fas fa-search"></i> Buscar Fretes
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('tabelas.listar_todas_tabelas') }}">
                  <i class="fas fa-eye"></i> Consulta de Tabelas
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('vinculos.consulta_vinculos') }}">
                  <i class="fas fa-link"></i> Consulta de V√≠nculos
                </a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">üì• Importa√ß√µes</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('cadastros_agendamento.importar_contatos') }}">
                  <i class="fas fa-calendar-plus"></i> Agendamento
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('vinculos.importar_vinculos') }}">
                  <i class="fas fa-link"></i> V√≠nculos
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('financeiro.importar_pendencias') }}">
                  <i class="fas fa-file-import"></i> Pend√™ncias Financeiras
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('faturamento.listar_relatorios') }}">
                  <i class="fas fa-file-upload"></i> Relat√≥rio de Faturamento
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('tagplus.pagina_importacao') }}">
                  <i class="fas fa-sync"></i> TagPlus
                </a></li>
            </ul>
          </li>

          <!-- CARTEIRA & PRODU√á√ÉO - M√≥dulos de carteira de pedidos -->

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="menuCarteira" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-industry text-success"></i> Carteira & Estoque
            </a>
            <ul class="dropdown-menu">
              <li>
                <h6 class="dropdown-header">üìä Dashboards</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('carteira.index') }}">
                  <i class="fas fa-shopping-cart text-success"></i> Carteira de Pedidos
                  <span class="badge bg-success ms-2">NOVO</span>
                </a></li>

              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">üè≠ Produ√ß√£o</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('manufatura.index') }}">
                  <i class="fas fa-industry text-success"></i> Manufatura/PCP
                  <span class="badge bg-success ms-2">NOVO</span>
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('producao.listar_programacao') }}">
                  <i class="fas fa-calendar-check"></i> Programa√ß√£o de Produ√ß√£o
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('producao.listar_palletizacao') }}">
                  <i class="fas fa-cubes"></i> Cadastro de Palletiza√ß√£o
                </a></li>

              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">üì¶ Estoque</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('estoque.listar_movimentacoes') }}">
                  <i class="fas fa-exchange-alt"></i> Movimenta√ß√µes de Estoque
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('estoque.saldo_estoque') }}">
                  <i class="fas fa-chart-line text-success"></i> Saldo de Estoque
                  <span class="badge bg-primary ms-2">NOVO</span>
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('estoque.listar_unificacao_codigos') }}">
                  <i class="fas fa-link text-warning"></i> Unifica√ß√£o de C√≥digos
                </a></li>

              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">üí∞ Faturamento</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('faturamento.dashboard_faturamento') }}">
                  <i class="fas fa-receipt"></i> Faturamento por Produto
                </a></li>

              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">üó∫Ô∏è Rotas</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('localidades.listar_rotas') }}">
                  <i class="fas fa-route"></i> Cadastro de Rotas
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('localidades.listar_sub_rotas') }}">
                  <i class="fas fa-map-marker-alt"></i> Cadastro de Sub-rotas
                </a></li>
            </ul>
          </li>
          {% endif %}

          <!-- BI - Business Intelligence & Analytics -->
          {% if current_user.perfil in ['administrador'] %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="menuBI" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-chart-bar text-info"></i> BI & Analytics
            </a>
            <ul class="dropdown-menu">
              <li>
                <h6 class="dropdown-header">üìä Dashboards</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('bi.dashboard') }}">
                  <i class="fas fa-tachometer-alt text-primary"></i> Dashboard Principal
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('bi.transportadoras') }}">
                  <i class="fas fa-truck text-success"></i> An√°lise de Transportadoras
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('bi.regional') }}">
                  <i class="fas fa-map-marked-alt text-warning"></i> An√°lise Regional
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('bi.despesas') }}">
                  <i class="fas fa-money-bill-wave text-danger"></i> An√°lise de Despesas
                </a></li>
            </ul>
          </li>
          {% endif %}

          <!-- COMERCIAL - Acompanhamento de vendas e clientes -->
          {% if current_user.is_authenticated and (current_user.tem_permissao('comercial') or
          current_user.tem_permissao('vendas') or current_user.perfil in ['administrador', 'diretoria',
          'gerente_comercial', 'vendedor']) %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="menuComercial" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-chart-line text-warning"></i> Comercial
            </a>
            <ul class="dropdown-menu">
              <li>
                <h6 class="dropdown-header">üìä Acompanhamento</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('comercial.dashboard_diretoria') }}">
                  <i class="fas fa-chart-bar text-primary"></i> Dashboard Comercial
                  <span class="badge bg-warning text-dark ms-2">NOVO</span>
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('comercial.lista_clientes', posicao='em_aberto') }}">
                  <i class="fas fa-building text-success"></i> Acompanhamento de Clientes
                </a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">üìà An√°lises</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('comercial.lista_clientes', posicao='todos') }}">
                  <i class="fas fa-list-alt"></i> Posi√ß√£o Total de Clientes
                </a></li>
              {% if current_user.perfil != 'vendedor' %}
              <li><a class="dropdown-item" href="{{ url_for('comercial.analise_margem') }}">
                  <i class="fas fa-chart-pie text-success"></i> An√°lise de Margem
                </a></li>
              {% endif %}
              {% if current_user.perfil in ['administrador', 'gerente_comercial'] %}
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">‚öôÔ∏è Administra√ß√£o</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('comercial.admin_permissoes') }}">
                  <i class="fas fa-user-shield text-danger"></i> Gerenciar Permiss√µes
                </a></li>
              {% endif %}
            </ul>
          </li>
          {% endif %}

          <!-- USU√ÅRIOS - Gest√£o de usu√°rios (baseado em permiss√µes) -->
          {% if current_user.is_authenticated and (current_user.pode_aprovar_usuarios() or
          current_user.tem_permissao('usuarios') or current_user.tem_permissao('admin')) %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="menuUsuarios" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-users"></i> Usu√°rios
            </a>
            <ul class="dropdown-menu">
              {% if current_user.pode_aprovar_usuarios() or current_user.tem_permissao('usuarios', 'aprovar') %}
              <li>
                <h6 class="dropdown-header">üë§ Gest√£o de Usu√°rios</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('auth.usuarios_pendentes') }}">
                  <i class="fas fa-user-clock text-warning"></i> Pendentes de Aprova√ß√£o
                </a></li>
              <li><a class="dropdown-item" href="{{ url_for('auth.listar_usuarios') }}">
                  <i class="fas fa-users"></i> Todos os Usu√°rios
                </a></li>
              {% endif %}

              {% if current_user.perfil in ['administrador', 'gerente_comercial'] %}
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <h6 class="dropdown-header">üîê Permiss√µes</h6>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('permissions.vendedores_vanilla') }}">
                  <i class="fas fa-users-cog text-info"></i> Vendedores e Equipes
                </a></li>
              {% endif %}

              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item" href="{{ url_for('auth.registro') }}" target="_blank">
                  <i class="fas fa-external-link-alt"></i> Link de Registro P√∫blico
                </a></li>
            </ul>
          </li>
          {% endif %}

          <!-- ü§ñ Agente Log√≠stico - Claude Agent SDK -->
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('agente.pagina_chat') }}"
              title="Agente Log√≠stico - Consultas inteligentes de pedidos e estoque">
              <i class="fas fa-robot text-info"></i> Agente
              <span class="badge bg-primary ms-1" style="font-size: 0.6rem;">SDK</span>
            </a>
          </li>

          <!-- Theme Toggle -->
          <li class="nav-item">
            <button class="nc-theme-toggle" type="button" title="Alternar tema">
              <i class="fas fa-sun"></i>
              <i class="fas fa-moon"></i>
            </button>
          </li>

          <!-- Logout -->
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('auth.logout') }}">
              <i class="fas fa-sign-out-alt"></i> Sair
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  {% endif %}

  <div class="container mt-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
      {% if category == 'success' %}
      <i class="fas fa-check-circle me-2"></i>
      {% elif category == 'danger' or category == 'error' %}
      <i class="fas fa-exclamation-circle me-2"></i>
      {% elif category == 'warning' %}
      <i class="fas fa-exclamation-triangle me-2"></i>
      {% elif category == 'info' %}
      <i class="fas fa-info-circle me-2"></i>
      {% endif %}
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
  </div>

  <!-- Carregamento de bibliotecas principais ANTES do conte√∫do -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

  <!-- Bloco de conte√∫do das p√°ginas -->
  {% block content %}{% endblock %}

<!-- Widget removido - usar /agente/ para chat -->


<!-- Scripts adicionais -->
  <script>
    $(document).ready(function () {
      // Configura√ß√£o do toastr
      toastr.options = {
        "closeButton": true,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "timeOut": "4000"
      };

      // Aplica m√°scara apenas para campos de texto (n√£o tipo date)
      $('input[name="data_embarque"]').not('[type="date"]').mask('00/00/0000');
    });
  </script>

  <!-- Theme Manager - Gerenciamento de Dark/Light Mode -->
  <script src="{{ url_for('static', filename='js/theme-manager.js') }}"></script>

  <!-- Premium Effects - Anima√ß√µes e efeitos visuais -->
  <script src="{{ url_for('static', filename='js/financeiro/premium-effects.js') }}"></script>

  <!-- ‚úÖ Inclua claramente aqui o HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.11"></script>
  <script>
    document.addEventListener("htmx:configRequest", function (event) {
      const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      if (token) {
        event.detail.headers['X-CSRFToken'] = token;
      }
    });

    // ‚úÖ TRATAMENTO ROBUSTO para erros CSRF
    document.addEventListener("htmx:responseError", function (event) {
      if (event.detail.xhr.status === 400) {
        const responseText = event.detail.xhr.responseText.toLowerCase();
        if (responseText.includes('csrf') || responseText.includes('token') || responseText.includes('missing')) {
          console.log('üîí Erro CSRF detectado, recarregando p√°gina...');
          alert('üîí Sess√£o de seguran√ßa expirou. Recarregando p√°gina...');
          window.location.reload();
          return;
        }

        try {
          const response = JSON.parse(event.detail.xhr.responseText);
          if (response.csrf_error) {
            alert(response.message);
            window.location.reload();
            return;
          }
        } catch (e) { }
      }
    });

    // ‚úÖ FUNC√á√ÉO GLOBAL para obter token CSRF
    function getCSRFToken() {
      // Primeiro tenta pegar do meta tag
      const metaToken = document.querySelector('meta[name="csrf-token"]');
      if (metaToken) {
        return metaToken.getAttribute('content');
      }

      // Fallback: busca em formul√°rios existentes
      const formToken = document.querySelector('input[name="csrf_token"]');
      if (formToken) {
        return formToken.value;
      }

      return null;
    }

    // ‚úÖ FUN√á√ÉO para regenerar token CSRF via AJAX
    function regenerateCSRFToken() {
      return fetch('/auth/regenerate_csrf', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      }).then(response => response.json()).then(data => {
        if (data.csrf_token) {
          // Atualiza meta tag
          const metaTag = document.querySelector('meta[name="csrf-token"]');
          if (metaTag) {
            metaTag.setAttribute('content', data.csrf_token);
          }

          // Atualiza todos os inputs de CSRF
          document.querySelectorAll('input[name="csrf_token"]').forEach(input => {
            input.value = data.csrf_token;
          });

          return data.csrf_token;
        }
        return null;
      }).catch(error => {
        console.error('Erro ao regenerar token CSRF:', error);
        return null;
      });
    }

    // ‚úÖ INTERCEPTOR ROBUSTO de formul√°rios para garantir CSRF
    document.addEventListener('submit', function (event) {
      const form = event.target;
      let csrfInput = form.querySelector('input[name="csrf_token"]');

      // Se n√£o tem input CSRF, cria um automaticamente
      if (!csrfInput) {
        csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        form.appendChild(csrfInput);
      }

      // Se input existe mas est√° vazio, preenche
      if (!csrfInput.value) {
        const token = getCSRFToken();
        if (token) {
          csrfInput.value = token;
          console.log('üîí Token CSRF adicionado automaticamente ao formul√°rio');
        } else {
          event.preventDefault();
          console.error('üîí Token CSRF n√£o encontrado, recarregando...');
          alert('‚ö†Ô∏è Sua sess√£o de seguran√ßa expirou. A p√°gina ser√° recarregada.');
          window.location.reload();
          return;
        }
      }
    });

    // ‚úÖ INTERCEPTOR ROBUSTO para AJAX/Fetch incluir CSRF
    const originalFetch = window.fetch;
    window.fetch = function (...args) {
      const [url, options = {}] = args;

      // Adiciona CSRF para qualquer m√©todo POST, PUT, PATCH, DELETE
      if (options.method && ['POST', 'PUT', 'PATCH', 'DELETE'].includes(options.method.toUpperCase())) {
        options.headers = options.headers || {};

        const token = getCSRFToken();
        if (token) {
          // M√∫ltiplos headers para compatibilidade m√°xima
          options.headers['X-CSRFToken'] = token;
          options.headers['X-CSRF-Token'] = token;
          options.headers['HTTP_X_CSRF_TOKEN'] = token;

          // Se est√° enviando FormData, adiciona tamb√©m no body
          if (options.body instanceof FormData) {
            options.body.append('csrf_token', token);
          }

          console.log('üîí Token CSRF adicionado √† requisi√ß√£o AJAX');
        } else {
          console.warn('‚ö†Ô∏è Token CSRF n√£o encontrado para requisi√ß√£o AJAX');
        }
      }

      return originalFetch.apply(this, [url, options]);
    };

    // ‚úÖ INTERCEPTOR ROBUSTO para jQuery AJAX incluir CSRF
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            // S√≥ adiciona para m√©todos que modificam dados
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                const token = getCSRFToken();
                if (token) {
                    xhr.setRequestHeader("X-CSRFToken", token);
                    console.log('üîí Token CSRF adicionado √† requisi√ß√£o jQuery AJAX');
                } else {
                    console.warn('‚ö†Ô∏è Token CSRF n√£o encontrado para jQuery AJAX');
                }
            }
        }
    });
  </script>

  {% block scripts %}{% endblock %}
</body>

</html>