<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Frete Sistema</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <!-- CSS customizado para navbar e mega-menu -->
    <style>
        /* For√ßa altura fixa do navbar */
        .navbar {
            height: auto !important; /* Permite altura din√¢mica */
            min-height: 56px !important;
            overflow: visible; /* Permite dropdowns sa√≠rem do navbar */
        }
        
        .navbar-nav {
            height: 100%;
            align-items: center;
        }
        
        .nav-item {
            height: 100%;
            display: flex;
            align-items: center;
        }
        
        /* Garante que dropdowns n√£o afetem o navbar */
        .dropdown-menu {
            position: absolute !important;
            top: 100% !important;
            z-index: 1050 !important;
            margin-top: 0 !important;
        }
        
        /* Melhorar responsividade dos dropdowns */
        @media (max-width: 768px) {
            .navbar-collapse {
                max-height: none !important;
            }
            
            .navbar-nav {
                flex-direction: column;
                align-items: stretch;
            }
            
            .nav-item {
                width: 100%;
            }
        }
        
        /* Corre√ß√µes para texto dos dropdowns */
        .dropdown-item {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .dropdown-header {
            white-space: nowrap;
        }
    </style>
</head>

<body>

{% if current_user.is_authenticated %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="{{ url_for('main.dashboard') }}">Logistica Nacom Goya</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">

        <!-- OPERACIONAL - Fluxo principal do dia a dia -->
        {% if current_user.is_authenticated and (current_user.tem_permissao('pedidos') or current_user.tem_permissao('separacao') or current_user.tem_permissao('embarques') or current_user.tem_permissao('monitoramento') or current_user.tem_permissao('portaria') or current_user.perfil == 'administrador' or current_user.perfil == 'logistica' or current_user.perfil == 'financeiro' or current_user.perfil == 'portaria') %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="menuOperacional" role="button" data-bs-toggle="dropdown">
            <i class="fas fa-tasks"></i> Operacional
          </a>
          <ul class="dropdown-menu">
            {% if current_user.tem_permissao('pedidos') or current_user.tem_permissao('separacao') or current_user.perfil == 'administrador' or current_user.perfil == 'logistica'  or current_user.perfil == 'financeiro'%}
            <li><h6 class="dropdown-header">üì¶ Pedidos e Separa√ß√£o</h6></li>
            {% if current_user.tem_permissao('pedidos', 'visualizar') or current_user.perfil == 'administrador' or current_user.perfil == 'logistica'  or current_user.perfil == 'financeiro'%}
            <li><a class="dropdown-item" href="{{ url_for('pedidos.lista_pedidos') }}">
              <i class="fas fa-list-alt"></i> Lista de Pedidos
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('separacao', 'visualizar') or current_user.perfil == 'administrador' or current_user.perfil == 'logistica'  or current_user.perfil == 'financeiro'%}
            <li><a class="dropdown-item" href="{{ url_for('separacao.listar') }}">
              <i class="fas fa-boxes"></i> Separa√ß√£o
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('separacao', 'importar') or current_user.perfil == 'administrador' or current_user.perfil == 'logistica' or current_user.perfil == 'financeiro'%}
            <li><a class="dropdown-item" href="{{ url_for('separacao.importar') }}">
              <i class="fas fa-upload"></i> Importar Separa√ß√£o
            </a></li>
            {% endif %}
            {% endif %}
            {% if current_user.tem_permissao('embarques') or current_user.tem_permissao('portaria') or current_user.perfil == 'administrador' or current_user.perfil == 'logistica' or current_user.perfil == 'portaria' or current_user.perfil == 'financeiro'%}
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header">üöõ Embarques</h6></li>
            {% if current_user.tem_permissao('embarques', 'visualizar') or current_user.perfil == 'administrador' or current_user.perfil == 'logistica' or current_user.perfil == 'portaria' or current_user.perfil == 'financeiro'%}
            <li><a class="dropdown-item" href="{{ url_for('embarques.listar_embarques') }}">
              <i class="fas fa-shipping-fast"></i> Listar Embarques
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('portaria', 'visualizar') or current_user.pode_acessar_portaria() or current_user.perfil == 'administrador' or current_user.perfil == 'logistica' or current_user.perfil == 'portaria' or current_user.perfil == 'financeiro'%}
            <li><a class="dropdown-item" href="{{ url_for('portaria.dashboard') }}">
              <i class="fas fa-truck"></i> Controle de Portaria
            </a></li>
            {% endif %}
            {% endif %}
            {% if current_user.tem_permissao('monitoramento') or current_user.pode_acessar_monitoramento_geral() or current_user.pode_acessar_monitoramento_vendedor() or current_user.perfil == 'administrador' or current_user.perfil == 'logistica' or current_user.perfil == 'financeiro'%}
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header">üìã Monitoramento</h6></li>
            {% if current_user.tem_permissao('monitoramento', 'visualizar') or current_user.pode_acessar_monitoramento_geral() or current_user.pode_acessar_monitoramento_vendedor() or current_user.perfil == 'administrador' or current_user.perfil == 'logistica' or current_user.perfil == 'financeiro'%}
            <li><a class="dropdown-item" href="{{ url_for('monitoramento.listar_entregas') }}">
              <i class="fas fa-eye"></i> Entregas Monitoradas
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('portaria', 'historico') or current_user.pode_acessar_portaria() or current_user.perfil == 'administrador' or current_user.perfil == 'logistica' or current_user.perfil == 'portaria' or current_user.perfil == 'financeiro'%}
            <li><a class="dropdown-item" href="{{ url_for('portaria.historico') }}">
              <i class="fas fa-history"></i> Hist√≥rico da Portaria
            </a></li>
            {% endif %}
            {% endif %}
          </ul>
        </li>
        {% endif %}

        <!-- FINANCEIRO - Gest√£o financeira -->
        {% if current_user.is_authenticated and (current_user.tem_permissao('fretes') or current_user.tem_permissao('financeiro') or current_user.tem_permissao('faturamento') or current_user.pode_acessar_financeiro() or current_user.perfil == 'administrador') %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="menuFinanceiro" role="button" data-bs-toggle="dropdown">
            <i class="fas fa-dollar-sign"></i> Financeiro
          </a>
          <ul class="dropdown-menu">
            {% if current_user.tem_permissao('fretes') or current_user.pode_acessar_financeiro() or current_user.perfil == 'administrador' %}
            <li><h6 class="dropdown-header">üí∞ Fretes</h6></li>
            {% if current_user.tem_permissao('fretes', 'visualizar') or current_user.pode_acessar_financeiro() or current_user.perfil == 'administrador' %}
            <li><a class="dropdown-item" href="{{ url_for('fretes.index') }}">
              <i class="fas fa-tachometer-alt"></i> Dashboard Fretes
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('fretes.listar_fretes') }}">
              <i class="fas fa-list"></i> Listar Fretes
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('fretes', 'lancar') or current_user.pode_editar('fretes') or current_user.perfil == 'administrador' %}
            <li><a class="dropdown-item" href="{{ url_for('fretes.lancar_cte') }}">
              <i class="fas fa-plus-circle"></i> Lan√ßar CTe
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('fretes', 'aprovar') or current_user.perfil in ['administrador', 'financeiro', 'gerente_comercial'] %}
            <li><a class="dropdown-item" href="{{ url_for('fretes.listar_aprovacoes') }}">
              <i class="fas fa-check-circle"></i> Aprova√ß√µes
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('fretes', 'faturas') or current_user.pode_acessar_financeiro() or current_user.perfil == 'administrador' %}
            <li><a class="dropdown-item" href="{{ url_for('fretes.listar_faturas') }}">
              <i class="fas fa-file-pdf"></i> Faturas de Frete
            </a></li>
            {% endif %}
            {% endif %}
            {% if current_user.tem_permissao('financeiro') or current_user.tem_permissao('faturamento') or current_user.pode_acessar_financeiro() or current_user.perfil == 'administrador' %}
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header">üíº Financeiro</h6></li>
            {% if current_user.tem_permissao('faturamento', 'visualizar') or current_user.pode_acessar_financeiro() or current_user.perfil == 'administrador' %}
            <li><a class="dropdown-item" href="{{ url_for('faturamento.listar_relatorios') }}">
              <i class="fas fa-chart-line"></i> Relat√≥rio de Faturamento
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('financeiro', 'pendencias') or current_user.pode_acessar_financeiro() or current_user.perfil == 'administrador' %}
            <li><a class="dropdown-item" href="{{ url_for('financeiro.consultar_pendencias') }}">
              <i class="fas fa-exclamation-triangle"></i> Pend√™ncias Financeiras
            </a></li>
            {% endif %}
            {% endif %}
          </ul>
        </li>
        {% endif %}

        <!-- CADASTROS - Dados mestres -->
        {% if current_user.is_authenticated and (current_user.tem_permissao('cadastros') or current_user.tem_permissao('transportadoras') or current_user.tem_permissao('tabelas') or current_user.pode_editar_cadastros() or current_user.perfil == 'administrador') %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="menuCadastros" role="button" data-bs-toggle="dropdown">
            <i class="fas fa-database"></i> Cadastros
          </a>
          <ul class="dropdown-menu">
            {% if current_user.tem_permissao('cadastros') or current_user.pode_editar_cadastros() or current_user.perfil == 'administrador' %}
            <li><h6 class="dropdown-header">‚öôÔ∏è Cadastros</h6></li>
            {% if current_user.tem_permissao('transportadoras', 'editar') or current_user.pode_editar_cadastros() or current_user.perfil == 'administrador' %}
            <li><a class="dropdown-item" href="{{ url_for('transportadoras.cadastrar_transportadora') }}">
              <i class="fas fa-truck"></i> Transportadoras
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('portaria', 'motoristas') or current_user.pode_editar_cadastros() or current_user.perfil == 'administrador' %}
            <li><a class="dropdown-item" href="{{ url_for('portaria.cadastrar_motorista') }}">
              <i class="fas fa-user-plus"></i> Cadastrar Motorista
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('portaria.listar_motoristas') }}">
              <i class="fas fa-users"></i> Listar Motoristas
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('localidades', 'editar') or current_user.pode_editar_cadastros() or current_user.perfil == 'administrador' %}
            <li><a class="dropdown-item" href="{{ url_for('localidades.cadastrar_cidade') }}">
              <i class="fas fa-map-marker-alt"></i> Cidades
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('veiculos', 'administrar') or current_user.pode_editar_cadastros() or current_user.perfil == 'administrador' %}
            <li><a class="dropdown-item" href="{{ url_for('veiculos.admin_veiculos') }}">
              <i class="fas fa-truck"></i> Administrar Ve√≠culos
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('agendamento', 'visualizar') or current_user.pode_editar_cadastros() or current_user.perfil == 'administrador' %}
            <li><a class="dropdown-item" href="{{ url_for('cadastros_agendamento.listar_contatos') }}">
              <i class="fas fa-calendar-alt"></i> Agendamento
            </a></li>
            {% endif %}
            {% endif %}
            {% if current_user.tem_permissao('tabelas') or current_user.pode_acessar_financeiro() or current_user.perfil == 'administrador' %}
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header">üìä Tabelas de Frete</h6></li>
            <li><a class="dropdown-item" href="{{ url_for('tabelas.cadastrar_tabela_frete') }}">
              <i class="fas fa-table"></i> Cadastro de Tabelas
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('tabelas.importar_tabela_frete') }}">
              <i class="fas fa-upload"></i> Importar Tabelas
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('tabelas.listar_todas_tabelas') }}">
              <i class="fas fa-eye"></i> Consulta de Tabelas
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('tabelas.historico_tabelas') }}">
              <i class="fas fa-history"></i> Hist√≥rico de Tabelas
            </a></li>
            {% endif %}
          </ul>
        </li>
        {% endif %}

        <!-- CONSULTAS - Informa√ß√µes e an√°lises -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="menuConsultas" role="button" data-bs-toggle="dropdown">
            <i class="fas fa-search"></i> Consultas
          </a>
          <ul class="dropdown-menu">
            <li><h6 class="dropdown-header">üîç Consultas</h6></li>
            <li><a class="dropdown-item" href="{{ url_for('fretes.listar_fretes') }}">
              <i class="fas fa-search"></i> Buscar Fretes
            </a></li>

            <li><a class="dropdown-item" href="{{ url_for('vinculos.consulta_vinculos') }}">
              <i class="fas fa-link"></i> Consulta de V√≠nculos
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header">üì• Importa√ß√µes</h6></li>
            <li><a class="dropdown-item" href="{{ url_for('cadastros_agendamento.importar_contatos') }}">
              <i class="fas fa-calendar-plus"></i> Agendamento
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('vinculos.importar_vinculos') }}">
              <i class="fas fa-link"></i> V√≠nculos
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('financeiro.importar_pendencias') }}">
              <i class="fas fa-file-import"></i> Pend√™ncias Financeiras
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('faturamento.listar_relatorios') }}">
              <i class="fas fa-file-upload"></i> Relat√≥rio de Faturamento
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('tagplus.pagina_importacao') }}">
              <i class="fas fa-sync"></i> TagPlus
            </a></li>
          </ul>
        </li>

        <!-- CARTEIRA & PRODU√á√ÉO - M√≥dulos de carteira de pedidos -->
        {% if current_user.is_authenticated and (current_user.tem_permissao('carteira') or current_user.tem_permissao('producao') or current_user.tem_permissao('estoque') or current_user.tem_permissao('rotas') or current_user.perfil == 'administrador' or current_user.perfil == 'logistica') %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="menuCarteira" role="button" data-bs-toggle="dropdown">
            <i class="fas fa-industry text-success"></i> Carteira & Estoque
          </a>
          <ul class="dropdown-menu">
            {% if current_user.tem_permissao('carteira', 'edit') or current_user.tem_permissao('producao') or current_user.tem_permissao('estoque') or current_user.perfil == 'logistica' or current_user.perfil == 'administrador' %}
            <li><h6 class="dropdown-header">üìä Dashboards</h6></li>
            {% if current_user.tem_permissao('carteira', 'visualizar') or current_user.perfil == 'administrador' or current_user.perfil == 'logistica'%}
            <li><a class="dropdown-item" href="{{ url_for('carteira.index') }}">
              <i class="fas fa-shopping-cart text-success"></i> Carteira de Pedidos
              <span class="badge bg-success ms-2">NOVO</span>
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('producao', 'visualizar') or current_user.perfil == 'administrador' or current_user.perfil == 'logistica'%}
            <li><a class="dropdown-item" href="{{ url_for('producao.index') }}">
              <i class="fas fa-tachometer-alt text-primary"></i> Dashboard Produ√ß√£o
            </a></li>
            {% endif %}
            {% if current_user.tem_permissao('estoque', 'visualizar') or current_user.perfil == 'administrador' or current_user.perfil == 'logistica'%}
            <li><a class="dropdown-item" href="{{ url_for('estoque.index') }}">
              <i class="fas fa-warehouse text-info"></i> Dashboard Estoque
            </a></li>
            {% endif %}
            {% endif %}
            
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header">üè≠ Produ√ß√£o</h6></li>
            <li><a class="dropdown-item" href="{{ url_for('producao.listar_programacao') }}">
              <i class="fas fa-calendar-check"></i> Programa√ß√£o de Produ√ß√£o
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('producao.listar_palletizacao') }}">
              <i class="fas fa-cubes"></i> Cadastro de Palletiza√ß√£o
            </a></li>
            
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header">üì¶ Estoque</h6></li>
            <li><a class="dropdown-item" href="{{ url_for('estoque.listar_movimentacoes') }}">
              <i class="fas fa-exchange-alt"></i> Movimenta√ß√µes de Estoque
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('estoque.saldo_estoque') }}">
              <i class="fas fa-chart-line text-success"></i> Saldo de Estoque
              <span class="badge bg-primary ms-2">NOVO</span>
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('estoque.listar_unificacao_codigos') }}">
              <i class="fas fa-link text-warning"></i> Unifica√ß√£o de C√≥digos
            </a></li>
            
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header">üí∞ Faturamento</h6></li>
            <li><a class="dropdown-item" href="{{ url_for('faturamento.dashboard_faturamento') }}">
              <i class="fas fa-receipt"></i> Faturamento por Produto
            </a></li>
            
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header">üó∫Ô∏è Rotas</h6></li>
            <li><a class="dropdown-item" href="{{ url_for('localidades.listar_rotas') }}">
              <i class="fas fa-route"></i> Cadastro de Rotas
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('localidades.listar_sub_rotas') }}">
              <i class="fas fa-map-marker-alt"></i> Cadastro de Sub-rotas
            </a></li>
          </ul>
        </li>
        {% endif %}


        <!-- USU√ÅRIOS - Gest√£o de usu√°rios (baseado em permiss√µes) -->
        {% if current_user.is_authenticated and (current_user.pode_aprovar_usuarios() or current_user.tem_permissao('usuarios') or current_user.tem_permissao('admin')) %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="menuUsuarios" role="button" data-bs-toggle="dropdown">
            <i class="fas fa-users"></i> Usu√°rios
          </a>
          <ul class="dropdown-menu">
            {% if current_user.pode_aprovar_usuarios() or current_user.tem_permissao('usuarios', 'aprovar') %}
            <li><h6 class="dropdown-header">üë§ Gest√£o de Usu√°rios</h6></li>
            <li><a class="dropdown-item" href="{{ url_for('auth.usuarios_pendentes') }}">
              <i class="fas fa-user-clock text-warning"></i> Pendentes de Aprova√ß√£o
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('auth.listar_usuarios') }}">
              <i class="fas fa-users"></i> Todos os Usu√°rios
            </a></li>
            {% endif %}
            
            {% if current_user.perfil in ['administrador', 'gerente_comercial'] %}
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header">üîê Permiss√µes</h6></li>
            <li><a class="dropdown-item" href="{{ url_for('permissions.vendedores_vanilla') }}">
              <i class="fas fa-users-cog text-info"></i> Vendedores e Equipes
            </a></li>
            {% endif %}
            
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('auth.registro') }}" target="_blank">
              <i class="fas fa-external-link-alt"></i> Link de Registro P√∫blico
            </a></li>
          </ul>
        </li>
        {% endif %}
        
        <!-- Claude AI -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="menuClaudeAI" role="button" data-bs-toggle="dropdown" title="Claude AI - Intelig√™ncia Artificial">
            <i class="fas fa-brain text-info"></i> Claude AI
          </a>
          <ul class="dropdown-menu">
            <li><h6 class="dropdown-header">üß† Intelig√™ncia Artificial</h6></li>
            <li><a class="dropdown-item" href="{{ url_for('claude_ai.claude_real') }}">
              <i class="fas fa-brain text-primary"></i> Claude 4 Sonnet
              <span class="badge bg-success ms-2">PRINCIPAL</span>
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('claude_ai.dashboard_executivo') }}">
              <i class="fas fa-tachometer-alt text-warning"></i> Dashboard Executivo
              <span class="badge bg-success ms-2">PRINCIPAL</span>
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('claude_ai.claude_real') }}?mode=analytics">
              <i class="fas fa-chart-bar"></i> An√°lises Avan√ßadas
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('mcp_logistica.index') }}">
              <i class="fas fa-truck text-primary"></i> MCP Log√≠stica
              <span class="badge bg-primary ms-2">NOVO</span>
            </a></li>
            <li><a class="dropdown-item" href="/MANUAL_ATALHOS_CLAUDE.md" target="_blank">
              <i class="fas fa-book text-info"></i> Manual de Atalhos
              <span class="badge bg-info ms-2">GUIA</span>
            </a></li>
          </ul>
        </li>
        
        <!-- Logout -->
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('auth.logout') }}">Sair</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
{% endif %}

<div class="container mt-3">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<!-- Carregamento de bibliotecas principais ANTES do conte√∫do -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Bloco de conte√∫do das p√°ginas -->
{% block content %}{% endblock %}

<!-- ü§ñ CLAUDE AI WIDGET - Inclu√≠do em todas as p√°ginas -->
{% if current_user.is_authenticated %}
  {% include 'claude_ai/widget.html' %}
{% endif %}

<!-- Scripts adicionais -->
<script>
  $(document).ready(function(){
    // Configura√ß√£o do toastr
    toastr.options = {
      "closeButton": true,
      "progressBar": true,
      "positionClass": "toast-top-right",
      "timeOut": "4000"
    };
    
    // Aplica m√°scara apenas para campos de texto (n√£o tipo date)
    $('input[name="data_embarque"]').not('[type="date"]').mask('00/00/0000');
  });
</script>

<!-- ‚úÖ Inclua claramente aqui o HTMX -->
<script src="https://unpkg.com/htmx.org@1.9.11"></script>
<script>
  document.addEventListener("htmx:configRequest", function(event) {
    const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    if (token) {
      event.detail.headers['X-CSRFToken'] = token;
    }
  });
  
  // ‚úÖ TRATAMENTO ROBUSTO para erros CSRF
  document.addEventListener("htmx:responseError", function(event) {
    if (event.detail.xhr.status === 400) {
      const responseText = event.detail.xhr.responseText.toLowerCase();
      if (responseText.includes('csrf') || responseText.includes('token') || responseText.includes('missing')) {
        console.log('üîí Erro CSRF detectado, recarregando p√°gina...');
        alert('üîí Sess√£o de seguran√ßa expirou. Recarregando p√°gina...');
        window.location.reload();
        return;
      }
      
      try {
        const response = JSON.parse(event.detail.xhr.responseText);
        if (response.csrf_error) {
          alert(response.message);
          window.location.reload();
          return;
        }
      } catch (e) {}
    }
  });
  
  // ‚úÖ FUNC√á√ÉO GLOBAL para obter token CSRF
  function getCSRFToken() {
    // Primeiro tenta pegar do meta tag
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) {
      return metaToken.getAttribute('content');
    }
    
    // Fallback: busca em formul√°rios existentes
    const formToken = document.querySelector('input[name="csrf_token"]');
    if (formToken) {
      return formToken.value;
    }
    
    return null;
  }
  
  // ‚úÖ FUN√á√ÉO para regenerar token CSRF via AJAX
  function regenerateCSRFToken() {
    return fetch('/auth/regenerate_csrf', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    }).then(response => response.json()).then(data => {
      if (data.csrf_token) {
        // Atualiza meta tag
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
          metaTag.setAttribute('content', data.csrf_token);
        }
        
        // Atualiza todos os inputs de CSRF
        document.querySelectorAll('input[name="csrf_token"]').forEach(input => {
          input.value = data.csrf_token;
        });
        
        return data.csrf_token;
      }
      return null;
    }).catch(error => {
      console.error('Erro ao regenerar token CSRF:', error);
      return null;
    });
  }
  
  // ‚úÖ INTERCEPTOR ROBUSTO de formul√°rios para garantir CSRF
  document.addEventListener('submit', function(event) {
    const form = event.target;
    let csrfInput = form.querySelector('input[name="csrf_token"]');
    
    // Se n√£o tem input CSRF, cria um automaticamente
    if (!csrfInput) {
      csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrf_token';
      form.appendChild(csrfInput);
    }
    
    // Se input existe mas est√° vazio, preenche
    if (!csrfInput.value) {
      const token = getCSRFToken();
      if (token) {
        csrfInput.value = token;
        console.log('üîí Token CSRF adicionado automaticamente ao formul√°rio');
      } else {
        event.preventDefault();
        console.error('üîí Token CSRF n√£o encontrado, recarregando...');
        alert('‚ö†Ô∏è Sua sess√£o de seguran√ßa expirou. A p√°gina ser√° recarregada.');
        window.location.reload();
        return;
      }
    }
  });
  
  // ‚úÖ INTERCEPTOR ROBUSTO para AJAX/Fetch incluir CSRF
  const originalFetch = window.fetch;
  window.fetch = function(...args) {
    const [url, options = {}] = args;
    
    // Adiciona CSRF para qualquer m√©todo POST, PUT, PATCH, DELETE
    if (options.method && ['POST', 'PUT', 'PATCH', 'DELETE'].includes(options.method.toUpperCase())) {
      options.headers = options.headers || {};
      
      const token = getCSRFToken();
      if (token) {
        // M√∫ltiplos headers para compatibilidade m√°xima
        options.headers['X-CSRFToken'] = token;
        options.headers['X-CSRF-Token'] = token;
        options.headers['HTTP_X_CSRF_TOKEN'] = token;
        
        // Se est√° enviando FormData, adiciona tamb√©m no body
        if (options.body instanceof FormData) {
          options.body.append('csrf_token', token);
        }
        
        console.log('üîí Token CSRF adicionado √† requisi√ß√£o AJAX');
      } else {
        console.warn('‚ö†Ô∏è Token CSRF n√£o encontrado para requisi√ß√£o AJAX');
      }
    }
    
    return originalFetch.apply(this, [url, options]);
  };
</script>

{% block scripts %}{% endblock %}
</body>
</html>

