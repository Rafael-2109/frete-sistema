{% extends "base.html" %}

{% block title %}Ensinar Claude - {{ pergunta.consulta[:50] }}...{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/claude-lite/trainer">IA Trainer</a></li>
                    <li class="breadcrumb-item active">Ensinar</li>
                </ol>
            </nav>
            <h4><i class="fas fa-graduation-cap me-2"></i>Ensinar o Claude</h4>
        </div>
    </div>

    <!-- Pergunta Original -->
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <i class="fas fa-question-circle me-2"></i>Pergunta Nao Respondida
        </div>
        <div class="card-body">
            <h5 class="mb-3">"{{ pergunta.consulta }}"</h5>
            <div class="row">
                <div class="col-md-3">
                    <small class="text-muted">Tipo:</small>
                    <span class="badge bg-info">{{ pergunta.tipo_pergunta or 'simples' }}</span>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Motivo:</small>
                    <span class="badge bg-secondary">{{ pergunta.motivo_falha }}</span>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Dimensoes:</small>
                    <span>{{ (pergunta.dimensoes_detectadas or [])|join(', ') or '-' }}</span>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Sugestao do sistema:</small>
                    <p class="small mb-0">{{ pergunta.sugestao_gerada or '-' }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Coluna Esquerda: Decomposicao -->
        <div class="col-lg-5">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-puzzle-piece me-2"></i>Decomposicao</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="sugerirDecomposicao()">
                        <i class="fas fa-magic"></i> Sugerir
                    </button>
                </div>
                <div class="card-body">
                    <p class="text-muted small">Decomponha a pergunta em partes e explique cada termo:</p>

                    <div id="partes-container">
                        <!-- Partes serao adicionadas aqui -->
                    </div>

                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="adicionarParte()">
                        <i class="fas fa-plus"></i> Adicionar Parte
                    </button>
                </div>
                <div class="card-footer">
                    <button class="btn btn-primary w-100" onclick="gerarCodigo()" id="btnGerar">
                        <i class="fas fa-cogs"></i> Gerar Codigo
                    </button>
                </div>
            </div>
        </div>

        <!-- Coluna Direita: Debate e Codigo -->
        <div class="col-lg-7">
            <!-- Area de Debate -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-comments me-2"></i>Debate com Claude
                </div>
                <div class="card-body" style="height: 300px; overflow-y: auto;" id="debate-container">
                    <p class="text-muted text-center">O debate aparecera aqui apos gerar o codigo</p>
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" class="form-control" id="inputDebate"
                               placeholder="Questione, refine ou ajuste o codigo..."
                               onkeypress="if(event.key==='Enter') enviarDebate()">
                        <button class="btn btn-outline-primary" onclick="enviarDebate()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Codigo Gerado -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-code me-2"></i>Codigo Gerado</span>
                    <div>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="testarCodigo()" id="btnTestar" disabled>
                            <i class="fas fa-flask"></i> Testar
                        </button>
                        <button class="btn btn-sm btn-success" onclick="ativarCodigo()" id="btnAtivar" disabled>
                            <i class="fas fa-check"></i> Ativar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <pre id="codigo-preview" class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
Nenhum codigo gerado ainda. Preencha a decomposicao e clique em "Gerar Codigo".
                    </pre>
                </div>
            </div>

            <!-- Resultado do Teste -->
            <div class="card d-none" id="card-teste">
                <div class="card-header">
                    <i class="fas fa-vial me-2"></i>Resultado do Teste
                </div>
                <div class="card-body">
                    <pre id="teste-resultado" class="mb-0"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template para parte da decomposicao -->
<template id="template-parte">
    <div class="parte-item border rounded p-3 mb-3">
        <div class="d-flex justify-content-between mb-2">
            <strong>Parte <span class="parte-numero">1</span></strong>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerParte(this)">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-2">
            <label class="form-label small">Texto/Termo:</label>
            <input type="text" class="form-control form-control-sm parte-texto" placeholder="Ex: item parcial pendente">
        </div>
        <div class="mb-2">
            <label class="form-label small">O que significa:</label>
            <textarea class="form-control form-control-sm parte-explicacao" rows="2"
                      placeholder="Explique o que esse termo significa no contexto do negocio..."></textarea>
        </div>
        <div class="row">
            <div class="col-6">
                <label class="form-label small">Tipo:</label>
                <select class="form-select form-select-sm parte-tipo">
                    <option value="">Selecione...</option>
                    <option value="filtro">Filtro (condicao)</option>
                    <option value="entidade">Entidade (cliente, produto...)</option>
                    <option value="conceito">Conceito (termo de negocio)</option>
                    <option value="acao">Acao (o que fazer)</option>
                </select>
            </div>
            <div class="col-6">
                <label class="form-label small">Campo/Model (opcional):</label>
                <input type="text" class="form-control form-control-sm parte-campo"
                       placeholder="Ex: raz_social_red">
            </div>
        </div>
    </div>
</template>

<script>
let sessaoId = null;
let codigoAtual = null;
const perguntaId = {{ pergunta.id }};

document.addEventListener('DOMContentLoaded', function() {
    iniciarSessao();
    adicionarParte(); // Adiciona primeira parte
});

async function iniciarSessao() {
    try {
        const resp = await fetch('/claude-lite/trainer/api/sessao/iniciar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pergunta_id: perguntaId })
        });
        const data = await resp.json();

        if (data.sucesso) {
            sessaoId = data.sessao.id;
            console.log('Sessao iniciada:', sessaoId);

            // Restaura estado se sessao existente
            if (data.sessao.decomposicao) {
                restaurarDecomposicao(data.sessao.decomposicao);
            }
            if (data.sessao.historico_debate) {
                restaurarDebate(data.sessao.historico_debate);
            }
        } else {
            alert('Erro ao iniciar sessao: ' + data.erro);
        }
    } catch (e) {
        console.error('Erro:', e);
    }
}

function adicionarParte() {
    const template = document.getElementById('template-parte');
    const container = document.getElementById('partes-container');
    const clone = template.content.cloneNode(true);

    const numero = container.children.length + 1;
    clone.querySelector('.parte-numero').textContent = numero;

    container.appendChild(clone);
}

function removerParte(btn) {
    btn.closest('.parte-item').remove();
    atualizarNumeros();
}

function atualizarNumeros() {
    document.querySelectorAll('.parte-item').forEach((item, idx) => {
        item.querySelector('.parte-numero').textContent = idx + 1;
    });
}

function coletarDecomposicao() {
    const partes = [];
    document.querySelectorAll('.parte-item').forEach(item => {
        const texto = item.querySelector('.parte-texto').value.trim();
        if (texto) {
            partes.push({
                parte: texto,
                explicacao: item.querySelector('.parte-explicacao').value.trim(),
                tipo: item.querySelector('.parte-tipo').value,
                campo: item.querySelector('.parte-campo').value.trim()
            });
        }
    });
    return partes;
}

function restaurarDecomposicao(decomposicao) {
    const container = document.getElementById('partes-container');
    container.innerHTML = '';

    decomposicao.forEach(parte => {
        adicionarParte();
        const item = container.lastElementChild;
        item.querySelector('.parte-texto').value = parte.parte || '';
        item.querySelector('.parte-explicacao').value = parte.explicacao || '';
        item.querySelector('.parte-tipo').value = parte.tipo || '';
        item.querySelector('.parte-campo').value = parte.campo || '';
    });
}

function restaurarDebate(historico) {
    const container = document.getElementById('debate-container');
    container.innerHTML = historico.map(msg => {
        const isUser = msg.role === 'usuario';
        return `
            <div class="mb-2 ${isUser ? 'text-end' : ''}">
                <span class="badge bg-${isUser ? 'primary' : 'secondary'} mb-1">
                    ${isUser ? 'Voce' : 'Claude'}
                </span>
                <div class="p-2 rounded ${isUser ? 'bg-primary text-white' : 'bg-light'}">
                    ${msg.content.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
    }).join('');
    container.scrollTop = container.scrollHeight;
}

async function sugerirDecomposicao() {
    if (!sessaoId) return;

    try {
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        const resp = await fetch(`/claude-lite/trainer/api/sessao/${sessaoId}/sugerir-decomposicao`, {
            method: 'POST'
        });
        const data = await resp.json();

        if (data.sucesso && data.sugestoes) {
            const container = document.getElementById('partes-container');
            container.innerHTML = '';

            data.sugestoes.forEach(sug => {
                adicionarParte();
                const item = container.lastElementChild;
                item.querySelector('.parte-texto').value = sug.parte || '';
                item.querySelector('.parte-explicacao').value = sug.explicacao_sugerida || '';
                item.querySelector('.parte-tipo').value = sug.tipo_sugerido || '';
                item.querySelector('.parte-campo').value = sug.campo_sugerido || '';
            });
        }

        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic"></i> Sugerir';
    } catch (e) {
        console.error('Erro:', e);
    }
}

async function gerarCodigo() {
    if (!sessaoId) return;

    const decomposicao = coletarDecomposicao();
    if (decomposicao.length === 0) {
        alert('Adicione pelo menos uma parte na decomposicao');
        return;
    }

    const btn = document.getElementById('btnGerar');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';

    try {
        // Salva decomposicao
        await fetch(`/claude-lite/trainer/api/sessao/${sessaoId}/decomposicao`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ decomposicao })
        });

        // Gera codigo
        const resp = await fetch(`/claude-lite/trainer/api/sessao/${sessaoId}/gerar`, {
            method: 'POST'
        });
        const data = await resp.json();

        if (data.sucesso) {
            codigoAtual = data;
            document.getElementById('codigo-preview').textContent = JSON.stringify(data, null, 2);
            document.getElementById('btnTestar').disabled = false;
            document.getElementById('btnAtivar').disabled = false;

            // Adiciona ao debate
            adicionarMensagemDebate('assistente', 'Codigo gerado com sucesso! Revise e teste antes de ativar.');
        } else {
            document.getElementById('codigo-preview').textContent = 'Erro: ' + (data.erro || 'Falha ao gerar');
            adicionarMensagemDebate('sistema', 'Erro na geracao: ' + data.erro);
        }
    } catch (e) {
        console.error('Erro:', e);
    }

    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-cogs"></i> Gerar Codigo';
}

async function enviarDebate() {
    const input = document.getElementById('inputDebate');
    const mensagem = input.value.trim();
    if (!mensagem || !sessaoId) return;

    input.value = '';
    adicionarMensagemDebate('usuario', mensagem);

    try {
        const resp = await fetch(`/claude-lite/trainer/api/sessao/${sessaoId}/debater`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mensagem })
        });
        const data = await resp.json();

        if (data.sucesso) {
            codigoAtual = data;
            document.getElementById('codigo-preview').textContent = JSON.stringify(data, null, 2);
            adicionarMensagemDebate('assistente', data.raciocinio || 'Codigo ajustado conforme feedback.');
        }
    } catch (e) {
        console.error('Erro:', e);
    }
}

function adicionarMensagemDebate(role, content) {
    const container = document.getElementById('debate-container');
    const isUser = role === 'usuario';

    container.innerHTML += `
        <div class="mb-2 ${isUser ? 'text-end' : ''}">
            <span class="badge bg-${isUser ? 'primary' : role === 'sistema' ? 'warning' : 'secondary'} mb-1">
                ${isUser ? 'Voce' : role === 'sistema' ? 'Sistema' : 'Claude'}
            </span>
            <div class="p-2 rounded ${isUser ? 'bg-primary text-white' : 'bg-light'}">
                ${content.replace(/\n/g, '<br>')}
            </div>
        </div>
    `;
    container.scrollTop = container.scrollHeight;
}

async function testarCodigo() {
    if (!sessaoId) return;

    const btn = document.getElementById('btnTestar');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
        const resp = await fetch(`/claude-lite/trainer/api/sessao/${sessaoId}/testar`, {
            method: 'POST'
        });
        const data = await resp.json();

        const card = document.getElementById('card-teste');
        const resultado = document.getElementById('teste-resultado');

        card.classList.remove('d-none');
        resultado.textContent = JSON.stringify(data, null, 2);
        resultado.className = data.sucesso ? 'text-success' : 'text-danger';

        if (data.sucesso) {
            adicionarMensagemDebate('sistema', 'Teste PASSOU! Codigo pronto para ativar.');
        } else {
            adicionarMensagemDebate('sistema', 'Teste FALHOU: ' + (data.erro || 'Verifique o resultado'));
        }
    } catch (e) {
        console.error('Erro:', e);
    }

    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-flask"></i> Testar';
}

async function ativarCodigo() {
    if (!sessaoId || !confirm('Tem certeza que deseja ativar este codigo?')) return;

    try {
        const resp = await fetch(`/claude-lite/trainer/api/sessao/${sessaoId}/ativar`, {
            method: 'POST'
        });
        const data = await resp.json();

        if (data.sucesso) {
            alert('Codigo ativado com sucesso!');
            window.location.href = '/claude-lite/trainer';
        } else {
            alert('Erro: ' + data.erro);
        }
    } catch (e) {
        console.error('Erro:', e);
    }
}
</script>
{% endblock %}
