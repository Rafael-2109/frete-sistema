{% extends "base.html" %}

{% block title %}Sessao #{{ sessao.id }} - IA Trainer{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/claude-lite/trainer">IA Trainer</a></li>
                    <li class="breadcrumb-item active">Sessao #{{ sessao.id }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Pergunta -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <i class="fas fa-question-circle me-2"></i>Pergunta Original
                </div>
                <div class="card-body">
                    <h5>"{{ sessao.pergunta_original }}"</h5>
                </div>
            </div>

            <!-- Decomposicao -->
            {% if sessao.decomposicao %}
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-puzzle-piece me-2"></i>Decomposicao
                </div>
                <div class="card-body">
                    {% for parte in sessao.decomposicao %}
                    <div class="border rounded p-3 mb-2">
                        <strong>{{ loop.index }}. "{{ parte.parte }}"</strong>
                        <p class="mb-1 text-muted">{{ parte.explicacao }}</p>
                        <span class="badge bg-info">{{ parte.tipo or '-' }}</span>
                        {% if parte.campo %}
                        <span class="badge bg-secondary">{{ parte.campo }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Debate -->
            {% if sessao.historico_debate %}
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-comments me-2"></i>Historico de Debate
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% for msg in sessao.historico_debate %}
                    <div class="mb-2 {% if msg.role == 'usuario' %}text-end{% endif %}">
                        <span class="badge bg-{% if msg.role == 'usuario' %}primary{% elif msg.role == 'sistema' %}warning{% else %}secondary{% endif %} mb-1">
                            {% if msg.role == 'usuario' %}Voce{% elif msg.role == 'sistema' %}Sistema{% else %}Claude{% endif %}
                        </span>
                        <div class="p-2 rounded {% if msg.role == 'usuario' %}bg-primary text-white{% else %}bg-light{% endif %}">
                            {{ msg.content | replace('\n', '<br>') | safe }}
                        </div>
                        <small class="text-muted">{{ msg.timestamp }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Codigo Gerado -->
            {% if sessao.codigo_gerado %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-code me-2"></i>Codigo Gerado
                </div>
                <div class="card-body">
                    <pre class="bg-dark text-light p-3 rounded">{{ sessao.codigo_gerado | tojson(indent=2) }}</pre>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <!-- Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-info-circle me-2"></i>Status
                </div>
                <div class="card-body">
                    <p>
                        <strong>Status:</strong>
                        <span class="badge bg-{% if sessao.status == 'ativada' %}success{% elif sessao.status == 'cancelada' %}danger{% else %}info{% endif %}">
                            {{ sessao.status }}
                        </span>
                    </p>
                    <p><strong>Criado por:</strong> {{ sessao.criado_por }}</p>
                    <p><strong>Criado em:</strong> {{ sessao.criado_em }}</p>
                    {% if sessao.solucao_criada %}
                    <p><strong>Solucao criada:</strong> <span class="badge bg-success">SIM</span></p>
                    {% endif %}
                </div>
            </div>

            <!-- Acoes -->
            {% if sessao.status not in ['ativada', 'cancelada'] %}
            <div class="card">
                <div class="card-header">Acoes</div>
                <div class="card-body">
                    <a href="/claude-lite/trainer/ensinar/{{ sessao.pergunta_origem_id }}" class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-edit"></i> Continuar Ensino
                    </a>
                    <button class="btn btn-outline-danger w-100" onclick="cancelarSessao()">
                        <i class="fas fa-times"></i> Cancelar Sessao
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
async function cancelarSessao() {
    if (!confirm('Tem certeza?')) return;

    try {
        await fetch('/claude-lite/trainer/api/sessao/{{ sessao.id }}/cancelar', { method: 'POST' });
        window.location.reload();
    } catch (e) {
        alert('Erro ao cancelar');
    }
}
</script>
{% endblock %}
