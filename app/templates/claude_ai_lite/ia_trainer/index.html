{% extends "base.html" %}

{% block title %}IA Trainer - Claude AI Lite{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-brain me-2"></i>IA Trainer</h2>
            <p class="text-muted">Ensine o Claude a responder novas perguntas</p>
        </div>
    </div>

    <!-- Estatisticas -->
    <div class="row mb-4" id="estatisticas">
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <h3 id="stat-pendentes">-</h3>
                    <small>Pendentes</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3 id="stat-compostas">-</h3>
                    <small>Compostas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3 id="stat-implementadas">-</h3>
                    <small>Implementadas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3 id="stat-total">-</h3>
                    <small>Total (7 dias)</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="trainerTabs">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#perguntas">
                <i class="fas fa-question-circle me-1"></i>Perguntas Nao Respondidas
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#sessoes">
                <i class="fas fa-chalkboard-teacher me-1"></i>Sessoes de Ensino
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#codigos">
                <i class="fas fa-code me-1"></i>Codigos Gerados
            </a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Perguntas -->
        <div class="tab-pane fade show active" id="perguntas">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Perguntas que o sistema nao conseguiu responder</span>
                    <select id="filtroStatus" class="form-select form-select-sm" style="width: auto;">
                        <option value="pendente">Pendentes</option>
                        <option value="todas">Todas</option>
                        <option value="implementado">Implementadas</option>
                    </select>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="tabelaPerguntas">
                            <thead class="table-light">
                                <tr>
                                    <th>Pergunta</th>
                                    <th>Tipo</th>
                                    <th>Motivo</th>
                                    <th>Dimensoes</th>
                                    <th>Data</th>
                                    <th>Acoes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="text-center py-4">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sessoes -->
        <div class="tab-pane fade" id="sessoes">
            <div class="card">
                <div class="card-header">Sessoes de Ensino em Andamento</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="tabelaSessoes">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Pergunta</th>
                                    <th>Status</th>
                                    <th>Criado por</th>
                                    <th>Data</th>
                                    <th>Acoes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="text-center py-4">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Codigos -->
        <div class="tab-pane fade" id="codigos">
            <div class="card">
                <div class="card-header">Codigos Gerados pelo IA Trainer</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="tabelaCodigos">
                            <thead class="table-light">
                                <tr>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th>Dominio</th>
                                    <th>Gatilhos</th>
                                    <th>Ativo</th>
                                    <th>Acoes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="text-center py-4">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    carregarEstatisticas();
    carregarPerguntas();
    carregarSessoes();
    carregarCodigos();

    document.getElementById('filtroStatus').addEventListener('change', carregarPerguntas);
});

async function carregarEstatisticas() {
    try {
        const resp = await fetch('/claude-lite/trainer/api/perguntas/estatisticas');
        const data = await resp.json();

        if (data.sucesso) {
            document.getElementById('stat-pendentes').textContent =
                (data.por_motivo?.sem_capacidade || 0) + (data.por_motivo?.sem_criterio || 0);
            document.getElementById('stat-compostas').textContent =
                data.por_tipo?.composta || 0;
            document.getElementById('stat-implementadas').textContent =
                data.por_motivo?.implementado || 0;
            document.getElementById('stat-total').textContent = data.total || 0;
        }
    } catch (e) {
        console.error('Erro ao carregar estatisticas:', e);
    }
}

async function carregarPerguntas() {
    const status = document.getElementById('filtroStatus').value;
    const tbody = document.querySelector('#tabelaPerguntas tbody');

    try {
        const resp = await fetch(`/claude-lite/trainer/api/perguntas?status=${status}&limite=50`);
        const data = await resp.json();

        if (!data.sucesso || !data.perguntas.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Nenhuma pergunta encontrada</td></tr>';
            return;
        }

        tbody.innerHTML = data.perguntas.map(p => `
            <tr>
                <td style="max-width: 300px;">
                    <span class="text-truncate d-block" title="${p.consulta}">${p.consulta}</span>
                </td>
                <td><span class="badge bg-${p.tipo_pergunta === 'composta' ? 'info' : 'secondary'}">${p.tipo_pergunta || 'simples'}</span></td>
                <td><span class="badge bg-warning text-dark">${p.motivo_falha}</span></td>
                <td>${(p.dimensoes_detectadas || []).join(', ') || '-'}</td>
                <td>${new Date(p.criado_em).toLocaleDateString('pt-BR')}</td>
                <td>
                    <a href="/claude-lite/trainer/ensinar/${p.id}" class="btn btn-sm btn-primary">
                        <i class="fas fa-graduation-cap"></i> Ensinar
                    </a>
                </td>
            </tr>
        `).join('');
    } catch (e) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-danger">Erro ao carregar</td></tr>';
    }
}

async function carregarSessoes() {
    const tbody = document.querySelector('#tabelaSessoes tbody');

    try {
        const resp = await fetch('/claude-lite/trainer/api/sessoes?limite=20');
        const data = await resp.json();

        if (!data.sucesso || !data.sessoes.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Nenhuma sessao encontrada</td></tr>';
            return;
        }

        const statusColors = {
            'iniciada': 'secondary',
            'decomposta': 'info',
            'codigo_gerado': 'primary',
            'em_debate': 'warning',
            'testando': 'info',
            'validada': 'success',
            'ativada': 'success',
            'cancelada': 'danger'
        };

        tbody.innerHTML = data.sessoes.map(s => `
            <tr>
                <td>${s.id}</td>
                <td style="max-width: 250px;">
                    <span class="text-truncate d-block">${s.pergunta_original}</span>
                </td>
                <td><span class="badge bg-${statusColors[s.status] || 'secondary'}">${s.status}</span></td>
                <td>${s.criado_por}</td>
                <td>${new Date(s.criado_em).toLocaleDateString('pt-BR')}</td>
                <td>
                    <a href="/claude-lite/trainer/sessao/${s.id}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i> Ver
                    </a>
                </td>
            </tr>
        `).join('');
    } catch (e) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-danger">Erro ao carregar</td></tr>';
    }
}

async function carregarCodigos() {
    const tbody = document.querySelector('#tabelaCodigos tbody');

    try {
        const resp = await fetch('/claude-lite/trainer/api/codigos?limite=50');
        const data = await resp.json();

        if (!data.sucesso || !data.codigos.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Nenhum codigo gerado ainda</td></tr>';
            return;
        }

        tbody.innerHTML = data.codigos.map(c => `
            <tr>
                <td><code>${c.nome}</code></td>
                <td><span class="badge bg-info">${c.tipo_codigo}</span></td>
                <td>${c.dominio || '-'}</td>
                <td>${(c.gatilhos || []).slice(0, 3).join(', ')}</td>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" ${c.ativo ? 'checked' : ''}
                               onchange="toggleCodigo(${c.id})">
                    </div>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" onclick="verCodigo(${c.id})">
                        <i class="fas fa-code"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (e) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-danger">Erro ao carregar</td></tr>';
    }
}

async function toggleCodigo(id) {
    try {
        await fetch(`/claude-lite/trainer/api/codigos/${id}/toggle`, { method: 'POST' });
    } catch (e) {
        alert('Erro ao alterar status');
    }
}

function verCodigo(id) {
    alert('Funcionalidade em desenvolvimento');
}
</script>
{% endblock %}
