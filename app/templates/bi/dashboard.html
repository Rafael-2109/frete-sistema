<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI Fretes - Dashboard Principal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        .kpi-card {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .kpi-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        .variation-positive {
            color: #27ae60;
        }
        .variation-negative {
            color: #e74c3c;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        .navbar-bi {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .section-title {
            border-left: 4px solid #667eea;
            padding-left: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-bi">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up"></i> BI Fretes
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="/bi/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/bi/transportadoras">Transportadoras</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/bi/regional">Análise Regional</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/bi/despesas">Despesas Extras</a>
                    </li>
                </ul>
                <div class="ms-auto">
                    <button class="btn btn-outline-light btn-sm" onclick="executarETL()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar Dados
                    </button>
                    <span class="text-white ms-3" id="ultimo-update"></span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- KPIs Principais -->
        <h4 class="section-title">Indicadores Principais</h4>
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="kpi-label">Custo Total Frete</div>
                                <div class="kpi-value" id="kpi-custo-total">R$ 0</div>
                                <small class="variation-positive" id="kpi-custo-var">
                                    <i class="bi bi-arrow-up"></i> 0%
                                </small>
                            </div>
                            <i class="bi bi-truck text-primary" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="kpi-label">Custo por KG</div>
                                <div class="kpi-value" id="kpi-custo-kg">R$ 0</div>
                                <small class="text-muted" id="kpi-peso-total">0 kg</small>
                            </div>
                            <i class="bi bi-box-seam text-info" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="kpi-label">Despesas Extras</div>
                                <div class="kpi-value" id="kpi-despesas">R$ 0</div>
                                <small class="text-warning" id="kpi-despesas-perc">0% do total</small>
                            </div>
                            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="kpi-label">Economia Realizada</div>
                                <div class="kpi-value text-success" id="kpi-economia">R$ 0</div>
                                <small class="text-muted">Cotado vs Pago</small>
                            </div>
                            <i class="bi bi-piggy-bank text-success" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row">
            <!-- Evolução Mensal -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up text-primary"></i> Evolução Mensal de Custos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chartEvolucao"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Transportadoras -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-trophy text-warning"></i> Top Transportadoras
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="ranking-transportadoras">
                            <!-- Preenchido via JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Segunda linha de gráficos -->
        <div class="row mt-4">
            <!-- Distribuição Regional -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-geo-alt text-info"></i> Distribuição Regional
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chartRegional"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tipos de Despesas -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-pie-chart text-danger"></i> Tipos de Despesas Extras
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chartDespesas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela Resumo -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-table text-secondary"></i> Resumo por Transportadora (Mês Atual)
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportarDados()">
                            <i class="bi bi-download"></i> Exportar
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="tabela-resumo">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Transportadora</th>
                                        <th>Valor Total</th>
                                        <th>Peso (kg)</th>
                                        <th>Custo/kg</th>
                                        <th>Despesas</th>
                                        <th>% Despesas</th>
                                        <th>Dias Ativos</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-resumo">
                                    <!-- Preenchido via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Variáveis globais para os gráficos
        let chartEvolucao, chartRegional, chartDespesas;

        // Função para formatar valores em Reais
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        // Função para formatar números
        function formatarNumero(numero) {
            return new Intl.NumberFormat('pt-BR').format(numero);
        }

        // Carregar indicadores principais
        function carregarIndicadores() {
            $.ajax({
                url: '/bi/api/indicadores-principais',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log('Indicadores carregados:', data);
                    $('#kpi-custo-total').text(formatarMoeda(data.custo_total || 0));
                    $('#kpi-custo-kg').text(formatarMoeda(data.custo_medio_kg || 0));
                    $('#kpi-peso-total').text(formatarNumero(data.peso_total || 0) + ' kg');
                    $('#kpi-despesas').text(formatarMoeda(data.despesas_total || 0));
                    $('#kpi-economia').text(formatarMoeda(Math.abs(data.economia_realizada || 0)));

                    // Calcula percentual de despesas
                    if (data.custo_total > 0) {
                        let percDespesas = (data.despesas_total / data.custo_total * 100).toFixed(1);
                        $('#kpi-despesas-perc').text(percDespesas + '% do total');
                    }

                    // Variação do mês
                    if (data.variacao_mes > 0) {
                        $('#kpi-custo-var').html('<i class="bi bi-arrow-up"></i> ' + data.variacao_mes.toFixed(1) + '%');
                        $('#kpi-custo-var').removeClass('variation-positive').addClass('variation-negative');
                    } else if (data.variacao_mes < 0) {
                        $('#kpi-custo-var').html('<i class="bi bi-arrow-down"></i> ' + Math.abs(data.variacao_mes).toFixed(1) + '%');
                        $('#kpi-custo-var').removeClass('variation-negative').addClass('variation-positive');
                    } else {
                        $('#kpi-custo-var').html('0%');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao carregar indicadores:', error);
                    console.error('Response:', xhr.responseText);
                    // Usar valores padrão em caso de erro
                    $('#kpi-custo-total').text('R$ 0,00');
                    $('#kpi-custo-kg').text('R$ 0,00');
                    $('#kpi-peso-total').text('0 kg');
                    $('#kpi-despesas').text('R$ 0,00');
                    $('#kpi-economia').text('R$ 0,00');
                }
            });
        }

        // Carregar gráfico de evolução
        function carregarEvolucao() {
            $.get('/bi/api/evolucao-mensal', function(data) {
                const ctx = document.getElementById('chartEvolucao').getContext('2d');
                
                if (chartEvolucao) {
                    chartEvolucao.destroy();
                }
                
                chartEvolucao = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.periodo),
                        datasets: [{
                            label: 'Custo Total',
                            data: data.map(d => d.custo_total),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Despesas Extras',
                            data: data.map(d => d.despesas),
                            borderColor: '#f093fb',
                            backgroundColor: 'rgba(240, 147, 251, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatarMoeda(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatarMoeda(value);
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }

        // Carregar ranking de transportadoras
        function carregarRanking() {
            $.get('/bi/api/ranking-transportadoras?periodo=mes', function(data) {
                let html = '';
                data.slice(0, 5).forEach(function(item) {
                    let badge = '';
                    if (item.ranking === 1) badge = '<span class="badge bg-warning">🥇</span>';
                    else if (item.ranking === 2) badge = '<span class="badge bg-secondary">🥈</span>';
                    else if (item.ranking === 3) badge = '<span class="badge bg-danger">🥉</span>';
                    
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                ${badge}
                                <span class="fw-bold">${item.ranking}º</span>
                                ${item.transportadora}
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">${formatarMoeda(item.valor_total)}</div>
                                <small class="text-muted">${formatarMoeda(item.custo_kg)}/kg</small>
                            </div>
                        </div>
                    `;
                });
                $('#ranking-transportadoras').html(html);
                
                // Preenche tabela
                let tbody = '';
                data.forEach(function(item) {
                    tbody += `
                        <tr>
                            <td>${item.ranking}</td>
                            <td>${item.transportadora}</td>
                            <td>${formatarMoeda(item.valor_total)}</td>
                            <td>${formatarNumero(item.peso_total)}</td>
                            <td>${formatarMoeda(item.custo_kg)}</td>
                            <td>${formatarMoeda(item.despesas)}</td>
                            <td>
                                <span class="badge ${item.percentual_despesas > 5 ? 'bg-danger' : 'bg-success'}">
                                    ${item.percentual_despesas.toFixed(1)}%
                                </span>
                            </td>
                            <td>${item.dias_ativos}</td>
                        </tr>
                    `;
                });
                $('#tbody-resumo').html(tbody);
            });
        }

        // Carregar análise regional
        function carregarRegional() {
            $.get('/bi/api/analise-regional', function(data) {
                const ctx = document.getElementById('chartRegional').getContext('2d');
                
                if (chartRegional) {
                    chartRegional.destroy();
                }
                
                chartRegional = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.regiao),
                        datasets: [{
                            label: 'Custo Total',
                            data: data.map(d => d.custo_total),
                            backgroundColor: [
                                '#667eea',
                                '#f093fb',
                                '#4facfe',
                                '#43e97b',
                                '#fa709a'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return formatarMoeda(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatarMoeda(value);
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }

        // Carregar tipos de despesas
        function carregarDespesas() {
            $.get('/bi/api/despesas-por-tipo', function(data) {
                const ctx = document.getElementById('chartDespesas').getContext('2d');
                
                if (chartDespesas) {
                    chartDespesas.destroy();
                }
                
                chartDespesas = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(d => d.tipo),
                        datasets: [{
                            data: data.map(d => d.valor),
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF',
                                '#FF9F40',
                                '#FF6384',
                                '#C9CBCF'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + formatarMoeda(context.parsed);
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }

        // Executar ETL
        function executarETL() {
            if (confirm('Deseja executar a atualização dos dados agora? Isso pode levar alguns minutos.')) {
                // Mostrar loading
                $('#btn-atualizar').prop('disabled', true).html('<i class="bi bi-arrow-clockwise"></i> Atualizando...');

                $.ajax({
                    url: '/bi/api/executar-etl',
                    type: 'POST',
                    dataType: 'json',
                    success: function(data) {
                        if (data.sucesso) {
                            alert('Dados atualizados com sucesso!');
                            location.reload();
                        } else {
                            alert('Erro ao atualizar dados: ' + (data.mensagem || 'Erro desconhecido'));
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Erro ao executar ETL:', error);
                        alert('Erro ao executar atualização. Verifique o console para mais detalhes.');
                    },
                    complete: function() {
                        $('#btn-atualizar').prop('disabled', false).html('<i class="bi bi-arrow-clockwise"></i> Atualizar Dados');
                    }
                });
            }
        }

        // Exportar dados
        function exportarDados() {
            // Implementar exportação CSV
            alert('Funcionalidade de exportação em desenvolvimento');
        }

        // Verificar status ETL
        function verificarStatusETL() {
            $.get('/bi/api/status-etl', function(data) {
                if (data.ultimo_processamento) {
                    let ultimaData = new Date(data.ultimo_processamento);
                    $('#ultimo-update').html(
                        '<i class="bi bi-clock"></i> Última atualização: ' + 
                        ultimaData.toLocaleDateString('pt-BR') + ' ' +
                        ultimaData.toLocaleTimeString('pt-BR')
                    );
                }
            });
        }

        // Carregar todos os dados ao iniciar
        $(document).ready(function() {
            carregarIndicadores();
            carregarEvolucao();
            carregarRanking();
            carregarRegional();
            carregarDespesas();
            verificarStatusETL();
            
            // Atualizar a cada 5 minutos
            setInterval(function() {
                carregarIndicadores();
                verificarStatusETL();
            }, 300000);
        });
    </script>
</body>
</html>