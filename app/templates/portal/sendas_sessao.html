{% extends "base.html" %}

{% block title %}Gerenciar Sess√£o Sendas - Portal{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>üîê Gerenciador de Sess√£o - Portal Sendas</h2>
            <hr>
            
            <!-- Status da Sess√£o -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üìä Status da Sess√£o</h5>
                </div>
                <div class="card-body">
                    <div id="status-container">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Instru√ß√µes -->
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">üìã Como Capturar os Cookies</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-3">
                        <strong>‚ö†Ô∏è Aten√ß√£o: Cookies de Terceiros</strong><br>
                        Se voc√™ vir avisos sobre "Third-party cookie will be blocked":<br>
                        ‚Ä¢ V√° em Chrome ‚Üí Configura√ß√µes ‚Üí Privacidade ‚Üí Cookies<br>
                        ‚Ä¢ Escolha "Permitir todos os cookies" temporariamente<br>
                        ‚Ä¢ Ou adicione <code>[*.]trizy.com.br</code> como exce√ß√£o
                    </div>
                    
                    <ol>
                        <li><strong>Abra o Chrome</strong> (n√£o use modo an√¥nimo)</li>
                        <li><strong>Acesse:</strong> <a href="https://login.trizy.com.br/access/auth/login/" target="_blank">https://login.trizy.com.br/access/auth/login/</a></li>
                        <li><strong>Fa√ßa login normalmente</strong> (resolva o captcha manualmente)</li>
                        <li><strong>Ap√≥s logar, pressione F12</strong> para abrir o DevTools</li>
                        <li><strong>V√° para aba Console</strong></li>
                        <li><strong>Cole e execute</strong> o c√≥digo abaixo:</li>
                    </ol>
                    
                    <div class="bg-dark text-white p-3 rounded mb-3">
                        <code id="capture-script">
// Script melhorado para capturar TODOS os dados de autentica√ß√£o
const captureData = {
    // Cookies em formato array com atributos
    cookies: document.cookie.split('; ').map(c => {
        const [name, ...value] = c.split('=');
        return {
            name: name,
            value: value.join('='),
            domain: '.trizy.com.br', // Importante para subdom√≠nios
            path: '/',
            secure: true,
            httpOnly: false,
            sameSite: 'None' // Permite cross-site
        };
    }),
    // Cookies raw para backup
    cookiesRaw: document.cookie,
    // Todos os storages
    localStorage: {},
    sessionStorage: {},
    tokens: {},
    // Informa√ß√µes do contexto
    domain: window.location.hostname,
    url: window.location.href,
    timestamp: new Date().toISOString()
};

// Capturar localStorage completo
Object.keys(localStorage).forEach(key => {
    captureData.localStorage[key] = localStorage.getItem(key);
    if (key.toLowerCase().includes('token') || 
        key.toLowerCase().includes('auth') || 
        key.toLowerCase().includes('bearer') ||
        key.toLowerCase().includes('jwt')) {
        captureData.tokens[key] = localStorage.getItem(key);
    }
});

// Capturar sessionStorage completo
Object.keys(sessionStorage).forEach(key => {
    captureData.sessionStorage[key] = sessionStorage.getItem(key);
    if (key.toLowerCase().includes('token') || 
        key.toLowerCase().includes('auth') || 
        key.toLowerCase().includes('bearer') ||
        key.toLowerCase().includes('jwt')) {
        captureData.tokens[key] = sessionStorage.getItem(key);
    }
});

// Copiar para √°rea de transfer√™ncia
copy(JSON.stringify(captureData));

// Logs detalhados
console.log('‚úÖ Dados capturados e copiados!');
console.log('üìä Resumo:');
console.log('  ‚Ä¢ Cookies:', captureData.cookies.length, 'items');
console.log('  ‚Ä¢ LocalStorage:', Object.keys(captureData.localStorage).length, 'items');
console.log('  ‚Ä¢ SessionStorage:', Object.keys(captureData.sessionStorage).length, 'items');
console.log('  ‚Ä¢ Tokens:', Object.keys(captureData.tokens).length, 'items');
console.log('  ‚Ä¢ URL:', captureData.url);
console.log('\nüî¥ IMPORTANTE: Cole (Ctrl+V) no formul√°rio abaixo!');
                        </code>
                    </div>
                    
                    <button class="btn btn-sm btn-secondary" onclick="copyScript()">üìã Copiar C√≥digo</button>
                    
                    <div class="alert alert-info mt-3">
                        <strong>7.</strong> Ap√≥s executar o c√≥digo, <strong>cole (Ctrl+V)</strong> o resultado no campo abaixo
                    </div>
                </div>
            </div>
            
            <!-- Formul√°rio para Colar Dados -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üìù Colar Dados Capturados</h5>
                </div>
                <div class="card-body">
                    <form id="session-form">
                        <div class="form-group">
                            <label for="captured-data">Cole aqui os dados capturados:</label>
                            <textarea 
                                class="form-control" 
                                id="captured-data" 
                                rows="10" 
                                placeholder='Cole aqui o JSON capturado ou apenas os cookies no formato: "cookie1=valor1; cookie2=valor2"'
                            ></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-success btn-block">
                                    üíæ Salvar Sess√£o
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-info btn-block" onclick="testarSessao()">
                                    üß™ Testar Sess√£o
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-danger btn-block" onclick="limparSessao()">
                                    üóëÔ∏è Limpar Sess√£o
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Logs -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">üìú Logs</h5>
                </div>
                <div class="card-body">
                    <div id="logs" class="bg-dark text-white p-3 rounded" style="height: 200px; overflow-y: auto;">
                        <small>Aguardando a√ß√µes...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Vari√°veis globais
let logContainer = document.getElementById('logs');

// Fun√ß√£o para adicionar log
function addLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const color = {
        'info': 'hsl(188, 78%, 41%)',
        'success': 'hsl(134, 61%, 41%)',
        'error': 'hsl(354, 70%, 54%)',
        'warning': 'hsl(45, 100%, 51%)'
    }[type] || 'hsl(210, 9%, 51%)';

    logContainer.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
    logContainer.scrollTop = logContainer.scrollHeight;
}

// Copiar script de captura
function copyScript() {
    const script = document.getElementById('capture-script').textContent;
    navigator.clipboard.writeText(script).then(() => {
        alert('‚úÖ C√≥digo copiado! Cole no Console do Chrome (F12)');
        addLog('Script de captura copiado', 'info');
    });
}

// Carregar status ao iniciar
document.addEventListener('DOMContentLoaded', function() {
    carregarStatus();
    
    // Form submit
    document.getElementById('session-form').addEventListener('submit', function(e) {
        e.preventDefault();
        salvarSessao();
    });
});

// Carregar status da sess√£o
function carregarStatus() {
    fetch('/portal/sendas/sessao/status')
        .then(response => response.json())
        .then(data => {
            let statusHtml = '';
            
            if (data.exists) {
                const ageClass = data.age_minutes < 60 ? 'success' : 
                               data.age_minutes < 240 ? 'warning' : 'danger';
                
                statusHtml = `
                    <div class="row">
                        <div class="col-md-3">
                            <div class="alert alert-${ageClass}">
                                <strong>Status:</strong> Sess√£o Ativa
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="alert alert-info">
                                <strong>Idade:</strong> ${Math.round(data.age_minutes)} min
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="alert alert-info">
                                <strong>Cookies:</strong> ${data.cookies_count}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="alert alert-info">
                                <strong>Tokens:</strong> ${data.has_tokens ? '‚úÖ' : '‚ùå'}
                            </div>
                        </div>
                    </div>
                    <small class="text-muted">√öltima atualiza√ß√£o: ${data.timestamp}</small>
                `;
                
                addLog(`Sess√£o carregada: ${data.cookies_count} cookies, idade: ${Math.round(data.age_minutes)} min`, 'info');
            } else {
                statusHtml = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Nenhuma sess√£o salva</strong><br>
                        Siga as instru√ß√µes acima para capturar uma nova sess√£o.
                    </div>
                `;
                addLog('Nenhuma sess√£o encontrada', 'warning');
            }
            
            document.getElementById('status-container').innerHTML = statusHtml;
        })
        .catch(error => {
            document.getElementById('status-container').innerHTML = `
                <div class="alert alert-danger">
                    <strong>Erro ao carregar status:</strong> ${error.message}
                </div>
            `;
            addLog(`Erro ao carregar status: ${error.message}`, 'error');
        });
}

// Salvar sess√£o
function salvarSessao() {
    const rawData = document.getElementById('captured-data').value.trim();
    
    if (!rawData) {
        alert('‚ùå Por favor, cole os dados capturados');
        return;
    }
    
    let dataToSend = {};
    
    try {
        // Tentar fazer parse como JSON
        const parsed = JSON.parse(rawData);
        dataToSend = parsed;
        addLog(`Dados JSON parseados: ${parsed.cookies ? 'cookies encontrados' : 'formato personalizado'}`, 'info');
    } catch {
        // Se n√£o for JSON, assumir que s√£o cookies diretos
        dataToSend = {
            cookies: rawData,
            tokens: {},
            localStorage: {}
        };
        addLog('Dados tratados como cookies diretos', 'info');
    }
    
    // Enviar para o servidor
    fetch('/portal/sendas/sessao/salvar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dataToSend)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.message}`);
            addLog(data.message, 'success');
            document.getElementById('captured-data').value = '';
            carregarStatus();
        } else {
            alert(`‚ùå Erro: ${data.message}`);
            addLog(`Erro ao salvar: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        alert(`‚ùå Erro: ${error.message}`);
        addLog(`Erro ao salvar: ${error.message}`, 'error');
    });
}

// Testar sess√£o
function testarSessao() {
    addLog('Testando sess√£o...', 'info');
    
    fetch('/portal/sendas/sessao/testar', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.message}`);
            addLog(data.message, 'success');
        } else {
            alert(`‚ùå ${data.message}`);
            addLog(data.message, 'error');
        }
    })
    .catch(error => {
        alert(`‚ùå Erro ao testar: ${error.message}`);
        addLog(`Erro ao testar: ${error.message}`, 'error');
    });
}

// Limpar sess√£o
function limparSessao() {
    if (!confirm('‚ö†Ô∏è Tem certeza que deseja limpar a sess√£o salva?')) {
        return;
    }
    
    fetch('/portal/sendas/sessao/limpar', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.message}`);
            addLog(data.message, 'success');
            carregarStatus();
        } else {
            alert(`‚ùå ${data.message}`);
            addLog(`Erro: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        alert(`‚ùå Erro: ${error.message}`);
        addLog(`Erro ao limpar: ${error.message}`, 'error');
    });
}

// Auto-refresh status a cada 30 segundos
setInterval(carregarStatus, 30000);
</script>

<style>
code {
    font-family: 'Courier New', monospace;
    font-size: 12px;
    white-space: pre;
    display: block;
    overflow-x: auto;
}
</style>
{% endblock %}