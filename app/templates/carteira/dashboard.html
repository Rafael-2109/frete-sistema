{% extends "base.html" %}

{% block title %}Carteira de Pedidos - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Principal -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-clipboard-list text-accent"></i>
                Carteira de Pedidos
            </h1>
            <p class="text-muted mb-0">Sistema central de gestão da carteira</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalRelatorios">
                <i class="fas fa-file-excel"></i> Relatórios
            </button>
            <a href="{{ url_for('carteira.alertas_visualizacao.dashboard') }}" class="btn btn-outline-secondary btn-sm position-relative">
                <i class="fas fa-bell"></i> Alertas
                {% if alertas_pendentes_count and alertas_pendentes_count > 0 %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    {{ alertas_pendentes_count }}
                </span>
                {% endif %}
            </a>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalPedidosNaoOdoo">
                <i class="fas fa-file-import"></i> Não-Odoo
            </button>
            <a href="{{ url_for('leitura_pedidos.index') }}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-file-pdf"></i> Importar PDF
            </a>
            <a href="{{ url_for('portal.central_portais') }}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-globe"></i> Portais
            </a>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalClientesRedeSP">
                <i class="fas fa-network-wired"></i> Rede SP
            </button>
            <a href="{{ url_for('carteira.listar_pedidos_agrupados') }}" class="btn btn-primary btn-sm">
                <i class="fas fa-boxes"></i> Carteira Agrupada
            </a>
            <a href="{{ url_for('carteira.carteira_simples.index') }}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-list"></i> Simplificada
            </a>
        </div>
    </div>

    <!-- Cards de Estatísticas -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small text-uppercase text-muted mb-1">Total de Pedidos</div>
                            <h4 class="mb-0">{{ estatisticas.total_pedidos or 0 }}</h4>
                        </div>
                        <i class="fas fa-shopping-cart fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small text-uppercase text-muted mb-1">Produtos Únicos</div>
                            <h4 class="mb-0">{{ estatisticas.total_produtos or 0 }}</h4>
                        </div>
                        <i class="fas fa-boxes fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small text-uppercase text-muted mb-1">Total de Itens</div>
                            <h4 class="mb-0">{{ estatisticas.total_itens or 0 }}</h4>
                        </div>
                        <i class="fas fa-list fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stat-card stat-card-accent h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small text-uppercase text-muted mb-1">Valor Total</div>
                            <h4 class="mb-0 text-accent">R$ {{ "{:,.2f}".format(estatisticas.valor_total or 0) }}</h4>
                        </div>
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Pedidos Programados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header card-header-theme py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 fw-bold">
                            <i class="fas fa-calendar-check text-accent"></i> Pedidos Programados
                        </h6>
                        <div id="totais-programados" class="text-end">
                            <small>
                                <span class="badge badge-status">
                                    <span id="qtd-separacoes">0</span> Separações
                                </span>
                                <span class="badge badge-status badge-status-accent ms-2">
                                    R$ <span id="valor-total-separacoes">0,00</span>
                                </span>
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body py-2">
                    <!-- Grid Horizontal de Datas -->
                    <div class="table-responsive" style="max-height: 120px; overflow-x: auto;">
                        <table class="table table-sm table-bordered mb-0" style="font-size: 0.75rem;">
                            <thead class="table-light">
                                <tr id="datas-header">
                                    <!-- Preenchido via JavaScript -->
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="valores-row">
                                    <!-- Preenchido via JavaScript -->
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-1">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> Valores de Separações (status COTADO/ABERTO) por data de expedição
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações Rápidas - SEMPRE VISÍVEL -->
    <div class="row mb-4">
        <!-- Top Vendedores (apenas se houver dados) -->
        {% if top_vendedores %}
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header card-header-theme py-3">
                    <h6 class="m-0 fw-bold">
                        <i class="fas fa-user-tie text-accent"></i> Top Vendedores
                    </h6>
                </div>
                <div class="card-body">
                    {% for vendedor in top_vendedores[:5] %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ vendedor.vendedor or 'N/A' }}</span>
                        <div class="text-end">
                            <small class="text-muted">{{ vendedor.quantidade }} itens</small><br>
                            <strong class="text-accent">R$ {{ "{:,.0f}".format(vendedor.valor or 0) }}</strong>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Saldo Standby -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header card-header-theme py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold">
                        <i class="fas fa-pause-circle text-accent"></i> Saldo Standby
                    </h6>
                    <a href="{{ url_for('carteira.standby.visualizar_standby') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-eye"></i> Visualizar
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="small text-uppercase text-muted mb-1">
                                Total de Pedidos
                            </div>
                            <div class="h5 mb-2 fw-bold">
                                {{ total_standby_pedidos }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="small text-uppercase text-muted mb-1">
                                Valor Total
                            </div>
                            <div class="h5 mb-2 fw-bold text-accent">
                                R$ {{ "{:,.0f}".format(total_standby_valor) }}
                            </div>
                        </div>
                    </div>
                    {% if standby_stats %}
                    <hr>
                    <small class="text-muted">Por Status:</small>
                    {% for stat in standby_stats %}
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="badge badge-status
                            {% if stat.status_standby == 'ATIVO' %}badge-status-aprovado
                            {% elif stat.status_standby == 'BLOQ. COML.' %}badge-status-pendente
                            {% elif stat.status_standby == 'SALDO' %}badge-status-lancado
                            {% endif %}">
                            {{ stat.status_standby }}
                        </span>
                        <div class="text-end">
                            <small class="text-muted">{{ stat.qtd_pedidos }} pedidos</small>
                            <strong class="ms-2 text-accent">R$ {{ "{:,.0f}".format(stat.valor_total or 0) }}</strong>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        
        <!-- Ações Rápidas sempre visíveis -->
        <div class="col-lg-12 mt-3">
            <div class="card">
                <div class="card-header card-header-theme py-3">
                    <h6 class="m-0 fw-bold">
                        <i class="fas fa-cogs text-accent"></i> Ações Rápidas
                    </h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="/estoque/" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">
                                    <i class="fas fa-sync-alt text-accent"></i>
                                    Sincronização com Odoo
                                </h6>
                                <span class="badge badge-status">Seguro</span>
                            </div>
                            <p class="mb-1">Sincronizar carteira e faturamento com sequência automática</p>
                            <small class="text-muted">Executa Faturamento → Carteira automaticamente</small>
                        </a>

                        <a href="/faturamento/" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">
                                    <i class="fas fa-file-invoice text-accent"></i>
                                    Gerenciar Faturamento
                                </h6>
                                <span class="badge badge-status badge-status-aprovado">Ativo</span>
                            </div>
                            <p class="mb-1">Acessar dashboard de faturamento e relatórios</p>
                            <small class="text-muted">Visualizar dados importados e processar NFs</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sistema não inicializado -->
    {% if not sistema_inicializado %}
    <div class="row">
        <div class="col-lg-12">
            <div class="card stat-card border-start border-warning border-3">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col me-2">
                            <div class="small fw-bold text-warning text-uppercase mb-1">
                                Sistema de Carteira de Pedidos
                            </div>
                            <div class="h5 mb-2 fw-bold">
                                Aguardando primeira importação
                            </div>
                            <p class="text-muted mb-3">
                                O sistema está pronto para receber dados. Importe sua primeira carteira de pedidos para começar.
                            </p>
                            <!-- Botão Importar Primeira Carteira removido - funcionalidade desativada -->
                            <!-- Botão Baixar Modelo removido - funcionalidade desativada -->
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-list fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Seção do Workspace de Montagem -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card stat-card-accent">
                <div class="card-header card-header-theme py-3">
                    <h6 class="m-0 fw-bold">
                        <i class="fas fa-boxes text-accent"></i> Workspace de Montagem de Carga - v2.0
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <p class="text-muted mb-3">
                                Sistema avançado de pré-separação com interface drag & drop,
                                permitindo montagem inteligente de cargas com controle total de estoque.
                            </p>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="fw-bold text-accent">Principais Funcionalidades</h6>
                                    <ul class="list-unstyled text-sm">
                                        <li><i class="fas fa-check-circle text-accent me-2"></i> Drag & Drop intuitivo</li>
                                        <li><i class="fas fa-check-circle text-accent me-2"></i> Pré-separações persistentes</li>
                                        <li><i class="fas fa-check-circle text-accent me-2"></i> Validação de estoque em tempo real</li>
                                        <li><i class="fas fa-check-circle text-accent me-2"></i> Cardex D0-D28 integrado</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="fw-bold">Benefícios</h6>
                                    <ul class="list-unstyled text-sm">
                                        <li><i class="fas fa-arrow-up text-muted me-2"></i> Agilidade na separação</li>
                                        <li><i class="fas fa-shield-alt text-muted me-2"></i> Controle de rastreabilidade</li>
                                        <li><i class="fas fa-chart-line text-muted me-2"></i> Otimização de cargas</li>
                                        <li><i class="fas fa-clock text-muted me-2"></i> Redução de tempo operacional</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <a href="{{ url_for('carteira.listar_pedidos_agrupados') }}" class="btn btn-primary">
                                    <i class="fas fa-boxes"></i> Acessar Workspace
                                </a>
                                <a href="/static/DOCUMENTACAO_MODULO_CARTEIRA.md" target="_blank" class="btn btn-outline-secondary">
                                    <i class="fas fa-book"></i> Documentação
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="workspace-preview p-3">
                                <i class="fas fa-desktop fa-4x text-accent mb-3"></i>
                                <h6 class="fw-bold text-accent">Interface Moderna</h6>
                                <p class="text-muted small">
                                    Sistema modular com arquitetura JavaScript ES6+,
                                    APIs RESTful e interface responsiva.
                                </p>
                                <div class="badge-container">
                                    <span class="badge badge-status">Drag & Drop</span>
                                    <span class="badge badge-status">APIs REST</span>
                                    <span class="badge badge-status">Bootstrap 5</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Pedidos Não-Odoo -->
<div class="modal fade" id="modalPedidosNaoOdoo" tabindex="-1" aria-labelledby="modalPedidosNaoOdooLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPedidosNaoOdooLabel">
                    <i class="fas fa-file-import text-accent"></i> Gestão de Pedidos Não-Odoo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">
                    Sistema para importação e gestão de pedidos que não vêm do Odoo.
                    Permite cadastrar clientes, importar pedidos via Excel e gerenciar a carteira Não-Odoo.
                </p>

                <div class="row">
                    <!-- Cadastro de Cliente -->
                    <div class="col-md-4 mb-3">
                        <a href="{{ url_for('carteira.views_nao_odoo.cadastro_cliente') }}" class="action-card h-100">
                            <i class="fas fa-user-plus fa-2x"></i>
                            <h6 class="mt-2 mb-1">Cadastro de Cliente</h6>
                            <small class="text-muted text-center">Cadastre novos clientes Não-Odoo</small>
                        </a>
                    </div>

                    <!-- Importação de Pedidos -->
                    <div class="col-md-4 mb-3">
                        <a href="{{ url_for('carteira.views_nao_odoo.importacao_carteira') }}" class="action-card h-100">
                            <i class="fas fa-file-excel fa-2x"></i>
                            <h6 class="mt-2 mb-1">Importação de Pedidos</h6>
                            <small class="text-muted text-center">Importe via planilhas Excel</small>
                        </a>
                    </div>

                    <!-- Carteira Não-Odoo -->
                    <div class="col-md-4 mb-3">
                        <a href="{{ url_for('carteira.views_nao_odoo.carteira_nao_odoo') }}" class="action-card h-100">
                            <i class="fas fa-clipboard-list fa-2x"></i>
                            <h6 class="mt-2 mb-1">Carteira Não-Odoo</h6>
                            <small class="text-muted text-center">Visualize e gerencie pedidos</small>
                        </a>
                    </div>
                </div>

                <div class="alert alert-secondary mt-3" role="alert">
                    <i class="fas fa-info-circle"></i>
                    <strong>Nota:</strong> Os pedidos importados serão adicionados tanto na CarteiraCopia (para controle)
                    quanto na CarteiraPrincipal (para operação normal).
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Script de Relatórios -->
<script src="{{ url_for('static', filename='carteira/js/modal-relatorios.js') }}"></script>

<!-- Script para Pedidos Programados -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para carregar dados de separações programadas
    async function carregarPedidosProgramados() {
        try {
            const response = await fetch('/carteira/api/separacoes-programadas');
            const data = await response.json();
            
            if (data.success) {
                // Atualizar totais
                document.getElementById('qtd-separacoes').textContent = data.total_quantidade || 0;
                document.getElementById('valor-total-separacoes').textContent = 
                    new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2 }).format(data.total_valor || 0);
                
                // Preencher grid de datas
                preencherGridDatas(data.por_data || {});
            }
        } catch (error) {
            console.error('Erro ao carregar pedidos programados:', error);
        }
    }
    
    // Função para preencher o grid horizontal de datas
    function preencherGridDatas(dadosPorData) {
        const datasHeader = document.getElementById('datas-header');
        const valoresRow = document.getElementById('valores-row');
        
        // Limpar conteúdo anterior
        datasHeader.innerHTML = '';
        valoresRow.innerHTML = '';
        
        // Calcular range de datas (D-4 até D+10)
        const hoje = new Date();
        const datas = [];
        
        for (let i = -4; i <= 10; i++) {
            const data = new Date(hoje);
            data.setDate(hoje.getDate() + i);
            datas.push(data);
        }
        
        // Preencher cabeçalho e valores
        datas.forEach(data => {
            const dataStr = data.toISOString().split('T')[0];
            const diaMes = `${String(data.getDate()).padStart(2, '0')}/${String(data.getMonth() + 1).padStart(2, '0')}`;
            
            // Adicionar célula de data
            const thData = document.createElement('th');
            thData.className = 'text-center';
            thData.style.minWidth = '70px';
            
            // Destacar hoje
            if (data.toDateString() === hoje.toDateString()) {
                thData.innerHTML = `<span class="badge badge-status badge-status-accent">${diaMes}</span>`;
            } else if (data < hoje) {
                thData.innerHTML = `<small class="text-muted">${diaMes}</small>`;
            } else {
                thData.innerHTML = `<small>${diaMes}</small>`;
            }
            datasHeader.appendChild(thData);
            
            // Adicionar célula de valor
            const tdValor = document.createElement('td');
            tdValor.className = 'text-center';
            
            const valor = dadosPorData[dataStr] || 0;
            if (valor > 0) {
                const valorFormatado = new Intl.NumberFormat('pt-BR', {
                    notation: 'compact',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 1
                }).format(valor);

                // Colorir baseado no valor usando classes semânticas
                let badgeClass = 'badge-status';
                if (valor > 100000) badgeClass = 'badge-status badge-status-aprovado';
                else if (valor > 50000) badgeClass = 'badge-status badge-status-accent';
                else if (valor > 20000) badgeClass = 'badge-status badge-status-lancado';

                tdValor.innerHTML = `<small class="badge ${badgeClass}">R$ ${valorFormatado}</small>`;
            } else {
                tdValor.innerHTML = '<small class="text-muted">-</small>';
            }
            valoresRow.appendChild(tdValor);
        });
    }
    
    // Carregar dados ao iniciar
    carregarPedidosProgramados();
    
    // Recarregar a cada 5 minutos
    setInterval(carregarPedidosProgramados, 300000);
});
</script>

<!-- Modal Clientes Rede SP -->
<div class="modal fade" id="modalClientesRedeSP" tabindex="-1" aria-labelledby="modalClientesRedeSPLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalClientesRedeSPLabel">
                    <i class="fas fa-network-wired text-accent"></i> Selecione a Rede SP
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('carteira.programacao_em_lote.listar', rede='atacadao') }}" class="action-card h-100 py-4">
                            <i class="fas fa-shopping-cart fa-2x"></i>
                            <strong class="mt-2">Atacadão SP</strong>
                        </a>
                    </div>
                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('carteira.programacao_em_lote.listar', rede='sendas') }}" class="action-card h-100 py-4">
                            <i class="fas fa-store fa-2x"></i>
                            <strong class="mt-2">Sendas SP</strong>
                        </a>
                    </div>
                </div>
                <div class="alert alert-secondary mt-3">
                    <i class="fas fa-info-circle"></i>
                    <small>Selecione a rede para visualizar e programar pedidos em lote de clientes localizados em São Paulo.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %} 
