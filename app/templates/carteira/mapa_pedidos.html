<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Mapa de Pedidos - Sistema Frete</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        /* Estilos do Mapa */
        #map {
            height: calc(100vh - 200px);
            width: 100%;
            min-height: 500px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        /* Controles do Mapa */
        .map-controls {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-btn {
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* Painel Lateral */
        .side-panel {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 350px;
            max-height: calc(100vh - 250px);
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .side-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            position: sticky;
            top: 0;
            z-index: 1001;
        }
        
        .side-panel-content {
            padding: 15px;
        }
        
        /* Lista de Pedidos */
        .pedido-item {
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pedido-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .pedido-item.selected {
            background: #667eea;
            color: white;
        }
        
        .pedido-item.agendado {
            border-left-color: #28a745;
        }
        
        .pedido-item.urgente {
            border-left-color: #ffc107;
        }
        
        .pedido-item.atrasado {
            border-left-color: #dc3545;
        }
        
        /* InfoWindow Customizado */
        .info-window {
            min-width: 300px;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }
        
        .info-window-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            margin: -10px -10px 10px -10px;
            border-radius: 4px 4px 0 0;
        }
        
        .info-window-content {
            padding: 10px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        
        .info-value {
            color: #212529;
        }
        
        /* Estatísticas */
        .stats-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }
        
        /* Legenda do Mapa */
        .map-legend {
            position: absolute;
            bottom: 30px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            border-radius: 8px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .side-panel {
                width: 100%;
                right: 0;
                left: 0;
                top: auto;
                bottom: 0;
                max-height: 50vh;
                border-radius: 20px 20px 0 0;
            }
            
            #map {
                height: 60vh;
            }
        }
        
        /* Botão Flutuante */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
        
        .fab-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .fab-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }
        
        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: none;
        }
        
        .fab-menu.active {
            display: block;
        }
        
        .fab-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .fab-option:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2><i class="fas fa-map-marked-alt"></i> Visualização de Pedidos no Mapa</h2>
                    <div>
                        <button class="btn btn-secondary" onclick="window.history.back()">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controles do Mapa -->
        <div class="row">
            <div class="col-12">
                <div class="map-controls">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <button class="btn btn-primary control-btn" onclick="carregarPedidos()">
                                <i class="fas fa-sync"></i> Atualizar
                            </button>
                            <button class="btn btn-success control-btn" onclick="calcularRotaOtimizada()">
                                <i class="fas fa-route"></i> Rota Otimizada
                            </button>
                            <button class="btn btn-info control-btn" onclick="mostrarDensidade()">
                                <i class="fas fa-chart-pie"></i> Densidade
                            </button>
                            <button class="btn btn-warning control-btn" onclick="calcularMatrizDistancias()">
                                <i class="fas fa-table"></i> Matriz
                            </button>
                            <button class="btn btn-secondary control-btn" onclick="alternarClustering()">
                                <i class="fas fa-object-group"></i> Clustering
                            </button>
                            <button class="btn btn-dark control-btn" onclick="exportarDados()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                        <div class="col-md-4 text-end">
                            <select class="form-select d-inline-block w-auto" id="tipoMapa" onchange="mudarTipoMapa(this.value)">
                                <option value="roadmap">Ruas</option>
                                <option value="satellite">Satélite</option>
                                <option value="hybrid">Híbrido</option>
                                <option value="terrain">Terreno</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Estatísticas -->
        <div class="row mb-3">
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stat-value" id="totalPedidos">0</div>
                    <div class="stat-label">Total Pedidos</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stat-value" id="valorTotal">R$ 0</div>
                    <div class="stat-label">Valor Total</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stat-value" id="pesoTotal">0 kg</div>
                    <div class="stat-label">Peso Total</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stat-value" id="palletTotal">0</div>
                    <div class="stat-label">Pallets Total</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card bg-info text-white">
                    <div class="stat-value" id="veiculoSelecionado">-</div>
                    <div class="stat-label">Veículo Ideal</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card bg-warning text-dark">
                    <div class="stat-value" id="pedagioEstimado">R$ 0</div>
                    <div class="stat-label">Pedágio Estimado</div>
                </div>
            </div>
        </div>
        
        <!-- Mapa Container -->
        <div class="row">
            <div class="col-12 position-relative">
                <div id="map"></div>
                
                <!-- Loading Overlay -->
                <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
                
                <!-- Painel Lateral -->
                <div class="side-panel" id="sidePanel" style="display: none;">
                    <div class="side-panel-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Pedidos no Mapa</h5>
                            <button class="btn btn-sm btn-light" onclick="toggleSidePanel()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="side-panel-content" id="pedidosList">
                        <!-- Lista de pedidos será inserida aqui -->
                    </div>
                </div>
                
                <!-- Legenda -->
                <div class="map-legend" id="mapLegend">
                    <h6>Legenda</h6>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #28a745;"></div>
                        <span>Agendado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffc107;"></div>
                        <span>Urgente</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dc3545;"></div>
                        <span>Atrasado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #007bff;"></div>
                        <span>Normal</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Botão Flutuante -->
    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <button class="fab-option" onclick="centralizarMapa()" title="Centralizar">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="fab-option" onclick="toggleFullscreen()" title="Tela Cheia">
                <i class="fas fa-expand"></i>
            </button>
            <button class="fab-option" onclick="tirarScreenshot()" title="Screenshot">
                <i class="fas fa-camera"></i>
            </button>
        </div>
        <button class="fab-btn" onclick="toggleFabMenu()">
            <i class="fas fa-plus"></i>
        </button>
    </div>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Google Maps API -->
    <script>
        // Variáveis globais
        let map;
        let markers = [];
        let markerCluster;
        let directionsService;
        let directionsRenderer;
        let infoWindow;
        let pedidosData = [];
        let rotaPolyline;
        let heatmap;
        let cdMarker;
        let cdData = null;
        
        // Pedidos selecionados
        const pedidosSelecionados = {{ pedidos_selecionados|tojson }};
        
        // Inicializar mapa
        function initMap() {
            // Configuração inicial do mapa - Centro no CD Nacom Goya
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -23.409447293705245, lng: -46.89113812682363 }, // CD Nacom Goya
                zoom: 11,
                mapTypeId: 'roadmap',
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            
            // Inicializar serviços
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#667eea',
                    strokeWeight: 4,
                    strokeOpacity: 0.8
                }
            });
            
            infoWindow = new google.maps.InfoWindow();
            
            // Carregar pedidos automaticamente se houver selecionados
            if (pedidosSelecionados.length > 0) {
                carregarPedidos();
            }
        }
        
        // Obter CSRF token
        function getCSRFToken() {
            const token = document.querySelector('meta[name="csrf-token"]');
            if (token) {
                return token.getAttribute('content');
            }
            // Fallback: tentar obter de um cookie
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrf_token='))
                ?.split('=')[1];
            return cookieValue || '';
        }
        
        // Carregar pedidos no mapa
        function carregarPedidos() {
            showLoading();
            
            $.ajax({
                url: '/carteira/mapa/api/pedidos',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                data: JSON.stringify({ pedidos: pedidosSelecionados }),
                success: function(response) {
                    if (response.sucesso) {
                        pedidosData = response.pedidos;
                        cdData = response.cd;
                        plotarPedidosNoMapa(response.pedidos);
                        if (cdData) {
                            plotarCDNoMapa();
                        }
                        atualizarEstatisticas(response.resumo);
                        atualizarListaPedidos(response.pedidos);
                        $('#sidePanel').show();
                    }
                    hideLoading();
                },
                error: function(xhr) {
                    hideLoading();
                    Swal.fire('Erro', xhr.responseJSON?.erro || 'Erro ao carregar pedidos', 'error');
                }
            });
        }
        
        // Plotar CD no mapa
        function plotarCDNoMapa() {
            if (!cdData) return;
            
            // Criar marker para o CD
            cdMarker = new google.maps.Marker({
                position: {
                    lat: cdData.coordenadas.lat,
                    lng: cdData.coordenadas.lng
                },
                map: map,
                title: cdData.nome,
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    scaledSize: new google.maps.Size(50, 50)
                },
                animation: google.maps.Animation.DROP,
                zIndex: 1000
            });
            
            // InfoWindow do CD
            cdMarker.addListener('click', function() {
                const content = `
                    <div class="info-window">
                        <div class="info-window-header" style="background: #28a745;">
                            <h6 class="mb-0"><i class="fas fa-warehouse"></i> Centro de Distribuição</h6>
                        </div>
                        <div class="info-window-content">
                            <div class="info-row">
                                <span class="info-label">Nome:</span>
                                <span class="info-value">${cdData.nome}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Endereço:</span>
                                <span class="info-value">${cdData.endereco}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Tipo:</span>
                                <span class="info-value">Ponto de Origem</span>
                            </div>
                        </div>
                    </div>
                `;
                
                infoWindow.setContent(content);
                infoWindow.open(map, cdMarker);
            });
            
            markers.push(cdMarker);
        }
        
        // Plotar pedidos no mapa
        function plotarPedidosNoMapa(pedidos) {
            // Limpar markers anteriores
            limparMarkers();
            
            const bounds = new google.maps.LatLngBounds();
            
            // Adicionar CD aos bounds se existir
            if (cdData) {
                bounds.extend({
                    lat: cdData.coordenadas.lat,
                    lng: cdData.coordenadas.lng
                });
            }
            
            pedidos.forEach((pedido, index) => {
                const position = {
                    lat: pedido.coordenadas.lat,
                    lng: pedido.coordenadas.lng
                };
                
                // Determinar cor do marker baseado no status
                const markerColor = getMarkerColor(pedido.status);
                
                // Criar marker customizado
                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: `${pedido.num_pedido} - ${pedido.cliente.nome}`,
                    icon: {
                        url: `https://maps.google.com/mapfiles/ms/icons/${markerColor}-dot.png`,
                        scaledSize: new google.maps.Size(40, 40)
                    },
                    animation: google.maps.Animation.DROP,
                    pedidoData: pedido
                });
                
                // Adicionar label ao marker
                const label = new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                            `<svg xmlns="http://www.w3.org/2000/svg" width="30" height="20">
                                <text x="15" y="15" font-size="12" font-weight="bold" text-anchor="middle" fill="white" stroke="black" stroke-width="1">${index + 1}</text>
                            </svg>`
                        ),
                        anchor: new google.maps.Point(15, 40)
                    }
                });
                
                // Adicionar evento de clique
                marker.addListener('click', function() {
                    mostrarInfoWindow(marker, pedido);
                });
                
                markers.push(marker);
                markers.push(label);
                bounds.extend(position);
            });
            
            // Ajustar zoom para mostrar todos os markers
            if (pedidos.length > 0) {
                map.fitBounds(bounds);
                
                // Ajustar zoom se estiver muito próximo
                google.maps.event.addListenerOnce(map, 'idle', function() {
                    if (map.getZoom() > 15) {
                        map.setZoom(15);
                    }
                });
            }
        }
        
        // Obter cor do marker baseado no status
        function getMarkerColor(status) {
            switch(status) {
                case 'agendado': return 'green';
                case 'urgente': return 'yellow';
                case 'atrasado': return 'red';
                case 'pendente': return 'orange';
                default: return 'blue';
            }
        }
        
        // Mostrar InfoWindow
        function mostrarInfoWindow(marker, pedido) {
            const content = `
                <div class="info-window">
                    <div class="info-window-header">
                        <h6 class="mb-0">Pedido ${pedido.num_pedido}</h6>
                    </div>
                    <div class="info-window-content">
                        <div class="info-row">
                            <span class="info-label">Cliente:</span>
                            <span class="info-value">${pedido.cliente.nome}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">CNPJ:</span>
                            <span class="info-value">${pedido.cliente.cnpj}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Endereço:</span>
                            <span class="info-value">${pedido.endereco.completo}</span>
                        </div>
                        ${pedido.cliente.telefone ? `
                        <div class="info-row">
                            <span class="info-label">Telefone:</span>
                            <span class="info-value">${pedido.cliente.telefone}</span>
                        </div>` : ''}
                        <hr>
                        <div class="info-row">
                            <span class="info-label">Valor:</span>
                            <span class="info-value">R$ ${pedido.valores.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Peso:</span>
                            <span class="info-value">${pedido.valores.peso.toFixed(2)} kg</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Pallets:</span>
                            <span class="info-value">${pedido.valores.pallet.toFixed(2)}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Itens:</span>
                            <span class="info-value">${pedido.valores.itens}</span>
                        </div>
                        ${pedido.datas.expedicao ? `
                        <hr>
                        <div class="info-row">
                            <span class="info-label">Expedição:</span>
                            <span class="info-value">${pedido.datas.expedicao}</span>
                        </div>` : ''}
                        ${pedido.datas.agendamento ? `
                        <div class="info-row">
                            <span class="info-label">Agendamento:</span>
                            <span class="info-value">${pedido.datas.agendamento}</span>
                        </div>` : ''}
                        ${pedido.datas.protocolo ? `
                        <div class="info-row">
                            <span class="info-label">Protocolo:</span>
                            <span class="info-value">${pedido.datas.protocolo}</span>
                        </div>` : ''}
                        ${pedido.observacoes ? `
                        <hr>
                        <div class="info-row">
                            <span class="info-label">Observações:</span>
                            <span class="info-value">${pedido.observacoes}</span>
                        </div>` : ''}
                        <div class="mt-3 text-center">
                            <button class="btn btn-sm btn-primary" onclick="verDetalhesPedido('${pedido.num_pedido}')">
                                <i class="fas fa-eye"></i> Ver Detalhes
                            </button>
                            <button class="btn btn-sm btn-success" onclick="navegarAte(${pedido.coordenadas.lat}, ${pedido.coordenadas.lng})">
                                <i class="fas fa-directions"></i> Navegar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        }
        
        // Limpar markers
        function limparMarkers() {
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];
            
            if (markerCluster) {
                markerCluster.clearMarkers();
            }
        }
        
        // Atualizar estatísticas
        function atualizarEstatisticas(resumo) {
            $('#totalPedidos').text(pedidosData.length);
            $('#valorTotal').text('R$ ' + resumo.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2}));
            $('#pesoTotal').text(resumo.peso_total.toFixed(2) + ' kg');
            $('#palletTotal').text(resumo.pallet_total.toFixed(2));
        }
        
        // Atualizar lista de pedidos
        function atualizarListaPedidos(pedidos) {
            let html = '';
            
            pedidos.forEach((pedido, index) => {
                html += `
                    <div class="pedido-item ${pedido.status}" onclick="focusPedido(${index})">
                        <div class="d-flex justify-content-between">
                            <strong>${index + 1}. ${pedido.num_pedido}</strong>
                            <span class="badge bg-primary">${pedido.status}</span>
                        </div>
                        <div class="small mt-1">
                            <div>${pedido.cliente.nome}</div>
                            <div>${pedido.endereco.cidade}/${pedido.endereco.uf}</div>
                            <div class="text-muted">R$ ${pedido.valores.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                `;
            });
            
            $('#pedidosList').html(html);
        }
        
        // Focar em pedido específico
        function focusPedido(index) {
            const pedido = pedidosData[index];
            const marker = markers[index * 2]; // *2 porque temos marker + label
            
            map.setCenter({
                lat: pedido.coordenadas.lat,
                lng: pedido.coordenadas.lng
            });
            map.setZoom(15);
            
            // Abrir InfoWindow
            mostrarInfoWindow(marker, pedido);
            
            // Destacar na lista
            $('.pedido-item').removeClass('selected');
            $('.pedido-item').eq(index).addClass('selected');
        }
        
        // Calcular rota otimizada
        function calcularRotaOtimizada() {
            if (pedidosData.length < 2) {
                Swal.fire('Aviso', 'Selecione pelo menos 2 pedidos para calcular a rota', 'warning');
                return;
            }
            
            showLoading();
            
            $.ajax({
                url: '/carteira/mapa/api/rota-otimizada',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                data: JSON.stringify({ pedidos: pedidosSelecionados }),
                success: function(response) {
                    if (response.sucesso) {
                        exibirRotaOtimizada(response.rota);
                        
                        // Atualizar informações do veículo e pedágio
                        if (response.veiculo) {
                            $('#veiculoSelecionado').text(response.veiculo.nome);
                            $('#veiculoSelecionado').attr('title', 
                                `Capacidade: ${response.veiculo.peso_maximo} kg | ${response.veiculo.tipo} | ${response.veiculo.eixos} eixos`);
                        }
                        
                        if (response.pedagio) {
                            $('#pedagioEstimado').text(`R$ ${response.pedagio.valor_total.toFixed(2)}`);
                            $('#pedagioEstimado').attr('title', 
                                `${response.pedagio.num_pracas_estimado} praça(s) × R$ ${response.pedagio.valor_medio_praca.toFixed(2)}`);
                        }
                        
                        mostrarEstatisticasRotaCompleta(response.rota, response.estatisticas, response.veiculo, response.pedagio);
                    }
                    hideLoading();
                },
                error: function(xhr) {
                    hideLoading();
                    Swal.fire('Erro', xhr.responseJSON?.erro || 'Erro ao calcular rota', 'error');
                }
            });
        }
        
        // Variáveis para armazenar marcadores de ordem e pedágio
        let ordemMarkers = [];
        let pedagioMarkers = [];
        
        // Exibir rota otimizada
        function exibirRotaOtimizada(rota) {
            // Limpar rota anterior
            if (rotaPolyline) {
                rotaPolyline.setMap(null);
            }
            
            // Limpar marcadores de ordem anteriores
            ordemMarkers.forEach(marker => marker.setMap(null));
            ordemMarkers = [];
            
            // Limpar marcadores de pedágio anteriores
            pedagioMarkers.forEach(marker => marker.setMap(null));
            pedagioMarkers = [];
            
            // Decodificar polyline
            const path = google.maps.geometry.encoding.decodePath(rota.polyline);
            
            // Criar nova polyline com cor personalizada
            rotaPolyline = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: '#10b981',  // Verde esmeralda
                strokeOpacity: 0.9,
                strokeWeight: 5,
                icons: [{
                    icon: {
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        scale: 3,
                        strokeColor: '#065f46',
                        strokeWeight: 2,
                        fillColor: '#10b981',
                        fillOpacity: 1
                    },
                    offset: '100%',
                    repeat: '150px'  // Setas a cada 150px
                }],
                map: map
            });
            
            // Adicionar marcadores de ordem e tempo para cada pedido
            if (rota.ordem_pedidos && rota.legs) {
                // Array para armazenar tempos acumulados para cada pedido
                const temposAcumulados = [];
                let tempoTotal = 0;
                
                // Calcular tempo acumulado para cada ponto
                for (let i = 0; i <= rota.ordem_pedidos.length && i < rota.legs.length; i++) {
                    if (i === 0) {
                        // Tempo do CD até o primeiro pedido
                        const duracaoTexto = rota.legs[0].duracao;
                        const match = duracaoTexto.match(/\d+/);
                        if (match) {
                            tempoTotal = parseInt(match[0]);
                        }
                        temposAcumulados.push(tempoTotal);
                    } else {
                        // Tempo entre pedidos
                        const duracaoTexto = rota.legs[i].duracao;
                        const match = duracaoTexto.match(/\d+/);
                        if (match) {
                            tempoTotal += parseInt(match[0]);
                        }
                        temposAcumulados.push(tempoTotal);
                    }
                }
                
                rota.ordem_pedidos.forEach((numPedido, index) => {
                    // Encontrar o pedido nos dados
                    const pedido = pedidosData.find(p => p.num_pedido === numPedido);
                    
                    if (pedido) {
                        // Usar o tempo acumulado calculado
                        const tempoAcumulado = temposAcumulados[index] || 0;
                        
                        // Verificar se há outro pedido no mesmo local (mesmo cliente)
                        let offsetLat = 0;
                        let offsetLng = 0;
                        let pedidosNoMesmoLocal = 0;
                        
                        // Verificar pedidos anteriores no mesmo CNPJ ou coordenadas muito próximas
                        for (let j = 0; j < index; j++) {
                            const outroPedido = pedidosData.find(p => p.num_pedido === rota.ordem_pedidos[j]);
                            if (outroPedido) {
                                // Verificar se é o mesmo cliente (CNPJ) ou coordenadas muito próximas
                                const mesmoCNPJ = outroPedido.cliente.cnpj === pedido.cliente.cnpj;
                                const distanciaLat = Math.abs(outroPedido.coordenadas.lat - pedido.coordenadas.lat);
                                const distanciaLng = Math.abs(outroPedido.coordenadas.lng - pedido.coordenadas.lng);
                                const muitoProximo = distanciaLat < 0.0001 && distanciaLng < 0.0001;
                                
                                if (mesmoCNPJ && muitoProximo) {  // Só aplicar offset se for mesmo CNPJ E mesmo local
                                    pedidosNoMesmoLocal++;
                                    // Aplicar offset diagonal para separar visualmente
                                    offsetLat = pedidosNoMesmoLocal * 0.0004;
                                    offsetLng = pedidosNoMesmoLocal * 0.0004;
                                }
                            }
                        }
                        
                        // Criar marcador customizado com ordem (menor tamanho)
                        const ordemLabel = new google.maps.Marker({
                            position: {
                                lat: pedido.coordenadas.lat + offsetLat,
                                lng: pedido.coordenadas.lng + offsetLng
                            },
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 12,  // Reduzido de 20 para 12
                                fillColor: '#dc2626',  // Vermelho
                                fillOpacity: 0.9,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            },
                            label: {
                                text: String(index + 1),
                                color: '#ffffff',
                                fontSize: '11px',  // Reduzido de 14px
                                fontWeight: 'bold'
                            },
                            title: `${index + 1}º - ${pedido.num_pedido}`,
                            zIndex: 1000 + index
                        });
                        
                        // Criar label com tempo estimado (posicionado ACIMA do marcador)
                        const tempoLabel = new google.maps.Marker({
                            position: {
                                lat: pedido.coordenadas.lat + offsetLat + 0.002,  // Bem acima do marcador
                                lng: pedido.coordenadas.lng + offsetLng
                            },
                            map: map,
                            icon: {
                                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                    <svg xmlns="http://www.w3.org/2000/svg" width="90" height="28">
                                        <rect x="5" y="3" width="80" height="22" rx="11" fill="#1e40af" stroke="#ffffff" stroke-width="1" opacity="0.95"/>
                                        <text x="45" y="17" font-family="Arial, sans-serif" font-size="12" fill="white" text-anchor="middle" font-weight="bold">
                                            ${tempoAcumulado > 0 ? `${tempoAcumulado} min` : 'PARTIDA'}
                                        </text>
                                    </svg>
                                `),
                                anchor: new google.maps.Point(45, 25)  // Ancorar na parte inferior do SVG
                            },
                            zIndex: 1100 + index  // Maior zIndex para ficar acima
                        });
                        
                        // InfoWindow ao clicar
                        ordemLabel.addListener('click', () => {
                            // Verificar se há outros pedidos do mesmo cliente nesta rota
                            const pedidosMesmoCliente = rota.ordem_pedidos.filter(numPed => {
                                const p = pedidosData.find(pd => pd.num_pedido === numPed);
                                return p && p.cliente.cnpj === pedido.cliente.cnpj;
                            });
                            
                            let pedidosInfo = '';
                            if (pedidosMesmoCliente.length > 1) {
                                pedidosInfo = `<p class="mb-1"><strong>Pedidos neste local:</strong> ${pedidosMesmoCliente.join(', ')}</p>`;
                            }
                            
                            const infoContent = `
                                <div style="padding: 10px;">
                                    <h6 class="mb-2"><strong>${index + 1}ª Entrega</strong></h6>
                                    <p class="mb-1"><strong>Pedido:</strong> ${pedido.num_pedido}</p>
                                    <p class="mb-1"><strong>Cliente:</strong> ${pedido.cliente.nome}</p>
                                    <p class="mb-1"><strong>CNPJ:</strong> ${pedido.cliente.cnpj}</p>
                                    ${pedidosInfo}
                                    <p class="mb-1"><strong>Endereço:</strong> ${pedido.endereco.rua}, ${pedido.endereco.numero}</p>
                                    <p class="mb-1"><strong>Tempo até aqui:</strong> ${tempoAcumulado > 0 ? `${tempoAcumulado} minutos` : 'Ponto de partida'}</p>
                                    ${index < rota.legs.length ? `<p class="mb-1"><strong>Próximo trecho:</strong> ${rota.legs[index].distancia} - ${rota.legs[index].duracao}</p>` : ''}
                                    ${pedidosNoMesmoLocal > 0 ? `<div class="alert alert-info mt-2 mb-0"><small>⚠️ Múltiplas entregas neste endereço</small></div>` : ''}
                                </div>
                            `;
                            
                            if (infoWindow) {
                                infoWindow.close();
                            }
                            
                            infoWindow = new google.maps.InfoWindow({
                                content: infoContent
                            });
                            
                            infoWindow.open(map, ordemLabel);
                        });
                        
                        ordemMarkers.push(ordemLabel);
                        ordemMarkers.push(tempoLabel);
                    }
                });
            }
            
            // Adicionar marcadores de pedágio estimados
            adicionarMarcadoresPedagio(path, rota.distancia_total_km);
            
            // Ajustar bounds
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(new google.maps.LatLng(rota.bounds.southwest.lat, rota.bounds.southwest.lng));
            bounds.extend(new google.maps.LatLng(rota.bounds.northeast.lat, rota.bounds.northeast.lng));
            map.fitBounds(bounds);
        }
        
        // Função para adicionar marcadores de pedágio
        function adicionarMarcadoresPedagio(path, distanciaTotal) {
            // Estimar praças de pedágio (1 a cada 45km em rodovias pedagiadas)
            const distanciaPedagiada = distanciaTotal * 0.6; // 60% da rota
            const numPracas = Math.max(1, Math.floor(distanciaPedagiada / 45));
            
            // Distribuir praças ao longo da rota
            const totalPoints = path.length;
            const interval = Math.floor(totalPoints / (numPracas + 1));
            
            for (let i = 1; i <= numPracas; i++) {
                const pointIndex = Math.min(i * interval, totalPoints - 1);
                const position = path[pointIndex];
                
                // Criar marcador de pedágio
                const pedagioMarker = new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                                <!-- Fundo circular amarelo -->
                                <circle cx="20" cy="20" r="18" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
                                <!-- Símbolo de dinheiro -->
                                <text x="20" y="27" font-family="Arial, sans-serif" font-size="20" fill="#7c2d12" text-anchor="middle" font-weight="bold">$</text>
                            </svg>
                        `),
                        anchor: new google.maps.Point(20, 20),
                        scaledSize: new google.maps.Size(40, 40)
                    },
                    title: `Praça de Pedágio ${i}`,
                    zIndex: 800
                });
                
                // Adicionar InfoWindow ao clicar
                pedagioMarker.addListener('click', () => {
                    const valorEstimado = $('#pedagioEstimado').text();
                    const veiculoNome = $('#veiculoSelecionado').text();
                    
                    const infoContent = `
                        <div style="padding: 10px;">
                            <h6 class="mb-2"><strong>🛣️ Praça de Pedágio ${i}</strong></h6>
                            <p class="mb-1"><strong>Posição estimada:</strong> Km ${Math.round((i * 45) + (Math.random() * 10 - 5))}</p>
                            <p class="mb-1"><strong>Veículo:</strong> ${veiculoNome || 'Não definido'}</p>
                            <p class="mb-1"><strong>Valor estimado:</strong> ${valorEstimado ? (parseFloat(valorEstimado.replace('R$ ', '').replace(',', '.')) / numPracas).toFixed(2) : '0.00'}</p>
                            <div class="alert alert-info mt-2 mb-0">
                                <small>⚠️ Posição e valor estimados. Consulte rotas oficiais para valores exatos.</small>
                            </div>
                        </div>
                    `;
                    
                    if (infoWindow) {
                        infoWindow.close();
                    }
                    
                    infoWindow = new google.maps.InfoWindow({
                        content: infoContent,
                        maxWidth: 300
                    });
                    
                    infoWindow.open(map, pedagioMarker);
                });
                
                // Adicionar label flutuante com valor
                const valorPorPraca = $('#pedagioEstimado').text() ? 
                    (parseFloat($('#pedagioEstimado').text().replace('R$ ', '').replace(',', '.')) / numPracas).toFixed(2) : 
                    '8.50';
                
                const labelPedagio = new google.maps.Marker({
                    position: {
                        lat: position.lat() - 0.0008,  // Posicionar abaixo
                        lng: position.lng()
                    },
                    map: map,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="25">
                                <rect x="0" y="0" width="60" height="20" rx="10" fill="#fbbf24" opacity="0.9"/>
                                <text x="30" y="14" font-family="Arial, sans-serif" font-size="11" fill="#7c2d12" text-anchor="middle" font-weight="bold">
                                    R$ ${valorPorPraca}
                                </text>
                            </svg>
                        `),
                        anchor: new google.maps.Point(30, 10)
                    },
                    zIndex: 799
                });
                
                pedagioMarkers.push(pedagioMarker);
                pedagioMarkers.push(labelPedagio);
            }
        }
        
        // Mostrar estatísticas da rota (versão simplificada mantida para compatibilidade)
        function mostrarEstatisticasRota(rota, estatisticas) {
            mostrarEstatisticasRotaCompleta(rota, estatisticas, null, null);
        }
        
        // Mostrar estatísticas completas da rota com veículo e pedágio
        function mostrarEstatisticasRotaCompleta(rota, estatisticas, veiculo, pedagio) {
            let legsHtml = '';
            rota.legs.forEach((leg, index) => {
                legsHtml += `
                    <tr>
                        <td>Trecho ${index + 1}</td>
                        <td>${leg.distancia}</td>
                        <td>${leg.duracao}</td>
                    </tr>
                `;
            });
            
            // Seção do veículo
            let veiculoHtml = '';
            if (veiculo) {
                veiculoHtml = `
                    <h5 class="mt-3">🚚 Veículo Selecionado</h5>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Veículo:</strong></td>
                            <td>${veiculo.nome}</td>
                        </tr>
                        <tr>
                            <td><strong>Capacidade:</strong></td>
                            <td>${veiculo.peso_maximo.toLocaleString('pt-BR')} kg</td>
                        </tr>
                        <tr>
                            <td><strong>Tipo:</strong></td>
                            <td>${veiculo.tipo} (${veiculo.eixos} eixos)</td>
                        </tr>
                        <tr>
                            <td><strong>Peso da Carga:</strong></td>
                            <td>${estatisticas.peso_total.toLocaleString('pt-BR')} kg</td>
                        </tr>
                        <tr>
                            <td><strong>Utilização:</strong></td>
                            <td>${((estatisticas.peso_total / veiculo.peso_maximo) * 100).toFixed(1)}%</td>
                        </tr>
                    </table>
                `;
            }
            
            // Seção do pedágio
            let pedagioHtml = '';
            if (pedagio) {
                pedagioHtml = `
                    <h5 class="mt-3">💰 Estimativa de Pedágio</h5>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Valor Total:</strong></td>
                            <td class="text-success"><strong>R$ ${pedagio.valor_total.toFixed(2)}</strong></td>
                        </tr>
                        <tr>
                            <td><strong>Praças Estimadas:</strong></td>
                            <td>${pedagio.num_pracas_estimado}</td>
                        </tr>
                        <tr>
                            <td><strong>Valor Médio/Praça:</strong></td>
                            <td>R$ ${pedagio.valor_medio_praca.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Distância Pedagiada:</strong></td>
                            <td>${pedagio.distancia_pedagiada_km} km (60% da rota)</td>
                        </tr>
                        <tr>
                            <td><strong>Fator do Veículo:</strong></td>
                            <td>${pedagio.multiplicador_veiculo}x (base: R$ ${pedagio.valor_base_carro.toFixed(2)})</td>
                        </tr>
                    </table>
                    <div class="alert alert-info mt-2">
                        <small><i class="fas fa-info-circle"></i> ${pedagio.observacao}</small>
                    </div>
                `;
            }
            
            Swal.fire({
                title: '📍 Rota Otimizada',
                html: `
                    <div class="text-start">
                        <h5>📊 Resumo da Rota</h5>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Distância Total:</strong></td>
                                <td>${rota.distancia_total_km.toFixed(1)} km</td>
                            </tr>
                            <tr>
                                <td><strong>Tempo Estimado:</strong></td>
                                <td>${rota.tempo_formatado}</td>
                            </tr>
                            <tr>
                                <td><strong>Custo Combustível:</strong></td>
                                <td>R$ ${estatisticas.custo_estimado_km.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td><strong>Total de Pedidos:</strong></td>
                                <td>${estatisticas.total_pedidos}</td>
                            </tr>
                            <tr>
                                <td><strong>Valor Total:</strong></td>
                                <td>R$ ${estatisticas.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                            </tr>
                        </table>
                        
                        ${veiculoHtml}
                        ${pedagioHtml}
                        
                        <h5 class="mt-3">📦 Ordem de Entrega</h5>
                        <ol>
                            ${rota.ordem_pedidos.map(p => `<li>Pedido ${p}</li>`).join('')}
                        </ol>
                        
                        <h5 class="mt-3">🛣️ Trechos</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Trecho</th>
                                    <th>Distância</th>
                                    <th>Tempo</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${legsHtml}
                            </tbody>
                        </table>
                        
                        <div class="alert alert-warning mt-3">
                            <strong>💵 Custo Total Estimado:</strong><br>
                            Combustível: R$ ${estatisticas.custo_estimado_km.toFixed(2)}<br>
                            Pedágio: R$ ${pedagio ? pedagio.valor_total.toFixed(2) : '0.00'}<br>
                            <hr>
                            <strong>TOTAL: R$ ${(estatisticas.custo_estimado_km + (pedagio ? pedagio.valor_total : 0)).toFixed(2)}</strong>
                        </div>
                    </div>
                `,
                width: 700,
                confirmButtonText: 'Fechar'
            });
        }
        
        // Mostrar densidade regional
        function mostrarDensidade() {
            showLoading();
            
            $.ajax({
                url: '/carteira/mapa/api/densidade-regional',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                data: JSON.stringify({ pedidos: pedidosSelecionados }),
                success: function(response) {
                    if (response.sucesso) {
                        exibirDensidadeNoMapa(response.densidade);
                        mostrarEstatisticasDensidade(response.densidade);
                    }
                    hideLoading();
                },
                error: function(xhr) {
                    hideLoading();
                    Swal.fire('Erro', 'Erro ao analisar densidade', 'error');
                }
            });
        }
        
        // Exibir densidade no mapa (heatmap)
        function exibirDensidadeNoMapa(densidade) {
            // Preparar dados para heatmap
            const heatmapData = [];
            
            pedidosData.forEach(pedido => {
                heatmapData.push({
                    location: new google.maps.LatLng(pedido.coordenadas.lat, pedido.coordenadas.lng),
                    weight: pedido.valores.total / 1000 // Peso baseado no valor
                });
            });
            
            // Remover heatmap anterior
            if (heatmap) {
                heatmap.setMap(null);
            }
            
            // Criar novo heatmap
            heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                map: map,
                radius: 50,
                opacity: 0.6,
                gradient: [
                    'rgba(0, 255, 255, 0)',
                    'rgba(0, 255, 255, 1)',
                    'rgba(0, 191, 255, 1)',
                    'rgba(0, 127, 255, 1)',
                    'rgba(0, 63, 255, 1)',
                    'rgba(0, 0, 255, 1)',
                    'rgba(0, 0, 223, 1)',
                    'rgba(0, 0, 191, 1)',
                    'rgba(0, 0, 159, 1)',
                    'rgba(0, 0, 127, 1)',
                    'rgba(63, 0, 91, 1)',
                    'rgba(127, 0, 63, 1)',
                    'rgba(191, 0, 31, 1)',
                    'rgba(255, 0, 0, 1)'
                ]
            });
        }
        
        // Mostrar estatísticas de densidade
        function mostrarEstatisticasDensidade(densidade) {
            let estadosHtml = '';
            for (const [uf, dados] of Object.entries(densidade.por_estado)) {
                estadosHtml += `
                    <tr>
                        <td>${uf}</td>
                        <td>${dados.total_pedidos}</td>
                        <td>R$ ${dados.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td>${dados.peso_total.toFixed(2)} kg</td>
                    </tr>
                `;
            }
            
            let cidadesHtml = '';
            densidade.por_cidade.slice(0, 10).forEach(cidade => {
                cidadesHtml += `
                    <tr>
                        <td>${cidade.cidade}/${cidade.uf}</td>
                        <td>${cidade.total_pedidos}</td>
                        <td>R$ ${cidade.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });
            
            Swal.fire({
                title: 'Análise de Densidade Regional',
                html: `
                    <div class="text-start">
                        <h5>Resumo Geral</h5>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Total de Estados:</strong></td>
                                <td>${densidade.resumo.total_estados}</td>
                            </tr>
                            <tr>
                                <td><strong>Total de Cidades:</strong></td>
                                <td>${densidade.resumo.total_cidades}</td>
                            </tr>
                            <tr>
                                <td><strong>Total de Pedidos:</strong></td>
                                <td>${densidade.resumo.total_pedidos}</td>
                            </tr>
                            <tr>
                                <td><strong>Valor Total:</strong></td>
                                <td>R$ ${densidade.resumo.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                            </tr>
                        </table>
                        
                        <h5 class="mt-3">Por Estado</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>UF</th>
                                    <th>Pedidos</th>
                                    <th>Valor</th>
                                    <th>Peso</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${estadosHtml}
                            </tbody>
                        </table>
                        
                        <h5 class="mt-3">Top 10 Cidades</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Cidade</th>
                                    <th>Pedidos</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${cidadesHtml}
                            </tbody>
                        </table>
                        
                        ${densidade.analises ? `
                        <h5 class="mt-3">Análises e Sugestões</h5>
                        <div class="alert alert-info">
                            ${densidade.analises.sugestoes.map(s => `<p><i class="fas fa-lightbulb"></i> ${s.descricao}</p>`).join('')}
                        </div>
                        ` : ''}
                    </div>
                `,
                width: 700,
                confirmButtonText: 'Fechar'
            });
        }
        
        // Calcular matriz de distâncias
        function calcularMatrizDistancias() {
            if (pedidosData.length < 2) {
                Swal.fire('Aviso', 'Selecione pelo menos 2 pedidos para calcular a matriz', 'warning');
                return;
            }
            
            showLoading();
            
            $.ajax({
                url: '/carteira/mapa/api/matriz-distancias',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                data: JSON.stringify({ pedidos: pedidosSelecionados.slice(0, 10) }),
                success: function(response) {
                    if (response.sucesso) {
                        mostrarMatrizDistancias(response.matriz);
                    }
                    hideLoading();
                },
                error: function(xhr) {
                    hideLoading();
                    Swal.fire('Erro', xhr.responseJSON?.erro || 'Erro ao calcular matriz', 'error');
                }
            });
        }
        
        // Mostrar matriz de distâncias
        function mostrarMatrizDistancias(matriz) {
            let matrizHtml = '<table class="table table-sm table-bordered">';
            matrizHtml += '<thead><tr><th>De/Para</th>';
            
            // Header
            matriz.pedidos.forEach(pedido => {
                matrizHtml += `<th>${pedido}</th>`;
            });
            matrizHtml += '</tr></thead><tbody>';
            
            // Linhas
            matriz.distancias.forEach((linha, i) => {
                matrizHtml += `<tr><th>${matriz.pedidos[i]}</th>`;
                linha.forEach((dist, j) => {
                    if (dist === null) {
                        matrizHtml += '<td>-</td>';
                    } else if (i === j) {
                        matrizHtml += '<td class="table-secondary">0</td>';
                    } else {
                        matrizHtml += `<td>${dist} km</td>`;
                    }
                });
                matrizHtml += '</tr>';
            });
            matrizHtml += '</tbody></table>';
            
            // Pares próximos e distantes
            let paresHtml = '<h5 class="mt-3">Pares Mais Próximos</h5><ul>';
            matriz.resumo.pares_proximos.forEach(par => {
                paresHtml += `<li>${par.origem} → ${par.destino}: ${par.distancia.toFixed(1)} km (${par.tempo.toFixed(0)} min)</li>`;
            });
            paresHtml += '</ul>';
            
            paresHtml += '<h5 class="mt-3">Pares Mais Distantes</h5><ul>';
            matriz.resumo.pares_distantes.forEach(par => {
                paresHtml += `<li>${par.origem} → ${par.destino}: ${par.distancia.toFixed(1)} km (${par.tempo.toFixed(0)} min)</li>`;
            });
            paresHtml += '</ul>';
            
            Swal.fire({
                title: 'Matriz de Distâncias',
                html: `
                    <div class="text-start">
                        <div class="alert alert-info">
                            <strong>Distância Média:</strong> ${matriz.resumo.distancia_media_km} km<br>
                            <strong>Tempo Médio:</strong> ${matriz.resumo.tempo_medio_min} minutos
                        </div>
                        ${matrizHtml}
                        ${paresHtml}
                    </div>
                `,
                width: 900,
                confirmButtonText: 'Fechar'
            });
        }
        
        // Alternar clustering
        function alternarClustering() {
            if (markerCluster) {
                markerCluster.clearMarkers();
                markerCluster = null;
                plotarPedidosNoMapa(pedidosData);
                Swal.fire('Clustering Desativado', '', 'info');
            } else {
                // Ativar clustering
                markerCluster = new MarkerClusterer(map, markers.filter((m, i) => i % 2 === 0), {
                    imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
                    maxZoom: 15,
                    gridSize: 60
                });
                Swal.fire('Clustering Ativado', '', 'success');
            }
        }
        
        // Mudar tipo de mapa
        function mudarTipoMapa(tipo) {
            map.setMapTypeId(tipo);
        }
        
        // Centralizar mapa
        function centralizarMapa() {
            const bounds = new google.maps.LatLngBounds();
            
            // Incluir CD nos bounds
            if (cdData) {
                bounds.extend({
                    lat: cdData.coordenadas.lat,
                    lng: cdData.coordenadas.lng
                });
            }
            
            // Incluir pedidos nos bounds
            if (pedidosData.length > 0) {
                pedidosData.forEach(pedido => {
                    bounds.extend({
                        lat: pedido.coordenadas.lat,
                        lng: pedido.coordenadas.lng
                    });
                });
            }
            
            if (!bounds.isEmpty()) {
                map.fitBounds(bounds);
            }
        }
        
        // Toggle fullscreen
        function toggleFullscreen() {
            const mapDiv = document.getElementById('map');
            if (!document.fullscreenElement) {
                mapDiv.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // Tirar screenshot
        function tirarScreenshot() {
            // Implementar com html2canvas se necessário
            Swal.fire('Screenshot', 'Use Ctrl+Shift+S para capturar a tela', 'info');
        }
        
        // Navegar até localização
        function navegarAte(lat, lng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }
        
        // Ver detalhes do pedido
        function verDetalhesPedido(numPedido) {
            window.open(`/carteira/pedido/${numPedido}`, '_blank');
        }
        
        // Toggle side panel
        function toggleSidePanel() {
            $('#sidePanel').toggle();
        }
        
        // Toggle FAB menu
        function toggleFabMenu() {
            $('#fabMenu').toggleClass('active');
            $('.fab-btn i').toggleClass('fa-plus fa-times');
        }
        
        // Exportar dados
        function exportarDados() {
            showLoading();
            
            $.ajax({
                url: '/carteira/mapa/api/exportar-mapa',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                data: JSON.stringify({ 
                    pedidos: pedidosSelecionados,
                    incluir_rota: true,
                    incluir_densidade: true
                }),
                success: function(response) {
                    if (response.sucesso) {
                        // Criar download
                        const dataStr = JSON.stringify(response.dados, null, 2);
                        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                        
                        const exportFileDefaultName = `mapa_pedidos_${new Date().toISOString().slice(0,10)}.json`;
                        
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', exportFileDefaultName);
                        linkElement.click();
                        
                        Swal.fire('Sucesso', 'Dados exportados com sucesso', 'success');
                    }
                    hideLoading();
                },
                error: function(xhr) {
                    hideLoading();
                    Swal.fire('Erro', 'Erro ao exportar dados', 'error');
                }
            });
        }
        
        // Show/Hide loading
        function showLoading() {
            $('#loadingOverlay').show();
        }
        
        function hideLoading() {
            $('#loadingOverlay').hide();
        }
        
        // Atalhos de teclado
        $(document).keydown(function(e) {
            // R - Atualizar
            if (e.key === 'r' && !$(e.target).is('input, textarea')) {
                e.preventDefault();
                carregarPedidos();
            }
            // O - Rota otimizada
            if (e.key === 'o' && !$(e.target).is('input, textarea')) {
                e.preventDefault();
                calcularRotaOtimizada();
            }
            // D - Densidade
            if (e.key === 'd' && !$(e.target).is('input, textarea')) {
                e.preventDefault();
                mostrarDensidade();
            }
            // M - Matriz
            if (e.key === 'm' && !$(e.target).is('input, textarea')) {
                e.preventDefault();
                calcularMatrizDistancias();
            }
            // C - Clustering
            if (e.key === 'c' && !$(e.target).is('input, textarea')) {
                e.preventDefault();
                alternarClustering();
            }
            // ESC - Fechar panels
            if (e.key === 'Escape') {
                $('#sidePanel').hide();
                $('#fabMenu').removeClass('active');
            }
        });
    </script>
    
    <!-- Carregar Google Maps API com bibliotecas necessárias -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap&libraries=geometry,visualization,places&language=pt-BR">
    </script>
    
    <!-- MarkerClusterer -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</body>
</html>