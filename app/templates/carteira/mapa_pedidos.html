<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Mapa de Pedidos - Sistema Frete</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        /* Estilos do Mapa */
        #map {
            height: calc(100vh - 200px);
            width: 100%;
            min-height: 500px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* Controles do Mapa */
        .map-controls {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .control-btn {
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Painel Lateral */
        .side-panel {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 350px;
            max-height: calc(100vh - 250px);
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            overflow-y: auto;
        }

        .side-panel-header {
            background: var(--bs-secondary-bg);
            color: var(--bs-body-color);
            padding: 15px;
            border-radius: 8px 8px 0 0;
            position: sticky;
            top: 0;
            z-index: 1001;
            border-bottom: 1px solid var(--bs-border-color);
        }

        .side-panel-content {
            padding: 15px;
        }

        /* Lista de Pedidos */
        .pedido-item {
            border-left: 4px solid var(--bs-border-color);
            background: var(--bs-tertiary-bg);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pedido-item:hover {
            background: var(--bs-secondary-bg);
            transform: translateX(5px);
        }

        .pedido-item.selected {
            background: var(--bs-secondary-bg);
            border-left-color: var(--bs-body-color);
        }

        .pedido-item.agendado {
            border-left-color: #28a745;
        }

        .pedido-item.urgente {
            border-left-color: #ffc107;
        }

        .pedido-item.atrasado {
            border-left-color: #dc3545;
        }

        /* Estilos para cliente na rota (verde) */
        .cliente-item.na-rota {
            border-left-color: #10b981 !important;
            background: rgba(16, 185, 129, 0.1) !important;
        }

        .cliente-item.na-rota::before {
            content: '✓';
            position: absolute;
            right: 10px;
            top: 10px;
            color: #10b981;
            font-weight: bold;
        }

        .cliente-item {
            position: relative;
        }

        /* Sub-itens de pedido dentro do cliente */
        .pedido-sub-item {
            border-left-color: #6c757d;
        }

        .pedido-sub-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        /* InfoWindow Customizado */
        .info-window {
            min-width: 300px;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        .info-window-header {
            background: var(--bs-secondary-bg);
            color: var(--bs-body-color);
            padding: 10px;
            margin: -10px -10px 10px -10px;
            border-radius: 4px 4px 0 0;
            border-bottom: 1px solid var(--bs-border-color);
        }

        .info-window-content {
            padding: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
        }

        .info-value {
            color: #212529;
        }

        /* Estatísticas */
        .stats-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--bs-body-color);
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }

        /* Legenda do Mapa */
        .map-legend {
            position: absolute;
            bottom: 30px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            border-radius: 8px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--bs-border-color);
            border-top: 5px solid var(--bs-body-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .side-panel {
                width: 100%;
                right: 0;
                left: 0;
                top: auto;
                bottom: 0;
                max-height: 50vh;
                border-radius: 20px 20px 0 0;
            }

            #map {
                height: 60vh;
            }
        }

        /* Botão Flutuante */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .fab-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--bs-secondary-bg);
            color: var(--bs-body-color);
            border: 1px solid var(--bs-border-color);
            box-shadow: var(--bs-box-shadow);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fab-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: none;
        }

        .fab-menu.active {
            display: block;
        }

        .fab-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bs-body-bg);
            color: var(--bs-body-color);
            border: 1px solid var(--bs-border-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fab-option:hover {
            background: var(--bs-secondary-bg);
            color: var(--bs-body-color);
            transform: scale(1.1);
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2><i class="fas fa-map-marked-alt"></i> Visualização de Pedidos no Mapa</h2>
                    <div>
                        <button class="btn btn-secondary" onclick="window.history.back()">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controles do Mapa -->
        <div class="row">
            <div class="col-12">
                <div class="map-controls">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <button class="btn btn-primary control-btn" onclick="carregarPedidos()">
                                <i class="fas fa-sync"></i> Atualizar
                            </button>
                            <button class="btn btn-success control-btn" onclick="calcularRotaOtimizada()">
                                <i class="fas fa-route"></i> Rota Otimizada
                            </button>
                            <button class="btn btn-info control-btn" onclick="mostrarDensidade()">
                                <i class="fas fa-chart-pie"></i> Densidade
                            </button>
                            <button class="btn btn-warning control-btn" onclick="calcularMatrizDistancias()">
                                <i class="fas fa-table"></i> Matriz
                            </button>
                            <button class="btn btn-success control-btn" onclick="cotarFrete()">
                                <i class="fas fa-dollar-sign"></i> Cotar Frete
                            </button>
                            <button class="btn btn-dark control-btn" onclick="exportarExcel()">
                                <i class="fas fa-file-excel"></i> Exportar Excel
                            </button>
                        </div>
                        <div class="col-md-4 text-end">
                            <select class="form-select d-inline-block w-auto" id="tipoMapa"
                                onchange="mudarTipoMapa(this.value)">
                                <option value="roadmap">Ruas</option>
                                <option value="satellite">Satélite</option>
                                <option value="hybrid">Híbrido</option>
                                <option value="terrain">Terreno</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estatísticas -->
        <div class="row mb-3">
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stat-value" id="totalPedidos">0</div>
                    <div class="stat-label">Total Pedidos</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stat-value" id="valorTotal">R$ 0</div>
                    <div class="stat-label">Valor Total</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stat-value" id="pesoTotal">0 kg</div>
                    <div class="stat-label">Peso Total</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stat-value" id="palletTotal">0</div>
                    <div class="stat-label">Pallets Total</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card bg-info">
                    <div class="stat-value" id="veiculoSelecionado">-</div>
                    <div class="stat-label">Veículo Ideal</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card bg-warning text-dark">
                    <div class="stat-value" id="pedagioEstimado">R$ 0</div>
                    <div class="stat-label">Pedágio Estimado</div>
                </div>
            </div>
        </div>

        <!-- Mapa Container -->
        <div class="row">
            <div class="col-12 position-relative">
                <div id="map"></div>

                <!-- Loading Overlay -->
                <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>

                <!-- Painel Lateral -->
                <div class="side-panel" id="sidePanel" style="display: none;">
                    <div class="side-panel-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-building"></i> Entregas no Mapa</h5>
                            <button class="btn btn-sm btn-light" onclick="toggleSidePanel()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="side-panel-content" id="pedidosList">
                        <!-- Lista de clientes/entregas será inserida aqui -->
                    </div>
                </div>

                <!-- Legenda -->
                <div class="map-legend" id="mapLegend">
                    <h6>Legenda</h6>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #28a745;"></div>
                        <span>Agendado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffc107;"></div>
                        <span>Urgente</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dc3545;"></div>
                        <span>Atrasado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #6c757d;"></div>
                        <span>Normal</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botão Flutuante -->
    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <button class="fab-option" onclick="centralizarMapa()" title="Centralizar">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="fab-option" onclick="toggleFullscreen()" title="Tela Cheia">
                <i class="fas fa-expand"></i>
            </button>
            <button class="fab-option" onclick="tirarScreenshot()" title="Screenshot">
                <i class="fas fa-camera"></i>
            </button>
        </div>
        <button class="fab-btn" onclick="toggleFabMenu()">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Modal Verificação Bidirecional NF no CD (Mapa) -->
    <div class="modal fade" id="modalNfCdMapa" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark py-2">
                    <h5 class="modal-title mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Pedidos relacionados não selecionados
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body px-4 py-3">
                    <div class="alert alert-info d-flex align-items-center mb-4 py-2">
                        <i class="fas fa-info-circle me-2 fs-5"></i>
                        <span>Existem pedidos dos <strong>mesmos clientes</strong> que não foram incluídos na cotação. Verifique se deseja incluí-los.</span>
                    </div>

                    <!-- Seção: Pedidos Selecionados -->
                    <div class="card border-success mb-4">
                        <div class="card-header bg-success bg-opacity-10 py-2 d-flex align-items-center justify-content-between">
                            <span>
                                <i class="fas fa-check-circle text-success me-1"></i>
                                <strong>Pedidos Selecionados para Cotação</strong>
                            </span>
                            <span class="badge bg-success" id="mapa_count_selecionados">0</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 220px; overflow-y: auto;">
                                <table class="table table-sm table-hover table-striped mb-0 align-middle">
                                    <thead class="table-light sticky-top" style="z-index: 1;">
                                        <tr>
                                            <th class="text-nowrap">Pedido</th>
                                            <th class="text-nowrap">Cliente</th>
                                            <th class="text-nowrap">Cidade/UF</th>
                                            <th class="text-nowrap">Expedição</th>
                                            <th class="text-end text-nowrap">Valor</th>
                                            <th class="text-end text-nowrap">Peso</th>
                                            <th class="text-end text-nowrap">Pallet</th>
                                            <th class="text-nowrap">NF</th>
                                            <th class="text-nowrap">Lote</th>
                                            <th class="text-nowrap">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mapa_tabela_selecionados"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Pendentes NF CD -->
                    <div id="mapa_secao_pendentes_nf_cd" style="display: none;">
                        <div class="card border-warning mb-4">
                            <div class="card-header bg-warning bg-opacity-10 py-2 d-flex align-items-center justify-content-between">
                                <span>
                                    <i class="fas fa-undo text-warning me-1"></i>
                                    <strong>NF no CD — Não Selecionados</strong>
                                </span>
                                <span class="badge bg-warning text-dark" id="mapa_count_nf_cd">0</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 220px; overflow-y: auto;">
                                    <table class="table table-sm table-hover mb-0 align-middle">
                                        <thead class="table-warning sticky-top" style="z-index: 1;">
                                            <tr>
                                                <th class="text-nowrap">Pedido</th>
                                                <th class="text-nowrap">Cliente</th>
                                                <th class="text-nowrap">Cidade/UF</th>
                                                <th class="text-nowrap">Expedição</th>
                                                <th class="text-end text-nowrap">Valor</th>
                                                <th class="text-end text-nowrap">Peso</th>
                                                <th class="text-end text-nowrap">Pallet</th>
                                                <th class="text-nowrap">NF</th>
                                                <th class="text-nowrap">Lote</th>
                                                <th class="text-nowrap">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="mapa_tabela_nf_cd"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Pendentes Normais -->
                    <div id="mapa_secao_pendentes_normais" style="display: none;">
                        <div class="card border-info mb-4">
                            <div class="card-header bg-info bg-opacity-10 py-2 d-flex align-items-center justify-content-between">
                                <span>
                                    <i class="fas fa-box-open text-info me-1"></i>
                                    <strong>Pedidos Abertos — Não Selecionados</strong>
                                </span>
                                <span class="badge bg-info text-dark" id="mapa_count_normais">0</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 220px; overflow-y: auto;">
                                    <table class="table table-sm table-hover mb-0 align-middle">
                                        <thead class="table-info sticky-top" style="z-index: 1;">
                                            <tr>
                                                <th class="text-nowrap">Pedido</th>
                                                <th class="text-nowrap">Cliente</th>
                                                <th class="text-nowrap">Cidade/UF</th>
                                                <th class="text-nowrap">Expedição</th>
                                                <th class="text-end text-nowrap">Valor</th>
                                                <th class="text-end text-nowrap">Peso</th>
                                                <th class="text-end text-nowrap">Pallet</th>
                                                <th class="text-nowrap">NF</th>
                                                <th class="text-nowrap">Lote</th>
                                                <th class="text-nowrap">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="mapa_tabela_normais"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" id="btnProsseguirCotacaoMapa">
                        <i class="fas fa-arrow-right me-1"></i>Prosseguir mesmo assim
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Google Maps API -->
    <script>
        // Variáveis globais
        let map;
        let markers = [];
        let markerCluster;
        let directionsService;
        let directionsRenderer;
        let infoWindow;
        let clientesData = [];  // Renomeado de pedidosData para clientesData
        let rotaPolyline;
        let rotaCalculada = null;  // Armazenar última rota calculada
        let heatmap;
        let cdMarker;
        let cdData = null;

        // Pedidos selecionados
        const pedidosSelecionados = {{ pedidos_selecionados| tojson }};

        // Inicializar mapa
        function initMap() {
            // Configuração inicial do mapa - Centro no CD Nacom Goya
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -23.409447293705245, lng: -46.89113812682363 }, // CD Nacom Goya
                zoom: 11,
                mapTypeId: 'roadmap',
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            // Inicializar serviços
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#6c757d',
                    strokeWeight: 4,
                    strokeOpacity: 0.8
                }
            });

            infoWindow = new google.maps.InfoWindow();

            // Ajustar tamanho dos markers com base no zoom para melhor clicabilidade
            map.addListener('zoom_changed', ajustarTamanhoMarkers);

            // Carregar pedidos automaticamente se houver selecionados
            if (pedidosSelecionados.length > 0) {
                carregarPedidos();
            }
        }

        // Ajustar tamanho dos markers conforme o nível de zoom
        function ajustarTamanhoMarkers() {
            const zoom = map.getZoom();
            // Quanto menor o zoom (mais distante), maior o marker para facilitar clique
            let scaleWidth, scaleHeight;
            if (zoom < 8) {
                scaleWidth = 60;
                scaleHeight = 84;
            } else if (zoom < 10) {
                scaleWidth = 55;
                scaleHeight = 77;
            } else if (zoom < 12) {
                scaleWidth = 50;
                scaleHeight = 70;
            } else if (zoom < 14) {
                scaleWidth = 45;
                scaleHeight = 63;
            } else {
                scaleWidth = 40;
                scaleHeight = 56;
            }

            // Atualizar tamanho dos markers principais (clientes)
            markers.forEach((marker) => {
                if (marker.clienteData) {  // Apenas markers de cliente
                    const currentIcon = marker.getIcon();
                    if (currentIcon && currentIcon.scaledSize) {
                        marker.setIcon({
                            ...currentIcon,
                            scaledSize: new google.maps.Size(scaleWidth, scaleHeight),
                            anchor: new google.maps.Point(scaleWidth / 2, scaleHeight)
                        });
                    }
                }
            });
        }

        // Obter CSRF token
        function getCSRFToken() {
            const token = document.querySelector('meta[name="csrf-token"]');
            if (token) {
                return token.getAttribute('content');
            }
            // Fallback: tentar obter de um cookie
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrf_token='))
                ?.split('=')[1];
            return cookieValue || '';
        }

        // Carregar clientes (agrupados por CNPJ+endereço) no mapa
        function carregarPedidos() {
            showLoading();

            $.ajax({
                url: '/carteira/mapa/api/clientes',  // Nova API que agrupa por cliente
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                data: JSON.stringify({ pedidos: pedidosSelecionados }),
                success: function (response) {
                    if (response.sucesso) {
                        clientesData = response.clientes;
                        cdData = response.cd;
                        plotarClientesNoMapa(clientesData);
                        if (cdData) {
                            plotarCDNoMapa();
                        }
                        atualizarEstatisticas(response.resumo);
                        atualizarListaClientes(clientesData);
                        $('#sidePanel').show();
                    }
                    hideLoading();
                },
                error: function (xhr) {
                    hideLoading();
                    Swal.fire('Erro', xhr.responseJSON?.erro || 'Erro ao carregar clientes', 'error');
                }
            });
        }

        // Plotar CD no mapa
        function plotarCDNoMapa() {
            if (!cdData) return;

            // Criar marker para o CD
            cdMarker = new google.maps.Marker({
                position: {
                    lat: cdData.coordenadas.lat,
                    lng: cdData.coordenadas.lng
                },
                map: map,
                title: cdData.nome,
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    scaledSize: new google.maps.Size(50, 50)
                },
                animation: google.maps.Animation.DROP,
                zIndex: 1000
            });

            // InfoWindow do CD
            cdMarker.addListener('click', function () {
                const content = `
                    <div class="info-window">
                        <div class="info-window-header" style="background: #28a745;">
                            <h6 class="mb-0"><i class="fas fa-warehouse"></i> Centro de Distribuição</h6>
                        </div>
                        <div class="info-window-content">
                            <div class="info-row">
                                <span class="info-label">Nome:</span>
                                <span class="info-value">${cdData.nome}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Endereço:</span>
                                <span class="info-value">${cdData.endereco}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Tipo:</span>
                                <span class="info-value">Ponto de Origem</span>
                            </div>
                        </div>
                    </div>
                `;

                infoWindow.setContent(content);
                infoWindow.open(map, cdMarker);
            });

            markers.push(cdMarker);
        }

        // Plotar clientes no mapa (agrupados por CNPJ+endereço)
        function plotarClientesNoMapa(clientes) {
            // Limpar markers anteriores
            limparMarkers();

            const bounds = new google.maps.LatLngBounds();

            // Adicionar CD aos bounds se existir
            if (cdData) {
                bounds.extend({
                    lat: cdData.coordenadas.lat,
                    lng: cdData.coordenadas.lng
                });
            }

            clientes.forEach((cliente, index) => {
                const position = {
                    lat: cliente.coordenadas.lat,
                    lng: cliente.coordenadas.lng
                };

                // Determinar cor do marker baseado no status
                const markerColor = getMarkerColor(cliente.status);

                // Formatar peso para exibição
                const pesoFormatado = formatarPeso(cliente.totais.peso);

                // Criar marker customizado com número e peso
                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: `${cliente.cliente.nome} - ${cliente.totais.qtd_pedidos} pedido(s)`,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="70" viewBox="0 0 50 70">
                                <!-- Círculo principal com número -->
                                <circle cx="25" cy="20" r="18" fill="${getMarkerHexColor(cliente.status)}" stroke="white" stroke-width="2"/>
                                <text x="25" y="26" fill="white" font-size="16" font-weight="bold" text-anchor="middle">${index + 1}</text>
                                <!-- Badge de quantidade de pedidos -->
                                ${cliente.totais.qtd_pedidos > 1 ? `
                                <circle cx="40" cy="8" r="8" fill="#ef4444" stroke="white" stroke-width="1"/>
                                <text x="40" y="12" fill="white" font-size="10" font-weight="bold" text-anchor="middle">${cliente.totais.qtd_pedidos}</text>
                                ` : ''}
                                <!-- Retângulo com peso -->
                                <rect x="3" y="42" width="44" height="16" rx="4" fill="#1e40af"/>
                                <text x="25" y="54" fill="white" font-size="9" text-anchor="middle">${pesoFormatado}</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(50, 70),
                        anchor: new google.maps.Point(25, 70)
                    },
                    animation: google.maps.Animation.DROP,
                    clienteData: cliente,
                    optimized: false  // Melhora clicabilidade em zoom out
                });

                // Adicionar evento de clique
                marker.addListener('click', function () {
                    mostrarInfoWindowCliente(marker, cliente);
                });

                markers.push(marker);
                bounds.extend(position);
            });

            // Ajustar zoom para mostrar todos os markers
            if (clientes.length > 0) {
                map.fitBounds(bounds);

                // Ajustar zoom se estiver muito próximo
                google.maps.event.addListenerOnce(map, 'idle', function () {
                    if (map.getZoom() > 15) {
                        map.setZoom(15);
                    }
                });
            }
        }

        // Formatar peso para exibição compacta
        function formatarPeso(peso) {
            if (peso >= 1000) {
                return (peso / 1000).toFixed(1) + 't';
            }
            return peso.toFixed(0) + 'kg';
        }

        // Obter cor hexadecimal do marker baseado no status
        function getMarkerHexColor(status) {
            switch (status) {
                case 'agendado': return '#22c55e';  // Verde
                case 'urgente': return '#eab308';   // Amarelo
                case 'atrasado': return '#ef4444';  // Vermelho
                case 'pendente': return '#f97316';  // Laranja
                default: return '#3b82f6';          // Azul
            }
        }

        // Manter função antiga para compatibilidade (redireciona para a nova)
        function plotarPedidosNoMapa(pedidos) {
            // Converter formato antigo para novo se necessário
            const clientes = pedidos.map((p, i) => ({
                cliente_id: p.num_pedido,
                cliente: p.cliente,
                endereco: p.endereco,
                coordenadas: p.coordenadas,
                pedidos: [{
                    num_pedido: p.num_pedido,
                    valor: p.valores.total,
                    peso: p.valores.peso,
                    pallet: p.valores.pallet,
                    observacoes: p.observacoes
                }],
                totais: {
                    valor: p.valores.total,
                    peso: p.valores.peso,
                    pallet: p.valores.pallet,
                    qtd_pedidos: 1
                },
                status: p.status
            }));
            plotarClientesNoMapa(clientes);
        }

        // Obter cor do marker baseado no status
        function getMarkerColor(status) {
            switch (status) {
                case 'agendado': return 'green';
                case 'urgente': return 'yellow';
                case 'atrasado': return 'red';
                case 'pendente': return 'orange';
                default: return 'blue';
            }
        }

        // Mostrar InfoWindow para cliente (com lista de pedidos)
        function mostrarInfoWindowCliente(marker, cliente) {
            // Gerar lista de pedidos do cliente
            let pedidosHtml = '';
            cliente.pedidos.forEach((pedido, idx) => {
                const statusAgend = pedido.agendamento_confirmado
                    ? '<span class="badge bg-success">Confirmado</span>'
                    : (pedido.agendamento ? '<span class="badge bg-warning text-dark">Aguardando</span>' : '');

                pedidosHtml += `
                    <div class="border-start border-2 ps-2 mb-2 ${idx > 0 ? 'mt-2' : ''}">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${pedido.num_pedido}</strong>
                            ${statusAgend}
                        </div>
                        <div class="small text-muted">
                            R$ ${(pedido.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })} |
                            ${(pedido.peso || 0).toFixed(2)} kg
                        </div>
                        ${pedido.expedicao ? `<div class="small">Exp: ${pedido.expedicao}</div>` : ''}
                        ${pedido.agendamento ? `<div class="small">Agend: ${pedido.agendamento}</div>` : ''}
                    </div>
                `;
            });

            const content = `
                <div class="info-window" style="max-width: 350px;">
                    <div class="info-window-header" style="background: ${getMarkerHexColor(cliente.status)};">
                        <h6 class="mb-0 text-white">
                            <i class="fas fa-building"></i> ${cliente.cliente.nome}
                            <span class="badge bg-light text-dark ms-2">${cliente.totais.qtd_pedidos} pedido(s)</span>
                        </h6>
                    </div>
                    <div class="info-window-content">
                        <div class="info-row">
                            <span class="info-label">CNPJ:</span>
                            <span class="info-value">${cliente.cliente.cnpj || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Endereço:</span>
                            <span class="info-value">${cliente.endereco.completo}</span>
                        </div>
                        ${cliente.cliente.telefone ? `
                        <div class="info-row">
                            <span class="info-label">Telefone:</span>
                            <span class="info-value">${cliente.cliente.telefone}</span>
                        </div>` : ''}

                        <hr>
                        <h6 class="mb-2"><i class="fas fa-calculator"></i> Totais</h6>
                        <div class="row text-center small">
                            <div class="col-4">
                                <div class="fw-bold text-primary">R$ ${cliente.totais.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                                <div class="text-muted">Valor</div>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold text-success">${cliente.totais.peso.toFixed(2)} kg</div>
                                <div class="text-muted">Peso</div>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold text-info">${cliente.totais.pallet.toFixed(2)}</div>
                                <div class="text-muted">Pallets</div>
                            </div>
                        </div>

                        <hr>
                        <h6 class="mb-2"><i class="fas fa-file-alt"></i> Pedidos</h6>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${pedidosHtml}
                        </div>

                        <div class="mt-3 text-center">
                            <button class="btn btn-sm btn-success" onclick="navegarAte(${cliente.coordenadas.lat}, ${cliente.coordenadas.lng})">
                                <i class="fas fa-directions"></i> Navegar
                            </button>
                        </div>
                    </div>
                </div>
            `;

            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        }

        // Manter função antiga para compatibilidade
        function mostrarInfoWindow(marker, pedido) {
            // Converter para formato de cliente se necessário
            const cliente = pedido.cliente_id ? pedido : {
                cliente_id: pedido.num_pedido,
                cliente: pedido.cliente,
                endereco: pedido.endereco,
                coordenadas: pedido.coordenadas,
                pedidos: [{
                    num_pedido: pedido.num_pedido,
                    valor: pedido.valores?.total || 0,
                    peso: pedido.valores?.peso || 0,
                    pallet: pedido.valores?.pallet || 0,
                    expedicao: pedido.datas?.expedicao,
                    agendamento: pedido.datas?.agendamento,
                    agendamento_confirmado: false
                }],
                totais: {
                    valor: pedido.valores?.total || 0,
                    peso: pedido.valores?.peso || 0,
                    pallet: pedido.valores?.pallet || 0,
                    qtd_pedidos: 1
                },
                status: pedido.status
            };
            mostrarInfoWindowCliente(marker, cliente);
        }

        // Limpar markers
        function limparMarkers() {
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];

            if (markerCluster) {
                markerCluster.clearMarkers();
            }
        }

        // Atualizar estatísticas (suporta formato antigo e novo)
        function atualizarEstatisticas(resumo) {
            // Exibir total de pedidos (não de clientes)
            const totalPedidos = resumo.total_pedidos || clientesData.reduce((acc, c) => acc + (c.totais?.qtd_pedidos || 1), 0);
            $('#totalPedidos').text(totalPedidos);
            $('#valorTotal').text('R$ ' + (resumo.valor_total || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 }));
            $('#pesoTotal').text((resumo.peso_total || 0).toFixed(2) + ' kg');
            $('#palletTotal').text((resumo.pallet_total || 0).toFixed(2));
        }

        // Recalcular totais baseado nos clientes selecionados (checkboxes)
        function recalcularTotais() {
            const selecionados = getClientesSelecionados();
            let totalPedidos = 0, valorTotal = 0, pesoTotal = 0, palletTotal = 0;

            selecionados.forEach(cliente => {
                totalPedidos += cliente.totais.qtd_pedidos;
                valorTotal += cliente.totais.valor;
                pesoTotal += cliente.totais.peso;
                palletTotal += cliente.totais.pallet;
            });

            $('#totalPedidos').text(totalPedidos);
            $('#valorTotal').text('R$ ' + valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 }));
            $('#pesoTotal').text(pesoTotal.toFixed(2) + ' kg');
            $('#palletTotal').text(palletTotal.toFixed(2));
        }

        // Obter clientes selecionados (todos os marcados no checkbox)
        function getClientesSelecionados() {
            const selecionados = [];
            $('.cliente-checkbox:checked').each(function() {
                const clienteId = $(this).data('cliente-id');
                const cliente = clientesData.find(c => c.cliente_id === clienteId);
                if (cliente) {
                    selecionados.push(cliente);
                }
            });
            // Se nenhum checkbox estiver marcado, retornar todos
            if (selecionados.length === 0) {
                return clientesData;
            }
            return selecionados;
        }

        // Atualizar lista de clientes (agrupados)
        function atualizarListaClientes(clientes) {
            let html = `
                <div class="mb-3 border-bottom pb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <input type="checkbox" id="selectAllClientes" checked onchange="toggleSelectAll(this)">
                            <label for="selectAllClientes" class="ms-1 small">Selecionar Todos</label>
                        </div>
                        <span class="badge bg-secondary">${clientes.length} entregas</span>
                    </div>
                </div>
            `;

            clientes.forEach((cliente, index) => {
                const statusClass = cliente.status || 'pendente';
                const statusBadge = cliente.status === 'agendado'
                    ? '<span class="badge bg-success">Agendado</span>'
                    : (cliente.status === 'urgente'
                        ? '<span class="badge bg-warning text-dark">Urgente</span>'
                        : '<span class="badge bg-secondary">Pendente</span>');

                // Lista de pedidos do cliente
                let pedidosHtml = '';
                cliente.pedidos.forEach(pedido => {
                    const agendStatus = pedido.agendamento_confirmado
                        ? '<i class="fas fa-check-circle text-success" title="Confirmado"></i>'
                        : (pedido.agendamento ? '<i class="fas fa-clock text-warning" title="Aguardando"></i>' : '');

                    pedidosHtml += `
                        <div class="pedido-sub-item small py-1 ps-3 border-start">
                            <div class="d-flex justify-content-between">
                                <span>${pedido.num_pedido}</span>
                                ${agendStatus}
                            </div>
                            <div class="text-muted">R$ ${(pedido.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                        </div>
                    `;
                });

                html += `
                    <div class="cliente-item ${statusClass} ${cliente.na_rota ? 'na-rota' : ''}" data-cliente-id="${cliente.cliente_id}">
                        <div class="d-flex align-items-start">
                            <input type="checkbox" class="cliente-checkbox me-2 mt-1"
                                   data-cliente-id="${cliente.cliente_id}"
                                   checked
                                   onchange="recalcularTotais()">
                            <div class="flex-grow-1" onclick="focusCliente(${index})">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong>${index + 1}. ${cliente.cliente.nome || 'Cliente'}</strong>
                                    <span class="badge bg-info">${cliente.totais.qtd_pedidos} ped.</span>
                                </div>
                                <div class="small mt-1">
                                    <div class="text-muted">${cliente.endereco.cidade || ''}/${cliente.endereco.uf || ''}</div>
                                    <div class="d-flex justify-content-between">
                                        <span>R$ ${cliente.totais.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
                                        <span>${cliente.totais.peso.toFixed(0)} kg</span>
                                    </div>
                                </div>
                                ${cliente.totais.qtd_pedidos > 1 ? `
                                <div class="mt-2">
                                    <a class="small text-primary" data-bs-toggle="collapse" href="#pedidos-${cliente.cliente_id}" role="button">
                                        <i class="fas fa-chevron-down"></i> Ver pedidos
                                    </a>
                                    <div class="collapse mt-2" id="pedidos-${cliente.cliente_id}">
                                        ${pedidosHtml}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            $('#pedidosList').html(html);
        }

        // Toggle selecionar todos os clientes
        function toggleSelectAll(checkbox) {
            $('.cliente-checkbox').prop('checked', checkbox.checked);
            recalcularTotais();
        }

        // Manter função antiga para compatibilidade
        function atualizarListaPedidos(pedidos) {
            // Converter para formato de clientes
            const clientes = pedidos.map((p, i) => ({
                cliente_id: p.num_pedido,
                cliente: p.cliente,
                endereco: p.endereco,
                coordenadas: p.coordenadas,
                pedidos: [{
                    num_pedido: p.num_pedido,
                    valor: p.valores?.total || 0,
                    peso: p.valores?.peso || 0
                }],
                totais: {
                    valor: p.valores?.total || 0,
                    peso: p.valores?.peso || 0,
                    pallet: p.valores?.pallet || 0,
                    qtd_pedidos: 1
                },
                status: p.status
            }));
            atualizarListaClientes(clientes);
        }

        // Focar em cliente específico
        function focusCliente(index) {
            const cliente = clientesData[index];
            const marker = markers[index];  // Agora 1 marker por cliente

            if (!cliente || !marker) return;

            map.setCenter({
                lat: cliente.coordenadas.lat,
                lng: cliente.coordenadas.lng
            });
            map.setZoom(15);

            // Abrir InfoWindow
            mostrarInfoWindowCliente(marker, cliente);

            // Destacar na lista
            $('.cliente-item').removeClass('selected');
            $('.cliente-item').eq(index).addClass('selected');
        }

        // Manter função antiga para compatibilidade
        function focusPedido(index) {
            focusCliente(index);
        }

        // Calcular rota otimizada (usando clientes agrupados)
        function calcularRotaOtimizada() {
            const clientesSelecionados = getClientesSelecionados();

            if (clientesSelecionados.length < 2) {
                Swal.fire('Aviso', 'Selecione pelo menos 2 entregas para calcular a rota', 'warning');
                return;
            }

            showLoading();

            $.ajax({
                url: '/carteira/mapa/api/rota-clientes',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                data: JSON.stringify({ clientes: clientesSelecionados }),
                success: function (response) {
                    if (response.sucesso) {
                        // Armazenar rota calculada para exportação
                        rotaCalculada = response.rota;

                        exibirRotaOtimizadaClientes(response.rota, clientesSelecionados);

                        // Atualizar informações do veículo e pedágio
                        if (response.veiculo) {
                            $('#veiculoSelecionado').text(response.veiculo.nome);
                            $('#veiculoSelecionado').attr('title',
                                `Capacidade: ${response.veiculo.peso_maximo} kg | ${response.veiculo.tipo} | ${response.veiculo.eixos} eixos`);
                        }

                        if (response.pedagio) {
                            $('#pedagioEstimado').text(`R$ ${response.pedagio.valor_total.toFixed(2)}`);
                            $('#pedagioEstimado').attr('title',
                                `${response.pedagio.num_pracas_estimado} praça(s) × R$ ${response.pedagio.valor_medio_praca.toFixed(2)}`);
                        }

                        // Reordenar painel lateral conforme ordem da rota
                        reordenarPainelLateral(response.rota.ordem_clientes);

                        mostrarEstatisticasRotaCompleta(response.rota, response.estatisticas, response.veiculo, response.pedagio);
                    }
                    hideLoading();
                },
                error: function (xhr) {
                    hideLoading();
                    Swal.fire('Erro', xhr.responseJSON?.erro || 'Erro ao calcular rota', 'error');
                }
            });
        }

        // Reordenar painel lateral conforme ordem da rota otimizada
        function reordenarPainelLateral(ordemClientes) {
            // Reordenar clientesData com base na ordem da rota
            const novosClientes = [];

            // Primeiro, adicionar os clientes na ordem da rota
            ordemClientes.forEach(clienteId => {
                const cliente = clientesData.find(c => c.cliente_id === clienteId);
                if (cliente) {
                    cliente.na_rota = true;  // Flag para destacar (cor verde)
                    novosClientes.push(cliente);
                }
            });

            // Depois, adicionar clientes que não estão na rota (desmarcados)
            clientesData.forEach(c => {
                if (!novosClientes.includes(c)) {
                    c.na_rota = false;
                    novosClientes.push(c);
                }
            });

            clientesData = novosClientes;
            atualizarListaClientes(clientesData);
        }

        // Variáveis para armazenar marcadores de ordem e pedágio
        let ordemMarkers = [];
        let pedagioMarkers = [];

        // Exibir rota otimizada para clientes
        function exibirRotaOtimizadaClientes(rota, clientes) {
            // Limpar rota anterior
            if (rotaPolyline) {
                rotaPolyline.setMap(null);
            }

            // Limpar marcadores de ordem anteriores
            ordemMarkers.forEach(marker => marker.setMap(null));
            ordemMarkers = [];

            // Limpar marcadores de pedágio anteriores
            pedagioMarkers.forEach(marker => marker.setMap(null));
            pedagioMarkers = [];

            // Decodificar polyline
            const path = google.maps.geometry.encoding.decodePath(rota.polyline);

            // Criar nova polyline com cor personalizada
            rotaPolyline = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: '#10b981',  // Verde esmeralda
                strokeOpacity: 0.9,
                strokeWeight: 5,
                icons: [{
                    icon: {
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        scale: 3,
                        strokeColor: '#065f46',
                        strokeWeight: 2,
                        fillColor: '#10b981',
                        fillOpacity: 1
                    },
                    offset: '100%',
                    repeat: '150px'
                }],
                map: map
            });

            // Adicionar marcadores de ordem para cada cliente
            if (rota.ordem_clientes && rota.legs) {
                const temposAcumulados = [];
                let tempoTotal = 0;

                // Calcular tempo acumulado para cada ponto
                for (let i = 0; i <= rota.ordem_clientes.length && i < rota.legs.length; i++) {
                    const duracaoTexto = rota.legs[i]?.duracao || '0 min';
                    const match = duracaoTexto.match(/\d+/);
                    if (match) {
                        tempoTotal += parseInt(match[0]);
                    }
                    temposAcumulados.push(tempoTotal);
                }

                rota.ordem_clientes.forEach((clienteId, index) => {
                    const cliente = clientes.find(c => c.cliente_id === clienteId);

                    if (cliente) {
                        const tempoAcumulado = temposAcumulados[index] || 0;
                        const pesoFormatado = formatarPeso(cliente.totais.peso);

                        // Criar marcador customizado com ordem (DESTAQUE PRINCIPAL)
                        const ordemLabel = new google.maps.Marker({
                            position: {
                                lat: cliente.coordenadas.lat,
                                lng: cliente.coordenadas.lng
                            },
                            map: map,
                            icon: {
                                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                    <svg xmlns="http://www.w3.org/2000/svg" width="50" height="70" viewBox="0 0 50 70">
                                        <!-- Círculo principal com número - VERDE para indicar na rota -->
                                        <circle cx="25" cy="20" r="18" fill="#10b981" stroke="white" stroke-width="3"/>
                                        <text x="25" y="26" fill="white" font-size="16" font-weight="bold" text-anchor="middle">${index + 1}</text>
                                        <!-- Badge de quantidade de pedidos -->
                                        ${cliente.totais.qtd_pedidos > 1 ? `
                                        <circle cx="40" cy="8" r="8" fill="#3b82f6" stroke="white" stroke-width="1"/>
                                        <text x="40" y="12" fill="white" font-size="10" font-weight="bold" text-anchor="middle">${cliente.totais.qtd_pedidos}</text>
                                        ` : ''}
                                        <!-- Retângulo com peso -->
                                        <rect x="3" y="42" width="44" height="16" rx="4" fill="#1e40af"/>
                                        <text x="25" y="54" fill="white" font-size="9" text-anchor="middle">${pesoFormatado}</text>
                                    </svg>
                                `),
                                scaledSize: new google.maps.Size(50, 70),
                                anchor: new google.maps.Point(25, 70)
                            },
                            title: `${index + 1}º - ${cliente.cliente.nome}`,
                            zIndex: 1200 + index
                        });

                        // Criar label com tempo estimado
                        const tempoLabel = new google.maps.Marker({
                            position: {
                                lat: cliente.coordenadas.lat + 0.0025,
                                lng: cliente.coordenadas.lng
                            },
                            map: map,
                            icon: {
                                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                    <svg xmlns="http://www.w3.org/2000/svg" width="70" height="22">
                                        <rect x="3" y="2" width="64" height="18" rx="9" fill="#1e40af" stroke="#ffffff" stroke-width="1" opacity="0.85"/>
                                        <text x="35" y="14" font-family="Arial, sans-serif" font-size="10" fill="white" text-anchor="middle" font-weight="bold">
                                            ${tempoAcumulado > 0 ? `${tempoAcumulado} min` : 'PARTIDA'}
                                        </text>
                                    </svg>
                                `),
                                anchor: new google.maps.Point(35, 22)
                            },
                            zIndex: 1000 + index
                        });

                        // InfoWindow ao clicar
                        ordemLabel.addListener('click', () => {
                            // Listar todos os pedidos deste cliente
                            const pedidosStr = cliente.pedidos.map(p => p.num_pedido).join(', ');

                            const infoContent = `
                                <div style="padding: 10px;">
                                    <h6 class="mb-2"><strong>${index + 1}ª Entrega</strong></h6>
                                    <p class="mb-1"><strong>Cliente:</strong> ${cliente.cliente.nome}</p>
                                    <p class="mb-1"><strong>CNPJ:</strong> ${cliente.cliente.cnpj || '-'}</p>
                                    <p class="mb-1"><strong>Pedidos (${cliente.totais.qtd_pedidos}):</strong> ${pedidosStr}</p>
                                    <p class="mb-1"><strong>Valor Total:</strong> R$ ${cliente.totais.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                                    <p class="mb-1"><strong>Peso Total:</strong> ${cliente.totais.peso.toFixed(2)} kg</p>
                                    <p class="mb-1"><strong>Tempo até aqui:</strong> ${tempoAcumulado > 0 ? `${tempoAcumulado} minutos` : 'Ponto de partida'}</p>
                                    ${index < rota.legs.length ? `<p class="mb-1"><strong>Próximo trecho:</strong> ${rota.legs[index].distancia} - ${rota.legs[index].duracao}</p>` : ''}
                                </div>
                            `;

                            if (infoWindow) {
                                infoWindow.close();
                            }

                            infoWindow = new google.maps.InfoWindow({
                                content: infoContent
                            });

                            infoWindow.open(map, ordemLabel);
                        });

                        ordemMarkers.push(ordemLabel);
                        ordemMarkers.push(tempoLabel);
                    }
                });
            }

            // Adicionar marcadores de pedágio estimados
            adicionarMarcadoresPedagio(path, rota.distancia_total_km);

            // Ajustar bounds
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(new google.maps.LatLng(rota.bounds.southwest.lat, rota.bounds.southwest.lng));
            bounds.extend(new google.maps.LatLng(rota.bounds.northeast.lat, rota.bounds.northeast.lng));
            map.fitBounds(bounds);
        }

        // Função antiga mantida para compatibilidade
        function exibirRotaOtimizada(rota) {
            // Limpar rota anterior
            if (rotaPolyline) {
                rotaPolyline.setMap(null);
            }

            // Limpar marcadores de ordem anteriores
            ordemMarkers.forEach(marker => marker.setMap(null));
            ordemMarkers = [];

            // Limpar marcadores de pedágio anteriores
            pedagioMarkers.forEach(marker => marker.setMap(null));
            pedagioMarkers = [];

            // Decodificar polyline
            const path = google.maps.geometry.encoding.decodePath(rota.polyline);

            // Criar nova polyline com cor personalizada
            rotaPolyline = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: '#10b981',  // Verde esmeralda
                strokeOpacity: 0.9,
                strokeWeight: 5,
                icons: [{
                    icon: {
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        scale: 3,
                        strokeColor: '#065f46',
                        strokeWeight: 2,
                        fillColor: '#10b981',
                        fillOpacity: 1
                    },
                    offset: '100%',
                    repeat: '150px'  // Setas a cada 150px
                }],
                map: map
            });

            // Adicionar marcadores de ordem e tempo para cada pedido
            if (rota.ordem_pedidos && rota.legs) {
                // Array para armazenar tempos acumulados para cada pedido
                const temposAcumulados = [];
                let tempoTotal = 0;

                // Calcular tempo acumulado para cada ponto
                for (let i = 0; i <= rota.ordem_pedidos.length && i < rota.legs.length; i++) {
                    if (i === 0) {
                        // Tempo do CD até o primeiro pedido
                        const duracaoTexto = rota.legs[0].duracao;
                        const match = duracaoTexto.match(/\d+/);
                        if (match) {
                            tempoTotal = parseInt(match[0]);
                        }
                        temposAcumulados.push(tempoTotal);
                    } else {
                        // Tempo entre pedidos
                        const duracaoTexto = rota.legs[i].duracao;
                        const match = duracaoTexto.match(/\d+/);
                        if (match) {
                            tempoTotal += parseInt(match[0]);
                        }
                        temposAcumulados.push(tempoTotal);
                    }
                }

                rota.ordem_pedidos.forEach((numPedido, index) => {
                    // Encontrar o pedido nos dados
                    const pedido = pedidosData.find(p => p.num_pedido === numPedido);

                    if (pedido) {
                        // Usar o tempo acumulado calculado
                        const tempoAcumulado = temposAcumulados[index] || 0;

                        // Verificar se há outro pedido no mesmo local (mesmo cliente)
                        let offsetLat = 0;
                        let offsetLng = 0;
                        let pedidosNoMesmoLocal = 0;

                        // Verificar pedidos anteriores no mesmo CNPJ ou coordenadas muito próximas
                        for (let j = 0; j < index; j++) {
                            const outroPedido = pedidosData.find(p => p.num_pedido === rota.ordem_pedidos[j]);
                            if (outroPedido) {
                                // Verificar se é o mesmo cliente (CNPJ) ou coordenadas muito próximas
                                const mesmoCNPJ = outroPedido.cliente.cnpj === pedido.cliente.cnpj;
                                const distanciaLat = Math.abs(outroPedido.coordenadas.lat - pedido.coordenadas.lat);
                                const distanciaLng = Math.abs(outroPedido.coordenadas.lng - pedido.coordenadas.lng);
                                const muitoProximo = distanciaLat < 0.0001 && distanciaLng < 0.0001;

                                if (mesmoCNPJ && muitoProximo) {  // Só aplicar offset se for mesmo CNPJ E mesmo local
                                    pedidosNoMesmoLocal++;
                                    // Aplicar offset diagonal para separar visualmente
                                    offsetLat = pedidosNoMesmoLocal * 0.0004;
                                    offsetLng = pedidosNoMesmoLocal * 0.0004;
                                }
                            }
                        }

                        // Criar marcador customizado com ordem (DESTAQUE PRINCIPAL)
                        const ordemLabel = new google.maps.Marker({
                            position: {
                                lat: pedido.coordenadas.lat + offsetLat,
                                lng: pedido.coordenadas.lng + offsetLng
                            },
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 18,  // Aumentado para destaque
                                fillColor: '#dc2626',  // Vermelho
                                fillOpacity: 0.95,
                                strokeColor: '#ffffff',
                                strokeWeight: 3
                            },
                            label: {
                                text: String(index + 1),
                                color: '#ffffff',
                                fontSize: '14px',  // Aumentado para visibilidade
                                fontWeight: 'bold'
                            },
                            title: `${index + 1}º - ${pedido.num_pedido}`,
                            zIndex: 1200 + index  // zIndex mais alto para ficar acima de tudo
                        });

                        // Criar label com tempo estimado (posicionado ACIMA do marcador - menos destaque)
                        const tempoLabel = new google.maps.Marker({
                            position: {
                                lat: pedido.coordenadas.lat + offsetLat + 0.0025,  // Bem acima do marcador
                                lng: pedido.coordenadas.lng + offsetLng
                            },
                            map: map,
                            icon: {
                                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                    <svg xmlns="http://www.w3.org/2000/svg" width="70" height="22">
                                        <rect x="3" y="2" width="64" height="18" rx="9" fill="#1e40af" stroke="#ffffff" stroke-width="1" opacity="0.85"/>
                                        <text x="35" y="14" font-family="Arial, sans-serif" font-size="10" fill="white" text-anchor="middle" font-weight="bold">
                                            ${tempoAcumulado > 0 ? `${tempoAcumulado} min` : 'PARTIDA'}
                                        </text>
                                    </svg>
                                `),
                                anchor: new google.maps.Point(35, 22)  // Ancorar na parte inferior do SVG
                            },
                            zIndex: 1000 + index  // zIndex menor que o marcador de ordem
                        });

                        // InfoWindow ao clicar
                        ordemLabel.addListener('click', () => {
                            // Verificar se há outros pedidos do mesmo cliente nesta rota
                            const pedidosMesmoCliente = rota.ordem_pedidos.filter(numPed => {
                                const p = pedidosData.find(pd => pd.num_pedido === numPed);
                                return p && p.cliente.cnpj === pedido.cliente.cnpj;
                            });

                            let pedidosInfo = '';
                            if (pedidosMesmoCliente.length > 1) {
                                pedidosInfo = `<p class="mb-1"><strong>Pedidos neste local:</strong> ${pedidosMesmoCliente.join(', ')}</p>`;
                            }

                            const infoContent = `
                                <div style="padding: 10px;">
                                    <h6 class="mb-2"><strong>${index + 1}ª Entrega</strong></h6>
                                    <p class="mb-1"><strong>Pedido:</strong> ${pedido.num_pedido}</p>
                                    <p class="mb-1"><strong>Cliente:</strong> ${pedido.cliente.nome}</p>
                                    <p class="mb-1"><strong>CNPJ:</strong> ${pedido.cliente.cnpj}</p>
                                    ${pedidosInfo}
                                    <p class="mb-1"><strong>Endereço:</strong> ${pedido.endereco.rua}, ${pedido.endereco.numero}</p>
                                    <p class="mb-1"><strong>Tempo até aqui:</strong> ${tempoAcumulado > 0 ? `${tempoAcumulado} minutos` : 'Ponto de partida'}</p>
                                    ${index < rota.legs.length ? `<p class="mb-1"><strong>Próximo trecho:</strong> ${rota.legs[index].distancia} - ${rota.legs[index].duracao}</p>` : ''}
                                    ${pedidosNoMesmoLocal > 0 ? `<div class="alert alert-info mt-2 mb-0"><small>⚠️ Múltiplas entregas neste endereço</small></div>` : ''}
                                </div>
                            `;

                            if (infoWindow) {
                                infoWindow.close();
                            }

                            infoWindow = new google.maps.InfoWindow({
                                content: infoContent
                            });

                            infoWindow.open(map, ordemLabel);
                        });

                        ordemMarkers.push(ordemLabel);
                        ordemMarkers.push(tempoLabel);
                    }
                });
            }

            // Adicionar marcadores de pedágio estimados
            adicionarMarcadoresPedagio(path, rota.distancia_total_km);

            // Ajustar bounds
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(new google.maps.LatLng(rota.bounds.southwest.lat, rota.bounds.southwest.lng));
            bounds.extend(new google.maps.LatLng(rota.bounds.northeast.lat, rota.bounds.northeast.lng));
            map.fitBounds(bounds);
        }

        // Função para adicionar marcadores de pedágio
        function adicionarMarcadoresPedagio(path, distanciaTotal) {
            // Estimar praças de pedágio (1 a cada 45km em rodovias pedagiadas)
            const distanciaPedagiada = distanciaTotal * 0.6; // 60% da rota
            const numPracas = Math.max(1, Math.floor(distanciaPedagiada / 45));

            // Distribuir praças ao longo da rota
            const totalPoints = path.length;
            const interval = Math.floor(totalPoints / (numPracas + 1));

            for (let i = 1; i <= numPracas; i++) {
                const pointIndex = Math.min(i * interval, totalPoints - 1);
                const position = path[pointIndex];

                // Criar marcador de pedágio (menor destaque que marcador de entrega)
                const pedagioMarker = new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28">
                                <!-- Fundo circular amarelo claro -->
                                <circle cx="14" cy="14" r="12" fill="#fde68a" stroke="#fbbf24" stroke-width="1.5" opacity="0.9"/>
                                <!-- Símbolo de dinheiro -->
                                <text x="14" y="19" font-family="Arial, sans-serif" font-size="14" fill="#92400e" text-anchor="middle" font-weight="bold">$</text>
                            </svg>
                        `),
                        anchor: new google.maps.Point(14, 14),
                        scaledSize: new google.maps.Size(28, 28)
                    },
                    title: `Praça de Pedágio ${i}`,
                    zIndex: 800  // Bem abaixo do marcador de entrega (1200)
                });

                // Adicionar InfoWindow ao clicar
                pedagioMarker.addListener('click', () => {
                    const valorEstimado = $('#pedagioEstimado').text();
                    const veiculoNome = $('#veiculoSelecionado').text();

                    const infoContent = `
                        <div style="padding: 10px;">
                            <h6 class="mb-2"><strong>🛣️ Praça de Pedágio ${i}</strong></h6>
                            <p class="mb-1"><strong>Posição estimada:</strong> Km ${Math.round((i * 45) + (Math.random() * 10 - 5))}</p>
                            <p class="mb-1"><strong>Veículo:</strong> ${veiculoNome || 'Não definido'}</p>
                            <p class="mb-1"><strong>Valor estimado:</strong> ${valorEstimado ? (parseFloat(valorEstimado.replace('R$ ', '').replace(',', '.')) / numPracas).toFixed(2) : '0.00'}</p>
                            <div class="alert alert-info mt-2 mb-0">
                                <small>⚠️ Posição e valor estimados. Consulte rotas oficiais para valores exatos.</small>
                            </div>
                        </div>
                    `;

                    if (infoWindow) {
                        infoWindow.close();
                    }

                    infoWindow = new google.maps.InfoWindow({
                        content: infoContent,
                        maxWidth: 300
                    });

                    infoWindow.open(map, pedagioMarker);
                });

                // Adicionar label flutuante com valor
                const valorPorPraca = $('#pedagioEstimado').text() ?
                    (parseFloat($('#pedagioEstimado').text().replace('R$ ', '').replace(',', '.')) / numPracas).toFixed(2) :
                    '8.50';

                const labelPedagio = new google.maps.Marker({
                    position: {
                        lat: position.lat() - 0.0006,  // Posicionar abaixo
                        lng: position.lng()
                    },
                    map: map,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="18">
                                <rect x="0" y="0" width="50" height="16" rx="8" fill="#fde68a" opacity="0.85"/>
                                <text x="25" y="12" font-family="Arial, sans-serif" font-size="9" fill="#92400e" text-anchor="middle" font-weight="bold">
                                    R$ ${valorPorPraca}
                                </text>
                            </svg>
                        `),
                        anchor: new google.maps.Point(25, 8)
                    },
                    zIndex: 799  // Abaixo do marcador de entrega
                });

                pedagioMarkers.push(pedagioMarker);
                pedagioMarkers.push(labelPedagio);
            }
        }

        // Gerar HTML da ordem de entrega (agrupada por cliente)
        function gerarOrdemEntregaHtml(rota) {
            let html = '';
            const ordemIds = rota.ordem_clientes || rota.ordem_pedidos || [];

            ordemIds.forEach((id, idx) => {
                // Tentar encontrar como cliente primeiro
                const cliente = clientesData.find(c => c.cliente_id === id);

                if (cliente) {
                    // É um cliente agrupado
                    const pedidosStr = cliente.pedidos.map(p => p.num_pedido).join(', ');
                    const agendStatus = cliente.pedidos.some(p => p.agendamento_confirmado)
                        ? '<span class="badge bg-success ms-2">Confirmado</span>'
                        : (cliente.pedidos.some(p => p.agendamento)
                            ? '<span class="badge bg-warning text-dark ms-2">Aguardando</span>'
                            : '');

                    html += `
                        <div class="entrega-item border-start border-3 border-success ps-2 mb-2">
                            <strong>${idx + 1}. ${cliente.cliente.nome}</strong>
                            <span class="badge bg-info ms-2">${cliente.totais.qtd_pedidos} pedido(s)</span>
                            ${agendStatus}
                            <div class="small text-muted mt-1">
                                <div>📍 ${cliente.endereco.cidade || ''}/${cliente.endereco.uf || ''}</div>
                                <div>📦 Pedidos: ${pedidosStr}</div>
                                <div>💰 R$ ${cliente.totais.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} | ⚖️ ${cliente.totais.peso.toFixed(2)} kg</div>
                            </div>
                        </div>
                    `;
                } else {
                    // Fallback para formato antigo (pedido individual)
                    html += `
                        <div class="entrega-item border-start border-3 border-secondary ps-2 mb-2">
                            <strong>${idx + 1}. Pedido ${id}</strong>
                        </div>
                    `;
                }
            });

            return html || '<p class="text-muted">Nenhuma entrega na rota</p>';
        }

        // Mostrar estatísticas da rota (versão simplificada mantida para compatibilidade)
        function mostrarEstatisticasRota(rota, estatisticas) {
            mostrarEstatisticasRotaCompleta(rota, estatisticas, null, null);
        }

        // Mostrar estatísticas completas da rota com veículo e pedágio
        function mostrarEstatisticasRotaCompleta(rota, estatisticas, veiculo, pedagio) {
            let legsHtml = '';
            rota.legs.forEach((leg, index) => {
                legsHtml += `
                    <tr>
                        <td>Trecho ${index + 1}</td>
                        <td>${leg.distancia}</td>
                        <td>${leg.duracao}</td>
                    </tr>
                `;
            });

            // Seção do veículo
            let veiculoHtml = '';
            if (veiculo) {
                veiculoHtml = `
                    <h5 class="mt-3">🚚 Veículo Selecionado</h5>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Veículo:</strong></td>
                            <td>${veiculo.nome}</td>
                        </tr>
                        <tr>
                            <td><strong>Capacidade:</strong></td>
                            <td>${veiculo.peso_maximo.toLocaleString('pt-BR')} kg</td>
                        </tr>
                        <tr>
                            <td><strong>Tipo:</strong></td>
                            <td>${veiculo.tipo} (${veiculo.eixos} eixos)</td>
                        </tr>
                        <tr>
                            <td><strong>Peso da Carga:</strong></td>
                            <td>${estatisticas.peso_total.toLocaleString('pt-BR')} kg</td>
                        </tr>
                        <tr>
                            <td><strong>Utilização:</strong></td>
                            <td>${((estatisticas.peso_total / veiculo.peso_maximo) * 100).toFixed(1)}%</td>
                        </tr>
                    </table>
                `;
            }

            // Seção do pedágio
            let pedagioHtml = '';
            if (pedagio) {
                pedagioHtml = `
                    <h5 class="mt-3">💰 Estimativa de Pedágio</h5>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Valor Total:</strong></td>
                            <td class="text-success"><strong>R$ ${pedagio.valor_total.toFixed(2)}</strong></td>
                        </tr>
                        <tr>
                            <td><strong>Praças Estimadas:</strong></td>
                            <td>${pedagio.num_pracas_estimado}</td>
                        </tr>
                        <tr>
                            <td><strong>Valor Médio/Praça:</strong></td>
                            <td>R$ ${pedagio.valor_medio_praca.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Distância Pedagiada:</strong></td>
                            <td>${pedagio.distancia_pedagiada_km} km (60% da rota)</td>
                        </tr>
                        <tr>
                            <td><strong>Fator do Veículo:</strong></td>
                            <td>${pedagio.multiplicador_veiculo}x (base: R$ ${pedagio.valor_base_carro.toFixed(2)})</td>
                        </tr>
                    </table>
                    <div class="alert alert-info mt-2">
                        <small><i class="fas fa-info-circle"></i> ${pedagio.observacao}</small>
                    </div>
                `;
            }

            Swal.fire({
                title: '📍 Rota Otimizada',
                html: `
                    <div class="text-start">
                        <h5>📊 Resumo da Rota</h5>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Distância Total:</strong></td>
                                <td>${rota.distancia_total_km.toFixed(1)} km</td>
                            </tr>
                            <tr>
                                <td><strong>Tempo Estimado:</strong></td>
                                <td>${rota.tempo_formatado}</td>
                            </tr>
                            <tr>
                                <td><strong>Custo Combustível:</strong></td>
                                <td>R$ ${estatisticas.custo_estimado_km.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td><strong>Total de Pedidos:</strong></td>
                                <td>${estatisticas.total_pedidos}</td>
                            </tr>
                            <tr>
                                <td><strong>Valor Total:</strong></td>
                                <td>R$ ${estatisticas.valor_total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                            </tr>
                        </table>
                        
                        ${veiculoHtml}
                        ${pedagioHtml}
                        
                        <h5 class="mt-3">📦 Ordem de Entrega</h5>
                        ${gerarOrdemEntregaHtml(rota)}
                        
                        <h5 class="mt-3">🛣️ Trechos</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Trecho</th>
                                    <th>Distância</th>
                                    <th>Tempo</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${legsHtml}
                            </tbody>
                        </table>
                        
                        <div class="alert alert-warning mt-3">
                            <strong>💵 Custo Total Estimado:</strong><br>
                            Combustível: R$ ${estatisticas.custo_estimado_km.toFixed(2)}<br>
                            Pedágio: R$ ${pedagio ? pedagio.valor_total.toFixed(2) : '0.00'}<br>
                            <hr>
                            <strong>TOTAL: R$ ${(estatisticas.custo_estimado_km + (pedagio ? pedagio.valor_total : 0)).toFixed(2)}</strong>
                        </div>
                    </div>
                `,
                width: 700,
                confirmButtonText: 'Fechar'
            });
        }

        // Mostrar densidade regional
        function mostrarDensidade() {
            showLoading();

            $.ajax({
                url: '/carteira/mapa/api/densidade-regional',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                data: JSON.stringify({ pedidos: pedidosSelecionados }),
                success: function (response) {
                    if (response.sucesso) {
                        exibirDensidadeNoMapa(response.densidade);
                        mostrarEstatisticasDensidade(response.densidade);
                    }
                    hideLoading();
                },
                error: function (xhr) {
                    hideLoading();
                    Swal.fire('Erro', 'Erro ao analisar densidade', 'error');
                }
            });
        }

        // Exibir densidade no mapa (heatmap)
        function exibirDensidadeNoMapa(densidade) {
            // Preparar dados para heatmap
            const heatmapData = [];

            clientesData.forEach(cliente => {
                if (cliente.coordenadas) {
                    heatmapData.push({
                        location: new google.maps.LatLng(cliente.coordenadas.lat, cliente.coordenadas.lng),
                        weight: cliente.totais.valor / 1000 // Peso baseado no valor
                    });
                }
            });

            // Remover heatmap anterior
            if (heatmap) {
                heatmap.setMap(null);
            }

            // Criar novo heatmap
            heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                map: map,
                radius: 50,
                opacity: 0.6,
                gradient: [
                    'rgba(0, 255, 255, 0)',
                    'rgba(0, 255, 255, 1)',
                    'rgba(0, 191, 255, 1)',
                    'rgba(0, 127, 255, 1)',
                    'rgba(0, 63, 255, 1)',
                    'rgba(0, 0, 255, 1)',
                    'rgba(0, 0, 223, 1)',
                    'rgba(0, 0, 191, 1)',
                    'rgba(0, 0, 159, 1)',
                    'rgba(0, 0, 127, 1)',
                    'rgba(63, 0, 91, 1)',
                    'rgba(127, 0, 63, 1)',
                    'rgba(191, 0, 31, 1)',
                    'rgba(255, 0, 0, 1)'
                ]
            });
        }

        // Mostrar estatísticas de densidade
        function mostrarEstatisticasDensidade(densidade) {
            let estadosHtml = '';
            for (const [uf, dados] of Object.entries(densidade.por_estado)) {
                estadosHtml += `
                    <tr>
                        <td>${uf}</td>
                        <td>${dados.total_pedidos}</td>
                        <td>R$ ${dados.valor_total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td>${dados.peso_total.toFixed(2)} kg</td>
                    </tr>
                `;
            }

            let cidadesHtml = '';
            densidade.por_cidade.slice(0, 10).forEach(cidade => {
                cidadesHtml += `
                    <tr>
                        <td>${cidade.cidade}/${cidade.uf}</td>
                        <td>${cidade.total_pedidos}</td>
                        <td>R$ ${cidade.valor_total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    </tr>
                `;
            });

            Swal.fire({
                title: 'Análise de Densidade Regional',
                html: `
                    <div class="text-start">
                        <h5>Resumo Geral</h5>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Total de Estados:</strong></td>
                                <td>${densidade.resumo.total_estados}</td>
                            </tr>
                            <tr>
                                <td><strong>Total de Cidades:</strong></td>
                                <td>${densidade.resumo.total_cidades}</td>
                            </tr>
                            <tr>
                                <td><strong>Total de Pedidos:</strong></td>
                                <td>${densidade.resumo.total_pedidos}</td>
                            </tr>
                            <tr>
                                <td><strong>Valor Total:</strong></td>
                                <td>R$ ${densidade.resumo.valor_total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                            </tr>
                        </table>
                        
                        <h5 class="mt-3">Por Estado</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>UF</th>
                                    <th>Pedidos</th>
                                    <th>Valor</th>
                                    <th>Peso</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${estadosHtml}
                            </tbody>
                        </table>
                        
                        <h5 class="mt-3">Top 10 Cidades</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Cidade</th>
                                    <th>Pedidos</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${cidadesHtml}
                            </tbody>
                        </table>
                        
                        ${densidade.analises ? `
                        <h5 class="mt-3">Análises e Sugestões</h5>
                        <div class="alert alert-info">
                            ${densidade.analises.sugestoes.map(s => `<p><i class="fas fa-lightbulb"></i> ${s.descricao}</p>`).join('')}
                        </div>
                        ` : ''}
                    </div>
                `,
                width: 700,
                confirmButtonText: 'Fechar'
            });
        }

        // Calcular matriz de distâncias
        function calcularMatrizDistancias() {
            if (pedidosData.length < 2) {
                Swal.fire('Aviso', 'Selecione pelo menos 2 pedidos para calcular a matriz', 'warning');
                return;
            }

            showLoading();

            $.ajax({
                url: '/carteira/mapa/api/matriz-distancias',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                data: JSON.stringify({ pedidos: pedidosSelecionados.slice(0, 10) }),
                success: function (response) {
                    if (response.sucesso) {
                        mostrarMatrizDistancias(response.matriz);
                    }
                    hideLoading();
                },
                error: function (xhr) {
                    hideLoading();
                    Swal.fire('Erro', xhr.responseJSON?.erro || 'Erro ao calcular matriz', 'error');
                }
            });
        }

        // Mostrar matriz de distâncias
        function mostrarMatrizDistancias(matriz) {
            let matrizHtml = '<table class="table table-sm table-bordered">';
            matrizHtml += '<thead><tr><th>De/Para</th>';

            // Header
            matriz.pedidos.forEach(pedido => {
                matrizHtml += `<th>${pedido}</th>`;
            });
            matrizHtml += '</tr></thead><tbody>';

            // Linhas
            matriz.distancias.forEach((linha, i) => {
                matrizHtml += `<tr><th>${matriz.pedidos[i]}</th>`;
                linha.forEach((dist, j) => {
                    if (dist === null) {
                        matrizHtml += '<td>-</td>';
                    } else if (i === j) {
                        matrizHtml += '<td class="table-secondary">0</td>';
                    } else {
                        matrizHtml += `<td>${dist} km</td>`;
                    }
                });
                matrizHtml += '</tr>';
            });
            matrizHtml += '</tbody></table>';

            // Pares próximos e distantes
            let paresHtml = '<h5 class="mt-3">Pares Mais Próximos</h5><ul>';
            matriz.resumo.pares_proximos.forEach(par => {
                paresHtml += `<li>${par.origem} → ${par.destino}: ${par.distancia.toFixed(1)} km (${par.tempo.toFixed(0)} min)</li>`;
            });
            paresHtml += '</ul>';

            paresHtml += '<h5 class="mt-3">Pares Mais Distantes</h5><ul>';
            matriz.resumo.pares_distantes.forEach(par => {
                paresHtml += `<li>${par.origem} → ${par.destino}: ${par.distancia.toFixed(1)} km (${par.tempo.toFixed(0)} min)</li>`;
            });
            paresHtml += '</ul>';

            Swal.fire({
                title: 'Matriz de Distâncias',
                html: `
                    <div class="text-start">
                        <div class="alert alert-info">
                            <strong>Distância Média:</strong> ${matriz.resumo.distancia_media_km} km<br>
                            <strong>Tempo Médio:</strong> ${matriz.resumo.tempo_medio_min} minutos
                        </div>
                        ${matrizHtml}
                        ${paresHtml}
                    </div>
                `,
                width: 900,
                confirmButtonText: 'Fechar'
            });
        }


        // Mudar tipo de mapa
        function mudarTipoMapa(tipo) {
            map.setMapTypeId(tipo);
        }

        // Centralizar mapa
        function centralizarMapa() {
            const bounds = new google.maps.LatLngBounds();

            // Incluir CD nos bounds
            if (cdData) {
                bounds.extend({
                    lat: cdData.coordenadas.lat,
                    lng: cdData.coordenadas.lng
                });
            }

            // Incluir clientes nos bounds
            if (clientesData.length > 0) {
                clientesData.forEach(cliente => {
                    if (cliente.coordenadas) {
                        bounds.extend({
                            lat: cliente.coordenadas.lat,
                            lng: cliente.coordenadas.lng
                        });
                    }
                });
            }

            if (!bounds.isEmpty()) {
                map.fitBounds(bounds);
            }
        }

        // Toggle fullscreen
        function toggleFullscreen() {
            const mapDiv = document.getElementById('map');
            if (!document.fullscreenElement) {
                mapDiv.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Tirar screenshot
        function tirarScreenshot() {
            // Implementar com html2canvas se necessário
            Swal.fire('Screenshot', 'Use Ctrl+Shift+S para capturar a tela', 'info');
        }

        // Navegar até localização
        function navegarAte(lat, lng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // Ver detalhes do pedido
        function verDetalhesPedido(numPedido) {
            window.open(`/carteira/pedido/${numPedido}`, '_blank');
        }

        // Toggle side panel
        function toggleSidePanel() {
            $('#sidePanel').toggle();
        }

        // Toggle FAB menu
        function toggleFabMenu() {
            $('#fabMenu').toggleClass('active');
            $('.fab-btn i').toggleClass('fa-plus fa-times');
        }

        // Exportar dados em Excel
        function exportarExcel() {
            const selecionados = getClientesSelecionados();
            if (selecionados.length === 0) {
                Swal.fire('Aviso', 'Selecione ao menos um cliente para exportar', 'warning');
                return;
            }

            showLoading();

            // Preparar dados incluindo rota se calculada
            const dadosExport = {
                clientes: selecionados,
                rota: rotaCalculada || null
            };

            $.ajax({
                url: '/carteira/mapa/api/exportar-excel',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                data: JSON.stringify(dadosExport),
                xhrFields: { responseType: 'blob' },
                success: function (blob) {
                    hideLoading();
                    // Download do arquivo
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `mapa_pedidos_${new Date().toISOString().slice(0, 10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    Swal.fire('Sucesso', 'Arquivo exportado com sucesso!', 'success');
                },
                error: function () {
                    hideLoading();
                    Swal.fire('Erro', 'Falha ao exportar arquivo', 'error');
                }
            });
        }

        // URL de redirect para cotação (salva após preparar session)
        let _cotacaoRedirectUrl = null;

        // Cotar frete para clientes selecionados (com verificação NF CD)
        function cotarFrete() {
            const selecionados = getClientesSelecionados();
            if (selecionados.length === 0) {
                Swal.fire('Aviso', 'Selecione ao menos um cliente para cotar frete', 'warning');
                return;
            }

            // Coletar todos os num_pedido dos clientes selecionados
            const pedidos = [];
            selecionados.forEach(c => {
                c.pedidos.forEach(p => pedidos.push(p.num_pedido));
            });

            showLoading();

            // Passo 1: Preparar session com lotes no backend
            $.ajax({
                url: '/carteira/mapa/api/cotar-frete',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                data: JSON.stringify({ pedidos: pedidos }),
                success: function (response) {
                    if (response.sucesso) {
                        _cotacaoRedirectUrl = response.redirect;

                        // Passo 2: Verificar NF CD pendentes
                        verificarNfCdMapa(response.lotes, response.redirect, response.total_lotes);
                    } else {
                        hideLoading();
                        Swal.fire('Erro', 'Erro ao preparar cotação', 'error');
                    }
                },
                error: function (xhr) {
                    hideLoading();
                    Swal.fire('Erro', xhr.responseJSON?.erro || 'Erro ao processar cotação', 'error');
                }
            });
        }

        // Verificação bidirecional NF CD para o mapa
        function verificarNfCdMapa(lotes, redirectUrl, totalLotes) {
            $.ajax({
                url: '/cotacao/verificar_nf_cd',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                data: JSON.stringify({ separacao_lote_ids: lotes }),
                success: function (data) {
                    hideLoading();

                    if (!data.success) {
                        Swal.fire('Erro', data.message || 'Erro ao verificar pedidos.', 'error');
                        return;
                    }

                    if (!data.tem_pendentes) {
                        // Sem pendentes NF CD - confirmar e redirecionar
                        Swal.fire({
                            title: 'Cotação de Frete',
                            text: `${totalLotes} lote(s) de separação encontrado(s). Deseja prosseguir para a cotação?`,
                            icon: 'success',
                            showCancelButton: true,
                            confirmButtonText: 'Prosseguir',
                            cancelButtonText: 'Cancelar'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = redirectUrl;
                            }
                        });
                        return;
                    }

                    // TEM pendentes - abrir modal NF CD
                    preencherModalNfCdMapa(data.selecionados, data.pendentes_nf_cd, data.pendentes_normais);

                    // Configurar botão "Prosseguir mesmo assim"
                    document.getElementById('btnProsseguirCotacaoMapa').onclick = function () {
                        var modalEl = document.getElementById('modalNfCdMapa');
                        var modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) modal.hide();
                        window.location.href = redirectUrl;
                    };

                    var modal = new bootstrap.Modal(document.getElementById('modalNfCdMapa'));
                    modal.show();
                },
                error: function (xhr) {
                    hideLoading();
                    console.error('Erro na verificação NF CD:', xhr);
                    // Em caso de erro na verificação, prosseguir sem verificação
                    Swal.fire({
                        title: 'Cotação de Frete',
                        text: `${totalLotes} lote(s) encontrado(s). Não foi possível verificar NF no CD. Deseja prosseguir?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Prosseguir',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = redirectUrl;
                        }
                    });
                }
            });
        }

        // Preencher modal NF CD do mapa
        function preencherModalNfCdMapa(selecionados, pendentes_nf_cd, pendentes_normais) {
            var tbodySelecionados = document.getElementById('mapa_tabela_selecionados');
            tbodySelecionados.innerHTML = '';
            selecionados.forEach(function (p) {
                tbodySelecionados.innerHTML += renderizarLinhaNfCdMapa(p, '');
            });
            document.getElementById('mapa_count_selecionados').textContent = selecionados.length;

            // Seção NF CD
            var secaoNfCd = document.getElementById('mapa_secao_pendentes_nf_cd');
            var tbodyNfCd = document.getElementById('mapa_tabela_nf_cd');
            tbodyNfCd.innerHTML = '';
            if (pendentes_nf_cd && pendentes_nf_cd.length > 0) {
                secaoNfCd.style.display = 'block';
                pendentes_nf_cd.forEach(function (p) {
                    tbodyNfCd.innerHTML += renderizarLinhaNfCdMapa(p, 'table-warning');
                });
                document.getElementById('mapa_count_nf_cd').textContent = pendentes_nf_cd.length;
            } else {
                secaoNfCd.style.display = 'none';
            }

            // Seção Normais
            var secaoNormais = document.getElementById('mapa_secao_pendentes_normais');
            var tbodyNormais = document.getElementById('mapa_tabela_normais');
            tbodyNormais.innerHTML = '';
            if (pendentes_normais && pendentes_normais.length > 0) {
                secaoNormais.style.display = 'block';
                pendentes_normais.forEach(function (p) {
                    tbodyNormais.innerHTML += renderizarLinhaNfCdMapa(p, 'table-info');
                });
                document.getElementById('mapa_count_normais').textContent = pendentes_normais.length;
            } else {
                secaoNormais.style.display = 'none';
            }
        }

        // Renderizar linha da tabela NF CD do mapa
        function renderizarLinhaNfCdMapa(p, rowClass) {
            var statusBadge = '';
            if (p.status) {
                var statusColors = {
                    'ABERTO': 'primary', 'PREVISAO': 'info', 'COTADO': 'warning',
                    'EMBARCADO': 'success', 'FATURADO': 'secondary', 'NF no CD': 'danger'
                };
                var color = statusColors[p.status] || 'secondary';
                statusBadge = '<span class="badge bg-' + color + '">' + p.status + '</span>';
            }

            function fmtValor(v) {
                if (v === null || v === undefined) return '-';
                return v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function fmtNum(v, d) {
                if (v === null || v === undefined) return '-';
                return v.toLocaleString('pt-BR', { minimumFractionDigits: d, maximumFractionDigits: d });
            }

            return '<tr class="' + rowClass + '">' +
                '<td class="text-nowrap">' + (p.num_pedido || '') + '</td>' +
                '<td>' + (p.raz_social_red || '') + '</td>' +
                '<td class="text-nowrap">' + (p.nome_cidade || '') + '/' + (p.cod_uf || '') + '</td>' +
                '<td class="text-nowrap">' + (p.expedicao || '-') + '</td>' +
                '<td class="text-end">R$ ' + fmtValor(p.valor_saldo) + '</td>' +
                '<td class="text-end">' + fmtNum(p.peso, 1) + '</td>' +
                '<td class="text-end">' + fmtNum(p.pallet, 2) + '</td>' +
                '<td class="text-nowrap">' + (p.numero_nf || '-') + '</td>' +
                '<td class="text-nowrap"><small class="text-muted">' + (p.separacao_lote_id || '') + '</small></td>' +
                '<td>' + statusBadge + '</td>' +
            '</tr>';
        }

        // Função antiga mantida para compatibilidade
        function exportarDados() {
            exportarExcel();
        }

        // Show/Hide loading
        function showLoading() {
            $('#loadingOverlay').show();
        }

        function hideLoading() {
            $('#loadingOverlay').hide();
        }

        // Atalhos de teclado
        $(document).keydown(function (e) {
            // R - Atualizar
            if (e.key === 'r' && !$(e.target).is('input, textarea')) {
                e.preventDefault();
                carregarPedidos();
            }
            // O - Rota otimizada
            if (e.key === 'o' && !$(e.target).is('input, textarea')) {
                e.preventDefault();
                calcularRotaOtimizada();
            }
            // D - Densidade
            if (e.key === 'd' && !$(e.target).is('input, textarea')) {
                e.preventDefault();
                mostrarDensidade();
            }
            // M - Matriz
            if (e.key === 'm' && !$(e.target).is('input, textarea')) {
                e.preventDefault();
                calcularMatrizDistancias();
            }
            // ESC - Fechar panels
            if (e.key === 'Escape') {
                $('#sidePanel').hide();
                $('#fabMenu').removeClass('active');
            }
        });
    </script>

    <!-- Carregar Google Maps API com bibliotecas necessárias -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap&libraries=geometry,visualization,places&language=pt-BR">
        </script>

</body>

</html>