{% extends "base.html" %}

{% block title %}Dashboard de Alertas - Sistema de Fretes{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <h2 class="mb-4">
    <i class="fas fa-bell"></i> Dashboard de Alertas de Separação
  </h2>

  <!-- Estatísticas -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">Total de Alertas</h5>
          <h2 class="text-primary">{{ stats.total }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">Alertas Pendentes</h5>
          <h2 class="text-warning">{{ stats.pendentes }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">Alertas Reimpresos</h5>
          <h2 class="text-success">{{ stats.reimpresos }}</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" action="{{ url_for('carteira.alertas_visualizacao.dashboard') }}" class="row g-3">
        <div class="col-md-4">
          <label for="status" class="form-label">Status</label>
          <select name="status" id="status" class="form-select">
            <option value="todos" {% if filtro_status == 'todos' %}selected{% endif %}>Todos</option>
            <option value="pendentes" {% if filtro_status == 'pendentes' %}selected{% endif %}>Pendentes</option>
            <option value="reimpresos" {% if filtro_status == 'reimpresos' %}selected{% endif %}>Reimpresos</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="tipo" class="form-label">Tipo de Alteração</label>
          <select name="tipo" id="tipo" class="form-select">
            <option value="todos" {% if filtro_tipo == 'todos' %}selected{% endif %}>Todos</option>
            <option value="alteracao_quantidade" {% if filtro_tipo == 'alteracao_quantidade' %}selected{% endif %}>Quantidade</option>
            <option value="alteracao_data" {% if filtro_tipo == 'alteracao_data' %}selected{% endif %}>Data</option>
            <option value="cancelamento" {% if filtro_tipo == 'cancelamento' %}selected{% endif %}>Cancelamento</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">&nbsp;</label>
          <div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-filter"></i> Filtrar
            </button>
            <a href="{{ url_for('carteira.alertas_visualizacao.dashboard') }}" class="btn btn-secondary">
              <i class="fas fa-redo"></i> Limpar
            </a>
            <button type="button" class="btn btn-danger" onclick="limparOrfaos()">
              <i class="fas fa-trash"></i> Limpar Órfãos
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabela de Alertas -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Alertas de Separação</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Data/Hora</th>
              <th>Lote</th>
              <th>Pedido</th>
              <th>Produto</th>
              <th>Tipo</th>
              <th>Alteração</th>
              <th>Status Pedido</th>
              <th>Embarque</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for item in alertas %}
            <tr class="{% if item.is_orfao %}table-danger{% endif %}">
              <td>{{ item.alerta.id if item.alerta else '-' }}</td>
              <td>{{ item.alerta.data_alerta|formatar_data_hora_brasil if item.alerta else '-' }}</td>
              <td>{{ item.alerta.separacao_lote_id if item.alerta else '-' }}</td>
              <td>{{ item.alerta.num_pedido if item.alerta else '-' }}</td>
              <td>
                <small>
                  {% if item.alerta %}
                    {{ item.alerta.cod_produto if item.alerta.cod_produto else '-' }}<br>
                    {% if item.alerta.nome_produto %}
                      {{ item.alerta.nome_produto[:30] }}...
                    {% else %}
                      -
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </small>
              </td>
              <td>
                {% if item.alerta %}
                  {% if item.alerta.tipo_alteracao == 'alteracao_quantidade' %}
                    <span class="badge bg-info">Quantidade</span>
                  {% elif item.alerta.tipo_alteracao == 'alteracao_data' %}
                    <span class="badge bg-warning">Data</span>
                  {% elif item.alerta.tipo_alteracao == 'cancelamento' %}
                    <span class="badge bg-danger">Cancelamento</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ item.alerta.tipo_alteracao if item.alerta.tipo_alteracao else '-' }}</span>
                  {% endif %}
                {% else %}
                  <span class="badge bg-secondary">-</span>
                {% endif %}
              </td>
              <td>
                {% if item.alerta %}
                  {% if item.alerta.tipo_alteracao == 'alteracao_quantidade' %}
                    {{ item.alerta.qtd_anterior if item.alerta.qtd_anterior else '-' }} → {{ item.alerta.qtd_nova if item.alerta.qtd_nova else '-' }}
                  {% elif item.alerta.tipo_alteracao == 'alteracao_data' %}
                    {{ item.alerta.data_anterior if item.alerta.data_anterior else '-' }} → {{ item.alerta.data_nova if item.alerta.data_nova else '-' }}
                  {% else %}
                    -
                  {% endif %}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if item.pedido %}
                  <span class="badge bg-primary">{{ item.pedido.status }}</span>
                {% else %}
                  <span class="badge bg-danger">SEM PEDIDO</span>
                {% endif %}
              </td>
              <td>
                {% if item.embarque %}
                  #{{ item.embarque.numero }}
                {% else %}
                  <span class="text-danger">SEM EMBARQUE</span>
                {% endif %}
              </td>
              <td>
                {% if item.alerta %}
                  {% if item.alerta.reimpresso %}
                    <span class="badge bg-success">Reimpresso</span>
                  {% else %}
                    <span class="badge bg-warning">Pendente</span>
                  {% endif %}
                {% else %}
                  <span class="badge bg-secondary">-</span>
                {% endif %}
              </td>
              <td>
                {% if item.alerta and not item.alerta.reimpresso %}
                  <form method="POST" action="{{ url_for('carteira.alertas_visualizacao.marcar_reimpresso', alerta_id=item.alerta.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-sm btn-success" title="Marcar como reimpresso">
                      <i class="fas fa-check"></i>
                    </button>
                  </form>
                {% endif %}
                {% if item.is_orfao %}
                  <span class="badge bg-danger" title="Alerta órfão">
                    <i class="fas fa-exclamation-triangle"></i> Órfão
                  </span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
function limparOrfaos() {
  if (confirm('Tem certeza que deseja marcar todos os alertas órfãos como reimpresos?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("carteira.alertas_visualizacao.limpar_orfaos") }}';
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{ csrf_token() }}';
    
    form.appendChild(csrfInput);
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
{% endblock %}