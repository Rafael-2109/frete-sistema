{% extends "base.html" %}

{% block title %}Carteira Agrupada{% endblock %}

{% block content %}
<div class="container-fluid carteira-page">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-layer-group text-primary"></i>
            Carteira Agrupada por Pedidos
            {% if total_pedidos %}
            <span class="badge bg-primary">{{ total_pedidos }} pedidos</span>
            {% endif %}
        </h1>
        <div>
            <a href="{{ url_for('sync_integrada.dashboard') }}" class="btn btn-success btn-sm mr-2">
                <i class="fas fa-sync"></i> Sincronizar Odoo
            </a>
            <a href="{{ url_for('carteira.index') }}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
            <a href="{{ url_for('carteira.listar_principal') }}" class="btn btn-info btn-sm">
                <i class="fas fa-list"></i> Lista Detalhada
            </a>
        </div>
    </div>

    {% if pedidos %}
    <!-- Status da implementa√ß√£o -->
    <div class="alert alert-info">
        <strong>üîß Fase 1.1 - Query de Agrupamento Base</strong><br>
        Status: ‚úÖ Implementada e testando<br>
        Funcionalidade: Agrupamento por num_pedido com agrega√ß√µes conforme CARTEIRA.csv
    </div>

    <!-- Resultados Agrupados -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-table"></i> Pedidos Agrupados ({{ total_pedidos }} pedidos encontrados)
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable">
                    <thead>
                        <tr>
                            <th>Vendedor</th>
                            <th>Pedido</th>
                            <th>Cliente</th>
                            <th>Rota</th>
                            <th>Data Entrega</th>
                            <th>Informa√ß√µes</th>
                            <th>Saldo</th>
                            <th>Expedi√ß√£o / Agenda</th>
                            <th>Solicitar Agendamento</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in pedidos %}
                        <tr class="pedido-row{% if pedido.totalmente_separado %} table-success{% endif %}"
                            data-pedido="{{ pedido.num_pedido }}">
                            <!-- Vendedor / Equipe / Status -->
                            <td>
                                <strong>{{ pedido.vendedor or '' }}</strong>
                                {% if pedido.equipe_vendas %}
                                <br><small class="text-muted">{{ pedido.equipe_vendas }}</small>
                                {% endif %}
                                {% if pedido.status_pedido %}
                                <br><span class="badge bg-sm" style="background-color: #495057; color: white;">
                                    {{ pedido.status_pedido }}</span>
                                {% endif %}
                            </td>

                            <!-- Pedido / Data / Cliente Pedido -->
                            <td>
                                <button class="btn btn-link p-0 mr-2 btn-expandir"
                                    onclick="togglePedidoItens('{{ pedido.num_pedido }}')"
                                    title="Expandir/Colapsar itens">
                                    <i class="fas fa-chevron-right expand-icon" id="icon-{{ pedido.num_pedido }}"></i>
                                </button>
                                <strong>{{ pedido.num_pedido }}</strong>
                                {% if pedido.data_pedido %}
                                <br><small class="text-muted">{{ pedido.data_pedido.strftime('%d/%m/%Y') }}</small>
                                {% endif %}
                                {% if pedido.pedido_cliente %}
                                <br><small class="text-info">PC: {{ pedido.pedido_cliente }}</small>
                                {% endif %}
                            </td>

                            <!-- Cliente / CNPJ / UF/Cidade -->
                            <td>
                                <strong>{{ pedido.raz_social_red or '' }}</strong>
                                {% if pedido.cnpj_cpf %}
                                <br><small class="text-muted">{{ pedido.cnpj_cpf }}</small>
                                {% endif %}
                                {% if pedido.cod_uf and pedido.nome_cidade %}
                                <br><small class="text-primary">{{ pedido.nome_cidade }}/{{ pedido.cod_uf }}</small>
                                {% endif %}
                            </td>

                            <!-- Rota / Sub-rota / Incoterm -->
                            <td>
                                {{ pedido.rota or '' }}
                                {% if pedido.sub_rota %}
                                <br><small class="text-muted">{{ pedido.sub_rota }}</small>
                                {% endif %}
                                {% if pedido.incoterm %}
                                <br><span class="badge"
                                    style="background-color: #17a2b8; color: white; cursor: pointer;"
                                    onclick="abrirModalEndereco('{{ pedido.num_pedido }}')">
                                    {{ pedido.incoterm }}
                                </span>
                                {% endif %}
                            </td>

                            <!-- Data Entrega / Observa√ß√µes -->
                            <td>
                                {% if pedido.data_entrega_pedido %}
                                <strong>{{ pedido.data_entrega_pedido.strftime('%d/%m/%Y') }}</strong>
                                {% endif %}
                                {% if pedido.observ_ped_1 %}
                                <br><small class="text-muted" title="{{ pedido.observ_ped_1 }}">
                                    {{ pedido.observ_ped_1[:50] }}{% if pedido.observ_ped_1|length > 50 %}...{% endif %}
                                </small>
                                {% endif %}
                            </td>

                            <!-- Informa√ß√µes (Valor/Peso/Pallet) -->
                            <td>
                                <strong>{{ pedido.valor_total|valor_br }}</strong>
                                <br>{{ pedido.peso_total|peso_br }}
                                <br>{{ pedido.pallet_total|pallet_br }}
                                <br><span class="badge bg-info">{{ pedido.total_itens }} itens</span>
                            </td>

                            <!-- Saldo (Total das separa√ß√µes sem NF) -->
                            <td class="text-center">
                                <button class="btn btn-link p-0"
                                    onclick="toggleSeparacoesPedido('{{ pedido.num_pedido }}')"
                                    title="Expandir/Colapsar separa√ß√µes do pedido">
                                    <i class="fas fa-chevron-right separacao-icon"
                                        id="separacao-icon-{{ pedido.num_pedido }}"></i>
                                </button>
                                <br>
                                {% if pedido.totalmente_separado %}
                                <span class="badge bg-success">Total em Separa√ß√£o</span>
                                {% else %}
                                <strong>{{ pedido.valor_saldo_restante|valor_br }}</strong>
                                {% endif %}
                                <br>
                                <span class="badge" style="background-color: #17a2b8; color: white;"
                                    id="separacoes-badge-{{ pedido.num_pedido }}">
                                    {{ pedido.qtd_separacoes|default(0) }} separa√ß√µes
                                </span>
                            </td>

                            <!-- Expedi√ß√£o / Agenda / Protocolo -->
                            <td>
                                {% if pedido.expedicao %}
                                <strong>üìÖ {{ pedido.expedicao.strftime('%d/%m/%Y') }}</strong>
                                {% endif %}
                                {% if pedido.agendamento %}
                                <br>üóìÔ∏è {{ pedido.agendamento.strftime('%d/%m/%Y') }}
                                {% endif %}
                                {% if pedido.protocolo %}
                                <br><small class="text-success">üìã {{ pedido.protocolo }}</small>
                                {% endif %}
                            </td>

                            <!-- Solicitar Agendamento (4 bot√µes) -->
                            <td>
                                <div class="btn-group-vertical btn-group-sm" role="group">
                                    <button type="button" class="btn btn-primary btn-sm"
                                        onclick="criarSeparacao('{{ pedido.num_pedido }}')" title="Criar Separa√ß√£o">
                                        üì¶ Criar Separa√ß√£o
                                    </button>

                                    <button type="button" class="btn btn-warning btn-sm"
                                        onclick="abrirModalAvaliarEstoques('{{ pedido.num_pedido }}')"
                                        title="Avaliar Estoques (28 dias)">
                                        üîç Avaliar Estoques
                                    </button>

                                    <button type="button" class="btn btn-success btn-sm"
                                        onclick="solicitarAgendamento('{{ pedido.num_pedido }}')"
                                        title="Solicitar Agendamento">
                                        üóìÔ∏è Agendar
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <!-- Linha expandida para itens do pedido (inicialmente oculta) -->
                        <tr class="itens-expandidos collapse" id="itens-{{ pedido.num_pedido }}">
                            <td colspan="9">
                                <div class="card mt-2 mb-2">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-list"></i>
                                            Itens do Pedido {{ pedido.num_pedido }}
                                            <span class="badge bg-info ml-2" id="badge-{{ pedido.num_pedido }}">
                                                Carregando...
                                            </span>
                                        </h6>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="loading-{{ pedido.num_pedido }}" class="text-center p-3">
                                            <i class="fas fa-spinner fa-spin"></i> Carregando itens...
                                        </div>
                                        <div id="content-{{ pedido.num_pedido }}" style="display: none;">
                                            <!-- Conte√∫do ser√° carregado via AJAX -->
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <!-- Linha expandida para separa√ß√µes do pedido (inicialmente oculta) -->
                        <tr class="separacoes-expandidas collapse" id="separacoes-{{ pedido.num_pedido }}">
                            <td colspan="9">
                                <div class="card mt-2 mb-2" style="border-left: 4px solid #17a2b8;">
                                    <div class="card-header" style="background-color: #17a2b8; color: white;">
                                        <h6 class="mb-0">
                                            <i class="fas fa-boxes"></i>
                                            Separa√ß√µes do Pedido {{ pedido.num_pedido }}
                                            <span class="badge bg-light ml-2"
                                                id="separacoes-header-badge-{{ pedido.num_pedido }}">
                                                Carregando...
                                            </span>
                                        </h6>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="separacoes-loading-{{ pedido.num_pedido }}" class="text-center p-3">
                                            <i class="fas fa-spinner fa-spin"></i> Carregando separa√ß√µes...
                                        </div>
                                        <div id="separacoes-content-{{ pedido.num_pedido }}" style="display: none;">
                                            <!-- Conte√∫do das separa√ß√µes ser√° carregado via AJAX -->
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Debug Info -->
    <div class="card shadow mt-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-secondary">
                <i class="fas fa-bug"></i> Informa√ß√µes de Debug
            </h6>
        </div>
        <div class="card-body">
            <p><strong>Total de pedidos agrupados:</strong> {{ total_pedidos }}</p>
            <p><strong>Campos agregados sendo calculados:</strong></p>
            <ul>
                <li>valor_total = SUM(qtd_saldo_produto_pedido * preco_produto_pedido)</li>
                <li>peso_total = SUM(qtd_saldo_produto_pedido * CadastroPalletizacao.peso_bruto)</li>
                <li>pallet_total = SUM(qtd_saldo_produto_pedido / CadastroPalletizacao.palletizacao)</li>
                <li>total_itens = COUNT(id)</li>
            </ul>
            <p><strong>Status da implementa√ß√£o:</strong> ‚úÖ Query base funcionando, pr√≥ximo: calcular_saida_periodo()</p>
        </div>
    </div>

    {% else %}
    <!-- Sem dados -->
    <div class="card shadow mb-4">
        <div class="card-body text-center">
            <i class="fas fa-inbox fa-3x text-gray-300 mb-3"></i>
            <h5 class="text-gray-500">Nenhum pedido encontrado</h5>
            <p class="text-gray-400">
                {% if not pedidos %}
                Verifique se existem dados na carteira principal ou se houve erro na query.
                {% else %}
                Os filtros aplicados n√£o retornaram resultados.
                {% endif %}
            </p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Agendamento -->
<div class="modal fade" id="modalAgendamento" tabindex="-1" role="dialog" aria-labelledby="modalAgendamentoLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAgendamentoLabel">
                    <i class="fas fa-calendar-plus"></i> Solicitar Agendamento
                    <span id="modal-agendamento-pedido" class="badge bg-primary ml-2"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Loading state -->
                <div id="modal-agendamento-loading" class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando dados do pedido...</p>
                </div>

                <!-- Error state -->
                <div id="modal-agendamento-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="modal-agendamento-error-message"></span>
                </div>

                <!-- Form content -->
                <div id="modal-agendamento-content" style="display: none;">
                    <form id="form-agendamento">
                        <input type="hidden" id="agendamento-num-pedido" name="num_pedido">

                        <!-- Resumo do pedido -->
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-box"></i> Resumo do Pedido
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Cliente:</strong>
                                        <div id="agendamento-cliente">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Total de Itens:</strong>
                                        <div id="agendamento-total-itens">0</div>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Valor Total:</strong>
                                        <div id="agendamento-valor-total">R$ 0,00</div>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Peso Total:</strong>
                                        <div id="agendamento-peso-total">0 kg</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formul√°rio de agendamento -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="data_agendamento" class="form-label">
                                    <strong>Data do Agendamento:</strong>
                                </label>
                                <input type="date" class="form-control" id="data_agendamento" name="data_agendamento"
                                    required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="hora_agendamento" class="form-label">
                                    <strong>Hor√°rio:</strong>
                                </label>
                                <input type="time" class="form-control" id="hora_agendamento" name="hora_agendamento">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="expedicao" class="form-label">
                                    <strong>Data de Expedi√ß√£o:</strong>
                                </label>
                                <input type="date" class="form-control" id="expedicao" name="expedicao">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="protocolo_agendamento" class="form-label">
                                    <strong>Protocolo:</strong>
                                </label>
                                <input type="text" class="form-control" id="protocolo_agendamento" name="protocolo"
                                    placeholder="Protocolo do agendamento">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="observacoes_agendamento" class="form-label">
                                <strong>Observa√ß√µes:</strong>
                            </label>
                            <textarea class="form-control" id="observacoes_agendamento" name="observacoes" rows="3"
                                placeholder="Observa√ß√µes sobre o agendamento..."></textarea>
                        </div>

                        <!-- Checkbox Agenda Confirmada -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agenda_confirmada"
                                    name="agenda_confirmada" onchange="mostrarBadgeConfirmacao(this.checked)">
                                <label class="form-check-label" for="agenda_confirmada">
                                    <strong>Agenda Confirmada</strong>
                                    <span id="badge-status-agenda" class="badge ms-2" style="display: none;"></span>
                                    <br><small class="text-muted">Marque se o agendamento j√° foi confirmado com o
                                        cliente</small>
                                </label>
                            </div>
                        </div>

                        <!-- Itens do pedido (formata√ß√£o CORRETA) -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-list"></i> Itens do Pedido
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th>C√≥digo</th>
                                                <th>Produto</th>
                                                <th>Qtd</th>
                                                <th>Valor</th>
                                                <th>Peso</th>
                                                <th>Pallet</th>
                                            </tr>
                                        </thead>
                                        <tbody id="agendamento-tbody-itens">
                                            <!-- Itens ser√£o carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="salvarAgendamento()">
                    <i class="fas fa-save"></i> Salvar Agendamento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Criar Separa√ß√£o -->
<div class="modal fade" id="modalCriarSeparacao" tabindex="-1" role="dialog" aria-labelledby="modalCriarSeparacaoLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCriarSeparacaoLabel">
                    <i class="fas fa-boxes"></i> Criar Separa√ß√£o
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Criar nova separa√ß√£o</strong><br>
                    Selecione os itens do pedido que deseja incluir na separa√ß√£o.
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th width="40"><input type="checkbox" id="selectAllSeparacao"
                                        onchange="toggleTodosItensSeparacao(this)"></th>
                                <th>C√≥digo</th>
                                <th>Produto</th>
                                <th>Qtd Dispon√≠vel</th>
                                <th>Qtd Separar</th>
                                <th>Data Expedi√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaItensSeparacao">
                            <!-- Ser√° preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarCriacaoSeparacao()">
                    <i class="fas fa-check"></i> Criar Separa√ß√£o
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Modal para Detalhes do Endere√ßo - C√ìPIA EXATA DA CARTEIRA PRINCIPAL -->
<div class="modal fade" id="modalEndereco" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-map-marker-alt"></i> Detalhes do Endere√ßo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-user"></i> Cliente</h6>
                        <ul class="list-unstyled">
                            <li><strong>UF:</strong> <span id="modal_cliente_uf"></span></li>
                            <li><strong>Munic√≠pio:</strong> <span id="modal_cliente_municipio"></span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-shipping-fast"></i> Endere√ßo de Entrega</h6>
                        <ul class="list-unstyled">
                            <li><strong>CNPJ:</strong> <span id="modal_cnpj_endereco"></span></li>
                            <li><strong>Empresa:</strong> <span id="modal_empresa_endereco"></span></li>
                            <li><strong>UF:</strong> <span id="modal_uf_endereco"></span></li>
                            <li><strong>Munic√≠pio:</strong> <span id="modal_municipio_endereco"></span></li>
                            <li><strong>Bairro:</strong> <span id="modal_bairro_endereco"></span></li>
                            <li><strong>CEP:</strong> <span id="modal_cep_endereco"></span></li>
                            <li><strong>Rua:</strong> <span id="modal_rua_endereco"></span></li>
                            <li><strong>Telefone:</strong> <span id="modal_telefone_endereco"></span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Avaliar Estoques -->
<div class="modal fade" id="modalAvaliarEstoques" tabindex="-1" role="dialog"
    aria-labelledby="modalAvaliarEstoquesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAvaliarEstoquesLabel">
                    <i class="fas fa-chart-bar"></i> Avaliar Estoques do Pedido (28 dias)
                    <span id="modal-num-pedido-estoques" class="badge bg-primary ml-2"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Loading state -->
                <div id="modal-loading" class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando itens para avalia√ß√£o...</p>
                </div>

                <!-- Error state -->
                <div id="modal-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="modal-error-message"></span>
                    <button class="btn btn-sm btn-outline-danger ml-2" onclick="recarregarModalItens()">
                        <i class="fas fa-redo"></i> Tentar novamente
                    </button>
                </div>

                <!-- Form content -->
                <div id="modal-content" style="display: none;">
                    <form id="form-avaliar-itens">
                        <input type="hidden" id="form-num-pedido" name="num_pedido">

                        <!-- Resumo do pedido -->
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle"></i> Resumo do Pedido
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Total de Itens:</strong>
                                        <span id="resumo-total-itens" class="badge bg-info">0</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Valor Total:</strong>
                                        <span id="resumo-valor-total">R$ 0,00</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Peso Total:</strong>
                                        <span id="resumo-peso-total">0 kg</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Selecionados:</strong>
                                        <span id="resumo-selecionados" class="badge bg-warning">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- üéØ ETAPA 2: DROPDOWN TIPO DE ENVIO (IMPLEMENTADO) -->
                        <div class="card border-primary mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-shipping-fast"></i> Configura√ß√£o do Tipo de Envio
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="tipo_envio" class="form-label">
                                            <strong>Tipo de Envio:</strong>
                                        </label>
                                        <select class="form-control" id="tipo_envio" name="tipo_envio"
                                            onchange="atualizarTipoEnvio()">
                                            <option value="total">üì¶ Envio Total</option>
                                            <option value="parcial">üìã Envio Parcial</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8">
                                        <div id="explicacao_tipo_envio">
                                            <div id="explicacao_total" class="alert alert-success mb-0">
                                                <strong>üì¶ Envio Total:</strong> Todos os itens selecionados ser√£o
                                                enviados em uma √∫nica separa√ß√£o completa. Ideal para pedidos que podem
                                                ser entregues integralmente.
                                            </div>
                                            <div id="explicacao_parcial" class="alert alert-warning mb-0"
                                                style="display: none;">
                                                <strong>üìã Envio Parcial:</strong> Apenas parte dos itens ser√° enviada
                                                agora, o restante ficar√° para pr√≥ximos envios. Configure os motivos e
                                                justificativas abaixo.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Campos espec√≠ficos para Envio Parcial -->
                                <div id="campos_envio_parcial" style="display: none;">
                                    <hr>
                                    <h6 class="text-muted mb-3">
                                        <i class="fas fa-edit"></i> Configura√ß√µes do Envio Parcial
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="motivo_parcial" class="form-label">Motivo do Envio
                                                Parcial:</label>
                                            <select class="form-control" id="motivo_parcial" name="motivo_parcial">
                                                <option value="">Selecionar motivo...</option>
                                                <option value="ruptura_estoque">üî¥ Ruptura de Estoque</option>
                                                <option value="capacidade_transporte">üöõ Limita√ß√£o de Transporte
                                                </option>
                                                <option value="prazo_cliente">‚è∞ Urg√™ncia do Cliente</option>
                                                <option value="producao_andamento">üè≠ Produ√ß√£o em Andamento</option>
                                                <option value="estrategia_comercial">üíº Estrat√©gia Comercial</option>
                                                <option value="outros">‚ùì Outros</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="justificativa_parcial" class="form-label">Justificativa
                                                Detalhada:</label>
                                            <textarea class="form-control" id="justificativa_parcial"
                                                name="justificativa_parcial" rows="2"
                                                placeholder="Descreva o motivo espec√≠fico do envio parcial..."></textarea>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="previsao_complemento" class="form-label">Previs√£o para
                                                Complemento:</label>
                                            <input type="date" class="form-control" id="previsao_complemento"
                                                name="previsao_complemento">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="responsavel_aprovacao" class="form-label">Respons√°vel pela
                                                Aprova√ß√£o:</label>
                                            <input type="text" class="form-control" id="responsavel_aprovacao"
                                                name="responsavel_aprovacao" placeholder="Nome do respons√°vel..."
                                                value="{{ current_user.nome if current_user else '' }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Instru√ß√µes -->
                        <div class="alert alert-info">
                            <strong>üìã Instru√ß√µes:</strong>
                            <ul class="mb-0 mt-2">
                                <li>üéØ <strong>Configure o tipo de envio</strong> acima antes de selecionar itens</li>
                                <li>‚úÖ <strong>Selecione</strong> os itens que deseja incluir na separa√ß√£o</li>
                                <li>‚úèÔ∏è <strong>Edite</strong> quantidades (n√£o pode exceder o dispon√≠vel)</li>
                                <li>üìÖ <strong>Ajuste</strong> datas de expedi√ß√£o e agendamento conforme necess√°rio</li>
                                <li>üìù <strong>Adicione</strong> protocolo se necess√°rio</li>
                                <li>üí° <strong>Quantidade parcial</strong> criar√° nova linha com saldo restante</li>
                            </ul>
                        </div>

                        <!-- Tabela de itens edit√°veis -->
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabela-itens-modal">
                                <thead class="thead-dark">
                                    <tr>
                                        <th width="40">
                                            <input type="checkbox" id="select-all-itens"
                                                onchange="toggleTodosItens(this)">
                                        </th>
                                        <th>C√≥digo</th>
                                        <th>Produto</th>
                                        <th>Qtd Dispon√≠vel</th>
                                        <th>Qtd Selecionada</th>
                                        <th>Valor Unit.</th>
                                        <th>Expedi√ß√£o</th>
                                        <th>Agendamento</th>
                                        <th>Protocolo</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-itens-modal">
                                    <!-- Ser√° preenchido via JavaScript -->
                                </tbody>
                                <tfoot class="bg-light">
                                    <tr>
                                        <th colspan="4">TOTAIS SELECIONADOS:</th>
                                        <th id="total-qtd-selecionada">0</th>
                                        <th></th>
                                        <th colspan="4">
                                            <span id="total-valor-selecionado">R$ 0,00</span>
                                        </th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <!-- Bot√£o removido - avalia√ß√µes devem ser autom√°ticas -->
            </div>
        </div>
    </div>
</div>




<!-- JavaScript para expandir/colapsar itens -->
<script>
    // Estado de expans√£o dos pedidos (cache local)
    const pedidosExpandidos = new Set();
    const itensPedidoCache = new Map();

    /**
     * Toggle expans√£o/colapso de itens de um pedido
     * Implementa√ß√£o: Fase 2.2 - JavaScript Expandir/Colapsar
     */
    function togglePedidoItens(numPedido) {
        const linhaItens = document.getElementById(`itens-${numPedido}`);
        const icone = document.getElementById(`icon-${numPedido}`);

        if (pedidosExpandidos.has(numPedido)) {
            // Colapsar
            $(linhaItens).collapse('hide');
            icone.className = 'fas fa-chevron-right expand-icon';
            pedidosExpandidos.delete(numPedido);
        } else {
            // Expandir
            $(linhaItens).collapse('show');
            icone.className = 'fas fa-chevron-down expand-icon';
            pedidosExpandidos.add(numPedido);

            // Carregar itens se ainda n√£o foram carregados
            if (!itensPedidoCache.has(numPedido)) {
                carregarItensPedido(numPedido);
            }
        }
    }

    /**
     * Carrega itens de um pedido via AJAX (DROPDOWN REAL)
     */
    async function carregarItensPedido(numPedido) {
        const loadingDiv = document.getElementById(`loading-${numPedido}`);
        const contentDiv = document.getElementById(`content-${numPedido}`);
        const badge = document.getElementById(`badge-${numPedido}`);

        try {
            // Mostrar loading
            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';
            badge.textContent = 'Carregando...';
            badge.className = 'badge bg-info ml-2';

            // Fazer requisi√ß√£o AJAX para itens edit√°veis conforme CARTEIRA.csv
            const response = await fetch(`/carteira/api/pedido/${numPedido}/itens-editaveis`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Erro ao carregar itens');
            }

            // Armazenar no cache
            itensPedidoCache.set(numPedido, data);

            // Gerar HTML dos itens
            const htmlItens = gerarHtmlItens(data);
            contentDiv.innerHTML = htmlItens;

            // Atualizar badge
            badge.textContent = `${data.itens.length} itens`;
            badge.className = 'badge bg-success ml-2';

            // Mostrar conte√∫do
            loadingDiv.style.display = 'none';
            contentDiv.style.display = 'block';

            console.log(`‚úÖ Itens carregados para pedido ${numPedido}: ${data.itens.length} itens`);

            // Configurar contadores iniciais
            setTimeout(() => atualizarContadoresDropdown(numPedido), 100);

        } catch (error) {
            console.error(`‚ùå Erro ao carregar itens do pedido ${numPedido}:`, error);

            // Mostrar erro
            contentDiv.innerHTML = `
            <div class="alert alert-danger m-3">
                <i class="fas fa-exclamation-triangle"></i>
                Erro ao carregar itens: ${error.message}
                <button class="btn btn-sm btn-outline-danger ml-2" onclick="carregarItensPedido('${numPedido}')">
                    <i class="fas fa-redo"></i> Tentar novamente
                </button>
            </div>
        `;

            badge.textContent = 'Erro';
            badge.className = 'badge bg-danger ml-2';

            loadingDiv.style.display = 'none';
            contentDiv.style.display = 'block';
        }
    }

    // ===== FUN√á√ïES ESPEC√çFICAS DO DROPDOWN REAL =====

    /**
     * Atualiza contadores do dropdown expandido
     */
    function atualizarContadoresDropdown(numPedido) {
        const checkboxesMarcados = document.querySelectorAll(`.item-checkbox-dropdown[data-pedido="${numPedido}"]:checked`);
        const comExpedicao = Array.from(checkboxesMarcados).filter(cb => {
            const itemId = cb.getAttribute('data-item-id');
            const row = document.getElementById(`row-dropdown-${numPedido}-${itemId}`);
            const dataExpedicao = row?.querySelector('.data-expedicao-dropdown')?.value;
            return dataExpedicao && dataExpedicao.trim();
        });

        const contadorEl = document.getElementById(`contador-dropdown-${numPedido}`);
        const contadorExpedicaoEl = document.getElementById(`contador-expedicao-dropdown-${numPedido}`);
        const statusEl = document.getElementById(`status-dropdown-${numPedido}`);
        const btnEnviarEl = document.getElementById(`btn-enviar-dropdown-${numPedido}`);

        if (contadorEl) contadorEl.textContent = checkboxesMarcados.length;
        if (contadorExpedicaoEl) contadorExpedicaoEl.textContent = comExpedicao.length;

        // Atualizar status de valida√ß√£o
        if (statusEl && btnEnviarEl) {
            if (checkboxesMarcados.length === 0) {
                statusEl.textContent = 'Selecione itens';
                statusEl.className = 'badge';
                statusEl.style.backgroundColor = '#6c757d';
                statusEl.style.color = 'white';
                btnEnviarEl.disabled = true;
            } else {
                const semExpedicao = checkboxesMarcados.length - comExpedicao.length;
                if (semExpedicao > 0) {
                    statusEl.textContent = `${semExpedicao} sem data expedi√ß√£o`;
                    statusEl.className = 'badge';
                    statusEl.style.backgroundColor = '#dc3545';
                    statusEl.style.color = 'white';
                    btnEnviarEl.disabled = true;
                } else {
                    statusEl.textContent = 'Pronto para enviar';
                    statusEl.className = 'badge';
                    statusEl.style.backgroundColor = '#198754';
                    statusEl.style.color = 'white';
                    btnEnviarEl.disabled = false;
                }
            }
        }

        // Atualizar totais
        recalcularTotaisDropdown(numPedido);
    }

    /**
     * Recalcula totais do dropdown
     */
    function recalcularTotaisDropdown(numPedido) {
        let valorTotal = 0;
        let pesoTotal = 0;
        let palletTotal = 0;

        const checkboxesMarcados = document.querySelectorAll(`.item-checkbox-dropdown[data-pedido="${numPedido}"]:checked`);

        checkboxesMarcados.forEach(checkbox => {
            const itemId = checkbox.getAttribute('data-item-id');
            const row = document.getElementById(`row-dropdown-${numPedido}-${itemId}`);

            if (row) {
                const valorEl = row.querySelector('.valor-calculado-dropdown');
                const pesoEl = row.querySelector('.peso-calculado-dropdown');
                const palletEl = row.querySelector('.pallet-calculado-dropdown');

                if (valorEl) {
                    const valor = parseFloat(valorEl.textContent.replace(/[R$\s.]/g, '').replace(',', '.') || 0);
                    valorTotal += valor;
                }

                if (pesoEl) {
                    const peso = parseFloat(pesoEl.textContent.replace(/[kg\s]/g, '').replace(',', '.') || 0);
                    pesoTotal += peso;
                }

                if (palletEl) {
                    const pallet = parseFloat(palletEl.textContent.replace(/[pal\s]/g, '').replace(',', '.') || 0);
                    palletTotal += pallet;
                }
            }
        });

        // Atualizar elementos de total
        const totalValorEl = document.getElementById(`total-valor-dropdown-${numPedido}`);
        const totalPesoEl = document.getElementById(`total-peso-dropdown-${numPedido}`);
        const totalPalletEl = document.getElementById(`total-pallet-dropdown-${numPedido}`);

        if (totalValorEl) totalValorEl.textContent = `R$ ${valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        if (totalPesoEl) totalPesoEl.textContent = `${pesoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 1 })} kg`;
        if (totalPalletEl) totalPalletEl.textContent = `${palletTotal.toLocaleString('pt-BR', { minimumFractionDigits: 1 })} pal`;
    }

    /**
     * Recalcula valores de um item no dropdown quando quantidade muda
     */
    function recalcularValoresDropdown(input) {
        const itemId = input.getAttribute('data-item-id');
        const numPedido = input.getAttribute('data-pedido');
        const qtdNova = parseFloat(input.value) || 0;
        const precoUnitario = parseFloat(input.getAttribute('data-preco-unitario')) || 0;

        const row = document.getElementById(`row-dropdown-${numPedido}-${itemId}`);
        if (!row) return;

        // Buscar dados originais do cache para calcular peso/pallet proporcionais
        const dadosCache = itensPedidoCache.get(numPedido);
        const itemOriginal = dadosCache?.itens?.find(item => item.id.toString() === itemId.toString());

        let pesoTotal = 0;
        let palletTotal = 0;

        if (itemOriginal && itemOriginal.qtd_saldo_produto_pedido > 0) {
            // Garantir que peso e pallet sejam tratados corretamente
            let pesoOriginal = 0;
            let palletOriginal = 0;

            // Verificar se √© string ou n√∫mero
            if (typeof itemOriginal.peso === 'string') {
                pesoOriginal = parseFloat(itemOriginal.peso.replace(/[kg\s]/g, '').replace(',', '.') || 0);
            } else {
                pesoOriginal = parseFloat(itemOriginal.peso || 0);
            }

            if (typeof itemOriginal.pallet === 'string') {
                palletOriginal = parseFloat(itemOriginal.pallet.replace(/[pal\s]/g, '').replace(',', '.') || 0);
            } else {
                palletOriginal = parseFloat(itemOriginal.pallet || 0);
            }

            const proporcao = qtdNova / itemOriginal.qtd_saldo_produto_pedido;
            pesoTotal = pesoOriginal * proporcao;
            palletTotal = palletOriginal * proporcao;
        }

        // Calcular valores
        const valorTotal = qtdNova * precoUnitario;

        // Atualizar c√©lulas
        const valorEl = row.querySelector('.valor-calculado-dropdown');
        const pesoEl = row.querySelector('.peso-calculado-dropdown');
        const palletEl = row.querySelector('.pallet-calculado-dropdown');

        if (valorEl) valorEl.textContent = `R$ ${valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        if (pesoEl) pesoEl.textContent = `${pesoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 1 })} kg`;
        if (palletEl) palletEl.textContent = `${palletTotal.toLocaleString('pt-BR', { minimumFractionDigits: 1 })} pal`;

        // Atualizar totais gerais
        recalcularTotaisDropdown(numPedido);
    }

    /**
     * Processa altera√ß√£o de quantidade no dropdown (implementa divis√£o de linhas)
     */
    async function processarAlteracaoQuantidadeDropdown(input) {
        const itemId = input.getAttribute('data-item-id');
        const numPedido = input.getAttribute('data-pedido');
        const qtdOriginal = parseFloat(input.getAttribute('data-qtd-original'));
        const qtdNova = parseFloat(input.value) || 0;

        if (qtdNova < 0 || qtdNova > qtdOriginal) {
            alert('‚ö†Ô∏è Quantidade inv√°lida');
            input.value = qtdOriginal;
            return;
        }

        // Primeiro recalcular valores para mostrar imediatamente
        recalcularValoresDropdown(input);

        // Se quantidade menor que original, dividir linha (criar PreSeparacaoItem)
        if (qtdNova > 0 && qtdNova < qtdOriginal) {
            // N√ÉO salvar antes de dividir para evitar conflito
            const sucesso = await dividirLinhaDropdown(itemId, qtdNova, qtdOriginal, numPedido);
            if (sucesso) {
                // Divis√£o bem-sucedida, n√£o precisa salvar novamente
                atualizarContadoresDropdown(numPedido);
                return;
            }
        }

        // Se quantidade zero, unificar linha
        if (qtdNova === 0) {
            const sucesso = await unificarLinhaDropdown(itemId, numPedido);
            if (sucesso) {
                atualizarContadoresDropdown(numPedido);
                return;
            }
        }

        // Salvar apenas se n√£o houve divis√£o/unifica√ß√£o
        if (qtdNova === qtdOriginal) {
            await salvarAlteracaoAutomatica(itemId, 'quantidade', qtdNova);
        }

        // Atualizar contadores
        atualizarContadoresDropdown(numPedido);
    }

    /**
     * Processa altera√ß√£o de data expedi√ß√£o no dropdown
     */
    async function processarAlteracaoDataExpedicaoDropdown(input) {
        const itemId = input.getAttribute('data-item-id');
        const numPedido = input.getAttribute('data-pedido');
        const novaData = input.value;

        if (novaData) {
            // Recalcular estoques baseados na nova data D0
            await recalcularEstoquesBaseadoD0Dropdown(itemId, novaData, numPedido);

            // Replicar para itens marcados (amarrar)
            replicarCampoParaItensAmarradosDropdown(numPedido, 'data-expedicao-dropdown', novaData);
        }

        // Salvar automaticamente
        await salvarAlteracaoAutomatica(itemId, 'expedicao', novaData);

        // Atualizar valida√ß√£o
        atualizarContadoresDropdown(numPedido);
    }

    /**
     * Processa altera√ß√£o de agendamento no dropdown
     */
    async function processarAlteracaoAgendamentoDropdown(input) {
        const itemId = input.getAttribute('data-item-id');
        const numPedido = input.getAttribute('data-pedido');
        const novaData = input.value;

        // Replicar para itens marcados (amarrar)
        replicarCampoParaItensAmarradosDropdown(numPedido, 'agendamento-dropdown', novaData);

        // Salvar automaticamente
        await salvarAlteracaoAutomatica(itemId, 'agendamento', novaData);
    }

    /**
     * Processa altera√ß√£o de protocolo no dropdown
     */
    async function processarAlteracaoProtocoloDropdown(input) {
        const itemId = input.getAttribute('data-item-id');
        const numPedido = input.getAttribute('data-pedido');
        const novoProtocolo = input.value;

        // Replicar para itens marcados (amarrar)
        replicarCampoParaItensAmarradosDropdown(numPedido, 'protocolo-dropdown', novoProtocolo);

        // Salvar automaticamente
        await salvarAlteracaoAutomatica(itemId, 'protocolo', novoProtocolo);
    }

    /**
     * Replica campo para itens marcados no dropdown (amarrar campos)
     */
    function replicarCampoParaItensAmarradosDropdown(numPedido, classeCampo, valor) {
        const checkboxesMarcados = document.querySelectorAll(`.item-checkbox-dropdown[data-pedido="${numPedido}"]:checked`);

        checkboxesMarcados.forEach(checkbox => {
            const itemId = checkbox.getAttribute('data-item-id');
            const row = document.getElementById(`row-dropdown-${numPedido}-${itemId}`);
            const campo = row?.querySelector(`.${classeCampo}`);

            if (campo && campo.value !== valor) {
                campo.value = valor;

                // Se for data expedi√ß√£o, recalcular estoques
                if (classeCampo === 'data-expedicao-dropdown' && valor) {
                    recalcularEstoquesBaseadoD0Dropdown(itemId, valor, numPedido);
                }

                // Salvar automaticamente
                const nomeCampo = classeCampo.replace('data-', '').replace('-dropdown', '').replace('-', '_');
                salvarAlteracaoAutomatica(itemId, nomeCampo, valor);
            }
        });
    }

    /**
     * Recalcula estoques D0/D7 no dropdown
     */
    async function recalcularEstoquesBaseadoD0Dropdown(itemId, dataExpedicao, numPedido) {
        try {
            const response = await fetch(`/carteira/api/item/${itemId}/recalcular-estoques`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    data_d0: dataExpedicao
                })
            });

            const data = await response.json();

            if (data.success) {
                // Atualizar colunas de estoque na linha
                const row = document.getElementById(`row-dropdown-${numPedido}-${itemId}`);
                if (row) {
                    const menorEstoqueEl = row.querySelector('.menor-estoque-d7-dropdown');
                    const estoqueD0El = row.querySelector('.estoque-d0-dropdown');
                    const producaoD0El = row.querySelector('.producao-d0-dropdown');

                    if (menorEstoqueEl) menorEstoqueEl.textContent = data.menor_estoque_d7 || '-';
                    if (estoqueD0El) estoqueD0El.textContent = data.estoque_expedicao || '-';
                    if (producaoD0El) producaoD0El.textContent = data.producao_expedicao || '-';
                }
            }
        } catch (error) {
            console.error('Erro ao recalcular estoques no dropdown:', error);
        }
    }

    /**
     * Toggle todos os itens do dropdown
     */
    function toggleTodosItensDropdown(numPedido, selectAll) {
        const checkboxes = document.querySelectorAll(`.item-checkbox-dropdown[data-pedido="${numPedido}"]:not(:disabled)`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        atualizarContadoresDropdown(numPedido);
    }

    /**
     * Envia itens selecionados do dropdown para separa√ß√£o
     */
    async function enviarParaSeparacaoDropdown(numPedido) {
        const checkboxesMarcados = document.querySelectorAll(`.item-checkbox-dropdown[data-pedido="${numPedido}"]:checked`);

        if (checkboxesMarcados.length === 0) {
            alert('‚ö†Ô∏è Selecione pelo menos um item para enviar para separa√ß√£o');
            return;
        }

        // Validar se todos t√™m data de expedi√ß√£o
        const semExpedicao = Array.from(checkboxesMarcados).filter(cb => {
            const itemId = cb.getAttribute('data-item-id');
            const row = document.getElementById(`row-dropdown-${numPedido}-${itemId}`);
            const dataExpedicao = row?.querySelector('.data-expedicao-dropdown')?.value;
            return !dataExpedicao || !dataExpedicao.trim();
        });

        if (semExpedicao.length > 0) {
            alert(`‚ö†Ô∏è ${semExpedicao.length} itens n√£o possuem Data de Expedi√ß√£o.\n\nPreencha a Data de Expedi√ß√£o para todos os itens selecionados.`);
            return;
        }

        // Coletar dados dos itens selecionados
        const itensParaSeparacao = [];

        checkboxesMarcados.forEach(checkbox => {
            const itemId = checkbox.getAttribute('data-item-id');
            const row = document.getElementById(`row-dropdown-${numPedido}-${itemId}`);

            if (row) {
                const qtdInput = row.querySelector('.qtd-dropdown');
                const dataExpedicaoInput = row.querySelector('.data-expedicao-dropdown');
                const agendamentoInput = row.querySelector('.agendamento-dropdown');
                const protocoloInput = row.querySelector('.protocolo-dropdown');

                const qtd = parseFloat(qtdInput?.value) || 0;
                const dataExpedicao = dataExpedicaoInput?.value || '';
                const agendamento = agendamentoInput?.value || '';
                const protocolo = protocoloInput?.value || '';

                if (qtd > 0) {
                    itensParaSeparacao.push({
                        item_id: itemId,
                        qtd_separacao: qtd,
                        expedicao: dataExpedicao,
                        agendamento: agendamento,
                        protocolo: protocolo
                    });
                }
            }
        });

        if (itensParaSeparacao.length === 0) {
            alert('‚ö†Ô∏è Nenhum item v√°lido para separa√ß√£o');
            return;
        }

        try {
            const btnEnviar = document.getElementById(`btn-enviar-dropdown-${numPedido}`);
            btnEnviar.disabled = true;
            btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            const response = await fetch(`/carteira/api/pedido/${numPedido}/criar-separacao`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    itens: itensParaSeparacao
                })
            });

            const data = await response.json();

            if (data.success) {
                alert(`‚úÖ Separa√ß√£o criada com sucesso!\n\nLote ID: ${data.separacao_lote_id}\nItens: ${itensParaSeparacao.length}`);

                // Recarregar itens do dropdown
                await carregarItensPedido(numPedido);
            } else {
                throw new Error(data.error || 'Erro ao criar separa√ß√£o');
            }

        } catch (error) {
            console.error('Erro ao enviar para separa√ß√£o do dropdown:', error);
            alert(`‚ùå Erro ao criar separa√ß√£o:\n\n${error.message}`);
        } finally {
            const btnEnviar = document.getElementById(`btn-enviar-dropdown-${numPedido}`);
            if (btnEnviar) {
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar para Separa√ß√£o';
            }
        }
    }

    /**
     * Replica campos manualmente (bot√£o do dropdown)
     */
    function replicarCamposAmarradosDropdown(numPedido) {
        const checkboxesMarcados = document.querySelectorAll(`.item-checkbox-dropdown[data-pedido="${numPedido}"]:checked`);

        if (checkboxesMarcados.length < 2) {
            alert('‚ö†Ô∏è Marque pelo menos 2 itens para replicar campos');
            return;
        }

        // Perguntar qual item usar como origem
        const itensDisponiveis = Array.from(checkboxesMarcados).map((cb, index) => {
            const itemId = cb.getAttribute('data-item-id');
            const row = document.getElementById(`row-dropdown-${numPedido}-${itemId}`);
            const codProduto = row?.querySelector('td:nth-child(2)')?.textContent || '';
            return `${index + 1}. ${codProduto} (ID: ${itemId})`;
        }).join('\n');

        const origem = prompt(`üìã REPLICAR CAMPOS\n\nItens selecionados:\n${itensDisponiveis}\n\nDigite o n√∫mero do item origem (1, 2, 3...):`);

        if (!origem) return;

        const indiceOrigem = parseInt(origem) - 1;
        if (indiceOrigem < 0 || indiceOrigem >= checkboxesMarcados.length) {
            alert('‚ö†Ô∏è N√∫mero inv√°lido');
            return;
        }

        // Obter dados do item origem
        const checkboxOrigem = checkboxesMarcados[indiceOrigem];
        const itemIdOrigem = checkboxOrigem.getAttribute('data-item-id');
        const rowOrigem = document.getElementById(`row-dropdown-${numPedido}-${itemIdOrigem}`);

        if (!rowOrigem) return;

        const dataExpedicao = rowOrigem.querySelector('.data-expedicao-dropdown')?.value || '';
        const agendamento = rowOrigem.querySelector('.agendamento-dropdown')?.value || '';
        const protocolo = rowOrigem.querySelector('.protocolo-dropdown')?.value || '';

        // Replicar para todos os outros marcados
        checkboxesMarcados.forEach((checkbox, index) => {
            if (index === indiceOrigem) return; // Pular o pr√≥prio item origem

            const itemId = checkbox.getAttribute('data-item-id');
            const row = document.getElementById(`row-dropdown-${numPedido}-${itemId}`);

            if (row) {
                if (dataExpedicao) {
                    const expedicaoEl = row.querySelector('.data-expedicao-dropdown');
                    if (expedicaoEl) {
                        expedicaoEl.value = dataExpedicao;
                        salvarAlteracaoAutomatica(itemId, 'expedicao', dataExpedicao);
                        recalcularEstoquesBaseadoD0Dropdown(itemId, dataExpedicao, numPedido);
                    }
                }

                if (agendamento) {
                    const agendamentoEl = row.querySelector('.agendamento-dropdown');
                    if (agendamentoEl) {
                        agendamentoEl.value = agendamento;
                        salvarAlteracaoAutomatica(itemId, 'agendamento', agendamento);
                    }
                }

                if (protocolo) {
                    const protocoloEl = row.querySelector('.protocolo-dropdown');
                    if (protocoloEl) {
                        protocoloEl.value = protocolo;
                        salvarAlteracaoAutomatica(itemId, 'protocolo', protocolo);
                    }
                }
            }
        });

        // Atualizar valida√ß√£o
        atualizarContadoresDropdown(numPedido);

        alert(`‚úÖ Campos replicados do item ${itemIdOrigem} para ${checkboxesMarcados.length - 1} itens`);
    }

    /**
     * Divide linha no dropdown criando pr√©-separa√ß√£o em tempo real
     */
    async function dividirLinhaDropdown(itemId, qtdUtilizada, qtdOriginal, numPedido) {
        console.log(`üìä Dividindo linha dropdown: Item ${itemId}, Qtd ${qtdUtilizada}, Original ${qtdOriginal}`);

        try {
            // Criar pr√©-separa√ß√£o com a quantidade utilizada
            const response = await fetch(`/carteira/api/pedido/${numPedido}/criar-pre-separacao`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    item_id: itemId,
                    quantidade: qtdUtilizada
                })
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                console.log(`‚úÖ Pr√©-separa√ß√£o criada: ${result.pre_separacao_id}`);

                // Adicionar nova linha dinamicamente ao inv√©s de recarregar tudo
                adicionarLinhaPreSeparacaoDropdown(numPedido, itemId, result.pre_separacao_id, qtdUtilizada, qtdOriginal);

                // Atualizar a linha original para mostrar quantidade restante
                const qtdRestante = qtdOriginal - qtdUtilizada;
                atualizarLinhaOriginalDropdown(numPedido, itemId, qtdRestante);

                // Mostrar notifica√ß√£o de sucesso
                showNotification(`‚úÖ Linha dividida com sucesso! Quantidade ${qtdUtilizada} separada.`, 'success');

                return true;
            } else {
                throw new Error(result.error || 'Erro ao criar pr√©-separa√ß√£o');
            }

        } catch (error) {
            console.error('‚ùå Erro ao dividir linha:', error);
            showNotification(`‚ùå Erro ao dividir linha: ${error.message}`, 'error');
            return false;
        }
    }

    /**
     * Adiciona linha de pr√©-separa√ß√£o dinamicamente no dropdown
     */
    function adicionarLinhaPreSeparacaoDropdown(numPedido, itemIdOriginal, preSeparacaoId, qtdPreSeparacao, qtdOriginal) {
        const rowOriginal = document.getElementById(`row-dropdown-${numPedido}-${itemIdOriginal}`);
        if (!rowOriginal) return;

        // Buscar dados do item original
        const dadosCache = itensPedidoCache.get(numPedido);
        const itemOriginal = dadosCache?.itens?.find(item => item.id.toString() === itemIdOriginal.toString());
        if (!itemOriginal) return;

        // Criar nova linha para pr√©-separa√ß√£o
        const novaLinha = document.createElement('tr');
        novaLinha.id = `row-dropdown-${numPedido}-pre-${preSeparacaoId}`;
        novaLinha.className = 'table-warning';
        novaLinha.setAttribute('data-item-id', itemIdOriginal);
        novaLinha.setAttribute('data-pedido', numPedido);
        novaLinha.setAttribute('data-tipo-item', 'pre_separacao');
        novaLinha.setAttribute('data-pre-separacao-id', preSeparacaoId);

        // Calcular valores proporcionais
        const proporcao = qtdPreSeparacao / qtdOriginal;
        const valorTotal = (itemOriginal.preco_unitario || 0) * qtdPreSeparacao;
        const pesoTotal = (parseFloat(itemOriginal.peso || 0) * proporcao).toFixed(1);
        const palletTotal = (parseFloat(itemOriginal.pallet || 0) * proporcao).toFixed(1);

        novaLinha.innerHTML = `
            <td>
                <div class="btn-group-vertical" role="group">
                    <button type="button" 
                            class="btn btn-sm btn-outline-primary mb-1" 
                            onclick="editarPreSeparacao('${preSeparacaoId}')"
                            title="Editar pr√©-separa√ß√£o">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" 
                            class="btn btn-sm btn-outline-danger mb-1" 
                            onclick="cancelarPreSeparacao('${preSeparacaoId}')"
                            title="Cancelar pr√©-separa√ß√£o">
                        <i class="fas fa-times"></i>
                    </button>
                    <button type="button" 
                            class="btn btn-sm btn-outline-success" 
                            onclick="enviarPreSeparacaoParaSeparacao('${preSeparacaoId}')"
                            title="Enviar para separa√ß√£o">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </td>
            <td>
                <strong>${itemOriginal.cod_produto || ''}</strong>
                <br><small class="text-warning"><i class="fas fa-clock"></i> Pr√©-separa√ß√£o</small>
            </td>
            <td class="text-truncate" style="max-width: 200px;" title="${itemOriginal.nome_produto || ''}">
                ${itemOriginal.nome_produto || ''}
                <br><small class="badge bg-info">Pendente</small>
            </td>
            <td>
                <input type="number" 
                       class="form-control form-control-sm qtd-pre-separacao" 
                       data-pre-separacao-id="${preSeparacaoId}"
                       data-qtd-original="${qtdOriginal}"
                       step="1"
                       min="0"
                       max="${qtdOriginal}"
                       value="${qtdPreSeparacao}"
                       onchange="editarQuantidadePreSeparacao(this)"
                       title="Quantidade edit√°vel da pr√©-separa√ß√£o">
                <small class="text-muted">Pr√©-sep: ${qtdPreSeparacao} de ${qtdOriginal}</small>
            </td>
            <td class="valor-calculado-dropdown">R$ ${valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
            <td class="peso-calculado-dropdown">${pesoTotal} kg</td>
            <td class="pallet-calculado-dropdown">${palletTotal} pal</td>
            <td class="menor-estoque-d7-dropdown">${itemOriginal.menor_estoque_d7 || '-'}</td>
            <td class="estoque-d0-dropdown">${itemOriginal.estoque_expedicao || '-'}</td>
            <td class="producao-d0-dropdown">${itemOriginal.producao_expedicao || '-'}</td>
            <td class="proxima-data-estoque">${itemOriginal.proxima_data_estoque || '-'}</td>
            <td>
                <input type="date" 
                       class="form-control form-control-sm data-expedicao-pre-separacao" 
                       data-pre-separacao-id="${preSeparacaoId}"
                       value="${itemOriginal.expedicao || ''}"
                       onchange="editarDataPreSeparacao(this, 'data_expedicao_editada')"
                       title="Data de expedi√ß√£o edit√°vel da pr√©-separa√ß√£o">
            </td>
            <td>
                <input type="date" 
                       class="form-control form-control-sm data-agendamento-pre-separacao" 
                       data-pre-separacao-id="${preSeparacaoId}"
                       value="${itemOriginal.agendamento || ''}"
                       onchange="editarDataPreSeparacao(this, 'data_agendamento_editada')"
                       title="Data de agendamento edit√°vel da pr√©-separa√ß√£o">
            </td>
            <td>
                <input type="text" 
                       class="form-control form-control-sm protocolo-pre-separacao" 
                       data-pre-separacao-id="${preSeparacaoId}"
                       value="${itemOriginal.protocolo || ''}"
                       onchange="editarCampoPreSeparacao(this, 'protocolo_editado')"
                       placeholder="Protocolo"
                       title="Protocolo edit√°vel da pr√©-separa√ß√£o">
            </td>
        `;

        // Inserir ap√≥s a linha original
        rowOriginal.parentNode.insertBefore(novaLinha, rowOriginal.nextSibling);

        // Atualizar totais
        recalcularTotaisDropdown(numPedido);
    }

    /**
     * Atualiza linha original ap√≥s divis√£o
     */
    function atualizarLinhaOriginalDropdown(numPedido, itemId, qtdRestante) {
        const rowOriginal = document.getElementById(`row-dropdown-${numPedido}-${itemId}`);
        if (!rowOriginal) return;

        // Desabilitar checkbox e inputs se quantidade zerou
        if (qtdRestante === 0) {
            const checkbox = rowOriginal.querySelector('.item-checkbox-dropdown');
            if (checkbox) {
                checkbox.checked = false;
                checkbox.disabled = true;
            }

            const inputs = rowOriginal.querySelectorAll('input');
            inputs.forEach(input => input.disabled = true);

            rowOriginal.classList.add('table-secondary', 'text-muted');
        }

        // Atualizar display da quantidade m√°xima
        const qtdInput = rowOriginal.querySelector('.qtd-dropdown');
        if (qtdInput) {
            qtdInput.setAttribute('data-qtd-original', qtdRestante);
            qtdInput.setAttribute('max', qtdRestante);
            qtdInput.value = qtdRestante;

            const smallText = qtdInput.nextElementSibling;
            if (smallText) {
                smallText.textContent = `M√°x: ${qtdRestante}`;
            }
        }

        // Recalcular valores
        recalcularValoresDropdown(qtdInput);
    }

    /**
     * Unifica linha no dropdown removendo pr√©-separa√ß√£o
     */
    async function unificarLinhaDropdown(itemId, numPedido) {
        console.log(`üîÑ Unificando linha dropdown: Item ${itemId}`);

        try {
            // Buscar todas as linhas de pr√©-separa√ß√£o do item
            const linhasPreSeparacao = document.querySelectorAll(`tr[data-item-id="${itemId}"][data-tipo-item="pre_separacao"]`);

            if (linhasPreSeparacao.length === 0) {
                console.log('Item n√£o tem pr√©-separa√ß√£o para unificar');
                return true;
            }

            // Cancelar todas as pr√©-separa√ß√µes do item
            for (const linha of linhasPreSeparacao) {
                const preSeparacaoId = linha.getAttribute('data-pre-separacao-id');
                if (!preSeparacaoId) continue;

                const response = await fetch(`/carteira/api/pre-separacao/${preSeparacaoId}/cancelar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    console.log(`‚úÖ Pr√©-separa√ß√£o ${preSeparacaoId} cancelada`);

                    // Remover linha da pr√©-separa√ß√£o do DOM
                    linha.remove();

                    // Buscar dados originais do cache
                    const dadosCache = itensPedidoCache.get(numPedido);
                    const itemOriginal = dadosCache?.itens?.find(item => item.id.toString() === itemId.toString());

                    if (itemOriginal) {
                        // Restaurar quantidade original na linha principal
                        const rowOriginal = document.getElementById(`row-dropdown-${numPedido}-${itemId}`);
                        if (rowOriginal) {
                            // Reabilitar inputs
                            const checkbox = rowOriginal.querySelector('.item-checkbox-dropdown');
                            if (checkbox) checkbox.disabled = false;

                            const inputs = rowOriginal.querySelectorAll('input');
                            inputs.forEach(input => input.disabled = false);

                            // Remover classes de desabilitado
                            rowOriginal.classList.remove('table-secondary', 'text-muted');

                            // Restaurar quantidade original
                            const qtdInput = rowOriginal.querySelector('.qtd-dropdown');
                            if (qtdInput) {
                                const qtdOriginalTotal = parseFloat(itemOriginal.qtd_saldo_produto_pedido || 0);
                                qtdInput.setAttribute('data-qtd-original', qtdOriginalTotal);
                                qtdInput.setAttribute('max', qtdOriginalTotal);
                                qtdInput.value = qtdOriginalTotal;

                                const smallText = qtdInput.nextElementSibling;
                                if (smallText) {
                                    smallText.textContent = `M√°x: ${qtdOriginalTotal}`;
                                }

                                // Recalcular valores com quantidade total
                                recalcularValoresDropdown(qtdInput);
                            }
                        }
                    }
                } else {
                    throw new Error(result.error || 'Erro ao cancelar pr√©-separa√ß√£o');
                }
            }

            // Atualizar totais e contadores
            recalcularTotaisDropdown(numPedido);
            atualizarContadoresDropdown(numPedido);

            // Mostrar notifica√ß√£o de sucesso
            showNotification(`‚úÖ Linha unificada com sucesso! Quantidade restaurada ao original.`, 'success');

            return true;

        } catch (error) {
            console.error('‚ùå Erro ao unificar linha:', error);
            showNotification(`‚ùå Erro ao unificar linha: ${error.message}`, 'error');
            return false;
        }
    }

    // ===== FUN√á√ïES ESPEC√çFICAS DO DROPDOWN SEPARA√á√ïES =====

    // Estado de expans√£o das separa√ß√µes (cache local)
    const separacoesExpandidas = new Set();
    const separacoesPedidoCache = new Map();

    /**
     * Toggle expans√£o/colapso de separa√ß√µes de um pedido
     */
    function toggleSeparacoesPedido(numPedido) {
        const linhaSeparacoes = document.getElementById(`separacoes-${numPedido}`);
        const icone = document.getElementById(`separacao-icon-${numPedido}`);

        if (separacoesExpandidas.has(numPedido)) {
            // Colapsar
            $(linhaSeparacoes).collapse('hide');
            icone.className = 'fas fa-chevron-right separacao-icon';
            separacoesExpandidas.delete(numPedido);
        } else {
            // Expandir
            $(linhaSeparacoes).collapse('show');
            icone.className = 'fas fa-chevron-down separacao-icon';
            separacoesExpandidas.add(numPedido);

            // Carregar separa√ß√µes se ainda n√£o foram carregadas
            if (!separacoesPedidoCache.has(numPedido)) {
                carregarSeparacoesPedidoInline(numPedido);
            }
        }
    }

    /**
     * Carrega separa√ß√µes de um pedido via AJAX (INLINE ROW VERSION)
     */
    async function carregarSeparacoesPedidoInline(numPedido) {
        const loadingDiv = document.getElementById(`separacoes-loading-${numPedido}`);
        const contentDiv = document.getElementById(`separacoes-content-${numPedido}`);
        const badge = document.getElementById(`separacoes-badge-${numPedido}`);

        try {
            // Mostrar loading
            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';
            badge.textContent = 'Carregando...';
            badge.className = 'badge bg-light ml-2';

            // Fazer requisi√ß√£o AJAX para separa√ß√µes
            const response = await fetch(`/carteira/api/pedido/${numPedido}/separacoes`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Erro ao carregar separa√ß√µes');
            }

            // Armazenar no cache
            separacoesPedidoCache.set(numPedido, data);

            // Gerar HTML das separa√ß√µes
            const htmlSeparacoes = gerarHtmlSeparacoes(data);
            contentDiv.innerHTML = htmlSeparacoes;

            // Atualizar badge do header
            const totalSep = data.total_separacoes || 0;
            badge.textContent = `${totalSep} separa√ß√£o${totalSep !== 1 ? '√µes' : ''}`;
            badge.className = totalSep > 0 ? 'badge bg-success ml-2' : 'badge bg-secondary ml-2';

            // Atualizar badge principal da coluna
            const badgePrincipal = document.getElementById(`separacoes-badge-${numPedido}`);
            if (badgePrincipal) {
                badgePrincipal.textContent = `${totalSep} separa√ß√£o${totalSep !== 1 ? '√µes' : ''}`;
                badgePrincipal.style.backgroundColor = totalSep > 0 ? '#28a745' : '#6c757d';
            }

            // Atualizar badge do cabe√ßalho expandido
            const badgeHeader = document.getElementById(`separacoes-header-badge-${numPedido}`);
            if (badgeHeader) {
                badgeHeader.textContent = badge.textContent;
                badgeHeader.className = badge.className;
            }

            // Mostrar conte√∫do
            loadingDiv.style.display = 'none';
            contentDiv.style.display = 'block';

            console.log(`‚úÖ Separa√ß√µes carregadas para pedido ${numPedido}: ${totalSep} separa√ß√µes`);

        } catch (error) {
            console.error(`‚ùå Erro ao carregar separa√ß√µes do pedido ${numPedido}:`, error);

            // Mostrar erro
            badge.textContent = 'Erro';
            badge.className = 'badge bg-danger ml-2';

            // CORRIGIDO: XSS - criar elementos DOM ao inv√©s de innerHTML com error.message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger m-3';
            alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro ao carregar separa√ß√µes: ';
            const errorSpan = document.createElement('span');
            errorSpan.textContent = error.message || 'Erro desconhecido';
            alertDiv.appendChild(errorSpan);

            const retryBtn = document.createElement('button');
            retryBtn.className = 'btn btn-sm btn-outline-danger ml-2';
            retryBtn.onclick = () => carregarSeparacoesPedidoInline(numPedido);
            retryBtn.innerHTML = '<i class="fas fa-redo"></i> Tentar novamente';
            alertDiv.appendChild(retryBtn);

            contentDiv.innerHTML = '';
            contentDiv.appendChild(alertDiv);

            loadingDiv.style.display = 'none';
            contentDiv.style.display = 'block';
        }
    }

    /**
     * Gera HTML das separa√ß√µes conforme CARTEIRA.csv (DROP DOWN SEPARA√á√ÉO)
     */
    function gerarHtmlSeparacoes(data) {
        const numPedido = data.num_pedido;
        const separacoes = data.separacoes || [];

        if (separacoes.length === 0) {
            return `
            <div class="alert alert-info m-3">
                <i class="fas fa-info-circle"></i>
                <strong>Nenhuma separa√ß√£o encontrada</strong>
                <p class="mb-0">Este pedido ainda n√£o possui separa√ß√µes criadas.</p>
            </div>
        `;
        }

        let html = `
        <div class="table-responsive">
            <table class="table table-sm table-striped mb-0">
                <thead class="thead-dark">
                    <tr>
                        <th>C√≥digo</th>
                        <th>Produto</th>
                        <th>Qtd</th>
                        <th>Valor</th>
                        <th>Pallet</th>
                        <th>Peso</th>
                        <th>Menor Estoque D7</th>
                        <th>Est. Expedi√ß√£o</th>
                        <th>Prod. Expedi√ß√£o</th>
                        <th>Data Expedi√ß√£o</th>
                        <th>Agendamento</th>
                        <th>Protocolo</th>
                        <th>Lote ID</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
    `;

        separacoes.forEach(sep => {
            const statusClass = sep.status_class || 'info';
            const statusColors = {
                'success': '#28a745',
                'warning': '#ffc107',
                'danger': '#dc3545',
                'info': '#17a2b8',
                'primary': '#007bff'
            };
            const backgroundColor = statusColors[statusClass] || '#17a2b8';
            const textColor = statusClass === 'warning' ? '#212529' : 'white';

            html += `
            <tr>
                <td><strong>${sep.cod_produto || '-'}</strong></td>
                <td class="text-truncate" style="max-width: 200px;" title="${sep.nome_produto || ''}">
                    ${sep.nome_produto || '-'}
                </td>
                <td><strong>${(sep.qtd_saldo || 0).toLocaleString('pt-BR')}</strong></td>
                <td>${(sep.valor_saldo || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                <td>${(sep.pallet || 0).toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })} pal</td>
                <td>${(sep.peso || 0).toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })} kg</td>
                <td>${sep.menor_estoque_d7 || '-'}</td>
                <td>${sep.estoque_expedicao || '-'}</td>
                <td>${sep.producao_expedicao || '-'}</td>
                <td><small class="text-primary">${sep.expedicao || '-'}</small></td>
                <td><small class="text-info">${sep.agendamento || '-'}</small></td>
                <td><small class="text-success">${sep.protocolo || '-'}</small></td>
                <td><code class="small">${sep.separacao_lote_id || '-'}</code></td>
                <td>
                    <span class="badge" style="background-color: ${backgroundColor}; color: ${textColor};">
                        ${sep.status}
                    </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info btn-sm" 
                                onclick="verDetalhesSeparacao('${sep.separacao_lote_id}')"
                                title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm" 
                                onclick="editarSeparacao('${sep.separacao_lote_id}')"
                                title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        });

        // Calcular totais
        const totalQtd = separacoes.reduce((sum, sep) => sum + (sep.qtd_saldo || 0), 0);
        const totalValor = separacoes.reduce((sum, sep) => sum + (sep.valor_saldo || 0), 0);
        const totalPallet = separacoes.reduce((sum, sep) => sum + (sep.pallet || 0), 0);
        const totalPeso = separacoes.reduce((sum, sep) => sum + (sep.peso || 0), 0);

        html += `
                </tbody>
                <tfoot class="bg-light">
                    <tr>
                        <th colspan="2">TOTAIS:</th>
                        <th>${totalQtd.toLocaleString('pt-BR')}</th>
                        <th>${totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</th>
                        <th>${totalPallet.toLocaleString('pt-BR', { minimumFractionDigits: 1 })} pal</th>
                        <th>${totalPeso.toLocaleString('pt-BR', { minimumFractionDigits: 1 })} kg</th>
                        <th colspan="5">
                            <small class="text-muted">
                                ${data.separacoes_embarcadas}/${data.total_separacoes} embarcadas
                            </small>
                        </th>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Resumo das separa√ß√µes -->
        <div class="alert alert-info mt-2">
            <strong>üì¶ Resumo:</strong>
            <span class="badge bg-success ml-2">${data.separacoes_embarcadas} Embarcadas</span>
            <span class="badge bg-warning ml-2">${data.separacoes_pendentes} Pendentes</span>
            <span class="badge bg-info ml-2">${data.total_separacoes} Total</span>
        </div>
    `;

        return html;
    }

    /**
     * Gera HTML da tabela de itens
     */
    function gerarHtmlItens(data) {
        const numPedido = data.num_pedido;

        let html = `
        <!-- Bot√£o Enviar para Separa√ß√£o no topo conforme CARTEIRA.csv -->
        <div class="card mb-2">
            <div class="card-header bg-success text-white p-2">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-boxes"></i> A√ß√µes de Separa√ß√£o
                    </h6>
                    <button type="button" class="btn btn-light btn-sm" onclick="enviarParaSeparacaoDropdown('${numPedido}')" id="btn-enviar-dropdown-${numPedido}">
                        <i class="fas fa-paper-plane"></i> Enviar para Separa√ß√£o
                    </button>
                </div>
            </div>
            <div class="card-body p-2">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Itens Selecionados:</strong>
                        <span id="contador-dropdown-${numPedido}" class="badge" style="background-color: #ffc107; color: #212529;">0</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Com Data Expedi√ß√£o:</strong>
                        <span id="contador-expedicao-dropdown-${numPedido}" class="badge" style="background-color: #198754; color: white;">0</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Status:</strong>
                        <span id="status-dropdown-${numPedido}" class="badge" style="background-color: #6c757d; color: white;">Selecione itens</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-sm table-striped mb-0" id="tabela-dropdown-${numPedido}">
                <thead class="thead-dark">
                    <tr>
                        <th width="30">
                            <input type="checkbox" id="select-all-dropdown-${numPedido}" onchange="toggleTodosItensDropdown('${numPedido}', this)" title="Selecionar todos">
                        </th>
                        <th>C√≥digo</th>
                        <th>Produto</th>
                        <th>Qtd</th>
                        <th>Valor</th>
                        <th>Peso</th>
                        <th>Pallet</th>
                        <th>Menor Estoque D7</th>
                        <th>Est. Expedi√ß√£o</th>
                        <th>Prod. Expedi√ß√£o</th>
                        <th>Pr√≥x. Dispon√≠vel</th>
                        <th>Data Expedi√ß√£o</th>
                        <th>Agendamento</th>
                        <th>Protocolo</th>
                    </tr>
                </thead>
                <tbody>
    `;

        data.itens.forEach(item => {
            const itemId = item.id;
            const saldoDisponivel = item.qtd_saldo_disponivel || 0;
            const disabled = saldoDisponivel <= 0 ? 'disabled' : '';
            const isPreSeparacao = item.tipo_item === 'pre_separacao';
            const rowClass = isPreSeparacao ? 'table-warning' : '';

            html += `
            <tr id="row-dropdown-${numPedido}-${itemId}" 
                data-item-id="${itemId}" 
                data-pedido="${numPedido}"
                data-tipo-item="${item.tipo_item || 'carteira'}"
                ${isPreSeparacao ? `data-pre-separacao-id="${item.pre_separacao_id || ''}"` : ''}
                class="${rowClass}">
                <td>
                    ${isPreSeparacao ?
                    `<div class="btn-group-vertical" role="group">
                            <button type="button" 
                                    class="btn btn-sm btn-outline-primary mb-1" 
                                    onclick="editarPreSeparacao('${item.pre_separacao_id || ''}')"
                                    title="Editar pr√©-separa√ß√£o">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" 
                                    class="btn btn-sm btn-outline-danger mb-1" 
                                    onclick="cancelarPreSeparacao('${item.pre_separacao_id || ''}')"
                                    title="Cancelar pr√©-separa√ß√£o">
                                <i class="fas fa-times"></i>
                            </button>
                            <button type="button" 
                                    class="btn btn-sm btn-outline-success" 
                                    onclick="enviarPreSeparacaoParaSeparacao('${item.pre_separacao_id || ''}')"
                                    title="Enviar para separa√ß√£o">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>` :
                    `<input type="checkbox" 
                                class="item-checkbox-dropdown" 
                                data-item-id="${itemId}"
                                data-pedido="${numPedido}"
                                onchange="atualizarContadoresDropdown('${numPedido}')"
                                ${disabled}>`
                }
                </td>
                <td>
                    <strong>${item.cod_produto || ''}</strong>
                    ${isPreSeparacao ? `<br><small class="text-warning"><i class="fas fa-clock"></i> Pr√©-separa√ß√£o</small>` : ''}
                </td>
                <td class="text-truncate" style="max-width: 200px;" title="${item.nome_produto || ''}">
                    ${item.nome_produto || ''}
                    ${isPreSeparacao && item.status ? `<br><small class="badge bg-info">${item.status || ''}</small>` : ''}
                </td>
                <td>
                    ${isPreSeparacao ?
                    `<input type="number" 
                                class="form-control form-control-sm qtd-pre-separacao" 
                                data-pre-separacao-id="${item.pre_separacao_id || ''}"
                                data-qtd-original="${item.qtd_carteira}"
                                step="1"
                                min="0"
                                max="${item.qtd_carteira}"
                                value="${saldoDisponivel}"
                                onchange="editarQuantidadePreSeparacao(this)"
                                title="Quantidade edit√°vel da pr√©-separa√ß√£o">
                         <small class="text-muted">Pr√©-sep: ${saldoDisponivel} de ${item.qtd_carteira}</small>` :
                    `<input type="number" 
                                class="form-control form-control-sm qtd-dropdown" 
                                data-item-id="${itemId}"
                                data-pedido="${numPedido}"
                                data-qtd-original="${saldoDisponivel}"
                                data-preco-unitario="${item.preco_unitario || 0}"
                                step="1"
                                min="0"
                                max="${saldoDisponivel}"
                                value="${saldoDisponivel}"
                                placeholder="${saldoDisponivel}"
                                onchange="processarAlteracaoQuantidadeDropdown(this)"
                                oninput="recalcularValoresDropdown(this)"
                                ${disabled}>
                         <small class="text-muted">M√°x: ${saldoDisponivel}</small>`
                }
                </td>
                <td class="valor-calculado-dropdown">${item.valor_calculado || 'R$ 0,00'}</td>
                <td class="peso-calculado-dropdown">${item.peso_calculado || '0 kg'}</td>
                <td class="pallet-calculado-dropdown">${item.pallet_calculado || '0,0 pal'}</td>
                <td class="menor-estoque-d7-dropdown">${item.menor_estoque_d7 || '-'}</td>
                                    <td class="estoque-d0-dropdown">${item.estoque_expedicao || '-'}</td>
                    <td class="producao-d0-dropdown">${item.producao_expedicao || '-'}</td>
                <td class="proxima-data-estoque">${item.proxima_data_estoque || '-'}</td>
                <td>
                    ${isPreSeparacao ?
                    `<input type="date" 
                                class="form-control form-control-sm data-expedicao-pre-separacao" 
                                data-pre-separacao-id="${item.pre_separacao_id || ''}"
                                value="${item.expedicao || ''}"
                                onchange="editarDataPreSeparacao(this, 'expedicao')"
                                title="Data de expedi√ß√£o da pr√©-separa√ß√£o">` :
                    `<input type="date" 
                                class="form-control form-control-sm data-expedicao-dropdown" 
                                data-item-id="${itemId}"
                                data-pedido="${numPedido}"
                                value="${item.expedicao || ''}"
                                onchange="processarAlteracaoDataExpedicaoDropdown(this)"
                                ${disabled}>`
                }
                </td>
                <td>
                    ${isPreSeparacao ?
                    `<input type="date" 
                                class="form-control form-control-sm agendamento-pre-separacao" 
                                data-pre-separacao-id="${item.pre_separacao_id || ''}"
                                value="${item.agendamento || ''}"
                                onchange="editarDataPreSeparacao(this, 'agendamento')"
                                title="Data de agendamento da pr√©-separa√ß√£o">` :
                    `<input type="date" 
                                class="form-control form-control-sm agendamento-dropdown" 
                                data-item-id="${itemId}"
                                data-pedido="${numPedido}"
                                value="${item.agendamento || ''}"
                                onchange="processarAlteracaoAgendamentoDropdown(this)"
                                ${disabled}>`
                }
                </td>
                <td>
                    ${isPreSeparacao ?
                    `<input type="text" 
                                class="form-control form-control-sm protocolo-pre-separacao" 
                                data-pre-separacao-id="${item.pre_separacao_id || ''}"
                                value="${item.protocolo || ''}"
                                placeholder="Protocolo"
                                onchange="editarCampoPreSeparacao(this, 'protocolo')"
                                title="Protocolo da pr√©-separa√ß√£o">
                         ${item.observacoes ? `<br><small class="text-info" title="${item.observacoes}"><i class="fas fa-comment"></i> Obs.</small>` : ''}` :
                    `<input type="text" 
                                class="form-control form-control-sm protocolo-dropdown" 
                                data-item-id="${itemId}"
                                data-pedido="${numPedido}"
                                value="${item.protocolo || ''}"
                                placeholder="Protocolo"
                                onchange="processarAlteracaoProtocoloDropdown(this)"
                                ${disabled}>`
                }
                </td>
            </tr>
        `;
        });

        // Calcular totais dos valores atuais
        let valorTotal = 0;
        let pesoTotal = 0;
        let palletTotal = 0;

        data.itens.forEach(item => {
            const valor = parseFloat(item.valor_calculado?.replace(/[R$\s.]/g, '')?.replace(',', '.') || 0);
            const peso = parseFloat(item.peso?.replace(/[kg\s]/g, '')?.replace(',', '.') || 0);
            const pallet = parseFloat(item.pallet?.replace(/[pal\s]/g, '')?.replace(',', '.') || 0);

            valorTotal += valor;
            pesoTotal += peso;
            palletTotal += pallet;
        });

        html += `
                </tbody>
                <tfoot class="bg-light">
                    <tr>
                        <th colspan="4">TOTAIS SELECIONADOS:</th>
                        <th id="total-valor-dropdown-${numPedido}">R$ ${valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</th>
                        <th id="total-peso-dropdown-${numPedido}">${pesoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 1 })} kg</th>
                        <th id="total-pallet-dropdown-${numPedido}">${palletTotal.toLocaleString('pt-BR', { minimumFractionDigits: 1 })} pal</th>
                        <th colspan="7">
                            <button class="btn btn-sm btn-outline-info" onclick="replicarCamposAmarradosDropdown('${numPedido}')">
                                <i class="fas fa-link"></i> Replicar Campos
                            </button>
                        </th>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Instru√ß√µes de uso conforme CARTEIRA.csv -->
        <div class="alert alert-info mt-2">
            <strong>üìã Como usar:</strong>
            <ul class="mb-0">
                <li><strong>Qtd:</strong> Edite para dividir linha (saldo restante vira nova linha)</li>
                <li><strong>Campos amarrados:</strong> Data Expedi√ß√£o, Agendamento e Protocolo replicam automaticamente para itens marcados</li>
                <li><strong>Valida√ß√£o:</strong> S√≥ √© poss√≠vel enviar para separa√ß√£o itens com Data de Expedi√ß√£o preenchida</li>
                <li><strong>Auto-save:</strong> Altera√ß√µes s√£o salvas automaticamente</li>
            </ul>
        </div>
    `;

        return html;
    }

    /**
     * Placeholder para editar item - agora redireciona para modal
     */
    function editarItem(itemId) {
        // Buscar o pedido do item para abrir modal de itens edit√°veis
        const pedidoRow = document.querySelector(`tr[data-pedido]`);
        if (pedidoRow) {
            const numPedido = pedidoRow.getAttribute('data-pedido');
            // ‚ùå REMOVIDO: Modal obsoleto - funcionalidade agora no dropdown real
            console.log('‚ö†Ô∏è Modal edit√°vel foi substitu√≠do pelo dropdown expandido');
        }
    }

    // ===== FUN√á√ïES DO MODAL AVALIAR ESTOQUES =====

    // Vari√°veis globais do modal
    let dadosModalAtual = null;
    let numPedidoModal = null;

    /**
     * Abre modal para avaliar estoques de um pedido (28 dias)
     * Implementa√ß√£o: Fase 2.3 - Modal Avaliar Estoques
     */
    async function abrirModalAvaliarEstoques(numPedido) {
        console.log(`üìä Avaliar Estoques pedido ${numPedido}`);
        numPedidoModal = numPedido;

        try {
            // üîç DEBUG: Verificar elementos
            const modalElement = document.getElementById('modalAvaliarEstoques');
            const numPedidoElement = document.getElementById('modal-num-pedido-estoques');
            const formElement = document.getElementById('form-num-pedido');

            console.log('üîç DEBUG Modal:', {
                modalElement: !!modalElement,
                numPedidoElement: !!numPedidoElement,
                formElement: !!formElement,
                bootstrap: typeof bootstrap
            });

            // Configurar modal se elementos existirem
            if (numPedidoElement) numPedidoElement.textContent = numPedido;
            if (formElement) formElement.value = numPedido;

            // üéØ FOR√áAR modal a abrir - m√©todo mais compat√≠vel
            if (modalElement) {
                // Tentar Bootstrap 5 primeiro
                if (typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                    console.log('‚úÖ Modal Bootstrap 5 aberto');
                }
                // Fallback jQuery se Bootstrap 5 falhar
                else if (typeof $ !== 'undefined') {
                    $(modalElement).modal('show');
                    console.log('‚úÖ Modal jQuery aberto');
                }
                // √öltimo recurso: CSS manual
                else {
                    modalElement.style.display = 'block';
                    modalElement.classList.add('show');
                    modalElement.setAttribute('aria-hidden', 'false');
                    document.body.classList.add('modal-open');
                    console.log('‚úÖ Modal CSS manual aberto');
                }
            } else {
                alert('‚ùå Modal n√£o encontrado no DOM');
            }

            // Carregar dados
            await carregarDadosModal(numPedido);

        } catch (error) {
            console.error('‚ùå Erro ao abrir modal:', error);
            alert('Erro ao abrir modal: ' + error.message);
        }
    }

    /**
     * Carrega dados dos itens para o modal
     */
    async function carregarDadosModal(numPedido) {
        const modalLoading = document.getElementById('modal-loading');
        const modalError = document.getElementById('modal-error');
        const modalContent = document.getElementById('modal-content');

        try {
            // Mostrar loading
            modalLoading.style.display = 'block';
            modalError.style.display = 'none';
            modalContent.style.display = 'none';

            // Verificar se j√° temos os dados no cache
            let data = itensPedidoCache.get(numPedido);

            if (!data) {
                // üéØ Fazer requisi√ß√£o AJAX para estoque projetado 28 dias
                const response = await fetch(`/carteira/api/pedido/${numPedido}/estoque-projetado-28-dias`);
                data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Erro ao carregar itens');
                }

                // Armazenar no cache
                itensPedidoCache.set(numPedido, data);
            }

            // Armazenar dados para uso no modal
            dadosModalAtual = data;

            // Gerar HTML dos itens edit√°veis
            gerarHtmlItensModal(data);

            // Atualizar resumo
            atualizarResumoModal(data);

            // Mostrar conte√∫do
            modalLoading.style.display = 'none';
            modalContent.style.display = 'block';

            console.log(`‚úÖ Modal carregado para pedido ${numPedido}: ${data.total_itens} itens`);

        } catch (error) {
            console.error(`‚ùå Erro ao carregar modal do pedido ${numPedido}:`, error);

            // Mostrar erro
            document.getElementById('modal-error-message').textContent = error.message;
            modalLoading.style.display = 'none';
            modalError.style.display = 'block';
            modalContent.style.display = 'none';
        }
    }

    /**
     * Gera HTML da tabela de itens edit√°veis no modal
     */
    function gerarHtmlItensModal(data) {
        const tbody = document.getElementById('tbody-itens-modal');
        let html = '';

        data.itens.forEach((item, index) => {
            const disabled = item.tem_separacao ? 'disabled' : '';
            const checkboxDisabled = item.tem_separacao ? 'disabled' : '';
            const statusClass = item.tem_separacao ? 'success' : 'warning';
            const statusText = item.tem_separacao ? 'Separado' : 'Pendente';

            html += `
            <tr id="row-item-${item.id}" ${item.tem_separacao ? 'class="table-secondary"' : ''}>
                <td>
                    <input type="checkbox" 
                           class="item-checkbox" 
                           data-item-id="${item.id}"
                           data-index="${index}"
                           onchange="calcularTotaisModal()"
                           ${checkboxDisabled}>
                </td>
                <td><small><strong>${item.cod_produto}</strong></small></td>
                <td><small>${item.nome_produto || ''}</small></td>
                <td><strong>${item.qtd_saldo_formatado}</strong></td>
                <td>
                    <input type="number" 
                           class="form-control form-control-sm qtd-input" 
                           data-item-id="${item.id}"
                           data-max="${item.qtd_saldo}"
                           data-preco="${item.preco}"
                           data-peso-unitario="${item.peso_item / item.qtd_saldo || 0}"
                           data-pallet-unitario="${item.pallet_item / item.qtd_saldo || 0}"
                           step="1"
                           min="0"
                           max="${item.qtd_saldo}"
                           value="${Math.round(item.qtd_saldo)}"
                           placeholder="${Math.round(item.qtd_saldo)}"
                           onchange="validarQuantidade(this); calcularTotaisModal(); atualizarCalculosItem(this)"
                           oninput="atualizarCalculosItem(this)"
                           ${disabled}>
                    <small class="text-muted">Qtd edit√°vel - auto-c√°lculo valor/peso/pallet</small>
                </td>
                <td>
                    <span class="valor-calculado">R$ ${item.preco.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                    <input type="hidden" class="valor-original" value="${item.preco}">
                </td>
                <td>
                    <input type="date" 
                           class="form-control form-control-sm" 
                           data-item-id="${item.id}"
                           data-field="expedicao"
                           value="${item.expedicao}"
                           ${disabled}>
                </td>
                <td>
                    <input type="date" 
                           class="form-control form-control-sm" 
                           data-item-id="${item.id}"
                           data-field="agendamento"
                           value="${item.agendamento}"
                           ${disabled}>
                </td>
                <td>
                    <input type="text" 
                           class="form-control form-control-sm" 
                           data-item-id="${item.id}"
                           data-field="protocolo"
                           value="${item.protocolo}"
                           placeholder="Protocolo"
                           ${disabled}>
                </td>
                <td>
                    <span class="badge ${item.tem_separacao ? 'badge-success' : 'badge-warning'}" style="${item.tem_separacao ? 'background-color: #28a745; color: white;' : 'background-color: #ffc107; color: black;'}">
                        ${statusText}
                    </span>
                </td>
            </tr>
        `;
        });

        tbody.innerHTML = html;

        // Calcular totais iniciais
        calcularTotaisModal();
    }

    /**
     * Atualiza resumo do pedido no modal
     */
    function atualizarResumoModal(data) {
        document.getElementById('resumo-total-itens').textContent = data.total_itens;
        document.getElementById('resumo-valor-total').textContent = `R$ ${data.totais.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('resumo-peso-total').textContent = `${Math.round(data.totais.peso).toLocaleString('pt-BR')} kg`;
        document.getElementById('resumo-selecionados').textContent = '0';
    }

    /**
     * üéØ AUTO-C√ÅLCULO CONFORME CARTEIRA.CSV
     * Atualiza c√°lculos de valor, peso e pallet quando quantidade √© alterada
     */
    function atualizarCalculosItem(input) {
        const qtd = parseFloat(input.value) || 0;
        const preco = parseFloat(input.getAttribute('data-preco')) || 0;
        const pesoUnitario = parseFloat(input.getAttribute('data-peso-unitario')) || 0;
        const palletUnitario = parseFloat(input.getAttribute('data-pallet-unitario')) || 0;
        const itemId = input.getAttribute('data-item-id');

        // Calcular valores
        const valorTotal = qtd * preco;
        const pesoTotal = qtd * pesoUnitario;
        const palletTotal = qtd * palletUnitario;

        // Atualizar span de valor na mesma linha
        const row = input.closest('tr');
        const valorSpan = row.querySelector('.valor-calculado');
        if (valorSpan) {
            valorSpan.textContent = `R$ ${valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Adicionar colunas de peso e pallet calculados se n√£o existirem
        if (!row.querySelector('.peso-calculado')) {
            const valorCell = row.querySelector('.valor-calculado').parentElement;

            // Adicionar c√©lula de peso
            const pesoCell = document.createElement('td');
            pesoCell.innerHTML = `<span class="peso-calculado">${Math.round(pesoTotal).toLocaleString('pt-BR')} kg</span>`;
            valorCell.insertAdjacentElement('afterend', pesoCell);

            // Adicionar c√©lula de pallet  
            const palletCell = document.createElement('td');
            palletCell.innerHTML = `<span class="pallet-calculado">${palletTotal.toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })} pal</span>`;
            pesoCell.insertAdjacentElement('afterend', palletCell);
        } else {
            // Atualizar c√©lulas existentes
            const pesoSpan = row.querySelector('.peso-calculado');
            const palletSpan = row.querySelector('.pallet-calculado');

            if (pesoSpan) {
                pesoSpan.textContent = `${Math.round(pesoTotal).toLocaleString('pt-BR')} kg`;
            }
            if (palletSpan) {
                palletSpan.textContent = `${palletTotal.toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })} pal`;
            }
        }

        console.log(`üßÆ Auto-c√°lculo item ${itemId}: Qtd ${qtd} ‚Üí Valor ${valorTotal.toFixed(2)} | Peso ${pesoTotal.toFixed(0)} | Pallet ${palletTotal.toFixed(1)}`);
    }

    /**
     * üóìÔ∏è MODAL AGENDAMENTO - FUN√á√ïES IMPLEMENTADAS
     * 
     * ‚úÖ OTIMIZA√á√ïES APLICADAS (CodeRabbit):
     * - Cache de inst√¢ncias de modal para evitar recria√ß√£o desnecess√°ria
     * - Uso de getOrCreateInstance() quando dispon√≠vel (Bootstrap 5.2+)
     * - Fallback para getInstance() para compatibilidade com vers√µes anteriores
     */
    function carregarDadosAgendamento(numPedido) {
        const modalLoading = document.getElementById('modal-agendamento-loading');
        const modalError = document.getElementById('modal-agendamento-error');
        const modalContent = document.getElementById('modal-agendamento-content');

        // Reset states
        modalLoading.style.display = 'block';
        modalError.style.display = 'none';
        modalContent.style.display = 'none';

        // Atualizar t√≠tulo
        document.getElementById('modal-agendamento-pedido').textContent = numPedido;
        document.getElementById('agendamento-num-pedido').value = numPedido;

        // Carregar dados via AJAX
        Promise.all([
            fetch(`/carteira/api/pedido/${numPedido}/itens`),
            fetch(`/carteira/api/pedido/${numPedido}/agendamento-existente`)
        ])
            .then(([responseItens, responseAgendamento]) => {
                return Promise.all([responseItens.json(), responseAgendamento.json()]);
            })
            .then(([dataItens, dataAgendamento]) => {
                if (dataItens.success) {
                    // Buscar informa√ß√µes do cliente (pegar do primeiro item)
                    const clienteInfo = dataItens.itens.length > 0 ? dataItens.itens[0] : null;

                    // Atualizar resumo com dados corretos
                    document.getElementById('agendamento-cliente').textContent =
                        clienteInfo ? (clienteInfo.raz_social_red || clienteInfo.raz_social || `Cliente do pedido ${numPedido}`) : 'N/A';
                    document.getElementById('agendamento-total-itens').textContent = dataItens.total_itens;
                    document.getElementById('agendamento-valor-total').textContent =
                        `R$ ${dataItens.totais.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    document.getElementById('agendamento-peso-total').textContent =
                        `${Math.round(dataItens.totais.peso).toLocaleString('pt-BR')} kg`;

                    // ‚úÖ PR√â-PREENCHER CAMPOS com dados existentes do agendamento
                    if (dataAgendamento.success && dataAgendamento.agendamento) {
                        const agend = dataAgendamento.agendamento;

                        // Data de agendamento
                        if (agend.data_agendamento) {
                            document.getElementById('data_agendamento').value = agend.data_agendamento;
                        }

                        // Hor√°rio
                        if (agend.hora_agendamento) {
                            document.getElementById('hora_agendamento').value = agend.hora_agendamento;
                        }

                        // Data de expedi√ß√£o 
                        if (agend.expedicao) {
                            document.getElementById('expedicao').value = agend.expedicao;
                        }

                        // Protocolo
                        if (agend.protocolo) {
                            document.getElementById('protocolo_agendamento').value = agend.protocolo;
                        }

                        // Observa√ß√µes
                        if (agend.observacoes) {
                            document.getElementById('observacoes_agendamento').value = agend.observacoes;
                        }

                        // Checkbox confirma√ß√£o
                        document.getElementById('agenda_confirmada').checked = agend.agenda_confirmada || false;

                        // ‚úÖ MOSTRAR BADGE DE STATUS
                        mostrarBadgeConfirmacao(agend.agenda_confirmada);
                    }

                    // Carregar itens na tabela  
                    gerarTabelaAgendamento(dataItens);

                    modalLoading.style.display = 'none';
                    modalContent.style.display = 'block';
                } else {
                    throw new Error(dataItens.error || 'Erro ao carregar dados');
                }
            })
            .catch(error => {
                console.error('Erro ao carregar agendamento:', error);
                document.getElementById('modal-agendamento-error-message').textContent = error.message;
                modalLoading.style.display = 'none';
                modalError.style.display = 'block';
            });
    }

    function gerarTabelaAgendamento(data) {
        const tbody = document.getElementById('agendamento-tbody-itens');
        let html = '';

        data.itens.forEach(item => {
            html += `
            <tr>
                <td><small><strong>${item.cod_produto}</strong></small></td>
                <td><small>${item.nome_produto || ''}</small></td>
                <td><strong>${item.qtd_saldo_formatado}</strong></td>
                <td><strong>${item.valor_item_formatado}</strong></td>
                <td>${item.peso_item_formatado}</td>
                <td>${item.pallet_item_formatado}</td>
            </tr>
        `;
        });

        tbody.innerHTML = html;
    }

    async function salvarAgendamento() {
        const form = document.getElementById('form-agendamento');
        const formData = new FormData(form);
        const numPedido = formData.get('num_pedido');

        // Validar campos obrigat√≥rios
        if (!formData.get('data_agendamento')) {
            alert('‚ö†Ô∏è Data do agendamento √© obrigat√≥ria');
            document.getElementById('data_agendamento').focus();
            return;
        }

        if (!numPedido) {
            alert('‚ö†Ô∏è N√∫mero do pedido n√£o encontrado');
            return;
        }

        // üîÑ IMPLEMENTA√á√ÉO REAL - CONECTAR √Ä API EXISTENTE
        const btnSalvar = document.querySelector('.modal-footer .btn-primary');
        const textoOriginal = btnSalvar.innerHTML;

        try {
            // Mostrar loading
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            btnSalvar.disabled = true;

            // 1. Buscar primeiro item do pedido para obter item_id
            console.log(`üóìÔ∏è Buscando itens do pedido ${numPedido} para agendamento...`);

            const responseItens = await fetch(`/carteira/api/pedido/${numPedido}/itens`);
            const dataItens = await responseItens.json();

            if (!responseItens.ok || !dataItens.success || !dataItens.itens.length) {
                throw new Error(`Erro ao buscar itens do pedido: ${dataItens.error || 'Pedido sem itens'}`);
            }

            // Pegar o primeiro item (ser√° usado para aplicar a todos)
            const primeiroItem = dataItens.itens[0];
            const itemId = primeiroItem.id;

            console.log(`üóìÔ∏è Usando item ${itemId} para aplicar agendamento a todo o pedido ${numPedido}`);

            // 2. Preparar dados para API agendamento existente
            const dadosAgendamento = {
                data_agendamento: formData.get('data_agendamento'),
                expedicao: formData.get('expedicao') || null, // ‚úÖ CORRE√á√ÉO: Usar expedicao para campo expedi√ß√£o
                hora_agendamento: formData.get('hora_agendamento') || null,
                protocolo: formData.get('protocolo') || null,
                observacoes: formData.get('observacoes') || null,
                agenda_confirmada: formData.get('agenda_confirmada') === 'on' || false,
                aplicar_todos: true // ‚úÖ SEMPRE aplicar a todos os itens do pedido
            };

            console.log('üóìÔ∏è Dados do agendamento:', dadosAgendamento);

            // 3. Chamar API real de agendamento
            const responseAgendamento = await fetch(`/carteira/item/${itemId}/agendamento`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify(dadosAgendamento)
            });

            const dataAgendamento = await responseAgendamento.json();

            if (!responseAgendamento.ok || !dataAgendamento.success) {
                throw new Error(dataAgendamento.error || 'Erro ao salvar agendamento');
            }

            // ‚úÖ SUCESSO
            console.log('‚úÖ Agendamento salvo com sucesso:', dataAgendamento);

            // Mostrar mensagem de sucesso
            alert(`‚úÖ ${dataAgendamento.message || 'Agendamento salvo com sucesso!'}`);

            // Fechar modal
            const modalElement = document.getElementById('modalAgendamento');
            // ‚úÖ OTIMIZA√á√ÉO: Usar getOrCreateInstance se dispon√≠vel (Bootstrap 5.2+), fallback para compatibilidade
            if (bootstrap.Modal.getOrCreateInstance) {
                bootstrap.Modal.getOrCreateInstance(modalElement).hide();
            } else {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            }

            // Recarregar p√°gina para mostrar mudan√ßas
            setTimeout(() => {
                location.reload();
            }, 1000);

        } catch (error) {
            console.error('‚ùå Erro ao salvar agendamento:', error);

            let mensagemErro = `‚ùå **ERRO AO SALVAR AGENDAMENTO**\n\n`;
            mensagemErro += `Detalhes: ${error.message}\n\n`;
            mensagemErro += `üìã Pedido: ${numPedido}\n`;
            mensagemErro += `üîß Verifique os dados e tente novamente.`;

            alert(mensagemErro);

        } finally {
            // Restaurar bot√£o
            btnSalvar.innerHTML = textoOriginal;
            btnSalvar.disabled = false;
        }
    }

    /**
     * üìä MODAL ESTOQUE D0/D7 - INTEGRA√á√ÉO REAL COM ESTOQUE.MODELS
     */
    async function carregarEstoqueD0D7(numPedido) {
        const modalLoading = document.getElementById('modal-estoque-loading');
        const modalContent = document.getElementById('modal-estoque-content');

        // Reset states
        modalLoading.style.display = 'block';
        modalContent.style.display = 'none';

        // Atualizar t√≠tulo
        document.getElementById('modal-estoque-pedido').textContent = numPedido;

        try {
            console.log(`üìä Carregando an√°lise REAL de estoque D0/D7 para pedido ${numPedido}...`);

            // Carregar dados reais via API
            const response = await fetch(`/carteira/api/pedido/${numPedido}/estoque-d0-d7`);
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const data = await response.json();
            console.log('üìä Dados de estoque recebidos:', data);

            if (!data.success) {
                throw new Error(data.error || 'Erro ao carregar dados de estoque');
            }

            // Atualizar resumo com dados reais
            document.getElementById('resumo-problemas-d0').textContent = data.resumo.problemas_d0 || 0;
            document.getElementById('resumo-problemas-d7').textContent = data.resumo.problemas_d7 || 0;
            document.getElementById('resumo-estoque-ok').textContent = data.resumo.estoque_ok || 0;

            // Gerar tabela com dados reais
            gerarTabelaEstoqueReal(data.itens || []);

            modalLoading.style.display = 'none';
            modalContent.style.display = 'block';

            console.log(`‚úÖ An√°lise de estoque carregada: ${data.itens?.length || 0} produtos analisados`);

        } catch (error) {
            console.error(`‚ùå Erro ao carregar estoque D0/D7 do pedido ${numPedido}:`, error);

            // Mostrar erro
            modalLoading.style.display = 'none';
            modalContent.innerHTML = `
            <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h5>Erro ao carregar an√°lise de estoque</h5>
                <p>${error.message}</p>
                <button class="btn btn-primary" onclick="carregarEstoqueD0D7('${numPedido}')">
                    <i class="fas fa-redo"></i> Tentar Novamente
                </button>
            </div>
        `;
            modalContent.style.display = 'block';
        }
    }

    function gerarTabelaEstoqueReal(itens) {
        const tbody = document.getElementById('estoque-tbody-itens');
        let html = '';

        if (!itens || itens.length === 0) {
            tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center p-4">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum dado de estoque encontrado</h5>
                    <p class="text-muted">Os produtos deste pedido n√£o possuem dados de estoque dispon√≠veis.</p>
                </td>
            </tr>
        `;
            return;
        }

        itens.forEach(item => {
            // Determinar status e classe CSS baseado nos dados reais
            let status = 'NORMAL';
            let statusClass = 'info';

            if (item.estoque_expedicao <= 0) {
                status = 'CR√çTICO - SEM ESTOQUE';
                statusClass = 'danger';
            } else if (item.estoque_expedicao < item.qtd_pedido) {
                status = 'INSUFICIENTE';
                statusClass = 'warning';
            } else if (item.estoque_d7 <= 0) {
                status = 'RUPTURA D7';
                statusClass = 'warning';
            } else {
                status = 'DISPON√çVEL';
                statusClass = 'success';
            }

            // Calcular percentual de disponibilidade
            const disponibilidade = item.qtd_pedido > 0 ?
                Math.round((Math.min(item.estoque_expedicao, item.qtd_pedido) / item.qtd_pedido) * 100) : 0;

            html += `
            <tr class="${statusClass === 'danger' ? 'table-danger' : statusClass === 'warning' ? 'table-warning' : ''}">
                <td><small><strong>${item.cod_produto}</strong></small></td>
                <td><small>${item.nome_produto || '-'}</small></td>
                <td><strong>${item.qtd_pedido.toLocaleString('pt-BR')}</strong></td>
                <td>
                    <strong class="${item.estoque_expedicao <= 0 ? 'text-danger' : item.estoque_expedicao < item.qtd_pedido ? 'text-warning' : 'text-success'}">
                        ${item.estoque_expedicao.toLocaleString('pt-BR')}
                    </strong>
                </td>
                <td>
                    <span class="${item.estoque_d7 <= 0 ? 'text-danger' : 'text-dark'}">
                        ${item.estoque_d7.toLocaleString('pt-BR')}
                    </span>
                </td>
                <td>
                    <span class="badge bg-${statusClass}" style="${statusClass === 'danger' ? 'background-color: #dc3545; color: white;' : statusClass === 'warning' ? 'background-color: #ffc107; color: black;' : statusClass === 'success' ? 'background-color: #28a745; color: white;' : 'background-color: #17a2b8; color: white;'}">
                        ${status}
                    </span>
                    <br><small class="text-muted">${disponibilidade}% dispon√≠vel</small>
                </td>
                <td>
                    <div class="btn-group-vertical btn-group-sm">
                        <!-- Bot√£o removido - verDetalhesEstoque n√£o implementado -->
                        ${item.estoque_expedicao < item.qtd_pedido ? `
                        <button class="btn btn-sm btn-outline-warning" onclick="sugerirAlternativa('${item.cod_produto}')" title="Sugerir alternativa">
                            <i class="fas fa-lightbulb"></i>
                        </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
        });

        tbody.innerHTML = html;
    }

    // Manter fun√ß√£o antiga para compatibilidade
    function gerarTabelaEstoque(itens) {
        gerarTabelaEstoqueReal(itens);
    }

    // Fun√ß√£o verDetalhesEstoque removida - apenas placeholder com TODO

    async function exportarAnaliseEstoque() {
        if (!numPedidoEstoque) {
            alert('‚ö†Ô∏è Nenhum pedido selecionado para an√°lise de estoque');
            return;
        }

        console.log(`üìä Exportando an√°lise de estoque para pedido ${numPedidoEstoque}...`);

        try {
            // Mostrar loading
            const response = await fetch(`/carteira/api/export-excel/estoque-analise/${numPedidoEstoque}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                }
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Erro ao gerar arquivo Excel');
            }

            // ‚úÖ SUCESSO - Mostrar resultado e for√ßar download
            console.log('‚úÖ An√°lise exportada com sucesso:', data);

            alert(`‚úÖ **AN√ÅLISE DE ESTOQUE EXPORTADA!**\n\nüìä Arquivo: ${data.filename}\nüì¶ Produtos analisados: ${data.total_produtos}\n\nüîÑ Download iniciando automaticamente...`);

            // For√ßar download do arquivo
            const link = document.createElement('a');
            link.href = data.url;
            link.download = data.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (error) {
            console.error('‚ùå Erro ao exportar an√°lise:', error);
            alert(`‚ùå **ERRO AO EXPORTAR AN√ÅLISE**\n\nDetalhes: ${error.message}\n\nüîß Verifique sua conex√£o e tente novamente.`);
        }
    }

    // Fun√ß√£o verDetalhesEstoque removida



    /**
     * Toggle todos os itens (selecionar/desselecionar todos)
     */
    function toggleTodosItens(masterCheckbox) {
        const checkboxes = document.querySelectorAll('.item-checkbox:not(:disabled)');
        checkboxes.forEach(checkbox => {
            checkbox.checked = masterCheckbox.checked;
        });
        calcularTotaisModal();
    }

    /**
     * Valida quantidade inserida (SEM CASAS DECIMAIS conforme regra)
     */
    function validarQuantidade(input) {
        const max = Math.round(parseFloat(input.getAttribute('data-max')));
        let value = parseFloat(input.value);

        if (isNaN(value) || value < 0) {
            input.value = '0';
            input.classList.add('is-invalid');
            return false;
        }

        // For√ßar n√∫mero inteiro (sem casa decimal)
        value = Math.round(value);
        input.value = value;

        if (value > max) {
            input.value = max;
            input.classList.add('is-invalid');
            alert(`Quantidade n√£o pode exceder ${max}`);
            return false;
        }

        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        return true;
    }

    /**
     * Calcula totais dos itens selecionados
     */
    function calcularTotaisModal() {
        let totalQtd = 0;
        let totalValor = 0;
        let countSelecionados = 0;

        const checkboxes = document.querySelectorAll('.item-checkbox:checked');

        checkboxes.forEach(checkbox => {
            const itemId = checkbox.getAttribute('data-item-id');
            const qtdInput = document.querySelector(`.qtd-input[data-item-id="${itemId}"]`);

            if (qtdInput) {
                const qtd = parseFloat(qtdInput.value) || 0;

                // Buscar pre√ßo do item nos dados
                if (dadosModalAtual) {
                    const item = dadosModalAtual.itens.find(i => i.id == itemId);
                    if (item) {
                        totalQtd += qtd;
                        totalValor += qtd * item.preco;
                        countSelecionados++;
                    }
                }
            }
        });

        // Atualizar interface (formata√ß√£o brasileira SEM casas decimais para qtd)
        document.getElementById('total-qtd-selecionada').textContent = Math.round(totalQtd).toLocaleString('pt-BR');
        document.getElementById('total-valor-selecionado').textContent = `R$ ${totalValor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('resumo-selecionados').textContent = countSelecionados;

        // Atualizar cor do badge
        const badge = document.getElementById('resumo-selecionados');
        badge.className = countSelecionados > 0 ? 'badge bg-success ml-2' : 'badge bg-warning ml-2';
    }

    /*
     * Fun√ß√£o salvarAvaliacoes removida - avalia√ß√µes devem ser autom√°ticas
     * C√≥digo comentado para refer√™ncia hist√≥rica
     */
    /*
    async function salvarAvaliacoes() {
        if (!numPedidoModal || !dadosModalAtual) {
            alert('Erro: Dados do modal n√£o carregados');
            return;
        }

        // üéØ ETAPA 2: VALIDA√á√ÉO DO TIPO DE ENVIO
        if (!validarEnvioParcial()) {
            return; // Valida√ß√£o falhou, n√£o continuar
        }

        // Coletar dados do formul√°rio
        const itensSelecionados = [];
        const checkboxes = document.querySelectorAll('.item-checkbox:checked');

        if (checkboxes.length === 0) {
            alert('‚ö†Ô∏è Selecione pelo menos um item para continuar');
            return;
        }

        checkboxes.forEach(checkbox => {
            const itemId = checkbox.getAttribute('data-item-id');
            const qtdInput = document.querySelector(`.qtd-input[data-item-id="${itemId}"]`);
            const expedicaoInput = document.querySelector(`input[data-item-id="${itemId}"][data-field="expedicao"]`);
            const agendamentoInput = document.querySelector(`input[data-item-id="${itemId}"][data-field="agendamento"]`);
            const protocoloInput = document.querySelector(`input[data-item-id="${itemId}"][data-field="protocolo"]`);

            if (qtdInput && validarQuantidade(qtdInput)) {
                itensSelecionados.push({
                    item_id: parseInt(itemId),
                    qtd_selecionada: parseFloat(qtdInput.value),
                    expedicao: expedicaoInput ? expedicaoInput.value : '',
                    agendamento: agendamentoInput ? agendamentoInput.value : '',
                    protocolo: protocoloInput ? protocoloInput.value : ''
                });
            }
        });

        if (itensSelecionados.length === 0) {
            alert('‚ö†Ô∏è Nenhum item v√°lido selecionado');
            return;
        }

        // üîÑ PROCESSAR VIA API
        const btnSalvar = document.getElementById('btn-salvar-avaliacoes');
        const textoOriginal = btnSalvar.innerHTML;

        try {
            // Mostrar loading
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
            btnSalvar.disabled = true;

            // üéØ ETAPA 2: COLETAR DADOS DO TIPO DE ENVIO
            const tipoEnvio = document.getElementById('tipo_envio').value;
            const configEnvioParcial = tipoEnvio === 'parcial' ? {
                motivo: document.getElementById('motivo_parcial').value,
                justificativa: document.getElementById('justificativa_parcial').value,
                previsao_complemento: document.getElementById('previsao_complemento').value,
                responsavel_aprovacao: document.getElementById('responsavel_aprovacao').value
            } : null;

            // Chamar API
            const response = await fetch(`/carteira/api/pedido/${numPedidoModal}/salvar-avaliacoes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({
                    itens: itensSelecionados,
                    tipo_envio: tipoEnvio,
                    config_envio_parcial: configEnvioParcial
                })
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Erro ao processar avalia√ß√µes');
            }

            // ‚úÖ SUCESSO
            console.log('‚úÖ Avalia√ß√µes salvas com sucesso:', data);

            // Mostrar resultados detalhados
            let mensagem = `üéâ **AVALIA√á√ïES PROCESSADAS COM SUCESSO!**\n\n`;
            mensagem += `üìä **Resumo:**\n`;
            mensagem += `‚Ä¢ Itens processados: ${data.processados}\n`;
            mensagem += `‚Ä¢ Sucessos: ${data.sucessos}\n`;
            mensagem += `‚Ä¢ Erros: ${data.erros}\n\n`;

            if (data.resultados && data.resultados.length > 0) {
                mensagem += `üìã **Detalhes:**\n`;
                data.resultados.forEach(resultado => {
                    if (resultado.status === 'sucesso') {
                        const icone = resultado.acao === 'dividido' ? '‚úÇÔ∏è' : '‚úÖ';
                        mensagem += `${icone} ${resultado.mensagem}\n`;
                    } else {
                        mensagem += `‚ùå Item ${resultado.item_id}: ${resultado.erro}\n`;
                    }
                });
            }

            alert(mensagem);

            // Fechar modal e recarregar dados
            $('#modalAvaliarItens').modal('hide');

            // Limpar cache para for√ßar reload
            itensPedidoCache.delete(numPedidoModal);

            // Recarregar dados da tabela principal
            setTimeout(() => {
                location.reload(); // Recarregar p√°gina para mostrar mudan√ßas
            }, 1000);

        } catch (error) {
            console.error('‚ùå Erro ao salvar avalia√ß√µes:', error);

            let mensagemErro = `‚ùå **ERRO AO PROCESSAR AVALIA√á√ïES**\n\n`;
            mensagemErro += `Detalhes: ${error.message}\n\n`;
            mensagemErro += `üìã Dados coletados: ${itensSelecionados.length} itens\n`;
            mensagemErro += `üîß Verifique os logs do sistema ou tente novamente.`;

            alert(mensagemErro);

        } finally {
            // Restaurar bot√£o
            btnSalvar.innerHTML = textoOriginal;
            btnSalvar.disabled = false;
        }
    }
    */

    /**
     * Recarrega dados do modal
     */
    function recarregarModalItens() {
        if (numPedidoModal) {
            // Remover do cache para for√ßar reload
            itensPedidoCache.delete(numPedidoModal);
            carregarDadosModal(numPedidoModal);
        }
    }


    // Vari√°veis globais para estoque
    let dadosEstoqueAtual = null;
    let numPedidoEstoque = null;

    /**
     * Carrega dados de estoque D0/D7 via API
     */
    async function carregarDadosEstoque(numPedido) {
        numPedidoEstoque = numPedido;

        const modalLoading = document.getElementById('modal-estoque-loading');
        const modalError = document.getElementById('modal-estoque-error');
        const modalContent = document.getElementById('modal-estoque-content');

        try {
            // Mostrar loading
            modalLoading.style.display = 'block';
            modalError.style.display = 'none';
            modalContent.style.display = 'none';

            // Fazer requisi√ß√£o AJAX
            const response = await fetch(`/carteira/api/pedido/${numPedido}/estoque-d0-d7`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Erro ao calcular estoque');
            }

            // Armazenar dados
            dadosEstoqueAtual = data;

            // Gerar HTML dos produtos
            gerarHtmlEstoqueProdutos(data);

            // Atualizar resumo
            atualizarResumoEstoque(data);

            // Mostrar conte√∫do
            modalLoading.style.display = 'none';
            modalContent.style.display = 'block';

            console.log(`‚úÖ Estoque D0/D7 carregado para pedido ${numPedido}: ${data.produtos.length} produtos`);

        } catch (error) {
            console.error(`‚ùå Erro ao carregar estoque D0/D7 do pedido ${numPedido}:`, error);

            // Mostrar erro
            document.getElementById('modal-estoque-error-message').textContent = error.message;
            modalLoading.style.display = 'none';
            modalError.style.display = 'block';
            modalContent.style.display = 'none';
        }
    }

    /**
     * Gera HTML da tabela de produtos com estoque
     */
    function gerarHtmlEstoqueProdutos(data) {
        const tbody = document.getElementById('tbody-estoque-produtos');
        let html = '';

        data.produtos.forEach(produto => {
            // Classes CSS para status
            const statusD0Class = getStatusClass(produto.status_d0);
            const statusD7Class = getStatusClass(produto.status_d7);

            // √çcone de sufici√™ncia
            const suficienteIcon = produto.tem_estoque_suficiente ?
                '<i class="fas fa-check text-success"></i>' :
                '<i class="fas fa-times text-danger"></i>';

            // Proje√ß√£o resumida
            const projecaoHtml = produto.projecao_resumo && produto.projecao_resumo.length > 0 ?
                produto.projecao_resumo.map(dia =>
                    `<span class="badge bg-${getStatusClass(dia.status)} badge-sm">${dia.data}</span>`
                ).join(' ') :
                '<small class="text-muted">Sem dados</small>';

            html += `
            <tr ${produto.status_d0 === 'RUPTURA' ? 'class="table-danger"' : produto.status_d0 === 'BAIXO' ? 'class="table-warning"' : ''}>
                <td><strong>${produto.cod_produto}</strong></td>
                <td><small>${produto.nome_produto}</small></td>
                <td><strong>${produto.qtd_pedido.toFixed(3)}</strong></td>
                <td>
                    <strong>${produto.estoque_expedicao.toFixed(3)}</strong>
                    ${produto.dia_ruptura === 0 ? '<br><small class="text-danger">Ruptura hoje!</small>' : ''}
                </td>
                <td>
                    <span class="badge bg-${statusD0Class}">
                        ${formatarStatus(produto.status_d0)}
                    </span>
                </td>
                <td>
                    <strong>${produto.menor_estoque_d7.toFixed(3)}</strong>
                    ${produto.dia_ruptura !== null && produto.dia_ruptura > 0 ?
                    `<br><small class="text-warning">Ruptura D${produto.dia_ruptura}</small>` : ''}
                </td>
                <td>
                    <span class="badge bg-${statusD7Class}">
                        ${formatarStatus(produto.status_d7)}
                    </span>
                </td>
                <td class="text-center">
                    ${suficienteIcon}
                    ${produto.tem_estoque_suficiente ?
                    '<br><small class="text-success">OK</small>' :
                    '<br><small class="text-danger">Insuficiente</small>'}
                </td>
                <td style="max-width: 200px;">
                    <div class="projecao-container" style="font-size: 0.8em;">
                        ${projecaoHtml}
                    </div>
                </td>
            </tr>
        `;
        });

        tbody.innerHTML = html;
    }

    /**
     * Atualiza resumo das estat√≠sticas de estoque
     */
    function atualizarResumoEstoque(data) {
        const stats = data.estatisticas;

        // Verificar elementos antes de atualizar
        const dataCalculo = document.getElementById('estoque-data-calculo');
        if (dataCalculo) dataCalculo.textContent = data.data_calculo;

        const totalProdutos = document.getElementById('resumo-total-produtos');
        if (totalProdutos) totalProdutos.textContent = stats.total_produtos;

        const rupturaD0 = document.getElementById('resumo-ruptura-d0');
        if (rupturaD0) rupturaD0.textContent = stats.produtos_ruptura_d0;

        const problemasD7 = document.getElementById('resumo-problemas-d7');
        if (problemasD7) problemasD7.textContent = stats.produtos_ruptura_d7;

        const menorEstoque = document.getElementById('resumo-menor-estoque');
        if (menorEstoque && stats.menor_estoque_geral !== undefined) {
            menorEstoque.textContent = stats.menor_estoque_geral.toFixed(3);
        }

        // Alerta de ruptura
        const alertaRuptura = document.getElementById('alerta-ruptura');
        if (alertaRuptura) {
            if (stats.dia_ruptura_mais_proximo !== null) {
                const diasRuptura = document.getElementById('dias-ruptura');
                if (diasRuptura) diasRuptura.textContent = stats.dia_ruptura_mais_proximo;
                alertaRuptura.style.display = 'block';
            } else {
                alertaRuptura.style.display = 'none';
            }
        }
    }

    /**
     * Mapeia status para classes CSS do Bootstrap
     */
    function getStatusClass(status) {
        switch (status) {
            case 'NORMAL': return 'success';
            case 'BAIXO':
            case 'BAIXO_PREVISTO': return 'warning';
            case 'RUPTURA':
            case 'RUPTURA_PREVISTA': return 'danger';
            case 'SEM_DADOS': return 'secondary';
            default: return 'secondary';
        }
    }

    /**
     * Formata status para exibi√ß√£o
     */
    function formatarStatus(status) {
        switch (status) {
            case 'NORMAL': return 'Normal';
            case 'BAIXO': return 'Baixo';
            case 'BAIXO_PREVISTO': return 'Baixo Prev.';
            case 'RUPTURA': return 'Ruptura';
            case 'RUPTURA_PREVISTA': return 'Ruptura Prev.';
            case 'SEM_DADOS': return 'Sem Dados';
            default: return status;
        }
    }

    /**
     * Recarrega modal de estoque
     */
    function recarregarModalEstoque() {
        if (numPedidoEstoque) {
            carregarDadosEstoque(numPedidoEstoque);
        }
    }

    // üóëÔ∏è FUN√á√ÉO √ìRF√É REMOVIDA: exportarDadosEstoque()
    // Esta fun√ß√£o nunca era chamada (sem bot√µes ou eventos associados)
    // Funcionalidade de exporta√ß√£o j√° est√° dispon√≠vel via exportarAnaliseEstoque()

    /**
     * Consulta separa√ß√µes de um pedido
     * Implementa√ß√£o: Fase 3.1 - Query Separa√ß√µes por Pedido
     */
    async function consultarSeparacoes(numPedido) {
        // Configurar modal
        document.getElementById('modal-separacoes-pedido').textContent = numPedido;

        // Mostrar modal
        $('#modalConsultarSeparacoes').modal('show');

        // Carregar dados
        await carregarSeparacoesPedido(numPedido);
    }

    // Vari√°veis globais para separa√ß√µes
    let dadosSeparacoesAtual = null;
    let numPedidoSeparacoes = null;

    /**
     * Carrega separa√ß√µes de um pedido via API
     */
    async function carregarSeparacoesPedido(numPedido) {
        numPedidoSeparacoes = numPedido;

        const modalLoading = document.getElementById('modal-separacoes-loading');
        const modalError = document.getElementById('modal-separacoes-error');
        const modalEmpty = document.getElementById('modal-separacoes-empty');
        const modalContent = document.getElementById('modal-separacoes-content');

        try {
            // Mostrar loading
            modalLoading.style.display = 'block';
            modalError.style.display = 'none';
            modalEmpty.style.display = 'none';
            modalContent.style.display = 'none';

            // Fazer requisi√ß√£o AJAX
            const response = await fetch(`/carteira/api/pedido/${numPedido}/separacoes`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Erro ao carregar separa√ß√µes');
            }

            // Armazenar dados
            dadosSeparacoesAtual = data;

            // Verificar se tem separa√ß√µes
            if (data.total_separacoes === 0) {
                modalLoading.style.display = 'none';
                modalEmpty.style.display = 'block';
                return;
            }

            // Gerar HTML das separa√ß√µes
            gerarHtmlSeparacoes(data);

            // Atualizar resumo
            atualizarResumoSeparacoes(data);

            // Mostrar conte√∫do
            modalLoading.style.display = 'none';
            modalContent.style.display = 'block';

            console.log(`‚úÖ Separa√ß√µes carregadas para pedido ${numPedido}: ${data.total_separacoes} separa√ß√µes`);

        } catch (error) {
            console.error(`‚ùå Erro ao carregar separa√ß√µes do pedido ${numPedido}:`, error);

            // Mostrar erro
            document.getElementById('modal-separacoes-error-message').textContent = error.message;
            modalLoading.style.display = 'none';
            modalError.style.display = 'block';
            modalContent.style.display = 'none';
        }
    }

    /**
     * Gera HTML da tabela de separa√ß√µes
     */
    // ‚ùå FUN√á√ÉO DUPLICADA REMOVIDA - causava "undefined" nos dropdowns

    /**
     * Atualiza resumo das separa√ß√µes
     */
    function atualizarResumoSeparacoes(data) {
        document.getElementById('resumo-total-separacoes').textContent = data.total_separacoes;
        document.getElementById('resumo-separacoes-embarcadas').textContent = data.separacoes_embarcadas;
        document.getElementById('resumo-separacoes-pendentes').textContent = data.separacoes_pendentes;
    }

    /**
     * Recarrega modal de separa√ß√µes
     */
    function recarregarModalSeparacoes() {
        if (numPedidoSeparacoes) {
            carregarSeparacoesPedido(numPedidoSeparacoes);
        }
    }

    /**
     * üîß P2.1: Ver detalhes completos de uma separa√ß√£o (IMPLEMENTA√á√ÉO REAL)
     */
    async function verDetalhesSeparacao(loteId) {
        console.log(`üìä Carregando detalhes da separa√ß√£o: ${loteId}`);

        try {
            // Mostrar loading
            const response = await fetch(`/carteira/api/separacao/${loteId}/detalhes`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                }
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Erro ao carregar detalhes da separa√ß√£o');
            }

            // ‚úÖ SUCESSO - Mostrar detalhes em modal ou alert detalhado
            const separacao = data.separacao;
            const cabecalho = separacao.cabecalho;
            const totais = separacao.totais;
            const status = separacao.status;

            const detalhesTexto = `
üìä **DETALHES DA SEPARA√á√ÉO**

üè∑Ô∏è **IDENTIFICA√á√ÉO:**
   ‚Ä¢ Lote: ${cabecalho.lote_id}
   ‚Ä¢ Pedido: ${cabecalho.num_pedido}
   ‚Ä¢ Data Pedido: ${cabecalho.data_pedido}

üë§ **CLIENTE:**
   ‚Ä¢ ${cabecalho.raz_social_red}
   ‚Ä¢ CNPJ/CPF: ${cabecalho.cnpj_cpf}
   ‚Ä¢ Cidade: ${cabecalho.nome_cidade} - ${cabecalho.cod_uf}

üì¶ **TOTAIS:**
   ‚Ä¢ Produtos: ${totais.produtos}
   ‚Ä¢ Quantidade: ${totais.quantidade.toLocaleString('pt-BR')}
   ‚Ä¢ Valor: R$ ${totais.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
   ‚Ä¢ Peso: ${totais.peso.toLocaleString('pt-BR')} kg
   ‚Ä¢ Pallets: ${totais.pallet.toLocaleString('pt-BR', { minimumFractionDigits: 1 })}

üîó **STATUS:**
   ‚Ä¢ Pedido: ${status.pedido_vinculado ? `Vinculado (${status.pedido_status})` : 'N√£o vinculado'}
   ‚Ä¢ Embarque: ${status.embarque_vinculado ? `Vinculado (#${status.embarque_numero})` : 'N√£o vinculado'}
   ‚Ä¢ Pode editar: ${status.pode_editar ? 'Sim' : 'N√£o'}

üõ§Ô∏è **ROTA:**
   ‚Ä¢ Rota: ${cabecalho.rota || 'N/A'}
   ‚Ä¢ Sub-rota: ${cabecalho.sub_rota || 'N/A'}`;

            alert(detalhesTexto);

            // Log para debugging
            console.log('‚úÖ Detalhes da separa√ß√£o carregados:', data);

        } catch (error) {
            console.error('‚ùå Erro ao carregar detalhes:', error);
            alert(`‚ùå **ERRO AO CARREGAR DETALHES**\n\nSepara√ß√£o: ${loteId}\nDetalhes: ${error.message}\n\nüîß Verifique se a separa√ß√£o existe.`);
        }
    }

    /**
     * üîß P2.1: Editar dados de uma separa√ß√£o (IMPLEMENTA√á√ÉO REAL)
     * Conecta √† API /api/separacao/<lote_id>/editar
     */
    async function editarSeparacao(loteId) {
        console.log(`‚úèÔ∏è Editando separa√ß√£o: ${loteId}`);

        try {
            // 1. Primeiro carregar dados atuais da separa√ß√£o
            const responseDetalhes = await fetch(`/carteira/api/separacao/${loteId}/detalhes`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                }
            });

            const dataDetalhes = await responseDetalhes.json();

            if (!responseDetalhes.ok || !dataDetalhes.success) {
                throw new Error('N√£o foi poss√≠vel carregar dados da separa√ß√£o');
            }

            const separacao = dataDetalhes.separacao;
            const status = separacao.status;

            // 2. Verificar se pode editar
            if (!status.pode_editar) {
                alert(`‚ö†Ô∏è **N√ÉO √â POSS√çVEL EDITAR**\n\nA separa√ß√£o ${loteId} n√£o pode ser editada.\n\nStatus do pedido: ${status.pedido_status || 'Desconhecido'}\n\nüí° Apenas separa√ß√µes de pedidos ABERTOS ou COTADOS podem ser editadas.`);
                return;
            }

            // 3. Obter dados atuais para pr√©-preenchimento
            const produto = separacao.produtos[0] || {}; // Usar primeiro produto como refer√™ncia

            // 4. Prompt para edi√ß√£o com campos mais comuns
            const novaExpedicao = prompt(`üìÖ **EDITAR EXPEDI√á√ÉO**\n\nSepara√ß√£o: ${loteId}\nExpedi√ß√£o atual: ${produto.expedicao || 'N√£o definida'}\n\nNova data de expedi√ß√£o (dd/mm/yyyy):\n(Deixe vazio para n√£o alterar)`, produto.expedicao || '');

            // Cancelou a edi√ß√£o
            if (novaExpedicao === null) {
                return;
            }

            const novoAgendamento = prompt(`üìÖ **EDITAR AGENDAMENTO**\n\nSepara√ß√£o: ${loteId}\nAgendamento atual: ${produto.agendamento || 'N√£o definido'}\n\nNova data de agendamento (dd/mm/yyyy):\n(Deixe vazio para n√£o alterar)`, produto.agendamento || '');

            if (novoAgendamento === null) {
                return;
            }

            const novoProtocolo = prompt(`üìã **EDITAR PROTOCOLO**\n\nSepara√ß√£o: ${loteId}\nProtocolo atual: ${produto.protocolo || 'N√£o definido'}\n\nNovo protocolo:\n(Deixe vazio para n√£o alterar)`, produto.protocolo || '');

            if (novoProtocolo === null) {
                return;
            }

            const novasObservacoes = prompt(`üí¨ **EDITAR OBSERVA√á√ïES**\n\nSepara√ß√£o: ${loteId}\nObserva√ß√µes atuais: ${produto.observ_ped_1 || 'Nenhuma'}\n\nNovas observa√ß√µes:\n(Deixe vazio para n√£o alterar)`, produto.observ_ped_1 || '');

            if (novasObservacoes === null) {
                return;
            }

            // 5. Preparar dados para envio (apenas campos preenchidos)
            const dadosEdicao = {};

            if (novaExpedicao && novaExpedicao.trim()) {
                dadosEdicao.expedicao = novaExpedicao.trim();
            }

            if (novoAgendamento && novoAgendamento.trim()) {
                dadosEdicao.agendamento = novoAgendamento.trim();
            }

            if (novoProtocolo && novoProtocolo.trim()) {
                dadosEdicao.protocolo = novoProtocolo.trim();
            }

            if (novasObservacoes && novasObservacoes.trim()) {
                dadosEdicao.observ_ped_1 = novasObservacoes.trim();
            }

            // 6. Verificar se h√° alguma altera√ß√£o
            if (Object.keys(dadosEdicao).length === 0) {
                alert('‚ÑπÔ∏è **NENHUMA ALTERA√á√ÉO**\n\nNenhum campo foi modificado.\n\nEdi√ß√£o cancelada.');
                return;
            }

            // 7. Enviar altera√ß√µes para API
            const responseEdicao = await fetch(`/carteira/api/separacao/${loteId}/editar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify(dadosEdicao)
            });

            const dataEdicao = await responseEdicao.json();

            if (!responseEdicao.ok || !dataEdicao.success) {
                throw new Error(dataEdicao.error || 'Erro ao salvar altera√ß√µes');
            }

            // ‚úÖ SUCESSO
            console.log('‚úÖ Separa√ß√£o editada com sucesso:', dataEdicao);

            let mensagemSucesso = `‚úÖ **SEPARA√á√ÉO ATUALIZADA!**\n\nSepara√ß√£o: ${loteId}\nProdutos afetados: ${dataEdicao.total_produtos}`;

            if (dataEdicao.alteracoes && dataEdicao.alteracoes.length > 0) {
                mensagemSucesso += `\n\nüìù **ALTERA√á√ïES:**\n${dataEdicao.alteracoes.map(alt => `‚Ä¢ ${alt}`).join('\n')}`;
            }

            mensagemSucesso += '\n\nüîÑ A p√°gina ser√° recarregada para mostrar as altera√ß√µes.';

            alert(mensagemSucesso);

            // Recarregar dados da p√°gina para mostrar altera√ß√µes
            location.reload();

        } catch (error) {
            console.error('‚ùå Erro ao editar separa√ß√£o:', error);
            alert(`‚ùå **ERRO AO EDITAR SEPARA√á√ÉO**\n\nSepara√ß√£o: ${loteId}\nDetalhes: ${error.message}\n\nüîß Verifique os dados e tente novamente.`);
        }
    }

    /**
     * üéØ ETAPA 2: FUN√á√ÉO DROPDOWN TIPO DE ENVIO (IMPLEMENTADA)
     * Controla exibi√ß√£o de campos baseado no tipo de envio selecionado
     */
    function atualizarTipoEnvio() {
        const tipoEnvio = document.getElementById('tipo_envio').value;
        const explicacaoTotal = document.getElementById('explicacao_total');
        const explicacaoParcial = document.getElementById('explicacao_parcial');
        const camposParcial = document.getElementById('campos_envio_parcial');

        if (tipoEnvio === 'parcial') {
            // Mostrar configura√ß√µes para envio parcial
            explicacaoTotal.style.display = 'none';
            explicacaoParcial.style.display = 'block';
            camposParcial.style.display = 'block';

            // Tornar campos obrigat√≥rios
            document.getElementById('motivo_parcial').required = true;
            document.getElementById('justificativa_parcial').required = true;

            console.log('üéØ Modo Envio Parcial ativado - campos espec√≠ficos exibidos');

            // Atualizar instru√ß√µes
            const instrucoes = document.querySelector('.alert-info ul');
            if (instrucoes && !instrucoes.innerHTML.includes('envio parcial')) {
                const novaInstrucao = document.createElement('li');
                novaInstrucao.innerHTML = 'üî¥ <strong>Envio Parcial:</strong> Configure motivo e justificativa nos campos acima';
                novaInstrucao.style.color = '#dc3545';
                instrucoes.appendChild(novaInstrucao);
            }

        } else {
            // Mostrar configura√ß√µes para envio total
            explicacaoTotal.style.display = 'block';
            explicacaoParcial.style.display = 'none';
            camposParcial.style.display = 'none';

            // Remover obrigatoriedade
            document.getElementById('motivo_parcial').required = false;
            document.getElementById('justificativa_parcial').required = false;

            // Limpar campos de envio parcial
            document.getElementById('motivo_parcial').value = '';
            document.getElementById('justificativa_parcial').value = '';
            document.getElementById('previsao_complemento').value = '';

            console.log('üì¶ Modo Envio Total ativado - interface simplificada');

            // Remover instru√ß√£o espec√≠fica do parcial
            const instrucoes = document.querySelector('.alert-info ul');
            if (instrucoes) {
                const instrucoesList = instrucoes.querySelectorAll('li');
                instrucoesList.forEach(li => {
                    if (li.innerHTML.includes('Envio Parcial')) {
                        li.remove();
                    }
                });
            }
        }

        // Recalcular totais se necess√°rio
        if (typeof calcularTotaisModal === 'function') {
            calcularTotaisModal();
        }
    }

    /**
     * üéØ VALIDA√á√ÉO ESPEC√çFICA PARA ENVIO PARCIAL
     * Valida se campos obrigat√≥rios est√£o preenchidos
     */
    function validarEnvioParcial() {
        const tipoEnvio = document.getElementById('tipo_envio').value;

        if (tipoEnvio === 'parcial') {
            const motivo = document.getElementById('motivo_parcial').value;
            const justificativa = document.getElementById('justificativa_parcial').value.trim();

            if (!motivo) {
                alert('‚ùå Selecione o motivo do envio parcial');
                document.getElementById('motivo_parcial').focus();
                return false;
            }

            if (!justificativa) {
                alert('‚ùå Preencha a justificativa detalhada do envio parcial');
                document.getElementById('justificativa_parcial').focus();
                return false;
            }

            if (justificativa.length < 10) {
                alert('‚ùå Justificativa deve ter pelo menos 10 caracteres');
                document.getElementById('justificativa_parcial').focus();
                return false;
            }

            console.log('‚úÖ Valida√ß√£o envio parcial aprovada:', { motivo, justificativa });
        }

        return true;
    }

    /**
     * üîß FUN√á√ïES DOS BOT√ïES - IMPLEMENTADAS
     */
    function criarSeparacao(numPedido) {
        console.log(`üì¶ Criar Separa√ß√£o pedido ${numPedido}`);

        // Abrir modal espec√≠fico de criar separa√ß√£o
        const modalElement = document.getElementById('modalCriarSeparacao');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            // Carregar itens do pedido
            carregarItensParaSeparacao(numPedido);
        } else {
            console.error('Modal modalCriarSeparacao n√£o encontrado');
        }
    }

    async function carregarItensParaSeparacao(numPedido) {
        console.log(`üìã Carregando itens para separa√ß√£o do pedido ${numPedido}`);

        try {
            const response = await fetch(`/carteira/api/pedido/${numPedido}/itens-editaveis`);
            const data = await response.json();

            if (data.success && data.itens) {
                gerarTabelaItensSeparacao(data.itens, numPedido);
            } else {
                console.error('Erro ao carregar itens:', data.error);
            }
        } catch (error) {
            console.error('Erro na requisi√ß√£o:', error);
        }
    }

    function gerarTabelaItensSeparacao(itens, numPedido) {
        const tbody = document.getElementById('tabelaItensSeparacao');
        if (!tbody) return;

        let html = '';
        itens.forEach(item => {
            const qtdDisponivel = item.qtd_saldo_disponivel || 0;
            const dataExpedicao = item.expedicao || '';

            html += `
            <tr data-item-id="${item.id}">
                <td>
                    <input type="checkbox" class="item-checkbox" ${qtdDisponivel > 0 ? '' : 'disabled'}>
                </td>
                <td><strong>${item.cod_produto}</strong></td>
                <td class="text-truncate" style="max-width: 200px;" title="${item.nome_produto}">
                    ${item.nome_produto}
                </td>
                <td class="text-center">
                    <span class="${qtdDisponivel > 0 ? 'text-success' : 'text-danger'}">
                        ${qtdDisponivel.toLocaleString('pt-BR')}
                    </span>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm qtd-separar" 
                           value="${qtdDisponivel}" 
                           min="0" max="${qtdDisponivel}"
                           ${qtdDisponivel <= 0 ? 'disabled' : ''}>
                </td>
                <td>
                    <small class="text-muted">${dataExpedicao || '-'}</small>
                </td>
            </tr>
        `;
        });

        tbody.innerHTML = html;

        // Armazenar dados globalmente
        window.pedidoAtualSeparacao = numPedido;
        window.itensPedidoSeparacao = itens;
    }

    function toggleTodosItensSeparacao(masterCheckbox) {
        const checkboxes = document.querySelectorAll('#tabelaItensSeparacao .item-checkbox:not(:disabled)');
        checkboxes.forEach(checkbox => {
            checkbox.checked = masterCheckbox.checked;
        });
    }

    async function confirmarCriacaoSeparacao() {
        const numPedido = window.pedidoAtualSeparacao;
        if (!numPedido) {
            alert('Erro: Pedido n√£o identificado');
            return;
        }

        // Coletar itens selecionados
        const itensSelecionados = [];
        const rows = document.querySelectorAll('#tabelaItensSeparacao tr[data-item-id]');

        rows.forEach(row => {
            const checkbox = row.querySelector('.item-checkbox');
            const qtdInput = row.querySelector('.qtd-separar');

            if (checkbox && checkbox.checked) {
                const itemId = row.getAttribute('data-item-id');
                const qtdSeparar = parseFloat(qtdInput.value) || 0;

                if (qtdSeparar > 0) {
                    itensSelecionados.push({
                        item_id: itemId,
                        qtd_selecionada: qtdSeparar
                    });
                }
            }
        });

        if (itensSelecionados.length === 0) {
            alert('Selecione pelo menos um item para criar a separa√ß√£o');
            return;
        }

        try {
            const response = await fetch(`/carteira/api/pedido/${numPedido}/criar-separacao`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    itens: itensSelecionados,
                    tipo_envio: 'total'
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('Separa√ß√£o criada com sucesso!');

                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalCriarSeparacao'));
                if (modal) modal.hide();

                // Recarregar a p√°gina
                window.location.reload();
            } else {
                alert('Erro ao criar separa√ß√£o: ' + (data.error || 'Erro desconhecido'));
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao criar separa√ß√£o');
        }
    }

    /**
     * Carrega itens da carteira + PreSeparacaoItem agrupadas para o modal de separa√ß√£o
     */
    async function carregarItensEPreSeparacoes(numPedido) {
        const modalLoading = document.getElementById('modal-loading');
        const modalError = document.getElementById('modal-error');
        const modalContent = document.getElementById('modal-content');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const modalNumPedido = document.getElementById('modal-num-pedido-estoques');

        // Mostrar loading
        modalLoading.style.display = 'block';
        modalError.style.display = 'none';
        modalContent.style.display = 'none';
        modalNumPedido.textContent = numPedido;

        try {
            // Carregar itens da carteira em paralelo com pr√©-separa√ß√µes agrupadas
            const [itensResponse, preseparacoesResponse] = await Promise.all([
                fetch(`/carteira/api/pedido/${numPedido}/itens-editaveis`),
                fetch(`/carteira/api/pedido/${numPedido}/pre-separacoes-agrupadas`)
            ]);

            const [itensData, preseparacoesData] = await Promise.all([
                itensResponse.json(),
                preseparacoesResponse.json()
            ]);

            if (!itensData.success) {
                throw new Error(itensData.error || 'Erro ao carregar itens');
            }

            if (!preseparacoesData.success) {
                throw new Error(preseparacoesData.error || 'Erro ao carregar pr√©-separa√ß√µes');
            }

            // Ocultar loading
            modalLoading.style.display = 'none';

            // Gerar HTML dos itens da carteira
            gerarHtmlItensModal(itensData);

            // Se h√° pr√©-separa√ß√µes agrupadas, adicionar se√ß√£o espec√≠fica
            if (preseparacoesData.agrupamentos && preseparacoesData.agrupamentos.length > 0) {
                adicionarSecaoPreSeparacoesAgrupadas(preseparacoesData.agrupamentos, numPedido);
            }

            // Mostrar conte√∫do
            modalContent.style.display = 'block';

            // Calcular totais iniciais
            calcularTotaisModal();

        } catch (error) {
            console.error('Erro ao carregar dados para separa√ß√£o:', error);
            modalLoading.style.display = 'none';
            modalError.style.display = 'block';
            modalErrorMessage.textContent = error.message;
        }
    }

    /**
     * Adiciona se√ß√£o de pr√©-separa√ß√µes agrupadas ao modal
     */
    function adicionarSecaoPreSeparacoesAgrupadas(agrupamentos, numPedido) {
        const modalContent = document.getElementById('modal-content');

        // Criar se√ß√£o de pr√©-separa√ß√µes agrupadas
        const secaoPreSeparacoes = document.createElement('div');
        secaoPreSeparacoes.className = 'mt-4';
        secaoPreSeparacoes.innerHTML = `
        <hr>
        <h6 class="text-warning">
            <i class="fas fa-layer-group"></i> 
            Pr√©-Separa√ß√µes Agrupadas (${agrupamentos.length})
            <small class="text-muted">- Por expedi√ß√£o, agendamento e protocolo</small>
        </h6>
        
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Como funciona:</strong> Selecione os agrupamentos desejados. 
            Cada agrupamento ser√° convertido em <strong>1 separa√ß√£o</strong> contendo todos os produtos do grupo.
        </div>
        
        <div class="table-responsive">
            <table class="table table-sm table-striped" id="tabela-agrupamentos">
                <thead class="thead-dark">
                    <tr>
                        <th width="40">
                            <input type="checkbox" id="select-all-agrupamentos" onchange="toggleTodosAgrupamentos(this)">
                        </th>
                        <th>Agrupamento</th>
                        <th>Produtos</th>
                        <th>Qtd Total</th>
                        <th>Valor Total</th>
                        <th>Peso Total</th>
                        <th>Pallet Total</th>
                        <th>Detalhes</th>
                    </tr>
                </thead>
                <tbody id="tbody-agrupamentos">
                </tbody>
            </table>
        </div>
        
        <div class="text-center mt-3">
            <button type="button" 
                    class="btn btn-warning btn-lg" 
                    onclick="enviarAgrupamentosParaSeparacao('${numPedido}')"
                    id="btn-enviar-agrupamentos">
                <i class="fas fa-paper-plane"></i> 
                Criar Separa√ß√µes dos Agrupamentos Selecionados
            </button>
        </div>
    `;

        // Inserir ap√≥s o conte√∫do principal
        modalContent.appendChild(secaoPreSeparacoes);

        // Preencher tabela de agrupamentos
        const tbody = document.getElementById('tbody-agrupamentos');
        let html = '';

        agrupamentos.forEach((agrup, index) => {
            const preSeraracaoIds = agrup.pre_separacoes.map(ps => ps.id).join(',');

            html += `
            <tr id="row-agrupamento-${agrup.id_agrupamento}">
                <td>
                    <input type="checkbox" 
                           class="agrupamento-checkbox" 
                           data-agrupamento-id="${agrup.id_agrupamento}"
                           data-pre-separacao-ids="${preSeraracaoIds}"
                           data-descricao="${agrup.descricao}"
                           onchange="atualizarContadorAgrupamentos()">
                </td>
                <td>
                    <strong>${agrup.descricao}</strong>
                    <br>
                    <small class="text-muted">
                        ${agrup.total_pre_separacoes} pr√©-separa√ß√£o(√µes)
                    </small>
                </td>
                <td>
                    <strong>${agrup.total_produtos}</strong> produto(s)
                    <br>
                    <small class="text-muted">
                        ${agrup.produtos.map(p => p.cod_produto).join(', ')}
                    </small>
                </td>
                <td><strong>${agrup.total_quantidade.toFixed(0)}</strong></td>
                <td><strong>${agrup.total_valor_formatado}</strong></td>
                <td><strong>${agrup.total_peso_formatado}</strong></td>
                <td><strong>${agrup.total_pallet_formatado}</strong></td>
                <td>
                    <button type="button" 
                            class="btn btn-sm btn-outline-info" 
                            onclick="mostrarDetalhesAgrupamento('${agrup.id_agrupamento}')"
                            title="Ver produtos do agrupamento">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
        });

        tbody.innerHTML = html;

        // Armazenar dados dos agrupamentos globalmente
        window.agrupamentosData = agrupamentos;
    }

    /**
     * Toggle todos os agrupamentos
     */
    function toggleTodosAgrupamentos(checkbox) {
        const checkboxes = document.querySelectorAll('.agrupamento-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = checkbox.checked;
        });
        atualizarContadorAgrupamentos();
    }

    /**
     * Atualiza contador de agrupamentos selecionados
     */
    function atualizarContadorAgrupamentos() {
        const checkboxes = document.querySelectorAll('.agrupamento-checkbox:checked');
        const btnEnviar = document.getElementById('btn-enviar-agrupamentos');

        if (btnEnviar) {
            if (checkboxes.length > 0) {
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = `<i class="fas fa-paper-plane"></i> Criar ${checkboxes.length} Separa√ß√£o(√µes)`;
            } else {
                btnEnviar.disabled = true;
                btnEnviar.innerHTML = '<i class="fas fa-paper-plane"></i> Criar Separa√ß√µes dos Agrupamentos Selecionados';
            }
        }
    }

    /**
     * Mostra detalhes de um agrupamento
     */
    function mostrarDetalhesAgrupamento(agrupamentoId) {
        if (!window.agrupamentosData) {
            alert('Dados n√£o carregados');
            return;
        }

        const agrupamento = window.agrupamentosData.find(a => a.id_agrupamento === agrupamentoId);
        if (!agrupamento) {
            alert('Agrupamento n√£o encontrado');
            return;
        }

        let detalhes = `üìã DETALHES DO AGRUPAMENTO\n\n`;
        detalhes += `${agrupamento.descricao}\n\n`;
        detalhes += `üìä RESUMO:\n`;
        detalhes += `‚Ä¢ ${agrupamento.total_produtos} produto(s)\n`;
        detalhes += `‚Ä¢ ${agrupamento.total_pre_separacoes} pr√©-separa√ß√£o(√µes)\n`;
        detalhes += `‚Ä¢ Total: ${agrupamento.total_valor_formatado}\n\n`;
        detalhes += `üõçÔ∏è PRODUTOS:\n`;

        agrupamento.pre_separacoes.forEach((ps, i) => {
            detalhes += `${i + 1}. ${ps.cod_produto} - ${ps.nome_produto}\n`;
            detalhes += `   Qtd: ${ps.quantidade} | Status: ${ps.status}\n`;
            if (ps.criado_em) {
                detalhes += `   Criado: ${ps.criado_em}\n`;
            }
            detalhes += `\n`;
        });

        alert(detalhes);
    }

    /**
     * Envia agrupamentos selecionados para separa√ß√£o
     */
    async function enviarAgrupamentosParaSeparacao(numPedido) {
        const checkboxes = document.querySelectorAll('.agrupamento-checkbox:checked');

        if (checkboxes.length === 0) {
            alert('‚ö†Ô∏è Selecione pelo menos um agrupamento');
            return;
        }

        const observacoes = prompt(`üìù Observa√ß√µes para as ${checkboxes.length} separa√ß√£o(√µes) (opcional):`) || '';

        if (!confirm(`Confirma a cria√ß√£o de ${checkboxes.length} separa√ß√£o(√µes)?`)) {
            return;
        }

        const btnEnviar = document.getElementById('btn-enviar-agrupamentos');
        btnEnviar.disabled = true;
        btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

        try {
            // Montar dados dos agrupamentos selecionados
            const agrupamentosSelecionados = [];

            checkboxes.forEach(checkbox => {
                const agrupamentoId = checkbox.getAttribute('data-agrupamento-id');
                const preSeracaoIds = checkbox.getAttribute('data-pre-separacao-ids').split(',').map(id => parseInt(id));
                const descricao = checkbox.getAttribute('data-descricao');

                agrupamentosSelecionados.push({
                    agrupamento_id: agrupamentoId,
                    pre_separacao_ids: preSeracaoIds,
                    descricao: descricao
                });
            });

            // Enviar para API
            const response = await fetch('/carteira/api/agrupamentos/enviar-separacao', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    agrupamentos: agrupamentosSelecionados,
                    observacoes: observacoes
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification(`${data.message}`, 'success');

                // Mostrar detalhes das separa√ß√µes criadas
                let detalhes = '‚úÖ SEPARA√á√ïES CRIADAS:\n\n';
                data.separacoes_criadas.forEach((sep, i) => {
                    detalhes += `${i + 1}. Lote: ${sep.lote_id}\n`;
                    detalhes += `   Itens: ${sep.total_itens}\n`;
                    detalhes += `   Grupo: ${sep.descricao}\n\n`;
                });

                alert(detalhes);

                // Fechar modal
                // Fechar modal (Bootstrap 5)
                const modalElement = document.getElementById('modalAvaliarEstoques');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) modal.hide();
                }

                // Recarregar p√°gina para refletir altera√ß√µes
                window.location.reload();

            } else {
                showNotification('Erro: ' + data.error, 'error');
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = '<i class="fas fa-paper-plane"></i> Criar Separa√ß√µes dos Agrupamentos Selecionados';
            }

        } catch (error) {
            console.error('Erro ao enviar agrupamentos:', error);
            showNotification('Erro de conex√£o', 'error');
            btnEnviar.disabled = false;
            btnEnviar.innerHTML = '<i class="fas fa-paper-plane"></i> Criar Separa√ß√µes dos Agrupamentos Selecionados';
        }
    }

    function solicitarAgendamento(numPedido) {
        console.log(`üóìÔ∏è Solicitar Agendamento pedido ${numPedido}`);
        // ‚úÖ OTIMIZA√á√ÉO: Cache da inst√¢ncia do modal para evitar recria√ß√£o
        if (!window._modalAgendamento) {
            window._modalAgendamento = new bootstrap.Modal(document.getElementById('modalAgendamento'));
        }
        window._modalAgendamento.show();
        carregarDadosAgendamento(numPedido);
    }

    // Fun√ß√£o removida - usando a vers√£o async acima

    function abrirModalEndereco(numPedido) {
        // Buscar dados do pedido via AJAX - ADAPTADO PARA CARTEIRA AGRUPADA
        fetch('/carteira/item/' + numPedido + '/endereco')
            .then(response => response.json())
            .then(data => {
                // Preencher dados do cliente
                document.getElementById('modal_cliente_uf').textContent = data.estado || '-';
                document.getElementById('modal_cliente_municipio').textContent = data.municipio || '-';

                // Preencher dados do endere√ßo de entrega
                document.getElementById('modal_cnpj_endereco').textContent = data.cnpj_endereco_ent || '-';
                document.getElementById('modal_empresa_endereco').textContent = data.empresa_endereco_ent || '-';
                document.getElementById('modal_uf_endereco').textContent = data.cod_uf || '-';
                document.getElementById('modal_municipio_endereco').textContent = data.nome_cidade || '-';
                document.getElementById('modal_bairro_endereco').textContent = data.bairro_endereco_ent || '-';
                document.getElementById('modal_cep_endereco').textContent = data.cep_endereco_ent || '-';

                // Combinar rua e endere√ßo
                let ruaCompleta = '';
                if (data.rua_endereco_ent && data.endereco_ent) {
                    ruaCompleta = data.rua_endereco_ent + ' / ' + data.endereco_ent;
                } else if (data.rua_endereco_ent) {
                    ruaCompleta = data.rua_endereco_ent;
                } else if (data.endereco_ent) {
                    ruaCompleta = data.endereco_ent;
                }
                document.getElementById('modal_rua_endereco').textContent = ruaCompleta || '-';

                document.getElementById('modal_telefone_endereco').textContent = data.telefone_endereco_ent || '-';

                // Mostrar modal
                // ‚úÖ OTIMIZA√á√ÉO: Cache da inst√¢ncia do modal para evitar recria√ß√£o
                if (!window._modalEndereco) {
                    window._modalEndereco = new bootstrap.Modal(document.getElementById('modalEndereco'));
                }
                window._modalEndereco.show();
            })
            .catch(error => {
                console.error('Erro ao buscar dados do endere√ßo:', error);
                alert('Erro ao carregar dados do endere√ßo');
            });
    }





    // Inicializa√ß√£o
    // ===== MODAL EDIT√ÅVEL REMOVIDO (FUNCIONALIDADE MOVIDA PARA DROPDOWN) =====

    /**
     * Carrega dados para o modal de itens edit√°veis
     */
    async function carregarDadosModalEditavel(numPedido) {
        const modalLoading = document.getElementById('modal-editavel-loading');
        const modalError = document.getElementById('modal-editavel-error');
        const modalContent = document.getElementById('modal-editavel-content');

        try {
            // Mostrar loading
            modalLoading.style.display = 'block';
            modalError.style.display = 'none';
            modalContent.style.display = 'none';

            // Fazer requisi√ß√£o para obter itens com saldo calculado
            const response = await fetch(`/carteira/api/pedido/${numPedido}/itens-editaveis`, {
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                }
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Erro ao carregar itens edit√°veis');
            }

            // Armazenar dados
            dadosModalEditavel = data;

            // Gerar HTML da tabela
            gerarTabelaItensEditaveis(data);

            // Atualizar contadores
            atualizarContadoresModalEditavel();

            // Mostrar conte√∫do
            modalLoading.style.display = 'none';
            modalContent.style.display = 'block';

            console.log(`‚úÖ Modal edit√°vel carregado: ${data.itens.length} itens`);

        } catch (error) {
            console.error(`‚ùå Erro ao carregar modal edit√°vel:`, error);

            document.getElementById('modal-editavel-error-message').textContent = error.message;
            modalLoading.style.display = 'none';
            modalError.style.display = 'block';
            modalContent.style.display = 'none';
        }
    }

    /**
     * Gera HTML da tabela de itens edit√°veis
     */
    function gerarTabelaItensEditaveis(data) {
        const tbody = document.getElementById('tbody-itens-editaveis');
        let html = '';

        data.itens.forEach((item, index) => {
            const itemId = item.id;
            const saldoDisponivel = item.qtd_saldo_disponivel || 0;
            const disabled = saldoDisponivel <= 0 ? 'disabled' : '';

            html += `
            <tr id="row-editavel-${itemId}" data-item-id="${itemId}">
                <td>
                    <input type="checkbox" 
                           class="item-checkbox-editavel" 
                           data-item-id="${itemId}"
                           onchange="atualizarContadoresModalEditavel()"
                           ${disabled}>
                </td>
                <td><strong>${item.cod_produto || ''}</strong></td>
                <td class="text-truncate" style="max-width: 200px;" title="${item.nome_produto || ''}">
                    ${item.nome_produto || ''}
                </td>
                <td>
                    <input type="number" 
                           class="form-control form-control-sm qtd-editavel" 
                           data-item-id="${itemId}"
                           data-pedido="${numPedidoEditavel}"
                           data-qtd-original="${saldoDisponivel}"
                           data-preco-unitario="${item.preco_unitario || 0}"
                           step="1"
                           min="0"
                           max="${saldoDisponivel}"
                           value="${saldoDisponivel}"
                           onchange="processarAlteracaoQuantidadeDropdown(this)"
                           ${disabled}>
                    <small class="text-muted">M√°x: ${saldoDisponivel}</small>
                </td>
                <td class="valor-calculado">${item.valor_calculado || 'R$ 0,00'}</td>
                <td class="peso-calculado">${item.peso_calculado || '0 kg'}</td>
                <td class="pallet-calculado">${item.pallet_calculado || '0,0 pal'}</td>
                <td class="menor-estoque-d7">${item.menor_estoque_d7 || '-'}</td>
                <td class="estoque-expedicao">${item.estoque_expedicao || '-'}</td>
                <td class="producao-expedicao">${item.producao_expedicao || '-'}</td>
                <td class="proxima-data-estoque">
                    ${item.proxima_data_com_estoque ?
                    `<small class="text-info"><i class="fas fa-calendar-alt"></i> ${item.proxima_data_com_estoque}</small>` :
                    '<small class="text-muted">-</small>'
                }
                </td>
                <td>
                    <input type="date" 
                           class="form-control form-control-sm data-expedicao" 
                           data-item-id="${itemId}"
                           data-pedido="${numPedidoEditavel}"
                           value="${item.expedicao || ''}"
                           onchange="processarAlteracaoDataExpedicaoDropdown(this)"
                           ${disabled}>
                </td>
                <td>
                    <input type="date" 
                           class="form-control form-control-sm agendamento" 
                           data-item-id="${itemId}"
                           data-pedido="${numPedidoEditavel}"
                           value="${item.agendamento || ''}"
                           onchange="processarAlteracaoAgendamentoDropdown(this)"
                           ${disabled}>
                </td>
                <td>
                    <input type="text" 
                           class="form-control form-control-sm protocolo" 
                           data-item-id="${itemId}"
                           data-pedido="${numPedidoEditavel}"
                           value="${item.protocolo || ''}"
                           placeholder="Protocolo"
                           onchange="processarAlteracaoProtocoloDropdown(this)"
                           ${disabled}>
                </td>
            </tr>
        `;
        });

        tbody.innerHTML = html;
    }


    /**
     * Cria nova linha com saldo restante
     */
    async function criarNovaLinhaItem(itemIdOriginal, qtdRestante) {
        const rowOriginal = document.getElementById(`row-editavel-${itemIdOriginal}`);
        const tbody = document.getElementById('tbody-itens-editaveis');

        // Gerar novo ID tempor√°rio
        const novoItemId = `${itemIdOriginal}_saldo_${Date.now()}`;

        // Clonar linha original
        const novaRow = rowOriginal.cloneNode(true);
        novaRow.id = `row-editavel-${novoItemId}`;

        // Atualizar dados da nova linha
        const qtdInput = novaRow.querySelector('.qtd-editavel');
        qtdInput.value = qtdRestante;
        qtdInput.setAttribute('data-qtd-original', qtdRestante);
        qtdInput.setAttribute('data-item-id', novoItemId);

        // Atualizar outros campos
        novaRow.querySelectorAll('[data-item-id]').forEach(element => {
            element.setAttribute('data-item-id', novoItemId);
        });

        // Adicionar badge indicando saldo
        const produtoCell = novaRow.querySelector('td:nth-child(3)');
        produtoCell.innerHTML += ' <span class="badge bg-info">Saldo</span>';

        // Inserir ap√≥s linha original
        rowOriginal.parentNode.insertBefore(novaRow, rowOriginal.nextSibling);

        // Marcar como item dividido
        itensDivididos.set(novoItemId, {
            itemOriginal: itemIdOriginal,
            qtdRestante: qtdRestante,
            tipo: 'saldo'
        });
    }

    /**
     * Processa altera√ß√£o de data de expedi√ß√£o (D0) e recalcula estoques
     */
    async function processarAlteracaoDataExpedicao(input) {
        const itemId = input.getAttribute('data-item-id');
        const novaData = input.value;

        if (novaData) {
            // Recalcular estoques baseados na nova data D0
            await recalcularEstoquesBaseadoD0(itemId, novaData);

            // Replicar para itens marcados (amarrar)
            replicarCampoParaItensAmarrados('data-expedicao', novaData);
        }

        // Salvar automaticamente
        await salvarAlteracaoAutomatica(itemId, 'expedicao', novaData);

        // Atualizar valida√ß√£o
        atualizarValidacaoEnvioSeparacao();
    }

    /**
     * Recalcula estoques D0/D7 baseado na nova data de expedi√ß√£o
     */
    async function recalcularEstoquesBaseadoD0(itemId, dataExpedicao) {
        try {
            const response = await fetch(`/carteira/api/item/${itemId}/recalcular-estoques`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    data_d0: dataExpedicao
                })
            });

            const data = await response.json();

            if (data.success) {
                // Atualizar colunas de estoque na linha
                const row = document.getElementById(`row-editavel-${itemId}`);
                row.querySelector('.menor-estoque-d7').textContent = data.menor_estoque_d7 || '-';
                row.querySelector('.estoque-expedicao').textContent = data.estoque_expedicao || '-';
                row.querySelector('.producao-expedicao').textContent = data.producao_expedicao || '-';

                // Atualizar pr√≥xima data dispon√≠vel
                const proximaDataEl = row.querySelector('.proxima-data-estoque');
                if (proximaDataEl && data.proxima_data_com_estoque) {
                    proximaDataEl.innerHTML = `<small class="text-info"><i class="fas fa-calendar-alt"></i> ${data.proxima_data_com_estoque}</small>`;
                } else if (proximaDataEl) {
                    proximaDataEl.innerHTML = '<small class="text-muted">-</small>';
                }
            }
        } catch (error) {
            console.error('Erro ao recalcular estoques:', error);
        }
    }

    /**
     * Replica campo para itens marcados no checkbox (amarrar campos)
     */
    function replicarCampoParaItensAmarrados(classeCampo, valor) {
        const checkboxesMarcados = document.querySelectorAll('.item-checkbox-editavel:checked');

        checkboxesMarcados.forEach(checkbox => {
            const itemId = checkbox.getAttribute('data-item-id');
            const row = document.getElementById(`row-editavel-${itemId}`);
            const campo = row.querySelector(`.${classeCampo}`);

            if (campo && campo.value !== valor) {
                campo.value = valor;

                // Se for data expedi√ß√£o, recalcular estoques
                if (classeCampo === 'data-expedicao' && valor) {
                    recalcularEstoquesBaseadoD0(itemId, valor);
                }

                // Salvar automaticamente
                const nomeCampo = classeCampo.replace('data-', '').replace('-', '_');
                salvarAlteracaoAutomatica(itemId, nomeCampo, valor);
            }
        });
    }

    /**
     * Atualiza contadores do modal
     */
    function atualizarContadoresModalEditavel() {
        const checkboxesMarcados = document.querySelectorAll('.item-checkbox-editavel:checked');
        const comExpedicao = Array.from(checkboxesMarcados).filter(cb => {
            const itemId = cb.getAttribute('data-item-id');
            const row = document.getElementById(`row-editavel-${itemId}`);
            const dataExpedicao = row.querySelector('.data-expedicao').value;
            return dataExpedicao && dataExpedicao.trim();
        });

        document.getElementById('contador-selecionados').textContent = checkboxesMarcados.length;
        document.getElementById('contador-com-expedicao').textContent = comExpedicao.length;

        // Atualizar status de valida√ß√£o
        atualizarValidacaoEnvioSeparacao();
    }

    /**
     * Atualiza valida√ß√£o para envio de separa√ß√£o
     */
    function atualizarValidacaoEnvioSeparacao() {
        const checkboxesMarcados = document.querySelectorAll('.item-checkbox-editavel:checked');
        const statusSpan = document.getElementById('status-validacao');
        const btnEnviar = document.getElementById('btn-enviar-separacao');

        if (checkboxesMarcados.length === 0) {
            statusSpan.textContent = 'Selecione itens';
            statusSpan.className = 'badge bg-secondary';
            btnEnviar.disabled = true;
            return;
        }

        const semExpedicao = Array.from(checkboxesMarcados).filter(cb => {
            const itemId = cb.getAttribute('data-item-id');
            const row = document.getElementById(`row-editavel-${itemId}`);
            const dataExpedicao = row.querySelector('.data-expedicao').value;
            return !dataExpedicao || !dataExpedicao.trim();
        });

        if (semExpedicao.length > 0) {
            statusSpan.textContent = `${semExpedicao.length} sem data expedi√ß√£o`;
            statusSpan.className = 'badge bg-danger';
            btnEnviar.disabled = true;
        } else {
            statusSpan.textContent = 'Pronto para enviar';
            statusSpan.className = 'badge bg-success';
            btnEnviar.disabled = false;
        }
    }

    /**
     * Envia itens selecionados para separa√ß√£o
     */
    async function enviarParaSeparacao() {
        const checkboxesMarcados = document.querySelectorAll('.item-checkbox-editavel:checked');

        if (checkboxesMarcados.length === 0) {
            alert('‚ö†Ô∏è Selecione pelo menos um item para enviar para separa√ß√£o');
            return;
        }

        // Validar se todos t√™m data de expedi√ß√£o
        const semExpedicao = Array.from(checkboxesMarcados).filter(cb => {
            const itemId = cb.getAttribute('data-item-id');
            const row = document.getElementById(`row-editavel-${itemId}`);
            const dataExpedicao = row.querySelector('.data-expedicao').value;
            return !dataExpedicao || !dataExpedicao.trim();
        });

        if (semExpedicao.length > 0) {
            alert(`‚ö†Ô∏è ${semExpedicao.length} itens n√£o possuem Data de Expedi√ß√£o.\n\nPreencha a Data de Expedi√ß√£o para todos os itens selecionados.`);
            return;
        }

        // Coletar dados dos itens selecionados
        const itensParaSeparacao = [];

        checkboxesMarcados.forEach(checkbox => {
            const itemId = checkbox.getAttribute('data-item-id');
            const row = document.getElementById(`row-editavel-${itemId}`);

            const qtd = parseFloat(row.querySelector('.qtd-editavel').value) || 0;
            const dataExpedicao = row.querySelector('.data-expedicao').value;
            const agendamento = row.querySelector('.agendamento').value;
            const protocolo = row.querySelector('.protocolo').value;

            if (qtd > 0) {
                itensParaSeparacao.push({
                    item_id: itemId,
                    qtd_separacao: qtd,
                    data_expedicao: dataExpedicao,
                    agendamento: agendamento,
                    protocolo: protocolo
                });
            }
        });

        if (itensParaSeparacao.length === 0) {
            alert('‚ö†Ô∏è Nenhum item v√°lido para separa√ß√£o');
            return;
        }

        try {
            const btnEnviar = document.getElementById('btn-enviar-separacao');
            btnEnviar.disabled = true;
            btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            const response = await fetch(`/carteira/api/pedido/${numPedidoEditavel}/criar-separacao`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    itens: itensParaSeparacao
                })
            });

            const data = await response.json();

            if (data.success) {
                alert(`‚úÖ Separa√ß√£o criada com sucesso!\n\nLote ID: ${data.separacao_lote_id}\nItens: ${itensParaSeparacao.length}`);

                // Fechar modal e recarregar pedidos
                $('#modalItensEditaveis').modal('hide');

                // Opcional: recarregar a p√°gina ou atualizar lista
                location.reload();
            } else {
                throw new Error(data.error || 'Erro ao criar separa√ß√£o');
            }

        } catch (error) {
            console.error('Erro ao enviar para separa√ß√£o:', error);
            alert(`‚ùå Erro ao criar separa√ß√£o:\n\n${error.message}`);
        } finally {
            const btnEnviar = document.getElementById('btn-enviar-separacao');
            btnEnviar.disabled = false;
            btnEnviar.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar para Separa√ß√£o';
        }
    }

    /**
     * Salva altera√ß√£o automaticamente
     */
    async function salvarAlteracaoAutomatica(itemId, campo, valor) {
        try {
            console.log(`üíæ Auto-save: Item ${itemId}, Campo ${campo}, Valor ${valor}`);

            const response = await fetch(`/carteira/api/item/${itemId}/salvar-alteracao`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    campo: campo,
                    valor: valor
                })
            });

            const data = await response.json();

            if (!data.success) {
                console.error(`Erro no auto-save:`, data.error);
            } else {
                console.log(`‚úÖ Auto-save: ${data.message}`);
            }

        } catch (error) {
            console.error('Erro no auto-save:', error);
        }
    }

    /**
     * Toggle todos os itens edit√°veis
     */
    function toggleTodosItensEditaveis(selectAll) {
        const checkboxes = document.querySelectorAll('.item-checkbox-editavel:not(:disabled)');
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        atualizarContadoresModalEditavel();
    }

    /**
     * Recarrega modal edit√°vel
     */
    function recarregarModalEditavel() {
        if (numPedidoEditavel) {
            carregarDadosModalEditavel(numPedidoEditavel);
        }
    }

    /**
     * Processa altera√ß√£o de agendamento (replica automaticamente)
     */
    async function processarAlteracaoAgendamento(input) {
        const itemId = input.getAttribute('data-item-id');
        const novaData = input.value;

        // Replicar para itens marcados (amarrar)
        replicarCampoParaItensAmarrados('agendamento', novaData);

        // Salvar automaticamente
        await salvarAlteracaoAutomatica(itemId, 'agendamento', novaData);
    }

    /**
     * Processa altera√ß√£o de protocolo (replica automaticamente)
     */
    async function processarAlteracaoProtocolo(input) {
        const itemId = input.getAttribute('data-item-id');
        const novoProtocolo = input.value;

        // Replicar para itens marcados (amarrar)
        replicarCampoParaItensAmarrados('protocolo', novoProtocolo);

        // Salvar automaticamente
        await salvarAlteracaoAutomatica(itemId, 'protocolo', novoProtocolo);
    }

    /**
     * Recalcula valores autom√°ticos de um item baseado na nova quantidade
     */
    function recalcularValoresItem(itemId, qtdNova) {
        const row = document.getElementById(`row-editavel-${itemId}`);
        if (!row) return;

        // Buscar dados originais do item
        const dadosItem = dadosModalEditavel?.itens?.find(item => item.id.toString() === itemId.toString());
        if (!dadosItem) return;

        const precoUnitario = dadosItem.preco_unitario || 0;

        // Calcular novos valores
        const valorTotal = qtdNova * precoUnitario;
        const pesoTotal = qtdNova * (dadosItem.peso_unitario || 0);
        const palletTotal = qtdNova * (dadosItem.pallet_unitario || 0);

        // Atualizar c√©lulas
        row.querySelector('.valor-calculado').textContent = `R$ ${valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        row.querySelector('.peso-calculado').textContent = `${pesoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 1 })} kg`;
        row.querySelector('.pallet-calculado').textContent = `${palletTotal.toLocaleString('pt-BR', { minimumFractionDigits: 1 })} pal`;
    }

    /**
     * REMOVIDO - DUPLICA√á√ÉO: Usar unificarLinhaDropdown
     * Unifica linha quando quantidade √© zerada (remove divis√£o)
     */
    /* COMENTADO - DUPLICA√á√ÉO
    async function unificarLinhaItem(itemId) {
        console.log(`üîÑ Unificando linha do item ${itemId}`);

        // Verificar se h√° linha de saldo para unificar
        const linhasSaldo = Array.from(document.querySelectorAll('[id^="row-editavel-"]')).filter(row => {
            const id = row.id.replace('row-editavel-', '');
            return itensDivididos.has(id) && itensDivididos.get(id).itemOriginal === itemId;
        });

        if (linhasSaldo.length > 0) {
            // Somar quantidades das linhas de saldo
            let qtdTotalSaldo = 0;
            linhasSaldo.forEach(linha => {
                const qtdInput = linha.querySelector('.qtd-editavel');
                qtdTotalSaldo += parseFloat(qtdInput.value) || 0;

                // Remover linha de saldo
                linha.remove();

                // Remover do mapeamento
                const linhaId = linha.id.replace('row-editavel-', '');
                itensDivididos.delete(linhaId);
            });

            // Restaurar quantidade original na linha principal
            const linhaPrincipal = document.getElementById(`row-editavel-${itemId}`);
            if (linhaPrincipal) {
                const qtdInput = linhaPrincipal.querySelector('.qtd-editavel');
                const qtdOriginal = parseFloat(qtdInput.getAttribute('data-qtd-original'));
                qtdInput.value = qtdOriginal;

                // Recalcular valores
                recalcularValoresItem(itemId, qtdOriginal);
            }

            console.log(`‚úÖ Item ${itemId} unificado, quantidade restaurada`);
        }
    }
    */

    /**
     * Cria PreSeparacaoItem via API
     */
    async function criarPreSeparacaoItem(itemId, qtdUtilizada, numPedido) {
        try {
            console.log(`üìù Criando PreSeparacaoItem: Item ${itemId}, Qtd ${qtdUtilizada}`);

            const response = await fetch(`/carteira/api/pedido/${numPedido}/criar-pre-separacao`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    item_id: itemId,
                    qtd_pre_separacao: qtdUtilizada,
                    tipo_envio: 'total'
                })
            });

            const data = await response.json();

            if (data.success) {
                console.log(`‚úÖ PreSeparacaoItem criado: ID ${data.pre_separacao_id}, Novo item: ${data.novo_item_id}`);
                return true;
            } else {
                console.error('Erro ao criar PreSeparacaoItem:', data.error);
                return false;
            }

        } catch (error) {
            console.error('Erro ao criar PreSeparacaoItem:', error);
            return false;
        }
    }

    // ========================================
    // üóÇÔ∏è FUN√á√ïES PARA GERENCIAR PR√â-SEPARA√á√ïES
    // ========================================

    /**
     * Edita campo de pr√©-separa√ß√£o
     */
    async function editarCampoPreSeparacao(element, campo) {
        const preSeparacaoId = element.getAttribute('data-pre-separacao-id');
        const valor = element.value;

        try {
            const response = await fetch(`/carteira/api/pre-separacao/${preSeparacaoId}/editar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    campo: campo,
                    valor: valor
                })
            });

            const data = await response.json();

            if (data.success) {
                console.log(`‚úÖ Campo ${campo} da pr√©-separa√ß√£o ${preSeparacaoId} atualizado`);
                // Mostrar feedback visual
                element.style.borderColor = '#28a745';
                setTimeout(() => {
                    element.style.borderColor = '';
                }, 2000);
            } else {
                console.error('Erro ao editar pr√©-separa√ß√£o:', data.error);
                showNotification('Erro ao salvar altera√ß√£o: ' + data.error, 'error');
                element.focus();
            }

        } catch (error) {
            console.error('Erro ao editar pr√©-separa√ß√£o:', error);
            showNotification('Erro de conex√£o ao salvar altera√ß√£o', 'error');
        }
    }

    /**
     * Edita data de pr√©-separa√ß√£o
     */
    async function editarDataPreSeparacao(element, campo) {
        await editarCampoPreSeparacao(element, campo);
    }

    /**
     * Edita quantidade de pr√©-separa√ß√£o
     */
    async function editarQuantidadePreSeparacao(element) {
        const preSeparacaoId = element.getAttribute('data-pre-separacao-id');
        const novaQuantidade = parseFloat(element.value) || 0;
        const qtdOriginal = parseFloat(element.getAttribute('data-qtd-original')) || 0;

        // Validar quantidade
        if (novaQuantidade <= 0) {
            showNotification('Quantidade deve ser maior que zero', 'error');
            element.focus();
            return;
        }

        if (novaQuantidade > qtdOriginal) {
            showNotification(`Quantidade n√£o pode ser maior que ${qtdOriginal}`, 'error');
            element.value = qtdOriginal;
            element.focus();
            return;
        }

        await editarCampoPreSeparacao(element, 'quantidade');
    }

    /**
     * Cancela pr√©-separa√ß√£o
     */
    async function cancelarPreSeparacao(preSeparacaoId) {
        if (!confirm('Tem certeza que deseja cancelar esta pr√©-separa√ß√£o?')) {
            return;
        }

        try {
            const response = await fetch(`/carteira/api/pre-separacao/${preSeparacaoId}/cancelar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                }
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Pr√©-separa√ß√£o cancelada com sucesso', 'success');

                // Remover linha da tabela
                const row = document.querySelector(`[data-pre-separacao-id="${preSeparacaoId}"]`);
                if (row) {
                    row.style.transition = 'opacity 0.3s';
                    row.style.opacity = '0.5';
                    setTimeout(() => {
                        row.remove();
                    }, 300);
                }

            } else {
                showNotification('Erro ao cancelar pr√©-separa√ß√£o: ' + data.error, 'error');
            }

        } catch (error) {
            console.error('Erro ao cancelar pr√©-separa√ß√£o:', error);
            showNotification('Erro de conex√£o ao cancelar pr√©-separa√ß√£o', 'error');
        }
    }

    /**
     * Envia pr√©-separa√ß√£o para separa√ß√£o definitiva
     */
    async function enviarPreSeparacaoParaSeparacao(preSeparacaoId) {
        const observacoes = prompt('Observa√ß√µes para a separa√ß√£o (opcional):') || '';

        if (!confirm('Tem certeza que deseja enviar esta pr√©-separa√ß√£o para separa√ß√£o definitiva?')) {
            return;
        }

        try {
            const response = await fetch(`/carteira/api/pre-separacao/${preSeparacaoId}/enviar-separacao`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    observacoes: observacoes
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification(`Pr√©-separa√ß√£o enviada para separa√ß√£o ${data.lote_id}`, 'success');

                // Atualizar status da linha
                const row = document.querySelector(`[data-pre-separacao-id="${preSeparacaoId}"]`);
                if (row) {
                    row.classList.remove('table-warning');
                    row.classList.add('table-success');

                    // Atualizar badge de status
                    const statusBadge = row.querySelector('.badge');
                    if (statusBadge) {
                        statusBadge.textContent = 'ENVIADO_SEPARACAO';
                        statusBadge.className = 'badge bg-success';
                    }

                    // Desabilitar bot√µes
                    const buttons = row.querySelectorAll('button');
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        btn.classList.add('disabled');
                    });
                }

            } else {
                showNotification('Erro ao enviar para separa√ß√£o: ' + data.error, 'error');
            }

        } catch (error) {
            console.error('Erro ao enviar pr√©-separa√ß√£o para separa√ß√£o:', error);
            showNotification('Erro de conex√£o ao enviar para separa√ß√£o', 'error');
        }
    }

    /**
     * Abre modal para editar detalhes da pr√©-separa√ß√£o
     */
    function editarPreSeparacao(preSeparacaoId) {
        // TODO: Implementar modal de edi√ß√£o completa se necess√°rio
        showNotification('Use os campos da tabela para editar a pr√©-separa√ß√£o', 'info');
    }

    /**
     * Fun√ß√£o auxiliar para mostrar notifica√ß√µes
     */
    function showNotification(message, type = 'info') {
        // Implementa√ß√£o b√°sica - pode ser melhorada com uma biblioteca de notifica√ß√µes
        const alertClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'warning': 'alert-warning',
            'info': 'alert-info'
        }[type] || 'alert-info';

        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;

        document.body.appendChild(notification);

        // Auto-remover ap√≥s 5 segundos
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    /**
     * Mostra/oculta badge de confirma√ß√£o de agendamento
     */
    function mostrarBadgeConfirmacao(confirmado) {
        const badge = document.getElementById('badge-status-agenda');
        if (badge) {
            if (confirmado) {
                badge.style.display = 'inline-block';
                badge.innerHTML = '<i class="fas fa-check-circle"></i> Confirmado';
                badge.className = 'badge bg-success ms-2';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    /**
     * Sugere data alternativa com estoque dispon√≠vel
     */
    async function sugerirAlternativa(codProduto) {
        try {
            // Buscar o item para obter a quantidade necess√°ria
            const itemRow = document.querySelector(`tr[data-cod-produto="${codProduto}"]`);
            const qtdNecessaria = parseFloat(itemRow?.querySelector('.qtd-input')?.value) ||
                parseFloat(itemRow?.dataset.qtdPedido) || 0;

            // Buscar proje√ß√£o de estoque para o produto
            const response = await fetch(`/carteira/api/produto/${codProduto}/estoque-d0-d7`);
            if (!response.ok) {
                throw new Error('Erro ao buscar estoque');
            }

            const data = await response.json();

            if (!data.success || !data.produto) {
                throw new Error('Dados de estoque n√£o dispon√≠veis');
            }

            const produto = data.produto;
            const resumoEstoque = produto.estoque_info;

            // Usar dados reais da proje√ß√£o
            let datasSugeridas = [];
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            // Se tem proje√ß√£o detalhada
            if (resumoEstoque && resumoEstoque.projecao_29_dias) {
                resumoEstoque.projecao_29_dias.forEach((dia, index) => {
                    const estoqueProjetado = dia.estoque_final || 0;

                    // Se tem estoque suficiente para a quantidade necess√°ria
                    if (estoqueProjetado >= qtdNecessaria && datasSugeridas.length < 3) {
                        const dataSugestao = new Date(hoje);
                        dataSugestao.setDate(hoje.getDate() + index);

                        datasSugeridas.push({
                            data: dataSugestao.toLocaleDateString('pt-BR'),
                            estoque_previsto: Math.floor(estoqueProjetado),
                            producao_dia: dia.producao || 0,
                            consumo_dia: dia.consumo || 0
                        });
                    }
                });
            }

            // Mostrar resultado
            if (datasSugeridas.length > 0) {
                let mensagem = `üìÖ DATAS ALTERNATIVAS COM ESTOQUE\n\n`;
                mensagem += `Produto: ${codProduto} - ${produto.nome_produto || ''}\n`;
                mensagem += `Quantidade necess√°ria: ${qtdNecessaria.toFixed(0)} unidades\n`;
                mensagem += `Estoque atual: ${resumoEstoque?.estoque_inicial?.toFixed(0) || 0} unidades\n\n`;
                mensagem += `Sugest√µes de expedi√ß√£o:\n`;

                datasSugeridas.forEach((sugestao, index) => {
                    mensagem += `\n${index + 1}. ${sugestao.data}\n`;
                    mensagem += `   ‚Ä¢ Estoque previsto: ${sugestao.estoque_previsto} unidades\n`;
                    if (sugestao.producao_dia > 0) {
                        mensagem += `   ‚Ä¢ Produ√ß√£o no dia: +${sugestao.producao_dia} unidades\n`;
                    }
                });

                alert(mensagem);
            } else {
                alert(`‚ö†Ô∏è ESTOQUE INSUFICIENTE\n\nProduto: ${codProduto}\nQuantidade necess√°ria: ${qtdNecessaria} unidades\n\nN√£o h√° previs√£o de estoque suficiente nos pr√≥ximos 28 dias.\n\nConsidere:\n‚Ä¢ Reduzir a quantidade\n‚Ä¢ Negociar prazo maior\n‚Ä¢ Buscar produto alternativo`);
            }

        } catch (error) {
            console.error('Erro ao sugerir alternativa:', error);
            alert('‚ùå Erro ao buscar sugest√µes de data alternativa');
        }
    }

    /**
     * Recalcula todos os estoques D0/D7 do modal
     */
    async function recalcularEstoquesD0D7() {
        const rows = document.querySelectorAll('[id^="row-editavel-"]');
        let recalculados = 0;

        for (const row of rows) {
            const itemId = row.id.replace('row-editavel-', '');
            const dataExpedicaoInput = row.querySelector('.data-expedicao');

            if (dataExpedicaoInput && dataExpedicaoInput.value) {
                try {
                    await recalcularEstoquesBaseadoD0(itemId, dataExpedicaoInput.value);
                    recalculados++;
                } catch (error) {
                    console.error(`Erro ao recalcular estoque do item ${itemId}:`, error);
                }
            }
        }

        if (recalculados > 0) {
            alert(`‚úÖ ${recalculados} itens tiveram seus estoques recalculados`);
        } else {
            alert('‚ÑπÔ∏è Nenhum item com data de expedi√ß√£o para recalcular');
        }
    }

    /**
     * Replica campos manualmente (bot√£o "Replicar Campos")
     */
    function replicarCamposAmarrados() {
        const checkboxesMarcados = document.querySelectorAll('.item-checkbox-editavel:checked');

        if (checkboxesMarcados.length < 2) {
            alert('‚ö†Ô∏è Marque pelo menos 2 itens para replicar campos');
            return;
        }

        // Perguntar qual item usar como origem
        const itensDisponiveis = Array.from(checkboxesMarcados).map((cb, index) => {
            const itemId = cb.getAttribute('data-item-id');
            const row = document.getElementById(`row-editavel-${itemId}`);
            const codProduto = row.querySelector('td:nth-child(2)').textContent;
            return `${index + 1}. ${codProduto} (ID: ${itemId})`;
        }).join('\n');

        const origem = prompt(`üìã REPLICAR CAMPOS\n\nItens selecionados:\n${itensDisponiveis}\n\nDigite o n√∫mero do item origem (1, 2, 3...):`);

        if (!origem) return;

        const indiceOrigem = parseInt(origem) - 1;
        if (indiceOrigem < 0 || indiceOrigem >= checkboxesMarcados.length) {
            alert('‚ö†Ô∏è N√∫mero inv√°lido');
            return;
        }

        // Obter dados do item origem
        const checkboxOrigem = checkboxesMarcados[indiceOrigem];
        const itemIdOrigem = checkboxOrigem.getAttribute('data-item-id');
        const rowOrigem = document.getElementById(`row-editavel-${itemIdOrigem}`);

        const dataExpedicao = rowOrigem.querySelector('.data-expedicao').value;
        const agendamento = rowOrigem.querySelector('.agendamento').value;
        const protocolo = rowOrigem.querySelector('.protocolo').value;

        // Replicar para todos os outros marcados
        checkboxesMarcados.forEach((checkbox, index) => {
            if (index === indiceOrigem) return; // Pular o pr√≥prio item origem

            const itemId = checkbox.getAttribute('data-item-id');
            const row = document.getElementById(`row-editavel-${itemId}`);

            if (dataExpedicao) {
                row.querySelector('.data-expedicao').value = dataExpedicao;
                salvarAlteracaoAutomatica(itemId, 'expedicao', dataExpedicao);
                if (dataExpedicao) recalcularEstoquesBaseadoD0(itemId, dataExpedicao);
            }

            if (agendamento) {
                row.querySelector('.agendamento').value = agendamento;
                salvarAlteracaoAutomatica(itemId, 'agendamento', agendamento);
            }

            if (protocolo) {
                row.querySelector('.protocolo').value = protocolo;
                salvarAlteracaoAutomatica(itemId, 'protocolo', protocolo);
            }
        });

        // Atualizar valida√ß√£o
        atualizarValidacaoEnvioSeparacao();

        alert(`‚úÖ Campos replicados do item ${checkboxesMarcados[indiceOrigem].getAttribute('data-item-id')} para ${checkboxesMarcados.length - 1} itens`);
    }

    $(document).ready(function () {
        console.log('‚úÖ JavaScript expandir/colapsar inicializado');
        console.log(`üìä ${$('.pedido-row').length} pedidos dispon√≠veis para expans√£o`);

        // üîÑ Carregar contadores de separa√ß√µes para todos os pedidos
        carregarContadoresSeparacoes();
    });

    /**
     * Carrega contadores de separa√ß√µes para todos os pedidos vis√≠veis
     */
    async function carregarContadoresSeparacoes() {
        const pedidoRows = document.querySelectorAll('.pedido-row');
        console.log(`üî¢ Carregando contadores de separa√ß√µes para ${pedidoRows.length} pedidos...`);

        // CORRIGIDO: Performance - usar Promise.all para requisi√ß√µes paralelas ao inv√©s de sequenciais
        await Promise.all(
            Array.from(pedidoRows).map(async (row) => {
                const numPedido = row.getAttribute('data-pedido');
                if (!numPedido) return;

                try {
                    const response = await fetch(`/carteira/api/pedido/${numPedido}/separacoes`);
                    const data = await response.json();

                    if (data.success) {
                        const totalSep = data.total_separacoes || 0;
                        const badgeEl = document.getElementById(`separacoes-badge-${numPedido}`);

                        if (badgeEl) {
                            badgeEl.textContent = `${totalSep} separa√ß√£o${totalSep !== 1 ? '√µes' : ''}`;
                            badgeEl.style.backgroundColor = totalSep > 0 ? '#28a745' : '#6c757d';
                            badgeEl.style.color = 'white';
                        }

                        // Armazenar no cache para uso futuro
                        separacoesPedidoCache.set(numPedido, data);
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Erro ao carregar contador de separa√ß√µes do pedido ${numPedido}:`, error);
                }
            })
        );

        console.log('‚úÖ Contadores de separa√ß√µes carregados');
    }

    /**
     * üîß P2.1: Criar nova separa√ß√£o (IMPLEMENTA√á√ÉO REAL)
     * Conecta √† API /api/separacao/criar
     */
    async function criarNovaSeparacao() {
        if (!numPedidoSeparacoes) {
            alert('‚ö†Ô∏è **NENHUM PEDIDO SELECIONADO**\n\nSelecione um pedido na aba "Separa√ß√µes" para criar nova separa√ß√£o.');
            return;
        }

        console.log(`‚ûï Criando nova separa√ß√£o para pedido: ${numPedidoSeparacoes}`);

        try {
            // 1. Carregar itens dispon√≠veis do pedido (sem separa√ß√£o)
            const responseItens = await fetch(`/carteira/api/pedido/${numPedidoSeparacoes}/itens`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                }
            });

            const dataItens = await responseItens.json();

            if (!responseItens.ok || !dataItens.success) {
                throw new Error('N√£o foi poss√≠vel carregar itens do pedido');
            }

            // 2. Filtrar apenas itens sem separa√ß√£o
            const itensSemSeparacao = dataItens.itens.filter(item => !item.tem_separacao);

            if (itensSemSeparacao.length === 0) {
                alert(`‚ÑπÔ∏è **TODOS OS ITENS J√Å SEPARADOS**\n\nPedido: ${numPedidoSeparacoes}\n\nTodos os itens deste pedido j√° possuem separa√ß√£o.\n\nN√£o √© poss√≠vel criar nova separa√ß√£o.`);
                return;
            }

            // 3. Mostrar itens dispon√≠veis e permitir sele√ß√£o
            let itensTexto = `üì¶ **ITENS DISPON√çVEIS PARA SEPARA√á√ÉO**\n\nPedido: ${numPedidoSeparacoes}\nItens sem separa√ß√£o: ${itensSemSeparacao.length}\n\n`;

            itensSemSeparacao.forEach((item, index) => {
                itensTexto += `${index + 1}. ${item.cod_produto} - ${item.nome_produto}\n   Qtd: ${item.qtd_saldo.toLocaleString('pt-BR')} | Valor: R$ ${item.valor_item.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}\n\n`;
            });

            // 4. Perguntar se quer separar todos ou selecionar
            const separarTodos = confirm(`${itensTexto}\n\n‚ùì **COMO PROCEDER?**\n\n‚úÖ OK = Separar TODOS os itens listados\n‚ùå Cancelar = Selecionar itens espec√≠ficos\n\n‚ö†Ô∏è Nota: Para sele√ß√£o espec√≠fica, use a interface da carteira principal.`);

            let itensSelecionados;

            if (separarTodos) {
                // Separar todos os itens dispon√≠veis
                itensSelecionados = itensSemSeparacao.map(item => item.id);
            } else {
                // Para simplificar, por enquanto vamos usar apenas o primeiro item
                // Em uma implementa√ß√£o mais avan√ßada, poderia ter um modal de sele√ß√£o
                alert(`üí° **SELE√á√ÉO ESPEC√çFICA**\n\nPara selecionar itens espec√≠ficos, use os checkboxes na interface principal da carteira.\n\nPor enquanto, vamos criar separa√ß√£o apenas com o primeiro item.`);
                itensSelecionados = [itensSemSeparacao[0].id];
            }

            // 5. Obter dados opcionais da separa√ß√£o
            const tipoEnvio = confirm(`üì¶ **TIPO DE ENVIO**\n\n‚úÖ OK = TOTAL (envio completo)\n‚ùå Cancelar = PARCIAL (envio parcial)`) ? 'total' : 'parcial';

            const dataExpedicao = prompt(`üìÖ **DATA DE EXPEDI√á√ÉO**\n\nInforme a data de expedi√ß√£o (dd/mm/yyyy):\n(Deixe vazio se n√£o souber ainda)`, '');

            const dataAgendamento = prompt(`üìÖ **DATA DE AGENDAMENTO**\n\nInforme a data de agendamento (dd/mm/yyyy):\n(Deixe vazio se n√£o souber ainda)`, '');

            const protocolo = prompt(`üìã **PROTOCOLO**\n\nInforme o protocolo (opcional):`, '');

            const observacoes = prompt(`üí¨ **OBSERVA√á√ïES**\n\nInforme observa√ß√µes sobre a separa√ß√£o (opcional):`, '');

            // 6. Preparar dados para cria√ß√£o
            const dadosCriacao = {
                num_pedido: numPedidoSeparacoes,
                itens_selecionados: itensSelecionados,
                tipo_envio: tipoEnvio
            };

            if (dataExpedicao && dataExpedicao.trim()) {
                dadosCriacao.expedicao = dataExpedicao.trim();
            }

            if (dataAgendamento && dataAgendamento.trim()) {
                dadosCriacao.agendamento = dataAgendamento.trim();
            }

            if (protocolo && protocolo.trim()) {
                dadosCriacao.protocolo = protocolo.trim();
            }

            if (observacoes && observacoes.trim()) {
                dadosCriacao.observacoes = observacoes.trim();
            }

            // 7. Enviar para API
            const responseCriacao = await fetch(`/carteira/api/separacao/criar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify(dadosCriacao)
            });

            const dataCriacao = await responseCriacao.json();

            if (!responseCriacao.ok || !dataCriacao.success) {
                throw new Error(dataCriacao.error || 'Erro ao criar separa√ß√£o');
            }

            // ‚úÖ SUCESSO
            console.log('‚úÖ Separa√ß√£o criada com sucesso:', dataCriacao);

            const separacao = dataCriacao.separacao;
            const totais = separacao.totais;

            const mensagemSucesso = `‚úÖ **SEPARA√á√ÉO CRIADA!**\n\nüè∑Ô∏è **DADOS:**\n‚Ä¢ Lote: ${separacao.lote_id}\n‚Ä¢ Pedido: ${separacao.num_pedido}\n‚Ä¢ Tipo: ${separacao.tipo_envio.toUpperCase()}\n‚Ä¢ Criada em: ${separacao.data_criacao}\n\nüì¶ **TOTAIS:**\n‚Ä¢ Produtos: ${separacao.total_produtos}\n‚Ä¢ Quantidade: ${totais.quantidade.toLocaleString('pt-BR')}\n‚Ä¢ Valor: R$ ${totais.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}\n‚Ä¢ Peso: ${totais.peso.toLocaleString('pt-BR')} kg\n‚Ä¢ Pallets: ${totais.pallet.toLocaleString('pt-BR', { minimumFractionDigits: 1 })}\n\nüîÑ A p√°gina ser√° recarregada para mostrar a nova separa√ß√£o.`;

            alert(mensagemSucesso);

            // Recarregar dados da p√°gina para mostrar nova separa√ß√£o
            location.reload();

        } catch (error) {
            console.error('‚ùå Erro ao criar separa√ß√£o:', error);
            alert(`‚ùå **ERRO AO CRIAR SEPARA√á√ÉO**\n\nPedido: ${numPedidoSeparacoes}\nDetalhes: ${error.message}\n\nüîß Verifique os dados e tente novamente.`);
        }
    }

    /**
     * FUN√á√ÉO PRINCIPAL: Criar pr√©-separa√ß√£o com dados edit√°veis
     * Implementada para corrigir gap identificado na an√°lise
     */
    async function criarPreSeparacao(itemId, numPedido) {
        try {
            // Buscar dados do item da linha atual
            const linha = document.querySelector(`tr[data-item-id="${itemId}"]`);
            if (!linha) {
                throw new Error('Item n√£o encontrado na tabela');
            }

            // Obter dados dos campos da linha
            const qtdInput = linha.querySelector('.qtd-dropdown');
            const dataExpedicaoInput = linha.querySelector('.data-expedicao-dropdown');
            const agendamentoInput = linha.querySelector('.agendamento-dropdown');
            const protocoloInput = linha.querySelector('.protocolo-dropdown');

            const qtdPreSeparacao = parseFloat(qtdInput?.value || 0);
            const dataExpedicao = dataExpedicaoInput?.value;
            const agendamento = agendamentoInput?.value;
            const protocolo = protocoloInput?.value;

            // Valida√ß√µes b√°sicas
            if (qtdPreSeparacao <= 0) {
                throw new Error('Quantidade deve ser maior que zero');
            }

            if (!dataExpedicao) {
                throw new Error('Data de expedi√ß√£o √© obrigat√≥ria');
            }

            // Confirmar com usu√°rio
            if (!confirm(`Criar pr√©-separa√ß√£o?\n\nQuantidade: ${qtdPreSeparacao}\nExpedi√ß√£o: ${dataExpedicao}\nAgendamento: ${agendamento || 'N√£o definido'}\nProtocolo: ${protocolo || 'N√£o definido'}`)) {
                return;
            }

            // Chamar API
            const response = await fetch(`/carteira/api/pedido/${numPedido}/criar-pre-separacao`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    item_id: itemId,
                    qtd_pre_separacao: qtdPreSeparacao,
                    data_expedicao: dataExpedicao,
                    data_agendamento: agendamento,
                    protocolo: protocolo,
                    tipo_envio: 'total'
                })
            });

            const result = await response.json();

            if (result.success) {
                showNotification(`Pr√©-separa√ß√£o criada com sucesso! ID: ${result.pre_separacao_id}`, 'success');

                // Recarregar dados do pedido
                if (window.recarregarItens) {
                    window.recarregarItens(numPedido);
                }
            } else {
                throw new Error(result.error || 'Erro desconhecido');
            }

        } catch (error) {
            console.error('‚ùå Erro ao criar pr√©-separa√ß√£o:', error);
            showNotification(`Erro ao criar pr√©-separa√ß√£o: ${error.message}`, 'error');
        }
    }

    /**
     * Editar pr√©-separa√ß√£o existente com modal
     */
    function editarPreSeparacaoCompleta(preSeparacaoId) {
        // Buscar dados atuais da pr√©-separa√ß√£o
        fetch(`/carteira/api/pre-separacao/${preSeparacaoId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Criar modal com dados atuais para edi√ß√£o
                    const modalHtml = `
                    <div class="modal fade" id="modalEditarPreSeparacao" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Editar Pr√©-Separa√ß√£o #${preSeparacaoId}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="formEditarPreSeparacao">
                                        <div class="mb-3">
                                            <label class="form-label">Quantidade</label>
                                            <input type="number" class="form-control" name="quantidade" 
                                                   value="${data.pre_separacao.qtd_selecionada_usuario}" step="0.001" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Data Expedi√ß√£o</label>
                                            <input type="date" class="form-control" name="data_expedicao" 
                                                   value="${data.pre_separacao.data_expedicao_editada || ''}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Agendamento</label>
                                            <input type="date" class="form-control" name="agendamento" 
                                                   value="${data.pre_separacao.data_agendamento_editada || ''}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Protocolo</label>
                                            <input type="text" class="form-control" name="protocolo" 
                                                   value="${data.pre_separacao.protocolo_editado || ''}">
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-primary" onclick="salvarEdicaoPreSeparacao(${preSeparacaoId})">Salvar</button>
                                </div>
                            </div>
                        </div>
                    </div>`;

                    // Remover modal anterior se existir
                    const modalAntigo = document.getElementById('modalEditarPreSeparacao');
                    if (modalAntigo) {
                        modalAntigo.remove();
                    }

                    // Adicionar novo modal
                    document.body.insertAdjacentHTML('beforeend', modalHtml);

                    // Mostrar modal
                    const modal = new bootstrap.Modal(document.getElementById('modalEditarPreSeparacao'));
                    modal.show();
                } else {
                    showNotification(`Erro ao buscar pr√©-separa√ß√£o: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('‚ùå Erro ao buscar pr√©-separa√ß√£o:', error);
                showNotification('Erro ao carregar dados da pr√©-separa√ß√£o', 'error');
            });
    }

    /**
     * Salvar edi√ß√µes da pr√©-separa√ß√£o
     */
    async function salvarEdicaoPreSeparacao(preSeparacaoId) {
        try {
            const form = document.getElementById('formEditarPreSeparacao');
            const formData = new FormData(form);

            const dados = {
                qtd_selecionada_usuario: parseFloat(formData.get('quantidade')),
                data_expedicao_editada: formData.get('data_expedicao'),
                data_agendamento_editada: formData.get('agendamento'),
                protocolo_editado: formData.get('protocolo')
            };

            // Validar campos obrigat√≥rios
            if (dados.qtd_selecionada_usuario <= 0) {
                throw new Error('Quantidade deve ser maior que zero');
            }

            // Salvar cada campo individualmente (usando API existente)
            for (const [campo, valor] of Object.entries(dados)) {
                if (valor !== null && valor !== '') {
                    const response = await fetch(`/carteira/api/pre-separacao/${preSeparacaoId}/editar`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                        },
                        body: JSON.stringify({
                            campo: campo,
                            valor: valor
                        })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(`Erro ao salvar ${campo}: ${result.error}`);
                    }
                }
            }

            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarPreSeparacao'));
            modal.hide();

            showNotification('Pr√©-separa√ß√£o atualizada com sucesso!', 'success');

            // Recarregar p√°gina para mostrar altera√ß√µes
            if (window.recarregarItens) {
                window.recarregarItens();
            }

        } catch (error) {
            console.error('‚ùå Erro ao salvar pr√©-separa√ß√£o:', error);
            showNotification(`Erro ao salvar: ${error.message}`, 'error');
        }
    }
</script>

<style>
    /* üé® CORRE√á√ÉO DE CONTRASTE - BADGES VIS√çVEIS */
    /* CORRIGIDO: CSS namespace para n√£o afetar Bootstrap global */
    .carteira-page .badge {
        font-weight: 500 !important;
        font-size: 0.75rem !important;
    }

    /* For√ßar contraste em badges secund√°rios */
    .badge-secondary {
        background-color: #495057 !important;
        color: white !important;
    }

    /* Garantir que badges em cabe√ßalhos verdes tenham contraste */
    .bg-success .badge {
        font-weight: 600 !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
    }

    /* Status do pedido sempre vis√≠vel */
    .pedido-row .badge {
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }

    /* Contadores do dropdown sempre vis√≠veis */
    [id^="contador-dropdown-"],
    [id^="contador-expedicao-dropdown-"],
    [id^="status-dropdown-"] {
        font-weight: 600 !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3) !important;
    }

    /* üì¶ ESTILOS ESPEC√çFICOS DO DROPDOWN SEPARA√á√ïES */

    /* √çcones de separa√ß√£o */
    .separacao-icon {
        transition: transform 0.2s ease;
        color: #17a2b8;
    }

    .separacao-icon:hover {
        transform: scale(1.1);
        color: #138496;
    }

    /* Cards de separa√ß√£o com borda azul */
    .separacoes-expandidas .card {
        box-shadow: 0 0.125rem 0.25rem rgba(23, 162, 184, 0.2) !important;
    }

    /* Header das separa√ß√µes */
    .separacoes-expandidas .card-header {
        border-bottom: 2px solid rgba(255, 255, 255, 0.3) !important;
    }

    /* Badges de separa√ß√£o sempre vis√≠veis */
    [id^="separacoes-badge-"] {
        font-weight: 600 !important;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
    }

    /* Tabela de separa√ß√µes */
    .separacoes-expandidas .table-responsive {
        border-radius: 0.375rem;
        overflow: hidden;
    }

    .separacoes-expandidas .table thead th {
        background-color: #343a40 !important;
        color: white !important;
        border: none !important;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .separacoes-expandidas .table tbody td {
        font-size: 0.85rem;
        vertical-align: middle;
        border-color: #dee2e6;
    }

    /* Status badges nas separa√ß√µes */
    .separacoes-expandidas .badge {
        font-weight: 500 !important;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2) !important;
    }

    /* Bot√µes de a√ß√£o nas separa√ß√µes */
    .separacoes-expandidas .btn-group-sm .btn {
        padding: 0.25rem 0.4rem;
        font-size: 0.75rem;
    }

    /* Anima√ß√£o suave no hover dos bot√µes */
    .separacoes-expandidas .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        transition: all 0.15s ease;
    }

    /* Resumo no final das separa√ß√µes */
    .separacoes-expandidas .alert-info {
        border-left: 4px solid #17a2b8;
        background-color: rgba(23, 162, 184, 0.05);
    }

    /* Totais na tabela de separa√ß√µes */
    .separacoes-expandidas tfoot th {
        background-color: #f8f9fa !important;
        border-top: 2px solid #17a2b8 !important;
        font-weight: 600 !important;
    }
</style>

{% endblock %}