{% extends "base.html" %}

{% block title %}Carteira Agrupada{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-layer-group text-primary"></i> 
            Carteira Agrupada por Pedidos
            {% if total_pedidos %}
                <span class="badge badge-primary">{{ total_pedidos }} pedidos</span>
            {% endif %}
        </h1>
        <div>
            <a href="{{ url_for('carteira.index') }}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
            <a href="{{ url_for('carteira.listar_principal') }}" class="btn btn-info btn-sm">
                <i class="fas fa-list"></i> Lista Detalhada
            </a>
        </div>
    </div>

    {% if pedidos %}
    <!-- Status da implementa√ß√£o -->
    <div class="alert alert-info">
        <strong>üîß Fase 1.1 - Query de Agrupamento Base</strong><br>
        Status: ‚úÖ Implementada e testando<br>
        Funcionalidade: Agrupamento por num_pedido com agrega√ß√µes conforme CARTEIRA.csv
    </div>

    <!-- Resultados Agrupados -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-table"></i> Pedidos Agrupados ({{ total_pedidos }} pedidos encontrados)
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable">
                    <thead>
                        <tr>
                            <th>Vendedor</th>
                            <th>Pedido</th>
                            <th>Cliente</th>
                            <th>Rota</th>
                            <th>Data Entrega</th>
                            <th>Informa√ß√µes</th>
                            <th>Saldo</th>
                            <th>Expedi√ß√£o / Agenda</th>
                            <th>Solicitar Agendamento</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in pedidos %}
                        <tr class="pedido-row" data-pedido="{{ pedido.num_pedido }}">
                            <!-- Vendedor / Equipe / Status -->
                            <td>
                                <strong>{{ pedido.vendedor or '' }}</strong>
                                {% if pedido.equipe_vendas %}
                                <br><small class="text-muted">{{ pedido.equipe_vendas }}</small>
                                {% endif %}
                                {% if pedido.status_pedido %}
                                <br><span class="badge badge-secondary badge-sm">{{ pedido.status_pedido }}</span>
                                {% endif %}
                            </td>
                            
                            <!-- Pedido / Data / Cliente Pedido -->
                            <td>
                                <button class="btn btn-link p-0 mr-2 btn-expandir" 
                                        onclick="togglePedidoItens('{{ pedido.num_pedido }}')"
                                        title="Expandir/Colapsar itens">
                                    <i class="fas fa-chevron-right expand-icon" id="icon-{{ pedido.num_pedido }}"></i>
                                </button>
                                <strong>{{ pedido.num_pedido }}</strong>
                                {% if pedido.data_pedido %}
                                <br><small class="text-muted">{{ pedido.data_pedido.strftime('%d/%m/%Y') }}</small>
                                {% endif %}
                                {% if pedido.pedido_cliente %}
                                <br><small class="text-info">PC: {{ pedido.pedido_cliente }}</small>
                                {% endif %}
                            </td>
                            
                            <!-- Cliente / CNPJ / UF/Cidade -->
                            <td>
                                <strong>{{ pedido.raz_social_red or '' }}</strong>
                                {% if pedido.cnpj_cpf %}
                                <br><small class="text-muted">{{ pedido.cnpj_cpf }}</small>
                                {% endif %}
                                {% if pedido.cod_uf and pedido.nome_cidade %}
                                <br><small class="text-primary">{{ pedido.nome_cidade }}/{{ pedido.cod_uf }}</small>
                                {% endif %}
                            </td>
                            
                            <!-- Rota / Sub-rota / Incoterm -->
                            <td>
                                {{ pedido.rota or '' }}
                                {% if pedido.sub_rota %}
                                <br><small class="text-muted">{{ pedido.sub_rota }}</small>
                                {% endif %}
                                {% if pedido.incoterm %}
                                <br><span class="badge" style="background-color: #17a2b8; color: white; cursor: pointer;" onclick="abrirModalEndereco('{{ pedido.num_pedido }}')">
                                    {{ pedido.incoterm }}
                                </span>
                                {% endif %}
                            </td>
                            
                            <!-- Data Entrega / Observa√ß√µes -->
                            <td>
                                {% if pedido.data_entrega_pedido %}
                                <strong>{{ pedido.data_entrega_pedido.strftime('%d/%m/%Y') }}</strong>
                                {% endif %}
                                {% if pedido.observ_ped_1 %}
                                <br><small class="text-muted" title="{{ pedido.observ_ped_1 }}">
                                    {{ pedido.observ_ped_1[:50] }}{% if pedido.observ_ped_1|length > 50 %}...{% endif %}
                                </small>
                                {% endif %}
                            </td>
                            
                            <!-- Informa√ß√µes (Valor/Peso/Pallet) -->
                            <td>
                                <strong>{{ pedido.valor_total|valor_br(0) }}</strong>
                                <br>{{ pedido.peso_total|peso_br }}
                                <br>{{ pedido.pallet_total|pallet_br }}
                                <br><span class="badge badge-info">{{ pedido.total_itens }} itens</span>
                            </td>
                            
                            <!-- Saldo (Total das separa√ß√µes sem NF) -->
                            <td>
                                <div class="text-center">
                                    <i class="fas fa-info-circle text-muted" title="Total das separa√ß√µes sem NF utilizando Separacao.qtd_saldo"></i>
                                    <br><small class="text-muted">Em desenvolvimento</small>
                                </div>
                            </td>
                            
                            <!-- Expedi√ß√£o / Agenda / Protocolo -->
                            <td>
                                {% if pedido.expedicao %}
                                <strong>üìÖ {{ pedido.expedicao.strftime('%d/%m/%Y') }}</strong>
                                {% endif %}
                                {% if pedido.agendamento %}
                                <br>üóìÔ∏è {{ pedido.agendamento.strftime('%d/%m/%Y') }}
                                {% endif %}
                                {% if pedido.protocolo %}
                                <br><small class="text-success">üìã {{ pedido.protocolo }}</small>
                                {% endif %}
                            </td>
                            
                            <!-- Solicitar Agendamento (4 bot√µes) -->
                            <td>
                                <div class="btn-group-vertical btn-group-sm" role="group">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="criarSeparacao('{{ pedido.num_pedido }}')" title="Criar Separa√ß√£o">
                                        üì¶ Criar Separa√ß√£o
                                    </button>
                                    
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-toggle="dropdown" title="Consultar Separa√ß√µes">
                                            üìã Consultar
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="#" onclick="consultarSeparacoes('{{ pedido.num_pedido }}')">
                                                üì¶ Ver Separa√ß√µes
                                            </a>
                                            <a class="dropdown-item" href="#" onclick="calcularEstoqueD0D7('{{ pedido.num_pedido }}')">
                                                üìä Estoque D0/D7
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-warning btn-sm dropdown-toggle" data-toggle="dropdown" title="Avaliar Itens">
                                            üîç Avaliar
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="#" onclick="abrirModalAvaliarItens('{{ pedido.num_pedido }}')">
                                                üìã Avaliar Itens
                                            </a>
                                            <a class="dropdown-item" href="#" onclick="calcularEstoqueD0D7('{{ pedido.num_pedido }}')">
                                                üìä Estoque D0/D7
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-success btn-sm" onclick="solicitarAgendamento('{{ pedido.num_pedido }}')" title="Solicitar Agendamento">
                                        üóìÔ∏è Agendar
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <!-- Linha expandida para itens do pedido (inicialmente oculta) -->
                        <tr class="itens-expandidos collapse" id="itens-{{ pedido.num_pedido }}">
                            <td colspan="9">
                                <div class="card mt-2 mb-2">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-list"></i> 
                                            Itens do Pedido {{ pedido.num_pedido }}
                                            <span class="badge badge-info ml-2" id="badge-{{ pedido.num_pedido }}">
                                                Carregando...
                                            </span>
                                        </h6>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="loading-{{ pedido.num_pedido }}" class="text-center p-3">
                                            <i class="fas fa-spinner fa-spin"></i> Carregando itens...
                                        </div>
                                        <div id="content-{{ pedido.num_pedido }}" style="display: none;">
                                            <!-- Conte√∫do ser√° carregado via AJAX -->
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Debug Info -->
    <div class="card shadow mt-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-secondary">
                <i class="fas fa-bug"></i> Informa√ß√µes de Debug
            </h6>
        </div>
        <div class="card-body">
            <p><strong>Total de pedidos agrupados:</strong> {{ total_pedidos }}</p>
            <p><strong>Campos agregados sendo calculados:</strong></p>
            <ul>
                <li>valor_total = SUM(qtd_saldo_produto_pedido * preco_produto_pedido)</li>
                <li>peso_total = SUM(qtd_saldo_produto_pedido * CadastroPalletizacao.peso_bruto)</li>
                <li>pallet_total = SUM(qtd_saldo_produto_pedido / CadastroPalletizacao.palletizacao)</li>
                <li>total_itens = COUNT(id)</li>
            </ul>
            <p><strong>Status da implementa√ß√£o:</strong> ‚úÖ Query base funcionando, pr√≥ximo: calcular_saida_periodo()</p>
        </div>
    </div>

    {% else %}
    <!-- Sem dados -->
    <div class="card shadow mb-4">
        <div class="card-body text-center">
            <i class="fas fa-inbox fa-3x text-gray-300 mb-3"></i>
            <h5 class="text-gray-500">Nenhum pedido encontrado</h5>
            <p class="text-gray-400">
                {% if not pedidos %}
                Verifique se existem dados na carteira principal ou se houve erro na query.
                {% else %}
                Os filtros aplicados n√£o retornaram resultados.
                {% endif %}
            </p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Agendamento -->
<div class="modal fade" id="modalAgendamento" tabindex="-1" role="dialog" aria-labelledby="modalAgendamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAgendamentoLabel">
                    <i class="fas fa-calendar-plus"></i> Solicitar Agendamento
                    <span id="modal-agendamento-pedido" class="badge badge-primary ml-2"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Loading state -->
                <div id="modal-agendamento-loading" class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando dados do pedido...</p>
                </div>
                
                <!-- Error state -->
                <div id="modal-agendamento-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="modal-agendamento-error-message"></span>
                </div>
                
                <!-- Form content -->
                <div id="modal-agendamento-content" style="display: none;">
                    <form id="form-agendamento">
                        <input type="hidden" id="agendamento-num-pedido" name="num_pedido">
                        
                        <!-- Resumo do pedido -->
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-box"></i> Resumo do Pedido
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Cliente:</strong>
                                        <div id="agendamento-cliente">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Total de Itens:</strong>
                                        <div id="agendamento-total-itens">0</div>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Valor Total:</strong>
                                        <div id="agendamento-valor-total">R$ 0,00</div>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Peso Total:</strong>
                                        <div id="agendamento-peso-total">0 kg</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Formul√°rio de agendamento -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="data_agendamento" class="form-label">
                                    <strong>Data do Agendamento:</strong>
                                </label>
                                <input type="date" class="form-control" id="data_agendamento" name="data_agendamento" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="hora_agendamento" class="form-label">
                                    <strong>Hor√°rio:</strong>
                                </label>
                                <input type="time" class="form-control" id="hora_agendamento" name="hora_agendamento">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="data_expedicao" class="form-label">
                                    <strong>Data de Expedi√ß√£o:</strong>
                                </label>
                                <input type="date" class="form-control" id="data_expedicao" name="data_expedicao">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="protocolo_agendamento" class="form-label">
                                    <strong>Protocolo:</strong>
                                </label>
                                <input type="text" class="form-control" id="protocolo_agendamento" name="protocolo" placeholder="Protocolo do agendamento">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="observacoes_agendamento" class="form-label">
                                <strong>Observa√ß√µes:</strong>
                            </label>
                            <textarea class="form-control" id="observacoes_agendamento" name="observacoes" rows="3" placeholder="Observa√ß√µes sobre o agendamento..."></textarea>
                        </div>
                        
                        <!-- Checkbox Agenda Confirmada -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agenda_confirmada" name="agenda_confirmada">
                                <label class="form-check-label" for="agenda_confirmada">
                                    <strong>Agenda Confirmada</strong>
                                    <br><small class="text-muted">Marque se o agendamento j√° foi confirmado com o cliente</small>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Itens do pedido (formata√ß√£o CORRETA) -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-list"></i> Itens do Pedido
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th>C√≥digo</th>
                                                <th>Produto</th>
                                                <th>Qtd</th>
                                                <th>Valor</th>
                                                <th>Peso</th>
                                                <th>Pallet</th>
                                            </tr>
                                        </thead>
                                        <tbody id="agendamento-tbody-itens">
                                            <!-- Itens ser√£o carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="salvarAgendamento()">
                    <i class="fas fa-save"></i> Salvar Agendamento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Estoque D0/D7 -->
<div class="modal fade" id="modalEstoqueD0D7" tabindex="-1" role="dialog" aria-labelledby="modalEstoqueD0D7Label" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEstoqueD0D7Label">
                    <i class="fas fa-chart-bar"></i> An√°lise de Estoque D0/D7
                    <span id="modal-estoque-pedido" class="badge badge-primary ml-2"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Loading state -->
                <div id="modal-estoque-loading" class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Calculando proje√ß√£o de estoque...</p>
                </div>
                
                <!-- Content -->
                <div id="modal-estoque-content" style="display: none;">
                    <!-- Resumo de alertas -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card border-danger">
                                <div class="card-body text-center">
                                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                                    <h5 class="mt-2">D0 - Ruptura Hoje</h5>
                                    <h3 class="text-danger" id="resumo-problemas-d0">0</h3>
                                    <small class="text-muted">Itens com falta hoje</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <i class="fas fa-clock fa-2x text-warning"></i>
                                    <h5 class="mt-2">D1-D7 - Ruptura 7 dias</h5>
                                    <h3 class="text-warning" id="resumo-problemas-d7">0</h3>
                                    <small class="text-muted">Itens com falta pr√≥ximos 7 dias</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <i class="fas fa-check-circle fa-2x text-success"></i>
                                    <h5 class="mt-2">Estoque OK</h5>
                                    <h3 class="text-success" id="resumo-estoque-ok">0</h3>
                                    <small class="text-muted">Itens com estoque adequado</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Legenda -->
                    <div class="alert alert-info">
                        <strong>üìä Legenda:</strong>
                        <span class="badge badge-danger ml-2">CR√çTICO</span> Ruptura hoje (D0)
                        <span class="badge badge-warning ml-2">BAIXO</span> Estoque baixo (‚â§10)
                        <span class="badge badge-info ml-2">NORMAL</span> Estoque adequado
                        <span class="badge badge-success ml-2">ALTO</span> Estoque alto (>50)
                    </div>
                    
                    <!-- Tabela de itens -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">An√°lise Detalhada por Item</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>C√≥digo</th>
                                            <th>Produto</th>
                                            <th>Qtd Pedido</th>
                                            <th>Estoque D0</th>
                                            <th>Estoque D7</th>
                                            <th>Status</th>
                                            <th>A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody id="estoque-tbody-itens">
                                        <!-- Itens ser√£o carregados via AJAX -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
                <button type="button" class="btn btn-primary" onclick="exportarAnaliseEstoque()">
                    <i class="fas fa-download"></i> Exportar An√°lise
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalhes do Endere√ßo - C√ìPIA EXATA DA CARTEIRA PRINCIPAL -->
<div class="modal fade" id="modalEndereco" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-map-marker-alt"></i> Detalhes do Endere√ßo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-user"></i> Cliente</h6>
                        <ul class="list-unstyled">
                            <li><strong>UF:</strong> <span id="modal_cliente_uf"></span></li>
                            <li><strong>Munic√≠pio:</strong> <span id="modal_cliente_municipio"></span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-shipping-fast"></i> Endere√ßo de Entrega</h6>
                        <ul class="list-unstyled">
                            <li><strong>CNPJ:</strong> <span id="modal_cnpj_endereco"></span></li>
                            <li><strong>Empresa:</strong> <span id="modal_empresa_endereco"></span></li>
                            <li><strong>UF:</strong> <span id="modal_uf_endereco"></span></li>
                            <li><strong>Munic√≠pio:</strong> <span id="modal_municipio_endereco"></span></li>
                            <li><strong>Bairro:</strong> <span id="modal_bairro_endereco"></span></li>
                            <li><strong>CEP:</strong> <span id="modal_cep_endereco"></span></li>
                            <li><strong>Rua:</strong> <span id="modal_rua_endereco"></span></li>
                            <li><strong>Telefone:</strong> <span id="modal_telefone_endereco"></span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Avaliar Itens -->
<div class="modal fade" id="modalAvaliarItens" tabindex="-1" role="dialog" aria-labelledby="modalAvaliarItensLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAvaliarItensLabel">
                    <i class="fas fa-edit"></i> Avaliar Itens do Pedido
                    <span id="modal-num-pedido" class="badge badge-primary ml-2"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Loading state -->
                <div id="modal-loading" class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando itens para avalia√ß√£o...</p>
                </div>
                
                <!-- Error state -->
                <div id="modal-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="modal-error-message"></span>
                    <button class="btn btn-sm btn-outline-danger ml-2" onclick="recarregarModalItens()">
                        <i class="fas fa-redo"></i> Tentar novamente
                    </button>
                </div>
                
                <!-- Form content -->
                <div id="modal-content" style="display: none;">
                    <form id="form-avaliar-itens">
                        <input type="hidden" id="form-num-pedido" name="num_pedido">
                        
                        <!-- Resumo do pedido -->
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle"></i> Resumo do Pedido
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Total de Itens:</strong>
                                        <span id="resumo-total-itens" class="badge badge-info">0</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Valor Total:</strong>
                                        <span id="resumo-valor-total">R$ 0,00</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Peso Total:</strong>
                                        <span id="resumo-peso-total">0 kg</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Selecionados:</strong>
                                        <span id="resumo-selecionados" class="badge badge-warning">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- üéØ ETAPA 2: DROPDOWN TIPO DE ENVIO (IMPLEMENTADO) -->
                        <div class="card border-primary mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-shipping-fast"></i> Configura√ß√£o do Tipo de Envio
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="tipo_envio" class="form-label">
                                            <strong>Tipo de Envio:</strong>
                                        </label>
                                        <select class="form-control" id="tipo_envio" name="tipo_envio" onchange="atualizarTipoEnvio()">
                                            <option value="total">üì¶ Envio Total</option>
                                            <option value="parcial">üìã Envio Parcial</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8">
                                        <div id="explicacao_tipo_envio">
                                            <div id="explicacao_total" class="alert alert-success mb-0">
                                                <strong>üì¶ Envio Total:</strong> Todos os itens selecionados ser√£o enviados em uma √∫nica separa√ß√£o completa. Ideal para pedidos que podem ser entregues integralmente.
                                            </div>
                                            <div id="explicacao_parcial" class="alert alert-warning mb-0" style="display: none;">
                                                <strong>üìã Envio Parcial:</strong> Apenas parte dos itens ser√° enviada agora, o restante ficar√° para pr√≥ximos envios. Configure os motivos e justificativas abaixo.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Campos espec√≠ficos para Envio Parcial -->
                                <div id="campos_envio_parcial" style="display: none;">
                                    <hr>
                                    <h6 class="text-muted mb-3">
                                        <i class="fas fa-edit"></i> Configura√ß√µes do Envio Parcial
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="motivo_parcial" class="form-label">Motivo do Envio Parcial:</label>
                                            <select class="form-control" id="motivo_parcial" name="motivo_parcial">
                                                <option value="">Selecionar motivo...</option>
                                                <option value="ruptura_estoque">üî¥ Ruptura de Estoque</option>
                                                <option value="capacidade_transporte">üöõ Limita√ß√£o de Transporte</option>
                                                <option value="prazo_cliente">‚è∞ Urg√™ncia do Cliente</option>
                                                <option value="producao_andamento">üè≠ Produ√ß√£o em Andamento</option>
                                                <option value="estrategia_comercial">üíº Estrat√©gia Comercial</option>
                                                <option value="outros">‚ùì Outros</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="justificativa_parcial" class="form-label">Justificativa Detalhada:</label>
                                            <textarea class="form-control" id="justificativa_parcial" name="justificativa_parcial" 
                                                      rows="2" placeholder="Descreva o motivo espec√≠fico do envio parcial..."></textarea>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="previsao_complemento" class="form-label">Previs√£o para Complemento:</label>
                                            <input type="date" class="form-control" id="previsao_complemento" name="previsao_complemento">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="responsavel_aprovacao" class="form-label">Respons√°vel pela Aprova√ß√£o:</label>
                                            <input type="text" class="form-control" id="responsavel_aprovacao" name="responsavel_aprovacao" 
                                                   placeholder="Nome do respons√°vel..." value="{{ current_user.nome if current_user else '' }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Instru√ß√µes -->
                        <div class="alert alert-info">
                            <strong>üìã Instru√ß√µes:</strong>
                            <ul class="mb-0 mt-2">
                                <li>üéØ <strong>Configure o tipo de envio</strong> acima antes de selecionar itens</li>
                                <li>‚úÖ <strong>Selecione</strong> os itens que deseja incluir na separa√ß√£o</li>
                                <li>‚úèÔ∏è <strong>Edite</strong> quantidades (n√£o pode exceder o dispon√≠vel)</li>
                                <li>üìÖ <strong>Ajuste</strong> datas de expedi√ß√£o e agendamento conforme necess√°rio</li>
                                <li>üìù <strong>Adicione</strong> protocolo se necess√°rio</li>
                                <li>üí° <strong>Quantidade parcial</strong> criar√° nova linha com saldo restante</li>
                            </ul>
                        </div>
                        
                        <!-- Tabela de itens edit√°veis -->
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabela-itens-modal">
                                <thead class="thead-dark">
                                    <tr>
                                        <th width="40">
                                            <input type="checkbox" id="select-all-itens" onchange="toggleTodosItens(this)">
                                        </th>
                                        <th>C√≥digo</th>
                                        <th>Produto</th>
                                        <th>Qtd Dispon√≠vel</th>
                                        <th>Qtd Selecionada</th>
                                        <th>Valor Unit.</th>
                                        <th>Expedi√ß√£o</th>
                                        <th>Agendamento</th>
                                        <th>Protocolo</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-itens-modal">
                                    <!-- Ser√° preenchido via JavaScript -->
                                </tbody>
                                <tfoot class="bg-light">
                                    <tr>
                                        <th colspan="4">TOTAIS SELECIONADOS:</th>
                                        <th id="total-qtd-selecionada">0</th>
                                        <th></th>
                                        <th colspan="4">
                                            <span id="total-valor-selecionado">R$ 0,00</span>
                                        </th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btn-salvar-avaliacoes" onclick="salvarAvaliacoes()">
                    <i class="fas fa-save"></i> Salvar Avalia√ß√µes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Consultar Separa√ß√µes -->
<div class="modal fade" id="modalConsultarSeparacoes" tabindex="-1" role="dialog" aria-labelledby="modalConsultarSeparacoesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConsultarSeparacoesLabel">
                    <i class="fas fa-boxes"></i> Separa√ß√µes do Pedido
                    <span id="modal-separacoes-pedido" class="badge badge-primary ml-2"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Loading state -->
                <div id="modal-separacoes-loading" class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando separa√ß√µes...</p>
                </div>
                
                <!-- Error state -->
                <div id="modal-separacoes-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="modal-separacoes-error-message"></span>
                    <button class="btn btn-sm btn-outline-danger ml-2" onclick="recarregarModalSeparacoes()">
                        <i class="fas fa-redo"></i> Tentar novamente
                    </button>
                </div>
                
                <!-- Empty state -->
                <div id="modal-separacoes-empty" class="text-center p-5" style="display: none;">
                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhuma separa√ß√£o encontrada</h5>
                    <p class="text-muted">Este pedido ainda n√£o possui separa√ß√µes criadas.</p>
                </div>
                
                <!-- Content -->
                <div id="modal-separacoes-content" style="display: none;">
                    <!-- Resumo das separa√ß√µes -->
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-bar"></i> Resumo das Separa√ß√µes
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Total de Separa√ß√µes:</strong>
                                    <span id="resumo-total-separacoes" class="badge badge-info">0</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Embarcadas:</strong>
                                    <span id="resumo-separacoes-embarcadas" class="badge badge-success">0</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Pendentes:</strong>
                                    <span id="resumo-separacoes-pendentes" class="badge badge-warning">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de separa√ß√µes -->
                    <div class="table-responsive">
                        <table class="table table-striped" id="tabela-separacoes">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Lote ID</th>
                                    <th>Status</th>
                                    <th>Criada em</th>
                                    <th>Embarque</th>
                                    <th>Transportadora</th>
                                    <th>Prev. Embarque</th>
                                    <th>Data Embarque</th>
                                    <th>Valor</th>
                                    <th>Peso</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-separacoes">
                                <!-- Ser√° preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
                <button type="button" class="btn btn-primary" onclick="criarNovaSeparacao()">
                    <i class="fas fa-plus"></i> Nova Separa√ß√£o
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Estoque D0/D7 -->
<div class="modal fade" id="modalEstoqueD0D7" tabindex="-1" role="dialog" aria-labelledby="modalEstoqueD0D7Label" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEstoqueD0D7Label">
                    <i class="fas fa-warehouse"></i> Estoque D0/D7 - Pedido
                    <span id="modal-estoque-pedido" class="badge badge-primary ml-2"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Loading state -->
                <div id="modal-estoque-loading" class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Calculando estoque D0/D7...</p>
                </div>
                
                <!-- Error state -->
                <div id="modal-estoque-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="modal-estoque-error-message"></span>
                    <button class="btn btn-sm btn-outline-danger ml-2" onclick="recarregarModalEstoque()">
                        <i class="fas fa-redo"></i> Tentar novamente
                    </button>
                </div>
                
                <!-- Content -->
                <div id="modal-estoque-content" style="display: none;">
                    <!-- Resumo das estat√≠sticas -->
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-pie"></i> Resumo do Estoque
                                <small class="float-right" id="estoque-data-calculo"></small>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Total de Produtos:</strong>
                                    <span id="resumo-total-produtos" class="badge badge-info">0</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Ruptura D0:</strong>
                                    <span id="resumo-ruptura-d0" class="badge badge-danger">0</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Problemas D7:</strong>
                                    <span id="resumo-problemas-d7" class="badge badge-warning">0</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Menor Estoque:</strong>
                                    <span id="resumo-menor-estoque" class="badge badge-secondary">0</span>
                                </div>
                            </div>
                            <div class="row mt-2" id="alerta-ruptura" style="display: none;">
                                <div class="col-12">
                                    <div class="alert alert-danger mb-0">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>ATEN√á√ÉO:</strong> Ruptura prevista em 
                                        <span id="dias-ruptura"></span> dias!
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Legenda -->
                    <div class="alert alert-info">
                        <strong>üìä Legenda:</strong>
                        <span class="badge badge-success ml-2">NORMAL</span> Estoque OK
                        <span class="badge badge-warning ml-2">BAIXO</span> Estoque baixo (‚â§10)
                        <span class="badge badge-danger ml-2">RUPTURA</span> Sem estoque (‚â§0)
                        <span class="badge badge-secondary ml-2">SEM_DADOS</span> Produto sem dados
                    </div>
                    
                    <!-- Tabela de produtos -->
                    <div class="table-responsive">
                        <table class="table table-striped" id="tabela-estoque-produtos">
                            <thead class="thead-dark">
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Produto</th>
                                    <th>Qtd Pedido</th>
                                    <th>Estoque D0</th>
                                    <th>Status D0</th>
                                    <th>Menor D7</th>
                                    <th>Status D7</th>
                                    <th>Suficiente?</th>
                                    <th>Proje√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-estoque-produtos">
                                <!-- Ser√° preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
                <button type="button" class="btn btn-info" onclick="exportarDadosEstoque()">
                    <i class="fas fa-download"></i> Exportar Dados
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para expandir/colapsar itens -->
<script>
// Estado de expans√£o dos pedidos (cache local)
const pedidosExpandidos = new Set();
const itensPedidoCache = new Map();

/**
 * Toggle expans√£o/colapso de itens de um pedido
 * Implementa√ß√£o: Fase 2.2 - JavaScript Expandir/Colapsar
 */
function togglePedidoItens(numPedido) {
    const linhaItens = document.getElementById(`itens-${numPedido}`);
    const icone = document.getElementById(`icon-${numPedido}`);
    
    if (pedidosExpandidos.has(numPedido)) {
        // Colapsar
        $(linhaItens).collapse('hide');
        icone.className = 'fas fa-chevron-right expand-icon';
        pedidosExpandidos.delete(numPedido);
    } else {
        // Expandir
        $(linhaItens).collapse('show');
        icone.className = 'fas fa-chevron-down expand-icon';
        pedidosExpandidos.add(numPedido);
        
        // Carregar itens se ainda n√£o foram carregados
        if (!itensPedidoCache.has(numPedido)) {
            carregarItensPedido(numPedido);
        }
    }
}

/**
 * Carrega itens de um pedido via AJAX
 */
async function carregarItensPedido(numPedido) {
    const loadingDiv = document.getElementById(`loading-${numPedido}`);
    const contentDiv = document.getElementById(`content-${numPedido}`);
    const badge = document.getElementById(`badge-${numPedido}`);
    
    try {
        // Mostrar loading
        loadingDiv.style.display = 'block';
        contentDiv.style.display = 'none';
        badge.textContent = 'Carregando...';
        badge.className = 'badge badge-info ml-2';
        
        // Fazer requisi√ß√£o AJAX
        const response = await fetch(`/carteira/api/pedido/${numPedido}/itens`);
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Erro ao carregar itens');
        }
        
        // Armazenar no cache
        itensPedidoCache.set(numPedido, data);
        
        // Gerar HTML dos itens
        const htmlItens = gerarHtmlItens(data);
        contentDiv.innerHTML = htmlItens;
        
        // Atualizar badge
        badge.textContent = `${data.total_itens} itens`;
        badge.className = 'badge badge-success ml-2';
        
        // Mostrar conte√∫do
        loadingDiv.style.display = 'none';
        contentDiv.style.display = 'block';
        
        console.log(`‚úÖ Itens carregados para pedido ${numPedido}: ${data.total_itens} itens`);
        
    } catch (error) {
        console.error(`‚ùå Erro ao carregar itens do pedido ${numPedido}:`, error);
        
        // Mostrar erro
        contentDiv.innerHTML = `
            <div class="alert alert-danger m-3">
                <i class="fas fa-exclamation-triangle"></i>
                Erro ao carregar itens: ${error.message}
                <button class="btn btn-sm btn-outline-danger ml-2" onclick="carregarItensPedido('${numPedido}')">
                    <i class="fas fa-redo"></i> Tentar novamente
                </button>
            </div>
        `;
        
        badge.textContent = 'Erro';
        badge.className = 'badge badge-danger ml-2';
        
        loadingDiv.style.display = 'none';
        contentDiv.style.display = 'block';
    }
}

/**
 * Gera HTML da tabela de itens
 */
function gerarHtmlItens(data) {
    let html = `
        <div class="table-responsive">
            <table class="table table-sm table-striped mb-0">
                <thead class="thead-light">
                    <tr>
                        <th>C√≥digo</th>
                        <th>Produto</th>
                        <th>Qtd</th>
                        <th>Pre√ßo</th>
                        <th>Valor</th>
                        <th>Peso</th>
                        <th>Pallet</th>
                        <th>Expedi√ß√£o</th>
                        <th>Agenda</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.itens.forEach(item => {
        const statusClass = item.tem_separacao ? 'success' : 'warning';
        const statusText = item.tem_separacao ? 'Separado' : 'Pendente';
        const statusIcon = item.tem_separacao ? 'check-circle' : 'clock';
        
        html += `
            <tr>
                <td><small>${item.cod_produto}</small></td>
                <td><small>${item.nome_produto || ''}</small></td>
                <td><strong>${item.qtd_saldo_formatado}</strong></td>
                <td>R$ ${item.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td><strong>${item.valor_item_formatado}</strong></td>
                <td>${item.peso_item_formatado}</td>
                <td>${item.pallet_item_formatado}</td>
                <td>${item.expedicao || '-'}</td>
                <td>${item.agendamento || '-'}</td>
                <td>
                    <span class="badge ${item.tem_separacao ? 'badge-success' : 'badge-warning'}" style="${item.tem_separacao ? 'background-color: #28a745; color: white;' : 'background-color: #ffc107; color: black;'}">
                        <i class="fas fa-${statusIcon}"></i> ${statusText}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="editarItem(${item.id})" 
                            title="Editar item">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
                <tfoot class="bg-light">
                    <tr>
                        <th colspan="4">TOTAIS:</th>
                        <th>R$ ${data.totais.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</th>
                        <th>${Math.round(data.totais.peso).toLocaleString('pt-BR')} kg</th>
                        <th>${data.totais.pallet.toLocaleString('pt-BR', {minimumFractionDigits: 1, maximumFractionDigits: 1})} pal</th>
                        <th colspan="4">
                            <small class="text-muted">
                                ${data.itens_separados}/${data.total_itens} separados
                            </small>
                        </th>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;
    
    return html;
}

/**
 * Placeholder para editar item - agora redireciona para modal
 */
function editarItem(itemId) {
    // Buscar o pedido do item para abrir modal
    const pedidoRow = document.querySelector(`tr[data-pedido]`);
    if (pedidoRow) {
        const numPedido = pedidoRow.getAttribute('data-pedido');
        abrirModalAvaliarItens(numPedido);
    }
}

// ===== FUN√á√ïES DO MODAL AVALIAR ITENS =====

// Vari√°veis globais do modal
let dadosModalAtual = null;
let numPedidoModal = null;

/**
 * Abre modal para avaliar itens de um pedido
 * Implementa√ß√£o: Fase 2.3 - Modal Avaliar Itens
 */
async function abrirModalAvaliarItens(numPedido) {
    numPedidoModal = numPedido;
    
    // Configurar modal
    document.getElementById('modal-num-pedido').textContent = numPedido;
    document.getElementById('form-num-pedido').value = numPedido;
    
    // Mostrar modal
    $('#modalAvaliarItens').modal('show');
    
    // Carregar dados
    await carregarDadosModal(numPedido);
}

/**
 * Carrega dados dos itens para o modal
 */
async function carregarDadosModal(numPedido) {
    const modalLoading = document.getElementById('modal-loading');
    const modalError = document.getElementById('modal-error');
    const modalContent = document.getElementById('modal-content');
    
    try {
        // Mostrar loading
        modalLoading.style.display = 'block';
        modalError.style.display = 'none';
        modalContent.style.display = 'none';
        
        // Verificar se j√° temos os dados no cache
        let data = itensPedidoCache.get(numPedido);
        
        if (!data) {
            // Fazer requisi√ß√£o AJAX
            const response = await fetch(`/carteira/api/pedido/${numPedido}/itens`);
            data = await response.json();
            
            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Erro ao carregar itens');
            }
            
            // Armazenar no cache
            itensPedidoCache.set(numPedido, data);
        }
        
        // Armazenar dados para uso no modal
        dadosModalAtual = data;
        
        // Gerar HTML dos itens edit√°veis
        gerarHtmlItensModal(data);
        
        // Atualizar resumo
        atualizarResumoModal(data);
        
        // Mostrar conte√∫do
        modalLoading.style.display = 'none';
        modalContent.style.display = 'block';
        
        console.log(`‚úÖ Modal carregado para pedido ${numPedido}: ${data.total_itens} itens`);
        
    } catch (error) {
        console.error(`‚ùå Erro ao carregar modal do pedido ${numPedido}:`, error);
        
        // Mostrar erro
        document.getElementById('modal-error-message').textContent = error.message;
        modalLoading.style.display = 'none';
        modalError.style.display = 'block';
        modalContent.style.display = 'none';
    }
}

/**
 * Gera HTML da tabela de itens edit√°veis no modal
 */
function gerarHtmlItensModal(data) {
    const tbody = document.getElementById('tbody-itens-modal');
    let html = '';
    
    data.itens.forEach((item, index) => {
        const disabled = item.tem_separacao ? 'disabled' : '';
        const checkboxDisabled = item.tem_separacao ? 'disabled' : '';
        const statusClass = item.tem_separacao ? 'success' : 'warning';
        const statusText = item.tem_separacao ? 'Separado' : 'Pendente';
        
        html += `
            <tr id="row-item-${item.id}" ${item.tem_separacao ? 'class="table-secondary"' : ''}>
                <td>
                    <input type="checkbox" 
                           class="item-checkbox" 
                           data-item-id="${item.id}"
                           data-index="${index}"
                           onchange="calcularTotaisModal()"
                           ${checkboxDisabled}>
                </td>
                <td><small><strong>${item.cod_produto}</strong></small></td>
                <td><small>${item.nome_produto || ''}</small></td>
                <td><strong>${item.qtd_saldo_formatado}</strong></td>
                <td>
                    <input type="number" 
                           class="form-control form-control-sm qtd-input" 
                           data-item-id="${item.id}"
                           data-max="${item.qtd_saldo}"
                           data-preco="${item.preco}"
                           data-peso-unitario="${item.peso_item / item.qtd_saldo || 0}"
                           data-pallet-unitario="${item.pallet_item / item.qtd_saldo || 0}"
                           step="1"
                           min="0"
                           max="${item.qtd_saldo}"
                           value="${Math.round(item.qtd_saldo)}"
                           placeholder="${Math.round(item.qtd_saldo)}"
                           onchange="validarQuantidade(this); calcularTotaisModal(); atualizarCalculosItem(this)"
                           oninput="atualizarCalculosItem(this)"
                           ${disabled}>
                    <small class="text-muted">Qtd edit√°vel - auto-c√°lculo valor/peso/pallet</small>
                </td>
                <td>
                    <span class="valor-calculado">R$ ${item.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    <input type="hidden" class="valor-original" value="${item.preco}">
                </td>
                <td>
                    <input type="date" 
                           class="form-control form-control-sm" 
                           data-item-id="${item.id}"
                           data-field="expedicao"
                           value="${item.expedicao}"
                           ${disabled}>
                </td>
                <td>
                    <input type="date" 
                           class="form-control form-control-sm" 
                           data-item-id="${item.id}"
                           data-field="agendamento"
                           value="${item.agendamento}"
                           ${disabled}>
                </td>
                <td>
                    <input type="text" 
                           class="form-control form-control-sm" 
                           data-item-id="${item.id}"
                           data-field="protocolo"
                           value="${item.protocolo}"
                           placeholder="Protocolo"
                           ${disabled}>
                </td>
                <td>
                    <span class="badge ${item.tem_separacao ? 'badge-success' : 'badge-warning'}" style="${item.tem_separacao ? 'background-color: #28a745; color: white;' : 'background-color: #ffc107; color: black;'}">
                        ${statusText}
                    </span>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // Calcular totais iniciais
    calcularTotaisModal();
}

/**
 * Atualiza resumo do pedido no modal
 */
function atualizarResumoModal(data) {
    document.getElementById('resumo-total-itens').textContent = data.total_itens;
    document.getElementById('resumo-valor-total').textContent = `R$ ${data.totais.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('resumo-peso-total').textContent = `${Math.round(data.totais.peso).toLocaleString('pt-BR')} kg`;
    document.getElementById('resumo-selecionados').textContent = '0';
}

/**
 * üéØ AUTO-C√ÅLCULO CONFORME CARTEIRA.CSV
 * Atualiza c√°lculos de valor, peso e pallet quando quantidade √© alterada
 */
function atualizarCalculosItem(input) {
    const qtd = parseFloat(input.value) || 0;
    const preco = parseFloat(input.getAttribute('data-preco')) || 0;
    const pesoUnitario = parseFloat(input.getAttribute('data-peso-unitario')) || 0;
    const palletUnitario = parseFloat(input.getAttribute('data-pallet-unitario')) || 0;
    const itemId = input.getAttribute('data-item-id');
    
    // Calcular valores
    const valorTotal = qtd * preco;
    const pesoTotal = qtd * pesoUnitario;
    const palletTotal = qtd * palletUnitario;
    
    // Atualizar span de valor na mesma linha
    const row = input.closest('tr');
    const valorSpan = row.querySelector('.valor-calculado');
    if (valorSpan) {
        valorSpan.textContent = `R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
    
    // Adicionar colunas de peso e pallet calculados se n√£o existirem
    if (!row.querySelector('.peso-calculado')) {
        const valorCell = row.querySelector('.valor-calculado').parentElement;
        
        // Adicionar c√©lula de peso
        const pesoCell = document.createElement('td');
        pesoCell.innerHTML = `<span class="peso-calculado">${Math.round(pesoTotal).toLocaleString('pt-BR')} kg</span>`;
        valorCell.insertAdjacentElement('afterend', pesoCell);
        
        // Adicionar c√©lula de pallet  
        const palletCell = document.createElement('td');
        palletCell.innerHTML = `<span class="pallet-calculado">${palletTotal.toLocaleString('pt-BR', {minimumFractionDigits: 1, maximumFractionDigits: 1})} pal</span>`;
        pesoCell.insertAdjacentElement('afterend', palletCell);
    } else {
        // Atualizar c√©lulas existentes
        const pesoSpan = row.querySelector('.peso-calculado');
        const palletSpan = row.querySelector('.pallet-calculado');
        
        if (pesoSpan) {
            pesoSpan.textContent = `${Math.round(pesoTotal).toLocaleString('pt-BR')} kg`;
        }
        if (palletSpan) {
            palletSpan.textContent = `${palletTotal.toLocaleString('pt-BR', {minimumFractionDigits: 1, maximumFractionDigits: 1})} pal`;
        }
    }
    
    console.log(`üßÆ Auto-c√°lculo item ${itemId}: Qtd ${qtd} ‚Üí Valor ${valorTotal.toFixed(2)} | Peso ${pesoTotal.toFixed(0)} | Pallet ${palletTotal.toFixed(1)}`);
}

/**
 * üóìÔ∏è MODAL AGENDAMENTO - FUN√á√ïES IMPLEMENTADAS
 * 
 * ‚úÖ OTIMIZA√á√ïES APLICADAS (CodeRabbit):
 * - Cache de inst√¢ncias de modal para evitar recria√ß√£o desnecess√°ria
 * - Uso de getOrCreateInstance() quando dispon√≠vel (Bootstrap 5.2+)
 * - Fallback para getInstance() para compatibilidade com vers√µes anteriores
 */
function carregarDadosAgendamento(numPedido) {
    const modalLoading = document.getElementById('modal-agendamento-loading');
    const modalError = document.getElementById('modal-agendamento-error');
    const modalContent = document.getElementById('modal-agendamento-content');
    
    // Reset states
    modalLoading.style.display = 'block';
    modalError.style.display = 'none';
    modalContent.style.display = 'none';
    
    // Atualizar t√≠tulo
    document.getElementById('modal-agendamento-pedido').textContent = numPedido;
    document.getElementById('agendamento-num-pedido').value = numPedido;
    
    // Carregar dados via AJAX
    fetch(`/carteira/api/pedido/${numPedido}/itens`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Buscar informa√ß√µes do cliente (pegar do primeiro item)
                const clienteInfo = data.itens.length > 0 ? data.itens[0] : null;
                
                // Atualizar resumo com dados corretos
                document.getElementById('agendamento-cliente').textContent = 
                    clienteInfo ? (clienteInfo.nome_produto ? `Cliente do pedido ${numPedido}` : 'N/A') : 'N/A';
                document.getElementById('agendamento-total-itens').textContent = data.total_itens;
                document.getElementById('agendamento-valor-total').textContent = 
                    `R$ ${data.totais.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                document.getElementById('agendamento-peso-total').textContent = 
                    `${Math.round(data.totais.peso).toLocaleString('pt-BR')} kg`;
                
                // Carregar itens na tabela  
                gerarTabelaAgendamento(data);
                
                modalLoading.style.display = 'none';
                modalContent.style.display = 'block';
            } else {
                throw new Error(data.error || 'Erro ao carregar dados');
            }
        })
        .catch(error => {
            console.error('Erro ao carregar agendamento:', error);
            document.getElementById('modal-agendamento-error-message').textContent = error.message;
            modalLoading.style.display = 'none';
            modalError.style.display = 'block';
        });
}

function gerarTabelaAgendamento(data) {
    const tbody = document.getElementById('agendamento-tbody-itens');
    let html = '';
    
    data.itens.forEach(item => {
        html += `
            <tr>
                <td><small><strong>${item.cod_produto}</strong></small></td>
                <td><small>${item.nome_produto || ''}</small></td>
                <td><strong>${item.qtd_saldo_formatado}</strong></td>
                <td><strong>${item.valor_item_formatado}</strong></td>
                <td>${item.peso_item_formatado}</td>
                <td>${item.pallet_item_formatado}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

async function salvarAgendamento() {
    const form = document.getElementById('form-agendamento');
    const formData = new FormData(form);
    const numPedido = formData.get('num_pedido');
    
    // Validar campos obrigat√≥rios
    if (!formData.get('data_agendamento')) {
        alert('‚ö†Ô∏è Data do agendamento √© obrigat√≥ria');
        document.getElementById('data_agendamento').focus();
        return;
    }
    
    if (!numPedido) {
        alert('‚ö†Ô∏è N√∫mero do pedido n√£o encontrado');
        return;
    }
    
    // üîÑ IMPLEMENTA√á√ÉO REAL - CONECTAR √Ä API EXISTENTE
    const btnSalvar = document.querySelector('.modal-footer .btn-primary');
    const textoOriginal = btnSalvar.innerHTML;
    
    try {
        // Mostrar loading
        btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
        btnSalvar.disabled = true;
        
        // 1. Buscar primeiro item do pedido para obter item_id
        console.log(`üóìÔ∏è Buscando itens do pedido ${numPedido} para agendamento...`);
        
        const responseItens = await fetch(`/carteira/api/pedido/${numPedido}/itens`);
        const dataItens = await responseItens.json();
        
        if (!responseItens.ok || !dataItens.success || !dataItens.itens.length) {
            throw new Error(`Erro ao buscar itens do pedido: ${dataItens.error || 'Pedido sem itens'}`);
        }
        
        // Pegar o primeiro item (ser√° usado para aplicar a todos)
        const primeiroItem = dataItens.itens[0];
        const itemId = primeiroItem.id;
        
        console.log(`üóìÔ∏è Usando item ${itemId} para aplicar agendamento a todo o pedido ${numPedido}`);
        
        // 2. Preparar dados para API agendamento existente
        const dadosAgendamento = {
            data_agendamento: formData.get('data_agendamento'),
            data_entrega: formData.get('data_expedicao') || null, // Campo 'data_expedicao' vira 'data_entrega'
            hora_agendamento: formData.get('hora_agendamento') || null,
            protocolo: formData.get('protocolo') || null,
            observacoes: formData.get('observacoes') || null, // ‚úÖ CORRE√á√ÉO: Incluir observa√ß√µes
            agenda_confirmada: formData.get('agenda_confirmada') === 'on' || false,
            aplicar_todos: true // ‚úÖ SEMPRE aplicar a todos os itens do pedido
        };
        
        console.log('üóìÔ∏è Dados do agendamento:', dadosAgendamento);
        
        // 3. Chamar API real de agendamento
        const responseAgendamento = await fetch(`/carteira/item/${itemId}/agendamento`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            },
            body: JSON.stringify(dadosAgendamento)
        });
        
        const dataAgendamento = await responseAgendamento.json();
        
        if (!responseAgendamento.ok || !dataAgendamento.success) {
            throw new Error(dataAgendamento.error || 'Erro ao salvar agendamento');
        }
        
        // ‚úÖ SUCESSO
        console.log('‚úÖ Agendamento salvo com sucesso:', dataAgendamento);
        
        // Mostrar mensagem de sucesso
        alert(`‚úÖ ${dataAgendamento.message || 'Agendamento salvo com sucesso!'}`);
        
        // Fechar modal
        const modalElement = document.getElementById('modalAgendamento');
        // ‚úÖ OTIMIZA√á√ÉO: Usar getOrCreateInstance se dispon√≠vel (Bootstrap 5.2+), fallback para compatibilidade
        if (bootstrap.Modal.getOrCreateInstance) {
            bootstrap.Modal.getOrCreateInstance(modalElement).hide();
        } else {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }
        
        // Recarregar p√°gina para mostrar mudan√ßas
        setTimeout(() => {
            location.reload();
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå Erro ao salvar agendamento:', error);
        
        let mensagemErro = `‚ùå **ERRO AO SALVAR AGENDAMENTO**\n\n`;
        mensagemErro += `Detalhes: ${error.message}\n\n`;
        mensagemErro += `üìã Pedido: ${numPedido}\n`;
        mensagemErro += `üîß Verifique os dados e tente novamente.`;
        
        alert(mensagemErro);
        
    } finally {
        // Restaurar bot√£o
        btnSalvar.innerHTML = textoOriginal;
        btnSalvar.disabled = false;
    }
}

/**
 * üìä MODAL ESTOQUE D0/D7 - INTEGRA√á√ÉO REAL COM ESTOQUE.MODELS
 */
async function carregarEstoqueD0D7(numPedido) {
    const modalLoading = document.getElementById('modal-estoque-loading');
    const modalContent = document.getElementById('modal-estoque-content');
    
    // Reset states
    modalLoading.style.display = 'block';
    modalContent.style.display = 'none';
    
    // Atualizar t√≠tulo
    document.getElementById('modal-estoque-pedido').textContent = numPedido;
    
    try {
        console.log(`üìä Carregando an√°lise REAL de estoque D0/D7 para pedido ${numPedido}...`);
        
        // Carregar dados reais via API
        const response = await fetch(`/carteira/api/pedido/${numPedido}/estoque-d0-d7`);
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üìä Dados de estoque recebidos:', data);
        
        if (!data.success) {
            throw new Error(data.error || 'Erro ao carregar dados de estoque');
        }
        
        // Atualizar resumo com dados reais
        document.getElementById('resumo-problemas-d0').textContent = data.resumo.problemas_d0 || 0;
        document.getElementById('resumo-problemas-d7').textContent = data.resumo.problemas_d7 || 0;
        document.getElementById('resumo-estoque-ok').textContent = data.resumo.estoque_ok || 0;
        
        // Gerar tabela com dados reais
        gerarTabelaEstoqueReal(data.itens || []);
        
        modalLoading.style.display = 'none';
        modalContent.style.display = 'block';
        
        console.log(`‚úÖ An√°lise de estoque carregada: ${data.itens?.length || 0} produtos analisados`);
        
    } catch (error) {
        console.error(`‚ùå Erro ao carregar estoque D0/D7 do pedido ${numPedido}:`, error);
        
        // Mostrar erro
        modalLoading.style.display = 'none';
        modalContent.innerHTML = `
            <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h5>Erro ao carregar an√°lise de estoque</h5>
                <p>${error.message}</p>
                <button class="btn btn-primary" onclick="carregarEstoqueD0D7('${numPedido}')">
                    <i class="fas fa-redo"></i> Tentar Novamente
                </button>
            </div>
        `;
        modalContent.style.display = 'block';
    }
}

function gerarTabelaEstoqueReal(itens) {
    const tbody = document.getElementById('estoque-tbody-itens');
    let html = '';
    
    if (!itens || itens.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center p-4">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum dado de estoque encontrado</h5>
                    <p class="text-muted">Os produtos deste pedido n√£o possuem dados de estoque dispon√≠veis.</p>
                </td>
            </tr>
        `;
        return;
    }
    
    itens.forEach(item => {
        // Determinar status e classe CSS baseado nos dados reais
        let status = 'NORMAL';
        let statusClass = 'info';
        
        if (item.estoque_d0 <= 0) {
            status = 'CR√çTICO - SEM ESTOQUE';
            statusClass = 'danger';
        } else if (item.estoque_d0 < item.qtd_pedido) {
            status = 'INSUFICIENTE';
            statusClass = 'warning';
        } else if (item.estoque_d7 <= 0) {
            status = 'RUPTURA D7';
            statusClass = 'warning';
        } else {
            status = 'DISPON√çVEL';
            statusClass = 'success';
        }
        
        // Calcular percentual de disponibilidade
        const disponibilidade = item.qtd_pedido > 0 ? 
            Math.round((Math.min(item.estoque_d0, item.qtd_pedido) / item.qtd_pedido) * 100) : 0;
        
        html += `
            <tr class="${statusClass === 'danger' ? 'table-danger' : statusClass === 'warning' ? 'table-warning' : ''}">
                <td><small><strong>${item.cod_produto}</strong></small></td>
                <td><small>${item.nome_produto || '-'}</small></td>
                <td><strong>${item.qtd_pedido.toLocaleString('pt-BR')}</strong></td>
                <td>
                    <strong class="${item.estoque_d0 <= 0 ? 'text-danger' : item.estoque_d0 < item.qtd_pedido ? 'text-warning' : 'text-success'}">
                        ${item.estoque_d0.toLocaleString('pt-BR')}
                    </strong>
                </td>
                <td>
                    <span class="${item.estoque_d7 <= 0 ? 'text-danger' : 'text-dark'}">
                        ${item.estoque_d7.toLocaleString('pt-BR')}
                    </span>
                </td>
                <td>
                    <span class="badge badge-${statusClass}" style="${statusClass === 'danger' ? 'background-color: #dc3545; color: white;' : statusClass === 'warning' ? 'background-color: #ffc107; color: black;' : statusClass === 'success' ? 'background-color: #28a745; color: white;' : 'background-color: #17a2b8; color: white;'}">
                        ${status}
                    </span>
                    <br><small class="text-muted">${disponibilidade}% dispon√≠vel</small>
                </td>
                <td>
                    <div class="btn-group-vertical btn-group-sm">
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalhesEstoque('${item.cod_produto}')" title="Ver proje√ß√£o completa">
                            <i class="fas fa-chart-line"></i>
                        </button>
                        ${item.estoque_d0 < item.qtd_pedido ? `
                        <button class="btn btn-sm btn-outline-warning" onclick="sugerirAlternativa('${item.cod_produto}')" title="Sugerir alternativa">
                            <i class="fas fa-lightbulb"></i>
                        </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Manter fun√ß√£o antiga para compatibilidade
function gerarTabelaEstoque(itens) {
    gerarTabelaEstoqueReal(itens);
}

function exportarAnaliseEstoque() {
    console.log('üìä Exportando an√°lise de estoque...');
    alert('üìä Fun√ß√£o de exporta√ß√£o ser√° implementada em breve');
}

function verDetalhesEstoque(codProduto) {
    console.log(`üìä Ver detalhes estoque produto: ${codProduto}`);
    alert(`üìä Detalhes do produto ${codProduto} - funcionalidade ser√° implementada`);
}



/**
 * Toggle todos os itens (selecionar/desselecionar todos)
 */
function toggleTodosItens(masterCheckbox) {
    const checkboxes = document.querySelectorAll('.item-checkbox:not(:disabled)');
    checkboxes.forEach(checkbox => {
        checkbox.checked = masterCheckbox.checked;
    });
    calcularTotaisModal();
}

/**
 * Valida quantidade inserida (SEM CASAS DECIMAIS conforme regra)
 */
function validarQuantidade(input) {
    const max = Math.round(parseFloat(input.getAttribute('data-max')));
    let value = parseFloat(input.value);
    
    if (isNaN(value) || value < 0) {
        input.value = '0';
        input.classList.add('is-invalid');
        return false;
    }
    
    // For√ßar n√∫mero inteiro (sem casa decimal)
    value = Math.round(value);
    input.value = value;
    
    if (value > max) {
        input.value = max;
        input.classList.add('is-invalid');
        alert(`Quantidade n√£o pode exceder ${max}`);
        return false;
    }
    
    input.classList.remove('is-invalid');
    input.classList.add('is-valid');
    return true;
}

/**
 * Calcula totais dos itens selecionados
 */
function calcularTotaisModal() {
    let totalQtd = 0;
    let totalValor = 0;
    let countSelecionados = 0;
    
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    
    checkboxes.forEach(checkbox => {
        const itemId = checkbox.getAttribute('data-item-id');
        const qtdInput = document.querySelector(`.qtd-input[data-item-id="${itemId}"]`);
        
        if (qtdInput) {
            const qtd = parseFloat(qtdInput.value) || 0;
            
            // Buscar pre√ßo do item nos dados
            if (dadosModalAtual) {
                const item = dadosModalAtual.itens.find(i => i.id == itemId);
                if (item) {
                    totalQtd += qtd;
                    totalValor += qtd * item.preco;
                    countSelecionados++;
                }
            }
        }
    });
    
    // Atualizar interface (formata√ß√£o brasileira SEM casas decimais para qtd)
    document.getElementById('total-qtd-selecionada').textContent = Math.round(totalQtd).toLocaleString('pt-BR');
    document.getElementById('total-valor-selecionado').textContent = `R$ ${totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('resumo-selecionados').textContent = countSelecionados;
    
    // Atualizar cor do badge
    const badge = document.getElementById('resumo-selecionados');
    badge.className = countSelecionados > 0 ? 'badge badge-success ml-2' : 'badge badge-warning ml-2';
}

/**
 * Salva avalia√ß√µes dos itens selecionados via API
 * üéØ ETAPA 2: IMPLEMENTA√á√ÉO COM TIPO DE ENVIO (ATUALIZADA)
 */
async function salvarAvaliacoes() {
    if (!numPedidoModal || !dadosModalAtual) {
        alert('Erro: Dados do modal n√£o carregados');
        return;
    }
    
    // üéØ ETAPA 2: VALIDA√á√ÉO DO TIPO DE ENVIO
    if (!validarEnvioParcial()) {
        return; // Valida√ß√£o falhou, n√£o continuar
    }
    
    // Coletar dados do formul√°rio
    const itensSelecionados = [];
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('‚ö†Ô∏è Selecione pelo menos um item para continuar');
        return;
    }
    
    checkboxes.forEach(checkbox => {
        const itemId = checkbox.getAttribute('data-item-id');
        const qtdInput = document.querySelector(`.qtd-input[data-item-id="${itemId}"]`);
        const expedicaoInput = document.querySelector(`input[data-item-id="${itemId}"][data-field="expedicao"]`);
        const agendamentoInput = document.querySelector(`input[data-item-id="${itemId}"][data-field="agendamento"]`);
        const protocoloInput = document.querySelector(`input[data-item-id="${itemId}"][data-field="protocolo"]`);
        
        if (qtdInput && validarQuantidade(qtdInput)) {
            itensSelecionados.push({
                item_id: parseInt(itemId),
                qtd_selecionada: parseFloat(qtdInput.value),
                expedicao: expedicaoInput ? expedicaoInput.value : '',
                agendamento: agendamentoInput ? agendamentoInput.value : '',
                protocolo: protocoloInput ? protocoloInput.value : ''
            });
        }
    });
    
    if (itensSelecionados.length === 0) {
        alert('‚ö†Ô∏è Nenhum item v√°lido selecionado');
        return;
    }
    
    // üîÑ PROCESSAR VIA API
    const btnSalvar = document.getElementById('btn-salvar-avaliacoes');
    const textoOriginal = btnSalvar.innerHTML;
    
    try {
        // Mostrar loading
        btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
        btnSalvar.disabled = true;
        
        // üéØ ETAPA 2: COLETAR DADOS DO TIPO DE ENVIO
        const tipoEnvio = document.getElementById('tipo_envio').value;
        const configEnvioParcial = tipoEnvio === 'parcial' ? {
            motivo: document.getElementById('motivo_parcial').value,
            justificativa: document.getElementById('justificativa_parcial').value,
            previsao_complemento: document.getElementById('previsao_complemento').value,
            responsavel_aprovacao: document.getElementById('responsavel_aprovacao').value
        } : null;
        
        // Chamar API
        const response = await fetch(`/carteira/api/pedido/${numPedidoModal}/salvar-avaliacoes`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({
                itens: itensSelecionados,
                tipo_envio: tipoEnvio,
                config_envio_parcial: configEnvioParcial
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Erro ao processar avalia√ß√µes');
        }
        
        // ‚úÖ SUCESSO
        console.log('‚úÖ Avalia√ß√µes salvas com sucesso:', data);
        
        // Mostrar resultados detalhados
        let mensagem = `üéâ **AVALIA√á√ïES PROCESSADAS COM SUCESSO!**\n\n`;
        mensagem += `üìä **Resumo:**\n`;
        mensagem += `‚Ä¢ Itens processados: ${data.processados}\n`;
        mensagem += `‚Ä¢ Sucessos: ${data.sucessos}\n`;
        mensagem += `‚Ä¢ Erros: ${data.erros}\n\n`;
        
        if (data.resultados && data.resultados.length > 0) {
            mensagem += `üìã **Detalhes:**\n`;
            data.resultados.forEach(resultado => {
                if (resultado.status === 'sucesso') {
                    const icone = resultado.acao === 'dividido' ? '‚úÇÔ∏è' : '‚úÖ';
                    mensagem += `${icone} ${resultado.mensagem}\n`;
                } else {
                    mensagem += `‚ùå Item ${resultado.item_id}: ${resultado.erro}\n`;
                }
            });
        }
        
        alert(mensagem);
        
        // Fechar modal e recarregar dados
        $('#modalAvaliarItens').modal('hide');
        
        // Limpar cache para for√ßar reload
        itensPedidoCache.delete(numPedidoModal);
        
        // Recarregar dados da tabela principal
        setTimeout(() => {
            location.reload(); // Recarregar p√°gina para mostrar mudan√ßas
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå Erro ao salvar avalia√ß√µes:', error);
        
        let mensagemErro = `‚ùå **ERRO AO PROCESSAR AVALIA√á√ïES**\n\n`;
        mensagemErro += `Detalhes: ${error.message}\n\n`;
        mensagemErro += `üìã Dados coletados: ${itensSelecionados.length} itens\n`;
        mensagemErro += `üîß Verifique os logs do sistema ou tente novamente.`;
        
        alert(mensagemErro);
        
    } finally {
        // Restaurar bot√£o
        btnSalvar.innerHTML = textoOriginal;
        btnSalvar.disabled = false;
    }
}

/**
 * Recarrega dados do modal
 */
function recarregarModalItens() {
    if (numPedidoModal) {
        // Remover do cache para for√ßar reload
        itensPedidoCache.delete(numPedidoModal);
        carregarDadosModal(numPedidoModal);
    }
}

/**
 * Calcula e exibe estoque D0/D7 de um pedido
 * Implementa√ß√£o: Fase 3.2 - Integra√ß√£o Estoque D0/D7
 */
async function calcularEstoqueD0D7(numPedido) {
    // Configurar modal
    document.getElementById('modal-estoque-pedido').textContent = numPedido;
    
    // Mostrar modal
    $('#modalEstoqueD0D7').modal('show');
    
    // Carregar dados
    await carregarDadosEstoque(numPedido);
}

// Vari√°veis globais para estoque
let dadosEstoqueAtual = null;
let numPedidoEstoque = null;

/**
 * Carrega dados de estoque D0/D7 via API
 */
async function carregarDadosEstoque(numPedido) {
    numPedidoEstoque = numPedido;
    
    const modalLoading = document.getElementById('modal-estoque-loading');
    const modalError = document.getElementById('modal-estoque-error');
    const modalContent = document.getElementById('modal-estoque-content');
    
    try {
        // Mostrar loading
        modalLoading.style.display = 'block';
        modalError.style.display = 'none';
        modalContent.style.display = 'none';
        
        // Fazer requisi√ß√£o AJAX
        const response = await fetch(`/carteira/api/pedido/${numPedido}/estoque-d0-d7`);
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Erro ao calcular estoque');
        }
        
        // Armazenar dados
        dadosEstoqueAtual = data;
        
        // Gerar HTML dos produtos
        gerarHtmlEstoqueProdutos(data);
        
        // Atualizar resumo
        atualizarResumoEstoque(data);
        
        // Mostrar conte√∫do
        modalLoading.style.display = 'none';
        modalContent.style.display = 'block';
        
        console.log(`‚úÖ Estoque D0/D7 carregado para pedido ${numPedido}: ${data.produtos.length} produtos`);
        
    } catch (error) {
        console.error(`‚ùå Erro ao carregar estoque D0/D7 do pedido ${numPedido}:`, error);
        
        // Mostrar erro
        document.getElementById('modal-estoque-error-message').textContent = error.message;
        modalLoading.style.display = 'none';
        modalError.style.display = 'block';
        modalContent.style.display = 'none';
    }
}

/**
 * Gera HTML da tabela de produtos com estoque
 */
function gerarHtmlEstoqueProdutos(data) {
    const tbody = document.getElementById('tbody-estoque-produtos');
    let html = '';
    
    data.produtos.forEach(produto => {
        // Classes CSS para status
        const statusD0Class = getStatusClass(produto.status_d0);
        const statusD7Class = getStatusClass(produto.status_d7);
        
        // √çcone de sufici√™ncia
        const suficienteIcon = produto.tem_estoque_suficiente ? 
            '<i class="fas fa-check text-success"></i>' : 
            '<i class="fas fa-times text-danger"></i>';
        
        // Proje√ß√£o resumida
        const projecaoHtml = produto.projecao_resumo && produto.projecao_resumo.length > 0 ?
            produto.projecao_resumo.map(dia => 
                `<span class="badge badge-${getStatusClass(dia.status)} badge-sm">${dia.data}</span>`
            ).join(' ') : 
            '<small class="text-muted">Sem dados</small>';
        
        html += `
            <tr ${produto.status_d0 === 'RUPTURA' ? 'class="table-danger"' : produto.status_d0 === 'BAIXO' ? 'class="table-warning"' : ''}>
                <td><strong>${produto.cod_produto}</strong></td>
                <td><small>${produto.nome_produto}</small></td>
                <td><strong>${produto.qtd_pedido.toFixed(3)}</strong></td>
                <td>
                    <strong>${produto.estoque_d0.toFixed(3)}</strong>
                    ${produto.dia_ruptura === 0 ? '<br><small class="text-danger">Ruptura hoje!</small>' : ''}
                </td>
                <td>
                    <span class="badge badge-${statusD0Class}">
                        ${formatarStatus(produto.status_d0)}
                    </span>
                </td>
                <td>
                    <strong>${produto.menor_estoque_d7.toFixed(3)}</strong>
                    ${produto.dia_ruptura !== null && produto.dia_ruptura > 0 ? 
                      `<br><small class="text-warning">Ruptura D${produto.dia_ruptura}</small>` : ''}
                </td>
                <td>
                    <span class="badge badge-${statusD7Class}">
                        ${formatarStatus(produto.status_d7)}
                    </span>
                </td>
                <td class="text-center">
                    ${suficienteIcon}
                    ${produto.tem_estoque_suficiente ? 
                      '<br><small class="text-success">OK</small>' : 
                      '<br><small class="text-danger">Insuficiente</small>'}
                </td>
                <td style="max-width: 200px;">
                    <div class="projecao-container" style="font-size: 0.8em;">
                        ${projecaoHtml}
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

/**
 * Atualiza resumo das estat√≠sticas de estoque
 */
function atualizarResumoEstoque(data) {
    const stats = data.estatisticas;
    
    document.getElementById('estoque-data-calculo').textContent = data.data_calculo;
    document.getElementById('resumo-total-produtos').textContent = stats.total_produtos;
    document.getElementById('resumo-ruptura-d0').textContent = stats.produtos_ruptura_d0;
    document.getElementById('resumo-problemas-d7').textContent = stats.produtos_ruptura_d7;
    document.getElementById('resumo-menor-estoque').textContent = stats.menor_estoque_geral.toFixed(3);
    
    // Alerta de ruptura
    const alertaRuptura = document.getElementById('alerta-ruptura');
    if (stats.dia_ruptura_mais_proximo !== null) {
        document.getElementById('dias-ruptura').textContent = stats.dia_ruptura_mais_proximo;
        alertaRuptura.style.display = 'block';
    } else {
        alertaRuptura.style.display = 'none';
    }
}

/**
 * Mapeia status para classes CSS do Bootstrap
 */
function getStatusClass(status) {
    switch (status) {
        case 'NORMAL': return 'success';
        case 'BAIXO': 
        case 'BAIXO_PREVISTO': return 'warning';
        case 'RUPTURA': 
        case 'RUPTURA_PREVISTA': return 'danger';
        case 'SEM_DADOS': return 'secondary';
        default: return 'secondary';
    }
}

/**
 * Formata status para exibi√ß√£o
 */
function formatarStatus(status) {
    switch (status) {
        case 'NORMAL': return 'Normal';
        case 'BAIXO': return 'Baixo';
        case 'BAIXO_PREVISTO': return 'Baixo Prev.';
        case 'RUPTURA': return 'Ruptura';
        case 'RUPTURA_PREVISTA': return 'Ruptura Prev.';
        case 'SEM_DADOS': return 'Sem Dados';
        default: return status;
    }
}

/**
 * Recarrega modal de estoque
 */
function recarregarModalEstoque() {
    if (numPedidoEstoque) {
        carregarDadosEstoque(numPedidoEstoque);
    }
}

/**
 * Placeholder para exportar dados de estoque
 */
function exportarDadosEstoque() {
    if (dadosEstoqueAtual) {
        alert(`üîß Fun√ß√£o exportar dados de estoque ser√° implementada na Fase 4 - Valida√ß√£o/Performance\n\nDados dispon√≠veis: ${dadosEstoqueAtual.produtos.length} produtos`);
    }
}

/**
 * Consulta separa√ß√µes de um pedido
 * Implementa√ß√£o: Fase 3.1 - Query Separa√ß√µes por Pedido
 */
async function consultarSeparacoes(numPedido) {
    // Configurar modal
    document.getElementById('modal-separacoes-pedido').textContent = numPedido;
    
    // Mostrar modal
    $('#modalConsultarSeparacoes').modal('show');
    
    // Carregar dados
    await carregarSeparacoesPedido(numPedido);
}

// Vari√°veis globais para separa√ß√µes
let dadosSeparacoesAtual = null;
let numPedidoSeparacoes = null;

/**
 * Carrega separa√ß√µes de um pedido via API
 */
async function carregarSeparacoesPedido(numPedido) {
    numPedidoSeparacoes = numPedido;
    
    const modalLoading = document.getElementById('modal-separacoes-loading');
    const modalError = document.getElementById('modal-separacoes-error');
    const modalEmpty = document.getElementById('modal-separacoes-empty');
    const modalContent = document.getElementById('modal-separacoes-content');
    
    try {
        // Mostrar loading
        modalLoading.style.display = 'block';
        modalError.style.display = 'none';
        modalEmpty.style.display = 'none';
        modalContent.style.display = 'none';
        
        // Fazer requisi√ß√£o AJAX
        const response = await fetch(`/carteira/api/pedido/${numPedido}/separacoes`);
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Erro ao carregar separa√ß√µes');
        }
        
        // Armazenar dados
        dadosSeparacoesAtual = data;
        
        // Verificar se tem separa√ß√µes
        if (data.total_separacoes === 0) {
            modalLoading.style.display = 'none';
            modalEmpty.style.display = 'block';
            return;
        }
        
        // Gerar HTML das separa√ß√µes
        gerarHtmlSeparacoes(data);
        
        // Atualizar resumo
        atualizarResumoSeparacoes(data);
        
        // Mostrar conte√∫do
        modalLoading.style.display = 'none';
        modalContent.style.display = 'block';
        
        console.log(`‚úÖ Separa√ß√µes carregadas para pedido ${numPedido}: ${data.total_separacoes} separa√ß√µes`);
        
    } catch (error) {
        console.error(`‚ùå Erro ao carregar separa√ß√µes do pedido ${numPedido}:`, error);
        
        // Mostrar erro
        document.getElementById('modal-separacoes-error-message').textContent = error.message;
        modalLoading.style.display = 'none';
        modalError.style.display = 'block';
        modalContent.style.display = 'none';
    }
}

/**
 * Gera HTML da tabela de separa√ß√µes
 */
function gerarHtmlSeparacoes(data) {
    const tbody = document.getElementById('tbody-separacoes');
    let html = '';
    
    data.separacoes.forEach(sep => {
        const transportadora = sep.transportadora.razao_social || sep.transportadora.nome_fantasia || '-';
        const embarqueInfo = sep.embarque.numero ? `#${sep.embarque.numero}` : '-';
        
        html += `
            <tr>
                <td>
                    <strong>${sep.separacao_lote_id}</strong>
                    <br><small class="text-muted">${sep.total_itens} itens</small>
                </td>
                <td>
                    <span class="badge badge-${sep.status_class}">
                        ${sep.status}
                    </span>
                </td>
                <td>${sep.criado_em}</td>
                <td>
                    ${embarqueInfo}
                    ${sep.embarque.tipo_carga ? `<br><small class="text-muted">${sep.embarque.tipo_carga}</small>` : ''}
                </td>
                <td>
                    <small>${transportadora}</small>
                </td>
                <td>${sep.embarque.data_prevista || '-'}</td>
                <td>${sep.embarque.data_embarque || '-'}</td>
                <td>
                    <strong>R$ ${sep.valor_saldo.toFixed(2)}</strong>
                </td>
                <td>
                    ${sep.peso.toFixed(2)} kg
                    <br><small class="text-muted">${sep.pallet.toFixed(2)} pal</small>
                </td>
                <td>
                    <div class="btn-group-vertical btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" 
                                onclick="verDetalhesSeparacao('${sep.separacao_lote_id}')"
                                title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${sep.status === 'CRIADA' ? `
                        <button class="btn btn-outline-warning btn-sm" 
                                onclick="editarSeparacao('${sep.separacao_lote_id}')"
                                title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

/**
 * Atualiza resumo das separa√ß√µes
 */
function atualizarResumoSeparacoes(data) {
    document.getElementById('resumo-total-separacoes').textContent = data.total_separacoes;
    document.getElementById('resumo-separacoes-embarcadas').textContent = data.separacoes_embarcadas;
    document.getElementById('resumo-separacoes-pendentes').textContent = data.separacoes_pendentes;
}

/**
 * Recarrega modal de separa√ß√µes
 */
function recarregarModalSeparacoes() {
    if (numPedidoSeparacoes) {
        carregarSeparacoesPedido(numPedidoSeparacoes);
    }
}

/**
 * Placeholder para ver detalhes de separa√ß√£o
 */
function verDetalhesSeparacao(loteId) {
    alert(`üîß Fun√ß√£o ver detalhes da separa√ß√£o ${loteId} ser√° implementada na Fase 3.4 - Dropdown Separa√ß√µes`);
}

/**
 * Placeholder para editar separa√ß√£o
 */
function editarSeparacao(loteId) {
    alert(`üîß Fun√ß√£o editar separa√ß√£o ${loteId} ser√° implementada na Fase 3.4 - Dropdown Separa√ß√µes`);
}

/**
 * üéØ ETAPA 2: FUN√á√ÉO DROPDOWN TIPO DE ENVIO (IMPLEMENTADA)
 * Controla exibi√ß√£o de campos baseado no tipo de envio selecionado
 */
function atualizarTipoEnvio() {
    const tipoEnvio = document.getElementById('tipo_envio').value;
    const explicacaoTotal = document.getElementById('explicacao_total');
    const explicacaoParcial = document.getElementById('explicacao_parcial');
    const camposParcial = document.getElementById('campos_envio_parcial');
    
    if (tipoEnvio === 'parcial') {
        // Mostrar configura√ß√µes para envio parcial
        explicacaoTotal.style.display = 'none';
        explicacaoParcial.style.display = 'block';
        camposParcial.style.display = 'block';
        
        // Tornar campos obrigat√≥rios
        document.getElementById('motivo_parcial').required = true;
        document.getElementById('justificativa_parcial').required = true;
        
        console.log('üéØ Modo Envio Parcial ativado - campos espec√≠ficos exibidos');
        
        // Atualizar instru√ß√µes
        const instrucoes = document.querySelector('.alert-info ul');
        if (instrucoes && !instrucoes.innerHTML.includes('envio parcial')) {
            const novaInstrucao = document.createElement('li');
            novaInstrucao.innerHTML = 'üî¥ <strong>Envio Parcial:</strong> Configure motivo e justificativa nos campos acima';
            novaInstrucao.style.color = '#dc3545';
            instrucoes.appendChild(novaInstrucao);
        }
        
    } else {
        // Mostrar configura√ß√µes para envio total
        explicacaoTotal.style.display = 'block';
        explicacaoParcial.style.display = 'none';
        camposParcial.style.display = 'none';
        
        // Remover obrigatoriedade
        document.getElementById('motivo_parcial').required = false;
        document.getElementById('justificativa_parcial').required = false;
        
        // Limpar campos de envio parcial
        document.getElementById('motivo_parcial').value = '';
        document.getElementById('justificativa_parcial').value = '';
        document.getElementById('previsao_complemento').value = '';
        
        console.log('üì¶ Modo Envio Total ativado - interface simplificada');
        
        // Remover instru√ß√£o espec√≠fica do parcial
        const instrucoes = document.querySelector('.alert-info ul');
        if (instrucoes) {
            const instrucoesList = instrucoes.querySelectorAll('li');
            instrucoesList.forEach(li => {
                if (li.innerHTML.includes('Envio Parcial')) {
                    li.remove();
                }
            });
        }
    }
    
    // Recalcular totais se necess√°rio
    if (typeof calcularTotaisModal === 'function') {
        calcularTotaisModal();
    }
}

/**
 * üéØ VALIDA√á√ÉO ESPEC√çFICA PARA ENVIO PARCIAL
 * Valida se campos obrigat√≥rios est√£o preenchidos
 */
function validarEnvioParcial() {
    const tipoEnvio = document.getElementById('tipo_envio').value;
    
    if (tipoEnvio === 'parcial') {
        const motivo = document.getElementById('motivo_parcial').value;
        const justificativa = document.getElementById('justificativa_parcial').value.trim();
        
        if (!motivo) {
            alert('‚ùå Selecione o motivo do envio parcial');
            document.getElementById('motivo_parcial').focus();
            return false;
        }
        
        if (!justificativa) {
            alert('‚ùå Preencha a justificativa detalhada do envio parcial');
            document.getElementById('justificativa_parcial').focus();
            return false;
        }
        
        if (justificativa.length < 10) {
            alert('‚ùå Justificativa deve ter pelo menos 10 caracteres');
            document.getElementById('justificativa_parcial').focus();
            return false;
        }
        
        console.log('‚úÖ Valida√ß√£o envio parcial aprovada:', { motivo, justificativa });
    }
    
    return true;
}

/**
 * üîß FUN√á√ïES DOS BOT√ïES - IMPLEMENTADAS
 */
function criarSeparacao(numPedido) {
    console.log(`üì¶ Criar Separa√ß√£o pedido ${numPedido}`);
    abrirModalAvaliarItens(numPedido);
}

function consultarSeparacoes(numPedido) {
    console.log(`üìã Consultar Separa√ß√µes pedido ${numPedido}`);
    $('#modalSeparacoes').modal('show');
    carregarSeparacoesPedido(numPedido);
}

function abrirModalAvaliarItens(numPedido) {
    console.log(`üîç Avaliar Itens pedido ${numPedido}`);
    $('#modalAvaliarItens').modal('show');
    carregarItensParaAvaliacao(numPedido);
}

function solicitarAgendamento(numPedido) {
    console.log(`üóìÔ∏è Solicitar Agendamento pedido ${numPedido}`);
    // ‚úÖ OTIMIZA√á√ÉO: Cache da inst√¢ncia do modal para evitar recria√ß√£o
    if (!window._modalAgendamento) {
        window._modalAgendamento = new bootstrap.Modal(document.getElementById('modalAgendamento'));
    }
    window._modalAgendamento.show();
    carregarDadosAgendamento(numPedido);
}

function calcularEstoqueD0D7(numPedido) {
    console.log(`üìä Calcular Estoque D0/D7 pedido ${numPedido}`);
    $('#modalEstoqueD0D7').modal('show');
    carregarEstoqueD0D7(numPedido);
}

function abrirModalEndereco(numPedido) {
    // Buscar dados do pedido via AJAX - ADAPTADO PARA CARTEIRA AGRUPADA
    fetch('/carteira/item/' + numPedido + '/endereco')
        .then(response => response.json())
        .then(data => {
            // Preencher dados do cliente
            document.getElementById('modal_cliente_uf').textContent = data.estado || '-';
            document.getElementById('modal_cliente_municipio').textContent = data.municipio || '-';
            
            // Preencher dados do endere√ßo de entrega
            document.getElementById('modal_cnpj_endereco').textContent = data.cnpj_endereco_ent || '-';
            document.getElementById('modal_empresa_endereco').textContent = data.empresa_endereco_ent || '-';
            document.getElementById('modal_uf_endereco').textContent = data.cod_uf || '-';
            document.getElementById('modal_municipio_endereco').textContent = data.nome_cidade || '-';
            document.getElementById('modal_bairro_endereco').textContent = data.bairro_endereco_ent || '-';
            document.getElementById('modal_cep_endereco').textContent = data.cep_endereco_ent || '-';
            
            // Combinar rua e endere√ßo
            let ruaCompleta = '';
            if (data.rua_endereco_ent && data.endereco_ent) {
                ruaCompleta = data.rua_endereco_ent + ' / ' + data.endereco_ent;
            } else if (data.rua_endereco_ent) {
                ruaCompleta = data.rua_endereco_ent;
            } else if (data.endereco_ent) {
                ruaCompleta = data.endereco_ent;
            }
            document.getElementById('modal_rua_endereco').textContent = ruaCompleta || '-';
            
            document.getElementById('modal_telefone_endereco').textContent = data.telefone_endereco_ent || '-';
            
            // Mostrar modal
            // ‚úÖ OTIMIZA√á√ÉO: Cache da inst√¢ncia do modal para evitar recria√ß√£o
            if (!window._modalEndereco) {
                window._modalEndereco = new bootstrap.Modal(document.getElementById('modalEndereco'));
            }
            window._modalEndereco.show();
        })
        .catch(error => {
            console.error('Erro ao buscar dados do endere√ßo:', error);
            alert('Erro ao carregar dados do endere√ßo');
        });
}



/**
 * Placeholder para criar nova separa√ß√£o
 */
function criarNovaSeparacao() {
    if (numPedidoSeparacoes) {
        alert(`üîß Fun√ß√£o criar nova separa√ß√£o para pedido ${numPedidoSeparacoes} ser√° implementada na Fase 3.3 - Sistema Pr√©-Separa√ß√£o`);
    }
}

// Inicializa√ß√£o
$(document).ready(function() {
    console.log('‚úÖ JavaScript expandir/colapsar inicializado');
    console.log(`üìä ${$('.pedido-row').length} pedidos dispon√≠veis para expans√£o`);
});
</script>

{% endblock %} 