{% extends "base.html" %}

{% block title %}Saldo Standby{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header da Página -->
    <header class="page-header">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="fas fa-pause-circle text-warning me-2"></i>
                    Saldo Standby
                </h1>
                <small class="text-muted"><span id="contador-standby">0</span> pedidos em standby</small>
            </div>
            
            <div class="btn-toolbar" role="toolbar">
                <a href="{{ url_for('carteira.index') }}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-arrow-left me-1"></i> Voltar
                </a>
            </div>
        </div>
    </header>

    <!-- Filtros -->
    <section class="filters-section mb-4">
        <div class="card">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="filtro-busca-standby" 
                                   placeholder="Buscar pedido, cliente, CNPJ...">
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="filtro-tipo-standby">
                            <option value="">Todos os Tipos</option>
                            <option value="Saldo">Saldo</option>
                            <option value="Aguardar Comercial">Aguardar Comercial</option>
                            <option value="Aguardar PCP">Aguardar PCP</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="filtro-status-standby">
                            <option value="">Todos os Status</option>
                            <option value="ATIVO">Ativo</option>
                            <option value="BLOQ. COML.">Bloqueado Comercial</option>
                            <option value="SALDO">Saldo</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2 text-end">
                        <button class="btn btn-primary btn-sm" onclick="carregarPedidosStandby()">
                            <i class="fas fa-sync-alt me-1"></i> Atualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Tabela de Pedidos Standby -->
    <section class="standby-section">
        <div class="card">
            <div class="card-body">
                <div id="loading-standby" class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p class="mt-2">Carregando pedidos em standby...</p>
                </div>
                
                <div id="tabela-standby" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="50">
                                        <button class="btn btn-link btn-sm p-0" onclick="toggleTodosPedidos()">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </th>
                                    <th>Pedido</th>
                                    <th>Cliente</th>
                                    <th>Data Pedido</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th class="text-end">Valor</th>
                                    <th class="text-end">Peso</th>
                                    <th class="text-end">Pallet</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-standby">
                                <!-- Pedidos serão carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="sem-dados-standby" class="text-center p-4" style="display: none;">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Nenhum pedido em standby encontrado</p>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block styles %}
<style>
.btn-status-standby {
    min-width: 100px;
    font-size: 0.875rem;
}

.badge-tipo-standby {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
}

.produtos-standby {
    background-color: #f8f9fa;
    font-size: 0.875rem;
}

.produtos-standby td {
    padding: 0.5rem;
}

.btn-acao-standby {
    margin: 0 2px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let pedidosStandby = [];

// Carregar pedidos ao iniciar a página
document.addEventListener('DOMContentLoaded', function() {
    carregarPedidosStandby();
    
    // Configurar filtros
    document.getElementById('filtro-busca-standby').addEventListener('input', filtrarPedidos);
    document.getElementById('filtro-tipo-standby').addEventListener('change', filtrarPedidos);
    document.getElementById('filtro-status-standby').addEventListener('change', filtrarPedidos);
});

async function carregarPedidosStandby() {
    const loading = document.getElementById('loading-standby');
    const tabela = document.getElementById('tabela-standby');
    const semDados = document.getElementById('sem-dados-standby');
    
    loading.style.display = 'block';
    tabela.style.display = 'none';
    semDados.style.display = 'none';
    
    try {
        const response = await fetch('/carteira/api/standby/listar');
        const data = await response.json();
        
        if (data.success) {
            pedidosStandby = data.pedidos;
            document.getElementById('contador-standby').textContent = pedidosStandby.length;
            
            if (pedidosStandby.length > 0) {
                renderizarTabela(pedidosStandby);
                tabela.style.display = 'block';
            } else {
                semDados.style.display = 'block';
            }
        } else {
            showAlert('error', 'Erro ao carregar pedidos');
        }
    } catch (error) {
        console.error('Erro ao carregar standby:', error);
        showAlert('error', 'Erro ao carregar pedidos');
    } finally {
        loading.style.display = 'none';
    }
}

function renderizarTabela(pedidos) {
    const tbody = document.getElementById('tbody-standby');
    tbody.innerHTML = '';
    
    pedidos.forEach(pedido => {
        // Linha principal do pedido
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <button class="btn btn-link btn-sm p-0" onclick="toggleProdutos('${pedido.num_pedido}')">
                    <i class="fas fa-chevron-right" id="icon-${pedido.num_pedido}"></i>
                </button>
            </td>
            <td>
                <strong>${pedido.num_pedido}</strong>
            </td>
            <td>
                <div>${pedido.nome_cliente}</div>
                <small class="text-muted">${pedido.cnpj_cliente}</small>
            </td>
            <td>${pedido.data_pedido || '-'}</td>
            <td>
                <span class="badge badge-tipo-standby bg-info">${pedido.tipo_standby}</span>
            </td>
            <td>
                <span class="badge ${getBadgeClassStatus(pedido.status_standby)}" 
                      style="cursor: pointer;"
                      onclick="abrirModalObservacoes('${pedido.num_pedido}', ${JSON.stringify(pedido.observacoes || []).replace(/"/g, '&quot;')})"
                      title="Clique para ver/adicionar observações">
                    ${pedido.status_standby}
                    ${pedido.total_observacoes > 0 ? `<i class="fas fa-comment-dots ms-1"></i> (${pedido.total_observacoes})` : ''}
                </span>
            </td>
            <td class="text-end">${formatarMoeda(pedido.valor_total)}</td>
            <td class="text-end">${formatarNumero(pedido.peso_total, 2)} kg</td>
            <td class="text-end">${formatarNumero(pedido.pallet_total, 2)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary btn-acao-standby" 
                        onclick="alterarStatus('${pedido.num_pedido}', 'ATIVO')"
                        title="Reverter para Ativo">
                    <i class="fas fa-undo"></i> Reverter
                </button>
                <button class="btn btn-sm btn-outline-warning btn-acao-standby" 
                        onclick="alterarStatus('${pedido.num_pedido}', 'BLOQ. COML.')"
                        title="Bloquear Comercial">
                    <i class="fas fa-ban"></i> Bloquear
                </button>
                <button class="btn btn-sm btn-outline-info btn-acao-standby" 
                        onclick="alterarStatus('${pedido.num_pedido}', 'SALDO')"
                        title="Marcar como Saldo">
                    <i class="fas fa-box"></i> Saldo
                </button>
                <button class="btn btn-sm btn-outline-success btn-acao-standby" 
                        onclick="alterarStatus('${pedido.num_pedido}', 'CONFIRMADO')"
                        title="Confirmar e Retornar">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </td>
        `;
        tbody.appendChild(tr);
        
        // Linha de produtos (oculta)
        const trProdutos = document.createElement('tr');
        trProdutos.id = `produtos-${pedido.num_pedido}`;
        trProdutos.className = 'produtos-standby';
        trProdutos.style.display = 'none';
        trProdutos.innerHTML = `
            <td colspan="10">
                <div class="p-3">
                    <h6 class="mb-2">Produtos do Pedido ${pedido.num_pedido}:</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Quantidade</th>
                                <th class="text-end">Valor</th>
                                <th class="text-end">Peso</th>
                                <th class="text-end">Pallet</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pedido.produtos.map(prod => `
                                <tr>
                                    <td>${prod.cod_produto} ${prod.nome_produto ? `- ${prod.nome_produto}` : ''}</td>
                                    <td>${formatarNumero(prod.qtd_saldo, 3)}</td>
                                    <td class="text-end">${formatarMoeda(prod.valor_saldo)}</td>
                                    <td class="text-end">${formatarNumero(prod.peso_saldo, 2)} kg</td>
                                    <td class="text-end">${formatarNumero(prod.pallet_saldo, 2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </td>
        `;
        tbody.appendChild(trProdutos);
    });
}

function toggleProdutos(numPedido) {
    const produtosRow = document.getElementById(`produtos-${numPedido}`);
    const icon = document.getElementById(`icon-${numPedido}`);
    
    if (produtosRow.style.display === 'none') {
        produtosRow.style.display = 'table-row';
        icon.className = 'fas fa-chevron-down';
    } else {
        produtosRow.style.display = 'none';
        icon.className = 'fas fa-chevron-right';
    }
}

function toggleTodosPedidos() {
    const todasLinhasProdutos = document.querySelectorAll('.produtos-standby');
    const primeiraLinha = todasLinhasProdutos[0];
    const mostrar = primeiraLinha && primeiraLinha.style.display === 'none';
    
    todasLinhasProdutos.forEach(linha => {
        linha.style.display = mostrar ? 'table-row' : 'none';
        const numPedido = linha.id.replace('produtos-', '');
        const icon = document.getElementById(`icon-${numPedido}`);
        if (icon) {
            icon.className = mostrar ? 'fas fa-chevron-down' : 'fas fa-chevron-right';
        }
    });
}

async function alterarStatus(numPedido, novoStatus) {
    if (!confirm(`Confirma alterar o status do pedido ${numPedido} para ${novoStatus}?`)) {
        return;
    }
    
    try {
        const response = await fetch('/carteira/api/standby/atualizar-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                num_pedido: numPedido,
                novo_status: novoStatus
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', data.message);
            
            if (novoStatus === 'CONFIRMADO') {
                // Remover da lista se foi confirmado
                setTimeout(() => {
                    carregarPedidosStandby();
                }, 1500);
            } else {
                // Apenas atualizar o status na tabela
                const pedido = pedidosStandby.find(p => p.num_pedido === numPedido);
                if (pedido) {
                    pedido.status_standby = novoStatus;
                    renderizarTabela(pedidosStandby);
                }
            }
        } else {
            showAlert('error', data.message || 'Erro ao atualizar status');
        }
    } catch (error) {
        console.error('Erro ao alterar status:', error);
        showAlert('error', 'Erro ao processar solicitação');
    }
}

function filtrarPedidos() {
    const busca = document.getElementById('filtro-busca-standby').value.toLowerCase();
    const tipo = document.getElementById('filtro-tipo-standby').value;
    const status = document.getElementById('filtro-status-standby').value;
    
    const pedidosFiltrados = pedidosStandby.filter(pedido => {
        // Filtro de busca
        if (busca) {
            const textoBusca = `${pedido.num_pedido} ${pedido.nome_cliente} ${pedido.cnpj_cliente}`.toLowerCase();
            if (!textoBusca.includes(busca)) return false;
        }
        
        // Filtro de tipo
        if (tipo && pedido.tipo_standby !== tipo) return false;
        
        // Filtro de status
        if (status && pedido.status_standby !== status) return false;
        
        return true;
    });
    
    renderizarTabela(pedidosFiltrados);
}

function getBadgeClassStatus(status) {
    const classes = {
        'ATIVO': 'bg-success',
        'BLOQ. COML.': 'bg-warning text-dark',
        'SALDO': 'bg-info'
    };
    return classes[status] || 'bg-secondary';
}

function formatarMoeda(valor) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(valor);
}

function formatarNumero(valor, decimais = 2) {
    return parseFloat(valor).toFixed(decimais);
}

function showAlert(type, message) {
    const alertTypes = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    };
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertTypes[type]} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Funções para o modal de observações
let pedidoAtualObservacoes = null;

function abrirModalObservacoes(numPedido, observacoes) {
    pedidoAtualObservacoes = numPedido;
    
    // Criar modal se não existir
    let modal = document.getElementById('modalObservacoes');
    if (!modal) {
        const modalHtml = `
            <div class="modal fade" id="modalObservacoes" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-comment-dots"></i> Observações - Pedido <span id="numPedidoModal"></span>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="listaObservacoes" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                                <!-- Observações serão listadas aqui -->
                            </div>
                            <div class="border-top pt-3">
                                <h6>Adicionar Nova Observação:</h6>
                                <div class="mb-3">
                                    <textarea class="form-control" id="novaObservacao" rows="3" 
                                              placeholder="Digite sua observação..."></textarea>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="salvarObservacao()">
                                    <i class="fas fa-save"></i> Gravar Observação
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modal = document.getElementById('modalObservacoes');
    }
    
    // Atualizar número do pedido
    document.getElementById('numPedidoModal').textContent = numPedido;
    
    // Limpar campo de nova observação
    document.getElementById('novaObservacao').value = '';
    
    // Mostrar observações existentes
    const listaObservacoes = document.getElementById('listaObservacoes');
    if (observacoes && observacoes.length > 0) {
        listaObservacoes.innerHTML = observacoes.map(obs => `
            <div class="card mb-2">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${obs.usuario}</strong>
                            <small class="text-muted ms-2">${obs.data}</small>
                        </div>
                    </div>
                    <p class="mb-0 mt-1">${obs.texto}</p>
                </div>
            </div>
        `).join('');
    } else {
        listaObservacoes.innerHTML = '<p class="text-muted">Nenhuma observação registrada ainda.</p>';
    }
    
    // Mostrar modal
    const modalBS = new bootstrap.Modal(modal);
    modalBS.show();
}

function salvarObservacao() {
    const observacao = document.getElementById('novaObservacao').value.trim();
    
    if (!observacao) {
        showAlert('warning', 'Por favor, digite uma observação');
        return;
    }
    
    fetch('/carteira/api/standby/adicionar-observacao', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            num_pedido: pedidoAtualObservacoes,
            observacao: observacao
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert('success', 'Observação adicionada com sucesso');
            
            // Atualizar lista de observações no modal
            const listaObservacoes = document.getElementById('listaObservacoes');
            const novaObsHtml = `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${data.observacao.usuario}</strong>
                                <small class="text-muted ms-2">${data.observacao.data}</small>
                            </div>
                        </div>
                        <p class="mb-0 mt-1">${data.observacao.texto}</p>
                    </div>
                </div>
            `;
            
            if (listaObservacoes.innerHTML.includes('Nenhuma observação')) {
                listaObservacoes.innerHTML = novaObsHtml;
            } else {
                listaObservacoes.insertAdjacentHTML('beforeend', novaObsHtml);
            }
            
            // Limpar campo
            document.getElementById('novaObservacao').value = '';
            
            // Recarregar dados para atualizar contador
            carregarDados();
        } else {
            showAlert('error', 'Erro ao adicionar observação: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro na requisição:', error);
        // Não mostrar alert duplicado se já foi tratado acima
        if (error.message && error.message.includes('HTTP error')) {
            showAlert('error', 'Erro de conexão ao adicionar observação');
        }
    });
}
</script>
{% endblock %}