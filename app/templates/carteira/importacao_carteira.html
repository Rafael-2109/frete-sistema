{% extends "base.html" %}

{% block title %}Importa√ß√£o de Carteira N√£o-Odoo{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2>Importa√ß√£o de Carteira N√£o-Odoo</h2>
            <hr>
        </div>
    </div>

    <div class="row">
        <!-- Formul√°rio de Upload -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Upload do Arquivo</h5>
                </div>
                <div class="card-body">
                    <form id="formImportacao" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="form-group">
                            <label>Arquivo(s) Excel <span class="text-danger">*</span></label>
                            <input type="file" class="form-control-file" id="arquivo" name="file" accept=".xlsx,.xls" multiple required>
                            <small class="form-text text-muted">
                                ‚úÖ <strong>M√∫ltiplos arquivos aceitos!</strong> Selecione um ou mais arquivos (.xlsx, .xls)
                            </small>
                            <div id="arquivosSelecionados" class="mt-2" style="display: none;">
                                <small class="text-info">
                                    <i class="fas fa-file-excel"></i> <span id="qtdArquivos">0</span> arquivo(s) selecionado(s)
                                </small>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="button" class="btn btn-info" onclick="validarArquivo()">
                                    <i class="fas fa-check"></i> Validar Arquivo
                                </button>
                                <button type="submit" class="btn btn-primary" id="btnImportar" disabled>
                                    <i class="fas fa-upload"></i> Importar
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="limparTudo()">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Template de Exemplo -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Formato Esperado do Arquivo</h5>
                </div>
                <div class="card-body">
                    <h6>Campos do Cabe√ßalho (formato chave-valor):</h6>
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>Coluna A</th>
                                <th>Coluna B</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>NUMERO DO PEDIDO DO REPRESENTANTE</td>
                                <td>PED-001</td>
                            </tr>
                            <tr>
                                <td>CNPJ*</td>
                                <td>12.345.678/0001-23</td>
                            </tr>
                            <tr>
                                <td>NUMERO DO PEDIDO DO CLIENTE</td>
                                <td>CLI-123</td>
                            </tr>
                            <tr>
                                <td>Data Entrega</td>
                                <td>15/08/2024</td>
                            </tr>
                        </tbody>
                    </table>

                    <h6 class="mt-3">Tabela de Produtos:</h6>
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>C√ìDIGO</th>
                                <th>Qtde Solicitada</th>
                                <th>Valor Negociado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>P001</td>
                                <td>100</td>
                                <td>25.50</td>
                            </tr>
                            <tr>
                                <td>P002</td>
                                <td>50</td>
                                <td>30.00</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="alert alert-info mt-3">
                        <strong>Importante:</strong> O CNPJ do cliente deve estar previamente cadastrado no sistema.
                        <a href="{{ url_for('carteira.views_nao_odoo.cadastro_cliente') }}" target="_blank">Cadastrar Cliente</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview e Resultado -->
        <div class="col-md-6">
            <!-- Preview da Valida√ß√£o -->
            <div class="card" id="cardPreview" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">Preview da Importa√ß√£o</h5>
                </div>
                <div class="card-body">
                    <div id="previewContent"></div>
                </div>
            </div>

            <!-- Resultado da Importa√ß√£o -->
            <div class="card" id="cardResultado" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">Resultado da Importa√ß√£o</h5>
                </div>
                <div class="card-body">
                    <div id="resultadoContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ MODAL PARA CADASTRAR CLIENTES NOVOS -->
<div class="modal fade" id="modalCadastrarClientes" tabindex="-1" role="dialog" aria-labelledby="modalCadastrarClientesLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="modalCadastrarClientesLabel">
                    <i class="fas fa-exclamation-triangle"></i> Clientes N√£o Cadastrados - A√ß√£o Necess√°ria
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>üìã Instru√ß√µes:</strong> Os clientes abaixo foram encontrados na Receita Federal mas n√£o est√£o cadastrados no sistema.
                    Revise os dados e selecione o vendedor e equipe de vendas para cada um.
                </div>

                <div id="clientesPendentesContainer">
                    <!-- Preenchido via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar Importa√ß√£o
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmarCadastros" onclick="confirmarCadastrosEImportar()">
                    <i class="fas fa-check"></i> Cadastrar Clientes e Importar Pedidos
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ‚úÖ Vari√°vel global para armazenar arquivos durante o processo
let arquivosParaReimportar = null;
// ‚úÖ Mostrar quantidade de arquivos selecionados
document.getElementById('arquivo').addEventListener('change', function() {
    const qtd = this.files.length;
    if (qtd > 0) {
        document.getElementById('arquivosSelecionados').style.display = 'block';
        document.getElementById('qtdArquivos').textContent = qtd;
    } else {
        document.getElementById('arquivosSelecionados').style.display = 'none';
    }
});

// Validar arquivo antes de importar (apenas primeiro arquivo para preview)
function validarArquivo() {
    const fileInput = document.getElementById('arquivo');
    if (!fileInput.files.length) {
        toastr.warning('Selecione pelo menos um arquivo');
        return;
    }

    const formData = new FormData();
    // Valida apenas o primeiro arquivo para preview
    formData.append('file', fileInput.files[0]);

    // Adicionar CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    formData.append('csrf_token', csrfToken);

    // Mostrar loading
    $('#cardPreview').show();
    $('#previewContent').html(`<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Validando primeiro arquivo (${fileInput.files[0].name})...</div>`);

    $.ajax({
        url: '/carteira/api/importacao-nao-odoo/validar',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': csrfToken
        },
        success: function(response) {
            if (response.success) {
                mostrarPreview(response.preview);

                // Se valida√ß√£o OK, habilita bot√£o de importar
                if (!response.preview.erros || response.preview.erros.length === 0) {
                    $('#btnImportar').prop('disabled', false);
                }
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Erro ao validar arquivo';
            $('#previewContent').html(`<div class="alert alert-danger">${error}</div>`);
            $('#btnImportar').prop('disabled', true);
        }
    });
}

// Mostrar preview da valida√ß√£o
function mostrarPreview(preview) {
    let html = '';
    
    // Erros
    if (preview.erros && preview.erros.length > 0) {
        html += '<div class="alert alert-danger">';
        html += '<strong>Erros encontrados:</strong><ul>';
        preview.erros.forEach(erro => {
            html += `<li>${erro}</li>`;
        });
        html += '</ul></div>';
    }
    
    // Avisos
    if (preview.avisos && preview.avisos.length > 0) {
        html += '<div class="alert alert-warning">';
        html += '<strong>Avisos:</strong><ul>';
        preview.avisos.forEach(aviso => {
            html += `<li>${aviso}</li>`;
        });
        html += '</ul></div>';
    }
    
    // Dados do cliente
    if (preview.cliente) {
        if (preview.cliente.encontrado) {
            html += `<div class="alert alert-success">
                <strong>Cliente encontrado:</strong> ${preview.cliente.raz_social}<br>
                ${preview.cliente.municipio}/${preview.cliente.estado}
            </div>`;
        } else {
            html += `<div class="alert alert-danger">
                <strong>Cliente n√£o cadastrado:</strong> CNPJ ${preview.cliente.cnpj}<br>
                <a href="{{ url_for('carteira.views_nao_odoo.cadastro_cliente') }}" target="_blank" class="btn btn-sm btn-primary">
                    Cadastrar Cliente
                </a>
            </div>`;
        }
    }
    
    // Mostrar dados no formato da tabela esperada
    html += '<h6>Conte√∫do do Arquivo:</h6>';
    html += '<table class="table table-sm table-bordered">';
    
    // Cabe√ßalho - formato chave-valor
    if (preview.cabecalho) {
        const mapeamentoCabecalho = {
            'num_pedido': 'NUMERO DO PEDIDO DO REPRESENTANTE',
            'cnpj_cpf': 'CNPJ*',
            'pedido_cliente': 'NUMERO DO PEDIDO DO CLIENTE',
            'data_entrega': 'Data Entrega'
        };
        
        Object.keys(mapeamentoCabecalho).forEach(key => {
            if (preview.cabecalho[key]) {
                html += `<tr>
                    <td><strong>${mapeamentoCabecalho[key]}</strong></td>
                    <td>${preview.cabecalho[key]}</td>
                    <td></td>
                </tr>`;
            }
        });
        
        // Linha em branco para separar
        html += '<tr><td colspan="3">&nbsp;</td></tr>';
    }
    
    // Cabe√ßalho da tabela de produtos
    html += '<tr class="table-active">';
    html += '<th>C√ìDIGO</th>';
    html += '<th>Qtde Solicitada</th>';
    html += '<th>Valor Negociado</th>';
    html += '</tr>';
    
    // Produtos
    if (preview.produtos && preview.produtos.length > 0) {
        preview.produtos.forEach(produto => {
            html += `<tr>
                <td>${produto.cod_produto}</td>
                <td>${produto.qtd_produto_pedido}</td>
                <td>R$ ${produto.preco_produto_pedido.toFixed(2)}</td>
            </tr>`;
        });
    } else {
        html += '<tr><td colspan="3" class="text-center text-muted">Nenhum produto v√°lido encontrado (quantidade > 0)</td></tr>';
    }
    
    html += '</table>';
    
    // Resumo
    if (preview.produtos && preview.produtos.length > 0) {
        html += `<p class="text-info"><strong>Total de produtos v√°lidos: ${preview.total_produtos}</strong></p>`;
    }
    
    $('#previewContent').html(html);
}

// ‚úÖ Submit do formul√°rio com M√öLTIPLOS ARQUIVOS
$('#formImportacao').submit(function(e) {
    e.preventDefault();

    const fileInput = document.getElementById('arquivo');
    if (!fileInput.files.length) {
        toastr.warning('Selecione pelo menos um arquivo');
        return;
    }

    const formData = new FormData();

    // ‚úÖ Adicionar TODOS os arquivos selecionados
    for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('file', fileInput.files[i]);
    }

    // Adicionar CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    formData.append('csrf_token', csrfToken);

    // Desabilitar bot√µes
    const qtdArquivos = fileInput.files.length;
    $('#btnImportar').prop('disabled', true).html(`<i class="fas fa-spinner fa-spin"></i> Importando ${qtdArquivos} arquivo(s)...`);

    $.ajax({
        url: '/carteira/api/importacao-nao-odoo/upload',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': csrfToken
        },
        success: function(response) {
            if (response.success) {
                mostrarResultado(response);
                // Limpar formul√°rio
                $('#formImportacao')[0].reset();
                $('#btnImportar').prop('disabled', true).html('<i class="fas fa-upload"></i> Importar');
                $('#cardPreview').hide();
                $('#arquivosSelecionados').hide();
            } else if (response.pendente_cadastro) {
                // ‚úÖ H√Å CLIENTES PENDENTES - MOSTRAR MODAL
                arquivosParaReimportar = fileInput.files;  // Salvar arquivos para reimportar
                mostrarModalCadastroClientes(response.clientes_pendentes);
                $('#btnImportar').prop('disabled', false).html('<i class="fas fa-upload"></i> Importar');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON : {error: 'Erro ao importar arquivos'};
            mostrarErro(error);
            $('#btnImportar').prop('disabled', false).html('<i class="fas fa-upload"></i> Importar');
        }
    });
});

// ‚úÖ Mostrar resultado da importa√ß√£o (M√öLTIPLOS ARQUIVOS)
function mostrarResultado(response) {
    $('#cardResultado').show();

    let html = '<div class="alert alert-success">';
    html += `<strong>${response.mensagem}</strong><br>`;
    html += `üìÅ Total de arquivos: ${response.total_arquivos}<br>`;
    html += `‚úÖ Arquivos processados: ${response.arquivos_processados}<br>`;
    if (response.arquivos_com_erro > 0) {
        html += `‚ùå Arquivos com erro: ${response.arquivos_com_erro}<br>`;
    }
    html += `üì¶ Total de pedidos importados: ${response.total_pedidos_importados}`;
    html += '</div>';

    // ‚úÖ Mostrar detalhes por arquivo
    if (response.detalhes_por_arquivo && response.detalhes_por_arquivo.length > 0) {
        html += '<h6>Detalhes por Arquivo:</h6>';

        response.detalhes_por_arquivo.forEach((arquivo, index) => {
            const statusClass = arquivo.success ? 'success' : 'danger';
            const statusIcon = arquivo.success ? '‚úÖ' : '‚ùå';

            html += `<div class="card mb-2">`;
            html += `<div class="card-header bg-${statusClass} text-white">`;
            html += `${statusIcon} ${arquivo.nome_arquivo} - ${arquivo.pedidos_importados} pedido(s) importado(s)`;
            html += `</div>`;

            if (arquivo.erros && arquivo.erros.length > 0) {
                html += `<div class="card-body">`;
                html += `<div class="alert alert-danger mb-0">`;
                html += `<strong>Erros:</strong><ul class="mb-0">`;
                arquivo.erros.forEach(erro => {
                    html += `<li>${erro}</li>`;
                });
                html += `</ul></div></div>`;
            }

            if (arquivo.avisos && arquivo.avisos.length > 0) {
                html += `<div class="card-body">`;
                html += `<div class="alert alert-warning mb-0">`;
                html += `<strong>Avisos:</strong><ul class="mb-0">`;
                arquivo.avisos.forEach(aviso => {
                    html += `<li>${aviso}</li>`;
                });
                html += `</ul></div></div>`;
            }

            html += `</div>`;
        });
    }

    html += '<div class="mt-3">';
    html += '<a href="{{ url_for("carteira.views_nao_odoo.carteira_nao_odoo") }}" class="btn btn-primary">Ver Carteira N√£o-Odoo</a>';

    // ‚úÖ BOT√ÉO PARA BAIXAR EXCEL DE ERROS
    if (response.excel_erros) {
        html += ' <button class="btn btn-warning" onclick="baixarExcelErros()"><i class="fas fa-download"></i> Baixar Excel com Erros</button>';
        // Salvar Excel globalmente
        window.excelErrosBase64 = response.excel_erros;
    }

    html += '</div>';

    $('#resultadoContent').html(html);
}

// ‚úÖ Mostrar erro (M√öLTIPLOS ARQUIVOS)
function mostrarErro(error) {
    $('#cardResultado').show();

    let html = '<div class="alert alert-danger">';
    html += '<strong>Erro na importa√ß√£o:</strong><br>';

    // ‚úÖ Se houver detalhes por arquivo
    if (error.detalhes_por_arquivo && error.detalhes_por_arquivo.length > 0) {
        html += `<p>Total de arquivos: ${error.total_arquivos} | Erros: ${error.arquivos_com_erro}</p>`;
        html += '</div>';

        error.detalhes_por_arquivo.forEach((arquivo, index) => {
            if (arquivo.erros && arquivo.erros.length > 0) {
                html += `<div class="alert alert-danger mt-2">`;
                html += `<strong>‚ùå ${arquivo.nome_arquivo}:</strong><ul>`;
                arquivo.erros.forEach(erro => {
                    html += `<li>${erro}</li>`;
                });
                html += `</ul></div>`;
            }
        });
    } else if (error.erros && Array.isArray(error.erros)) {
        html += '<ul>';
        error.erros.forEach(erro => {
            html += `<li>${erro}</li>`;
        });
        html += '</ul></div>';
    } else {
        html += (error.error || 'Erro desconhecido') + '</div>';
    }

    $('#resultadoContent').html(html);
}

// Limpar tudo
function limparTudo() {
    $('#formImportacao')[0].reset();
    $('#btnImportar').prop('disabled', true);
    $('#cardPreview').hide();
    $('#cardResultado').hide();
}

// ‚úÖ FUN√á√ÉO PARA MOSTRAR MODAL DE CADASTRO DE CLIENTES
function mostrarModalCadastroClientes(clientesPendentes) {
    let html = '';

    clientesPendentes.forEach((cliente, index) => {
        const dados = cliente.dados_receita;

        html += `
        <div class="card mb-3" data-cnpj="${cliente.cnpj}">
            <div class="card-header bg-light">
                <strong><i class="fas fa-building"></i> Cliente Novo: ${dados.nome || 'N/A'}</strong>
                <span class="badge badge-info ml-2">Arquivo: ${cliente.arquivo_origem}</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>CNPJ:</strong> ${dados.cnpj || cliente.cnpj}</p>
                        <p class="mb-1"><strong>Raz√£o Social:</strong> ${dados.nome || 'N/A'}</p>
                        <p class="mb-1"><strong>Nome Fantasia:</strong> ${dados.fantasia || 'N/A'}</p>
                        <p class="mb-1"><strong>Situa√ß√£o:</strong> <span class="badge badge-${dados.situacao === 'ATIVA' ? 'success' : 'warning'}">${dados.situacao || 'N/A'}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Cidade/UF:</strong> ${dados.municipio || 'N/A'}/${dados.uf || 'N/A'}</p>
                        <p class="mb-1"><strong>Telefone:</strong> ${dados.telefone || 'N/A'}</p>
                        <p class="mb-1"><strong>Abertura:</strong> ${dados.abertura || 'N/A'}</p>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label><i class="fas fa-user-tie"></i> Vendedor <span class="text-danger">*</span></label>
                            <small class="d-block text-muted mb-1">Sugest√£o do Excel: <strong>${cliente.vendedor_sugerido || 'N/A'}</strong></small>
                            <select class="form-control vendedor-select" data-cnpj="${cliente.cnpj}" data-sugestao="${cliente.vendedor_sugerido || ''}" required>
                                <option value="">-- Selecione um vendedor --</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label><i class="fas fa-users"></i> Equipe de Vendas <span class="text-danger">*</span></label>
                            <small class="d-block text-muted mb-1">Sugest√£o do Excel: <strong>${cliente.equipe_sugerida || 'N/A'}</strong></small>
                            <select class="form-control equipe-select" data-cnpj="${cliente.cnpj}" data-sugestao="${cliente.equipe_sugerida || ''}" required>
                                <option value="">-- Selecione uma equipe --</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
    });

    $('#clientesPendentesContainer').html(html);

    // ‚úÖ BUSCAR LISTAS DE VENDEDORES E EQUIPES
    $.get('/carteira/api/listar-vendedores-equipes', function(data) {
        if (data.success) {
            // Preencher vendedores
            $('.vendedor-select').each(function() {
                const select = $(this);
                const sugestao = select.data('sugestao');

                data.vendedores.forEach(vendedor => {
                    const selected = vendedor === sugestao ? 'selected' : '';
                    select.append(`<option value="${vendedor}" ${selected}>${vendedor}</option>`);
                });
            });

            // Preencher equipes
            $('.equipe-select').each(function() {
                const select = $(this);
                const sugestao = select.data('sugestao');

                data.equipes.forEach(equipe => {
                    const selected = equipe === sugestao ? 'selected' : '';
                    select.append(`<option value="${equipe}" ${selected}>${equipe}</option>`);
                });
            });
        } else {
            toastr.error('Erro ao carregar listas de vendedores e equipes');
        }
    });

    // Mostrar modal
    $('#modalCadastrarClientes').modal('show');
}

// ‚úÖ FUN√á√ÉO PARA CONFIRMAR CADASTROS E REIMPORTAR
function confirmarCadastrosEImportar() {
    const clientes = [];
    let todosPreenchidos = true;

    // Coletar dados de cada cliente
    $('.vendedor-select').each(function() {
        const cnpj = $(this).data('cnpj');
        const vendedor = $(this).val();
        const equipe = $(`.equipe-select[data-cnpj="${cnpj}"]`).val();

        if (!vendedor || !equipe) {
            todosPreenchidos = false;
            $(this).addClass('is-invalid');
            $(`.equipe-select[data-cnpj="${cnpj}"]`).addClass('is-invalid');
            return false;  // Parar loop
        }

        // Buscar dados_receita do card
        const card = $(`.card[data-cnpj="${cnpj}"]`);

        // Pegar dados do cliente pendente original
        const clientePendente = window.clientesPendentesData.find(c => c.cnpj === cnpj);

        clientes.push({
            cnpj: cnpj,
            vendedor: vendedor,
            equipe_vendas: equipe,
            dados_receita: clientePendente.dados_receita
        });
    });

    if (!todosPreenchidos) {
        toastr.error('Preencha vendedor e equipe para todos os clientes');
        return;
    }

    // Desabilitar bot√£o
    $('#btnConfirmarCadastros').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Cadastrando...');

    // ‚úÖ ENVIAR PARA CADASTRAR CLIENTES
    $.ajax({
        url: '/carteira/api/cadastrar-cliente-e-importar',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({clientes: clientes}),
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        success: function(response) {
            if (response.success && response.reenviar_importacao) {
                toastr.success(response.mensagem);

                // Fechar modal
                $('#modalCadastrarClientes').modal('hide');

                // ‚úÖ REIMPORTAR ARQUIVOS AUTOMATICAMENTE
                setTimeout(() => {
                    reenviarArquivos();
                }, 500);
            } else {
                toastr.error(response.mensagem || 'Erro ao cadastrar clientes');
                $('#btnConfirmarCadastros').prop('disabled', false).html('<i class="fas fa-check"></i> Cadastrar Clientes e Importar Pedidos');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Erro ao cadastrar clientes';
            toastr.error(error);
            $('#btnConfirmarCadastros').prop('disabled', false).html('<i class="fas fa-check"></i> Cadastrar Clientes e Importar Pedidos');
        }
    });
}

// ‚úÖ FUN√á√ÉO PARA REENVIAR ARQUIVOS AP√ìS CADASTRO
function reenviarArquivos() {
    if (!arquivosParaReimportar || arquivosParaReimportar.length === 0) {
        toastr.error('Nenhum arquivo para reimportar');
        return;
    }

    const formData = new FormData();

    // Adicionar arquivos salvos
    for (let i = 0; i < arquivosParaReimportar.length; i++) {
        formData.append('file', arquivosParaReimportar[i]);
    }

    // Adicionar CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    formData.append('csrf_token', csrfToken);

    // Mostrar loading
    toastr.info('Reimportando arquivos com clientes cadastrados...');
    $('#btnImportar').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Reimportando...');

    $.ajax({
        url: '/carteira/api/importacao-nao-odoo/upload',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': csrfToken
        },
        success: function(response) {
            if (response.success) {
                mostrarResultado(response);
                toastr.success('Importa√ß√£o conclu√≠da com sucesso!');

                // Limpar
                arquivosParaReimportar = null;
                $('#formImportacao')[0].reset();
                $('#btnImportar').prop('disabled', true).html('<i class="fas fa-upload"></i> Importar');
                $('#cardPreview').hide();
                $('#arquivosSelecionados').hide();
            } else if (response.pendente_cadastro) {
                // Se ainda houver pend√™ncias (n√£o deveria acontecer)
                toastr.warning('Ainda h√° clientes pendentes de cadastro');
                mostrarModalCadastroClientes(response.clientes_pendentes);
                $('#btnImportar').prop('disabled', false).html('<i class="fas fa-upload"></i> Importar');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON : {error: 'Erro ao reimportar arquivos'};
            mostrarErro(error);
            $('#btnImportar').prop('disabled', false).html('<i class="fas fa-upload"></i> Importar');
        }
    });
}

// ‚úÖ Vari√°vel global para armazenar dados dos clientes pendentes
let clientesPendentesData = [];

// ‚úÖ Atualizar mostrarModalCadastroClientes para salvar dados globalmente
const mostrarModalOriginal = mostrarModalCadastroClientes;
mostrarModalCadastroClientes = function(clientesPendentes) {
    window.clientesPendentesData = clientesPendentes;  // Salvar globalmente
    mostrarModalOriginal(clientesPendentes);
};

// ‚úÖ FUN√á√ÉO PARA BAIXAR EXCEL DE ERROS
function baixarExcelErros() {
    if (!window.excelErrosBase64) {
        toastr.error('Excel de erros n√£o dispon√≠vel');
        return;
    }

    try {
        // Converter base64 para blob
        const byteCharacters = atob(window.excelErrosBase64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});

        // Criar link de download
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `erros_importacao_${new Date().getTime()}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        toastr.success('Excel de erros baixado com sucesso!');
    } catch (e) {
        console.error('Erro ao baixar Excel:', e);
        toastr.error('Erro ao baixar Excel de erros');
    }
}
</script>
{% endblock %}