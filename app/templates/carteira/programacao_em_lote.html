{% extends "base.html" %}

{% block title %}Programação em Lote - {{ rede }} SP{% endblock %}

{% block styles %}
<style>
    /* Estilos para as cores das linhas conforme status */
    .table-danger {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }
    
    .table-warning {
        background-color: rgba(255, 193, 7, 0.1) !important;
    }
    
    .table-info {
        background-color: rgba(13, 202, 240, 0.1) !important;
    }
    
    .table-success {
        background-color: rgba(25, 135, 84, 0.1) !important;
    }
    
    /* Ajuste hover para linhas coloridas */
    .table-hover tbody tr.table-danger:hover {
        background-color: rgba(220, 53, 69, 0.2) !important;
    }
    
    .table-hover tbody tr.table-warning:hover {
        background-color: rgba(255, 193, 7, 0.2) !important;
    }
    
    .table-hover tbody tr.table-info:hover {
        background-color: rgba(13, 202, 240, 0.2) !important;
    }
    
    .table-hover tbody tr.table-success:hover {
        background-color: rgba(25, 135, 84, 0.2) !important;
    }
    
    /* Estilos para badges de status */
    .badge {
        font-weight: 500;
        letter-spacing: 0.3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-network-wired text-warning"></i>
                Programação em Lote - {{ rede }} SP 
                <span style="font-size: 0.8em; font-weight: bold;">- {{ vendedor or 'Sem vendedor' }} - {{ equipe_vendas or 'Sem equipe' }}</span>
            </h1>
            <p class="text-muted mb-0">
                Gestão unificada de pedidos para {{ rede }} em São Paulo
            </p>
        </div>
        <div>
            {% if rede == 'sendas' %}
            <button class="btn btn-dark me-2" id="btnImportarAgendamentos">
                <i class="fas fa-file-excel"></i> Importar Agendamentos Assai
            </button>
            <button class="btn btn-warning me-2" onclick="abrirModalImportarPlanilhaSendas()">
                <i class="fas fa-file-import"></i> Importar Agenda Disp. Sendas
            </button>
            <button class="btn btn-success me-2" onclick="solicitarAgendamentoSendasLote()">
                <i class="fas fa-calendar-check"></i> Solicitar Agendamento Sendas
            </button>
            <a href="/portal/sendas/exportacao" class="btn btn-info me-2" target="_blank">
                <i class="fas fa-file-export"></i> Exportar Planilhas Sendas
            </a>
            <a href="/portal/sendas/verificacao" class="btn btn-success me-2" target="_blank">
                <i class="fas fa-check-circle"></i> Verificar Agendamentos Sendas
            </a>
            {% endif %}
            <button class="btn btn-info me-2" id="btnAnalisarEstoques">
                <i class="fas fa-chart-line"></i> Analisar Estoques
            </button>
            <button class="btn btn-warning me-2" id="btnSugerirDatas">
                <i class="fas fa-magic"></i> Sugerir Datas
            </button>
            <button class="btn btn-primary me-2" id="btnSelecionarTodos">
                <i class="fas fa-check-square"></i> Selecionar Todos
            </button>
            <button class="btn btn-success me-2" id="btnProcessarLote" disabled>
                <i class="fas fa-calendar-alt"></i> Agendar Selecionados
            </button>
            <a href="{{ url_for('carteira.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Cards de Resumo -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total de CNPJs
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ total_cnpjs }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-building fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Valor Total
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                R$ <span id="valorTotalGeral">0,00</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Peso Total
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                <span id="pesoTotalGeral">0</span> kg
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-weight fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pallets Total
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                <span id="palletsTotalGeral">0</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-pallet fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dropdown de Análise de Estoques (inicialmente oculto) -->
    <div class="card shadow mb-4 d-none" id="cardAnaliseEstoques">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-chart-line"></i> Análise de Estoques - Itens da Rede
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-bordered" id="tabelaAnaliseEstoques">
                    <thead class="sticky-top bg-white">
                        <tr>
                            <th>Código</th>
                            <th>Produto</th>
                            <th>Qtd Total</th>
                            <th>Valor Total</th>
                            <th>Estoque Atual</th>
                            <th>Data Disponível</th>
                            <th>Projeção 15 dias</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tabela de CNPJs -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-list"></i> Clientes {{ rede }} SP
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="tabelaProgramacao">
                    <thead>
                        <tr class="bg-light">
                            <th width="40">
                                <input type="checkbox" id="checkTodos" title="Selecionar apenas Pendentes e Reagendar" />
                            </th>
                            <th>Cliente</th>
                            <th>Cidade</th>
                            <th>Valor Total</th>
                            <th>Peso (kg)</th>
                            <th>Pallets</th>
                            <th>Expedição</th>
                            <th>Agendamento</th>
                            <th>Status</th>
                            <th width="150">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cnpj_data in dados_cnpj %}
                        <tr class="cnpj-row {{ cnpj_data.cor_linha }}" data-cnpj="{{ cnpj_data.cnpj }}" data-status="{{ cnpj_data.status }}">
                            <td class="text-center">
                                <input type="checkbox" class="check-cnpj" value="{{ cnpj_data.cnpj }}" data-status="{{ cnpj_data.status }}" />
                            </td>
                            <td>
                                <div style="font-size: 0.95em; font-weight: 500;">{{ cnpj_data.raz_social }}</div>
                                <div style="font-size: 0.75em; color: #6c757d;">{{ cnpj_data.cnpj_formatado }}</div>
                            </td>
                            <td>
                                <div>{{ cnpj_data.cidade }}</div>
                                <div style="font-size: 0.75em; color: #6c757d;">Sub-Rota: {{ cnpj_data.sub_rota or '-' }}</div>
                            </td>
                            <td class="text-end" style="font-size: 0.9em;">R$ {{ "{:,.2f}".format(cnpj_data.total_valor) }}</td>
                            <td class="text-end" style="font-size: 0.9em;">{{ "{:,.2f}".format(cnpj_data.total_peso) }}</td>
                            <td class="text-end" style="font-size: 0.9em;">{{ "{:,.2f}".format(cnpj_data.total_pallets) }}</td>
                            <td>
                                <input type="date" class="form-control form-control-sm data-expedicao" 
                                       data-cnpj="{{ cnpj_data.cnpj }}" 
                                       value="{{ cnpj_data.expedicao_sugerida }}"
                                       style="width: 110px; font-size: 0.85em;">
                            </td>
                            <td>
                                <input type="date" class="form-control form-control-sm data-agendamento" 
                                       data-cnpj="{{ cnpj_data.cnpj }}"
                                       value="{{ cnpj_data.agendamento_sugerido }}"
                                       style="width: 110px; font-size: 0.85em;">
                            </td>
                            <td class="text-center">
                                {% if cnpj_data.status %}
                                    <span class="badge 
                                        {% if cnpj_data.status == 'Reagendar' %}bg-danger{% elif cnpj_data.status == 'Consolidar' %}bg-warning text-dark{% elif cnpj_data.status == 'Ag. Aprovação' %}bg-info{% elif cnpj_data.status == 'Pronto' %}bg-success{% else %}bg-secondary{% endif %}"
                                        style="font-size: 0.8em; padding: 4px 8px;">
                                        <i class="fas {{ cnpj_data.icone_status }} me-1"></i>
                                        {{ cnpj_data.status }}
                                    </span>
                                {% else %}
                                    <span style="color: #6c757d; font-size: 0.85em;">Pendente</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-warning btn-priorizar" 
                                        data-cnpj="{{ cnpj_data.cnpj }}"
                                        title="Priorizar">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="btn btn-sm btn-primary btn-analisar-ruptura" 
                                        data-cnpj="{{ cnpj_data.cnpj }}"
                                        data-pedidos="{% if cnpj_data.pedidos %}{% for p in cnpj_data.pedidos %}{{ p.num_pedido }}{% if not loop.last %},{% endif %}{% endfor %}{% endif %}"
                                        title="Analisar ruptura"
                                        style="min-width: 120px; font-size: 0.75em;">
                                    <span class="ruptura-info">Analisando...</span>
                                </button>
                                <button class="btn btn-sm btn-info btn-expandir" 
                                        data-cnpj="{{ cnpj_data.cnpj }}"
                                        title="Ver detalhes">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </td>
                        </tr>
                        
                        <!-- Linha de detalhes (inicialmente oculta) -->
                        <tr class="detail-row d-none" data-cnpj-detail="{{ cnpj_data.cnpj }}">
                            <td colspan="10">
                                <div class="p-3 bg-light">
                                    <h6 class="mb-3">
                                        <i class="fas fa-clipboard-list"></i> 
                                        Detalhes dos Pedidos - {{ cnpj_data.raz_social }}
                                    </h6>
                                    
                                    {% for pedido in cnpj_data.pedidos %}
                                    <div class="card mb-2">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-2">
                                                    <strong>Pedido:</strong><br>
                                                    {{ pedido.num_pedido }}
                                                </div>
                                                <div class="col-md-2">
                                                    <strong>Data:</strong><br>
                                                    {{ pedido.data_pedido.strftime('%d/%m/%Y') if pedido.data_pedido else '-' }}
                                                </div>
                                                <div class="col-md-2">
                                                    <strong>Pedido Cliente:</strong><br>
                                                    {{ pedido.pedido_cliente or '-' }}
                                                </div>
                                                <div class="col-md-2">
                                                    <strong>Status:</strong><br>
                                                    <span class="badge 
                                                        {% if pedido.status == 'PENDENTE' %}bg-warning text-dark
                                                        {% elif pedido.status == 'NF_CD_SEM_CARTEIRA' %}bg-danger
                                                        {% else %}bg-info text-dark{% endif %}">
                                                        {{ pedido.status }}
                                                    </span>
                                                </div>
                                                <div class="col-md-4">
                                                    <strong>Observações:</strong><br>
                                                    {{ pedido.observacoes or '-' }}
                                                </div>
                                            </div>
                                            
                                            {% if pedido.qtd_pendente > 0 %}
                                            <div class="mt-2">
                                                <span class="text-muted">Pendente:</span>
                                                <span class="badge bg-warning text-dark">
                                                    R$ {{ "{:,.2f}".format(pedido.valor_pendente) }} |
                                                    {{ "{:,.2f}".format(pedido.peso_pendente) }} kg |
                                                    {{ "{:,.2f}".format(pedido.pallets_pendente) }} pallets
                                                </span>
                                            </div>
                                            {% endif %}
                                            
                                            {% if pedido.separacoes %}
                                            <div class="mt-2">
                                                <strong>Separações:</strong>
                                                {% for sep in pedido.separacoes %}
                                                <div class="ms-3 mb-1">
                                                    <span class="text-muted">{{ sep.separacao_lote_id }}:</span>
                                                    <span class="badge bg-info text-dark">
                                                        {{ sep.status }}
                                                    </span>
                                                    <span class="badge bg-light text-dark border">
                                                        R$ {{ "{:,.2f}".format(sep.valor_total) if sep.valor_total else '0,00' }} |
                                                        {{ "{:,.2f}".format(sep.peso_total) if sep.peso_total else '0,00' }} kg |
                                                        {{ "{:,.2f}".format(sep.pallet_total) if sep.pallet_total else '0,00' }} pallets
                                                    </span>
                                                    <span class="badge {% if sep.agendamento_confirmado %}bg-success{% else %}bg-secondary{% endif %}">
                                                        Exp: {{ sep.expedicao.strftime('%d/%m') if sep.expedicao else '-' }} |
                                                        Agenda: {{ sep.agendamento.strftime('%d/%m') if sep.agendamento else '-' }}
                                                    </span>
                                                    {% if sep.protocolo %}
                                                    <span class="badge bg-primary">
                                                        <i class="fas fa-check-circle"></i> Prot: {{ sep.protocolo }}
                                                    </span>
                                                    {% endif %}
                                                    {% if sep.agendamento_confirmado %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check-double"></i> Confirmado
                                                    </span>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            
                                            {% if pedido.nfs_cd %}
                                            <div class="mt-2">
                                                <strong>NFs no CD:</strong>
                                                {% for nf in pedido.nfs_cd %}
                                                <div class="ms-3 mb-1">
                                                    <span class="text-muted">NF {{ nf.numero_nf }}:</span>
                                                    <span class="badge bg-danger">
                                                        {{ nf.status }}
                                                    </span>
                                                    <span class="badge bg-light text-dark border">
                                                        R$ {{ "{:,.2f}".format(nf.valor) if nf.valor else '0,00' }} |
                                                        {{ "{:,.2f}".format(nf.peso) if nf.peso else '0,00' }} kg |
                                                        {{ "{:,.2f}".format(nf.pallet) if nf.pallet else '0,00' }} pallets
                                                    </span>
                                                    {% if nf.expedicao or nf.agendamento %}
                                                    <span class="badge bg-secondary">
                                                        Exp: {{ nf.expedicao.strftime('%d/%m') if nf.expedicao else '-' }} |
                                                        Agenda: {{ nf.agendamento.strftime('%d/%m') if nf.agendamento else '-' }}
                                                    </span>
                                                    {% endif %}
                                                    {% if nf.protocolo %}
                                                    <span class="badge bg-primary">
                                                        <i class="fas fa-check-circle"></i> Prot: {{ nf.protocolo }}
                                                    </span>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Importação de Agendamentos Assai -->
<div class="modal fade" id="modalImportarAgendamentos" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-excel"></i> Importar Agendamentos Assai
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Instruções -->
                <div class="alert alert-info">
                    <h6 class="alert-heading"><i class="fas fa-info-circle"></i> Formato do arquivo Excel:</h6>
                    <ul class="mb-0">
                        <li><strong>ID</strong> - Número do protocolo de agendamento</li>
                        <li><strong>Status</strong> - "Aprovada" ou "Pendente"</li>
                        <li><strong>CNPJ Terminal</strong> - CNPJ numérico sem formatação</li>
                        <li><strong>Data Efetiva</strong> - Data/hora do agendamento (formato: DD/MM/AAAA HH:MM:SS)</li>
                        <li><strong>Unidade Destino</strong> - Nome da filial (opcional)</li>
                    </ul>
                </div>
                
                <!-- Upload de arquivo -->
                <div class="mb-3">
                    <label class="form-label"><strong>Selecione o arquivo Excel:</strong></label>
                    <input type="file" class="form-control" id="fileImportarAgendamentos" accept=".xlsx,.xls">
                    <div class="form-text">Formatos aceitos: .xlsx, .xls</div>
                </div>
                
                <!-- Área de progresso (inicialmente oculta) -->
                <div id="progressoImportacao" class="d-none">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
                            Processando...
                        </div>
                    </div>
                </div>
                
                <!-- Área de resultado (inicialmente oculta) -->
                <div id="resultadoImportacao" class="d-none">
                    <!-- Resumo -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Resumo da Importação</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col">
                                    <div class="h5 mb-0 text-primary" id="totalProcessados">0</div>
                                    <small class="text-muted">Processados</small>
                                </div>
                                <div class="col">
                                    <div class="h5 mb-0 text-success" id="totalCriados">0</div>
                                    <small class="text-muted">Criados</small>
                                </div>
                                <div class="col">
                                    <div class="h5 mb-0 text-info" id="totalAtualizados">0</div>
                                    <small class="text-muted">Atualizados</small>
                                </div>
                                <div class="col">
                                    <div class="h5 mb-0 text-warning" id="totalNaoEncontrados">0</div>
                                    <small class="text-muted">Não Encontrados</small>
                                </div>
                                <div class="col">
                                    <div class="h5 mb-0 text-danger" id="totalErros">0</div>
                                    <small class="text-muted">Erros</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CNPJs não encontrados -->
                    <div id="areaNaoEncontrados" class="card mb-3 d-none">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> CNPJs Não Encontrados no Sistema</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>CNPJ</th>
                                            <th>Protocolo</th>
                                            <th>Unidade</th>
                                            <th>Status</th>
                                            <th>Data</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaNaoEncontrados"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Erros -->
                    <div id="areaErros" class="card d-none">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0"><i class="fas fa-times-circle"></i> Erros Encontrados</h6>
                        </div>
                        <div class="card-body">
                            <ul id="listaErros" class="mb-0" style="max-height: 150px; overflow-y: auto;"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-dark" id="btnConfirmarImportacao">
                    <i class="fas fa-upload"></i> Importar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Agendamento em Lote -->
<div class="modal fade" id="modalAgendamento" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-alt"></i> Agendamento em Lote
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span id="qtdSelecionados">0</span> CNPJs selecionados para agendamento
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Data de Expedição:</label>
                        <input type="date" class="form-control" id="dataExpedicao" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Data de Agendamento:</label>
                        <input type="date" class="form-control" id="dataAgendamento">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Observações:</label>
                    <textarea class="form-control" id="observacoesLote" rows="3"></textarea>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Esta ação irá processar o agendamento de todos os pedidos pendentes dos CNPJs selecionados.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarAgendamento">
                    <i class="fas fa-check"></i> Confirmar Agendamento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Importação da Planilha Sendas -->
<div class="modal fade" id="modalImportarPlanilhaSendas" tabindex="-1" aria-labelledby="modalImportarPlanilhaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalImportarPlanilhaLabel">
          <i class="fas fa-file-import"></i> Importar Agenda Disponível Sendas
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formImportarPlanilhaSendas" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="arquivoPlanilha" class="form-label">Selecione a planilha modelo (.xlsx)</label>
            <input type="file" class="form-control" id="arquivoPlanilha" name="arquivo" accept=".xlsx" required>
            <div class="form-text">Baixe a planilha do portal Sendas e faça upload aqui</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="importarPlanilhaSendas()">
          <i class="fas fa-upload"></i> Importar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Incluir modais de comparação Sendas -->
{% include 'portal/sendas/modals_comparacao.html' %}

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{{ url_for('static', filename='js/sendas_comparacao.js') }}"></script>
<script>
    // Dados do portal para o JavaScript
    window.PORTAL_CONFIG = {
        portal: '{{ portal }}',
        rede: '{{ rede }}'
    };

    // Função para abrir o modal de importação
    function abrirModalImportarPlanilhaSendas() {
        const modal = new bootstrap.Modal(document.getElementById('modalImportarPlanilhaSendas'));
        modal.show();
    }

    // Função para importar a planilha
    function importarPlanilhaSendas() {
        const fileInput = document.getElementById('arquivoPlanilha');
        const file = fileInput.files[0];

        if (!file) {
            alert('Por favor, selecione um arquivo');
            return;
        }

        const formData = new FormData();
        formData.append('arquivo', file);

        // Mostrar loading
        const btnImportar = event.target;
        const textoOriginal = btnImportar.innerHTML;
        btnImportar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando...';
        btnImportar.disabled = true;

        fetch('/portal/sendas/importar-planilha-modelo', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrf_token]')?.value || ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                alert(data.mensagem);
                // Fechar modal
                bootstrap.Modal.getInstance(document.getElementById('modalImportarPlanilhaSendas')).hide();
                // Limpar formulário
                document.getElementById('formImportarPlanilhaSendas').reset();
            } else {
                alert('Erro: ' + data.mensagem);
            }
        })
        .catch(error => {
            alert('Erro ao importar planilha: ' + error);
        })
        .finally(() => {
            btnImportar.innerHTML = textoOriginal;
            btnImportar.disabled = false;
        });
    }

    // Função para solicitar agendamento Sendas em lote
    // Variável global para controlar processamento sequencial
    let filaAgendamentoSendas = [];
    let indiceAtualFila = 0;
    let protocolosGerados = {};

    function solicitarAgendamentoSendasLote() {
        // Buscar CNPJs selecionados na tabela
        const checkboxes = document.querySelectorAll('.check-cnpj:checked');

        if (checkboxes.length === 0) {
            alert('Por favor, selecione pelo menos um CNPJ para solicitar agendamento');
            return;
        }

        // Coletar dados dos CNPJs selecionados
        const cnpjsSelecionados = [];
        checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const cnpj = checkbox.value;
            const razSocial = row.querySelector('td:nth-child(2)').textContent.trim();
            const cidade = row.querySelector('td:nth-child(3) > div:first-child').textContent.trim();
            const dataExpedicao = row.querySelector('.data-expedicao').value;
            const dataAgendamento = row.querySelector('.data-agendamento').value;

            cnpjsSelecionados.push({
                cnpj: cnpj,
                cliente: razSocial,
                cidade: cidade,
                data_expedicao: dataExpedicao,
                data_agendamento: dataAgendamento || getProximoDiaUtil()
            });
        });

        // Primeiro preparar dados (criar separações do saldo)
        Swal.fire({
            title: 'Preparando dados...',
            html: `
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Preparando...</span>
                    </div>
                    <p>Criando separações e buscando dados...</p>
                </div>
            `,
            allowOutsideClick: false,
            showConfirmButton: false
        });

        // Buscar dados dos CNPJs (cria separações e busca tudo)
        fetch('/portal/sendas/solicitar/lote/preparar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                cnpjs: cnpjsSelecionados.map(c => c.cnpj)
            })
        })
        .then(response => response.json())
        .then(response => {
            if (response.sucesso && response.solicitacoes && response.solicitacoes.length > 0) {
                // Agrupar solicitações por CNPJ
                const dadosPorCnpj = {};
                response.solicitacoes.forEach(sol => {
                    if (!dadosPorCnpj[sol.cnpj]) {
                        const cnpjInfo = cnpjsSelecionados.find(c => c.cnpj === sol.cnpj);
                        dadosPorCnpj[sol.cnpj] = {
                            cnpj: sol.cnpj,
                            cliente: cnpjInfo?.cliente || '',
                            cidade: cnpjInfo?.cidade || '',
                            data_expedicao: cnpjInfo?.data_expedicao,
                            data_agendamento: cnpjInfo?.data_agendamento || sol.data_agendamento,
                            pedidos: []
                        };
                    }
                    dadosPorCnpj[sol.cnpj].pedidos.push(sol);
                });

                // Converter para array e iniciar processamento sequencial
                filaAgendamentoSendas = Object.values(dadosPorCnpj);
                indiceAtualFila = 0;
                protocolosGerados = {};

                Swal.close();

                // Processar o primeiro CNPJ
                processarProximoCNPJ();

            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sem dados para comparar',
                    text: 'Não foram encontrados pedidos ou separações para os CNPJs selecionados'
                });
            }
        })
        .catch(error => {
            console.error('Erro ao buscar dados:', error);
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: 'Erro ao buscar dados dos CNPJs'
            });
        });
    }

    // Função para processar próximo CNPJ da fila
    function processarProximoCNPJ() {
        if (indiceAtualFila >= filaAgendamentoSendas.length) {
            // Todos os CNPJs foram processados
            exibirResumoFinal();
            return;
        }

        const dadosCnpj = filaAgendamentoSendas[indiceAtualFila];

        // Abrir modal individual para este CNPJ
        abrirModalComparacaoCNPJIndividual(dadosCnpj, indiceAtualFila + 1, filaAgendamentoSendas.length);
    }

    // Função para abrir modal de comparação individual
    function abrirModalComparacaoCNPJIndividual(dadosCnpj, numero, total) {
        // Criar modal dinâmico para este CNPJ
        const modalId = 'modalComparacaoCNPJIndividual';

        // Remover modal anterior se existir
        const modalExistente = document.getElementById(modalId);
        if (modalExistente) {
            modalExistente.remove();
        }

        // Criar HTML do modal
        const modalHTML = `
        <div class="modal fade" id="${modalId}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                  <i class="fas fa-calendar-check"></i> Agendamento Sendas - CNPJ ${numero}/${total}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <!-- Info do CNPJ -->
                <div class="card mb-3">
                  <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-building"></i> Dados do Cliente</h6>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-3">
                        <strong>CNPJ:</strong><br> ${dadosCnpj.cnpj}
                      </div>
                      <div class="col-md-5">
                        <strong>Cliente:</strong><br> ${dadosCnpj.cliente}
                      </div>
                      <div class="col-md-4">
                        <strong>Cidade:</strong><br> ${dadosCnpj.cidade}
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-md-6">
                        <label><strong>Data Expedição:</strong></label>
                        <input type="date" class="form-control form-control-sm w-auto d-inline"
                               id="modal-data-expedicao" value="${dadosCnpj.data_expedicao || ''}">
                      </div>
                      <div class="col-md-6">
                        <label><strong>Data Agendamento:</strong></label>
                        <input type="date" class="form-control form-control-sm w-auto d-inline"
                               id="modal-data-agendamento" value="${dadosCnpj.data_agendamento || ''}">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Resumo dos pedidos/produtos -->
                <div class="card mb-3">
                  <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                      <i class="fas fa-boxes"></i> Pedidos e Produtos
                      <span class="badge bg-light text-dark ms-2">${dadosCnpj.pedidos.length} itens</span>
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Pedido</th>
                            <th>Pedido Cliente</th>
                            <th>Produto</th>
                            <th>Nome</th>
                            <th>Quantidade</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${dadosCnpj.pedidos.map(p => `
                            <tr>
                              <td>${p.num_pedido || '-'}</td>
                              <td>${p.pedido_cliente || '-'}</td>
                              <td>${p.cod_produto}</td>
                              <td>${p.nome_produto || '-'}</td>
                              <td>${p.quantidade}</td>
                            </tr>
                          `).join('')}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- Resultado da comparação -->
                <div class="card">
                  <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-check-circle"></i> Resultado da Comparação</h6>
                  </div>
                  <div class="card-body">
                    <div id="resultado-comparacao-individual">
                      <div class="text-center text-muted">
                        Clique em "Comparar" para verificar disponibilidade
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="pularCNPJAtual()">
                  <i class="fas fa-forward"></i> Pular este CNPJ
                </button>
                <button type="button" class="btn btn-primary" id="btn-comparar-individual" onclick="compararCNPJIndividual()">
                  <i class="fas fa-search"></i> Comparar
                </button>
                <button type="button" class="btn btn-success" id="btn-confirmar-individual" onclick="confirmarCNPJIndividual()" style="display: none;">
                  <i class="fas fa-check"></i> Confirmar Agendamento
                </button>
              </div>
            </div>
          </div>
        </div>
        `;

        // Adicionar modal ao body
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // Armazenar dados no modal
        const modal = document.getElementById(modalId);
        modal.dadosCnpj = dadosCnpj;

        // Abrir modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }

    // Função para comparar CNPJ individual
    function compararCNPJIndividual() {
        const modal = document.getElementById('modalComparacaoCNPJIndividual');
        const dadosCnpj = modal.dadosCnpj;
        const dataAgendamento = document.getElementById('modal-data-agendamento').value;

        if (!dataAgendamento) {
            alert('Por favor, selecione uma data de agendamento');
            return;
        }

        // Atualizar data de agendamento nos dados
        dadosCnpj.pedidos.forEach(p => {
            p.data_agendamento = dataAgendamento;
        });

        // Mostrar loading
        const btnComparar = document.getElementById('btn-comparar-individual');
        btnComparar.disabled = true;
        btnComparar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Comparando...';

        // Fazer comparação
        fetch('/portal/sendas/solicitar/lote/comparar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                solicitacoes: dadosCnpj.pedidos
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                exibirResultadoComparacaoIndividual(data.resultados_por_cnpj[dadosCnpj.cnpj]);
            } else {
                document.getElementById('resultado-comparacao-individual').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Erro ao comparar: ${data.erro || 'Erro desconhecido'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            document.getElementById('resultado-comparacao-individual').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Erro ao comparar
                </div>
            `;
        })
        .finally(() => {
            btnComparar.disabled = false;
            btnComparar.innerHTML = '<i class="fas fa-search"></i> Comparar';
        });
    }

    // Exibir resultado da comparação individual
    function exibirResultadoComparacaoIndividual(resultado) {
        let html = '';
        const container = document.getElementById('resultado-comparacao-individual');

        if (!resultado) {
            container.innerHTML = '<div class="alert alert-warning">Sem resultados</div>';
            return;
        }

        // Contar itens encontrados e não encontrados
        const encontrados = resultado.itens.filter(i => i.tipo_match === 'exato').length;
        const total = resultado.itens.length;

        // Resumo
        html += `
        <div class="alert ${encontrados === total ? 'alert-success' : encontrados > 0 ? 'alert-warning' : 'alert-danger'}">
            <strong>Resultado:</strong> ${encontrados}/${total} produtos encontrados na planilha Sendas
        </div>
        `;

        // Listar itens
        html += '<div class="accordion" id="accordionItens">';
        resultado.itens.forEach((item, idx) => {
            const sucesso = item.tipo_match === 'exato';
            const suficiente = item.encontrado?.quantidade_suficiente;

            html += `
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button ${idx > 0 ? 'collapsed' : ''}" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapse${idx}">
                        <span class="badge bg-${sucesso ? suficiente ? 'success' : 'warning' : 'danger'} me-2">
                            ${sucesso ? suficiente ? '✅' : '⚠️' : '❌'}
                        </span>
                        Pedido: ${item.solicitado.pedido_cliente || '-'} |
                        Produto: ${item.solicitado.cod_produto}
                    </button>
                </h2>
                <div id="collapse${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}"
                     data-bs-parent="#accordionItens">
                    <div class="accordion-body">
            `;

            if (sucesso && item.encontrado) {
                html += `
                    <strong>✅ Encontrado na planilha:</strong><br>
                    Pedido Sendas: ${item.encontrado.codigo_pedido_sendas}<br>
                    Produto: ${item.encontrado.descricao}<br>
                    Disponível: ${item.encontrado.saldo_disponivel} ${item.encontrado.unidade_medida}<br>
                    Solicitado: ${item.solicitado.quantidade}<br>
                    ${!suficiente ? '<span class="text-warning">⚠️ Quantidade insuficiente</span>' : ''}
                `;
            } else {
                html += `
                    <strong>❌ Não encontrado na planilha</strong><br>
                    ${item.observacao || 'Produto não disponível'}
                `;
            }

            html += `
                    </div>
                </div>
            </div>
            `;
        });
        html += '</div>';

        // Se tem alternativas, mostrar
        if (resultado.alternativas_filial && resultado.alternativas_filial.mostrar_tudo) {
            html += `
            <div class="alert alert-info mt-3">
                <strong>Alternativas:</strong> ${resultado.alternativas_filial.sugestao}
                <button class="btn btn-sm btn-info ms-2" onclick="mostrarAlternativasFilial()">
                    Ver todos produtos da filial
                </button>
            </div>
            `;

            // Armazenar alternativas para uso posterior
            container.alternativas = resultado.alternativas_filial;
        }

        container.innerHTML = html;

        // Armazenar resultado para confirmação
        const modal = document.getElementById('modalComparacaoCNPJIndividual');
        modal.resultadoComparacao = resultado;

        // Mostrar botão de confirmar se tem pelo menos 1 item para agendar
        if (resultado.pode_agendar_todos) {
            document.getElementById('btn-confirmar-individual').style.display = 'inline-block';
        }
    }

    // Confirmar agendamento individual
    function confirmarCNPJIndividual() {
        const modal = document.getElementById('modalComparacaoCNPJIndividual');
        const resultado = modal.resultadoComparacao;
        const dadosCnpj = modal.dadosCnpj;

        if (!resultado) {
            alert('Nenhum resultado para confirmar');
            return;
        }

        // Preparar itens para confirmação
        const itensConfirmados = resultado.itens.map(item => ({
            cnpj: dadosCnpj.cnpj,
            num_pedido: item.solicitado.num_pedido,
            pedido_cliente: item.solicitado.pedido_cliente,
            cod_produto: item.solicitado.cod_produto,
            nome_produto: item.solicitado.nome_produto || '',
            quantidade: item.solicitado.quantidade,
            data_expedicao: document.getElementById('modal-data-expedicao').value,
            data_agendamento: document.getElementById('modal-data-agendamento').value
        }));

        // Mostrar loading
        const btnConfirmar = document.getElementById('btn-confirmar-individual');
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Confirmando...';

        // Enviar confirmação
        fetch('/portal/sendas/solicitar/lote/confirmar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                itens_confirmados: itensConfirmados
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                // Armazenar protocolo gerado
                protocolosGerados[dadosCnpj.cnpj] = data.protocolos[dadosCnpj.cnpj];

                // Fechar modal atual
                const bsModal = bootstrap.Modal.getInstance(modal);
                bsModal.hide();

                // Processar próximo CNPJ
                indiceAtualFila++;
                setTimeout(() => {
                    modal.remove();
                    processarProximoCNPJ();
                }, 500);
            } else {
                alert('Erro ao confirmar: ' + (data.erro || 'Erro desconhecido'));
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar Agendamento';
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao confirmar agendamento');
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar Agendamento';
        });
    }

    // Pular CNPJ atual
    function pularCNPJAtual() {
        const modal = document.getElementById('modalComparacaoCNPJIndividual');
        const bsModal = bootstrap.Modal.getInstance(modal);
        bsModal.hide();

        indiceAtualFila++;
        setTimeout(() => {
            modal.remove();
            processarProximoCNPJ();
        }, 500);
    }

    // Exibir resumo final
    function exibirResumoFinal() {
        const totalProcessados = Object.keys(protocolosGerados).length;
        const totalCNPJs = filaAgendamentoSendas.length;

        let mensagem = `<h5>Processo Concluído!</h5>`;
        mensagem += `<p>${totalProcessados} de ${totalCNPJs} CNPJs agendados com sucesso.</p>`;

        if (totalProcessados > 0) {
            mensagem += '<h6>Protocolos Gerados:</h6><ul>';
            for (const [cnpj, protocolo] of Object.entries(protocolosGerados)) {
                mensagem += `<li><strong>${cnpj}:</strong> ${protocolo}</li>`;
            }
            mensagem += '</ul>';
        }

        Swal.fire({
            icon: totalProcessados > 0 ? 'success' : 'info',
            title: 'Agendamento Concluído',
            html: mensagem,
            confirmButtonText: 'OK'
        });

        // Limpar variáveis
        filaAgendamentoSendas = [];
        indiceAtualFila = 0;
        protocolosGerados = {};
    }

    // Função auxiliar para obter próximo dia útil
    function getProximoDiaUtil() {
        const hoje = new Date();
        let dia = new Date(hoje);
        dia.setDate(dia.getDate() + 1);

        // Se for sábado (6) ou domingo (0), avançar para segunda
        while (dia.getDay() === 0 || dia.getDay() === 6) {
            dia.setDate(dia.getDate() + 1);
        }

        return dia.toISOString().split('T')[0];
    }
</script>
<script src="{{ url_for('static', filename='js/programacao-lote.js') }}"></script>

<!-- Scripts adicionais Sendas (opcional - se precisar de funções auxiliares) -->
<!-- <script src="{{ url_for('static', filename='js/sendas_comparacao.js') }}"></script> -->

{% endblock %}