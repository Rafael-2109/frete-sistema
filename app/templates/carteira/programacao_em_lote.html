{% extends "base.html" %}

{% block title %}Programa√ß√£o em Lote - {{ rede }} SP{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para as cores das linhas conforme status - usando vari√°veis CSS */
    .table-danger {
        background-color: var(--semantic-danger-subtle) !important;
    }

    .table-warning {
        background-color: var(--semantic-warning-subtle) !important;
    }

    .table-info {
        background-color: var(--semantic-info-subtle) !important;
    }

    .table-success {
        background-color: var(--semantic-success-subtle) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid premium-page">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 reveal">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-network-wired"></i>
                Programa√ß√£o em Lote - {{ rede }} SP
                <span class="fs-6 fw-normal text-muted">- {{ vendedor or 'Sem vendedor' }} - {{ equipe_vendas or 'Sem
                    equipe' }}</span>
            </h1>
            <p class="text-muted mb-0">
                Gest√£o unificada de pedidos para {{ rede }} em S√£o Paulo
            </p>
        </div>
        <div>
            {% if rede == 'sendas' %}
            <!-- Dropdown Agendamentos Sendas -->
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    <i class="fas fa-calendar-alt"></i> Agendamentos Sendas
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item" href="#" onclick="abrirModalImportarPlanilhaSendas(); return false;">
                            <i class="fas fa-file-import text-warning"></i> Importar Planilha Modelo
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" onclick="solicitarAgendamentoSendasLote(); return false;">
                            <i class="fas fa-paper-plane text-success"></i> Solicitar Agendamento
                        </a>
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li>
                        <a class="dropdown-item" href="/portal/sendas/exportacao" target="_blank">
                            <i class="fas fa-file-export text-info"></i> Exportar Planilha Preenchida
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="/portal/sendas/verificacao" target="_blank">
                            <i class="fas fa-check-circle text-success"></i> Importar Agendamentos
                        </a>
                    </li>
                </ul>
            </div>
            {% endif %}
            <button class="btn btn-secondary me-2" id="btnAnalisarEstoques">
                <i class="fas fa-chart-line"></i> Analisar Estoques
            </button>
            <button class="btn btn-secondary me-2" id="btnSugerirDatas">
                <i class="fas fa-magic"></i> Sugerir Datas
            </button>
            <button class="btn btn-secondary me-2" id="btnSelecionarTodos">
                <i class="fas fa-check-square"></i> Selecionar Todos
            </button>
            <button class="btn btn-primary me-2" id="btnProcessarLote" disabled>
                <i class="fas fa-calendar-alt"></i> Agendar Selecionados
            </button>
            <a href="{{ url_for('carteira.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Cards de Resumo - Usando stat-card padr√£o -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card shadow h-100 py-2">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col me-2">
                            <div class="small fw-bold text-uppercase mb-1">
                                Total de CNPJs
                            </div>
                            <div class="h5 mb-0 fw-bold">
                                {{ total_cnpjs }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-building fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card shadow h-100 py-2">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col me-2">
                            <div class="small fw-bold text-uppercase mb-1">
                                Valor Total
                            </div>
                            <div class="h5 mb-0 fw-bold">
                                R$ <span id="valorTotalGeral">0,00</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card shadow h-100 py-2">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col me-2">
                            <div class="small fw-bold text-uppercase mb-1">
                                Peso Total
                            </div>
                            <div class="h5 mb-0 fw-bold">
                                <span id="pesoTotalGeral">0</span> kg
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-weight fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card shadow h-100 py-2">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col me-2">
                            <div class="small fw-bold text-uppercase mb-1">
                                Pallets Total
                            </div>
                            <div class="h5 mb-0 fw-bold">
                                <span id="palletsTotalGeral">0</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-pallet fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dropdown de An√°lise de Estoques (inicialmente oculto) -->
    <div class="card shadow mb-4 d-none" id="cardAnaliseEstoques">
        <div class="card-header py-3">
            <h6 class="m-0 fw-bold">
                <i class="fas fa-chart-line"></i> An√°lise de Estoques - Itens da Rede
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-bordered" id="tabelaAnaliseEstoques">
                    <thead class="sticky-top table-thead-theme">
                        <tr>
                            <th>C√≥digo</th>
                            <th>Produto</th>
                            <th>Qtd Total</th>
                            <th>Valor Total</th>
                            <th>Estoque Atual</th>
                            <th>Data Dispon√≠vel</th>
                            <th>Proje√ß√£o 15 dias</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tabela de CNPJs -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 fw-bold">
                <i class="fas fa-list"></i> Clientes {{ rede }} SP
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="tabelaProgramacao">
                    <thead class="table-thead-theme">
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="checkTodos"
                                    title="Selecionar apenas Pendentes e Reagendar" />
                            </th>
                            <th>Cliente</th>
                            <th>Cidade</th>
                            <th>Valor Total</th>
                            <th>Peso (kg)</th>
                            <th>Pallets</th>
                            <th>Expedi√ß√£o</th>
                            <th>Agendamento</th>
                            <th>Status</th>
                            <th width="150">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cnpj_data in dados_cnpj %}
                        <tr class="cnpj-row {{ cnpj_data.cor_linha }}" data-cnpj="{{ cnpj_data.cnpj }}"
                            data-status="{{ cnpj_data.status }}">
                            <td class="text-center">
                                <input type="checkbox" class="check-cnpj" value="{{ cnpj_data.cnpj }}"
                                    data-status="{{ cnpj_data.status }}" />
                            </td>
                            <td>
                                <div class="fw-medium">{{ cnpj_data.raz_social }}</div>
                                <small class="text-muted">{{ cnpj_data.cnpj_formatado }}</small>
                            </td>
                            <td>
                                <div>{{ cnpj_data.cidade }}</div>
                                <small class="text-muted">Sub-Rota: {{ cnpj_data.sub_rota or '-' }}</small>
                            </td>
                            <td class="text-end" style="font-size: 0.9em;">R$ {{ "{:,.2f}".format(cnpj_data.total_valor)
                                }}</td>
                            <td class="text-end" style="font-size: 0.9em;">{{ "{:,.2f}".format(cnpj_data.total_peso) }}
                            </td>
                            <td class="text-end" style="font-size: 0.9em;">{{ "{:,.2f}".format(cnpj_data.total_pallets)
                                }}</td>
                            <td>
                                <input type="date" class="form-control form-control-sm data-expedicao"
                                    data-cnpj="{{ cnpj_data.cnpj }}" value="{{ cnpj_data.expedicao_sugerida }}"
                                    style="width: 110px; font-size: 0.85em;">
                            </td>
                            <td>
                                <input type="date" class="form-control form-control-sm data-agendamento"
                                    data-cnpj="{{ cnpj_data.cnpj }}" value="{{ cnpj_data.agendamento_sugerido }}"
                                    style="width: 110px; font-size: 0.85em;">
                            </td>
                            <td class="text-center">
                                {% if cnpj_data.status %}
                                <span
                                    class="badge 
                                        {% if cnpj_data.status == 'Reagendar' %}bg-danger{% elif cnpj_data.status == 'Consolidar' %}bg-warning text-dark{% elif cnpj_data.status == 'Ag. Aprova√ß√£o' %}bg-info{% elif cnpj_data.status == 'Pronto' %}bg-success{% else %}bg-secondary{% endif %}"
                                    style="font-size: 0.8em; padding: 4px 8px;">
                                    <i class="fas {{ cnpj_data.icone_status }} me-1"></i>
                                    {{ cnpj_data.status }}
                                </span>
                                {% else %}
                                <span class="badge bg-secondary">Pendente</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-warning btn-priorizar" data-cnpj="{{ cnpj_data.cnpj }}"
                                    title="Priorizar">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary btn-analisar-ruptura"
                                    data-cnpj="{{ cnpj_data.cnpj }}"
                                    data-pedidos="{% if cnpj_data.pedidos %}{% for p in cnpj_data.pedidos %}{{ p.num_pedido }}{% if not loop.last %},{% endif %}{% endfor %}{% endif %}"
                                    title="Analisar ruptura" style="min-width: 120px; font-size: 0.75em;">
                                    <span class="ruptura-info">Analisando...</span>
                                </button>
                                <button class="btn btn-sm btn-secondary btn-expandir" data-cnpj="{{ cnpj_data.cnpj }}"
                                    title="Ver detalhes">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </td>
                        </tr>

                        <!-- Linha de detalhes (inicialmente oculta) -->
                        <tr class="detail-row d-none" data-cnpj-detail="{{ cnpj_data.cnpj }}">
                            <td colspan="10">
                                <div class="p-3 bg-light">
                                    <h6 class="mb-3">
                                        <i class="fas fa-clipboard-list"></i>
                                        Detalhes dos Pedidos - {{ cnpj_data.raz_social }}
                                    </h6>

                                    {% for pedido in cnpj_data.pedidos %}
                                    <div class="card mb-2">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-2">
                                                    <strong>Pedido:</strong><br>
                                                    {{ pedido.num_pedido }}
                                                </div>
                                                <div class="col-md-2">
                                                    <strong>Data:</strong><br>
                                                    {{ pedido.data_pedido.strftime('%d/%m/%Y') if pedido.data_pedido
                                                    else '-' }}
                                                </div>
                                                <div class="col-md-2">
                                                    <strong>Pedido Cliente:</strong><br>
                                                    {{ pedido.pedido_cliente or '-' }}
                                                </div>
                                                <div class="col-md-2">
                                                    <strong>Status:</strong><br>
                                                    <span class="badge 
                                                        {% if pedido.status == 'PENDENTE' %}bg-warning text-dark
                                                        {% elif pedido.status == 'NF_CD_SEM_CARTEIRA' %}bg-danger
                                                        {% else %}bg-info text-dark{% endif %}">
                                                        {{ pedido.status }}
                                                    </span>
                                                </div>
                                                <div class="col-md-4">
                                                    <strong>Observa√ß√µes:</strong><br>
                                                    {{ pedido.observacoes or '-' }}
                                                </div>
                                            </div>

                                            {% if pedido.qtd_pendente > 0 %}
                                            <div class="mt-2">
                                                <span class="text-muted">Pendente:</span>
                                                <span class="badge bg-warning text-dark">
                                                    R$ {{ "{:,.2f}".format(pedido.valor_pendente) }} |
                                                    {{ "{:,.2f}".format(pedido.peso_pendente) }} kg |
                                                    {{ "{:,.2f}".format(pedido.pallets_pendente) }} pallets
                                                </span>
                                            </div>
                                            {% endif %}

                                            {% if pedido.separacoes %}
                                            <div class="mt-2">
                                                <strong>Separa√ß√µes:</strong>
                                                {% for sep in pedido.separacoes %}
                                                <div class="ms-3 mb-1">
                                                    <span class="text-muted">{{ sep.separacao_lote_id }}:</span>
                                                    <span class="badge bg-info text-dark">
                                                        {{ sep.status }}
                                                    </span>
                                                    <span class="badge bg-light text-dark border">
                                                        R$ {{ "{:,.2f}".format(sep.valor_total) if sep.valor_total else
                                                        '0,00' }} |
                                                        {{ "{:,.2f}".format(sep.peso_total) if sep.peso_total else
                                                        '0,00' }} kg |
                                                        {{ "{:,.2f}".format(sep.pallet_total) if sep.pallet_total else
                                                        '0,00' }} pallets
                                                    </span>
                                                    <span
                                                        class="badge {% if sep.agendamento_confirmado %}bg-success{% else %}bg-secondary{% endif %}">
                                                        Exp: {{ sep.expedicao.strftime('%d/%m') if sep.expedicao else
                                                        '-' }} |
                                                        Agenda: {{ sep.agendamento.strftime('%d/%m') if sep.agendamento
                                                        else '-' }}
                                                    </span>
                                                    {% if sep.protocolo %}
                                                    <span class="badge bg-secondary">
                                                        <i class="fas fa-check-circle"></i> Prot: {{ sep.protocolo }}
                                                    </span>
                                                    {% endif %}
                                                    {% if sep.agendamento_confirmado %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check-double"></i> Confirmado
                                                    </span>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}

                                            {% if pedido.nfs_cd %}
                                            <div class="mt-2">
                                                <strong>NFs no CD:</strong>
                                                {% for nf in pedido.nfs_cd %}
                                                <div class="ms-3 mb-1">
                                                    <span class="text-muted">NF {{ nf.numero_nf }}:</span>
                                                    <span class="badge bg-danger">
                                                        {{ nf.status }}
                                                    </span>
                                                    <span class="badge bg-light text-dark border">
                                                        R$ {{ "{:,.2f}".format(nf.valor) if nf.valor else '0,00' }} |
                                                        {{ "{:,.2f}".format(nf.peso) if nf.peso else '0,00' }} kg |
                                                        {{ "{:,.2f}".format(nf.pallet) if nf.pallet else '0,00' }}
                                                        pallets
                                                    </span>
                                                    {% if nf.expedicao or nf.agendamento %}
                                                    <span class="badge bg-secondary">
                                                        Exp: {{ nf.expedicao.strftime('%d/%m') if nf.expedicao else '-'
                                                        }} |
                                                        Agenda: {{ nf.agendamento.strftime('%d/%m') if nf.agendamento
                                                        else '-' }}
                                                    </span>
                                                    {% endif %}
                                                    {% if nf.protocolo %}
                                                    <span class="badge bg-secondary">
                                                        <i class="fas fa-check-circle"></i> Prot: {{ nf.protocolo }}
                                                    </span>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Agendamento em Lote -->
<div class="modal fade" id="modalAgendamento" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-alt"></i> Agendamento em Lote
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span id="qtdSelecionados">0</span> CNPJs selecionados para agendamento
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Data de Expedi√ß√£o:</label>
                        <input type="date" class="form-control" id="dataExpedicao" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Data de Agendamento:</label>
                        <input type="date" class="form-control" id="dataAgendamento">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Observa√ß√µes:</label>
                    <textarea class="form-control" id="observacoesLote" rows="3"></textarea>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Esta a√ß√£o ir√° processar o agendamento de todos os pedidos pendentes dos CNPJs selecionados.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarAgendamento">
                    <i class="fas fa-check"></i> Confirmar Agendamento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Importa√ß√£o da Planilha Sendas -->
<div class="modal fade" id="modalImportarPlanilhaSendas" tabindex="-1" aria-labelledby="modalImportarPlanilhaLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalImportarPlanilhaLabel">
                    <i class="fas fa-file-import"></i> Importar Agenda Dispon√≠vel Sendas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formImportarPlanilhaSendas" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="arquivoPlanilha" class="form-label">Selecione a planilha modelo (.xlsx)</label>
                        <input type="file" class="form-control" id="arquivoPlanilha" name="arquivo" accept=".xlsx"
                            required>
                        <div class="form-text">Baixe a planilha do portal Sendas e fa√ßa upload aqui</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="importarPlanilhaSendas()">
                    <i class="fas fa-upload"></i> Importar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Incluir modais de compara√ß√£o Sendas -->
{% include 'portal/sendas/modals_comparacao.html' %}

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{{ url_for('static', filename='js/sendas_comparacao.js') }}"></script>
<script>
    // Dados do portal para o JavaScript
    window.PORTAL_CONFIG = {
        portal: '{{ portal }}',
        rede: '{{ rede }}'
    };

    // Fun√ß√£o para abrir o modal de importa√ß√£o
    function abrirModalImportarPlanilhaSendas() {
        const modal = new bootstrap.Modal(document.getElementById('modalImportarPlanilhaSendas'));
        modal.show();
    }

    // Fun√ß√£o para importar a planilha
    function importarPlanilhaSendas() {
        const fileInput = document.getElementById('arquivoPlanilha');
        const file = fileInput.files[0];

        if (!file) {
            alert('Por favor, selecione um arquivo');
            return;
        }

        const formData = new FormData();
        formData.append('arquivo', file);

        // Mostrar loading
        const btnImportar = event.target;
        const textoOriginal = btnImportar.innerHTML;
        btnImportar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando...';
        btnImportar.disabled = true;

        fetch('/portal/sendas/importar-planilha-modelo', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrf_token]')?.value || ''
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    alert(data.mensagem);
                    // Fechar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalImportarPlanilhaSendas')).hide();
                    // Limpar formul√°rio
                    document.getElementById('formImportarPlanilhaSendas').reset();
                } else {
                    alert('Erro: ' + data.mensagem);
                }
            })
            .catch(error => {
                alert('Erro ao importar planilha: ' + error);
            })
            .finally(() => {
                btnImportar.innerHTML = textoOriginal;
                btnImportar.disabled = false;
            });
    }

    // Fun√ß√£o para solicitar agendamento Sendas em lote
    // Vari√°vel global para controlar processamento sequencial
    let filaAgendamentoSendas = [];
    let indiceAtualFila = 0;
    let protocolosGerados = {};

    function solicitarAgendamentoSendasLote() {
        // Buscar CNPJs selecionados na tabela
        const checkboxes = document.querySelectorAll('.check-cnpj:checked');

        if (checkboxes.length === 0) {
            alert('Por favor, selecione pelo menos um CNPJ para solicitar agendamento');
            return;
        }

        // Coletar dados dos CNPJs selecionados
        const cnpjsSelecionados = [];
        const cnpjsSemData = [];

        checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const cnpj = checkbox.value;
            const razSocial = row.querySelector('td:nth-child(2)').textContent.trim();
            const cidade = row.querySelector('td:nth-child(3) > div:first-child').textContent.trim();
            const dataExpedicao = row.querySelector('.data-expedicao').value;
            const dataAgendamento = row.querySelector('.data-agendamento').value;

            // Validar se as datas est√£o preenchidas
            if (!dataExpedicao || !dataExpedicao.trim()) {
                cnpjsSemData.push(`${razSocial} (${cnpj}) - falta Data de Expedi√ß√£o`);
                return; // Pula este CNPJ
            }

            if (!dataAgendamento || !dataAgendamento.trim()) {
                cnpjsSemData.push(`${razSocial} (${cnpj}) - falta Data de Agendamento`);
                return; // Pula este CNPJ
            }

            cnpjsSelecionados.push({
                cnpj: cnpj,
                cliente: razSocial,
                cidade: cidade,
                data_expedicao: dataExpedicao,
                data_agendamento: dataAgendamento
            });
        });

        // Se h√° CNPJs sem data, mostrar alerta
        if (cnpjsSemData.length > 0) {
            let mensagem = 'Os seguintes CNPJs est√£o sem datas preenchidas:\n\n';
            mensagem += cnpjsSemData.join('\n');
            mensagem += '\n\nPor favor, preencha as datas de Expedi√ß√£o e Agendamento antes de solicitar o agendamento.';
            alert(mensagem);
            return;
        }

        // Se nenhum CNPJ v√°lido foi selecionado
        if (cnpjsSelecionados.length === 0) {
            alert('Nenhum CNPJ com datas v√°lidas foi selecionado');
            return;
        }

        // Debug: Mostrar o que ser√° enviado
        const dadosEnviar = {
            cnpjs: cnpjsSelecionados.map(c => ({
                cnpj: c.cnpj,
                data_agendamento: c.data_agendamento,
                data_expedicao: c.data_expedicao
            }))
        };
        console.log('üì§ Enviando para /portal/sendas/solicitar/lote/preparar:', dadosEnviar);
        console.log('   Total de CNPJs:', dadosEnviar.cnpjs.length);
        dadosEnviar.cnpjs.forEach((item, i) => {
            console.log(`   CNPJ ${i + 1}:`, item.cnpj, '- Exp:', item.data_expedicao, '- Agend:', item.data_agendamento);
        });

        // Primeiro preparar dados (criar separa√ß√µes do saldo)
        Swal.fire({
            title: 'Preparando dados...',
            html: `
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Preparando...</span>
                    </div>
                    <p>Criando separa√ß√µes e buscando dados...</p>
                </div>
            `,
            allowOutsideClick: false,
            showConfirmButton: false
        });

        // Buscar dados dos CNPJs (cria separa√ß√µes e busca tudo)
        fetch('/portal/sendas/solicitar/lote/preparar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(dadosEnviar)
        })
            .then(response => response.json())
            .then(response => {
                if (response.sucesso && response.solicitacoes && response.solicitacoes.length > 0) {
                    // Agrupar solicita√ß√µes por CNPJ
                    const dadosPorCnpj = {};
                    response.solicitacoes.forEach(sol => {
                        if (!dadosPorCnpj[sol.cnpj]) {
                            const cnpjInfo = cnpjsSelecionados.find(c => c.cnpj === sol.cnpj);
                            dadosPorCnpj[sol.cnpj] = {
                                cnpj: sol.cnpj,
                                cliente: cnpjInfo?.cliente || '',
                                cidade: cnpjInfo?.cidade || '',
                                data_expedicao: cnpjInfo?.data_expedicao,
                                data_agendamento: cnpjInfo?.data_agendamento || sol.data_agendamento,
                                pedidos: []
                            };
                        }
                        dadosPorCnpj[sol.cnpj].pedidos.push(sol);
                    });

                    // Converter para array e iniciar processamento sequencial
                    filaAgendamentoSendas = Object.values(dadosPorCnpj);
                    indiceAtualFila = 0;
                    protocolosGerados = {};

                    Swal.close();

                    // Processar o primeiro CNPJ
                    processarProximoCNPJ();

                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sem dados para comparar',
                        text: 'N√£o foram encontrados pedidos ou separa√ß√µes para os CNPJs selecionados'
                    });
                }
            })
            .catch(error => {
                console.error('Erro ao buscar dados:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao buscar dados dos CNPJs'
                });
            });
    }

    // Fun√ß√£o para processar pr√≥ximo CNPJ da fila
    function processarProximoCNPJ() {
        if (indiceAtualFila >= filaAgendamentoSendas.length) {
            // Todos os CNPJs foram processados
            exibirResumoFinal();
            return;
        }

        const dadosCnpj = filaAgendamentoSendas[indiceAtualFila];

        // Abrir modal individual para este CNPJ
        abrirModalComparacaoCNPJIndividual(dadosCnpj, indiceAtualFila + 1, filaAgendamentoSendas.length);
    }

    // Fun√ß√£o para abrir modal de compara√ß√£o individual
    function abrirModalComparacaoCNPJIndividual(dadosCnpj, numero, total) {
        // Criar modal din√¢mico para este CNPJ
        const modalId = 'modalComparacaoCNPJIndividual';

        // Remover modal anterior se existir
        const modalExistente = document.getElementById(modalId);
        if (modalExistente) {
            modalExistente.remove();
        }

        // Criar HTML do modal
        const modalHTML = `
        <div class="modal fade" id="${modalId}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                  <i class="fas fa-calendar-check"></i> Agendamento Sendas - CNPJ ${numero}/${total}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <!-- Info do CNPJ -->
                <div class="card mb-3">
                  <div class="card-header bg-info">
                    <h6 class="mb-0"><i class="fas fa-building"></i> Dados do Cliente</h6>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-3">
                        <strong>CNPJ:</strong><br> ${dadosCnpj.cnpj}
                      </div>
                      <div class="col-md-5">
                        <strong>Cliente:</strong><br> ${dadosCnpj.cliente}
                      </div>
                      <div class="col-md-4">
                        <strong>Cidade:</strong><br> ${dadosCnpj.cidade}
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-md-6">
                        <label><strong>Data Expedi√ß√£o:</strong></label>
                        <input type="date" class="form-control form-control-sm w-auto d-inline"
                               id="modal-data-expedicao" value="${dadosCnpj.data_expedicao || ''}">
                      </div>
                      <div class="col-md-6">
                        <label><strong>Data Agendamento:</strong></label>
                        <input type="date" class="form-control form-control-sm w-auto d-inline"
                               id="modal-data-agendamento" value="${dadosCnpj.data_agendamento || ''}">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Resumo dos pedidos/produtos -->
                <div class="card mb-3">
                  <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                      <i class="fas fa-boxes"></i> Pedidos e Produtos
                      <span class="badge bg-light text-dark ms-2">${dadosCnpj.pedidos.length} itens</span>
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Pedido</th>
                            <th>Pedido Cliente</th>
                            <th>Produto</th>
                            <th>Nome</th>
                            <th>Quantidade</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${dadosCnpj.pedidos.map(p => `
                            <tr>
                              <td>${p.num_pedido || '-'}</td>
                              <td>${p.pedido_cliente || '-'}</td>
                              <td>${p.cod_produto}</td>
                              <td>${p.nome_produto || '-'}</td>
                              <td>${p.quantidade}</td>
                            </tr>
                          `).join('')}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- Resultado da compara√ß√£o -->
                <div class="card">
                  <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-check-circle"></i> Resultado da Compara√ß√£o</h6>
                  </div>
                  <div class="card-body">
                    <div id="resultado-comparacao-individual">
                      <div class="text-center text-muted">
                        Clique em "Comparar" para verificar disponibilidade
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="pularCNPJAtual()">
                  <i class="fas fa-forward"></i> Pular este CNPJ
                </button>
                <button type="button" class="btn btn-primary" id="btn-comparar-individual" onclick="compararCNPJIndividual()">
                  <i class="fas fa-search"></i> Comparar
                </button>
                <button type="button" class="btn btn-success" id="btn-confirmar-individual" onclick="confirmarCNPJIndividual()" style="display: none;">
                  <i class="fas fa-check"></i> Confirmar Agendamento
                </button>
              </div>
            </div>
          </div>
        </div>
        `;

        // Adicionar modal ao body
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // Armazenar dados no modal
        const modal = document.getElementById(modalId);
        modal.dadosCnpj = dadosCnpj;

        // Abrir modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }

    // Fun√ß√£o para comparar CNPJ individual
    function compararCNPJIndividual() {
        const modal = document.getElementById('modalComparacaoCNPJIndividual');
        const dadosCnpj = modal.dadosCnpj;
        const dataAgendamento = document.getElementById('modal-data-agendamento').value;

        if (!dataAgendamento) {
            alert('Por favor, selecione uma data de agendamento');
            return;
        }

        // Atualizar data de agendamento nos dados
        dadosCnpj.pedidos.forEach(p => {
            p.data_agendamento = dataAgendamento;
        });

        // Mostrar loading
        const btnComparar = document.getElementById('btn-comparar-individual');
        btnComparar.disabled = true;
        btnComparar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Comparando...';

        // Fazer compara√ß√£o
        fetch('/portal/sendas/solicitar/lote/comparar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                solicitacoes: dadosCnpj.pedidos
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    exibirResultadoComparacaoIndividual(data.resultados_por_cnpj[dadosCnpj.cnpj]);
                } else {
                    document.getElementById('resultado-comparacao-individual').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Erro ao comparar: ${data.erro || 'Erro desconhecido'}
                    </div>
                `;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                document.getElementById('resultado-comparacao-individual').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Erro ao comparar
                </div>
            `;
            })
            .finally(() => {
                btnComparar.disabled = false;
                btnComparar.innerHTML = '<i class="fas fa-search"></i> Comparar';
            });
    }

    // Exibir resultado da compara√ß√£o individual
    function exibirResultadoComparacaoIndividual(resultado) {
        let html = '';
        const container = document.getElementById('resultado-comparacao-individual');

        if (!resultado) {
            container.innerHTML = '<div class="alert alert-warning">Sem resultados</div>';
            return;
        }

        // Contar itens encontrados e n√£o encontrados
        const encontrados = resultado.itens.filter(i => i.tipo_match === 'exato').length;
        const total = resultado.itens.length;

        // Resumo
        html += `
        <div class="alert ${encontrados === total ? 'alert-success' : encontrados > 0 ? 'alert-warning' : 'alert-danger'}">
            <strong>Resultado:</strong> ${encontrados}/${total} produtos encontrados na planilha Sendas
        </div>
        `;

        // Listar itens
        html += '<div class="accordion" id="accordionItens">';
        resultado.itens.forEach((item, idx) => {
            const sucesso = item.tipo_match === 'exato';
            const suficiente = item.encontrado?.quantidade_suficiente;

            html += `
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button ${idx > 0 ? 'collapsed' : ''}" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapse${idx}">
                        <span class="badge bg-${sucesso ? suficiente ? 'success' : 'warning' : 'danger'} me-2">
                            ${sucesso ? suficiente ? '‚úÖ' : '‚ö†Ô∏è' : '‚ùå'}
                        </span>
                        Pedido: ${item.solicitado.pedido_cliente || '-'} |
                        Produto: ${item.solicitado.cod_produto}
                    </button>
                </h2>
                <div id="collapse${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}"
                     data-bs-parent="#accordionItens">
                    <div class="accordion-body">
            `;

            if (sucesso && item.encontrado) {
                html += `
                    <strong>‚úÖ Encontrado na planilha:</strong><br>
                    Pedido Sendas: ${item.encontrado.codigo_pedido_sendas}<br>
                    Produto: ${item.encontrado.descricao}<br>
                    Dispon√≠vel: ${item.encontrado.saldo_disponivel} ${item.encontrado.unidade_medida}<br>
                    Solicitado: ${item.solicitado.quantidade}<br>
                    ${!suficiente ? '<span class="text-warning">‚ö†Ô∏è Quantidade insuficiente</span>' : ''}
                `;
            } else {
                html += `
                    <strong>‚ùå N√£o encontrado na planilha</strong><br>
                    ${item.observacao || 'Produto n√£o dispon√≠vel'}
                `;
            }

            html += `
                    </div>
                </div>
            </div>
            `;
        });
        html += '</div>';

        // Se tem alternativas, mostrar
        if (resultado.alternativas_filial && resultado.alternativas_filial.mostrar_tudo) {
            html += `
            <div class="alert alert-info mt-3">
                <strong>Alternativas:</strong> ${resultado.alternativas_filial.sugestao}
                <button class="btn btn-sm btn-secondary ms-2" onclick="mostrarAlternativasFilial()">
                    Ver todos produtos da filial
                </button>
            </div>
            `;

            // Armazenar alternativas para uso posterior
            container.alternativas = resultado.alternativas_filial;
        }

        container.innerHTML = html;

        // Armazenar resultado para confirma√ß√£o
        const modal = document.getElementById('modalComparacaoCNPJIndividual');
        modal.resultadoComparacao = resultado;

        // Mostrar bot√£o de confirmar se tem pelo menos 1 item para agendar
        if (resultado.pode_agendar_todos) {
            document.getElementById('btn-confirmar-individual').style.display = 'inline-block';
        }

        // üéØ AUTO-CONFIRMA√á√ÉO: Se todos os itens t√™m match 100%, confirmar automaticamente
        if (resultado.todos_tem_match_100) {
            console.log('‚úÖ 100% de match detectado! Confirmando automaticamente...');

            // Mostrar notifica√ß√£o ao usu√°rio
            const notificacao = document.createElement('div');
            notificacao.className = 'alert alert-success alert-dismissible fade show mt-3';
            notificacao.innerHTML = `
                <strong><i class="fas fa-check-circle"></i> 100% de Match!</strong><br>
                Todos os produtos foram encontrados na planilha. Confirmando agendamento automaticamente em 2 segundos...
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.insertBefore(notificacao, container.firstChild);

            // Confirmar automaticamente ap√≥s 2 segundos para dar tempo do usu√°rio ver
            setTimeout(() => {
                confirmarCNPJIndividual();
            }, 2000);
        }
    }

    // Confirmar agendamento individual
    function confirmarCNPJIndividual() {
        const modal = document.getElementById('modalComparacaoCNPJIndividual');
        const resultado = modal.resultadoComparacao;
        const dadosCnpj = modal.dadosCnpj;

        if (!resultado) {
            alert('Nenhum resultado para confirmar');
            return;
        }

        // Preparar itens para confirma√ß√£o
        const itensConfirmados = resultado.itens.map(item => ({
            cnpj: dadosCnpj.cnpj,
            num_pedido: item.solicitado.num_pedido,
            // ‚úÖ CORRE√á√ÉO: Usar c√≥digos Sendas do encontrado quando dispon√≠vel
            pedido_cliente: item.encontrado?.codigo_pedido_sendas || item.solicitado.pedido_cliente,
            cod_produto: item.encontrado?.codigo_produto_sendas || item.solicitado.cod_produto,
            nome_produto: item.solicitado.nome_produto || '',
            quantidade: item.solicitado.quantidade,
            separacao_lote_id: item.solicitado.separacao_lote_id,  // ‚úÖ ADICIONADO
            data_expedicao: document.getElementById('modal-data-expedicao').value,
            data_agendamento: document.getElementById('modal-data-agendamento').value
        }));

        // Mostrar loading
        const btnConfirmar = document.getElementById('btn-confirmar-individual');
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Confirmando...';

        // Enviar confirma√ß√£o
        fetch('/portal/sendas/solicitar/lote/confirmar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                itens_confirmados: itensConfirmados
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    // Armazenar protocolo gerado
                    protocolosGerados[dadosCnpj.cnpj] = data.protocolos[dadosCnpj.cnpj];

                    // Fechar modal atual
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    bsModal.hide();

                    // Processar pr√≥ximo CNPJ
                    indiceAtualFila++;
                    setTimeout(() => {
                        modal.remove();
                        processarProximoCNPJ();
                    }, 500);
                } else {
                    alert('Erro ao confirmar: ' + (data.erro || 'Erro desconhecido'));
                    btnConfirmar.disabled = false;
                    btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar Agendamento';
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao confirmar agendamento');
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar Agendamento';
            });
    }

    // Pular CNPJ atual - DELETAR separa√ß√µes criadas
    async function pularCNPJAtual() {
        const modal = document.getElementById('modalComparacaoCNPJIndividual');
        const dadosCnpj = modal.dadosCnpj;

        // Buscar protocolo que foi gerado na prepara√ß√£o
        const protocolo = dadosCnpj.pedidos && dadosCnpj.pedidos.length > 0
            ? dadosCnpj.pedidos[0].protocolo
            : null;

        console.log(`Pulando CNPJ ${dadosCnpj.cnpj}, protocolo: ${protocolo}`);

        // Chamar endpoint para deletar separa√ß√µes
        try {
            const response = await fetch('/portal/sendas/solicitar/lote/cancelar-cnpj', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    cnpj: dadosCnpj.cnpj,
                    protocolo: protocolo
                })
            });

            const result = await response.json();

            if (result.sucesso) {
                console.log(`‚úÖ ${result.total_deletado} separa√ß√µes deletadas para CNPJ ${dadosCnpj.cnpj}`);
            } else {
                console.warn(`‚ö†Ô∏è Erro ao deletar separa√ß√µes: ${result.erro}`);
            }
        } catch (error) {
            console.error('Erro ao cancelar CNPJ:', error);
        }

        // Fechar modal e avan√ßar
        const bsModal = bootstrap.Modal.getInstance(modal);
        bsModal.hide();

        indiceAtualFila++;
        setTimeout(() => {
            modal.remove();
            processarProximoCNPJ();
        }, 500);
    }

    // Exibir resumo final
    function exibirResumoFinal() {
        const totalProcessados = Object.keys(protocolosGerados).length;
        const totalCNPJs = filaAgendamentoSendas.length;

        let mensagem = `<h5>Processo Conclu√≠do!</h5>`;
        mensagem += `<p>${totalProcessados} de ${totalCNPJs} CNPJs agendados com sucesso.</p>`;

        if (totalProcessados > 0) {
            mensagem += '<h6>Protocolos Gerados:</h6><ul>';
            for (const [cnpj, protocolo] of Object.entries(protocolosGerados)) {
                mensagem += `<li><strong>${cnpj}:</strong> ${protocolo}</li>`;
            }
            mensagem += '</ul>';
        }

        Swal.fire({
            icon: totalProcessados > 0 ? 'success' : 'info',
            title: 'Agendamento Conclu√≠do',
            html: mensagem,
            confirmButtonText: 'OK'
        });

        // Limpar vari√°veis
        filaAgendamentoSendas = [];
        indiceAtualFila = 0;
        protocolosGerados = {};
    }

    // Fun√ß√£o auxiliar para obter pr√≥ximo dia √∫til
    function getProximoDiaUtil() {
        const hoje = new Date();
        let dia = new Date(hoje);
        dia.setDate(dia.getDate() + 1);

        // Se for s√°bado (6) ou domingo (0), avan√ßar para segunda
        while (dia.getDay() === 0 || dia.getDay() === 6) {
            dia.setDate(dia.getDate() + 1);
        }

        return dia.toISOString().split('T')[0];
    }
</script>
<script src="{{ url_for('static', filename='js/programacao-lote.js') }}"></script>

<!-- Scripts adicionais Sendas (opcional - se precisar de fun√ß√µes auxiliares) -->
<!-- <script src="{{ url_for('static', filename='js/sendas_comparacao.js') }}"></script> -->

{% endblock %}