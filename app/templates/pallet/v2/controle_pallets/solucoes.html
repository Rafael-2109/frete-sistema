{% extends 'base.html' %}

{% block title %}Soluções de Pallet | Controle de Pallets v2{% endblock %}

{% block extra_css %}
<style>
/* ============================================
   SOLUÇÕES DE PALLET - Controle de Pallets v2
   Migrado para Design Tokens - Dark Mode Ready
   ============================================ */

.pallet-solucoes {
    padding: 1.5rem;
    background-color: var(--bg);
    min-height: calc(100vh - 60px);
}

/* Header */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.page-header h1 {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
}

.page-header h1 i {
    color: var(--semantic-success);
    margin-right: 0.5rem;
}

/* Breadcrumb */
.breadcrumb-nav {
    margin-bottom: 1rem;
}

.breadcrumb-nav .breadcrumb {
    background: transparent;
    padding: 0;
    margin: 0;
    font-size: 0.875rem;
}

.breadcrumb-nav .breadcrumb-item a {
    color: var(--text-muted);
    text-decoration: none;
}

.breadcrumb-nav .breadcrumb-item a:hover {
    color: var(--semantic-success);
}

.breadcrumb-nav .breadcrumb-item.active {
    color: var(--text);
}

/* Stats Cards */
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: var(--bg-light);
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.stat-icon.pendente { background: hsla(45 100% 65% / 0.2); color: var(--amber-55); }
.stat-icon.parcial { background: hsla(190 90% 50% / 0.2); color: hsl(190 90% 50%); }
.stat-icon.resolvido { background: hsla(145 60% 40% / 0.2); color: var(--semantic-success); }
.stat-icon.total { background: hsla(215 90% 60% / 0.2); color: hsl(215 90% 60%); }

.stat-content h4 {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
    color: var(--text);
}

.stat-content span {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.stat-saldo {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

/* Filtros */
.filter-card {
    background: var(--bg-light);
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: var(--shadow);
    margin-bottom: 1.5rem;
}

.filter-card .filter-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 1rem;
}

.filter-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: flex-end;
}

.filter-group {
    flex: 1;
    min-width: 180px;
}

.filter-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 0.5rem;
}

.filter-group select,
.filter-group input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.875rem;
    background-color: var(--bg-light);
    color: var(--text);
    transition: border-color 0.2s, box-shadow 0.2s;
}

.filter-group select:focus,
.filter-group input:focus {
    border-color: var(--semantic-success);
    box-shadow: 0 0 0 3px hsla(145 60% 40% / 0.15);
    outline: none;
}

.filter-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-filter {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-filter-primary {
    background: var(--semantic-success);
    color: hsl(0 0% 100%);
    border: none;
}

.btn-filter-primary:hover {
    background: hsl(145 70% 32%);
    color: hsl(0 0% 100%);
}

.btn-filter-secondary {
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border);
}

.btn-filter-secondary:hover {
    background: var(--bg-light);
}

/* Tabela de Créditos */
.table-card {
    background: var(--bg-light);
    border-radius: 12px;
    box-shadow: var(--shadow);
    overflow: hidden;
}

.table-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.table-header h3 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
}

.table-header .badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
}

.table-responsive {
    max-height: calc(100vh - 450px);
    overflow-y: auto;
}

.table-creditos {
    margin: 0;
    width: 100%;
}

.table-creditos thead th {
    background: var(--bg);
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0.75rem 1rem;
    border-bottom: 2px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 10;
}

.table-creditos tbody td {
    padding: 0.75rem 1rem;
    vertical-align: middle;
    font-size: 0.875rem;
    border-bottom: 1px solid var(--border);
    background: var(--bg-light);
}

.table-creditos tbody tr:hover td {
    background-color: var(--bg);
}

/* Badges de status */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-badge.pendente {
    background: hsla(45 100% 65% / 0.2);
    color: var(--amber-55);
}

.status-badge.parcial {
    background: hsla(190 90% 50% / 0.2);
    color: hsl(190 90% 50%);
}

.status-badge.resolvido {
    background: hsla(145 60% 40% / 0.2);
    color: var(--semantic-success);
}

.status-badge.vencido {
    background: hsla(0 70% 50% / 0.2);
    color: var(--semantic-danger);
}

.status-badge.a-vencer {
    background: hsla(30 100% 50% / 0.2);
    color: hsl(30 100% 45%);
}

/* Tipo de responsável badge */
.tipo-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
}

.tipo-badge.transportadora {
    background: hsla(215 90% 60% / 0.2);
    color: hsl(215 90% 60%);
}

.tipo-badge.cliente {
    background: hsla(145 60% 40% / 0.2);
    color: var(--semantic-success);
}

/* Célula de responsável */
.responsavel-cell {
    max-width: 200px;
}

.responsavel-nome {
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
}

.responsavel-cnpj {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: 'Monaco', 'Consolas', monospace;
}

/* Célula de saldo */
.saldo-cell {
    text-align: center;
}

.saldo-value {
    font-size: 1.25rem;
    font-weight: 700;
}

.saldo-original {
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* Botões de ação */
.action-buttons {
    display: flex;
    gap: 0.35rem;
    flex-wrap: wrap;
}

.btn-action {
    padding: 0.35rem 0.65rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.btn-baixa {
    background: hsla(0 70% 50% / 0.2);
    color: var(--semantic-danger);
}

.btn-baixa:hover {
    background: hsla(0 70% 50% / 0.3);
}

.btn-venda {
    background: hsla(145 60% 40% / 0.2);
    color: var(--semantic-success);
}

.btn-venda:hover {
    background: hsla(145 60% 40% / 0.3);
}

.btn-recebimento {
    background: hsla(190 90% 50% / 0.2);
    color: hsl(190 70% 45%);
}

.btn-recebimento:hover {
    background: hsla(190 90% 50% / 0.3);
}

.btn-substituicao {
    background: var(--bg);
    color: var(--text-muted);
}

.btn-substituicao:hover {
    background: var(--border);
}

.btn-detalhes {
    background: var(--bg);
    color: var(--text-muted);
}

.btn-detalhes:hover {
    background: var(--border);
}

/* Vencimento highlight */
.vencimento-cell {
    font-weight: 500;
}

.vencimento-cell.vencido {
    color: var(--semantic-danger);
}

.vencimento-cell.a-vencer {
    color: hsl(30 100% 45%);
}

.vencimento-cell.ok {
    color: var(--semantic-success);
}

/* Empty state */
.empty-state {
    padding: 3rem;
    text-align: center;
}

.empty-state i {
    font-size: 3rem;
    color: var(--border);
    margin-bottom: 1rem;
}

.empty-state h4 {
    color: var(--text-muted);
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.empty-state p {
    color: var(--text-muted);
    margin: 0;
}

/* Paginação */
.pagination-wrapper {
    padding: 1rem 1.25rem;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.pagination-info {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.pagination {
    margin: 0;
}

.pagination .page-link {
    border-radius: 6px;
    margin: 0 0.15rem;
    border: none;
    color: var(--text);
    background: var(--bg-light);
    font-size: 0.875rem;
}

.pagination .page-link:hover {
    background: var(--bg);
}

.pagination .page-item.active .page-link {
    background: var(--semantic-success);
    color: hsl(0 0% 100%);
}

/* Botão de ação principal */
.btn-primary-action {
    background: linear-gradient(135deg, hsl(145 65% 40%) 0%, hsl(145 70% 32%) 100%);
    color: hsl(0 0% 100%);
    border: none;
    padding: 0.625rem 1.25rem;
    border-radius: 10px;
    font-weight: 500;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
    box-shadow: 0 2px 8px hsla(145 60% 40% / 0.25);
}

.btn-primary-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px hsla(145 60% 40% / 0.35);
    color: hsl(0 0% 100%);
}

/* Modal */
.modal-header {
    background: linear-gradient(135deg, hsl(145 65% 40%) 0%, hsl(145 70% 32%) 100%);
    color: hsl(0 0% 100%);
    border-radius: 12px 12px 0 0;
}

.modal-header .btn-close {
    filter: brightness(0) invert(1);
}

.modal-content {
    border-radius: 12px;
    border: none;
    background: var(--bg-light);
    color: var(--text);
}

.modal-footer {
    border-top: 1px solid var(--border);
}

/* Modal header variants */
.modal-header.modal-baixa {
    background: linear-gradient(135deg, hsl(0 70% 50%) 0%, hsl(0 75% 40%) 100%);
}

.modal-header.modal-venda {
    background: linear-gradient(135deg, hsl(145 65% 40%) 0%, hsl(145 70% 32%) 100%);
}

.modal-header.modal-recebimento {
    background: linear-gradient(135deg, hsl(215 90% 60%) 0%, hsl(215 90% 50%) 100%);
}

.modal-header.modal-substituicao {
    background: linear-gradient(135deg, hsl(0 0% 45%) 0%, hsl(0 0% 35%) 100%);
}

/* Info card no modal */
.info-card {
    background: var(--bg);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.info-card h6 {
    color: var(--text-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
}

.info-card .info-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text);
}

.info-card .info-detail {
    font-size: 0.875rem;
    color: var(--text-muted);
}

/* ===== Modal Venda v2 - Redesigned ===== */
.venda-top-section,
.venda-body-section {
    background: var(--bg);
    border-radius: 8px;
    padding: 1rem;
}

.venda-section-title {
    color: var(--text-muted);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.75rem;
}

.venda-section-title i {
    margin-right: 0.25rem;
}

.venda-info-card {
    background: hsla(145 60% 40% / 0.08);
    border: 1px solid hsla(145 60% 40% / 0.25);
    border-radius: 8px;
    padding: 0.75rem 1rem;
}

.venda-info-cliente {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text);
}

.venda-info-qtd {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--semantic-success, #28a745);
}

.venda-info-valor {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.venda-totais-badge {
    background: var(--bg-dark, #f0f0f0);
    border-radius: 6px;
    padding: 0.35rem 0.75rem;
    font-size: 0.85rem;
    color: var(--text);
}

/* Autocomplete dropdown para modal de venda */
.venda-autocomplete-dropdown {
    display: none;
    position: absolute;
    z-index: 1060;
    width: 100%;
    max-height: 280px;
    overflow-y: auto;
    background: var(--bg-light, #fff);
    border: 1px solid var(--border, #ddd);
    border-radius: 0 0 0.375rem 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    margin-top: -1px;
}

.venda-autocomplete-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid var(--border, #eee);
    transition: background 0.15s;
}

.venda-autocomplete-item:hover {
    background: var(--bg, #f5f5f5);
}

.venda-autocomplete-item:last-child {
    border-bottom: none;
}

/* Linhas de remessa na tabela */
.remessa-row .remessa-autocomplete-wrapper {
    position: relative;
}

.remessa-row .venda-autocomplete-dropdown {
    left: 0;
    right: 0;
}

/* Fix: autocomplete da remessa nao ficar cortado pelo table-responsive */
#modalVenda .table-responsive {
    overflow: visible;
}

#modalVenda .venda-autocomplete-dropdown {
    z-index: 1070;
}

.btn-remove-remessa {
    background: none;
    border: none;
    color: var(--semantic-danger, #dc3545);
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    opacity: 0.5;
    font-size: 0.9rem;
    transition: opacity 0.15s;
}

.btn-remove-remessa:hover {
    opacity: 1;
}

/* Checkbox selection for batch operations */
.select-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* Batch action bar */
.batch-action-bar {
    background: var(--bg-dark);
    color: var(--text);
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: none;
    align-items: center;
    justify-content: space-between;
}

.batch-action-bar.show {
    display: flex;
}

.batch-count {
    font-weight: 600;
}

.batch-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-batch {
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
}
</style>
{% endblock %}

{% block content %}
<div class="pallet-solucoes">
    <!-- Breadcrumb -->
    <nav class="breadcrumb-nav" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('pallet_v2.dashboard.index') }}">
                    <i class="fas fa-pallet"></i> Gestão de Pallets
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Soluções de Pallets</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="page-header">
        <h1><i class="fas fa-tasks"></i> Soluções de Pallets</h1>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-success" onclick="openVendaModalLimpo()">
                <i class="fas fa-dollar-sign"></i> Nova Venda
            </button>
            <button type="button" class="btn btn-secondary" onclick="openSubstituicaoModalLimpo()">
                <i class="fas fa-exchange-alt"></i> Nova Substituição
            </button>
            <a href="{{ url_for('pallet_v2.controle_pallets.historico_solucoes') }}" class="btn btn-outline-secondary">
                <i class="fas fa-history"></i> Histórico
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-icon pendente">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="stat-content">
                <h4>{{ stats.pendentes }}</h4>
                <span>Pendentes</span>
                <div class="stat-saldo">{{ stats.pendentes_saldo }} pallets</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon parcial">
                <i class="fas fa-tasks"></i>
            </div>
            <div class="stat-content">
                <h4>{{ stats.parciais }}</h4>
                <span>Parciais</span>
                <div class="stat-saldo">{{ stats.parciais_saldo }} pallets</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon resolvido">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <h4>{{ stats.resolvidos }}</h4>
                <span>Resolvidos</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon total">
                <i class="fas fa-coins"></i>
            </div>
            <div class="stat-content">
                <h4>{{ stats.pendentes_saldo + stats.parciais_saldo }}</h4>
                <span>Total Saldo em Aberto</span>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-card">
        <div class="filter-title">
            <i class="fas fa-filter"></i> Filtros
        </div>
        <form method="GET" action="{{ url_for('pallet_v2.controle_pallets.listar_solucoes') }}">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="status">Status do Crédito</label>
                    <select name="status" id="status" class="form-select">
                        <option value="">Pendentes e Parciais</option>
                        <option value="PENDENTE" {% if filtro_status == 'PENDENTE' %}selected{% endif %}>Apenas Pendentes</option>
                        <option value="PARCIAL" {% if filtro_status == 'PARCIAL' %}selected{% endif %}>Apenas Parciais</option>
                        <option value="RESOLVIDO" {% if filtro_status == 'RESOLVIDO' %}selected{% endif %}>Resolvidos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="tipo_responsavel">Tipo de Responsável</label>
                    <select name="tipo_responsavel" id="tipo_responsavel" class="form-select">
                        <option value="">Todos</option>
                        <option value="TRANSPORTADORA" {% if filtro_tipo_responsavel == 'TRANSPORTADORA' %}selected{% endif %}>Transportadora</option>
                        <option value="CLIENTE" {% if filtro_tipo_responsavel == 'CLIENTE' %}selected{% endif %}>Cliente</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="cnpj">CNPJ/Nome do Responsável</label>
                    <input type="text"
                           name="cnpj"
                           id="cnpj"
                           class="form-control"
                           placeholder="Buscar por CNPJ ou nome..."
                           value="{{ filtro_cnpj or '' }}">
                </div>
                <div class="filter-actions">
                    <button type="submit" class="btn btn-filter btn-filter-primary">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                    <a href="{{ url_for('pallet_v2.controle_pallets.listar_solucoes') }}" class="btn btn-filter btn-filter-secondary">
                        <i class="fas fa-times"></i> Limpar
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Barra de ações em lote -->
    <div class="batch-action-bar" id="batchActionBar">
        <div>
            <span class="batch-count" id="batchCount">0</span> créditos selecionados
        </div>
        <div class="batch-actions">
            <button type="button" class="btn-batch btn-venda" onclick="openVendaLoteModal()">
                <i class="fas fa-dollar-sign"></i> Registrar Venda
            </button>
            <button type="button" class="btn-batch btn btn-secondary btn-sm" onclick="limparSelecao()">
                <i class="fas fa-times"></i> Cancelar
            </button>
        </div>
    </div>

    <!-- Tabela de Créditos -->
    <div class="table-card">
        <div class="table-header">
            <h3>
                <i class="fas fa-list"></i> Créditos de Pallets
            </h3>
            <span class="badge bg-secondary">{{ creditos.total }} registro(s)</span>
        </div>

        {% if creditos.items %}
        <div class="table-responsive">
            <table class="table table-creditos">
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" class="select-checkbox" id="selectAll" onclick="toggleSelectAll(this)">
                        </th>
                        <th>ID</th>
                        <th>NF Remessa</th>
                        <th>Tipo</th>
                        <th>Responsável</th>
                        <th class="text-center">Saldo</th>
                        <th>Vencimento</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for credito in creditos.items %}
                    <tr data-credito-id="{{ credito.id }}" data-credito-saldo="{{ credito.qtd_saldo }}">
                        <td>
                            <input type="checkbox"
                                   class="select-checkbox credito-checkbox"
                                   data-id="{{ credito.id }}"
                                   data-saldo="{{ credito.qtd_saldo }}"
                                   data-nf="{{ credito.nf_remessa.numero_nf if credito.nf_remessa else 'N/A' }}"
                                   data-responsavel="{{ credito.nome_responsavel or credito.cnpj_responsavel }}"
                                   onclick="updateBatchSelection()">
                        </td>
                        <td><strong>#{{ credito.id }}</strong></td>
                        <td>
                            {% if credito.nf_remessa %}
                            <a href="{{ url_for('pallet_v2.nf_remessa.detalhe', nf_id=credito.nf_remessa.id) }}" class="text-decoration-none">
                                <strong>{{ credito.nf_remessa.numero_nf }}</strong>
                            </a>
                            {% if credito.nf_remessa.serie %}
                            <small class="text-muted">/{{ credito.nf_remessa.serie }}</small>
                            {% endif %}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if credito.tipo_responsavel == 'TRANSPORTADORA' %}
                            <span class="tipo-badge transportadora">
                                <i class="fas fa-truck"></i> Transp.
                            </span>
                            {% else %}
                            <span class="tipo-badge cliente">
                                <i class="fas fa-user"></i> Cliente
                            </span>
                            {% endif %}
                        </td>
                        <td class="responsavel-cell">
                            <span class="responsavel-nome" title="{{ credito.nome_responsavel or 'N/A' }}">
                                {{ credito.nome_responsavel or 'N/A' }}
                            </span>
                            {% if credito.cnpj_responsavel %}
                            <span class="responsavel-cnpj">{{ credito.cnpj_responsavel }}</span>
                            {% endif %}
                        </td>
                        <td class="saldo-cell">
                            <div class="saldo-value
                                {% if credito.qtd_saldo == credito.qtd_original %}text-warning
                                {% elif credito.qtd_saldo == 0 %}text-success
                                {% else %}text-info{% endif %}">
                                {{ credito.qtd_saldo }}
                            </div>
                            <div class="saldo-original">de {{ credito.qtd_original }}</div>
                        </td>
                        <td class="vencimento-cell
                            {% if credito.vencido %}vencido
                            {% elif credito.prestes_a_vencer %}a-vencer
                            {% else %}ok{% endif %}">
                            {% if credito.data_vencimento %}
                            {{ credito.data_vencimento|formatar_data_segura }}
                            {% if credito.dias_para_vencer is not none %}
                                {% if credito.dias_para_vencer < 0 %}
                                <br><small class="text-danger">({{ credito.dias_para_vencer|abs }} dias atrás)</small>
                                {% elif credito.dias_para_vencer == 0 %}
                                <br><small class="text-warning">(Hoje)</small>
                                {% elif credito.dias_para_vencer <= 7 %}
                                <br><small class="text-warning">({{ credito.dias_para_vencer }} dias)</small>
                                {% endif %}
                            {% endif %}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if credito.vencido %}
                            <span class="status-badge vencido">
                                <i class="fas fa-exclamation-circle"></i> Vencido
                            </span>
                            {% elif credito.status == 'PENDENTE' %}
                            <span class="status-badge pendente">
                                <i class="fas fa-hourglass-half"></i> Pendente
                            </span>
                            {% elif credito.status == 'PARCIAL' %}
                            <span class="status-badge parcial">
                                <i class="fas fa-tasks"></i> Parcial
                            </span>
                            {% elif credito.status == 'RESOLVIDO' %}
                            <span class="status-badge resolvido">
                                <i class="fas fa-check"></i> Resolvido
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                {% if credito.status != 'RESOLVIDO' %}
                                <button type="button" class="btn-action btn-baixa" title="Registrar Baixa"
                                        onclick="openBaixaModal({{ credito.id }}, {{ credito.qtd_saldo }}, '{{ credito.nf_remessa.numero_nf if credito.nf_remessa else '' }}', '{{ credito.nome_responsavel or credito.cnpj_responsavel or '' }}')">
                                    <i class="fas fa-minus-circle"></i>
                                </button>
                                <button type="button" class="btn-action btn-venda" title="Registrar Venda"
                                        onclick="openVendaModal({{ credito.id }}, {{ credito.qtd_saldo }}, '{{ credito.nf_remessa.numero_nf if credito.nf_remessa else '' }}', '{{ credito.nome_responsavel or credito.cnpj_responsavel or '' }}')">
                                    <i class="fas fa-dollar-sign"></i>
                                </button>
                                <button type="button" class="btn-action btn-recebimento" title="Registrar Recebimento"
                                        onclick="openRecebimentoModal({{ credito.id }}, {{ credito.qtd_saldo }}, '{{ credito.nf_remessa.numero_nf if credito.nf_remessa else '' }}', '{{ credito.nome_responsavel or credito.cnpj_responsavel or '' }}')">
                                    <i class="fas fa-box"></i>
                                </button>
                                <button type="button" class="btn-action btn-substituicao" title="Substituição de Responsabilidade"
                                        onclick="openSubstituicaoModal({{ credito.id }}, {{ credito.qtd_saldo }}, '{{ credito.nf_remessa.numero_nf if credito.nf_remessa else '' }}', '{{ credito.nome_responsavel or credito.cnpj_responsavel or '' }}')">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                {% endif %}
                                <button type="button" class="btn-action btn-detalhes" title="Ver Detalhes"
                                        onclick="openDetalhesModal({{ credito.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Paginação -->
        <div class="pagination-wrapper">
            <div class="pagination-info">
                Mostrando {{ ((creditos.page - 1) * creditos.per_page) + 1 }} -
                {{ [creditos.page * creditos.per_page, creditos.total]|min }}
                de {{ creditos.total }} registros
            </div>

            {% if creditos.pages > 1 %}
            <nav aria-label="Paginação">
                <ul class="pagination">
                    {% if creditos.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('pallet_v2.controle_pallets.listar_solucoes', page=creditos.prev_num, status=filtro_status, tipo_responsavel=filtro_tipo_responsavel, cnpj=filtro_cnpj) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for page_num in creditos.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if page_num %}
                            {% if page_num == creditos.page %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('pallet_v2.controle_pallets.listar_solucoes', page=page_num, status=filtro_status, tipo_responsavel=filtro_tipo_responsavel, cnpj=filtro_cnpj) }}">{{ page_num }}</a>
                            </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if creditos.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('pallet_v2.controle_pallets.listar_solucoes', page=creditos.next_num, status=filtro_status, tipo_responsavel=filtro_tipo_responsavel, cnpj=filtro_cnpj) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>

        {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <i class="fas fa-coins"></i>
            <h4>Nenhum crédito encontrado</h4>
            <p>Ajuste os filtros ou aguarde novas NFs de remessa</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- =============================================
     MODAL: REGISTRAR BAIXA
     ============================================= -->
<div class="modal fade" id="modalBaixa" tabindex="-1" aria-labelledby="modalBaixaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header modal-baixa">
                <h5 class="modal-title" id="modalBaixaLabel">
                    <i class="fas fa-minus-circle"></i> Registrar Baixa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{{ url_for('pallet_v2.controle_pallets.registrar_baixa') }}">
                <div class="modal-body">
                    <input type="hidden" name="credito_id" id="baixa_credito_id">

                    <!-- Info do crédito -->
                    <div class="info-card">
                        <h6>Crédito Selecionado</h6>
                        <div class="info-value" id="baixa_info_nf">-</div>
                        <div class="info-detail" id="baixa_info_responsavel">-</div>
                        <div class="info-detail">Saldo disponível: <strong id="baixa_info_saldo">-</strong> pallets</div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="baixa_quantidade" class="form-label">Quantidade <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="baixa_quantidade" name="quantidade" min="1" required>
                            <small class="text-muted">Quantidade de pallets a dar baixa</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Confirmação do Cliente</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="confirmado_cliente" name="confirmado_cliente">
                                <label class="form-check-label" for="confirmado_cliente">
                                    Cliente confirmou descarte
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="baixa_motivo" class="form-label">Motivo da Baixa <span class="text-danger">*</span></label>
                            <select class="form-select" id="baixa_motivo" name="motivo" required>
                                <option value="">Selecione...</option>
                                <option value="DESCARTAVEL">Pallet descartável (acordado com cliente)</option>
                                <option value="DANIFICADO">Pallet danificado</option>
                                <option value="PERDIDO">Pallet perdido</option>
                                <option value="ACORDO_COMERCIAL">Acordo comercial</option>
                                <option value="OUTRO">Outro motivo</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="baixa_observacao" class="form-label">Observações</label>
                            <textarea class="form-control" id="baixa_observacao" name="observacao" rows="2" placeholder="Detalhes adicionais..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-minus-circle"></i> Confirmar Baixa
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =============================================
     MODAL: REGISTRAR VENDA (Redesigned v2)
     ============================================= -->
<div class="modal fade" id="modalVenda" tabindex="-1" aria-labelledby="modalVendaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header modal-venda">
                <h5 class="modal-title" id="modalVendaLabel">
                    <i class="fas fa-dollar-sign"></i> Registrar Venda de Pallets
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{{ url_for('pallet_v2.controle_pallets.registrar_venda') }}" id="formVenda" onsubmit="return validarFormVenda()">
                <div class="modal-body">
                    <input type="hidden" name="creditos" id="venda_creditos_json">

                    <!-- ===== TOPO: NF de Venda ===== -->
                    <div class="venda-top-section">
                        <h6 class="venda-section-title"><i class="fas fa-file-invoice"></i> NF de Venda</h6>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-5">
                                <label for="venda_nf" class="form-label">Buscar NF de Venda <span class="text-danger">*</span></label>
                                <div style="position: relative;">
                                    <input type="text" class="form-control" id="venda_nf" name="nf_venda"
                                           required placeholder="Digite numero da NF ou nome do cliente..."
                                           autocomplete="off">
                                    <div id="listaNfVenda" class="venda-autocomplete-dropdown"></div>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <div id="vendaInfoCard" class="venda-info-card" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="venda-info-cliente" id="venda_info_cliente">-</div>
                                            <small class="text-muted" id="venda_info_data">-</small>
                                        </div>
                                        <div class="text-end">
                                            <div class="venda-info-qtd"><span id="venda_info_qtd">0</span> pallets</div>
                                            <div class="venda-info-valor">R$ <span id="venda_info_valor">0,00</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Campos adicionais (colapsados) -->
                        <div class="row g-2 mt-2">
                            <div class="col-md-3">
                                <label for="venda_cnpj" class="form-label form-label-sm">CNPJ Comprador</label>
                                <input type="text" class="form-control form-control-sm" id="venda_cnpj" name="cnpj_comprador" placeholder="00.000.000/0000-00">
                            </div>
                            <div class="col-md-3">
                                <label for="venda_nome" class="form-label form-label-sm">Nome Comprador</label>
                                <input type="text" class="form-control form-control-sm" id="venda_nome" name="nome_comprador" placeholder="Razao Social">
                            </div>
                            <div class="col-md-3">
                                <label for="venda_data" class="form-label form-label-sm">Data Venda</label>
                                <input type="date" class="form-control form-control-sm" id="venda_data" name="data_venda">
                            </div>
                            <div class="col-md-3">
                                <label for="venda_valor" class="form-label form-label-sm">Vlr. Unitario (R$)</label>
                                <input type="text" class="form-control form-control-sm" id="venda_valor" name="valor_unitario" value="35,00">
                            </div>
                        </div>
                    </div>

                    <hr class="my-3">

                    <!-- ===== CORPO: NFs de Remessa ===== -->
                    <div class="venda-body-section">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="venda-section-title mb-0"><i class="fas fa-truck"></i> NFs de Remessa</h6>
                            <div class="venda-totais-badge">
                                Total: <strong id="venda_total_pallets">0</strong> pallets
                                &middot; R$ <strong id="venda_total_valor">0,00</strong>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-1" id="tabelaRemessasVenda">
                                <thead>
                                    <tr>
                                        <th style="width: 35%">NF Remessa</th>
                                        <th style="width: 25%">Responsavel</th>
                                        <th style="width: 13%" class="text-center">Saldo</th>
                                        <th style="width: 17%" class="text-center">Qtd Venda</th>
                                        <th style="width: 10%"></th>
                                    </tr>
                                </thead>
                                <tbody id="vendaRemessasBody">
                                    <!-- Linhas dinamicas via JS -->
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="adicionarLinhaRemessa()">
                            <i class="fas fa-plus"></i> Adicionar +
                        </button>
                    </div>

                    <!-- Observacoes -->
                    <div class="mt-3">
                        <label for="venda_observacao" class="form-label form-label-sm">Observacoes</label>
                        <textarea class="form-control form-control-sm" id="venda_observacao" name="observacao" rows="2" placeholder="Observacoes adicionais..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btnConfirmarVenda">
                        <i class="fas fa-dollar-sign"></i> Confirmar Venda
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =============================================
     MODAL: REGISTRAR RECEBIMENTO
     ============================================= -->
<div class="modal fade" id="modalRecebimento" tabindex="-1" aria-labelledby="modalRecebimentoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header modal-recebimento">
                <h5 class="modal-title" id="modalRecebimentoLabel">
                    <i class="fas fa-box"></i> Registrar Recebimento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{{ url_for('pallet_v2.controle_pallets.registrar_recebimento') }}">
                <div class="modal-body">
                    <input type="hidden" name="credito_id" id="recebimento_credito_id">

                    <!-- Info do crédito -->
                    <div class="info-card">
                        <h6>Crédito Selecionado</h6>
                        <div class="info-value" id="recebimento_info_nf">-</div>
                        <div class="info-detail" id="recebimento_info_responsavel">-</div>
                        <div class="info-detail">Saldo disponível: <strong id="recebimento_info_saldo">-</strong> pallets</div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="recebimento_quantidade" class="form-label">Quantidade Recebida <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="recebimento_quantidade" name="quantidade" min="1" required>
                        </div>
                        <div class="col-md-6">
                            <label for="recebimento_data" class="form-label">Data do Recebimento</label>
                            <input type="date" class="form-control" id="recebimento_data" name="data_recebimento">
                        </div>
                        <div class="col-12">
                            <label for="recebimento_local" class="form-label">Local do Recebimento</label>
                            <input type="text" class="form-control" id="recebimento_local" name="local_recebimento" placeholder="Ex: CD Goiânia, Coleta na obra, etc.">
                        </div>
                        <div class="col-12">
                            <label for="recebimento_observacao" class="form-label">Observações</label>
                            <textarea class="form-control" id="recebimento_observacao" name="observacao" rows="2" placeholder="Detalhes do recebimento..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-box"></i> Confirmar Recebimento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =============================================
     MODAL: SUBSTITUIÇÃO DE RESPONSABILIDADE (v2)
     ============================================= -->
<div class="modal fade" id="modalSubstituicao" tabindex="-1" aria-labelledby="modalSubstituicaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-substituicao">
                <h5 class="modal-title" id="modalSubstituicaoLabel">
                    <i class="fas fa-exchange-alt"></i> Substituição de Responsabilidade
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{{ url_for('pallet_v2.controle_pallets.registrar_substituicao') }}" id="formSubstituicao">
                <div class="modal-body">
                    <input type="hidden" name="credito_origem_id" id="substituicao_credito_id">
                    <input type="hidden" name="nf_remessa_destino_id" id="substituicao_nf_destino_id">

                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle"></i>
                        Selecione a NF de origem (de onde saem os pallets) e a NF de destino (para onde transferir a responsabilidade).
                    </div>

                    <!-- PASSO 1: NF de Origem (autocomplete) -->
                    <div class="mb-3" id="substituicao_origem_busca">
                        <label for="substituicao_nf_origem_input" class="form-label">
                            NF de Origem <span class="text-danger">*</span>
                        </label>
                        <div style="position: relative;">
                            <input type="text" class="form-control" id="substituicao_nf_origem_input"
                                   placeholder="Digite o número da NF de remessa..."
                                   autocomplete="off">
                            <div id="listaSubstOrigem" class="venda-autocomplete-dropdown"></div>
                        </div>
                    </div>

                    <!-- Info card da ORIGEM (exibido após selecionar) -->
                    <div class="info-card mb-3" id="substituicao_origem_card" style="display: none;">
                        <h6><i class="fas fa-file-export"></i> Crédito de Origem</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="info-value" id="substituicao_info_nf">-</div>
                                <div class="info-detail" id="substituicao_info_responsavel">-</div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-warning text-dark" id="substituicao_info_saldo_badge">0 pallets</span>
                                <div class="info-detail">Saldo disponível</div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="limparOrigemSubstituicao()">
                            <i class="fas fa-times"></i> Alterar
                        </button>
                    </div>

                    <!-- PASSO 2: Quantidade -->
                    <div class="mb-3" id="substituicao_qtd_wrapper" style="display: none;">
                        <label for="substituicao_quantidade" class="form-label">
                            Quantidade a Transferir <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="substituicao_quantidade"
                               name="quantidade" min="1" required>
                        <small class="text-muted">Máximo: <span id="substituicao_max_info">0</span> pallets</small>
                    </div>

                    <!-- PASSO 3: NF de Destino (autocomplete) -->
                    <div class="mb-3" id="substituicao_destino_busca" style="display: none;">
                        <label for="substituicao_nf_destino_input" class="form-label">
                            NF de Remessa Destino <span class="text-danger">*</span>
                        </label>
                        <div style="position: relative;">
                            <input type="text" class="form-control" id="substituicao_nf_destino_input"
                                   placeholder="Digite o número da NF de remessa destino..."
                                   autocomplete="off">
                            <div id="listaSubstDestino" class="venda-autocomplete-dropdown"></div>
                        </div>
                    </div>

                    <!-- Info card do DESTINO (exibido após selecionar) -->
                    <div class="info-card mb-3" id="substituicao_destino_card" style="display: none;">
                        <h6><i class="fas fa-file-import"></i> NF de Destino</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="info-value" id="substituicao_dest_nf">-</div>
                                <div class="info-detail" id="substituicao_dest_responsavel">-</div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-info text-dark" id="substituicao_dest_qtd_badge">0 pallets</span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="limparDestinoSubstituicao()">
                            <i class="fas fa-times"></i> Alterar
                        </button>
                    </div>

                    <!-- PASSO 4: Observações -->
                    <div class="mb-3" id="substituicao_obs_wrapper" style="display: none;">
                        <label for="substituicao_observacao" class="form-label">Observações</label>
                        <textarea class="form-control" id="substituicao_observacao" name="observacao"
                                  rows="2" placeholder="Motivo da substituição (opcional)..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnConfirmarSubstituicao" disabled>
                        <i class="fas fa-exchange-alt"></i> Confirmar Substituição
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =============================================
     MODAL: DETALHES DO CRÉDITO
     ============================================= -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalhesLabel">
                    <i class="fas fa-info-circle"></i> Detalhes do Crédito
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="modalDetalhesContent">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// =============================================
// SELEÇÃO EM LOTE
// =============================================
let creditosSelecionados = [];

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.credito-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateBatchSelection();
}

function updateBatchSelection() {
    creditosSelecionados = [];
    const checkboxes = document.querySelectorAll('.credito-checkbox:checked');

    checkboxes.forEach(cb => {
        creditosSelecionados.push({
            id: parseInt(cb.dataset.id),
            saldo: parseInt(cb.dataset.saldo),
            nf: cb.dataset.nf,
            responsavel: cb.dataset.responsavel
        });
    });

    const batchBar = document.getElementById('batchActionBar');
    const batchCount = document.getElementById('batchCount');

    if (creditosSelecionados.length > 0) {
        batchBar.classList.add('show');
        batchCount.textContent = creditosSelecionados.length;
    } else {
        batchBar.classList.remove('show');
    }

    // Atualizar checkbox "Selecionar todos"
    const selectAll = document.getElementById('selectAll');
    const totalCheckboxes = document.querySelectorAll('.credito-checkbox').length;
    selectAll.checked = checkboxes.length === totalCheckboxes && totalCheckboxes > 0;
    selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < totalCheckboxes;
}

function limparSelecao() {
    document.querySelectorAll('.credito-checkbox, #selectAll').forEach(cb => {
        cb.checked = false;
    });
    updateBatchSelection();
}

// =============================================
// MODAL BAIXA
// =============================================
function openBaixaModal(creditoId, saldo, nf, responsavel) {
    document.getElementById('baixa_credito_id').value = creditoId;
    document.getElementById('baixa_info_nf').textContent = 'NF ' + (nf || 'N/A');
    document.getElementById('baixa_info_responsavel').textContent = responsavel || 'N/A';
    document.getElementById('baixa_info_saldo').textContent = saldo;
    document.getElementById('baixa_quantidade').max = saldo;
    document.getElementById('baixa_quantidade').value = saldo;

    new bootstrap.Modal(document.getElementById('modalBaixa')).show();
}

// =============================================
// MODAL VENDA (Redesigned v2)
// =============================================
let vendaLinhaCounter = 0;
let vendaLinhas = []; // {linhaId, credito_id, numero_nf, nome_responsavel, qtd_saldo, quantidade}
let vendaNfTimeout = null;
let remessaTimeouts = {};

// ---- Abrir modal ----
function openVendaModal(creditoId, saldo, nf, responsavel) {
    resetVendaModal();
    adicionarLinhaRemessaPreenchida(creditoId, nf, responsavel, saldo, saldo);
    new bootstrap.Modal(document.getElementById('modalVenda')).show();
}

function openVendaLoteModal() {
    if (creditosSelecionados.length === 0) {
        alert('Selecione pelo menos um credito para a venda.');
        return;
    }
    resetVendaModal();
    creditosSelecionados.forEach(c => {
        adicionarLinhaRemessaPreenchida(c.id, c.nf, c.responsavel, c.saldo, c.saldo);
    });
    new bootstrap.Modal(document.getElementById('modalVenda')).show();
}

function openVendaModalLimpo() {
    resetVendaModal();
    adicionarLinhaRemessa();
    new bootstrap.Modal(document.getElementById('modalVenda')).show();
}

function resetVendaModal() {
    vendaLinhaCounter = 0;
    vendaLinhas = [];
    document.getElementById('vendaRemessasBody').innerHTML = '';
    document.getElementById('venda_nf').value = '';
    document.getElementById('venda_cnpj').value = '';
    document.getElementById('venda_nome').value = '';
    document.getElementById('venda_observacao').value = '';
    document.getElementById('venda_valor').value = '35,00';
    document.getElementById('vendaInfoCard').style.display = 'none';

    const dataVenda = document.getElementById('venda_data');
    dataVenda.value = new Date().toISOString().split('T')[0];

    recalcularTotaisVenda();
}

// ---- Autocomplete: NF de Venda (topo) ----
function buscarNfVenda(termo) {
    const lista = document.getElementById('listaNfVenda');

    if (vendaNfTimeout) clearTimeout(vendaNfTimeout);

    if (termo.trim().length < 2) {
        lista.style.display = 'none';
        return;
    }

    vendaNfTimeout = setTimeout(function() {
        const url = '{{ url_for("pallet_v2.controle_pallets.api_buscar_vendas_pallet") }}' +
            '?q=' + encodeURIComponent(termo.trim()) + '&limit=10';

        fetch(url)
            .then(r => r.json())
            .then(data => {
                lista.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(venda => {
                        const valorFmt = venda.valor_total ? parseFloat(venda.valor_total).toFixed(2).replace('.', ',') : '0,00';
                        const jaVinc = venda.ja_vinculada ? ' <span class="badge bg-secondary">vinculada</span>' : '';
                        const div = document.createElement('div');
                        div.className = 'venda-autocomplete-item';
                        div.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>NF ${venda.numero_nf}</strong>${jaVinc}
                                    <br><small class="text-muted">${venda.nome_comprador || '-'}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-warning text-dark">${venda.quantidade} plt</span>
                                    <br><small class="text-muted">R$ ${valorFmt}</small>
                                </div>
                            </div>
                        `;
                        div.addEventListener('click', function() {
                            selecionarNfVenda(venda);
                            lista.style.display = 'none';
                        });
                        lista.appendChild(div);
                    });
                    lista.style.display = 'block';
                } else {
                    lista.innerHTML = '<div class="p-2 text-muted text-center small">Nenhuma NF de venda encontrada</div>';
                    lista.style.display = 'block';
                }
            })
            .catch(err => {
                console.error('Erro buscar NF venda:', err);
                lista.style.display = 'none';
            });
    }, 300);
}

function selecionarNfVenda(venda) {
    document.getElementById('venda_nf').value = venda.numero_nf;
    document.getElementById('venda_cnpj').value = venda.cnpj_comprador || '';
    document.getElementById('venda_nome').value = venda.nome_comprador || '';

    // Calcular valor unitario a partir do total
    const qtd = venda.quantidade || 1;
    const valorTotal = parseFloat(venda.valor_total) || 0;
    const valorUnit = qtd > 0 ? (valorTotal / qtd) : 35;
    document.getElementById('venda_valor').value = valorUnit.toFixed(2).replace('.', ',');

    // Exibir info card
    const card = document.getElementById('vendaInfoCard');
    document.getElementById('venda_info_cliente').textContent = venda.nome_comprador || '-';
    document.getElementById('venda_info_data').textContent = venda.data_venda || '-';
    document.getElementById('venda_info_qtd').textContent = qtd;
    document.getElementById('venda_info_valor').textContent = valorTotal.toFixed(2).replace('.', ',');
    card.style.display = 'block';

    recalcularTotaisVenda();
}

// ---- Linhas de Remessa (corpo) ----
function adicionarLinhaRemessa() {
    const linhaId = vendaLinhaCounter++;
    const tbody = document.getElementById('vendaRemessasBody');

    const tr = document.createElement('tr');
    tr.className = 'remessa-row';
    tr.id = 'remessa_row_' + linhaId;
    tr.innerHTML = `
        <td>
            <div class="remessa-autocomplete-wrapper" style="position: relative;">
                <input type="text" class="form-control form-control-sm"
                       id="remessa_busca_${linhaId}"
                       placeholder="Buscar NF remessa..."
                       autocomplete="off"
                       oninput="buscarRemessa(${linhaId}, this.value)">
                <input type="hidden" id="remessa_credito_id_${linhaId}">
                <div class="venda-autocomplete-dropdown" id="remessa_lista_${linhaId}"></div>
            </div>
        </td>
        <td>
            <span class="text-muted small" id="remessa_responsavel_${linhaId}">-</span>
        </td>
        <td class="text-center">
            <span class="text-muted" id="remessa_saldo_${linhaId}">-</span>
        </td>
        <td class="text-center">
            <input type="number" class="form-control form-control-sm text-center"
                   id="remessa_qtd_${linhaId}" min="1" value=""
                   disabled
                   onchange="recalcularTotaisVenda()">
        </td>
        <td class="text-center">
            <button type="button" class="btn-remove-remessa" onclick="removerLinhaRemessa(${linhaId})" title="Remover">
                <i class="fas fa-times"></i>
            </button>
        </td>
    `;

    tbody.appendChild(tr);

    vendaLinhas.push({
        linhaId: linhaId,
        credito_id: null,
        numero_nf: null,
        nome_responsavel: null,
        qtd_saldo: 0,
        quantidade: 0
    });

    document.getElementById('remessa_busca_' + linhaId).focus();
}

function adicionarLinhaRemessaPreenchida(creditoId, nf, responsavel, saldo, quantidade) {
    const linhaId = vendaLinhaCounter++;
    const tbody = document.getElementById('vendaRemessasBody');

    const tr = document.createElement('tr');
    tr.className = 'remessa-row';
    tr.id = 'remessa_row_' + linhaId;
    tr.innerHTML = `
        <td>
            <div class="remessa-autocomplete-wrapper" style="position: relative;">
                <input type="text" class="form-control form-control-sm"
                       id="remessa_busca_${linhaId}"
                       value="NF ${nf || 'N/A'}"
                       autocomplete="off"
                       oninput="buscarRemessa(${linhaId}, this.value)">
                <input type="hidden" id="remessa_credito_id_${linhaId}" value="${creditoId}">
                <div class="venda-autocomplete-dropdown" id="remessa_lista_${linhaId}"></div>
            </div>
        </td>
        <td>
            <span class="text-muted small" id="remessa_responsavel_${linhaId}">${responsavel || '-'}</span>
        </td>
        <td class="text-center">
            <span id="remessa_saldo_${linhaId}"><strong>${saldo}</strong></span>
        </td>
        <td class="text-center">
            <input type="number" class="form-control form-control-sm text-center"
                   id="remessa_qtd_${linhaId}" min="1" max="${saldo}" value="${quantidade}"
                   onchange="recalcularTotaisVenda()">
        </td>
        <td class="text-center">
            <button type="button" class="btn-remove-remessa" onclick="removerLinhaRemessa(${linhaId})" title="Remover">
                <i class="fas fa-times"></i>
            </button>
        </td>
    `;

    tbody.appendChild(tr);

    vendaLinhas.push({
        linhaId: linhaId,
        credito_id: creditoId,
        numero_nf: nf,
        nome_responsavel: responsavel,
        qtd_saldo: saldo,
        quantidade: quantidade
    });

    recalcularTotaisVenda();
}

function removerLinhaRemessa(linhaId) {
    const row = document.getElementById('remessa_row_' + linhaId);
    if (row) row.remove();
    vendaLinhas = vendaLinhas.filter(l => l.linhaId !== linhaId);
    recalcularTotaisVenda();
}

// ---- Autocomplete: NF de Remessa ----
function buscarRemessa(linhaId, termo) {
    // Limpar selecao anterior
    document.getElementById('remessa_credito_id_' + linhaId).value = '';
    document.getElementById('remessa_responsavel_' + linhaId).textContent = '-';
    document.getElementById('remessa_saldo_' + linhaId).textContent = '-';
    const qtdInput = document.getElementById('remessa_qtd_' + linhaId);
    qtdInput.value = '';
    qtdInput.disabled = true;

    const linhaData = vendaLinhas.find(l => l.linhaId === linhaId);
    if (linhaData) {
        linhaData.credito_id = null;
        linhaData.qtd_saldo = 0;
        linhaData.quantidade = 0;
    }

    const lista = document.getElementById('remessa_lista_' + linhaId);
    termo = termo.trim();

    if (remessaTimeouts[linhaId]) clearTimeout(remessaTimeouts[linhaId]);

    if (termo.length < 1) {
        lista.style.display = 'none';
        recalcularTotaisVenda();
        return;
    }

    remessaTimeouts[linhaId] = setTimeout(function() {
        const url = '{{ url_for("pallet_v2.controle_pallets.api_listar_creditos") }}' +
            '?q=' + encodeURIComponent(termo) + '&status=PENDENTE,PARCIAL&limit=15';

        fetch(url)
            .then(r => r.json())
            .then(data => {
                lista.innerHTML = '';

                // Filtrar creditos ja selecionados em outras linhas
                const creditosJaSelecionados = vendaLinhas
                    .filter(l => l.linhaId !== linhaId && l.credito_id)
                    .map(l => l.credito_id);

                const disponiveis = data.filter(c => !creditosJaSelecionados.includes(c.id));

                if (!disponiveis || disponiveis.length === 0) {
                    lista.innerHTML = '<div class="p-2 text-muted text-center small">Nenhum credito disponivel</div>';
                } else {
                    disponiveis.forEach(credito => {
                        const div = document.createElement('div');
                        div.className = 'venda-autocomplete-item';
                        div.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>NF ${credito.numero_nf || 'N/A'}</strong>
                                    <br><small class="text-muted">${credito.nome_responsavel || credito.cnpj_responsavel || '-'}</small>
                                </div>
                                <span class="badge bg-warning text-dark">${credito.qtd_saldo} plt</span>
                            </div>
                        `;
                        div.addEventListener('click', function() {
                            selecionarRemessa(linhaId, credito);
                            lista.style.display = 'none';
                        });
                        lista.appendChild(div);
                    });
                }
                lista.style.display = 'block';
            })
            .catch(err => {
                console.error('Erro buscar remessa:', err);
                lista.innerHTML = '<div class="p-2 text-danger text-center small">Erro na busca</div>';
                lista.style.display = 'block';
            });
    }, 300);
}

function selecionarRemessa(linhaId, credito) {
    document.getElementById('remessa_busca_' + linhaId).value = 'NF ' + (credito.numero_nf || 'N/A');
    document.getElementById('remessa_credito_id_' + linhaId).value = credito.id;
    document.getElementById('remessa_responsavel_' + linhaId).textContent = credito.nome_responsavel || credito.cnpj_responsavel || '-';
    document.getElementById('remessa_saldo_' + linhaId).innerHTML = '<strong>' + credito.qtd_saldo + '</strong>';

    const qtdInput = document.getElementById('remessa_qtd_' + linhaId);
    qtdInput.disabled = false;
    qtdInput.max = credito.qtd_saldo;
    qtdInput.value = credito.qtd_saldo;

    const linhaData = vendaLinhas.find(l => l.linhaId === linhaId);
    if (linhaData) {
        linhaData.credito_id = credito.id;
        linhaData.numero_nf = credito.numero_nf;
        linhaData.nome_responsavel = credito.nome_responsavel;
        linhaData.qtd_saldo = credito.qtd_saldo;
        linhaData.quantidade = credito.qtd_saldo;
    }

    recalcularTotaisVenda();
}

// ---- Totais e JSON ----
function recalcularTotaisVenda() {
    let totalQtd = 0;
    const creditos = [];

    vendaLinhas.forEach(linha => {
        const qtdInput = document.getElementById('remessa_qtd_' + linha.linhaId);
        if (qtdInput && linha.credito_id) {
            const qtd = parseInt(qtdInput.value) || 0;
            linha.quantidade = qtd;
            totalQtd += qtd;
            creditos.push({ credito_id: linha.credito_id, quantidade: qtd });
        }
    });

    document.getElementById('venda_total_pallets').textContent = totalQtd;

    // Calcular valor total
    const valorStr = document.getElementById('venda_valor').value.replace(/\./g, '').replace(',', '.');
    const valorUnitario = parseFloat(valorStr) || 35.0;
    const totalValor = totalQtd * valorUnitario;
    document.getElementById('venda_total_valor').textContent = totalValor.toFixed(2).replace('.', ',');

    // Atualizar JSON hidden
    document.getElementById('venda_creditos_json').value = JSON.stringify(creditos);
}

// ---- Validacao ----
function validarFormVenda() {
    const nfVenda = document.getElementById('venda_nf').value.trim();
    if (!nfVenda) {
        alert('Informe o numero da NF de venda.');
        return false;
    }

    const creditosValidos = vendaLinhas.filter(l => l.credito_id && l.quantidade > 0);
    if (creditosValidos.length === 0) {
        alert('Adicione pelo menos uma NF de remessa com quantidade.');
        return false;
    }

    for (const linha of vendaLinhas) {
        if (linha.credito_id) {
            const qtdInput = document.getElementById('remessa_qtd_' + linha.linhaId);
            const qtd = parseInt(qtdInput.value) || 0;
            if (qtd <= 0) {
                alert('Quantidade invalida na linha da NF ' + (linha.numero_nf || 'N/A') + '.');
                return false;
            }
            if (qtd > linha.qtd_saldo) {
                alert('Quantidade (' + qtd + ') excede saldo (' + linha.qtd_saldo + ') na NF ' + (linha.numero_nf || 'N/A') + '.');
                return false;
            }
        }
    }

    recalcularTotaisVenda();
    return true;
}

// =============================================
// MODAL RECEBIMENTO
// =============================================
function openRecebimentoModal(creditoId, saldo, nf, responsavel) {
    document.getElementById('recebimento_credito_id').value = creditoId;
    document.getElementById('recebimento_info_nf').textContent = 'NF ' + (nf || 'N/A');
    document.getElementById('recebimento_info_responsavel').textContent = responsavel || 'N/A';
    document.getElementById('recebimento_info_saldo').textContent = saldo;
    document.getElementById('recebimento_quantidade').max = saldo;
    document.getElementById('recebimento_quantidade').value = saldo;

    // Data padrão: hoje
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('recebimento_data').value = hoje;

    new bootstrap.Modal(document.getElementById('modalRecebimento')).show();
}

// =============================================
// MODAL SUBSTITUIÇÃO (v2 - autocomplete)
// =============================================
let substOrigemTimeout = null;
let substDestinoTimeout = null;
let substOrigemSelecionado = null;
let substDestinoSelecionado = null;

// Abrir modal LIMPO (botão global)
function openSubstituicaoModalLimpo() {
    resetSubstituicaoModal();
    new bootstrap.Modal(document.getElementById('modalSubstituicao')).show();
}

// Abrir modal PRÉ-SELECIONADO (botão por linha)
function openSubstituicaoModal(creditoId, saldo, nf, responsavel) {
    resetSubstituicaoModal();

    substOrigemSelecionado = {
        credito_id: creditoId,
        saldo: saldo,
        nf: nf,
        responsavel: responsavel
    };

    document.getElementById('substituicao_credito_id').value = creditoId;
    document.getElementById('substituicao_info_nf').textContent = 'NF ' + (nf || 'N/A');
    document.getElementById('substituicao_info_responsavel').textContent = responsavel || 'N/A';
    document.getElementById('substituicao_info_saldo_badge').textContent = saldo + ' pallets';

    document.getElementById('substituicao_origem_busca').style.display = 'none';
    document.getElementById('substituicao_origem_card').style.display = 'block';

    mostrarPassosSubstituicao(saldo);

    new bootstrap.Modal(document.getElementById('modalSubstituicao')).show();
}

function resetSubstituicaoModal() {
    substOrigemSelecionado = null;
    substDestinoSelecionado = null;

    document.getElementById('substituicao_credito_id').value = '';
    document.getElementById('substituicao_nf_destino_id').value = '';
    document.getElementById('substituicao_nf_origem_input').value = '';
    document.getElementById('substituicao_nf_destino_input').value = '';
    document.getElementById('substituicao_quantidade').value = '';
    document.getElementById('substituicao_observacao').value = '';

    document.getElementById('substituicao_origem_busca').style.display = 'block';
    document.getElementById('substituicao_origem_card').style.display = 'none';
    document.getElementById('substituicao_qtd_wrapper').style.display = 'none';
    document.getElementById('substituicao_destino_busca').style.display = 'none';
    document.getElementById('substituicao_destino_card').style.display = 'none';
    document.getElementById('substituicao_obs_wrapper').style.display = 'none';
    document.getElementById('btnConfirmarSubstituicao').disabled = true;

    document.getElementById('listaSubstOrigem').style.display = 'none';
    document.getElementById('listaSubstDestino').style.display = 'none';
}

function mostrarPassosSubstituicao(saldo) {
    document.getElementById('substituicao_qtd_wrapper').style.display = 'block';
    document.getElementById('substituicao_quantidade').max = saldo;
    document.getElementById('substituicao_quantidade').value = saldo;
    document.getElementById('substituicao_max_info').textContent = saldo;
    document.getElementById('substituicao_destino_busca').style.display = 'block';
    document.getElementById('substituicao_obs_wrapper').style.display = 'block';
}

// Autocomplete: NF Origem (busca créditos pendentes)
function buscarNfOrigem(termo) {
    const lista = document.getElementById('listaSubstOrigem');

    if (substOrigemTimeout) clearTimeout(substOrigemTimeout);

    if (termo.trim().length < 2) {
        lista.style.display = 'none';
        return;
    }

    substOrigemTimeout = setTimeout(function() {
        const url = '{{ url_for("pallet_v2.controle_pallets.api_listar_creditos") }}' +
            '?q=' + encodeURIComponent(termo.trim()) + '&status=PENDENTE,PARCIAL&limit=10';

        fetch(url)
            .then(r => r.json())
            .then(data => {
                lista.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(credito => {
                        const div = document.createElement('div');
                        div.className = 'venda-autocomplete-item';
                        div.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>NF ${credito.numero_nf || 'N/A'}</strong>
                                    <br><small class="text-muted">${credito.nome_responsavel || credito.cnpj_responsavel || '-'} (${credito.tipo_responsavel})</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-warning text-dark">${credito.qtd_saldo} plt</span>
                                    <br><small class="text-muted">de ${credito.qtd_original}</small>
                                </div>
                            </div>
                        `;
                        div.addEventListener('click', function() {
                            selecionarOrigemSubstituicao(credito);
                            lista.style.display = 'none';
                        });
                        lista.appendChild(div);
                    });
                    lista.style.display = 'block';
                } else {
                    lista.innerHTML = '<div class="p-2 text-muted text-center small">Nenhum crédito pendente encontrado</div>';
                    lista.style.display = 'block';
                }
            })
            .catch(err => {
                console.error('Erro buscar NF origem:', err);
                lista.style.display = 'none';
            });
    }, 300);
}

function selecionarOrigemSubstituicao(credito) {
    substOrigemSelecionado = {
        credito_id: credito.id,
        saldo: credito.qtd_saldo,
        nf: credito.numero_nf,
        responsavel: credito.nome_responsavel || credito.cnpj_responsavel
    };

    document.getElementById('substituicao_credito_id').value = credito.id;
    document.getElementById('substituicao_info_nf').textContent = 'NF ' + (credito.numero_nf || 'N/A');
    document.getElementById('substituicao_info_responsavel').textContent =
        (credito.nome_responsavel || credito.cnpj_responsavel || '-') + ' (' + credito.tipo_responsavel + ')';
    document.getElementById('substituicao_info_saldo_badge').textContent = credito.qtd_saldo + ' pallets';

    document.getElementById('substituicao_origem_busca').style.display = 'none';
    document.getElementById('substituicao_origem_card').style.display = 'block';

    mostrarPassosSubstituicao(credito.qtd_saldo);
    atualizarBotaoSubstituicao();
}

function limparOrigemSubstituicao() {
    substOrigemSelecionado = null;
    document.getElementById('substituicao_credito_id').value = '';
    document.getElementById('substituicao_nf_origem_input').value = '';
    document.getElementById('substituicao_origem_busca').style.display = 'block';
    document.getElementById('substituicao_origem_card').style.display = 'none';
    document.getElementById('substituicao_qtd_wrapper').style.display = 'none';
    document.getElementById('substituicao_destino_busca').style.display = 'none';
    document.getElementById('substituicao_destino_card').style.display = 'none';
    document.getElementById('substituicao_obs_wrapper').style.display = 'none';
    document.getElementById('btnConfirmarSubstituicao').disabled = true;
}

// Autocomplete: NF Destino (busca NFs de remessa)
function buscarNfDestino(termo) {
    const lista = document.getElementById('listaSubstDestino');

    if (substDestinoTimeout) clearTimeout(substDestinoTimeout);

    if (termo.trim().length < 2) {
        lista.style.display = 'none';
        return;
    }

    substDestinoTimeout = setTimeout(function() {
        const url = '{{ url_for("pallet_v2.nf_remessa.api_buscar") }}' +
            '?q=' + encodeURIComponent(termo.trim()) + '&limit=10';

        fetch(url)
            .then(r => r.json())
            .then(data => {
                lista.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(nf => {
                        const div = document.createElement('div');
                        div.className = 'venda-autocomplete-item';
                        div.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>NF ${nf.numero_nf}</strong>
                                    <br><small class="text-muted">${nf.nome_destinatario || '-'} (${nf.tipo_destinatario || '-'})</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-info text-dark">${nf.quantidade || 0} plt</span>
                                    <br><small class="text-muted">${nf.data_emissao || '-'}</small>
                                </div>
                            </div>
                        `;
                        div.addEventListener('click', function() {
                            selecionarDestinoSubstituicao(nf);
                            lista.style.display = 'none';
                        });
                        lista.appendChild(div);
                    });
                    lista.style.display = 'block';
                } else {
                    lista.innerHTML = '<div class="p-2 text-muted text-center small">Nenhuma NF de remessa encontrada</div>';
                    lista.style.display = 'block';
                }
            })
            .catch(err => {
                console.error('Erro buscar NF destino:', err);
                lista.style.display = 'none';
            });
    }, 300);
}

function selecionarDestinoSubstituicao(nf) {
    substDestinoSelecionado = {
        nf_id: nf.id,
        numero_nf: nf.numero_nf,
        nome: nf.nome_destinatario,
        cnpj: nf.cnpj_destinatario,
        tipo: nf.tipo_destinatario,
        quantidade: nf.quantidade
    };

    document.getElementById('substituicao_nf_destino_id').value = nf.id;
    document.getElementById('substituicao_dest_nf').textContent = 'NF ' + nf.numero_nf;
    document.getElementById('substituicao_dest_responsavel').textContent =
        (nf.nome_destinatario || nf.cnpj_destinatario || '-') + ' (' + (nf.tipo_destinatario || '-') + ')';
    document.getElementById('substituicao_dest_qtd_badge').textContent = (nf.quantidade || 0) + ' pallets';

    document.getElementById('substituicao_destino_busca').style.display = 'none';
    document.getElementById('substituicao_destino_card').style.display = 'block';

    atualizarBotaoSubstituicao();
}

function limparDestinoSubstituicao() {
    substDestinoSelecionado = null;
    document.getElementById('substituicao_nf_destino_id').value = '';
    document.getElementById('substituicao_nf_destino_input').value = '';
    document.getElementById('substituicao_destino_busca').style.display = 'block';
    document.getElementById('substituicao_destino_card').style.display = 'none';
    document.getElementById('btnConfirmarSubstituicao').disabled = true;
}

function atualizarBotaoSubstituicao() {
    const temOrigem = !!substOrigemSelecionado;
    const temDestino = !!substDestinoSelecionado;
    const quantidade = parseInt(document.getElementById('substituicao_quantidade').value) || 0;
    const max = parseInt(document.getElementById('substituicao_quantidade').max) || 0;

    document.getElementById('btnConfirmarSubstituicao').disabled =
        !(temOrigem && temDestino && quantidade > 0 && quantidade <= max);
}

// =============================================
// MODAL DETALHES
// =============================================
function openDetalhesModal(creditoId) {
    const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
    const content = document.getElementById('modalDetalhesContent');

    content.innerHTML = `<div class="text-center py-4">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p class="mt-2">Carregando...</p>
    </div>`;

    modal.show();

    fetch(`{{ url_for('pallet_v2.controle_pallets.api_detalhe_credito', credito_id=0) }}`.replace('/0', '/' + creditoId))
        .then(response => response.json())
        .then(data => {
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Informações do Crédito</h6>
                        <table class="table table-sm">
                            <tr><th>ID</th><td>#${data.credito.id}</td></tr>
                            <tr><th>NF Remessa</th><td>${data.credito.numero_nf || '-'}</td></tr>
                            <tr><th>Tipo</th><td>${data.credito.tipo_responsavel || '-'}</td></tr>
                            <tr><th>Responsável</th><td>${data.credito.nome_responsavel || data.credito.cnpj_responsavel || '-'}</td></tr>
                            <tr><th>Quantidade Original</th><td>${data.credito.qtd_original}</td></tr>
                            <tr><th>Saldo Atual</th><td><strong>${data.credito.qtd_saldo}</strong></td></tr>
                            <tr><th>Status</th><td>${data.credito.status}</td></tr>
                            <tr><th>Prazo</th><td>${data.credito.prazo_dias || '-'} dias</td></tr>
                            <tr><th>Vencimento</th><td>${data.credito.data_vencimento ? new Date(data.credito.data_vencimento).toLocaleDateString('pt-BR') : '-'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Documentos Vinculados</h6>
                        ${data.documentos.length > 0 ? `
                        <ul class="list-group list-group-flush">
                            ${data.documentos.map(d => `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${d.tipo}</strong>
                                        ${d.numero_documento ? ` - ${d.numero_documento}` : ''}
                                        <br><small class="text-muted">${d.quantidade} pallets</small>
                                    </div>
                                    <span class="badge ${d.recebido ? 'bg-success' : 'bg-warning'}">${d.recebido ? 'Recebido' : 'Pendente'}</span>
                                </li>
                            `).join('')}
                        </ul>
                        ` : '<p class="text-muted">Nenhum documento vinculado</p>'}

                        <h6 class="text-muted mb-3 mt-4">Histórico de Soluções</h6>
                        ${data.solucoes.length > 0 ? `
                        <ul class="list-group list-group-flush">
                            ${data.solucoes.map(s => `
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <strong>${s.tipo}</strong>
                                        <span>${s.quantidade} pallets</span>
                                    </div>
                                    <small class="text-muted">${new Date(s.criado_em).toLocaleString('pt-BR')} por ${s.criado_por || '-'}</small>
                                </li>
                            `).join('')}
                        </ul>
                        ` : '<p class="text-muted">Nenhuma solução registrada</p>'}
                    </div>
                </div>
            `;
            content.innerHTML = html;
        })
        .catch(error => {
            console.error('Erro ao carregar detalhes:', error);
            content.innerHTML = `<div class="alert alert-danger">Erro ao carregar detalhes do crédito.</div>`;
        });
}

// =============================================
// MÁSCARAS E VALIDAÇÕES
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    // Máscara de CNPJ
    const cnpjInputs = document.querySelectorAll('#venda_cnpj');
    cnpjInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 14) value = value.slice(0, 14);

            if (value.length > 12) {
                value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
            } else if (value.length > 8) {
                value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d+)$/, '$1.$2.$3/$4');
            } else if (value.length > 5) {
                value = value.replace(/^(\d{2})(\d{3})(\d+)$/, '$1.$2.$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d+)$/, '$1.$2');
            }

            e.target.value = value;
        });
    });

    // Máscara de valor monetário
    const valorInput = document.getElementById('venda_valor');
    if (valorInput) {
        valorInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = (parseInt(value) / 100).toFixed(2);
            value = value.replace('.', ',');
            e.target.value = value;
        });
        // Recalcular totais ao mudar valor unitario
        valorInput.addEventListener('change', recalcularTotaisVenda);
    }

    // Data padrão para recebimento
    const dataRecebimento = document.getElementById('recebimento_data');
    if (dataRecebimento && !dataRecebimento.value) {
        dataRecebimento.value = new Date().toISOString().split('T')[0];
    }

    // Data padrão para venda
    const dataVenda = document.getElementById('venda_data');
    if (dataVenda && !dataVenda.value) {
        dataVenda.value = new Date().toISOString().split('T')[0];
    }

    // Autocomplete: NF de Venda (topo do modal)
    const vendaNfInput = document.getElementById('venda_nf');
    if (vendaNfInput) {
        vendaNfInput.addEventListener('input', function() {
            buscarNfVenda(this.value);
        });
    }

    // Autocomplete: NF Origem para Substituição
    const substOrigemInput = document.getElementById('substituicao_nf_origem_input');
    if (substOrigemInput) {
        substOrigemInput.addEventListener('input', function() {
            buscarNfOrigem(this.value);
        });
    }

    // Autocomplete: NF Destino para Substituição
    const substDestinoInput = document.getElementById('substituicao_nf_destino_input');
    if (substDestinoInput) {
        substDestinoInput.addEventListener('input', function() {
            buscarNfDestino(this.value);
        });
    }

    // Quantidade de Substituição: validar ao mudar
    const substQtdInput = document.getElementById('substituicao_quantidade');
    if (substQtdInput) {
        substQtdInput.addEventListener('input', atualizarBotaoSubstituicao);
    }

    // Validação do form de Substituição no submit
    const formSubstituicao = document.getElementById('formSubstituicao');
    if (formSubstituicao) {
        formSubstituicao.addEventListener('submit', function(e) {
            if (!substOrigemSelecionado || !substDestinoSelecionado) {
                e.preventDefault();
                alert('Selecione a NF de origem e a NF de destino.');
                return false;
            }
            const quantidade = parseInt(document.getElementById('substituicao_quantidade').value) || 0;
            if (quantidade <= 0 || quantidade > substOrigemSelecionado.saldo) {
                e.preventDefault();
                alert('Quantidade inválida. Máximo: ' + substOrigemSelecionado.saldo + ' pallets.');
                return false;
            }
        });
    }

    // Fechar dropdowns de autocomplete ao clicar fora
    document.addEventListener('click', function(e) {
        document.querySelectorAll('.venda-autocomplete-dropdown').forEach(function(dropdown) {
            const wrapper = dropdown.parentElement;
            if (wrapper && !wrapper.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}
