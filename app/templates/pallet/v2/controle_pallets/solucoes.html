{% extends 'base.html' %}

{% block title %}Soluções de Pallet | Controle de Pallets v2{% endblock %}

{% block extra_css %}
<style>
/* ============================================
   SOLUÇÕES DE PALLET - Controle de Pallets v2
   ============================================ */

.pallet-solucoes {
    padding: 1.5rem;
    background-color: #f8f9fa;
    min-height: calc(100vh - 60px);
}

/* Header */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.page-header h1 {
    font-size: 1.75rem;
    font-weight: 600;
    color: #212529;
    margin: 0;
}

.page-header h1 i {
    color: #198754;
    margin-right: 0.5rem;
}

/* Breadcrumb */
.breadcrumb-nav {
    margin-bottom: 1rem;
}

.breadcrumb-nav .breadcrumb {
    background: transparent;
    padding: 0;
    margin: 0;
    font-size: 0.875rem;
}

.breadcrumb-nav .breadcrumb-item a {
    color: #6c757d;
    text-decoration: none;
}

.breadcrumb-nav .breadcrumb-item a:hover {
    color: #198754;
}

.breadcrumb-nav .breadcrumb-item.active {
    color: #212529;
}

/* Stats Cards */
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.stat-icon.pendente { background: #fff3cd; color: #ffc107; }
.stat-icon.parcial { background: #cff4fc; color: #0dcaf0; }
.stat-icon.resolvido { background: #d1e7dd; color: #198754; }
.stat-icon.total { background: #e8f4fd; color: #0d6efd; }

.stat-content h4 {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
    color: #212529;
}

.stat-content span {
    font-size: 0.875rem;
    color: #6c757d;
}

.stat-saldo {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

/* Filtros */
.filter-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
}

.filter-card .filter-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 1rem;
}

.filter-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: flex-end;
}

.filter-group {
    flex: 1;
    min-width: 180px;
}

.filter-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #495057;
    margin-bottom: 0.5rem;
}

.filter-group select,
.filter-group input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    font-size: 0.875rem;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.filter-group select:focus,
.filter-group input:focus {
    border-color: #198754;
    box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.15);
    outline: none;
}

.filter-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-filter {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-filter-primary {
    background: #198754;
    color: white;
    border: none;
}

.btn-filter-primary:hover {
    background: #157347;
    color: white;
}

.btn-filter-secondary {
    background: #f8f9fa;
    color: #495057;
    border: 1px solid #dee2e6;
}

.btn-filter-secondary:hover {
    background: #e9ecef;
}

/* Tabela de Créditos */
.table-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
}

.table-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.table-header h3 {
    font-size: 1rem;
    font-weight: 600;
    color: #212529;
    margin: 0;
}

.table-header .badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
}

.table-responsive {
    max-height: calc(100vh - 450px);
    overflow-y: auto;
}

.table-creditos {
    margin: 0;
    width: 100%;
}

.table-creditos thead th {
    background: #f8f9fa;
    font-size: 0.75rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0.75rem 1rem;
    border-bottom: 2px solid #e9ecef;
    position: sticky;
    top: 0;
    z-index: 10;
}

.table-creditos tbody td {
    padding: 0.75rem 1rem;
    vertical-align: middle;
    font-size: 0.875rem;
    border-bottom: 1px solid #f1f3f4;
}

.table-creditos tbody tr:hover {
    background-color: #f8f9fa;
}

/* Badges de status */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-badge.pendente {
    background: #fff3cd;
    color: #856404;
}

.status-badge.parcial {
    background: #cff4fc;
    color: #055160;
}

.status-badge.resolvido {
    background: #d4edda;
    color: #155724;
}

.status-badge.vencido {
    background: #f8d7da;
    color: #721c24;
}

.status-badge.a-vencer {
    background: #ffe5d0;
    color: #7c4a03;
}

/* Tipo de responsável badge */
.tipo-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
}

.tipo-badge.transportadora {
    background: #e8f4fd;
    color: #0d6efd;
}

.tipo-badge.cliente {
    background: #d1e7dd;
    color: #198754;
}

/* Célula de responsável */
.responsavel-cell {
    max-width: 200px;
}

.responsavel-nome {
    font-weight: 500;
    color: #212529;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
}

.responsavel-cnpj {
    font-size: 0.75rem;
    color: #6c757d;
    font-family: 'Monaco', 'Consolas', monospace;
}

/* Célula de saldo */
.saldo-cell {
    text-align: center;
}

.saldo-value {
    font-size: 1.25rem;
    font-weight: 700;
}

.saldo-original {
    font-size: 0.75rem;
    color: #6c757d;
}

/* Botões de ação */
.action-buttons {
    display: flex;
    gap: 0.35rem;
    flex-wrap: wrap;
}

.btn-action {
    padding: 0.35rem 0.65rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.btn-baixa {
    background: #f8d7da;
    color: #721c24;
}

.btn-baixa:hover {
    background: #f5c6cb;
}

.btn-venda {
    background: #d4edda;
    color: #155724;
}

.btn-venda:hover {
    background: #c3e6cb;
}

.btn-recebimento {
    background: #d1ecf1;
    color: #0c5460;
}

.btn-recebimento:hover {
    background: #bee5eb;
}

.btn-substituicao {
    background: #e2e3e5;
    color: #383d41;
}

.btn-substituicao:hover {
    background: #d6d8db;
}

.btn-detalhes {
    background: #e9ecef;
    color: #495057;
}

.btn-detalhes:hover {
    background: #dee2e6;
}

/* Vencimento highlight */
.vencimento-cell {
    font-weight: 500;
}

.vencimento-cell.vencido {
    color: #dc3545;
}

.vencimento-cell.a-vencer {
    color: #fd7e14;
}

.vencimento-cell.ok {
    color: #198754;
}

/* Empty state */
.empty-state {
    padding: 3rem;
    text-align: center;
}

.empty-state i {
    font-size: 3rem;
    color: #dee2e6;
    margin-bottom: 1rem;
}

.empty-state h4 {
    color: #6c757d;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.empty-state p {
    color: #adb5bd;
    margin: 0;
}

/* Paginação */
.pagination-wrapper {
    padding: 1rem 1.25rem;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.pagination-info {
    font-size: 0.875rem;
    color: #6c757d;
}

.pagination {
    margin: 0;
}

.pagination .page-link {
    border-radius: 6px;
    margin: 0 0.15rem;
    border: none;
    color: #495057;
    font-size: 0.875rem;
}

.pagination .page-link:hover {
    background: #e9ecef;
}

.pagination .page-item.active .page-link {
    background: #198754;
    color: white;
}

/* Botão de ação principal */
.btn-primary-action {
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
    color: white;
    border: none;
    padding: 0.625rem 1.25rem;
    border-radius: 10px;
    font-weight: 500;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(25, 135, 84, 0.25);
}

.btn-primary-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.35);
    color: white;
}

/* Modal */
.modal-header {
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
    color: white;
    border-radius: 12px 12px 0 0;
}

.modal-header .btn-close {
    filter: brightness(0) invert(1);
}

.modal-content {
    border-radius: 12px;
    border: none;
}

.modal-footer {
    border-top: 1px solid #e9ecef;
}

/* Modal header variants */
.modal-header.modal-baixa {
    background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
}

.modal-header.modal-venda {
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
}

.modal-header.modal-recebimento {
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
}

.modal-header.modal-substituicao {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
}

/* Info card no modal */
.info-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.info-card h6 {
    color: #6c757d;
    font-size: 0.75rem;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
}

.info-card .info-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: #212529;
}

.info-card .info-detail {
    font-size: 0.875rem;
    color: #6c757d;
}

/* Checkbox selection for batch operations */
.select-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* Batch action bar */
.batch-action-bar {
    background: #212529;
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: none;
    align-items: center;
    justify-content: space-between;
}

.batch-action-bar.show {
    display: flex;
}

.batch-count {
    font-weight: 600;
}

.batch-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-batch {
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
}
</style>
{% endblock %}

{% block content %}
<div class="pallet-solucoes">
    <!-- Breadcrumb -->
    <nav class="breadcrumb-nav" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('pallet_v2.dashboard.index') }}">
                    <i class="fas fa-pallet"></i> Gestão de Pallets
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Soluções de Pallets</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="page-header">
        <h1><i class="fas fa-tasks"></i> Soluções de Pallets</h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('pallet_v2.controle_pallets.historico_solucoes') }}" class="btn btn-outline-secondary">
                <i class="fas fa-history"></i> Histórico
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-icon pendente">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="stat-content">
                <h4>{{ stats.pendentes }}</h4>
                <span>Pendentes</span>
                <div class="stat-saldo">{{ stats.pendentes_saldo }} pallets</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon parcial">
                <i class="fas fa-tasks"></i>
            </div>
            <div class="stat-content">
                <h4>{{ stats.parciais }}</h4>
                <span>Parciais</span>
                <div class="stat-saldo">{{ stats.parciais_saldo }} pallets</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon resolvido">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <h4>{{ stats.resolvidos }}</h4>
                <span>Resolvidos</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon total">
                <i class="fas fa-coins"></i>
            </div>
            <div class="stat-content">
                <h4>{{ stats.pendentes_saldo + stats.parciais_saldo }}</h4>
                <span>Total Saldo em Aberto</span>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-card">
        <div class="filter-title">
            <i class="fas fa-filter"></i> Filtros
        </div>
        <form method="GET" action="{{ url_for('pallet_v2.controle_pallets.listar_solucoes') }}">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="status">Status do Crédito</label>
                    <select name="status" id="status" class="form-select">
                        <option value="">Pendentes e Parciais</option>
                        <option value="PENDENTE" {% if filtro_status == 'PENDENTE' %}selected{% endif %}>Apenas Pendentes</option>
                        <option value="PARCIAL" {% if filtro_status == 'PARCIAL' %}selected{% endif %}>Apenas Parciais</option>
                        <option value="RESOLVIDO" {% if filtro_status == 'RESOLVIDO' %}selected{% endif %}>Resolvidos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="tipo_responsavel">Tipo de Responsável</label>
                    <select name="tipo_responsavel" id="tipo_responsavel" class="form-select">
                        <option value="">Todos</option>
                        <option value="TRANSPORTADORA" {% if filtro_tipo_responsavel == 'TRANSPORTADORA' %}selected{% endif %}>Transportadora</option>
                        <option value="CLIENTE" {% if filtro_tipo_responsavel == 'CLIENTE' %}selected{% endif %}>Cliente</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="cnpj">CNPJ/Nome do Responsável</label>
                    <input type="text"
                           name="cnpj"
                           id="cnpj"
                           class="form-control"
                           placeholder="Buscar por CNPJ ou nome..."
                           value="{{ filtro_cnpj or '' }}">
                </div>
                <div class="filter-actions">
                    <button type="submit" class="btn btn-filter btn-filter-primary">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                    <a href="{{ url_for('pallet_v2.controle_pallets.listar_solucoes') }}" class="btn btn-filter btn-filter-secondary">
                        <i class="fas fa-times"></i> Limpar
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Barra de ações em lote -->
    <div class="batch-action-bar" id="batchActionBar">
        <div>
            <span class="batch-count" id="batchCount">0</span> créditos selecionados
        </div>
        <div class="batch-actions">
            <button type="button" class="btn-batch btn-venda" onclick="openVendaLoteModal()">
                <i class="fas fa-dollar-sign"></i> Registrar Venda
            </button>
            <button type="button" class="btn-batch btn btn-secondary btn-sm" onclick="limparSelecao()">
                <i class="fas fa-times"></i> Cancelar
            </button>
        </div>
    </div>

    <!-- Tabela de Créditos -->
    <div class="table-card">
        <div class="table-header">
            <h3>
                <i class="fas fa-list"></i> Créditos de Pallets
            </h3>
            <span class="badge bg-secondary">{{ creditos.total }} registro(s)</span>
        </div>

        {% if creditos.items %}
        <div class="table-responsive">
            <table class="table table-creditos">
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" class="select-checkbox" id="selectAll" onclick="toggleSelectAll(this)">
                        </th>
                        <th>ID</th>
                        <th>NF Remessa</th>
                        <th>Tipo</th>
                        <th>Responsável</th>
                        <th class="text-center">Saldo</th>
                        <th>Vencimento</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for credito in creditos.items %}
                    <tr data-credito-id="{{ credito.id }}" data-credito-saldo="{{ credito.qtd_saldo }}">
                        <td>
                            <input type="checkbox"
                                   class="select-checkbox credito-checkbox"
                                   data-id="{{ credito.id }}"
                                   data-saldo="{{ credito.qtd_saldo }}"
                                   data-nf="{{ credito.nf_remessa.numero_nf if credito.nf_remessa else 'N/A' }}"
                                   data-responsavel="{{ credito.nome_responsavel or credito.cnpj_responsavel }}"
                                   onclick="updateBatchSelection()">
                        </td>
                        <td><strong>#{{ credito.id }}</strong></td>
                        <td>
                            {% if credito.nf_remessa %}
                            <a href="{{ url_for('pallet_v2.nf_remessa.detalhe', nf_id=credito.nf_remessa.id) }}" class="text-decoration-none">
                                <strong>{{ credito.nf_remessa.numero_nf }}</strong>
                            </a>
                            {% if credito.nf_remessa.serie %}
                            <small class="text-muted">/{{ credito.nf_remessa.serie }}</small>
                            {% endif %}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if credito.tipo_responsavel == 'TRANSPORTADORA' %}
                            <span class="tipo-badge transportadora">
                                <i class="fas fa-truck"></i> Transp.
                            </span>
                            {% else %}
                            <span class="tipo-badge cliente">
                                <i class="fas fa-user"></i> Cliente
                            </span>
                            {% endif %}
                        </td>
                        <td class="responsavel-cell">
                            <span class="responsavel-nome" title="{{ credito.nome_responsavel or 'N/A' }}">
                                {{ credito.nome_responsavel or 'N/A' }}
                            </span>
                            {% if credito.cnpj_responsavel %}
                            <span class="responsavel-cnpj">{{ credito.cnpj_responsavel }}</span>
                            {% endif %}
                        </td>
                        <td class="saldo-cell">
                            <div class="saldo-value
                                {% if credito.qtd_saldo == credito.qtd_original %}text-warning
                                {% elif credito.qtd_saldo == 0 %}text-success
                                {% else %}text-info{% endif %}">
                                {{ credito.qtd_saldo }}
                            </div>
                            <div class="saldo-original">de {{ credito.qtd_original }}</div>
                        </td>
                        <td class="vencimento-cell
                            {% if credito.vencido %}vencido
                            {% elif credito.prestes_a_vencer %}a-vencer
                            {% else %}ok{% endif %}">
                            {% if credito.data_vencimento %}
                            {{ credito.data_vencimento.strftime('%d/%m/%Y') }}
                            {% if credito.dias_para_vencer is not none %}
                                {% if credito.dias_para_vencer < 0 %}
                                <br><small class="text-danger">({{ credito.dias_para_vencer|abs }} dias atrás)</small>
                                {% elif credito.dias_para_vencer == 0 %}
                                <br><small class="text-warning">(Hoje)</small>
                                {% elif credito.dias_para_vencer <= 7 %}
                                <br><small class="text-warning">({{ credito.dias_para_vencer }} dias)</small>
                                {% endif %}
                            {% endif %}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if credito.vencido %}
                            <span class="status-badge vencido">
                                <i class="fas fa-exclamation-circle"></i> Vencido
                            </span>
                            {% elif credito.status == 'PENDENTE' %}
                            <span class="status-badge pendente">
                                <i class="fas fa-hourglass-half"></i> Pendente
                            </span>
                            {% elif credito.status == 'PARCIAL' %}
                            <span class="status-badge parcial">
                                <i class="fas fa-tasks"></i> Parcial
                            </span>
                            {% elif credito.status == 'RESOLVIDO' %}
                            <span class="status-badge resolvido">
                                <i class="fas fa-check"></i> Resolvido
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                {% if credito.status != 'RESOLVIDO' %}
                                <button type="button" class="btn-action btn-baixa" title="Registrar Baixa"
                                        onclick="openBaixaModal({{ credito.id }}, {{ credito.qtd_saldo }}, '{{ credito.nf_remessa.numero_nf if credito.nf_remessa else '' }}', '{{ credito.nome_responsavel or credito.cnpj_responsavel or '' }}')">
                                    <i class="fas fa-minus-circle"></i>
                                </button>
                                <button type="button" class="btn-action btn-venda" title="Registrar Venda"
                                        onclick="openVendaModal({{ credito.id }}, {{ credito.qtd_saldo }}, '{{ credito.nf_remessa.numero_nf if credito.nf_remessa else '' }}', '{{ credito.nome_responsavel or credito.cnpj_responsavel or '' }}')">
                                    <i class="fas fa-dollar-sign"></i>
                                </button>
                                <button type="button" class="btn-action btn-recebimento" title="Registrar Recebimento"
                                        onclick="openRecebimentoModal({{ credito.id }}, {{ credito.qtd_saldo }}, '{{ credito.nf_remessa.numero_nf if credito.nf_remessa else '' }}', '{{ credito.nome_responsavel or credito.cnpj_responsavel or '' }}')">
                                    <i class="fas fa-box"></i>
                                </button>
                                <button type="button" class="btn-action btn-substituicao" title="Substituição de Responsabilidade"
                                        onclick="openSubstituicaoModal({{ credito.id }}, {{ credito.qtd_saldo }}, '{{ credito.nf_remessa.numero_nf if credito.nf_remessa else '' }}', '{{ credito.nome_responsavel or credito.cnpj_responsavel or '' }}')">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                {% endif %}
                                <button type="button" class="btn-action btn-detalhes" title="Ver Detalhes"
                                        onclick="openDetalhesModal({{ credito.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Paginação -->
        <div class="pagination-wrapper">
            <div class="pagination-info">
                Mostrando {{ ((creditos.page - 1) * creditos.per_page) + 1 }} -
                {{ [creditos.page * creditos.per_page, creditos.total]|min }}
                de {{ creditos.total }} registros
            </div>

            {% if creditos.pages > 1 %}
            <nav aria-label="Paginação">
                <ul class="pagination">
                    {% if creditos.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('pallet_v2.controle_pallets.listar_solucoes', page=creditos.prev_num, status=filtro_status, tipo_responsavel=filtro_tipo_responsavel, cnpj=filtro_cnpj) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for page_num in creditos.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if page_num %}
                            {% if page_num == creditos.page %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('pallet_v2.controle_pallets.listar_solucoes', page=page_num, status=filtro_status, tipo_responsavel=filtro_tipo_responsavel, cnpj=filtro_cnpj) }}">{{ page_num }}</a>
                            </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if creditos.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('pallet_v2.controle_pallets.listar_solucoes', page=creditos.next_num, status=filtro_status, tipo_responsavel=filtro_tipo_responsavel, cnpj=filtro_cnpj) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>

        {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <i class="fas fa-coins"></i>
            <h4>Nenhum crédito encontrado</h4>
            <p>Ajuste os filtros ou aguarde novas NFs de remessa</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- =============================================
     MODAL: REGISTRAR BAIXA
     ============================================= -->
<div class="modal fade" id="modalBaixa" tabindex="-1" aria-labelledby="modalBaixaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header modal-baixa">
                <h5 class="modal-title" id="modalBaixaLabel">
                    <i class="fas fa-minus-circle"></i> Registrar Baixa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{{ url_for('pallet_v2.controle_pallets.registrar_baixa') }}">
                <div class="modal-body">
                    <input type="hidden" name="credito_id" id="baixa_credito_id">

                    <!-- Info do crédito -->
                    <div class="info-card">
                        <h6>Crédito Selecionado</h6>
                        <div class="info-value" id="baixa_info_nf">-</div>
                        <div class="info-detail" id="baixa_info_responsavel">-</div>
                        <div class="info-detail">Saldo disponível: <strong id="baixa_info_saldo">-</strong> pallets</div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="baixa_quantidade" class="form-label">Quantidade <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="baixa_quantidade" name="quantidade" min="1" required>
                            <small class="text-muted">Quantidade de pallets a dar baixa</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Confirmação do Cliente</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="confirmado_cliente" name="confirmado_cliente">
                                <label class="form-check-label" for="confirmado_cliente">
                                    Cliente confirmou descarte
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="baixa_motivo" class="form-label">Motivo da Baixa <span class="text-danger">*</span></label>
                            <select class="form-select" id="baixa_motivo" name="motivo" required>
                                <option value="">Selecione...</option>
                                <option value="DESCARTAVEL">Pallet descartável (acordado com cliente)</option>
                                <option value="DANIFICADO">Pallet danificado</option>
                                <option value="PERDIDO">Pallet perdido</option>
                                <option value="ACORDO_COMERCIAL">Acordo comercial</option>
                                <option value="OUTRO">Outro motivo</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="baixa_observacao" class="form-label">Observações</label>
                            <textarea class="form-control" id="baixa_observacao" name="observacao" rows="2" placeholder="Detalhes adicionais..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-minus-circle"></i> Confirmar Baixa
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =============================================
     MODAL: REGISTRAR VENDA
     ============================================= -->
<div class="modal fade" id="modalVenda" tabindex="-1" aria-labelledby="modalVendaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-venda">
                <h5 class="modal-title" id="modalVendaLabel">
                    <i class="fas fa-dollar-sign"></i> Registrar Venda de Pallets
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{{ url_for('pallet_v2.controle_pallets.registrar_venda') }}" id="formVenda">
                <div class="modal-body">
                    <input type="hidden" name="creditos" id="venda_creditos_json">

                    <!-- Info dos créditos selecionados -->
                    <div class="info-card">
                        <h6>Créditos para Venda</h6>
                        <div id="venda_creditos_lista">
                            <!-- Preenchido via JS -->
                        </div>
                        <div class="mt-2">
                            Total: <strong id="venda_total_pallets">0</strong> pallets
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="venda_nf" class="form-label">Número da NF de Venda <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="venda_nf" name="nf_venda" required placeholder="Ex: 123456">
                        </div>
                        <div class="col-md-6">
                            <label for="venda_data" class="form-label">Data da Venda</label>
                            <input type="date" class="form-control" id="venda_data" name="data_venda" value="{{ now().strftime('%Y-%m-%d') if now is defined else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="venda_valor" class="form-label">Valor Unitário (R$)</label>
                            <input type="text" class="form-control" id="venda_valor" name="valor_unitario" value="35,00" placeholder="35,00">
                        </div>
                        <div class="col-md-6">
                            <label for="venda_chave" class="form-label">Chave NFe</label>
                            <input type="text" class="form-control" id="venda_chave" name="chave_nfe" maxlength="44" placeholder="44 dígitos">
                        </div>
                        <div class="col-md-6">
                            <label for="venda_cnpj" class="form-label">CNPJ do Comprador</label>
                            <input type="text" class="form-control" id="venda_cnpj" name="cnpj_comprador" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="col-md-6">
                            <label for="venda_nome" class="form-label">Nome do Comprador</label>
                            <input type="text" class="form-control" id="venda_nome" name="nome_comprador" placeholder="Razão Social">
                        </div>
                        <div class="col-12">
                            <label for="venda_observacao" class="form-label">Observações</label>
                            <textarea class="form-control" id="venda_observacao" name="observacao" rows="2" placeholder="Observações adicionais..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-dollar-sign"></i> Confirmar Venda
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =============================================
     MODAL: REGISTRAR RECEBIMENTO
     ============================================= -->
<div class="modal fade" id="modalRecebimento" tabindex="-1" aria-labelledby="modalRecebimentoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header modal-recebimento">
                <h5 class="modal-title" id="modalRecebimentoLabel">
                    <i class="fas fa-box"></i> Registrar Recebimento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{{ url_for('pallet_v2.controle_pallets.registrar_recebimento') }}">
                <div class="modal-body">
                    <input type="hidden" name="credito_id" id="recebimento_credito_id">

                    <!-- Info do crédito -->
                    <div class="info-card">
                        <h6>Crédito Selecionado</h6>
                        <div class="info-value" id="recebimento_info_nf">-</div>
                        <div class="info-detail" id="recebimento_info_responsavel">-</div>
                        <div class="info-detail">Saldo disponível: <strong id="recebimento_info_saldo">-</strong> pallets</div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="recebimento_quantidade" class="form-label">Quantidade Recebida <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="recebimento_quantidade" name="quantidade" min="1" required>
                        </div>
                        <div class="col-md-6">
                            <label for="recebimento_data" class="form-label">Data do Recebimento</label>
                            <input type="date" class="form-control" id="recebimento_data" name="data_recebimento">
                        </div>
                        <div class="col-12">
                            <label for="recebimento_local" class="form-label">Local do Recebimento</label>
                            <input type="text" class="form-control" id="recebimento_local" name="local_recebimento" placeholder="Ex: CD Goiânia, Coleta na obra, etc.">
                        </div>
                        <div class="col-12">
                            <label for="recebimento_observacao" class="form-label">Observações</label>
                            <textarea class="form-control" id="recebimento_observacao" name="observacao" rows="2" placeholder="Detalhes do recebimento..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-box"></i> Confirmar Recebimento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =============================================
     MODAL: SUBSTITUIÇÃO DE RESPONSABILIDADE
     ============================================= -->
<div class="modal fade" id="modalSubstituicao" tabindex="-1" aria-labelledby="modalSubstituicaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-substituicao">
                <h5 class="modal-title" id="modalSubstituicaoLabel">
                    <i class="fas fa-exchange-alt"></i> Substituição de Responsabilidade
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{{ url_for('pallet_v2.controle_pallets.registrar_substituicao') }}">
                <div class="modal-body">
                    <input type="hidden" name="credito_origem_id" id="substituicao_credito_id">

                    <!-- Info do crédito de origem -->
                    <div class="info-card">
                        <h6>Crédito de Origem</h6>
                        <div class="info-value" id="substituicao_info_nf">-</div>
                        <div class="info-detail" id="substituicao_info_responsavel">-</div>
                        <div class="info-detail">Saldo disponível: <strong id="substituicao_info_saldo">-</strong> pallets</div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        A substituição transfere a responsabilidade dos pallets de um devedor para outro.
                        O saldo do crédito de origem será reduzido e um novo crédito será criado ou incrementado no destino.
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="substituicao_quantidade" class="form-label">Quantidade a Transferir <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="substituicao_quantidade" name="quantidade" min="1" required>
                        </div>
                        <div class="col-md-6">
                            <label for="substituicao_tipo_destino" class="form-label">Tipo do Novo Responsável <span class="text-danger">*</span></label>
                            <select class="form-select" id="substituicao_tipo_destino" name="tipo_responsavel_destino" required>
                                <option value="">Selecione...</option>
                                <option value="TRANSPORTADORA">Transportadora</option>
                                <option value="CLIENTE">Cliente</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="substituicao_cnpj_destino" class="form-label">CNPJ do Novo Responsável <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="substituicao_cnpj_destino" name="cnpj_destino" required placeholder="00.000.000/0000-00">
                        </div>
                        <div class="col-md-6">
                            <label for="substituicao_nome_destino" class="form-label">Nome do Novo Responsável</label>
                            <input type="text" class="form-control" id="substituicao_nome_destino" name="nome_destino" placeholder="Razão Social">
                        </div>
                        <div class="col-12">
                            <label for="substituicao_nf_destino" class="form-label">NF de Remessa Destino (opcional)</label>
                            <select class="form-select" id="substituicao_nf_destino" name="nf_remessa_destino_id">
                                <option value="">Criar novo crédito</option>
                                <!-- Será preenchido via JS se necessário -->
                            </select>
                            <small class="text-muted">Deixe vazio para criar um novo crédito para o novo responsável</small>
                        </div>
                        <div class="col-12">
                            <label for="substituicao_observacao" class="form-label">Observações</label>
                            <textarea class="form-control" id="substituicao_observacao" name="observacao" rows="2" placeholder="Motivo da substituição..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-secondary">
                        <i class="fas fa-exchange-alt"></i> Confirmar Substituição
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =============================================
     MODAL: DETALHES DO CRÉDITO
     ============================================= -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalhesLabel">
                    <i class="fas fa-info-circle"></i> Detalhes do Crédito
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="modalDetalhesContent">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// =============================================
// SELEÇÃO EM LOTE
// =============================================
let creditosSelecionados = [];

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.credito-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateBatchSelection();
}

function updateBatchSelection() {
    creditosSelecionados = [];
    const checkboxes = document.querySelectorAll('.credito-checkbox:checked');

    checkboxes.forEach(cb => {
        creditosSelecionados.push({
            id: parseInt(cb.dataset.id),
            saldo: parseInt(cb.dataset.saldo),
            nf: cb.dataset.nf,
            responsavel: cb.dataset.responsavel
        });
    });

    const batchBar = document.getElementById('batchActionBar');
    const batchCount = document.getElementById('batchCount');

    if (creditosSelecionados.length > 0) {
        batchBar.classList.add('show');
        batchCount.textContent = creditosSelecionados.length;
    } else {
        batchBar.classList.remove('show');
    }

    // Atualizar checkbox "Selecionar todos"
    const selectAll = document.getElementById('selectAll');
    const totalCheckboxes = document.querySelectorAll('.credito-checkbox').length;
    selectAll.checked = checkboxes.length === totalCheckboxes && totalCheckboxes > 0;
    selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < totalCheckboxes;
}

function limparSelecao() {
    document.querySelectorAll('.credito-checkbox, #selectAll').forEach(cb => {
        cb.checked = false;
    });
    updateBatchSelection();
}

// =============================================
// MODAL BAIXA
// =============================================
function openBaixaModal(creditoId, saldo, nf, responsavel) {
    document.getElementById('baixa_credito_id').value = creditoId;
    document.getElementById('baixa_info_nf').textContent = 'NF ' + (nf || 'N/A');
    document.getElementById('baixa_info_responsavel').textContent = responsavel || 'N/A';
    document.getElementById('baixa_info_saldo').textContent = saldo;
    document.getElementById('baixa_quantidade').max = saldo;
    document.getElementById('baixa_quantidade').value = saldo;

    new bootstrap.Modal(document.getElementById('modalBaixa')).show();
}

// =============================================
// MODAL VENDA (individual)
// =============================================
function openVendaModal(creditoId, saldo, nf, responsavel) {
    // Configurar como venda individual
    creditosSelecionados = [{
        id: creditoId,
        saldo: saldo,
        nf: nf,
        responsavel: responsavel
    }];

    atualizarModalVenda();
    new bootstrap.Modal(document.getElementById('modalVenda')).show();
}

// MODAL VENDA (lote)
function openVendaLoteModal() {
    if (creditosSelecionados.length === 0) {
        alert('Selecione pelo menos um crédito para a venda.');
        return;
    }

    atualizarModalVenda();
    new bootstrap.Modal(document.getElementById('modalVenda')).show();
}

function atualizarModalVenda() {
    const listaDiv = document.getElementById('venda_creditos_lista');
    let html = '<ul class="list-unstyled mb-0">';
    let totalPallets = 0;

    const creditos = [];

    creditosSelecionados.forEach(c => {
        html += `<li class="d-flex justify-content-between align-items-center mb-1">
            <span>NF ${c.nf} - ${c.responsavel}</span>
            <input type="number" class="form-control form-control-sm ms-2" style="width: 80px;"
                   id="venda_qtd_${c.id}" value="${c.saldo}" min="1" max="${c.saldo}"
                   onchange="atualizarTotalVenda()">
        </li>`;
        totalPallets += c.saldo;
        creditos.push({ credito_id: c.id, quantidade: c.saldo });
    });

    html += '</ul>';
    listaDiv.innerHTML = html;
    document.getElementById('venda_total_pallets').textContent = totalPallets;
    document.getElementById('venda_creditos_json').value = JSON.stringify(creditos);
}

function atualizarTotalVenda() {
    let total = 0;
    const creditos = [];

    creditosSelecionados.forEach(c => {
        const input = document.getElementById('venda_qtd_' + c.id);
        const qtd = parseInt(input.value) || 0;
        total += qtd;
        creditos.push({ credito_id: c.id, quantidade: qtd });
    });

    document.getElementById('venda_total_pallets').textContent = total;
    document.getElementById('venda_creditos_json').value = JSON.stringify(creditos);
}

// =============================================
// MODAL RECEBIMENTO
// =============================================
function openRecebimentoModal(creditoId, saldo, nf, responsavel) {
    document.getElementById('recebimento_credito_id').value = creditoId;
    document.getElementById('recebimento_info_nf').textContent = 'NF ' + (nf || 'N/A');
    document.getElementById('recebimento_info_responsavel').textContent = responsavel || 'N/A';
    document.getElementById('recebimento_info_saldo').textContent = saldo;
    document.getElementById('recebimento_quantidade').max = saldo;
    document.getElementById('recebimento_quantidade').value = saldo;

    // Data padrão: hoje
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('recebimento_data').value = hoje;

    new bootstrap.Modal(document.getElementById('modalRecebimento')).show();
}

// =============================================
// MODAL SUBSTITUIÇÃO
// =============================================
function openSubstituicaoModal(creditoId, saldo, nf, responsavel) {
    document.getElementById('substituicao_credito_id').value = creditoId;
    document.getElementById('substituicao_info_nf').textContent = 'NF ' + (nf || 'N/A');
    document.getElementById('substituicao_info_responsavel').textContent = responsavel || 'N/A';
    document.getElementById('substituicao_info_saldo').textContent = saldo;
    document.getElementById('substituicao_quantidade').max = saldo;
    document.getElementById('substituicao_quantidade').value = saldo;

    new bootstrap.Modal(document.getElementById('modalSubstituicao')).show();
}

// =============================================
// MODAL DETALHES
// =============================================
function openDetalhesModal(creditoId) {
    const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
    const content = document.getElementById('modalDetalhesContent');

    content.innerHTML = `<div class="text-center py-4">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p class="mt-2">Carregando...</p>
    </div>`;

    modal.show();

    fetch(`{{ url_for('pallet_v2.controle_pallets.api_detalhe_credito', credito_id=0) }}`.replace('/0', '/' + creditoId))
        .then(response => response.json())
        .then(data => {
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Informações do Crédito</h6>
                        <table class="table table-sm">
                            <tr><th>ID</th><td>#${data.credito.id}</td></tr>
                            <tr><th>NF Remessa</th><td>${data.credito.numero_nf || '-'}</td></tr>
                            <tr><th>Tipo</th><td>${data.credito.tipo_responsavel || '-'}</td></tr>
                            <tr><th>Responsável</th><td>${data.credito.nome_responsavel || data.credito.cnpj_responsavel || '-'}</td></tr>
                            <tr><th>Quantidade Original</th><td>${data.credito.qtd_original}</td></tr>
                            <tr><th>Saldo Atual</th><td><strong>${data.credito.qtd_saldo}</strong></td></tr>
                            <tr><th>Status</th><td>${data.credito.status}</td></tr>
                            <tr><th>Prazo</th><td>${data.credito.prazo_dias || '-'} dias</td></tr>
                            <tr><th>Vencimento</th><td>${data.credito.data_vencimento ? new Date(data.credito.data_vencimento).toLocaleDateString('pt-BR') : '-'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Documentos Vinculados</h6>
                        ${data.documentos.length > 0 ? `
                        <ul class="list-group list-group-flush">
                            ${data.documentos.map(d => `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${d.tipo}</strong>
                                        ${d.numero_documento ? ` - ${d.numero_documento}` : ''}
                                        <br><small class="text-muted">${d.quantidade} pallets</small>
                                    </div>
                                    <span class="badge ${d.recebido ? 'bg-success' : 'bg-warning'}">${d.recebido ? 'Recebido' : 'Pendente'}</span>
                                </li>
                            `).join('')}
                        </ul>
                        ` : '<p class="text-muted">Nenhum documento vinculado</p>'}

                        <h6 class="text-muted mb-3 mt-4">Histórico de Soluções</h6>
                        ${data.solucoes.length > 0 ? `
                        <ul class="list-group list-group-flush">
                            ${data.solucoes.map(s => `
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <strong>${s.tipo}</strong>
                                        <span>${s.quantidade} pallets</span>
                                    </div>
                                    <small class="text-muted">${new Date(s.criado_em).toLocaleString('pt-BR')} por ${s.criado_por || '-'}</small>
                                </li>
                            `).join('')}
                        </ul>
                        ` : '<p class="text-muted">Nenhuma solução registrada</p>'}
                    </div>
                </div>
            `;
            content.innerHTML = html;
        })
        .catch(error => {
            console.error('Erro ao carregar detalhes:', error);
            content.innerHTML = `<div class="alert alert-danger">Erro ao carregar detalhes do crédito.</div>`;
        });
}

// =============================================
// MÁSCARAS E VALIDAÇÕES
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    // Máscara de CNPJ
    const cnpjInputs = document.querySelectorAll('#venda_cnpj, #substituicao_cnpj_destino');
    cnpjInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 14) value = value.slice(0, 14);

            if (value.length > 12) {
                value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
            } else if (value.length > 8) {
                value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d+)$/, '$1.$2.$3/$4');
            } else if (value.length > 5) {
                value = value.replace(/^(\d{2})(\d{3})(\d+)$/, '$1.$2.$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d+)$/, '$1.$2');
            }

            e.target.value = value;
        });
    });

    // Máscara de valor monetário
    const valorInput = document.getElementById('venda_valor');
    if (valorInput) {
        valorInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = (parseInt(value) / 100).toFixed(2);
            value = value.replace('.', ',');
            e.target.value = value;
        });
    }

    // Data padrão para recebimento
    const dataRecebimento = document.getElementById('recebimento_data');
    if (dataRecebimento && !dataRecebimento.value) {
        dataRecebimento.value = new Date().toISOString().split('T')[0];
    }

    // Data padrão para venda
    const dataVenda = document.getElementById('venda_data');
    if (dataVenda && !dataVenda.value) {
        dataVenda.value = new Date().toISOString().split('T')[0];
    }
});
</script>
{% endblock %}
