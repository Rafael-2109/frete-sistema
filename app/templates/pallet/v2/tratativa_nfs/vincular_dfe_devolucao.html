{% extends 'base.html' %}

{% block title %}Vincular Devolucao DFe | Tratativa de NFs v2{% endblock %}

{% block extra_css %}
<style>
/* ============================================
   WIZARD VINCULACAO DFe DEVOLUCAO
   Design tokens (06-08)
   ============================================ */

.wizard-devolucao {
    padding: 1.5rem;
    background-color: var(--bg);
    min-height: calc(100vh - 60px);
}

/* Header */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.page-header h1 {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
}

.page-header h1 i {
    color: var(--amber-55);
    margin-right: 0.5rem;
}

/* Breadcrumb */
.breadcrumb-nav {
    margin-bottom: 1rem;
}

.breadcrumb-nav .breadcrumb {
    background: transparent;
    padding: 0;
    margin: 0;
    font-size: 0.875rem;
}

.breadcrumb-nav .breadcrumb-item a {
    color: var(--text-muted);
    text-decoration: none;
}

.breadcrumb-nav .breadcrumb-item a:hover {
    color: var(--amber-55);
}

.breadcrumb-nav .breadcrumb-item.active {
    color: var(--text);
}

/* Wizard Steps */
.wizard-steps {
    display: flex;
    justify-content: center;
    gap: 0;
    margin-bottom: 2rem;
    padding: 0 1rem;
}

.wizard-step {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: var(--bg-light);
    border: 1px solid var(--border);
    color: var(--text-muted);
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.3s;
    cursor: default;
}

.wizard-step:first-child {
    border-radius: 8px 0 0 8px;
}

.wizard-step:last-child {
    border-radius: 0 8px 8px 0;
}

.wizard-step .step-num {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
}

.wizard-step.active {
    background: var(--amber-55);
    color: #fff;
    border-color: var(--amber-55);
}

.wizard-step.active .step-num {
    background: rgba(255,255,255,0.3);
    color: #fff;
}

.wizard-step.completed {
    background: var(--semantic-success);
    color: #fff;
    border-color: var(--semantic-success);
}

.wizard-step.completed .step-num {
    background: rgba(255,255,255,0.3);
}

/* Card */
.wizard-card {
    background: var(--bg-light);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px hsla(0 0% 0% / 0.08);
    border: 1px solid var(--border);
    margin-bottom: 1.5rem;
}

.wizard-card h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
}

.wizard-card h3 i {
    margin-right: 0.5rem;
    color: var(--amber-55);
}

/* Table */
.wizard-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.85rem;
}

.wizard-table thead th {
    background: var(--bg);
    padding: 0.75rem 0.5rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid var(--border);
}

.wizard-table tbody tr {
    cursor: pointer;
    transition: background 0.15s;
}

.wizard-table tbody tr:hover {
    background: hsla(45, 100%, 51%, 0.05);
}

.wizard-table tbody tr.selected {
    background: hsla(45, 100%, 51%, 0.12);
    border-left: 3px solid var(--amber-55);
}

.wizard-table tbody td {
    padding: 0.65rem 0.5rem;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
}

/* Input qty */
.qty-input {
    width: 80px;
    padding: 0.35rem 0.5rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.85rem;
    text-align: right;
    background: var(--bg-light);
    color: var(--text);
}

.qty-input:focus {
    outline: none;
    border-color: var(--amber-55);
    box-shadow: 0 0 0 2px hsla(45, 100%, 51%, 0.2);
}

/* Badges */
.empresa-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
}

.empresa-badge.CD { background: #e0f2fe; color: #0369a1; }
.empresa-badge.FB { background: #fce7f3; color: #be185d; }
.empresa-badge.SC { background: #dcfce7; color: #166534; }

/* Totalizador */
.totalizer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--bg);
    border-radius: 8px;
    margin-top: 1rem;
    border: 1px solid var(--border);
}

.totalizer .label {
    font-weight: 600;
    color: var(--text-muted);
}

.totalizer .value {
    font-size: 1.25rem;
    font-weight: 700;
}

.totalizer .value.ok { color: var(--semantic-success); }
.totalizer .value.error { color: var(--semantic-danger); }

/* Empresa select */
.empresa-select {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.75rem;
}

.empresa-option {
    padding: 0.5rem 1rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    background: var(--bg-light);
}

.empresa-option:hover {
    border-color: var(--amber-55);
}

.empresa-option.selected {
    border-color: var(--amber-55);
    background: hsla(45, 100%, 51%, 0.1);
}

/* Resumo */
.resumo-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
}

.resumo-item:last-child {
    border-bottom: none;
    font-weight: 700;
}

/* Buttons */
.btn-wizard {
    padding: 0.65rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-wizard-primary {
    background: var(--amber-55);
    color: #fff;
}

.btn-wizard-primary:hover {
    filter: brightness(0.9);
}

.btn-wizard-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-wizard-secondary {
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border);
}

.btn-wizard-secondary:hover {
    background: var(--border);
}

.wizard-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 1.5rem;
}

/* Loading */
.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}

.loading-overlay.active {
    display: flex;
}

.loading-box {
    background: var(--bg-light);
    padding: 2rem 3rem;
    border-radius: 12px;
    text-align: center;
}

.loading-box .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--border);
    border-top-color: var(--amber-55);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Resultado */
.resultado-card {
    background: var(--bg-light);
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    border: 2px solid var(--semantic-success);
}

.resultado-card.erro {
    border-color: var(--semantic-danger);
}

.resultado-card h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

.resultado-card .icon-big {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.resultado-card .icon-big.sucesso { color: var(--semantic-success); }
.resultado-card .icon-big.erro { color: var(--semantic-danger); }

/* Empty */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-muted);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.4;
}
</style>
{% endblock %}

{% block content %}
<div class="wizard-devolucao">

    <!-- Breadcrumb -->
    <nav class="breadcrumb-nav">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('pallet_v2.dashboard') }}">Pallets v2</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('pallet_v2.tratativa_nfs.direcionamento') }}">Tratativa de NFs</a></li>
            <li class="breadcrumb-item active">Vincular Devolucao DFe</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="page-header">
        <h1><i class="fas fa-link"></i> Vincular Devolucao DFe</h1>
        <a href="{{ url_for('pallet_v2.tratativa_nfs.direcionamento') }}" class="btn-wizard btn-wizard-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>

    <!-- Wizard Steps -->
    <div class="wizard-steps">
        <div class="wizard-step active" id="step-indicator-1">
            <span class="step-num">1</span> Selecionar NFD
        </div>
        <div class="wizard-step" id="step-indicator-2">
            <span class="step-num">2</span> Distribuir Quantidades
        </div>
        <div class="wizard-step" id="step-indicator-3">
            <span class="step-num">3</span> Revisar
        </div>
        <div class="wizard-step" id="step-indicator-4">
            <span class="step-num">4</span> Resultado
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ETAPA 1: Selecionar NFD -->
    <!-- ============================================ -->
    <div id="step-1" class="wizard-panel">
        <div class="wizard-card">
            <h3><i class="fas fa-file-invoice"></i> NFs de Devolucao de Pallet (DFe)</h3>

            {% if devolucoes %}
            <table class="wizard-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>NF</th>
                        <th>Serie</th>
                        <th>Data Emissao</th>
                        <th>CNPJ Emitente</th>
                        <th>Nome Emitente</th>
                        <th>Qtd Pallets</th>
                        <th>NF Ref.</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dev in devolucoes %}
                    <tr class="nfd-row" data-dfe='{{ dev | tojson }}'>
                        <td>
                            <input type="radio" name="nfd_selecionada" value="{{ dev.odoo_dfe_id }}">
                        </td>
                        <td><strong>{{ dev.numero_nf }}</strong></td>
                        <td>{{ dev.serie or '-' }}</td>
                        <td>{{ dev.data_emissao[:10] if dev.data_emissao else '-' }}</td>
                        <td><code>{{ dev.cnpj_emitente }}</code></td>
                        <td>{{ dev.nome_emitente or '-' }}</td>
                        <td><strong>{{ dev.quantidade }}</strong></td>
                        <td>{{ dev.nf_remessa_referenciada or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Empresa destino -->
            <div style="margin-top: 1.5rem;">
                <label style="font-weight: 600; color: var(--text);">Empresa que recebe a devolucao:</label>
                <div class="empresa-select">
                    <div class="empresa-option" data-company="4" onclick="selecionarEmpresa(4, this)">
                        <span class="empresa-badge CD">CD</span> Centro de Distribuicao
                    </div>
                    <div class="empresa-option" data-company="1" onclick="selecionarEmpresa(1, this)">
                        <span class="empresa-badge FB">FB</span> Fabrica
                    </div>
                    <div class="empresa-option" data-company="3" onclick="selecionarEmpresa(3, this)">
                        <span class="empresa-badge SC">SC</span> Santa Catarina
                    </div>
                </div>
            </div>

            {% else %}
            <div class="empty-state">
                <i class="fas fa-check-circle"></i>
                <p>Nenhuma devolucao de pallet pendente no DFe.</p>
                <p style="font-size: 0.85rem;">Todas as NFDs ja foram processadas ou nao ha DFes com finnfe=4.</p>
            </div>
            {% endif %}
        </div>

        {% if devolucoes %}
        <div class="wizard-actions">
            <div></div>
            <button class="btn-wizard btn-wizard-primary" id="btn-step1-next" disabled onclick="irParaEtapa2()">
                Proximo <i class="fas fa-arrow-right"></i>
            </button>
        </div>
        {% endif %}
    </div>

    <!-- ============================================ -->
    <!-- ETAPA 2: Distribuir Quantidades -->
    <!-- ============================================ -->
    <div id="step-2" class="wizard-panel" style="display: none;">
        <div class="wizard-card">
            <h3><i class="fas fa-balance-scale"></i> Distribuir Quantidade entre NFs de Remessa</h3>

            <div id="info-nfd-selecionada" style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg); border-radius: 8px;">
                <!-- Preenchido via JS -->
            </div>

            <div id="loading-remessas" style="text-align: center; padding: 2rem; display: none;">
                <div class="loading-box" style="display: inline-block;">
                    <div class="spinner"></div>
                    <p>Buscando remessas candidatas...</p>
                </div>
            </div>

            <div id="tabela-remessas-container" style="display: none;">
                <table class="wizard-table">
                    <thead>
                        <tr>
                            <th>NF Remessa</th>
                            <th>Data Emissao</th>
                            <th>Empresa</th>
                            <th>Destinatario</th>
                            <th>Qtd Total</th>
                            <th>Ja Resolvida</th>
                            <th>Pendente</th>
                            <th>Vincular</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-remessas">
                        <!-- Preenchido via JS -->
                    </tbody>
                </table>

                <div class="totalizer">
                    <div>
                        <span class="label">Total da NFD:</span>
                        <span id="total-nfd" style="font-weight: 700; margin-left: 0.5rem;">0</span>
                    </div>
                    <div>
                        <span class="label">Total alocado:</span>
                        <span id="total-alocado" class="value">0</span>
                    </div>
                    <div>
                        <span class="label">Restante:</span>
                        <span id="total-restante" class="value">0</span>
                    </div>
                </div>
            </div>

            <div id="sem-remessas" style="display: none;" class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Nenhuma NF de remessa encontrada para este CNPJ.</p>
            </div>
        </div>

        <div class="wizard-actions">
            <button class="btn-wizard btn-wizard-secondary" onclick="irParaEtapa1()">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <button class="btn-wizard btn-wizard-primary" id="btn-step2-next" disabled onclick="irParaEtapa3()">
                Revisar <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ETAPA 3: Revisar -->
    <!-- ============================================ -->
    <div id="step-3" class="wizard-panel" style="display: none;">
        <div class="wizard-card">
            <h3><i class="fas fa-clipboard-check"></i> Revisar Vinculacao</h3>

            <div id="resumo-container">
                <!-- Preenchido via JS -->
            </div>
        </div>

        <div class="wizard-actions">
            <button class="btn-wizard btn-wizard-secondary" onclick="irParaEtapa2()">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <button class="btn-wizard btn-wizard-primary" id="btn-confirmar" onclick="executarVinculacao()">
                <i class="fas fa-check"></i> Confirmar Vinculacao
            </button>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ETAPA 4: Resultado -->
    <!-- ============================================ -->
    <div id="step-4" class="wizard-panel" style="display: none;">
        <div id="resultado-container">
            <!-- Preenchido via JS -->
        </div>

        <div class="wizard-actions" style="justify-content: center; margin-top: 2rem;">
            <a href="{{ url_for('pallet_v2.tratativa_nfs.vincular_dfe_devolucao') }}" class="btn-wizard btn-wizard-primary">
                <i class="fas fa-redo"></i> Nova Vinculacao
            </a>
            <a href="{{ url_for('pallet_v2.tratativa_nfs.direcionamento') }}" class="btn-wizard btn-wizard-secondary" style="margin-left: 1rem;">
                <i class="fas fa-arrow-left"></i> Voltar ao Direcionamento
            </a>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <p>Processando vinculacao no Odoo...</p>
            <p style="font-size: 0.8rem; color: var(--text-muted);">Criando PO, picking e vinculando moves. Pode levar ate 2 minutos.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============================================
// Estado do wizard
// ============================================
let state = {
    nfdSelecionada: null,
    companyId: null,
    remessasCandidatas: [],
    vinculacoes: []
};

// ============================================
// ETAPA 1: Selecionar NFD + Empresa
// ============================================

document.querySelectorAll('.nfd-row').forEach(row => {
    row.addEventListener('click', function() {
        const radio = this.querySelector('input[type="radio"]');
        radio.checked = true;
        document.querySelectorAll('.nfd-row').forEach(r => r.classList.remove('selected'));
        this.classList.add('selected');

        state.nfdSelecionada = JSON.parse(this.dataset.dfe);
        verificarStep1Completo();
    });
});

function selecionarEmpresa(companyId, el) {
    document.querySelectorAll('.empresa-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    state.companyId = companyId;
    verificarStep1Completo();
}

function verificarStep1Completo() {
    const btn = document.getElementById('btn-step1-next');
    btn.disabled = !(state.nfdSelecionada && state.companyId);
}

// ============================================
// ETAPA 2: Buscar remessas e distribuir
// ============================================

async function irParaEtapa2() {
    mostrarEtapa(2);

    // Mostrar info da NFD selecionada
    const nfd = state.nfdSelecionada;
    document.getElementById('info-nfd-selecionada').innerHTML = `
        <strong>NFD selecionada:</strong> NF ${nfd.numero_nf}
        | Emitente: ${nfd.nome_emitente || nfd.cnpj_emitente}
        | <strong>${nfd.quantidade} pallets</strong>
    `;
    document.getElementById('total-nfd').textContent = nfd.quantidade;

    // Buscar remessas candidatas
    document.getElementById('loading-remessas').style.display = 'block';
    document.getElementById('tabela-remessas-container').style.display = 'none';
    document.getElementById('sem-remessas').style.display = 'none';

    try {
        const params = new URLSearchParams({
            cnpj_emitente: nfd.cnpj_emitente,
            quantidade: nfd.quantidade
        });
        const resp = await fetch(`{{ url_for('pallet_v2.tratativa_nfs.api_sugerir_vinculacao_dfe', dfe_id=0) }}`.replace('/0', '/' + nfd.odoo_dfe_id) + '?' + params);
        const data = await resp.json();

        document.getElementById('loading-remessas').style.display = 'none';

        if (data.sucesso && data.candidatas && data.candidatas.length > 0) {
            state.remessasCandidatas = data.candidatas;
            renderizarRemessas(data.candidatas);
            document.getElementById('tabela-remessas-container').style.display = 'block';
            atualizarTotais();
        } else {
            document.getElementById('sem-remessas').style.display = 'block';
        }
    } catch (err) {
        document.getElementById('loading-remessas').style.display = 'none';
        document.getElementById('sem-remessas').style.display = 'block';
        document.getElementById('sem-remessas').innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <p>Erro ao buscar remessas: ${err.message}</p>
        `;
    }
}

function renderizarRemessas(candidatas) {
    const tbody = document.getElementById('tbody-remessas');
    tbody.innerHTML = '';

    candidatas.forEach((c, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${c.numero_nf}</strong></td>
            <td>${c.data_emissao}</td>
            <td><span class="empresa-badge ${c.empresa}">${c.empresa}</span></td>
            <td>${c.nome_destinatario || '-'}</td>
            <td>${c.quantidade_total}</td>
            <td>${c.qtd_resolvida}</td>
            <td><strong>${c.qtd_pendente}</strong></td>
            <td>
                <input type="number" class="qty-input" id="qty-${i}"
                       min="0" max="${c.qtd_pendente}"
                       value="${c.qtd_sugerida}"
                       data-index="${i}"
                       onchange="atualizarTotais()"
                       oninput="atualizarTotais()">
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function atualizarTotais() {
    let totalAlocado = 0;
    const nfdQtd = state.nfdSelecionada.quantidade;

    state.remessasCandidatas.forEach((c, i) => {
        const input = document.getElementById('qty-' + i);
        if (input) {
            totalAlocado += parseInt(input.value) || 0;
        }
    });

    const restante = nfdQtd - totalAlocado;
    const elAlocado = document.getElementById('total-alocado');
    const elRestante = document.getElementById('total-restante');

    elAlocado.textContent = totalAlocado;
    elRestante.textContent = restante;

    if (totalAlocado === nfdQtd) {
        elAlocado.className = 'value ok';
        elRestante.className = 'value ok';
    } else {
        elAlocado.className = 'value error';
        elRestante.className = 'value error';
    }

    // Habilitar botao proximo apenas se soma == total
    document.getElementById('btn-step2-next').disabled = (totalAlocado !== nfdQtd);
}

function irParaEtapa1() {
    mostrarEtapa(1);
}

// ============================================
// ETAPA 3: Revisar
// ============================================

function irParaEtapa3() {
    // Construir vinculacoes
    state.vinculacoes = [];

    state.remessasCandidatas.forEach((c, i) => {
        const input = document.getElementById('qty-' + i);
        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
            state.vinculacoes.push({
                nf_remessa_id: c.nf_remessa_id,
                numero_nf: c.numero_nf,
                empresa: c.empresa,
                quantidade: qty,
                qtd_pendente: c.qtd_pendente,
                odoo_picking_remessa_id: c.odoo_picking_id
            });
        }
    });

    // Renderizar resumo
    const container = document.getElementById('resumo-container');
    const nfd = state.nfdSelecionada;
    const empresas = {1: 'FB (Fabrica)', 3: 'SC (Santa Catarina)', 4: 'CD (Centro de Distribuicao)'};

    let html = `
        <div style="margin-bottom: 1.5rem;">
            <h4 style="margin-bottom: 0.5rem;">NF de Devolucao</h4>
            <div class="resumo-item"><span>Numero NF</span><span><strong>${nfd.numero_nf}</strong></span></div>
            <div class="resumo-item"><span>Emitente</span><span>${nfd.nome_emitente || nfd.cnpj_emitente}</span></div>
            <div class="resumo-item"><span>CNPJ</span><span><code>${nfd.cnpj_emitente}</code></span></div>
            <div class="resumo-item"><span>Quantidade total</span><span><strong>${nfd.quantidade} pallets</strong></span></div>
            <div class="resumo-item"><span>Empresa destino</span><span><strong>${empresas[state.companyId] || state.companyId}</strong></span></div>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <h4 style="margin-bottom: 0.5rem;">Distribuicao (${state.vinculacoes.length} remessas)</h4>
    `;

    state.vinculacoes.forEach(v => {
        html += `
            <div class="resumo-item">
                <span>NF ${v.numero_nf} <span class="empresa-badge ${v.empresa}">${v.empresa}</span></span>
                <span><strong>${v.quantidade} pallets</strong> (de ${v.qtd_pendente} pendentes)</span>
            </div>
        `;
    });

    const totalVinculado = state.vinculacoes.reduce((s, v) => s + v.quantidade, 0);
    html += `
            <div class="resumo-item" style="border-top: 2px solid var(--border); padding-top: 0.75rem; margin-top: 0.5rem;">
                <span>TOTAL VINCULADO</span>
                <span style="font-size: 1.1rem;"><strong>${totalVinculado} pallets</strong></span>
            </div>
        </div>

        <div style="padding: 1rem; background: hsla(45, 100%, 51%, 0.08); border-radius: 8px; border: 1px solid var(--amber-55);">
            <strong><i class="fas fa-info-circle"></i> O que sera criado no Odoo:</strong>
            <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                <li>Purchase Order (PO) de devolucao de pallet</li>
                <li>Picking de recebimento (gerado automaticamente)</li>
                <li>${state.vinculacoes.length} moves vinculados as remessas originais</li>
            </ul>
        </div>
    `;

    container.innerHTML = html;
    mostrarEtapa(3);
}

// ============================================
// ETAPA 4: Executar vinculacao
// ============================================

async function executarVinculacao() {
    document.getElementById('loading-overlay').classList.add('active');
    document.getElementById('btn-confirmar').disabled = true;

    const nfd = state.nfdSelecionada;

    const payload = {
        odoo_dfe_id: nfd.odoo_dfe_id,
        company_id: state.companyId,
        nf_devolucao: {
            numero_nf: nfd.numero_nf,
            numero_nf_solucao: nfd.numero_nf,
            serie: nfd.serie,
            serie_nf_solucao: nfd.serie,
            chave_nfe: nfd.chave_nfe,
            chave_nfe_solucao: nfd.chave_nfe,
            data_emissao: nfd.data_emissao,
            data_nf_solucao: nfd.data_emissao,
            cnpj_emitente: nfd.cnpj_emitente,
            nome_emitente: nfd.nome_emitente,
            quantidade: nfd.quantidade,
            odoo_dfe_id: nfd.odoo_dfe_id,
        },
        vinculacoes: state.vinculacoes.map(v => ({
            nf_remessa_id: v.nf_remessa_id,
            quantidade: v.quantidade,
            odoo_picking_remessa_id: v.odoo_picking_remessa_id || null,
        }))
    };

    try {
        const resp = await fetch('{{ url_for("pallet_v2.tratativa_nfs.api_vincular_dfe_devolucao") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await resp.json();

        document.getElementById('loading-overlay').classList.remove('active');
        mostrarEtapa(4);

        if (data.sucesso) {
            document.getElementById('resultado-container').innerHTML = `
                <div class="resultado-card">
                    <div class="icon-big sucesso"><i class="fas fa-check-circle"></i></div>
                    <h2>Vinculacao Realizada com Sucesso!</h2>
                    <div style="text-align: left; max-width: 400px; margin: 1.5rem auto;">
                        <div class="resumo-item"><span>PO criado</span><span><strong>${data.odoo.po_name || '-'}</strong></span></div>
                        <div class="resumo-item"><span>Picking</span><span><strong>${data.odoo.picking_name || '-'}</strong></span></div>
                        <div class="resumo-item"><span>Solucoes registradas</span><span><strong>${data.local.solucoes_criadas}</strong></span></div>
                        <div class="resumo-item"><span>Total vinculado</span><span><strong>${data.quantidade_total} pallets</strong></span></div>
                    </div>
                </div>
            `;
        } else {
            document.getElementById('resultado-container').innerHTML = `
                <div class="resultado-card erro">
                    <div class="icon-big erro"><i class="fas fa-times-circle"></i></div>
                    <h2>Erro na Vinculacao</h2>
                    <p style="margin-top: 1rem; color: var(--semantic-danger);">${data.erro || 'Erro desconhecido'}</p>
                </div>
            `;
        }

    } catch (err) {
        document.getElementById('loading-overlay').classList.remove('active');
        mostrarEtapa(4);
        document.getElementById('resultado-container').innerHTML = `
            <div class="resultado-card erro">
                <div class="icon-big erro"><i class="fas fa-times-circle"></i></div>
                <h2>Erro de Comunicacao</h2>
                <p style="margin-top: 1rem;">${err.message}</p>
            </div>
        `;
    }
}

// ============================================
// Navegacao entre etapas
// ============================================

function mostrarEtapa(n) {
    for (let i = 1; i <= 4; i++) {
        document.getElementById('step-' + i).style.display = (i === n) ? 'block' : 'none';

        const indicator = document.getElementById('step-indicator-' + i);
        indicator.classList.remove('active', 'completed');
        if (i < n) indicator.classList.add('completed');
        if (i === n) indicator.classList.add('active');
    }
}
</script>
{% endblock %}
