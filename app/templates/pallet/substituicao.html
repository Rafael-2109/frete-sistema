{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-exchange-alt"></i>
                        Registrar Substituicao de NF
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Dados da remessa original -->
                    <div class="alert alert-warning mb-4">
                        <h6><i class="fas fa-truck"></i> NF Original (Transportadora)</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>NF:</strong> {{ remessa.numero_nf or '-' }}
                            </div>
                            <div class="col-md-3">
                                <strong>Qtd Original:</strong> {{ remessa.qtd_movimentacao|int }} pallets
                            </div>
                            <div class="col-md-3">
                                <strong>Data:</strong> {{ remessa.data_movimentacao|formatar_data_segura or '-' }}
                            </div>
                            <div class="col-md-3">
                                <strong>Transportadora:</strong><br>
                                <small>{{ remessa.nome_destinatario or remessa.cnpj_destinatario or '-' }}</small>
                            </div>
                        </div>
                        {# Mostrar informações de substituição #}
                        {% if qtd_ja_substituida and qtd_ja_substituida > 0 %}
                        <hr class="my-2">
                        <div class="row">
                            <div class="col-md-4">
                                <span class="text-info">
                                    <i class="fas fa-exchange-alt"></i>
                                    <strong>Já substituído:</strong> {{ qtd_ja_substituida|int }} pallets
                                </span>
                            </div>
                            <div class="col-md-4">
                                <span class="text-success fw-bold">
                                    <i class="fas fa-check-circle"></i>
                                    <strong>Disponível:</strong> {{ saldo_disponivel|int }} pallets
                                </span>
                            </div>
                            <div class="col-md-4">
                                <div class="progress" style="height: 20px;">
                                    {% set percentual = (((qtd_ja_substituida|float) / (remessa.qtd_movimentacao|float)) * 100)|int %}
                                    <div class="progress-bar bg-info" role="progressbar"
                                         style="width: {{ percentual }}%;"
                                         aria-valuenow="{{ percentual }}" aria-valuemin="0" aria-valuemax="100">
                                        {{ percentual }}% substituído
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <form method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <h5 class="mb-3"><i class="fas fa-user text-primary"></i> Dados da NF do Cliente</h5>
                        <p class="text-muted">Informe os dados da NF que sera emitida para o cliente:</p>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Numero da NF (Cliente) <span class="text-danger">*</span></label>
                                <input type="text" name="numero_nf" class="form-control" required
                                       placeholder="Numero da NF emitida para o cliente">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Quantidade de Pallets <span class="text-danger">*</span></label>
                                <input type="number" name="quantidade" class="form-control" required
                                       min="1" max="{{ saldo_disponivel|int }}"
                                       value="{{ saldo_disponivel|int }}"
                                       placeholder="Max: {{ saldo_disponivel|int }}">
                                <small class="text-muted">
                                    Máximo disponível: <strong class="text-success">{{ saldo_disponivel|int }}</strong> pallets
                                    {% if qtd_ja_substituida and qtd_ja_substituida > 0 %}
                                        (de {{ remessa.qtd_movimentacao|int }} originais, {{ qtd_ja_substituida|int }} já substituídos)
                                    {% endif %}
                                </small>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12 mb-3">
                                <label class="form-label">Buscar Cliente</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="buscaCliente"
                                           placeholder="Digite CNPJ ou nome para buscar..." autocomplete="off">
                                    <div id="listaClientes" class="position-absolute w-100 bg-white border rounded shadow-sm"
                                         style="display: none; z-index: 1000; max-height: 250px; overflow-y: auto;"></div>
                                </div>
                                <small class="text-muted">Busca em clientes cadastrados</small>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">CNPJ do Cliente <span class="text-danger">*</span></label>
                                <input type="text" name="cnpj_cliente" class="form-control" id="cnpjCliente" required
                                       placeholder="Preenchido automaticamente" readonly>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Nome do Cliente</label>
                                <input type="text" name="nome_cliente" class="form-control" id="nomeCliente"
                                       placeholder="Preenchido automaticamente" readonly>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-secondary w-100" id="btnLimparCliente" style="display: none;">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                        </div>

                        <!-- Alerta se cliente nao aceita NF pallet -->
                        <div class="row mb-3" id="alertaNfPallet" style="display: none;">
                            <div class="col-12">
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Atenção:</strong> Este cliente <strong>NÃO ACEITA</strong> NF de pallet.
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle"></i>
                            <strong>Importante:</strong> A responsabilidade pelo retorno dos pallets permanece com a
                            transportadora <strong>{{ remessa.nome_destinatario or remessa.cnpj_destinatario }}</strong>.
                            A nova NF do cliente apenas "consome" a quantidade da NF original.
                        </div>

                        <hr>
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('pallet.listar_substituicoes') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-exchange-alt"></i> Registrar Substituicao
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos do autocomplete
    const buscaCliente = document.getElementById('buscaCliente');
    const listaClientes = document.getElementById('listaClientes');
    const cnpjCliente = document.getElementById('cnpjCliente');
    const nomeCliente = document.getElementById('nomeCliente');
    const btnLimparCliente = document.getElementById('btnLimparCliente');
    const alertaNfPallet = document.getElementById('alertaNfPallet');

    let timeoutBusca = null;
    let clienteSelecionado = false;

    // Funcao para buscar clientes
    function buscarClientes(termo) {
        fetch(`/pallet/api/buscar-destinatario?q=${encodeURIComponent(termo)}&tipo=CLIENTE`)
            .then(response => response.json())
            .then(data => {
                listaClientes.innerHTML = '';
                if (data.length === 0) {
                    listaClientes.innerHTML = '<div class="p-3 text-muted text-center">Nenhum cliente encontrado</div>';
                } else {
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-bottom';
                        div.style.cursor = 'pointer';
                        div.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${item.nome}</strong>
                                    <br><small class="text-muted">${item.cnpj}</small>
                                </div>
                                ${!item.aceita_nf_pallet ? '<span class="badge bg-warning text-dark">Nao aceita NF</span>' : ''}
                            </div>
                        `;
                        div.addEventListener('click', function() {
                            selecionarCliente(item);
                        });
                        div.addEventListener('mouseenter', function() { this.style.backgroundColor = '#f8f9fa'; });
                        div.addEventListener('mouseleave', function() { this.style.backgroundColor = ''; });
                        listaClientes.appendChild(div);
                    });
                }
                listaClientes.style.display = 'block';
            })
            .catch(error => {
                console.error('Erro na busca:', error);
                listaClientes.innerHTML = '<div class="p-3 text-danger text-center">Erro na busca</div>';
                listaClientes.style.display = 'block';
            });
    }

    // Funcao para selecionar cliente
    function selecionarCliente(item) {
        clienteSelecionado = true;
        cnpjCliente.value = item.cnpj;
        nomeCliente.value = item.nome;
        buscaCliente.value = `${item.nome} (${item.cnpj})`;
        buscaCliente.disabled = true;
        listaClientes.style.display = 'none';
        btnLimparCliente.style.display = 'block';

        // Mostrar alerta se nao aceita NF pallet
        if (!item.aceita_nf_pallet) {
            alertaNfPallet.style.display = 'block';
        } else {
            alertaNfPallet.style.display = 'none';
        }
    }

    // Funcao para limpar selecao
    function limparCliente() {
        clienteSelecionado = false;
        cnpjCliente.value = '';
        nomeCliente.value = '';
        buscaCliente.value = '';
        buscaCliente.disabled = false;
        btnLimparCliente.style.display = 'none';
        alertaNfPallet.style.display = 'none';
        buscaCliente.focus();
    }

    // Evento de digitacao no campo de busca
    buscaCliente.addEventListener('input', function() {
        const termo = this.value.trim();
        if (timeoutBusca) clearTimeout(timeoutBusca);

        if (termo.length < 2) {
            listaClientes.style.display = 'none';
            return;
        }

        timeoutBusca = setTimeout(() => buscarClientes(termo), 300);
    });

    // Fechar lista ao clicar fora
    document.addEventListener('click', function(e) {
        if (!buscaCliente.contains(e.target) && !listaClientes.contains(e.target)) {
            listaClientes.style.display = 'none';
        }
    });

    // Evento do botao limpar
    btnLimparCliente.addEventListener('click', limparCliente);
});
</script>
{% endblock %}
