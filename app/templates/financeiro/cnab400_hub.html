{% extends "base.html" %}

{% block title %}CNAB400 - Retorno Bancario{% endblock %}

{% block extra_css %}
{# Styles moved to modules/_financeiro.css #}
{% endblock %}

{% block content %}
<div class="cnab-container">
    <!-- ================================================================== -->
    <!-- HEADER -->
    <!-- ================================================================== -->
    <header class="cnab-header">
        <div>
            <h1 class="cnab-header__title">
                <i class="fas fa-file-invoice-dollar"></i>
                CNAB400 - Retorno Bancario
            </h1>
            <p class="cnab-header__subtitle">
                Processe arquivos de retorno bancario e vincule com Contas a Receber
            </p>
        </div>
        <div class="cnab-header__actions">
            <a href="{{ url_for('cnab400.upload') }}" class="btn-cnab btn-cnab--primary">
                <i class="fas fa-upload"></i>
                Upload de Arquivo
            </a>
        </div>
    </header>

    <!-- ================================================================== -->
    <!-- STATS CARDS -->
    <!-- ================================================================== -->
    <div class="cnab-stats">
        <div class="cnab-stat">
            <div class="cnab-stat__icon cnab-stat__icon--primary">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="cnab-stat__value">{{ stats.total_lotes }}</div>
            <div class="cnab-stat__label">Total de Lotes</div>
        </div>
        <div class="cnab-stat">
            <div class="cnab-stat__icon cnab-stat__icon--warning">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="cnab-stat__value">{{ stats.lotes_pendentes }}</div>
            <div class="cnab-stat__label">Pendentes</div>
        </div>
        <div class="cnab-stat">
            <div class="cnab-stat__icon cnab-stat__icon--success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="cnab-stat__value">{{ stats.lotes_concluidos }}</div>
            <div class="cnab-stat__label">Concluidos</div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- TABELA DE LOTES -->
    <!-- ================================================================== -->
    <div class="cnab-section">
        <div class="cnab-section__header">
            <h2 class="cnab-section__title">
                <i class="fas fa-list"></i>
                Lotes Importados
            </h2>
        </div>

        {% if lotes %}
        <table class="cnab-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Arquivo</th>
                    <th>Banco</th>
                    <th>Data Arquivo</th>
                    <th>Registros</th>
                    <th>Match</th>
                    <th>Status</th>
                    <th>Processado Por</th>
                    <th>Acoes</th>
                </tr>
            </thead>
            <tbody>
                {% for lote in lotes %}
                <tr>
                    <td><strong>#{{ lote.id }}</strong></td>
                    <td>
                        <span title="{{ lote.arquivo_nome }}">
                            {{ lote.arquivo_nome[:30] }}{% if lote.arquivo_nome|length > 30 %}...{% endif %}
                        </span>
                    </td>
                    <td>
                        <span class="text-muted">{{ lote.banco_codigo }}</span>
                        {{ lote.banco_nome or '' }}
                    </td>
                    <td>
                        {% if lote.data_arquivo %}
                            {{ lote.data_arquivo.strftime('%d/%m/%Y') }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>{{ lote.total_registros }}</td>
                    <td>
                        <div class="match-stats">
                            <span class="match-stat match-stat--success" title="Com Match">
                                <i class="fas fa-check"></i> {{ lote.registros_com_match or 0 }}
                            </span>
                            <span class="match-stat match-stat--danger" title="Sem Match">
                                <i class="fas fa-times"></i> {{ lote.registros_sem_match or 0 }}
                            </span>
                        </div>
                    </td>
                    <td>
                        {% set status_class = {
                            'IMPORTADO': 'importado',
                            'AGUARDANDO_REVISAO': 'aguardando',
                            'APROVADO': 'aprovado',
                            'PROCESSANDO': 'processando',
                            'CONCLUIDO': 'concluido',
                            'PARCIAL': 'parcial',
                            'ERRO': 'erro'
                        } %}
                        <span class="status-badge status-badge--{{ status_class.get(lote.status, 'importado') }}">
                            {{ lote.status }}
                        </span>
                    </td>
                    <td>{{ lote.processado_por or '-' }}</td>
                    <td>
                        <a href="{{ url_for('cnab400.lote_detalhe', lote_id=lote.id) }}"
                           class="btn-cnab btn-cnab--outline btn-cnab--sm"
                           title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="cnab-empty">
            <div class="cnab-empty__icon">
                <i class="fas fa-inbox"></i>
            </div>
            <h3 class="cnab-empty__title">Nenhum arquivo importado</h3>
            <p>Faca o upload de um arquivo .ret para comecar</p>
            <a href="{{ url_for('cnab400.upload') }}" class="btn-cnab btn-cnab--primary" style="margin-top: 1rem;">
                <i class="fas fa-upload"></i>
                Fazer Upload
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
