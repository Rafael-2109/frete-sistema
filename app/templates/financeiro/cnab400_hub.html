{% extends "base.html" %}

{% block title %}CNAB400 - Retorno Bancario{% endblock %}

{% block extra_css %}
{# Styles moved to modules/_financeiro.css #}
<style>
/* Batch progress bar — uses semantic design tokens */
.cnab-batch-progresso {
    background: linear-gradient(135deg, hsl(220 80% 53%) 0%, hsl(220 80% 43%) 100%);
    color: hsl(0 0% 100%);
    border-radius: 8px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 6px hsla(0 0% 0% / 0.1);
    overflow: hidden;
}
.cnab-batch-progresso__header {
    padding: 12px 16px;
    font-size: 0.95rem;
}
.cnab-batch-progresso__body {
    background: hsla(0 0% 100% / 0.95);
    color: var(--text);
    padding: 12px 16px;
}
.cnab-batch-progresso__footer {
    background: hsla(0 0% 100% / 0.9);
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    text-align: right;
}
.cnab-batch-progresso.concluido {
    background: linear-gradient(135deg, hsl(160 93% 30%) 0%, hsl(160 93% 25%) 100%);
}
.cnab-batch-progresso.parcial {
    background: linear-gradient(135deg, hsl(40 96% 40%) 0%, hsl(35 90% 35%) 100%);
}
.cnab-batch-progresso.erro {
    background: linear-gradient(135deg, hsl(0 85% 50%) 0%, hsl(0 85% 42%) 100%);
}
</style>
{% endblock %}

{% block content %}
<div class="cnab-container">
    <!-- ================================================================== -->
    <!-- PAINEL DE PROGRESSO (se houver batch em andamento) -->
    <!-- ================================================================== -->
    <div id="batch-progresso-hub" class="cnab-batch-progresso" style="display: none;">
        <div class="cnab-batch-progresso__header">
            <i class="fas fa-cog fa-spin me-2"></i>
            <strong>Processamento em Andamento</strong>
            <span id="batch-arquivo-atual" class="ms-2 text-muted"></span>
        </div>
        <div class="cnab-batch-progresso__body">
            <div class="progress mb-2" style="height: 10px;">
                <div id="batch-barra" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 0%"></div>
            </div>
            <div class="d-flex justify-content-between small">
                <div>
                    <span class="text-success"><i class="fas fa-check me-1"></i><span id="batch-sucesso">0</span></span>
                    <span class="text-danger ms-3"><i class="fas fa-times me-1"></i><span id="batch-erro">0</span></span>
                </div>
                <span id="batch-contagem">0/0 arquivos</span>
            </div>
        </div>
        <div id="batch-footer" class="cnab-batch-progresso__footer" style="display: none;">
            <button onclick="fecharPainelBatch()" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-times"></i> Fechar
            </button>
            <button onclick="location.reload()" class="btn btn-sm btn-primary ms-2">
                <i class="fas fa-sync"></i> Atualizar Lista
            </button>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- HEADER -->
    <!-- ================================================================== -->
    <header class="cnab-header">
        <div>
            <h1 class="cnab-header__title">
                <i class="fas fa-file-invoice-dollar"></i>
                CNAB400 - Retorno Bancario
            </h1>
            <p class="cnab-header__subtitle">
                Processe arquivos de retorno bancario e vincule com Contas a Receber
            </p>
        </div>
        <div class="cnab-header__actions">
            <a href="{{ url_for('cnab400.api_exportar_todas_pendencias') }}"
               class="btn-cnab btn-cnab--outline"
               title="Exportar todas as pendências em Excel">
                <i class="fas fa-file-excel"></i>
                Exportar Pendências
            </a>
            <a href="{{ url_for('cnab400.upload') }}" class="btn-cnab btn-cnab--primary">
                <i class="fas fa-upload"></i>
                Upload de Arquivo
            </a>
        </div>
    </header>

    <!-- ================================================================== -->
    <!-- STATS CARDS -->
    <!-- ================================================================== -->
    <div class="cnab-stats">
        <div class="cnab-stat">
            <div class="cnab-stat__icon cnab-stat__icon--primary">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="cnab-stat__value">{{ stats.total_lotes }}</div>
            <div class="cnab-stat__label">Total de Lotes</div>
        </div>
        <div class="cnab-stat">
            <div class="cnab-stat__icon cnab-stat__icon--warning">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="cnab-stat__value">{{ stats.lotes_pendentes }}</div>
            <div class="cnab-stat__label">Pendentes</div>
        </div>
        <div class="cnab-stat">
            <div class="cnab-stat__icon cnab-stat__icon--success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="cnab-stat__value">{{ stats.lotes_concluidos }}</div>
            <div class="cnab-stat__label">Concluidos</div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- INCONSISTÊNCIAS CNAB (títulos com divergência Local × Odoo)        -->
    <!-- ================================================================== -->
    <div class="cnab-section" id="secaoInconsistenciasCnab" style="display: none;">
        <div class="cnab-section__header">
            <h2 class="cnab-section__title" style="color: var(--danger, #dc3545);">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="inconsistencias-titulo">Títulos com Inconsistência CNAB</span>
            </h2>
            <button class="btn-cnab btn-cnab--outline btn-cnab--sm" onclick="carregarInconsistenciasCnab()" title="Atualizar">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <div id="inconsistencias-loading" class="text-center py-3" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i> Carregando...
        </div>

        <table class="cnab-table" id="tabelaInconsistencias" style="display: none;">
            <thead>
                <tr>
                    <th>Emp</th>
                    <th>NF-Parc</th>
                    <th>Cliente</th>
                    <th>Valor</th>
                    <th>Residual</th>
                    <th>Metodo</th>
                    <th>Inconsistencia</th>
                    <th>Detectada</th>
                    <th>Acao</th>
                </tr>
            </thead>
            <tbody id="inconsistencias-body">
            </tbody>
        </table>

        <div id="inconsistencias-empty" class="text-center py-3 text-muted" style="display: none;">
            <i class="fas fa-check-circle text-success"></i> Nenhuma inconsistencia CNAB encontrada.
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- TABELA DE LOTES -->
    <!-- ================================================================== -->
    <div class="cnab-section">
        <div class="cnab-section__header">
            <h2 class="cnab-section__title">
                <i class="fas fa-list"></i>
                Lotes Importados
            </h2>
        </div>

        {% if lotes %}
        <table class="cnab-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Arquivo</th>
                    <th>Banco</th>
                    <th>Data Arquivo</th>
                    <th>Registros</th>
                    <th>Match</th>
                    <th>Status</th>
                    <th>Processado Por</th>
                    <th>Acoes</th>
                </tr>
            </thead>
            <tbody>
                {% for lote in lotes %}
                <tr>
                    <td><strong>#{{ lote.id }}</strong></td>
                    <td>
                        <span title="{{ lote.arquivo_nome }}">
                            {{ lote.arquivo_nome[:30] }}{% if lote.arquivo_nome|length > 30 %}...{% endif %}
                        </span>
                    </td>
                    <td>
                        <span class="text-muted">{{ lote.banco_codigo }}</span>
                        {{ lote.banco_nome or '' }}
                    </td>
                    <td>
                        {% if lote.data_arquivo %}
                            {{ lote.data_arquivo|formatar_data_segura }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>{{ lote.total_registros }}</td>
                    <td>
                        <div class="match-stats">
                            <span class="match-stat match-stat--success" title="Com Match">
                                <i class="fas fa-check"></i> {{ lote.registros_com_match or 0 }}
                            </span>
                            <span class="match-stat match-stat--danger" title="Sem Match">
                                <i class="fas fa-times"></i> {{ lote.registros_sem_match or 0 }}
                            </span>
                        </div>
                    </td>
                    <td>
                        {% set status_class = {
                            'IMPORTADO': 'importado',
                            'AGUARDANDO_REVISAO': 'aguardando',
                            'APROVADO': 'aprovado',
                            'PROCESSANDO': 'processando',
                            'CONCLUIDO': 'concluido',
                            'PARCIAL': 'parcial',
                            'ERRO': 'erro'
                        } %}
                        <span class="status-badge status-badge--{{ status_class.get(lote.status, 'importado') }}">
                            {{ lote.status }}
                        </span>
                    </td>
                    <td>{{ lote.processado_por or '-' }}</td>
                    <td>
                        <a href="{{ url_for('cnab400.lote_detalhe', lote_id=lote.id) }}"
                           class="btn-cnab btn-cnab--outline btn-cnab--sm"
                           title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="cnab-empty">
            <div class="cnab-empty__icon">
                <i class="fas fa-inbox"></i>
            </div>
            <h3 class="cnab-empty__title">Nenhum arquivo importado</h3>
            <p>Faca o upload de um arquivo .ret para comecar</p>
            <a href="{{ url_for('cnab400.upload') }}" class="btn-cnab btn-cnab--primary" style="margin-top: 1rem;">
                <i class="fas fa-upload"></i>
                Fazer Upload
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const painel = document.getElementById('batch-progresso-hub');
    const batchId = localStorage.getItem('cnab_batch_id');
    let pollInterval = null;

    if (batchId) {
        painel.style.display = 'block';
        startPolling();
    }

    function startPolling() {
        if (pollInterval) clearInterval(pollInterval);

        // Polling a cada 2 segundos
        checkBatchStatus();
        pollInterval = setInterval(checkBatchStatus, 2000);
    }

    async function checkBatchStatus() {
        const batchId = localStorage.getItem('cnab_batch_id');
        if (!batchId) {
            if (pollInterval) clearInterval(pollInterval);
            return;
        }

        try {
            const response = await fetch(`/cnab400/api/batch/${batchId}/status`);
            const data = await response.json();

            atualizarPainelHub(data);

            if (data.status === 'concluido' || data.status === 'erro' || data.status === 'parcial' || data.status === 'nao_encontrado') {
                clearInterval(pollInterval);
                finalizarPainelHub(data);
            }
        } catch (e) {
            console.error('Erro ao verificar status do batch:', e);
        }
    }

    function atualizarPainelHub(data) {
        const total = data.total_arquivos || 0;
        const processados = data.arquivos_processados || 0;
        const sucesso = data.arquivos_sucesso || 0;
        const erro = data.arquivos_erro || 0;

        const percent = total > 0 ? Math.round((processados / total) * 100) : 0;

        document.getElementById('batch-arquivo-atual').textContent = data.arquivo_atual || '';
        document.getElementById('batch-barra').style.width = percent + '%';
        document.getElementById('batch-sucesso').textContent = sucesso;
        document.getElementById('batch-erro').textContent = erro;
        document.getElementById('batch-contagem').textContent = `${processados}/${total} arquivos`;
    }

    function finalizarPainelHub(data) {
        const painel = document.getElementById('batch-progresso-hub');
        const barra = document.getElementById('batch-barra');

        barra.classList.remove('progress-bar-animated');

        if (data.status === 'concluido') {
            painel.classList.add('concluido');
            document.getElementById('batch-arquivo-atual').textContent = 'Concluido!';
        } else if (data.status === 'parcial') {
            painel.classList.add('parcial');
            document.getElementById('batch-arquivo-atual').textContent = 'Concluido com avisos';
        } else if (data.status === 'nao_encontrado') {
            // Batch nao encontrado - limpar localStorage
            localStorage.removeItem('cnab_batch_id');
            painel.style.display = 'none';
            return;
        } else {
            painel.classList.add('erro');
            document.getElementById('batch-arquivo-atual').textContent = 'Erro no processamento';
        }

        document.getElementById('batch-footer').style.display = 'block';
    }

    window.fecharPainelBatch = function() {
        localStorage.removeItem('cnab_batch_id');
        document.getElementById('batch-progresso-hub').style.display = 'none';
    };

    // =============================================
    // INCONSISTÊNCIAS CNAB
    // =============================================

    carregarInconsistenciasCnab();
});

function carregarInconsistenciasCnab() {
    const secao = document.getElementById('secaoInconsistenciasCnab');
    const loading = document.getElementById('inconsistencias-loading');
    const tabela = document.getElementById('tabelaInconsistencias');
    const body = document.getElementById('inconsistencias-body');
    const empty = document.getElementById('inconsistencias-empty');

    loading.style.display = 'block';
    tabela.style.display = 'none';
    empty.style.display = 'none';

    fetch('/cnab400/api/inconsistencias')
        .then(r => r.json())
        .then(data => {
            loading.style.display = 'none';

            if (!data.success) {
                console.error('Erro ao carregar inconsistencias:', data.error);
                return;
            }

            if (data.total === 0) {
                // Seção pode ficar oculta ou mostrar mensagem
                secao.style.display = 'block';
                empty.style.display = 'block';
                return;
            }

            secao.style.display = 'block';
            tabela.style.display = 'table';

            document.getElementById('inconsistencias-titulo').textContent =
                `Títulos com Inconsistência CNAB (${data.total})`;

            body.innerHTML = '';
            data.titulos.forEach(t => {
                const empresaBadge = {1: '<span class="badge badge-empresa badge-fb">FB</span>',
                                      2: '<span class="badge badge-empresa badge-sc">SC</span>',
                                      3: '<span class="badge badge-empresa badge-cd">CD</span>'}[t.empresa] || '?';

                const valor = t.valor_titulo ? `R$ ${Number(t.valor_titulo).toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : '-';
                const residual = t.valor_residual !== null ? `R$ ${Number(t.valor_residual).toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : '-';

                const detectada = t.inconsistencia_detectada_em
                    ? new Date(t.inconsistencia_detectada_em).toLocaleDateString('pt-BR')
                    : '-';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center">${empresaBadge}</td>
                    <td><strong>${t.titulo_nf}</strong>-${t.parcela}</td>
                    <td title="${t.raz_social_red || ''}">${(t.raz_social_red || '-').substring(0, 25)}</td>
                    <td class="text-end">${valor}</td>
                    <td class="text-end">${residual}</td>
                    <td><span class="badge bg-secondary">${t.metodo_baixa || '-'}</span></td>
                    <td><span class="badge bg-danger">${t.inconsistencia_odoo}</span></td>
                    <td>${detectada}</td>
                    <td>
                        <button class="btn-cnab btn-cnab--primary btn-cnab--sm"
                                onclick="reconciliarInconsistenciaCnab(${t.id}, '${t.titulo_nf}-${t.parcela}')"
                                title="Re-reconciliar no Odoo">
                            <i class="fas fa-sync"></i> Reconciliar
                        </button>
                    </td>
                `;
                body.appendChild(tr);
            });
        })
        .catch(err => {
            loading.style.display = 'none';
            console.error('Erro ao buscar inconsistencias CNAB:', err);
        });
}

function reconciliarInconsistenciaCnab(contaId, titulo) {
    if (!confirm(`Confirma re-reconciliação do título ${titulo} no Odoo?\n\nIsto criará um pagamento via write-off no Odoo.`)) {
        return;
    }

    const btn = event.target.closest('button');
    const textoOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    fetch(`/cnab400/api/inconsistencias/${contaId}/reconciliar`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Remover linha da tabela
            btn.closest('tr').remove();

            // Verificar se tabela ficou vazia
            const body = document.getElementById('inconsistencias-body');
            if (body.children.length === 0) {
                document.getElementById('tabelaInconsistencias').style.display = 'none';
                document.getElementById('inconsistencias-empty').style.display = 'block';
            }

            // Feedback visual
            const msg = data.ja_pago
                ? `${titulo}: já estava pago no Odoo. Flag limpo.`
                : `${titulo}: pagamento criado no Odoo (R$ ${data.amount ? data.amount.toFixed(2) : '?'}).`;

            // Usar alert simples (sem dependência de toastr no CNAB hub)
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.getElementById('secaoInconsistenciasCnab').prepend(alertDiv);
        } else {
            alert('Erro: ' + (data.error || 'Erro desconhecido'));
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
        }
    })
    .catch(err => {
        alert('Erro de conexão com o servidor');
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    });
}
</script>
{% endblock %}
