{% extends "base.html" %}

{% block title %}Conciliação via Extrato - Financeiro{% endblock %}

{% block styles %}
<style>
    .hub-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: none;
        border-radius: 12px;
    }
    .hub-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .stat-badge {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .statement-row {
        transition: background-color 0.2s;
    }
    .statement-row:hover {
        background-color: #f8f9fa;
    }
    .statement-row.importado {
        background-color: #e8f5e9;
    }
    .statement-row.selected {
        background-color: #e3f2fd;
    }
    .bulk-actions {
        position: sticky;
        bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 -4px 15px rgba(0,0,0,0.2);
        display: none;
    }
    .bulk-actions.show {
        display: flex;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-university text-primary me-2"></i>
                        Conciliação via Extrato Bancário
                    </h2>
                    <p class="text-muted mb-0">
                        Importe extratos do Odoo e vincule com títulos a receber
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('financeiro.contas_receber_hub') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <div class="stat-badge">{{ total_lotes }}</div>
                    <div>Extratos Importados</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <div class="stat-badge">{{ lotes_pendentes }}</div>
                    <div>Aguardando Aprovação</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <div class="stat-badge">{{ statements|selectattr('pendentes_odoo', 'gt', 0)|rejectattr('importado')|list|length }}</div>
                    <div>Extratos com Pendências</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <div class="stat-badge">{{ statements|sum(attribute='pendentes_odoo') }}</div>
                    <div>Recebimentos no Odoo</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Coluna Esquerda: Statements do Odoo -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice me-2"></i>
                        Extratos no Odoo (account.bank.statement)
                    </h5>
                    <!-- Filtro por Journal -->
                    <div class="d-flex align-items-center">
                        <select id="filterJournal" class="form-select form-select-sm" style="width: auto;">
                            <option value="">Todos os Journals</option>
                            {% for j in journals %}
                            <option value="{{ j.code }}" {{ 'selected' if journal_filter == j.code else '' }}>
                                {{ j.code }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="statementsTable">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAll" class="form-check-input"
                                               title="Selecionar todos não importados">
                                    </th>
                                    <th>Extrato</th>
                                    <th>Journal</th>
                                    <th>Data</th>
                                    <th class="text-center">Pendentes</th>
                                    <th class="text-center">Status</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for st in statements %}
                                {% if st.pendentes_odoo > 0 or st.importado %}
                                <tr class="statement-row {{ 'importado' if st.importado else '' }}"
                                    data-statement-id="{{ st.statement_id }}"
                                    data-importado="{{ 'true' if st.importado else 'false' }}">
                                    <td>
                                        {% if not st.importado and st.pendentes_odoo > 0 %}
                                        <input type="checkbox" class="form-check-input statement-checkbox"
                                               value="{{ st.statement_id }}"
                                               data-pendentes="{{ st.pendentes_odoo }}">
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ st.name }}</strong>
                                        <br><small class="text-muted">ID: {{ st.statement_id }}</small>
                                    </td>
                                    <td>
                                        <code>{{ st.journal_code }}</code>
                                        <br><small class="text-muted">{{ st.company[:15] }}</small>
                                    </td>
                                    <td>{{ st.date }}</td>
                                    <td class="text-center">
                                        {% if st.pendentes_odoo > 0 %}
                                        <span class="badge bg-warning text-dark">{{ st.pendentes_odoo }}</span>
                                        {% else %}
                                        <span class="badge bg-success">0</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if st.importado %}
                                        <span class="badge
                                            {% if st.lote_status == 'CONCLUIDO' %}bg-success
                                            {% elif st.lote_status == 'ERRO' %}bg-danger
                                            {% elif st.lote_status == 'AGUARDANDO_APROVACAO' %}bg-warning text-dark
                                            {% else %}bg-info{% endif %}">
                                            {{ st.lote_status }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">Não importado</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if st.importado %}
                                        <a href="{{ url_for('financeiro.extrato_lote_detalhe', lote_id=st.lote_id) }}"
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> Ver
                                        </a>
                                        {% elif st.pendentes_odoo > 0 %}
                                        <form action="{{ url_for('financeiro.extrato_importar_statement', statement_id=st.statement_id) }}"
                                              method="POST" style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-primary">
                                                <i class="fas fa-download"></i> Importar
                                            </button>
                                        </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <p>Nenhum extrato com pendências encontrado</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Barra de ações em lote -->
                    <div class="bulk-actions" id="bulkActions">
                        <div class="d-flex justify-content-between align-items-center w-100 text-white">
                            <div>
                                <strong><span id="selectedCount">0</span></strong> extratos selecionados
                                (<span id="selectedPendentes">0</span> linhas)
                            </div>
                            <div>
                                <button type="button" class="btn btn-light btn-sm me-2" onclick="clearSelection()">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                                <button type="button" class="btn btn-success" onclick="importarSelecionados()">
                                    <i class="fas fa-download me-2"></i>
                                    Importar Selecionados
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coluna Direita: Últimos Lotes e Fluxo -->
        <div class="col-md-4">
            <!-- Últimos Lotes -->
            <div class="card hub-card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Importações Recentes
                    </h5>
                    <div>
                        <button id="btnVerLotesSelecionados" class="btn btn-sm btn-success me-1" style="display:none;"
                                onclick="verLotesSelecionados()">
                            <i class="fas fa-eye me-1"></i>Ver <span id="countLotesSelecionados">0</span>
                        </button>
                        <a href="{{ url_for('financeiro.extrato_lotes') }}" class="btn btn-sm btn-outline-light">
                            Ver Todos
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if ultimos_lotes %}
                    <div class="list-group list-group-flush">
                        {% for lote in ultimos_lotes %}
                        <div class="list-group-item d-flex align-items-start">
                            <input type="checkbox" class="form-check-input me-2 lote-checkbox"
                                   value="{{ lote.id }}" data-nome="{{ lote.nome }}"
                                   style="margin-top:5px;" onchange="updateLotesSelecionados()">
                            <a href="{{ url_for('financeiro.extrato_lote_detalhe', lote_id=lote.id) }}"
                               class="flex-grow-1 text-decoration-none">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1 text-dark">
                                            <i class="fas fa-folder me-2 text-primary"></i>
                                            {{ lote.nome[:30] }}
                                        </h6>
                                        <small class="text-muted">
                                            {{ lote.criado_em.strftime('%d/%m/%Y %H:%M') }}
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge
                                            {% if lote.status == 'CONCLUIDO' %}bg-success
                                            {% elif lote.status == 'ERRO' %}bg-danger
                                            {% elif lote.status == 'CONCILIANDO' %}bg-info
                                            {% elif lote.status == 'AGUARDANDO_APROVACAO' %}bg-warning text-dark
                                            {% else %}bg-secondary{% endif %}">
                                            {{ lote.status }}
                                        </span>
                                        <div class="mt-1">
                                            <small class="text-muted">{{ lote.total_linhas }} linhas</small>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Nenhum extrato importado ainda</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Fluxo -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-project-diagram me-2"></i>
                        Fluxo de Conciliação
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-primary rounded-pill me-3">1</span>
                            <span><strong>Importar</strong> - Extrato do Odoo</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-info rounded-pill me-3">2</span>
                            <span><strong>Matching</strong> - Identificar títulos</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-warning text-dark rounded-pill me-3">3</span>
                            <span><strong>Aprovar</strong> - Validar matches</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-success rounded-pill me-3">4</span>
                            <span><strong>Conciliar</strong> - Executar no Odoo</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Filtro por journal
document.getElementById('filterJournal').addEventListener('change', function() {
    const journal = this.value;
    const url = new URL(window.location);
    if (journal) {
        url.searchParams.set('journal', journal);
    } else {
        url.searchParams.delete('journal');
    }
    window.location = url;
});

// Seleção de checkboxes
const selectAllCheckbox = document.getElementById('selectAll');
const checkboxes = document.querySelectorAll('.statement-checkbox');
const bulkActions = document.getElementById('bulkActions');
const selectedCountEl = document.getElementById('selectedCount');
const selectedPendentesEl = document.getElementById('selectedPendentes');

function updateBulkActions() {
    const selected = document.querySelectorAll('.statement-checkbox:checked');
    const count = selected.length;
    let pendentes = 0;

    selected.forEach(cb => {
        pendentes += parseInt(cb.dataset.pendentes || 0);
    });

    selectedCountEl.textContent = count;
    selectedPendentesEl.textContent = pendentes;

    if (count > 0) {
        bulkActions.classList.add('show');
    } else {
        bulkActions.classList.remove('show');
    }

    // Atualizar visual das linhas
    document.querySelectorAll('.statement-row').forEach(row => {
        const cb = row.querySelector('.statement-checkbox');
        if (cb && cb.checked) {
            row.classList.add('selected');
        } else {
            row.classList.remove('selected');
        }
    });
}

// Select all
selectAllCheckbox?.addEventListener('change', function() {
    checkboxes.forEach(cb => {
        cb.checked = this.checked;
    });
    updateBulkActions();
});

// Individual checkboxes
checkboxes.forEach(cb => {
    cb.addEventListener('change', updateBulkActions);
});

function clearSelection() {
    checkboxes.forEach(cb => cb.checked = false);
    if (selectAllCheckbox) selectAllCheckbox.checked = false;
    updateBulkActions();
}

function importarSelecionados() {
    const selected = document.querySelectorAll('.statement-checkbox:checked');
    const statementIds = Array.from(selected).map(cb => cb.value);

    if (statementIds.length === 0) {
        alert('Nenhum extrato selecionado');
        return;
    }

    if (!confirm(`Importar ${statementIds.length} extrato(s)?`)) {
        return;
    }

    // Desabilitar botão e mostrar loading
    const btn = document.querySelector('.bulk-actions .btn-success');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Importando...';

    // Enviar requisição
    fetch('{{ url_for("financeiro.extrato_importar_multiplos") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ statement_ids: statementIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Importação concluída!\n\n${data.importados} extratos importados\n${data.total_linhas} linhas no total`);
            window.location.reload();
        } else {
            alert('Erro: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        alert('Erro na requisição: ' + error);
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// =============================================
// Seleção de múltiplos lotes importados
// =============================================
function updateLotesSelecionados() {
    const selected = document.querySelectorAll('.lote-checkbox:checked');
    const count = selected.length;
    const btn = document.getElementById('btnVerLotesSelecionados');
    const countSpan = document.getElementById('countLotesSelecionados');

    countSpan.textContent = count;

    if (count > 0) {
        btn.style.display = 'inline-block';
    } else {
        btn.style.display = 'none';
    }
}

function verLotesSelecionados() {
    const selected = document.querySelectorAll('.lote-checkbox:checked');
    const loteIds = Array.from(selected).map(cb => cb.value);

    if (loteIds.length === 0) {
        alert('Nenhum lote selecionado');
        return;
    }

    // Redirecionar para a página de visualização de múltiplos lotes
    window.location.href = '{{ url_for("financeiro.extrato_lotes_detalhe") }}?lotes=' + loteIds.join(',');
}
</script>
{% endblock %}
