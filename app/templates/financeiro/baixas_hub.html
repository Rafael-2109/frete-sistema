{% extends "base.html" %}

{% block title %}Baixa de Titulos via Excel{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/financeiro/extrato.css') }}">
<style>
/* Estilos específicos para baixas que complementam o design system */
.row-inactive { opacity: 0.5; }
.row-sucesso td { background: var(--fin-bg-success) !important; }
.row-erro td { background: var(--fin-bg-danger) !important; }
.row-processando td { background: var(--fin-bg-warning) !important; }

.warning-duplicidade {
    color: var(--fin-accent-warning);
    font-size: 0.75rem;
}

/* ================================================================== */
/* PAINEL DE PROGRESSO DO JOB */
/* ================================================================== */
.fin-job-progress {
    background: var(--fin-bg-secondary);
    border: 1px solid var(--fin-border);
    border-radius: 8px;
    margin-bottom: 1.5rem;
    overflow: hidden;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fin-job-progress__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: linear-gradient(90deg, var(--fin-accent-primary), var(--fin-accent-success));
    color: white;
}

.fin-job-progress__title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 600;
    font-size: 0.95rem;
}

.fin-job-progress__title i {
    font-size: 1.1rem;
}

.fin-job-progress__actions {
    display: flex;
    gap: 0.25rem;
}

.fin-job-progress__actions .fin-btn {
    color: white;
    opacity: 0.8;
}

.fin-job-progress__actions .fin-btn:hover {
    opacity: 1;
}

.fin-job-progress__body {
    padding: 1rem;
}

.fin-job-progress__bar {
    height: 8px;
    background: var(--fin-bg-tertiary);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.fin-job-progress__bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--fin-accent-primary), var(--fin-accent-success));
    border-radius: 4px;
    transition: width 0.3s ease;
    position: relative;
}

.fin-job-progress__bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.fin-job-progress__stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
}

.fin-job-progress__stat {
    text-align: center;
    padding: 0.5rem;
    background: var(--fin-bg-tertiary);
    border-radius: 6px;
}

.fin-job-progress__stat-value {
    display: block;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--fin-text-primary);
}

.fin-job-progress__stat-label {
    display: block;
    font-size: 0.7rem;
    text-transform: uppercase;
    color: var(--fin-text-muted);
    letter-spacing: 0.5px;
}

.fin-job-progress__stat--success .fin-job-progress__stat-value {
    color: var(--fin-accent-success);
}

.fin-job-progress__stat--danger .fin-job-progress__stat-value {
    color: var(--fin-accent-danger);
}

.fin-job-progress__item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--fin-bg-tertiary);
    border-radius: 6px;
    font-size: 0.85rem;
    color: var(--fin-text-secondary);
}

.fin-job-progress__item i {
    color: var(--fin-accent-primary);
}

/* Estado minimizado */
.fin-job-progress.minimized .fin-job-progress__body {
    display: none;
}

/* Estado concluido */
.fin-job-progress.completed .fin-job-progress__header {
    background: linear-gradient(90deg, var(--fin-accent-success), #28a745);
}

.fin-job-progress.completed .fin-job-progress__bar-fill::after {
    animation: none;
}

/* Estado com erro */
.fin-job-progress.has-errors .fin-job-progress__header {
    background: linear-gradient(90deg, var(--fin-accent-warning), #e36209);
}

/* Responsivo */
@media (max-width: 768px) {
    .fin-job-progress__stats {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="fin-container premium-page">
    <!-- ================================================================== -->
    <!-- HEADER -->
    <!-- ================================================================== -->
    <header class="fin-header reveal">
        <div>
            <nav class="fin-breadcrumb">
                <a href="{{ url_for('financeiro.contas_receber_hub') }}" class="fin-breadcrumb__item">
                    <i class="fas fa-wallet"></i> Contas a Receber
                </a>
                <span class="fin-breadcrumb__separator">/</span>
                <span class="fin-breadcrumb__current">Baixa de Titulos</span>
            </nav>
            <h1 class="fin-header__title">
                <i class="fas fa-file-invoice-dollar"></i>
                Baixa de Titulos via Excel
            </h1>
            <p class="fin-header__subtitle">
                Gerencie baixas importadas e processe no Odoo
            </p>
        </div>
        <div class="fin-header__actions">
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                <i class="fas fa-sun theme-toggle__icon theme-toggle__icon--light"></i>
                <i class="fas fa-moon theme-toggle__icon theme-toggle__icon--dark"></i>
            </button>
            <a href="{{ url_for('financeiro.baixas_download_template') }}" class="fin-btn fin-btn--ghost">
                <i class="fas fa-download"></i> Template
            </a>
            <button class="fin-btn fin-btn--success" data-bs-toggle="modal" data-bs-target="#modalImportar">
                <i class="fas fa-upload"></i> Nova Importacao
            </button>
        </div>
    </header>

    <!-- ================================================================== -->
    <!-- PAINEL DE PROGRESSO DO JOB -->
    <!-- ================================================================== -->
    <div class="fin-job-progress" id="jobProgressPanel" style="display: none;">
        <div class="fin-job-progress__header">
            <div class="fin-job-progress__title">
                <i class="fas fa-cog fa-spin" id="jobProgressIcon"></i>
                <span id="jobProgressTitle">Processando baixas...</span>
            </div>
            <div class="fin-job-progress__actions">
                <button class="fin-btn fin-btn--ghost fin-btn--sm" onclick="toggleJobProgressMinimize()" title="Minimizar">
                    <i class="fas fa-minus" id="minimizeIcon"></i>
                </button>
                <button class="fin-btn fin-btn--ghost fin-btn--sm" onclick="closeJobProgress()" title="Fechar" id="btnCloseProgress" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="fin-job-progress__body" id="jobProgressBody">
            <div class="fin-job-progress__bar">
                <div class="fin-job-progress__bar-fill" id="jobProgressFill" style="width: 0%;"></div>
            </div>
            <div class="fin-job-progress__stats">
                <div class="fin-job-progress__stat">
                    <span class="fin-job-progress__stat-value" id="jobProgressPercent">0%</span>
                    <span class="fin-job-progress__stat-label">Progresso</span>
                </div>
                <div class="fin-job-progress__stat">
                    <span class="fin-job-progress__stat-value" id="jobProgressProcessados">0/0</span>
                    <span class="fin-job-progress__stat-label">Processados</span>
                </div>
                <div class="fin-job-progress__stat fin-job-progress__stat--success">
                    <span class="fin-job-progress__stat-value" id="jobProgressSucesso">0</span>
                    <span class="fin-job-progress__stat-label">Sucesso</span>
                </div>
                <div class="fin-job-progress__stat fin-job-progress__stat--danger">
                    <span class="fin-job-progress__stat-value" id="jobProgressErro">0</span>
                    <span class="fin-job-progress__stat-label">Erro</span>
                </div>
            </div>
            <div class="fin-job-progress__item" id="jobProgressItem">
                <i class="fas fa-spinner fa-spin"></i>
                <span id="jobProgressItemText">Aguardando...</span>
            </div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- STATS CARDS -->
    <!-- ================================================================== -->
    <div class="fin-stats">
        <div class="fin-stat-card fin-stat-card--primary">
            <div class="fin-stat-card__value" id="statTotal">{{ stats.total }}</div>
            <div class="fin-stat-card__label">Total</div>
        </div>
        <div class="fin-stat-card fin-stat-card--warning">
            <div class="fin-stat-card__value" id="statPendentes">{{ stats.pendentes }}</div>
            <div class="fin-stat-card__label">Pendentes</div>
        </div>
        <div class="fin-stat-card fin-stat-card--info">
            <div class="fin-stat-card__value" id="statValidos">{{ stats.validos }}</div>
            <div class="fin-stat-card__label">Validos</div>
        </div>
        <div class="fin-stat-card fin-stat-card--danger">
            <div class="fin-stat-card__value" id="statInvalidos">{{ stats.invalidos }}</div>
            <div class="fin-stat-card__label">Invalidos</div>
        </div>
        <div class="fin-stat-card fin-stat-card--success">
            <div class="fin-stat-card__value" id="statSucesso">{{ stats.sucesso }}</div>
            <div class="fin-stat-card__label">Sucesso</div>
        </div>
        <div class="fin-stat-card" style="--stat-color: #cf222e;">
            <div class="fin-stat-card__value" id="statErro">{{ stats.erro }}</div>
            <div class="fin-stat-card__label">Erro</div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- FILTROS -->
    <!-- ================================================================== -->
    <div class="fin-filters">
        <div class="fin-filters__grid">
            <div class="fin-filter-group">
                <label class="fin-filter-group__label">Lote</label>
                <select class="fin-filter-group__input fin-filter-group__select" id="filtroLote">
                    <option value="">Todos os lotes</option>
                    {% for lote in lotes %}
                    <option value="{{ lote.id }}" {% if filtro_lote == lote.id %}selected{% endif %}>
                        #{{ lote.id }} - {{ lote.nome_arquivo[:20] }}...
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="fin-filter-group">
                <label class="fin-filter-group__label">Status</label>
                <select class="fin-filter-group__input fin-filter-group__select" id="filtroStatus">
                    <option value="">Todos</option>
                    <option value="PENDENTE" {% if filtro_status == 'PENDENTE' %}selected{% endif %}>Pendente</option>
                    <option value="VALIDO" {% if filtro_status == 'VALIDO' %}selected{% endif %}>Valido</option>
                    <option value="INVALIDO" {% if filtro_status == 'INVALIDO' %}selected{% endif %}>Invalido</option>
                    <option value="SUCESSO" {% if filtro_status == 'SUCESSO' %}selected{% endif %}>Sucesso</option>
                    <option value="ERRO" {% if filtro_status == 'ERRO' %}selected{% endif %}>Erro</option>
                </select>
            </div>

            <div class="fin-filter-group">
                <label class="fin-filter-group__label">Ativo</label>
                <select class="fin-filter-group__input fin-filter-group__select" id="filtroAtivo">
                    <option value="">Todos</option>
                    <option value="1" {% if filtro_ativo == '1' %}selected{% endif %}>Ativos</option>
                    <option value="0" {% if filtro_ativo == '0' %}selected{% endif %}>Inativos</option>
                </select>
            </div>

            <div class="fin-filter-group">
                <label class="fin-filter-group__label">Buscar NF</label>
                <input type="text" class="fin-filter-group__input" id="filtroNF"
                       placeholder="Numero da NF..." value="{{ filtro_nf or '' }}">
            </div>

            <div class="fin-filter-group">
                <label class="fin-filter-group__label">&nbsp;</label>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="fin-btn fin-btn--primary" onclick="aplicarFiltros()">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                    <button class="fin-btn fin-btn--ghost" onclick="limparFiltros()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- TABELA PRINCIPAL -->
    <!-- ================================================================== -->
    <div class="fin-section">
        <div class="fin-section__header">
            <h2 class="fin-section__title">
                <i class="fas fa-list"></i>
                Itens Importados
                <span class="fin-section__badge">{{ itens|length }} de {{ stats.total }}</span>
            </h2>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" class="fin-checkbox" id="checkTodosPagina" onchange="togglePagina(this.checked)">
                    <span style="font-size: 0.8rem; color: var(--fin-text-secondary);">Pagina</span>
                </label>
                <button class="fin-btn fin-btn--ghost fin-btn--sm" onclick="selecionarTodos()">
                    <i class="fas fa-check-double"></i> Todos ({{ stats.total }})
                </button>
                <span style="font-size: 0.8rem; color: var(--fin-text-secondary);">
                    <strong id="countSelecionados">0</strong> selecionado(s)
                </span>
            </div>
        </div>

        <div class="fin-section__content">
            <div class="fin-table-wrapper" style="max-height: 55vh; overflow-y: auto;">
                <table class="fin-table">
                    <thead>
                        <tr>
                            <th width="40"></th>
                            <th width="50">Lote</th>
                            <th width="50">Linha</th>
                            <th>NF</th>
                            <th width="60">Parcela</th>
                            <th width="120">Valor</th>
                            <th>Journal</th>
                            <th width="100">Data</th>
                            <th width="80">Ativo</th>
                            <th width="90">Status</th>
                            <th>Mensagem</th>
                            <th width="40">Resultado</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaBody">
                        {% for item in itens %}
                        <tr class="{% if not item.ativo %}row-inactive{% endif %}
                                   {% if item.status == 'SUCESSO' %}row-sucesso{% endif %}
                                   {% if item.status == 'ERRO' %}row-erro{% endif %}
                                   {% if item.status == 'PROCESSANDO' %}row-processando{% endif %}"
                            data-id="{{ item.id }}"
                            data-status="{{ item.status }}"
                            data-ativo="{{ item.ativo|lower }}">
                            <td class="text-center">
                                <input type="checkbox" class="fin-checkbox item-check"
                                       value="{{ item.id }}"
                                       {% if item.status in ['SUCESSO', 'PROCESSANDO'] %}disabled{% endif %}
                                       onchange="atualizarSelecao()">
                            </td>
                            <td>
                                <span class="fin-badge fin-badge--muted">#{{ item.lote_id }}</span>
                            </td>
                            <td class="mono">{{ item.linha_excel }}</td>
                            <td>
                                <strong>{{ item.nf_excel }}</strong>
                                {% if item.duplicidade %}
                                <br><span class="warning-duplicidade">
                                    <i class="fas fa-exclamation-triangle"></i> Possivel duplicidade
                                </span>
                                {% endif %}
                            </td>
                            <td class="text-center mono">{{ item.parcela_excel }}</td>
                            <td class="text-end mono">
                                <strong>R$ {{ "%.2f"|format(item.valor_excel) }}</strong>
                            </td>
                            <td>
                                {{ item.journal_excel }}
                                {% if item.journal_odoo_id %}
                                <i class="fas fa-check-circle" style="color: var(--fin-accent-success);" title="Journal valido"></i>
                                {% else %}
                                <i class="fas fa-times-circle" style="color: var(--fin-accent-danger);" title="Journal nao encontrado"></i>
                                {% endif %}
                            </td>
                            <td class="mono">{{ item.data_excel.strftime('%d/%m/%Y') if item.data_excel else '-' }}</td>
                            <td class="text-center">
                                <input type="checkbox" class="fin-checkbox"
                                       id="ativo{{ item.id }}"
                                       {% if item.ativo %}checked{% endif %}
                                       {% if item.status in ['SUCESSO', 'PROCESSANDO', 'INVALIDO'] %}disabled{% endif %}
                                       onchange="toggleAtivo({{ item.id }}, this.checked)">
                            </td>
                            <td>
                                {% if item.status == 'PENDENTE' %}
                                <span class="fin-badge fin-badge--muted">PENDENTE</span>
                                {% elif item.status == 'VALIDO' %}
                                <span class="fin-badge fin-badge--success">VALIDO</span>
                                {% elif item.status == 'INVALIDO' %}
                                <span class="fin-badge fin-badge--danger">INVALIDO</span>
                                {% elif item.status == 'PROCESSANDO' %}
                                <span class="fin-badge fin-badge--warning">PROCESSANDO</span>
                                {% elif item.status == 'SUCESSO' %}
                                <span class="fin-badge fin-badge--success">SUCESSO</span>
                                {% elif item.status == 'ERRO' %}
                                <span class="fin-badge fin-badge--danger">ERRO</span>
                                {% endif %}
                            </td>
                            <td>
                                <small style="color: var(--fin-text-muted);" title="{{ item.mensagem or '' }}">
                                    {{ (item.mensagem or '-')[:100] }}{% if item.mensagem and item.mensagem|length > 100 %}...{% endif %}
                                </small>
                            </td>
                            <td>
                                {% if item.payment_odoo_name %}
                                <small style="color: var(--fin-accent-success);">
                                    <i class="fas fa-check"></i> {{ item.payment_odoo_name }}
                                </small>
                                {% elif item.status == 'ERRO' %}
                                <small style="color: var(--fin-accent-danger);">
                                    <i class="fas fa-times"></i> Falha
                                </small>
                                {% else %}
                                <small style="color: var(--fin-text-muted);">-</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="12">
                                <div class="fin-empty">
                                    <div class="fin-empty__icon"><i class="fas fa-inbox"></i></div>
                                    <div class="fin-empty__title">Nenhum item encontrado</div>
                                    <div class="fin-empty__text">
                                        <a href="#" data-bs-toggle="modal" data-bs-target="#modalImportar" class="fin-link">
                                            Importe um arquivo Excel
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Barra de Acoes Flutuante -->
<div class="fin-bulk-bar" id="actionBar">
    <div class="fin-bulk-bar__info">
        <span class="fin-bulk-bar__count" id="actionCount">0</span>
        <span>selecionado(s)</span>
    </div>
    <div class="fin-bulk-bar__actions">
        <button class="fin-btn fin-btn--success" onclick="processarSelecionados()">
            <i class="fas fa-play"></i> Processar no Odoo
        </button>
        <button class="fin-btn fin-btn--ghost" onclick="ativarSelecionados(true)">
            <i class="fas fa-toggle-on"></i> Ativar
        </button>
        <button class="fin-btn fin-btn--ghost" onclick="ativarSelecionados(false)">
            <i class="fas fa-toggle-off"></i> Inativar
        </button>
        <button class="fin-btn fin-btn--ghost" onclick="limparSelecao()">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<!-- Modal Importar -->
<div class="modal fade" id="modalImportar" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--fin-bg-secondary); color: var(--fin-text-primary); border: 1px solid var(--fin-border);">
            <div class="modal-header" style="border-color: var(--fin-border);">
                <h5 class="modal-title">
                    <i class="fas fa-upload"></i>
                    Importar Arquivo Excel
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: var(--fin-text-primary) == '#f0f6fc' ? invert(1) : none;"></button>
            </div>
            <div class="modal-body">
                <div class="fin-alert fin-alert--info" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Formato esperado:</strong><br>
                        <code style="background: var(--fin-bg-tertiary); padding: 0.25rem 0.5rem; border-radius: 4px;">NF | PARCELA | VALOR | JOURNAL | DATA</code>
                        <br><br>
                        <a href="{{ url_for('financeiro.baixas_download_template') }}" class="fin-link">
                            <i class="fas fa-download"></i> Baixar modelo Excel
                        </a>
                    </div>
                </div>

                <div class="fin-upload-zone" id="uploadZone">
                    <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
                    <div class="fin-upload-zone__icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <h5 style="margin-bottom: 0.5rem;">Arraste o arquivo aqui</h5>
                    <p style="color: var(--fin-text-muted); margin: 0;">ou clique para selecionar</p>
                </div>

                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="fin-progress">
                        <div class="fin-progress__bar" style="flex: 1;">
                            <div class="fin-progress__fill" style="width: 100%; animation: fin-progress-pulse 1s ease-in-out infinite;"></div>
                        </div>
                    </div>
                    <small style="color: var(--fin-text-muted);">Processando arquivo...</small>
                </div>

                <div id="uploadResultado" class="mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer" style="border-color: var(--fin-border);">
                <button type="button" class="fin-btn fin-btn--ghost" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmacao -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--fin-bg-secondary); color: var(--fin-text-primary); border: 1px solid var(--fin-border);">
            <div class="modal-header" style="background: var(--fin-bg-warning); border-color: var(--fin-border);">
                <h5 class="modal-title" style="color: var(--fin-accent-warning);">
                    <i class="fas fa-exclamation-triangle"></i>
                    Confirmar Processamento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Voce esta prestes a processar <strong id="confirmQtd">0</strong> baixa(s) no Odoo.</p>
                <div class="fin-alert fin-alert--warning">
                    <i class="fas fa-exclamation-circle"></i>
                    <span><strong>Atencao:</strong> Esta acao criara pagamentos no Odoo e nao pode ser desfeita facilmente.</span>
                </div>
                <p style="margin: 0;">Deseja continuar?</p>
            </div>
            <div class="modal-footer" style="border-color: var(--fin-border);">
                <button type="button" class="fin-btn fin-btn--ghost" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="fin-btn fin-btn--success" id="btnConfirmarProcessar">
                    <i class="fas fa-play"></i> Sim, Processar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/financeiro/extrato.js') }}"></script>
<script>
// Estado global
let itensSelecionados = new Set();
let todosIds = {{ todos_ids|tojson|default('[]') }};
let jobPollingInterval = null;
let currentJobId = null;

document.addEventListener('DOMContentLoaded', function() {
    setupUploadZone();
    setupFiltros();
    checkPendingJob();
});

// ================================================================
// GERENCIAMENTO DE JOB E PROGRESSO
// ================================================================

function checkPendingJob() {
    // Verificar se há um job em andamento salvo no localStorage
    const savedJob = localStorage.getItem('baixa_job_id');
    if (savedJob) {
        currentJobId = savedJob;
        showJobProgress();
        startJobPolling();
    }
}

function showJobProgress() {
    document.getElementById('jobProgressPanel').style.display = 'block';
}

function hideJobProgress() {
    document.getElementById('jobProgressPanel').style.display = 'none';
}

function toggleJobProgressMinimize() {
    const panel = document.getElementById('jobProgressPanel');
    const icon = document.getElementById('minimizeIcon');
    panel.classList.toggle('minimized');
    icon.classList.toggle('fa-minus');
    icon.classList.toggle('fa-expand');
}

function closeJobProgress() {
    hideJobProgress();
    stopJobPolling();
    localStorage.removeItem('baixa_job_id');
    currentJobId = null;
}

function startJobPolling() {
    if (jobPollingInterval) clearInterval(jobPollingInterval);

    // Polling a cada 2 segundos
    jobPollingInterval = setInterval(pollJobStatus, 2000);
    // Executar imediatamente
    pollJobStatus();
}

function stopJobPolling() {
    if (jobPollingInterval) {
        clearInterval(jobPollingInterval);
        jobPollingInterval = null;
    }
}

function pollJobStatus() {
    if (!currentJobId) return;

    fetch(`/financeiro/contas-receber/baixas/job/${currentJobId}/status`)
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            console.error('Erro ao buscar status:', data.error);
            return;
        }

        updateJobProgressUI(data);

        // Verificar se o job terminou
        if (data.status === 'finished' || data.status === 'failed') {
            stopJobPolling();
            onJobCompleted(data);
        }
    })
    .catch(err => {
        console.error('Erro no polling:', err);
    });
}

function updateJobProgressUI(data) {
    const panel = document.getElementById('jobProgressPanel');
    const progresso = data.progresso || {};

    // Calcular progresso
    const total = progresso.total_itens || data.result?.total_itens || 0;
    const processados = progresso.itens_processados || data.result?.total_itens || 0;
    const sucesso = progresso.itens_sucesso || data.result?.itens_sucesso || 0;
    const erro = progresso.itens_erro || data.result?.itens_erro || 0;
    const itemAtual = progresso.item_atual || 'Processando...';

    const percent = total > 0 ? Math.round((processados / total) * 100) : 0;

    // Atualizar UI
    document.getElementById('jobProgressFill').style.width = `${percent}%`;
    document.getElementById('jobProgressPercent').textContent = `${percent}%`;
    document.getElementById('jobProgressProcessados').textContent = `${processados}/${total}`;
    document.getElementById('jobProgressSucesso').textContent = sucesso;
    document.getElementById('jobProgressErro').textContent = erro;
    document.getElementById('jobProgressItemText').textContent = itemAtual;

    // Atualizar título baseado no status
    const statusMap = {
        'queued': 'Aguardando na fila...',
        'started': 'Processando baixas...',
        'finished': 'Processamento concluido!',
        'failed': 'Erro no processamento'
    };
    document.getElementById('jobProgressTitle').textContent = statusMap[data.status] || 'Processando...';

    // Atualizar classes do painel
    panel.classList.remove('completed', 'has-errors');
    if (data.status === 'finished') {
        panel.classList.add('completed');
        if (erro > 0) panel.classList.add('has-errors');
    }

    // Atualizar icone
    const icon = document.getElementById('jobProgressIcon');
    if (data.status === 'finished') {
        icon.classList.remove('fa-cog', 'fa-spin');
        icon.classList.add('fa-check-circle');
    } else if (data.status === 'failed') {
        icon.classList.remove('fa-cog', 'fa-spin');
        icon.classList.add('fa-times-circle');
    }
}

function onJobCompleted(data) {
    const result = data.result || {};
    const sucesso = result.itens_sucesso || 0;
    const erro = result.itens_erro || 0;

    // Mostrar botao de fechar
    document.getElementById('btnCloseProgress').style.display = 'inline-flex';

    // Atualizar item atual
    document.getElementById('jobProgressItem').innerHTML = `
        <i class="fas fa-flag-checkered"></i>
        <span>Finalizado! Sucesso: ${sucesso} | Erro: ${erro}</span>
    `;

    // Notificacao
    if (erro > 0) {
        toastr.warning(`Processamento concluido com ${erro} erro(s)`);
    } else {
        toastr.success(`${sucesso} baixa(s) processada(s) com sucesso!`);
    }

    // Recarregar pagina apos 3 segundos para atualizar a tabela
    setTimeout(() => {
        localStorage.removeItem('baixa_job_id');
        location.reload();
    }, 3000);
}

function setupUploadZone() {
    const zone = document.getElementById('uploadZone');
    const input = document.getElementById('fileInput');

    zone.addEventListener('click', () => input.click());
    zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) uploadFile(e.dataTransfer.files[0]);
    });
    input.addEventListener('change', () => { if (input.files.length > 0) uploadFile(input.files[0]); });
}

function uploadFile(file) {
    if (!file.name.endsWith('.xlsx')) { toastr.error('Arquivo deve ser .xlsx'); return; }

    const formData = new FormData();
    formData.append('arquivo', file);

    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('uploadResultado').style.display = 'none';

    fetch("{{ url_for('financeiro.baixas_upload') }}", { method: 'POST', body: formData })
    .then(r => r.json())
    .then(data => {
        document.getElementById('uploadProgress').style.display = 'none';
        const resultado = document.getElementById('uploadResultado');
        resultado.style.display = 'block';

        if (data.success) {
            resultado.innerHTML = `<div class="fin-alert fin-alert--success"><i class="fas fa-check-circle"></i>
                <span><strong>Importacao concluida!</strong> ${data.linhas_validas} validas, ${data.linhas_invalidas} invalidas.</span></div>`;
            toastr.success('Arquivo importado!');
            setTimeout(() => location.reload(), 2000);
        } else {
            resultado.innerHTML = `<div class="fin-alert fin-alert--danger"><i class="fas fa-times-circle"></i> <span>${data.error}</span></div>`;
            toastr.error(data.error);
        }
    })
    .catch(error => {
        document.getElementById('uploadProgress').style.display = 'none';
        toastr.error('Erro ao enviar arquivo');
    });
}

function setupFiltros() {
    document.getElementById('filtroNF').addEventListener('keypress', function(e) { if (e.key === 'Enter') aplicarFiltros(); });
}

function aplicarFiltros() {
    const params = new URLSearchParams();
    const lote = document.getElementById('filtroLote').value;
    const status = document.getElementById('filtroStatus').value;
    const ativo = document.getElementById('filtroAtivo').value;
    const nf = document.getElementById('filtroNF').value;
    if (lote) params.set('lote', lote);
    if (status) params.set('status', status);
    if (ativo) params.set('ativo', ativo);
    if (nf) params.set('nf', nf);
    window.location.href = "{{ url_for('financeiro.baixas_hub') }}?" + params.toString();
}

function limparFiltros() { window.location.href = "{{ url_for('financeiro.baixas_hub') }}"; }

function togglePagina(checked) {
    document.querySelectorAll('.item-check:not(:disabled)').forEach(cb => {
        cb.checked = checked;
        if (checked) itensSelecionados.add(parseInt(cb.value));
        else itensSelecionados.delete(parseInt(cb.value));
    });
    atualizarSelecao();
}

function selecionarTodos() {
    todosIds.forEach(id => itensSelecionados.add(id));
    document.querySelectorAll('.item-check:not(:disabled)').forEach(cb => cb.checked = true);
    atualizarSelecao();
    toastr.info(`${itensSelecionados.size} itens selecionados`);
}

function limparSelecao() {
    itensSelecionados.clear();
    document.querySelectorAll('.item-check').forEach(cb => cb.checked = false);
    document.getElementById('checkTodosPagina').checked = false;
    atualizarSelecao();
}

function atualizarSelecao() {
    document.querySelectorAll('.item-check').forEach(cb => {
        const id = parseInt(cb.value);
        if (cb.checked) itensSelecionados.add(id);
        else itensSelecionados.delete(id);
    });
    const count = itensSelecionados.size;
    document.getElementById('countSelecionados').textContent = count;
    document.getElementById('actionCount').textContent = count;
    document.getElementById('actionBar').classList.toggle('visible', count > 0);
}

function toggleAtivo(itemId, ativo) {
    fetch(`{{ url_for('financeiro.baixas_toggle_item', item_id=0) }}`.replace('/0/', `/${itemId}/`), {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ativo: ativo })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const row = document.querySelector(`tr[data-id="${itemId}"]`);
            if (row) row.classList.toggle('row-inactive', !ativo);
            toastr.success(ativo ? 'Item ativado' : 'Item inativado');
        } else {
            toastr.error(data.error);
            document.getElementById(`ativo${itemId}`).checked = !ativo;
        }
    });
}

function ativarSelecionados(ativo) {
    if (itensSelecionados.size === 0) return;
    fetch("{{ url_for('financeiro.baixas_ativar_lote') }}", {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: Array.from(itensSelecionados), ativo: ativo })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) { toastr.success(`${data.atualizados} itens atualizados`); setTimeout(() => location.reload(), 1000); }
        else toastr.error(data.error);
    });
}

function processarSelecionados() {
    if (itensSelecionados.size === 0) { toastr.warning('Nenhum item selecionado'); return; }
    document.getElementById('confirmQtd').textContent = itensSelecionados.size;
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmacao'));
    modal.show();
    document.getElementById('btnConfirmarProcessar').onclick = function() { modal.hide(); executarProcessamento(); };
}

function executarProcessamento() {
    const ids = Array.from(itensSelecionados);

    // Mostrar painel de progresso imediatamente
    document.getElementById('jobProgressPercent').textContent = '0%';
    document.getElementById('jobProgressProcessados').textContent = `0/${ids.length}`;
    document.getElementById('jobProgressSucesso').textContent = '0';
    document.getElementById('jobProgressErro').textContent = '0';
    document.getElementById('jobProgressItemText').textContent = 'Enfileirando job...';
    document.getElementById('jobProgressIcon').className = 'fas fa-cog fa-spin';
    document.getElementById('jobProgressTitle').textContent = 'Iniciando processamento...';
    document.getElementById('jobProgressPanel').classList.remove('completed', 'has-errors');
    document.getElementById('btnCloseProgress').style.display = 'none';
    showJobProgress();

    // Limpar selecao
    limparSelecao();

    fetch("{{ url_for('financeiro.baixas_processar_itens') }}", {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ids: ids })
    })
    .then(r => {
        if (!r.ok && r.status === 409) {
            // Conflito - itens ja em processamento
            return r.json().then(data => {
                throw new Error(data.error || 'Itens ja estao sendo processados');
            });
        }
        return r.json();
    })
    .then(data => {
        if (data.success) {
            // Salvar job_id e iniciar polling
            currentJobId = data.job_id;
            localStorage.setItem('baixa_job_id', data.job_id);
            toastr.info(`${data.total_itens} itens enfileirados para processamento`);
            startJobPolling();
        } else {
            hideJobProgress();
            toastr.error(data.error || 'Erro desconhecido');
        }
    })
    .catch((err) => {
        hideJobProgress();
        toastr.error(err.message || 'Erro ao enfileirar processamento');
        console.error('Erro no processamento:', err);
    });
}
</script>
{% endblock %}
