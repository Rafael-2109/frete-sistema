{% extends "base.html" %}

{% block title %}Lote {{ lote.id }} - Extrato - Financeiro{% endblock %}

{% block extra_css %}
{# Bootstrap overrides + Module CSS #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-overrides.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/financeiro/extrato.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid fin-container py-4">
    {# === HEADER === #}
    <div class="row">
        <div class="col-12">
            <header class="fin-header d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4 pb-3">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item">
                                <a href="{{ url_for('financeiro.extrato_hub') }}">Extrato</a>
                            </li>
                            <li class="breadcrumb-item active">Lote {{ lote.id }}</li>
                        </ol>
                    </nav>
                    <h1 class="fin-header__title h3 fw-bold mb-1">
                        <i class="fas fa-file-invoice me-2 text-primary"></i>
                        {{ lote.nome }}
                    </h1>
                    <p class="fin-header__subtitle text-secondary mb-0">
                        <i class="fas fa-calendar me-1"></i>
                        {{ lote.criado_em.strftime('%d/%m/%Y %H:%M') }}
                        {% if lote.criado_por %} | {{ lote.criado_por }}{% endif %}
                        |
                        <span class="badge
                            {% if lote.status == 'CONCLUIDO' %}bg-success
                            {% elif lote.status == 'ERRO' %}bg-danger
                            {% elif lote.status == 'CONCILIANDO' %}bg-info
                            {% elif lote.status == 'AGUARDANDO_APROVACAO' %}bg-warning
                            {% else %}bg-secondary{% endif %}">
                            {{ lote.status }}
                        </span>
                    </p>
                </div>
                <div class="fin-header__actions d-flex gap-2 flex-wrap">
                    <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                        <i class="fas fa-sun theme-toggle__icon theme-toggle__icon--light"></i>
                        <i class="fas fa-moon theme-toggle__icon theme-toggle__icon--dark"></i>
                    </button>

                    {% if lote.status not in ['CONCLUIDO'] %}
                    <button class="btn btn-primary" onclick="executarMatching()" id="btnMatching">
                        <i class="fas fa-magic me-2"></i>Executar Matching
                    </button>
                    {% endif %}

                    {% if stats.com_match > 0 and stats.aprovados < stats.com_match %}
                    <button class="btn btn-success" onclick="aprovarTodos()">
                        <i class="fas fa-check-double me-2"></i>
                        Aprovar Todos ({{ stats.com_match - stats.aprovados }})
                    </button>
                    {% endif %}

                    {% if stats.aprovados > 0 and lote.status != 'CONCLUIDO' %}
                    <button class="btn btn-warning" onclick="conciliarLote()">
                        <i class="fas fa-link me-2"></i>
                        Conciliar Aprovados ({{ stats.aprovados }})
                    </button>
                    {% endif %}

                    <a href="{{ url_for('financeiro.extrato_hub') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </a>
                </div>
            </header>
        </div>
    </div>

    {# === ESTATÍSTICAS === #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-static">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-around flex-wrap gap-3">
                        <div class="text-center">
                            <div class="h4 mb-0 font-mono fw-bold">{{ stats.total }}</div>
                            <small class="text-muted text-uppercase">Total</small>
                        </div>
                        <div class="text-center">
                            <div class="h4 mb-0 font-mono fw-bold text-success">{{ stats.com_match }}</div>
                            <small class="text-muted text-uppercase">Match Único</small>
                        </div>
                        <div class="text-center">
                            <div class="h4 mb-0 font-mono fw-bold text-warning">{{ stats.multiplos }}</div>
                            <small class="text-muted text-uppercase">Múltiplos</small>
                        </div>
                        <div class="text-center">
                            <div class="h4 mb-0 font-mono fw-bold text-danger">{{ stats.sem_match }}</div>
                            <small class="text-muted text-uppercase">Sem Match</small>
                        </div>
                        <div class="text-center">
                            <div class="h4 mb-0 font-mono fw-bold text-secondary">{{ stats.pendentes }}</div>
                            <small class="text-muted text-uppercase">Pendentes</small>
                        </div>
                        <div class="text-center">
                            <div class="h4 mb-0 font-mono fw-bold text-primary">{{ stats.aprovados }}</div>
                            <small class="text-muted text-uppercase">Aprovados</small>
                        </div>
                        <div class="text-center">
                            <div class="h4 mb-0 font-mono fw-bold text-info">{{ stats.conciliados }}</div>
                            <small class="text-muted text-uppercase">Conciliados</small>
                        </div>
                        <div class="text-center">
                            <div class="h4 mb-0 font-mono fw-bold">R$ {{ "{:,.2f}".format(lote.valor_total or 0) }}</div>
                            <small class="text-muted text-uppercase">Valor Total</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# === FILTROS === #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-static">
                <div class="card-body py-3">
                    <form method="GET" action="{{ url_for('financeiro.extrato_lote_detalhe', lote_id=lote.id) }}" id="formFiltros">
                        <div class="row g-2 align-items-end">
                            {# Filtro por Status Match #}
                            <div class="col-auto">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('financeiro.extrato_lote_detalhe', lote_id=lote.id, per_page=per_page, cnpj=filtro_cnpj, data_inicio=filtro_data_inicio, data_fim=filtro_data_fim) }}"
                                       class="btn btn-outline-secondary {{ 'active' if not request.args.get('status_match') }}">
                                        Todos
                                    </a>
                                    <a href="{{ url_for('financeiro.extrato_lote_detalhe', lote_id=lote.id, status_match='MATCH_ENCONTRADO', per_page=per_page, cnpj=filtro_cnpj, data_inicio=filtro_data_inicio, data_fim=filtro_data_fim) }}"
                                       class="btn btn-outline-success {{ 'active' if request.args.get('status_match') == 'MATCH_ENCONTRADO' }}">
                                        Match
                                    </a>
                                    <a href="{{ url_for('financeiro.extrato_lote_detalhe', lote_id=lote.id, status_match='MULTIPLOS_MATCHES', per_page=per_page, cnpj=filtro_cnpj, data_inicio=filtro_data_inicio, data_fim=filtro_data_fim) }}"
                                       class="btn btn-outline-warning {{ 'active' if request.args.get('status_match') == 'MULTIPLOS_MATCHES' }}">
                                        Múltiplos
                                    </a>
                                    <a href="{{ url_for('financeiro.extrato_lote_detalhe', lote_id=lote.id, status_match='SEM_MATCH', per_page=per_page, cnpj=filtro_cnpj, data_inicio=filtro_data_inicio, data_fim=filtro_data_fim) }}"
                                       class="btn btn-outline-danger {{ 'active' if request.args.get('status_match') == 'SEM_MATCH' }}">
                                        Sem Match
                                    </a>
                                    <a href="{{ url_for('financeiro.extrato_lote_detalhe', lote_id=lote.id, status_match='PENDENTE', per_page=per_page, cnpj=filtro_cnpj, data_inicio=filtro_data_inicio, data_fim=filtro_data_fim) }}"
                                       class="btn btn-outline-secondary {{ 'active' if request.args.get('status_match') == 'PENDENTE' }}">
                                        Pendentes
                                    </a>
                                </div>
                            </div>

                            {# Filtro por CNPJ #}
                            <div class="col-auto">
                                <label class="form-label small mb-1 text-muted">CNPJ</label>
                                <input type="text" name="cnpj" class="form-control form-control-sm" style="width:150px;"
                                       placeholder="Digite o CNPJ..." value="{{ filtro_cnpj or '' }}">
                            </div>

                            {# Filtro por Data #}
                            <div class="col-auto">
                                <label class="form-label small mb-1 text-muted">Data Início</label>
                                <input type="date" name="data_inicio" class="form-control form-control-sm"
                                       value="{{ filtro_data_inicio or '' }}">
                            </div>
                            <div class="col-auto">
                                <label class="form-label small mb-1 text-muted">Data Fim</label>
                                <input type="date" name="data_fim" class="form-control form-control-sm"
                                       value="{{ filtro_data_fim or '' }}">
                            </div>

                            {# Itens por página #}
                            <div class="col-auto">
                                <label class="form-label small mb-1 text-muted">Exibir</label>
                                <select name="per_page" class="form-select form-select-sm" style="width:90px;">
                                    <option value="10" {{ 'selected' if per_page == 10 }}>10</option>
                                    <option value="20" {{ 'selected' if per_page == 20 }}>20</option>
                                    <option value="50" {{ 'selected' if per_page == 50 }}>50</option>
                                    <option value="100" {{ 'selected' if per_page == 100 }}>100</option>
                                    <option value="0" {{ 'selected' if per_page == 0 }}>Todos</option>
                                </select>
                            </div>

                            {# Botão filtrar #}
                            <div class="col-auto">
                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="fas fa-filter me-1"></i>Filtrar
                                </button>
                                {% if filtro_cnpj or filtro_data_inicio or filtro_data_fim %}
                                <a href="{{ url_for('financeiro.extrato_lote_detalhe', lote_id=lote.id, per_page=per_page, status_match=request.args.get('status_match')) }}"
                                   class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-times"></i> Limpar
                                </a>
                                {% endif %}
                            </div>

                            {% if request.args.get('status_match') %}
                            <input type="hidden" name="status_match" value="{{ request.args.get('status_match') }}">
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# === LISTA DE ITENS === #}
    <div class="row">
        <div class="col-12">
            {% for item in itens %}
            <div class="fin-item-card
                {{ 'fin-item-card--conciliado' if item.status == 'CONCILIADO' }}
                {{ 'fin-item-card--aprovado' if item.aprovado and item.status != 'CONCILIADO' }}
                {{ 'fin-item-card--match' if item.status_match == 'MATCH_ENCONTRADO' and not item.aprovado }}
                {{ 'fin-item-card--multiplos' if item.status_match == 'MULTIPLOS_MATCHES' }}
                {{ 'fin-item-card--sem-match' if item.status_match == 'SEM_MATCH' }}"
                data-item-id="{{ item.id }}">
                <div class="row g-0">
                    {# SEÇÃO 1: EXTRATO #}
                    <div class="col-md-4 fin-item-col fin-item-col--bordered">
                        <div class="fin-section-header fin-section-header--extrato">
                            <i class="fas fa-university"></i> EXTRATO BANCÁRIO
                        </div>

                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="fin-tipo-badge fin-tipo-badge--{{ item.tipo_transacao|lower if item.tipo_transacao else 'outro' }}">
                                {{ item.tipo_transacao or 'OUTRO' }}
                            </span>
                            <div>
                                {% if item.status == 'CONCILIADO' %}
                                <span class="badge bg-info">CONCILIADO</span>
                                {% elif item.aprovado %}
                                <span class="badge bg-primary">APROVADO</span>
                                {% elif item.status_match == 'MATCH_ENCONTRADO' %}
                                <span class="badge bg-success">MATCH</span>
                                {% elif item.status_match == 'MULTIPLOS_MATCHES' %}
                                <span class="badge bg-warning">MÚLTIPLOS</span>
                                {% elif item.status_match == 'SEM_MATCH' %}
                                <span class="badge bg-danger">SEM MATCH</span>
                                {% else %}
                                <span class="badge bg-secondary">PENDENTE</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="fin-valor-grande mb-2">R$ {{ "{:,.2f}".format(item.valor) }}</div>

                        <div class="small">
                            <div class="fin-info-line">
                                <i class="fas fa-calendar-day"></i>
                                <strong>{{ item.data_transacao.strftime('%d/%m/%Y') }}</strong>
                            </div>
                            <div class="fin-info-line">
                                <i class="fas fa-building"></i>
                                {{ item.nome_pagador or 'Não identificado' }}
                            </div>
                            <div class="fin-info-line">
                                <i class="fas fa-id-card"></i>
                                <code class="fin-cnpj">{{ item.cnpj_pagador or 'CNPJ não identificado' }}</code>
                            </div>
                        </div>

                        {% if item.status != 'CONCILIADO' %}
                        <div class="mt-3 pt-2 border-top d-flex gap-1 flex-wrap">
                            {# Mostrar botão Aprovar se tem título vinculado (1:1 OU M:N) #}
                            {% if (item.titulo_receber_id or item.tem_multiplos_titulos) and not item.aprovado %}
                            <button class="btn btn-sm btn-success" onclick="aprovarItem({{ item.id }})">
                                <i class="fas fa-check"></i> Aprovar
                            </button>
                            {% endif %}
                            {% if item.aprovado %}
                            <button class="btn btn-sm btn-warning" onclick="conciliarItem({{ item.id }}, this)">
                                <i class="fas fa-link"></i> Conciliar
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="desaprovarItem({{ item.id }})">
                                <i class="fas fa-times"></i>
                            </button>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    {# SEÇÃO 2: COMPARAÇÃO #}
                    <div class="col-md-3 fin-item-col fin-item-col--bordered">
                        <div class="fin-section-header fin-section-header--comparacao">
                            <i class="fas fa-balance-scale"></i> COMPARAÇÃO
                        </div>

                        {# === COMPARAÇÃO PARA MÚLTIPLOS TÍTULOS === #}
                        {% if item.tem_multiplos_titulos %}
                        <div class="fin-comparacao-box">
                            <div class="text-center mb-2">
                                <span class="badge bg-info fs-6">
                                    <i class="fas fa-layer-group me-1"></i>
                                    {{ item.titulos_vinculados.count() }} Títulos
                                </span>
                            </div>

                            {# Valor do Extrato #}
                            <div class="fin-comparacao-item">
                                <span class="text-muted">Extrato:</span>
                                <span class="fw-bold font-mono">
                                    R$ {{ "{:,.2f}".format(item.valor or 0) }}
                                </span>
                            </div>

                            {# Soma dos Títulos #}
                            <div class="fin-comparacao-item">
                                <span class="text-muted">Σ Títulos:</span>
                                <span class="fw-bold font-mono">
                                    R$ {{ "{:,.2f}".format(item.valor_alocado_total or 0) }}
                                </span>
                            </div>

                            {# Diferença #}
                            {% set diff_valor = (item.valor or 0) - (item.valor_alocado_total or 0) %}
                            <div class="fin-comparacao-item border-top pt-2 mt-2">
                                <span class="text-muted">Δ Diferença:</span>
                                <span class="fw-bold {% if diff_valor|abs < 0.01 %}fin-diff--zero{% elif diff_valor > 0 %}fin-diff--positivo{% else %}fin-diff--negativo{% endif %}">
                                    {% if diff_valor|abs < 0.01 %}
                                    R$ 0,00 ✓
                                    {% elif diff_valor > 0 %}
                                    +R$ {{ "{:,.2f}".format(diff_valor) }}
                                    {% else %}
                                    -R$ {{ "{:,.2f}".format(diff_valor|abs) }}
                                    {% endif %}
                                </span>
                            </div>

                            {# Status de fechamento #}
                            {% if diff_valor|abs < 0.01 %}
                            <div class="text-center mt-2">
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>Valores fecham
                                </span>
                            </div>
                            {% elif diff_valor > 0 %}
                            <div class="text-center mt-2">
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Sobra no extrato
                                </span>
                            </div>
                            {% else %}
                            <div class="text-center mt-2">
                                <span class="badge bg-danger">
                                    <i class="fas fa-exclamation-circle me-1"></i>Falta no extrato
                                </span>
                            </div>
                            {% endif %}
                        </div>

                        {# === COMPARAÇÃO PARA TÍTULO ÚNICO === #}
                        {% elif item.titulo_receber_id %}
                        <div class="fin-comparacao-box">
                            <div class="text-center mb-2">
                                {% if item.match_score >= 100 %}
                                <span class="fin-score-badge fin-score-badge--100">{{ item.match_score }}%</span>
                                {% elif item.match_score >= 90 %}
                                <span class="fin-score-badge fin-score-badge--90">{{ item.match_score }}%</span>
                                {% elif item.match_score >= 80 %}
                                <span class="fin-score-badge fin-score-badge--80">{{ item.match_score }}%</span>
                                {% elif item.match_score >= 70 %}
                                <span class="fin-score-badge fin-score-badge--70">{{ item.match_score }}%</span>
                                {% else %}
                                <span class="fin-score-badge fin-score-badge--low">{{ item.match_score or 0 }}%</span>
                                {% endif %}
                            </div>

                            <div class="fin-comparacao-item">
                                <span class="text-muted">Critério:</span>
                                <span class="fw-bold">
                                    {% if 'CNPJ_EXATO' in (item.match_criterio or '') %}
                                    <span class="text-success"><i class="fas fa-check-circle"></i> CNPJ</span>
                                    {% elif 'GRUPO_CNPJ' in (item.match_criterio or '') %}
                                    <span class="text-warning"><i class="fas fa-sitemap"></i> Grupo</span>
                                    {% elif 'VALOR' in (item.match_criterio or '') %}
                                    <span class="text-info"><i class="fas fa-dollar-sign"></i> Valor</span>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </span>
                            </div>

                            {% set diff_valor = (item.valor or 0) - (item.titulo_valor or 0) %}
                            <div class="fin-comparacao-item">
                                <span class="text-muted">Δ Valor:</span>
                                <span class="fw-bold {% if diff_valor > 0.01 %}fin-diff--positivo{% elif diff_valor < -0.01 %}fin-diff--negativo{% else %}fin-diff--zero{% endif %}">
                                    {% if diff_valor > 0.01 %}+R$ {{ "{:,.2f}".format(diff_valor) }}
                                    {% elif diff_valor < -0.01 %}-R$ {{ "{:,.2f}".format(diff_valor|abs) }}
                                    {% else %}R$ 0,00 ✓{% endif %}
                                </span>
                            </div>

                            {% if item.titulo_vencimento and item.data_transacao %}
                            {% set diff_dias = (item.data_transacao - item.titulo_vencimento).days %}
                            <div class="fin-comparacao-item">
                                <span class="text-muted">Δ Dias:</span>
                                <span class="fw-bold {% if diff_dias > 0 %}fin-diff--positivo{% elif diff_dias < 0 %}fin-diff--negativo{% else %}fin-diff--zero{% endif %}">
                                    {% if diff_dias > 0 %}+{{ diff_dias }}d
                                    {% elif diff_dias < 0 %}{{ diff_dias }}d
                                    {% else %}✓{% endif %}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="fin-titulo-empty">
                            <div class="fin-titulo-empty__icon">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <p class="small mb-0">Sem match</p>
                        </div>
                        {% endif %}
                    </div>

                    {# SEÇÃO 3: TÍTULO #}
                    <div class="col-md-5 fin-item-col">
                        <div class="fin-section-header fin-section-header--titulo">
                            <i class="fas fa-file-invoice"></i> TÍTULO(S) A RECEBER
                            {% if item.tem_multiplos_titulos %}
                            <span class="badge bg-info ms-2">{{ item.titulos_vinculados.count() }} títulos</span>
                            {% endif %}
                        </div>

                        <div id="titulos-container-{{ item.id }}">
                            {# === MÚLTIPLOS TÍTULOS (M:N) === #}
                            {% if item.tem_multiplos_titulos %}
                            <div class="fin-titulos-multiplos">
                                {% for vinculo in item.titulos_vinculados %}
                                <div class="fin-titulo-candidato fin-titulo-candidato--selecionado mb-2 {{ 'fin-titulo-candidato--conciliado' if vinculo.status == 'CONCILIADO' }}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>NF {{ vinculo.titulo_nf }}</strong>
                                            <span class="badge bg-secondary ms-1">P{{ vinculo.titulo_parcela }}</span>
                                            {% if vinculo.status == 'CONCILIADO' %}
                                            <span class="badge bg-info ms-1"><i class="fas fa-check"></i></span>
                                            {% elif vinculo.status == 'ERRO' %}
                                            <span class="badge bg-danger ms-1"><i class="fas fa-times"></i></span>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            <div class="h6 mb-0 text-success font-mono fw-bold">
                                                R$ {{ "{:,.2f}".format(vinculo.valor_alocado or 0) }}
                                            </div>
                                            {% if vinculo.valor_titulo_original and vinculo.valor_titulo_original != vinculo.valor_alocado %}
                                            <small class="text-muted">(de R$ {{ "{:,.2f}".format(vinculo.valor_titulo_original) }})</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mt-1 small">
                                        <span class="text-muted">{{ vinculo.titulo_cliente or 'Cliente N/A' }}</span>
                                        {% if vinculo.titulo_vencimento %}
                                        | Venc: {{ vinculo.titulo_vencimento.strftime('%d/%m/%Y') }}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}

                                {# TOTALIZADOR #}
                                <div class="fin-titulos-total mt-2 pt-2 border-top">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong><i class="fas fa-calculator me-1"></i> Total Alocado:</strong>
                                        <span class="h5 mb-0 font-mono fw-bold text-primary">
                                            R$ {{ "{:,.2f}".format(item.valor_alocado_total or 0) }}
                                        </span>
                                    </div>
                                    {% set saldo = (item.valor or 0) - (item.valor_alocado_total or 0) %}
                                    {% if saldo|abs > 0.01 %}
                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                        <span class="text-muted">Saldo:</span>
                                        <span class="font-mono {% if saldo > 0 %}text-warning{% else %}text-danger{% endif %}">
                                            R$ {{ "{:,.2f}".format(saldo) }}
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>

                                {% if item.status != 'CONCILIADO' %}
                                <div class="mt-2 d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-primary" onclick="buscarCandidatos({{ item.id }})" title="Adicionar mais títulos">
                                        <i class="fas fa-plus me-1"></i>Adicionar
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="desvincularMultiplosTitulos({{ item.id }})" title="Remover todos">
                                        <i class="fas fa-unlink"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>

                            {# === TÍTULO ÚNICO (1:1 legacy) === #}
                            {% elif item.titulo_receber_id %}
                            <div class="fin-titulo-candidato fin-titulo-candidato--selecionado">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>NF {{ item.titulo_nf }}</strong>
                                        <span class="badge bg-secondary ms-1">P{{ item.titulo_parcela }}</span>
                                    </div>
                                    <div class="text-end">
                                        <div class="h5 mb-0 text-success font-mono fw-bold">
                                            R$ {{ "{:,.2f}".format(item.titulo_valor or 0) }}
                                        </div>
                                        {% if item.status != 'CONCILIADO' %}
                                        <div class="mt-1">
                                            <button class="btn btn-sm btn-outline-danger" onclick="desvincularTitulo({{ item.id }})" title="Desvincular">
                                                <i class="fas fa-unlink"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="buscarCandidatos({{ item.id }})" title="Trocar">
                                                <i class="fas fa-exchange-alt"></i>
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="mt-2 small">
                                    {# Usa titulo_receber (relationship correta para clientes) #}
                                    {% if item.titulo_receber %}
                                    <div class="fin-info-line">
                                        <i class="fas fa-building"></i>
                                        <strong>{{ item.titulo_receber.raz_social or item.titulo_cliente or 'N/A' }}</strong>
                                    </div>
                                    <div class="fin-info-line">
                                        <i class="fas fa-id-card"></i>
                                        <code class="fin-cnpj">{{ item.titulo_receber.cnpj or item.titulo_cnpj or 'N/A' }}</code>
                                    </div>
                                    {% else %}
                                    {# Fallback para campos de cache #}
                                    <div class="fin-info-line">
                                        <i class="fas fa-building"></i>
                                        <strong>{{ item.titulo_cliente or 'N/A' }}</strong>
                                    </div>
                                    <div class="fin-info-line">
                                        <i class="fas fa-id-card"></i>
                                        <code class="fin-cnpj">{{ item.titulo_cnpj or 'N/A' }}</code>
                                    </div>
                                    {% endif %}
                                    <div class="fin-info-line">
                                        <i class="fas fa-calendar-check"></i>
                                        Venc: <strong>{{ item.titulo_vencimento.strftime('%d/%m/%Y') if item.titulo_vencimento else 'N/A' }}</strong>
                                    </div>
                                </div>

                                {% if item.status == 'CONCILIADO' %}
                                <div class="mt-2 pt-2 border-top small text-info">
                                    <i class="fas fa-check-circle me-1"></i>
                                    Conciliado {{ item.processado_em.strftime('%d/%m %H:%M') if item.processado_em else '' }}
                                </div>
                                {% endif %}
                            </div>
                            {% elif item.status_match == 'PENDENTE' %}
                            <div class="fin-titulo-empty">
                                <div class="fin-titulo-empty__icon">
                                    <i class="fas fa-hourglass-half"></i>
                                </div>
                                <p class="small mb-0">Execute o matching</p>
                            </div>
                            {% elif item.status_match == 'SEM_MATCH' %}
                            <div class="fin-titulo-empty fin-titulo-empty--danger">
                                <div class="fin-titulo-empty__icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <p class="small mb-2">{{ item.mensagem or 'Nenhum título encontrado' }}</p>
                                <button class="btn btn-sm btn-outline-danger" onclick="buscarCandidatos({{ item.id }})">
                                    <i class="fas fa-search me-1"></i>Buscar
                                </button>
                            </div>
                            {% elif item.status_match == 'MULTIPLOS_MATCHES' %}
                            <div class="fin-titulo-empty fin-titulo-empty--warning">
                                <div class="fin-titulo-empty__icon">
                                    <i class="fas fa-question-circle"></i>
                                </div>
                                <p class="small mb-2">Múltiplos encontrados</p>
                                <button class="btn btn-sm btn-warning" onclick="buscarCandidatos({{ item.id }})">
                                    <i class="fas fa-list me-1"></i>Selecionar
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Nenhum item encontrado com os filtros selecionados.
            </div>
            {% endfor %}

            {# === PAGINAÇÃO === #}
            {% if pagination %}
            <nav aria-label="Paginação" class="mt-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="text-muted small">
                        Exibindo {{ itens|length }} de {{ pagination.total }} itens
                        (Página {{ pagination.page }} de {{ pagination.pages }})
                    </div>
                    <ul class="pagination pagination-sm mb-0">
                        {% if pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('financeiro.extrato_lote_detalhe', lote_id=lote.id, page=pagination.prev_num, per_page=per_page, status_match=request.args.get('status_match'), cnpj=filtro_cnpj, data_inicio=filtro_data_inicio, data_fim=filtro_data_fim) }}">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}

                        {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                            {% if p %}
                                {% if p == pagination.page %}
                                <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                                {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('financeiro.extrato_lote_detalhe', lote_id=lote.id, page=p, per_page=per_page, status_match=request.args.get('status_match'), cnpj=filtro_cnpj, data_inicio=filtro_data_inicio, data_fim=filtro_data_fim) }}">{{ p }}</a>
                                </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">…</span></li>
                            {% endif %}
                        {% endfor %}

                        {% if pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('financeiro.extrato_lote_detalhe', lote_id=lote.id, page=pagination.next_num, per_page=per_page, status_match=request.args.get('status_match'), cnpj=filtro_cnpj, data_inicio=filtro_data_inicio, data_fim=filtro_data_fim) }}">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

{# === MODAL DE CANDIDATOS (Suporte a Múltipla Seleção) === #}
<div class="modal fade fin-modal" id="modalCandidatos" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>
                    Selecionar Títulos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalCandidatosBody">
                <div class="fin-loading">
                    <div class="fin-loading__spinner"></div>
                    <p class="fin-loading__text">Buscando títulos...</p>
                </div>
            </div>
            <div class="modal-footer" id="modalCandidatosFooter" style="display: none;">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div id="titulosSelecionadosInfo" class="text-muted">
                        <span id="qtdSelecionados">0</span> título(s) selecionado(s)
                        | Total: <span id="totalSelecionados" class="font-mono fw-bold">R$ 0,00</span>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-success" id="btnVincularSelecionados" onclick="vincularTitulosSelecionados()" disabled>
                            <i class="fas fa-link me-1"></i>
                            Vincular Selecionados
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/financeiro/extrato.js') }}"></script>
<script>
const loteId = {{ lote.id }};
let itemAtual = null;
let valorExtrato = 0;
let titulosSelecionados = {}; // {titulo_id: {valor, titulo_nf, parcela, ...}}

function executarMatching() {
    if (!confirm('Executar matching automático para todos os itens pendentes?')) return;

    const btn = document.getElementById('btnMatching');
    const textoOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';

    fetch(`/financeiro/extrato/executar-matching/${loteId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            toastr.success(`Matching concluído: ${data.resultado.com_match} matches encontrados`);
            location.reload();
        } else {
            toastr.error(data.error || 'Erro no matching');
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
        }
    })
    .catch(err => {
        toastr.error('Erro de conexão');
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    });
}

function aprovarTodos() {
    if (!confirm('Aprovar todos os itens com match único?')) return;

    fetch('/financeiro/extrato/api/aprovar-todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lote_id: loteId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            toastr.success(`${data.aprovados} itens aprovados`);
            location.reload();
        } else {
            toastr.error(data.error || 'Erro ao aprovar');
        }
    });
}

function conciliarLote() {
    if (!confirm('Conciliar todos os itens aprovados no Odoo?')) return;

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Conciliando...';

    fetch('/financeiro/extrato/api/conciliar-lote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lote_id: loteId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            toastr.success(`Conciliação concluída: ${data.resultado.conciliados} itens`);
            location.reload();
        } else {
            toastr.error(data.error || 'Erro na conciliação');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-link me-2"></i>Conciliar Aprovados';
        }
    });
}

function aprovarItem(itemId) {
    fetch('/financeiro/extrato/api/aprovar-item', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId, aprovar: true })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            toastr.success('Item aprovado');
            location.reload();
        } else {
            toastr.error(data.error || 'Erro ao aprovar');
        }
    });
}

function desaprovarItem(itemId) {
    fetch('/financeiro/extrato/api/aprovar-item', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId, aprovar: false })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            toastr.info('Item desaprovado');
            location.reload();
        } else {
            toastr.error(data.error || 'Erro ao desaprovar');
        }
    });
}

function desvincularTitulo(itemId) {
    if (!confirm('Deseja desvincular o título deste item?\n\nO item voltará para o status PENDENTE.')) return;

    fetch('/financeiro/extrato/api/desvincular-titulo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            toastr.success('Título desvinculado');
            location.reload();
        } else {
            toastr.error(data.error || 'Erro ao desvincular');
        }
    });
}

// === FUNÇÃO PARA DESVINCULAR MÚLTIPLOS TÍTULOS ===
function desvincularMultiplosTitulos(itemId) {
    if (!confirm('Deseja remover TODOS os títulos vinculados a este item?\n\nO item voltará para o status PENDENTE.')) return;

    fetch('/financeiro/extrato/api/desvincular-multiplos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            toastr.success(data.message || 'Títulos desvinculados');
            location.reload();
        } else {
            toastr.error(data.error || 'Erro ao desvincular');
        }
    });
}

function conciliarItem(itemId, btn) {
    if (!confirm('Conciliar este título no Odoo?')) return;

    const textoOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    fetch('/financeiro/extrato/api/conciliar-item', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            if (data.extrato_reconciliado) {
                toastr.success('Título quitado - extrato reconciliado com payment existente');
            } else if (data.sincronizado_do_odoo) {
                toastr.warning('Título quitado - extrato NÃO reconciliado (verificar no Odoo)');
            } else {
                toastr.success('Item conciliado no Odoo');
            }
            location.reload();
        } else {
            toastr.error(data.error || 'Erro na conciliação');
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
        }
    })
    .catch(err => {
        toastr.error('Erro de conexão');
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    });
}

// === MODAL DE CANDIDATOS COM SELEÇÃO MÚLTIPLA ===
function buscarCandidatos(itemId) {
    itemAtual = itemId;
    titulosSelecionados = {};
    valorExtrato = 0;

    const modal = new bootstrap.Modal(document.getElementById('modalCandidatos'));
    modal.show();

    document.getElementById('modalCandidatosBody').innerHTML = `
        <div class="fin-loading">
            <div class="fin-loading__spinner"></div>
            <p class="fin-loading__text">Buscando títulos...</p>
        </div>
    `;
    document.getElementById('modalCandidatosFooter').style.display = 'none';

    fetch(`/financeiro/extrato/api/titulos-candidatos/${itemId}`)
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            valorExtrato = data.item.valor || 0;
            renderizarCandidatos(data.item, data.candidatos);
            document.getElementById('modalCandidatosFooter').style.display = 'flex';
            atualizarResumoSelecionados();
        } else {
            document.getElementById('modalCandidatosBody').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error || 'Erro ao buscar candidatos'}
                </div>
            `;
        }
    });
}

function renderizarCandidatos(item, candidatos) {
    let html = `
        <div class="mb-3 p-3 rounded" style="background: var(--fin-bg-tertiary, var(--bs-tertiary-bg));">
            <div class="row">
                <div class="col-md-8">
                    <strong>Extrato:</strong> ${item.tipo_transacao || 'N/A'}
                    <br><strong>CNPJ:</strong> ${item.cnpj_pagador || 'Não identificado'}
                    <br><strong>Pagador:</strong> ${item.nome_pagador || 'Não identificado'}
                </div>
                <div class="col-md-4 text-end">
                    <div class="h4 mb-0 font-mono fw-bold text-primary">
                        R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                    </div>
                    <small class="text-muted">Valor do Extrato</small>
                </div>
            </div>
        </div>

        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Seleção Múltipla:</strong> Use os checkboxes ou botão "Adicionar" para vincular vários títulos a este extrato.
        </div>
    `;

    if (candidatos.length === 0) {
        html += `
            <div class="alert alert-warning">
                <i class="fas fa-search me-2"></i>
                Nenhum título candidato encontrado para os critérios atuais.
            </div>
        `;
    } else {
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Encontrados ${candidatos.length} título(s) candidato(s):</span>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="limparSelecao()">
                        <i class="fas fa-eraser me-1"></i>Limpar Seleção
                    </button>
                </div>
            </div>
            <div class="fin-candidatos-lista" style="max-height: 400px; overflow-y: auto;">
        `;

        candidatos.forEach((t, idx) => {
            let scoreClass = 'fin-score-badge--low';
            if (t.score >= 100) scoreClass = 'fin-score-badge--100';
            else if (t.score >= 90) scoreClass = 'fin-score-badge--90';
            else if (t.score >= 80) scoreClass = 'fin-score-badge--80';
            else if (t.score >= 70) scoreClass = 'fin-score-badge--70';

            html += `
                <div class="fin-titulo-candidato ${t.score >= 100 ? 'fin-titulo-candidato--perfeito' : ''} mb-2"
                     id="candidato-${t.titulo_id}"
                     data-titulo-id="${t.titulo_id}"
                     data-valor="${t.valor || 0}"
                     data-nf="${t.titulo_nf}"
                     data-parcela="${t.parcela}">
                    <div class="d-flex align-items-start gap-2">
                        {# Checkbox #}
                        <div class="form-check mt-1">
                            <input class="form-check-input titulo-checkbox" type="checkbox"
                                   id="check-${t.titulo_id}"
                                   data-titulo-id="${t.titulo_id}"
                                   onchange="toggleTituloSelecionado(${t.titulo_id}, ${t.valor || 0}, '${t.titulo_nf}', '${t.parcela}')">
                        </div>

                        {# Info do Título #}
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="fin-score-badge ${scoreClass} me-2">${t.score}%</span>
                                    <strong>NF ${t.titulo_nf} - P${t.parcela}</strong>
                                </div>
                                <div class="text-end">
                                    <div class="h5 mb-0 font-mono fw-bold">
                                        R$ ${(t.valor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                                    </div>
                                </div>
                            </div>
                            <div class="mt-1 small">
                                <span class="text-muted">${t.cliente || 'Cliente não informado'}</span>
                                | <code class="fin-cnpj">${t.cnpj || 'N/A'}</code>
                                | Venc: ${t.vencimento || 'N/A'}
                            </div>
                        </div>

                        {# Botão Adicionar Individual #}
                        <div>
                            <button class="btn btn-sm btn-outline-success" onclick="adicionarTituloIndividual(${t.titulo_id}, ${t.valor || 0}, '${t.titulo_nf}', '${t.parcela}')"
                                    title="Adicionar apenas este título">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>'; // fecha fin-candidatos-lista
    }

    document.getElementById('modalCandidatosBody').innerHTML = html;
}

// === FUNÇÕES DE SELEÇÃO MÚLTIPLA ===
function toggleTituloSelecionado(tituloId, valor, nf, parcela) {
    const checkbox = document.getElementById(`check-${tituloId}`);
    const card = document.getElementById(`candidato-${tituloId}`);

    if (checkbox.checked) {
        titulosSelecionados[tituloId] = { titulo_id: tituloId, valor_alocado: valor, titulo_nf: nf, parcela: parcela };
        card.classList.add('fin-titulo-candidato--selecionado');
    } else {
        delete titulosSelecionados[tituloId];
        card.classList.remove('fin-titulo-candidato--selecionado');
    }

    atualizarResumoSelecionados();
}

function adicionarTituloIndividual(tituloId, valor, nf, parcela) {
    // Adiciona via checkbox e atualiza
    const checkbox = document.getElementById(`check-${tituloId}`);
    if (!checkbox.checked) {
        checkbox.checked = true;
        toggleTituloSelecionado(tituloId, valor, nf, parcela);
    }
    toastr.info(`NF ${nf} P${parcela} adicionado à seleção`);
}

function limparSelecao() {
    titulosSelecionados = {};
    document.querySelectorAll('.titulo-checkbox').forEach(cb => {
        cb.checked = false;
    });
    document.querySelectorAll('.fin-titulo-candidato--selecionado').forEach(el => {
        el.classList.remove('fin-titulo-candidato--selecionado');
    });
    atualizarResumoSelecionados();
}

function atualizarResumoSelecionados() {
    const qtd = Object.keys(titulosSelecionados).length;
    const total = Object.values(titulosSelecionados).reduce((sum, t) => sum + t.valor_alocado, 0);
    const diferenca = valorExtrato - total;

    document.getElementById('qtdSelecionados').textContent = qtd;
    document.getElementById('totalSelecionados').textContent = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

    const btn = document.getElementById('btnVincularSelecionados');
    btn.disabled = qtd === 0;

    // Mostrar diferença
    const info = document.getElementById('titulosSelecionadosInfo');
    if (qtd > 0) {
        let difClass = diferenca >= 0 ? 'text-success' : 'text-danger';
        let difText = diferenca >= 0 ? `+R$ ${diferenca.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : `-R$ ${Math.abs(diferenca).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        info.innerHTML = `
            <span id="qtdSelecionados">${qtd}</span> título(s)
            | Total: <span id="totalSelecionados" class="font-mono fw-bold">R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
            | Diferença: <span class="font-mono fw-bold ${difClass}">${difText}</span>
        `;
    } else {
        info.innerHTML = `
            <span id="qtdSelecionados">0</span> título(s) selecionado(s)
            | Total: <span id="totalSelecionados" class="font-mono fw-bold">R$ 0,00</span>
        `;
    }
}

function vincularTitulosSelecionados() {
    const titulos = Object.values(titulosSelecionados);
    if (titulos.length === 0) {
        toastr.warning('Selecione pelo menos um título');
        return;
    }

    const total = titulos.reduce((sum, t) => sum + t.valor_alocado, 0);
    const msg = titulos.length === 1
        ? `Vincular título NF ${titulos[0].titulo_nf} P${titulos[0].parcela} (R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})})?`
        : `Vincular ${titulos.length} títulos (Total: R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})})?`;

    if (!confirm(msg)) return;

    const btn = document.getElementById('btnVincularSelecionados');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Vinculando...';

    fetch('/financeiro/extrato/api/vincular-multiplos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            item_id: itemAtual,
            titulos: titulos,
            tipo: 'receber'
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            toastr.success(data.message || 'Títulos vinculados com sucesso');
            bootstrap.Modal.getInstance(document.getElementById('modalCandidatos')).hide();
            location.reload();
        } else {
            toastr.error(data.error || 'Erro ao vincular títulos');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-link me-1"></i>Vincular Selecionados';
        }
    })
    .catch(err => {
        toastr.error('Erro de conexão');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-link me-1"></i>Vincular Selecionados';
    });
}

// === FUNÇÃO LEGADA PARA SELEÇÃO ÚNICA (mantida para compatibilidade) ===
function selecionarTitulo(itemId, tituloId) {
    if (!confirm('Vincular este título ao recebimento?')) return;

    fetch('/financeiro/extrato/api/selecionar-titulo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId, titulo_id: tituloId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            toastr.success('Título vinculado com sucesso');
            bootstrap.Modal.getInstance(document.getElementById('modalCandidatos')).hide();
            location.reload();
        } else {
            toastr.error(data.error || 'Erro ao vincular título');
        }
    });
}
</script>
{% endblock %}
