{% extends "base.html" %}

{% block title %}Contas a Pagar - Central{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/financeiro/extrato.css') }}">
{% endblock %}

{% block content %}
<div class="fin-container premium-page">
    <!-- ================================================================== -->
    <!-- HEADER                                                              -->
    <!-- ================================================================== -->
    <header class="fin-header reveal">
        <div class="fin-header__content">
            <h1 class="fin-header__title">
                <i class="fas fa-file-invoice-dollar"></i>
                Contas a Pagar
            </h1>
            <p class="fin-header__subtitle">
                Central de gestao de contas a pagar - Dados sincronizados do Odoo
            </p>
        </div>
        <div class="fin-header__actions">
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                <i class="fas fa-sun theme-toggle__icon theme-toggle__icon--light"></i>
                <i class="fas fa-moon theme-toggle__icon theme-toggle__icon--dark"></i>
            </button>
        </div>
    </header>

    <!-- ================================================================== -->
    <!-- ESTATISTICAS RAPIDAS                                               -->
    <!-- ================================================================== -->
    <div class="fin-stats-grid" id="statsContainer">
        <div class="fin-stat-card fin-stat-card--danger">
            <div class="fin-stat-card__value" id="statVencidos">{{ '{:,.0f}'.format(qtd_vencido) }}</div>
            <div class="fin-stat-card__label">Vencidos</div>
            <div class="fin-stat-card__amount">R$ {{ '{:,.2f}'.format(total_vencido) }}</div>
        </div>
        <div class="fin-stat-card fin-stat-card--warning">
            <div class="fin-stat-card__value" id="statHoje">{{ '{:,.0f}'.format(qtd_hoje) }}</div>
            <div class="fin-stat-card__label">Vence Hoje</div>
            <div class="fin-stat-card__amount">R$ {{ '{:,.2f}'.format(total_hoje) }}</div>
        </div>
        <div class="fin-stat-card fin-stat-card--info">
            <div class="fin-stat-card__value" id="statSemana">{{ '{:,.0f}'.format(qtd_semana) }}</div>
            <div class="fin-stat-card__label">Vence em 7 dias</div>
            <div class="fin-stat-card__amount">R$ {{ '{:,.2f}'.format(total_semana) }}</div>
        </div>
        <div class="fin-stat-card fin-stat-card--primary">
            <div class="fin-stat-card__value" id="statTotal">{{ total_registros }}</div>
            <div class="fin-stat-card__label">Total em Aberto</div>
            <div class="fin-stat-card__amount">R$ {{ '{:,.2f}'.format(total_aberto) }}</div>
        </div>
    </div>

    <div class="fin-sync-info">
        <i class="fas fa-sync-alt"></i>
        Ultima sincronizacao:
        <span id="ultimaSync">
            {% if ultima_sync %}
            {{ ultima_sync.strftime('%d/%m/%Y %H:%M') }}
            {% else %}
            Nunca
            {% endif %}
        </span>
        | Total de registros: {{ total_registros }}
    </div>

    <!-- ================================================================== -->
    <!-- CARDS PRINCIPAIS                                                    -->
    <!-- ================================================================== -->
    <div class="fin-hub-section">
        <h2 class="fin-hub-section__title">
            <i class="fas fa-star"></i>
            Principais
        </h2>

        <div class="fin-hub-grid">
            <!-- Consultar Titulos -->
            <a href="{{ url_for('financeiro.listar_contas_pagar') }}" class="fin-hub-card fin-hub-card--primary">
                <span class="fin-hub-card__badge fin-hub-card__badge--success">PRINCIPAL</span>
                <div class="fin-hub-card__icon fin-hub-card__icon--danger">
                    <i class="fas fa-list"></i>
                </div>
                <h3 class="fin-hub-card__title">Listar Titulos</h3>
                <p class="fin-hub-card__desc">
                    Consulte todos os titulos a pagar com filtros por fornecedor,
                    vencimento, status e empresa. Veja detalhes e historico.
                </p>
                <span class="fin-hub-card__action">
                    <i class="fas fa-table"></i>
                    Acessar Listagem
                </span>
            </a>

            <!-- Baixa de Pagamentos -->
            <a href="{{ url_for('financeiro.pagamentos_baixas_hub') }}" class="fin-hub-card">
                <div class="fin-hub-card__icon fin-hub-card__icon--success">
                    <i class="fas fa-file-import"></i>
                </div>
                <h3 class="fin-hub-card__title">Baixa de Pagamentos</h3>
                <p class="fin-hub-card__desc">
                    Vincule pagamentos do extrato bancario aos titulos a pagar.
                    Conciliacao automatica e manual.
                </p>
                <span class="fin-hub-card__action">
                    <i class="fas fa-check-double"></i>
                    Realizar Baixas
                </span>
            </a>

            <!-- Sincronizacao -->
            <div class="fin-hub-card fin-hub-card--interactive">
                <div class="fin-hub-card__icon fin-hub-card__icon--warning">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <h3 class="fin-hub-card__title">Sincronizacao</h3>
                <p class="fin-hub-card__desc">
                    Sincronize dados com o Odoo manualmente.
                </p>
                <div class="fin-form-row" style="margin-bottom: 0.75rem;">
                    <div class="fin-filter-group">
                        <label class="fin-filter-group__label" style="font-size: 0.75rem;">De (Vencimento)</label>
                        <input type="date" id="syncDataInicio" class="fin-filter-group__input" style="font-size: 0.8rem; padding: 0.35rem;">
                    </div>
                    <div class="fin-filter-group">
                        <label class="fin-filter-group__label" style="font-size: 0.75rem;">Ate (Vencimento)</label>
                        <input type="date" id="syncDataFim" class="fin-filter-group__input" style="font-size: 0.8rem; padding: 0.35rem;">
                    </div>
                </div>
                <small class="text-muted" style="display: block; margin-bottom: 0.5rem; font-size: 0.7rem;">
                    Deixe vazio para buscar ultimos 90 dias
                </small>
                <div class="fin-hub-card__buttons">
                    <button class="btn-ext btn-ext--warning" onclick="sincronizarOdoo()" id="btnSincronizar">
                        <i class="fas fa-cloud-download-alt"></i>
                        Sincronizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- LINKS RAPIDOS                                                       -->
    <!-- ================================================================== -->
    <div class="fin-hub-section">
        <h2 class="fin-hub-section__title">
            <i class="fas fa-link"></i>
            Acesso Rapido
        </h2>

        <div class="fin-hub-grid fin-hub-grid--sm">
            <!-- Vencidos -->
            {% if qtd_vencido > 0 %}
            <a href="{{ url_for('financeiro.listar_contas_pagar', status='vencido') }}" class="fin-hub-card fin-hub-card--compact">
                <span class="fin-hub-card__badge fin-hub-card__badge--warning">ATENCAO</span>
                <div class="fin-hub-card__icon fin-hub-card__icon--danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="fin-hub-card__title">Titulos Vencidos</h3>
                <p class="fin-hub-card__desc">
                    {{ qtd_vencido }} titulo(s) vencido(s) totalizando R$ {{ '{:,.2f}'.format(total_vencido) }}
                </p>
            </a>
            {% endif %}

            <!-- Vence Hoje -->
            {% if qtd_hoje > 0 %}
            <a href="{{ url_for('financeiro.listar_contas_pagar', status='vence_hoje') }}" class="fin-hub-card fin-hub-card--compact">
                <div class="fin-hub-card__icon fin-hub-card__icon--warning">
                    <i class="fas fa-clock"></i>
                </div>
                <h3 class="fin-hub-card__title">Vence Hoje</h3>
                <p class="fin-hub-card__desc">
                    {{ qtd_hoje }} titulo(s) vencem hoje
                </p>
            </a>
            {% endif %}

            <!-- Vence na Semana -->
            {% if qtd_semana > 0 %}
            <a href="{{ url_for('financeiro.listar_contas_pagar', status='vence_semana') }}" class="fin-hub-card fin-hub-card--compact">
                <div class="fin-hub-card__icon fin-hub-card__icon--info">
                    <i class="fas fa-calendar-week"></i>
                </div>
                <h3 class="fin-hub-card__title">Proximos 7 dias</h3>
                <p class="fin-hub-card__desc">
                    {{ qtd_semana }} titulo(s) vencem em 7 dias
                </p>
            </a>
            {% endif %}

            <!-- Extrato Bancario -->
            <a href="{{ url_for('financeiro.extrato_hub') }}" class="fin-hub-card fin-hub-card--compact">
                <div class="fin-hub-card__icon fin-hub-card__icon--cyan">
                    <i class="fas fa-university"></i>
                </div>
                <h3 class="fin-hub-card__title">Extrato Bancario</h3>
                <p class="fin-hub-card__desc">
                    Visualize extratos e conciliacoes bancarias
                </p>
            </a>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- INFORMACOES SOBRE DADOS                                            -->
    <!-- ================================================================== -->
    <div class="fin-info-panel">
        <div class="fin-info-panel__header">
            <i class="fas fa-info-circle"></i>
            Sobre os Dados
        </div>
        <div class="fin-info-panel__body">
            <div class="fin-info-panel__grid">
                <div class="fin-info-panel__item">
                    <h4><i class="fas fa-database"></i> Fonte de Dados</h4>
                    <p>
                        Dados extraidos do modelo <code>account.move.line</code> do Odoo,
                        filtrados por contas a pagar em aberto.
                    </p>
                </div>
                <div class="fin-info-panel__item">
                    <h4><i class="fas fa-sync"></i> Sincronizacao</h4>
                    <p>
                        Sincronizacao manual. Clique em "Sincronizar" para
                        buscar os ultimos 90 dias de titulos.
                    </p>
                </div>
                <div class="fin-info-panel__item">
                    <h4><i class="fas fa-link"></i> Conciliacao</h4>
                    <p>
                        Use a "Baixa de Pagamentos" para vincular
                        pagamentos do extrato aos titulos.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ====================================================================== -->
<!-- MODAL DE LOADING                                                        -->
<!-- ====================================================================== -->
<div class="modal fade fin-modal" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="fin-loading">
                    <div class="fin-loading__spinner"></div>
                    <div class="fin-loading__text" id="loadingMessage">Sincronizando com Odoo...</div>
                    <p class="text-muted mb-0">Isso pode levar alguns segundos.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/financeiro/extrato.js') }}"></script>
<script>
// =============================================
// SINCRONIZACAO
// =============================================

function sincronizarOdoo() {
    const btn = document.getElementById('btnSincronizar');
    const textoOriginal = btn.innerHTML;

    // Obter datas dos campos
    const dataInicio = document.getElementById('syncDataInicio').value;
    const dataFim = document.getElementById('syncDataFim').value;

    // Preparar payload
    const payload = {
        apenas_em_aberto: true
    };

    if (dataInicio) {
        payload.data_inicio = dataInicio;
    }
    if (dataFim) {
        payload.data_fim = dataFim;
    }
    // Se n√£o informou datas, usa os ultimos 90 dias
    if (!dataInicio && !dataFim) {
        payload.dias = 90;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';

    fetch('{{ url_for("financeiro.sincronizar_contas_pagar_odoo") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (typeof toastr !== 'undefined') {
                toastr.success(
                    `Novos: ${data.novos}, Atualizados: ${data.atualizados}, Erros: ${data.erros}`,
                    'Sincronizacao concluida!'
                );
            } else {
                alert(`Sincronizacao concluida!\nNovos: ${data.novos}, Atualizados: ${data.atualizados}`);
            }
            setTimeout(() => location.reload(), 1500);
        } else {
            if (typeof toastr !== 'undefined') {
                toastr.error(data.error || 'Erro desconhecido', 'Erro na sincronizacao');
            } else {
                alert('Erro: ' + (data.error || 'Erro desconhecido'));
            }
        }
    })
    .catch(error => {
        if (typeof toastr !== 'undefined') {
            toastr.error(error.message, 'Erro');
        } else {
            alert('Erro: ' + error.message);
        }
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    });
}
</script>
{% endblock %}
