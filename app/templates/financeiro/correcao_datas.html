{% extends "base.html" %}

{% block title %}Correcao de Datas - NFs de Credito{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/financeiro/extrato.css') }}">
<style>
.data-errada {
    background: var(--fin-bg-danger) !important;
    color: var(--fin-accent-danger);
    font-weight: 600;
}
.data-correta {
    background: var(--fin-bg-success) !important;
    color: var(--fin-accent-success);
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="fin-container premium-page">
    <!-- ================================================================== -->
    <!-- HEADER -->
    <!-- ================================================================== -->
    <header class="fin-header">
        <div>
            <nav class="fin-breadcrumb">
                <a href="{{ url_for('financeiro.contas_receber_hub') }}" class="fin-breadcrumb__item">
                    <i class="fas fa-wallet"></i> Contas a Receber
                </a>
                <span class="fin-breadcrumb__separator">/</span>
                <span class="fin-breadcrumb__current">Correcao de Datas</span>
            </nav>
            <h1 class="fin-header__title">
                <i class="fas fa-calendar-check"></i>
                Correcao de Datas - NFs de Credito
            </h1>
            <p class="fin-header__subtitle">
                Identifica e corrige datas de lancamento incorretas em notas de credito
            </p>
        </div>
        <div class="fin-header__actions">
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                <i class="fas fa-sun theme-toggle__icon theme-toggle__icon--light"></i>
                <i class="fas fa-moon theme-toggle__icon theme-toggle__icon--dark"></i>
            </button>
            <button class="fin-btn fin-btn--ghost" onclick="executarDiagnostico()">
                <i class="fas fa-search"></i> Diagnosticar Odoo
            </button>
            <button class="fin-btn fin-btn--success" onclick="corrigirSelecionados()" id="btnCorrigir" disabled>
                <i class="fas fa-check-circle"></i> Corrigir Selecionados
            </button>
            <button class="fin-btn fin-btn--ghost" onclick="resetarErros()">
                <i class="fas fa-redo"></i> Resetar Erros
            </button>
            <a href="{{ url_for('financeiro.correcao_datas_api_exportar') }}" class="fin-btn fin-btn--ghost">
                <i class="fas fa-file-excel"></i> Exportar
            </a>
        </div>
    </header>

    <!-- ================================================================== -->
    <!-- STATS CARDS -->
    <!-- ================================================================== -->
    <div class="fin-stats">
        <div class="fin-stat-card fin-stat-card--primary">
            <div class="fin-stat-card__value" id="statTotal">{{ stats.total }}</div>
            <div class="fin-stat-card__label">Total Diagnosticado</div>
        </div>
        <div class="fin-stat-card fin-stat-card--warning">
            <div class="fin-stat-card__value" id="statPendente">{{ stats.pendente }}</div>
            <div class="fin-stat-card__label">Pendentes</div>
        </div>
        <div class="fin-stat-card fin-stat-card--success">
            <div class="fin-stat-card__value" id="statCorrigido">{{ stats.corrigido }}</div>
            <div class="fin-stat-card__label">Corrigidos</div>
        </div>
        <div class="fin-stat-card fin-stat-card--danger">
            <div class="fin-stat-card__value" id="statErro">{{ stats.erro }}</div>
            <div class="fin-stat-card__label">Com Erro</div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- FILTROS -->
    <!-- ================================================================== -->
    <div class="fin-filters">
        <div class="fin-filters__grid">
            <div class="fin-filter-group">
                <label class="fin-filter-group__label">Status</label>
                <select class="fin-filter-group__input fin-filter-group__select" id="filtroStatus">
                    <option value="">Todos</option>
                    <option value="pendente" selected>Pendente</option>
                    <option value="corrigido">Corrigido</option>
                    <option value="erro">Com Erro</option>
                </select>
            </div>

            <div class="fin-filter-group">
                <label class="fin-filter-group__label">Mes Emissao</label>
                <input type="month" class="fin-filter-group__input" id="filtroMes">
            </div>

            <div class="fin-filter-group">
                <label class="fin-filter-group__label">Documento</label>
                <input type="text" class="fin-filter-group__input" id="filtroDocumento"
                       placeholder="Ex: RDVEND/2024/00621">
            </div>

            <div class="fin-filter-group">
                <label class="fin-filter-group__label">&nbsp;</label>
                <button class="fin-btn fin-btn--primary" onclick="carregarDados()">
                    <i class="fas fa-filter"></i> Filtrar
                </button>
            </div>

            <div class="fin-filter-group">
                <label class="fin-filter-group__label">&nbsp;</label>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" class="fin-checkbox" id="checkAll" onclick="toggleSelecionarTodos()">
                        <span style="font-size: 0.8rem; color: var(--fin-text-secondary);">Todos</span>
                    </label>
                    <span class="fin-badge fin-badge--primary" id="countSelecionados">0 selecionados</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- TABELA -->
    <!-- ================================================================== -->
    <div class="fin-section">
        <div class="fin-section__header">
            <h2 class="fin-section__title">
                <i class="fas fa-list"></i>
                Documentos
                <span class="fin-section__badge" id="badgeTotal">0</span>
            </h2>
        </div>

        <div class="fin-section__content">
            <div class="fin-table-wrapper" style="max-height: 55vh; overflow-y: auto;">
                <table class="fin-table">
                    <thead>
                        <tr>
                            <th width="40"></th>
                            <th>Documento</th>
                            <th>NF</th>
                            <th>Parceiro</th>
                            <th width="100">Data Emissao</th>
                            <th width="120">Lanc. (Antes)</th>
                            <th width="120">Linhas (Antes)</th>
                            <th width="100">Data Correta</th>
                            <th width="90">Status</th>
                            <th width="60">Acoes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaBody">
                        <tr>
                            <td colspan="10">
                                <div class="fin-loading">
                                    <div class="fin-loading__spinner"></div>
                                    <div class="fin-loading__text">Carregando dados...</div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Paginacao -->
            <div class="fin-pagination" id="paginacaoContainer">
                <div class="fin-pagination__info" id="paginacaoInfo">
                    Mostrando 0 de 0 registros
                </div>
                <nav class="fin-pagination__nav" id="paginacao"></nav>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="fin-loading-overlay" id="loadingOverlay">
    <div style="text-align: center;">
        <div class="fin-loading__spinner" style="width: 50px; height: 50px; margin-bottom: 1rem;"></div>
        <div style="color: var(--fin-text-primary);" id="loadingText">Processando...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/financeiro/extrato.js') }}"></script>
<script>
// Estado global
let dadosAtuais = [];
let paginaAtual = 1;
let totalPaginas = 1;
let selecionados = new Set();

document.addEventListener('DOMContentLoaded', function() {
    carregarDados();
});

async function carregarDados(page = 1) {
    const status = document.getElementById('filtroStatus').value;
    const mes = document.getElementById('filtroMes').value;
    const documento = document.getElementById('filtroDocumento').value;

    const params = new URLSearchParams({ page: page, per_page: 50 });
    if (status) params.append('status', status);
    if (mes) params.append('mes', mes);
    if (documento) params.append('documento', documento);

    try {
        const response = await fetch(`/financeiro/correcao-datas/api/listar?${params}`);
        const data = await response.json();

        if (data.sucesso) {
            dadosAtuais = data.items;
            paginaAtual = data.page;
            totalPaginas = data.pages;
            renderizarTabela();
            renderizarPaginacao(data.total);
            document.getElementById('badgeTotal').textContent = data.total;
        } else {
            toastr.error('Erro ao carregar: ' + data.erro);
        }
    } catch (error) {
        console.error('Erro:', error);
        toastr.error('Erro ao carregar dados');
    }
}

function renderizarTabela() {
    const tbody = document.getElementById('tabelaBody');

    if (dadosAtuais.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10">
                    <div class="fin-empty">
                        <div class="fin-empty__icon"><i class="fas fa-inbox"></i></div>
                        <div class="fin-empty__title">Nenhum registro encontrado</div>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = dadosAtuais.map(item => {
        const headerErrado = item.data_lancamento_antes !== item.data_correta;
        const linhasErradas = item.data_lancamento_linhas_antes && item.data_lancamento_linhas_antes !== item.data_correta;
        const checked = selecionados.has(item.id) ? 'checked' : '';
        const disabled = item.status !== 'pendente' ? 'disabled' : '';

        let statusBadge = '';
        if (item.status === 'pendente') statusBadge = '<span class="fin-badge fin-badge--warning">PENDENTE</span>';
        else if (item.status === 'corrigido') statusBadge = '<span class="fin-badge fin-badge--success">CORRIGIDO</span>';
        else if (item.status === 'erro') statusBadge = '<span class="fin-badge fin-badge--danger">ERRO</span>';

        return `
            <tr>
                <td class="text-center">
                    <input class="fin-checkbox item-check" type="checkbox"
                           value="${item.id}" ${checked} ${disabled}
                           onchange="toggleItem(${item.id})">
                </td>
                <td>
                    <a href="https://odoo.nacomgoya.com.br/web#id=${item.odoo_move_id}&model=account.move&view_type=form"
                       target="_blank" class="fin-link">
                        ${item.nome_documento}
                        <i class="fas fa-external-link-alt" style="font-size: 0.7rem;"></i>
                    </a>
                </td>
                <td class="mono">${item.numero_nf || '-'}</td>
                <td style="max-width: 180px; overflow: hidden; text-overflow: ellipsis;" title="${item.nome_parceiro || ''}">
                    ${item.nome_parceiro || '-'}
                </td>
                <td class="text-center mono">${formatarData(item.data_emissao)}</td>
                <td class="text-center mono ${headerErrado ? 'data-errada' : ''}">${formatarData(item.data_lancamento_antes)}</td>
                <td class="text-center mono ${linhasErradas ? 'data-errada' : ''}">${formatarData(item.data_lancamento_linhas_antes)}</td>
                <td class="text-center mono ${(headerErrado || linhasErradas) ? 'data-correta' : ''}">${formatarData(item.data_correta)}</td>
                <td class="text-center">${statusBadge}</td>
                <td class="text-center">
                    ${item.status === 'pendente' ? `
                        <button class="fin-btn fin-btn--success fin-btn--sm fin-btn--icon"
                                onclick="corrigirUm(${item.id})" title="Corrigir">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                    ${item.status === 'erro' ? `
                        <span style="color: var(--fin-accent-danger);" title="${item.erro_mensagem || 'Erro'}">
                            <i class="fas fa-exclamation-circle"></i>
                        </span>
                    ` : ''}
                </td>
            </tr>
        `;
    }).join('');

    atualizarContadores();
}

function formatarData(data) {
    if (!data) return '-';
    const [ano, mes, dia] = data.split('-');
    return `${dia}/${mes}/${ano}`;
}

function toggleSelecionarTodos() {
    const checkAll = document.getElementById('checkAll');
    document.querySelectorAll('.item-check:not(:disabled)').forEach(cb => {
        cb.checked = checkAll.checked;
        const id = parseInt(cb.value);
        if (checkAll.checked) selecionados.add(id);
        else selecionados.delete(id);
    });
    atualizarContadores();
}

function toggleItem(id) {
    if (selecionados.has(id)) selecionados.delete(id);
    else selecionados.add(id);
    atualizarContadores();
}

function atualizarContadores() {
    const count = selecionados.size;
    document.getElementById('countSelecionados').textContent = `${count} selecionados`;
    document.getElementById('btnCorrigir').disabled = count === 0;
}

async function executarDiagnostico() {
    if (!confirm('Isso ira buscar novas NFs com problema no Odoo. Continuar?')) return;
    showLoading('Buscando NFs com problema no Odoo...');

    try {
        const response = await fetch('/financeiro/correcao-datas/api/diagnosticar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();

        if (data.sucesso) {
            toastr.success(`Diagnostico concluido! ${data.total_com_problema} com problema, ${data.novos_diagnosticados} novos.`);
            carregarDados();
            atualizarEstatisticas();
        } else {
            toastr.error('Erro: ' + data.erro);
        }
    } catch (error) {
        toastr.error('Erro no diagnostico');
    } finally {
        hideLoading();
    }
}

async function corrigirSelecionados() {
    if (selecionados.size === 0) { toastr.warning('Selecione pelo menos um item'); return; }
    if (!confirm(`Corrigir ${selecionados.size} documento(s)? Esta acao alterara os dados no Odoo.`)) return;

    showLoading(`Corrigindo ${selecionados.size} documento(s)...`);

    try {
        const response = await fetch('/financeiro/correcao-datas/api/corrigir', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: Array.from(selecionados) })
        });
        const data = await response.json();

        if (data.sucesso) {
            toastr.success(`Correcao concluida! ${data.corrigidos} corrigidos, ${data.erros} erros.`);
            selecionados.clear();
            carregarDados();
            atualizarEstatisticas();
        } else {
            toastr.error('Erro: ' + data.erro);
        }
    } catch (error) {
        toastr.error('Erro na correcao');
    } finally {
        hideLoading();
    }
}

async function corrigirUm(id) {
    if (!confirm('Corrigir este documento?')) return;
    showLoading('Corrigindo documento...');

    try {
        const response = await fetch('/financeiro/correcao-datas/api/corrigir', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: [id] })
        });
        const data = await response.json();

        if (data.sucesso && data.corrigidos > 0) {
            toastr.success('Documento corrigido!');
            carregarDados();
            atualizarEstatisticas();
        } else {
            toastr.error('Erro: ' + (data.detalhes?.[0]?.erro || data.erro || 'Erro desconhecido'));
        }
    } catch (error) {
        toastr.error('Erro na correcao');
    } finally {
        hideLoading();
    }
}

async function resetarErros() {
    if (!confirm('Resetar todos os registros com erro para pendente?')) return;
    showLoading('Resetando registros...');

    try {
        const response = await fetch('/financeiro/correcao-datas/api/resetar-erros', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (data.sucesso) {
            toastr.success(`${data.resetados} registro(s) resetado(s)`);
            carregarDados();
            atualizarEstatisticas();
        } else {
            toastr.error('Erro: ' + data.erro);
        }
    } catch (error) {
        toastr.error('Erro ao resetar');
    } finally {
        hideLoading();
    }
}

async function atualizarEstatisticas() {
    try {
        const response = await fetch('/financeiro/correcao-datas/api/estatisticas');
        const data = await response.json();

        if (data.sucesso) {
            document.getElementById('statTotal').textContent = data.stats.total;
            document.getElementById('statPendente').textContent = data.stats.pendente;
            document.getElementById('statCorrigido').textContent = data.stats.corrigido;
            document.getElementById('statErro').textContent = data.stats.erro;
        }
    } catch (error) {
        console.error('Erro ao atualizar estatisticas:', error);
    }
}

function renderizarPaginacao(total) {
    const info = document.getElementById('paginacaoInfo');
    const inicio = total > 0 ? (paginaAtual - 1) * 50 + 1 : 0;
    const fim = Math.min(paginaAtual * 50, total);
    info.innerHTML = `Mostrando <strong>${inicio}-${fim}</strong> de <strong>${total}</strong> registros`;

    const nav = document.getElementById('paginacao');
    nav.innerHTML = '';
    if (totalPaginas <= 1) return;

    // Anterior
    nav.innerHTML += `
        <button class="fin-pagination__btn" onclick="carregarDados(${paginaAtual - 1})" ${paginaAtual === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>
    `;

    // Paginas
    const startPage = Math.max(1, paginaAtual - 2);
    const endPage = Math.min(totalPaginas, paginaAtual + 2);

    for (let i = startPage; i <= endPage; i++) {
        nav.innerHTML += `
            <button class="fin-pagination__btn ${paginaAtual === i ? 'active' : ''}" onclick="carregarDados(${i})">${i}</button>
        `;
    }

    // Proximo
    nav.innerHTML += `
        <button class="fin-pagination__btn" onclick="carregarDados(${paginaAtual + 1})" ${paginaAtual === totalPaginas ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
}

function showLoading(text = 'Processando...') {
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}
</script>
{% endblock %}
