{% extends "base.html" %}

{% block title %}{{ lotes|length }} Lotes - Extrato - Financeiro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/financeiro/extrato.css') }}">
{% endblock %}

{% block content %}
<div class="fin-container">
    <!-- ================================================================== -->
    <!-- HEADER -->
    <!-- ================================================================== -->
    <header class="fin-header">
        <div>
            <nav class="fin-breadcrumb">
                <a href="{{ url_for('financeiro.extrato_hub') }}" class="fin-breadcrumb__item">
                    <i class="fas fa-university"></i> Extratos
                </a>
                <span class="fin-breadcrumb__separator">/</span>
                <span class="fin-breadcrumb__current">{{ lotes|length }} Lotes</span>
            </nav>
            <h1 class="fin-header__title">
                <i class="fas fa-layer-group"></i>
                Visualizando {{ lotes|length }} Lotes
            </h1>
            <p class="fin-header__subtitle">
                {% for lote in lotes %}
                <span class="fin-badge fin-badge--muted">{{ lote.nome }}</span>
                {% endfor %}
            </p>
        </div>
        <div class="fin-header__actions">
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                <i class="fas fa-sun theme-toggle__icon theme-toggle__icon--light"></i>
                <i class="fas fa-moon theme-toggle__icon theme-toggle__icon--dark"></i>
            </button>

            {% if stats.pendentes > 0 %}
            <button class="fin-btn fin-btn--primary" onclick="executarMatchingMultiplos()" id="btnMatching">
                <i class="fas fa-magic"></i> Executar Matching
            </button>
            {% endif %}

            {% if stats.com_match > 0 and stats.aprovados < stats.com_match %}
            <button class="fin-btn fin-btn--success" onclick="aprovarTodosMultiplos()">
                <i class="fas fa-check-double"></i>
                Aprovar Todos ({{ stats.com_match - stats.aprovados }})
            </button>
            {% endif %}

            {% if stats.aprovados > 0 %}
            <button class="fin-btn fin-btn--warning" onclick="conciliarMultiplos()">
                <i class="fas fa-link"></i>
                Conciliar Aprovados ({{ stats.aprovados - stats.conciliados }})
            </button>
            {% endif %}

            <a href="{{ url_for('financeiro.extrato_hub') }}" class="fin-btn fin-btn--ghost">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </header>

    <!-- ================================================================== -->
    <!-- STATS CARDS -->
    <!-- ================================================================== -->
    <div class="fin-stats">
        <div class="fin-stat-card fin-stat-card--primary">
            <div class="fin-stat-card__value">{{ stats.total }}</div>
            <div class="fin-stat-card__label">Total</div>
        </div>
        <div class="fin-stat-card fin-stat-card--success">
            <div class="fin-stat-card__value">{{ stats.com_match }}</div>
            <div class="fin-stat-card__label">Match</div>
        </div>
        <div class="fin-stat-card fin-stat-card--warning">
            <div class="fin-stat-card__value">{{ stats.multiplos }}</div>
            <div class="fin-stat-card__label">Multiplos</div>
        </div>
        <div class="fin-stat-card fin-stat-card--danger">
            <div class="fin-stat-card__value">{{ stats.sem_match }}</div>
            <div class="fin-stat-card__label">Sem Match</div>
        </div>
        <div class="fin-stat-card">
            <div class="fin-stat-card__value">{{ stats.pendentes }}</div>
            <div class="fin-stat-card__label">Pendentes</div>
        </div>
        <div class="fin-stat-card fin-stat-card--info">
            <div class="fin-stat-card__value">{{ stats.aprovados }}</div>
            <div class="fin-stat-card__label">Aprovados</div>
        </div>
        <div class="fin-stat-card" style="--stat-color: #17a2b8;">
            <div class="fin-stat-card__value">{{ stats.conciliados }}</div>
            <div class="fin-stat-card__label">Conciliados</div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- FILTROS -->
    <!-- ================================================================== -->
    <div class="fin-filters">
        <form method="GET" action="{{ url_for('financeiro.extrato_lotes_detalhe') }}">
            <input type="hidden" name="lotes" value="{{ lotes_param }}">

            <div class="fin-quick-filters">
                <a href="{{ url_for('financeiro.extrato_lotes_detalhe', lotes=lotes_param, per_page=per_page, cnpj=filtro_cnpj, data_inicio=filtro_data_inicio, data_fim=filtro_data_fim) }}"
                   class="fin-quick-filter {{ 'active' if not request.args.get('status_match') }}">
                    Todos
                </a>
                <a href="{{ url_for('financeiro.extrato_lotes_detalhe', lotes=lotes_param, status_match='MATCH_ENCONTRADO', per_page=per_page) }}"
                   class="fin-quick-filter fin-quick-filter--success {{ 'active' if request.args.get('status_match') == 'MATCH_ENCONTRADO' }}">
                    <i class="fas fa-check"></i> Match
                </a>
                <a href="{{ url_for('financeiro.extrato_lotes_detalhe', lotes=lotes_param, status_match='MULTIPLOS_MATCHES', per_page=per_page) }}"
                   class="fin-quick-filter fin-quick-filter--warning {{ 'active' if request.args.get('status_match') == 'MULTIPLOS_MATCHES' }}">
                    <i class="fas fa-exclamation"></i> Multiplos
                </a>
                <a href="{{ url_for('financeiro.extrato_lotes_detalhe', lotes=lotes_param, status_match='SEM_MATCH', per_page=per_page) }}"
                   class="fin-quick-filter fin-quick-filter--danger {{ 'active' if request.args.get('status_match') == 'SEM_MATCH' }}">
                    <i class="fas fa-times"></i> Sem Match
                </a>
                <a href="{{ url_for('financeiro.extrato_lotes_detalhe', lotes=lotes_param, status_match='PENDENTE', per_page=per_page) }}"
                   class="fin-quick-filter {{ 'active' if request.args.get('status_match') == 'PENDENTE' }}">
                    <i class="fas fa-clock"></i> Pendentes
                </a>
            </div>

            <div class="fin-filters__grid">
                <div class="fin-filter-group">
                    <label class="fin-filter-group__label">CNPJ</label>
                    <input type="text" name="cnpj" class="fin-filter-group__input"
                           placeholder="Digite o CNPJ..." value="{{ filtro_cnpj or '' }}">
                </div>

                <div class="fin-filter-group">
                    <label class="fin-filter-group__label">Data Inicio</label>
                    <input type="date" name="data_inicio" class="fin-filter-group__input"
                           value="{{ filtro_data_inicio or '' }}">
                </div>

                <div class="fin-filter-group">
                    <label class="fin-filter-group__label">Data Fim</label>
                    <input type="date" name="data_fim" class="fin-filter-group__input"
                           value="{{ filtro_data_fim or '' }}">
                </div>

                <div class="fin-filter-group">
                    <label class="fin-filter-group__label">Exibir</label>
                    <select name="per_page" class="fin-filter-group__input fin-filter-group__select">
                        <option value="20" {{ 'selected' if per_page == 20 }}>20</option>
                        <option value="50" {{ 'selected' if per_page == 50 }}>50</option>
                        <option value="100" {{ 'selected' if per_page == 100 }}>100</option>
                        <option value="0" {{ 'selected' if per_page == 0 }}>Todos</option>
                    </select>
                </div>

                <div class="fin-filter-group">
                    <label class="fin-filter-group__label">&nbsp;</label>
                    <button type="submit" class="fin-btn fin-btn--primary">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
            </div>

            {% if request.args.get('status_match') %}
            <input type="hidden" name="status_match" value="{{ request.args.get('status_match') }}">
            {% endif %}
        </form>
    </div>

    <!-- ================================================================== -->
    <!-- LISTA DE ITENS -->
    <!-- ================================================================== -->
    <div class="fin-section">
        <div class="fin-section__header" onclick="this.closest('.fin-section').classList.toggle('collapsed')">
            <h2 class="fin-section__title">
                <i class="fas fa-list"></i>
                Itens do Extrato
                <span class="fin-section__badge">{{ itens|length }}</span>
            </h2>
            <i class="fas fa-chevron-down fin-section__toggle"></i>
        </div>

        <div class="fin-section__content">
            {% for item in itens %}
            <div class="fin-item-card
                {{ 'fin-item-card--conciliado' if item.status == 'CONCILIADO' }}
                {{ 'fin-item-card--aprovado' if item.aprovado and item.status != 'CONCILIADO' }}
                {{ 'fin-item-card--match' if item.status_match == 'MATCH_ENCONTRADO' and not item.aprovado }}
                {{ 'fin-item-card--multiplos' if item.status_match == 'MULTIPLOS_MATCHES' }}
                {{ 'fin-item-card--sem-match' if item.status_match == 'SEM_MATCH' }}"
                data-item-id="{{ item.id }}">

                <div class="fin-item-card__body">
                    <div class="fin-item-card__row">
                        <!-- SECAO 1: EXTRATO -->
                        <div class="fin-item-section">
                            <div class="fin-item-section__header fin-item-section__header--extrato">
                                <i class="fas fa-university"></i> EXTRATO BANCARIO
                                <span class="fin-badge fin-badge--muted" style="margin-left: auto;">Lote {{ item.lote_id }}</span>
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <span class="fin-tipo-transacao fin-tipo-transacao--{{ (item.tipo_transacao or 'outro')|lower }}">
                                    {{ item.tipo_transacao or 'OUTRO' }}
                                </span>
                                <div>
                                    {% if item.status == 'CONCILIADO' %}
                                    <span class="fin-badge fin-badge--info">CONCILIADO</span>
                                    {% elif item.aprovado %}
                                    <span class="fin-badge fin-badge--primary">APROVADO</span>
                                    {% elif item.status_match == 'MATCH_ENCONTRADO' %}
                                    <span class="fin-badge fin-badge--success">MATCH</span>
                                    {% elif item.status_match == 'MULTIPLOS_MATCHES' %}
                                    <span class="fin-badge fin-badge--warning">MULTIPLOS</span>
                                    {% elif item.status_match == 'SEM_MATCH' %}
                                    <span class="fin-badge fin-badge--danger">SEM MATCH</span>
                                    {% else %}
                                    <span class="fin-badge fin-badge--muted">PENDENTE</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="fin-valor-destaque" style="margin-bottom: 0.75rem;">
                                R$ {{ "{:,.2f}".format(item.valor) }}
                            </div>

                            <div class="fin-info-line">
                                <i class="fas fa-calendar-day"></i>
                                <strong>{{ item.data_transacao.strftime('%d/%m/%Y') }}</strong>
                            </div>
                            <div class="fin-info-line">
                                <i class="fas fa-building"></i>
                                {{ item.nome_pagador or 'Nao identificado' }}
                            </div>
                            <div class="fin-info-line">
                                <i class="fas fa-id-card"></i>
                                <code>{{ item.cnpj_pagador or 'CNPJ nao identificado' }}</code>
                            </div>
                        </div>

                        <!-- SECAO 2: COMPARACAO -->
                        <div class="fin-item-section">
                            <div class="fin-item-section__header fin-item-section__header--comparacao">
                                <i class="fas fa-balance-scale"></i> COMPARACAO
                            </div>

                            {% if item.titulo_id %}
                            <div class="fin-comparacao-box">
                                <div style="text-align: center; margin-bottom: 0.75rem;">
                                    {% if item.match_score >= 100 %}
                                    <span class="fin-score-badge fin-score-badge--100">{{ item.match_score }}%</span>
                                    {% elif item.match_score >= 90 %}
                                    <span class="fin-score-badge fin-score-badge--90">{{ item.match_score }}%</span>
                                    {% elif item.match_score >= 80 %}
                                    <span class="fin-score-badge fin-score-badge--80">{{ item.match_score }}%</span>
                                    {% else %}
                                    <span class="fin-score-badge fin-score-badge--low">{{ item.match_score or 0 }}%</span>
                                    {% endif %}
                                </div>

                                {% set diff_valor = (item.valor or 0) - (item.titulo_valor or 0) %}
                                <div class="fin-comparacao-item">
                                    <span style="color: var(--fin-text-muted);">Delta Valor:</span>
                                    <span class="{% if diff_valor > 0.01 %}fin-diff--positive{% elif diff_valor < -0.01 %}fin-diff--negative{% else %}fin-diff--zero{% endif %}" style="font-weight: 600;">
                                        {% if diff_valor > 0.01 %}+R$ {{ "{:,.2f}".format(diff_valor) }}
                                        {% elif diff_valor < -0.01 %}-R$ {{ "{:,.2f}".format(diff_valor|abs) }}
                                        {% else %}R$ 0,00 <i class="fas fa-check"></i>{% endif %}
                                    </span>
                                </div>
                            </div>
                            {% else %}
                            <div class="fin-empty" style="padding: 1.5rem;">
                                <div class="fin-empty__icon" style="font-size: 2rem;"><i class="fas fa-question-circle"></i></div>
                                <div class="fin-empty__text">Sem match</div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- SECAO 3: TITULO -->
                        <div class="fin-item-section">
                            <div class="fin-item-section__header fin-item-section__header--titulo">
                                <i class="fas fa-file-invoice"></i> TITULO A RECEBER
                            </div>

                            {% if item.titulo_id %}
                            <div class="fin-titulo-card fin-titulo-card--selected">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div>
                                        <strong>NF {{ item.titulo_nf }}</strong>
                                        <span class="fin-badge fin-badge--muted" style="margin-left: 0.25rem;">P{{ item.titulo_parcela }}</span>
                                    </div>
                                    <div class="fin-valor fin-valor--positive" style="font-size: 1.1rem;">
                                        R$ {{ "{:,.2f}".format(item.titulo_valor or 0) }}
                                    </div>
                                </div>

                                <div style="margin-top: 0.75rem;">
                                    {% if item.titulo %}
                                    <div class="fin-info-line">
                                        <i class="fas fa-building"></i>
                                        <strong>{{ item.titulo.raz_social_red or item.titulo.raz_social or 'N/A' }}</strong>
                                    </div>
                                    <div class="fin-info-line">
                                        <i class="fas fa-id-card"></i>
                                        <code>{{ item.titulo.cnpj or 'N/A' }}</code>
                                    </div>
                                    {% endif %}
                                    <div class="fin-info-line">
                                        <i class="fas fa-calendar-check"></i>
                                        Venc: <strong>{{ item.titulo_vencimento.strftime('%d/%m/%Y') if item.titulo_vencimento else 'N/A' }}</strong>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="fin-empty" style="padding: 1.5rem;">
                                <div class="fin-empty__icon" style="font-size: 2rem;"><i class="fas fa-search"></i></div>
                                <div class="fin-empty__text">Nenhum titulo vinculado</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="fin-alert fin-alert--info" style="margin: 1.5rem;">
                <i class="fas fa-info-circle"></i>
                <span>Nenhum item encontrado com os filtros selecionados.</span>
            </div>
            {% endfor %}

            <!-- Paginacao -->
            {% if pagination %}
            <div class="fin-pagination">
                <div class="fin-pagination__info">
                    Exibindo <strong>{{ itens|length }}</strong> de <strong>{{ pagination.total }}</strong> itens
                    (Pagina {{ pagination.page }} de {{ pagination.pages }})
                </div>
                <nav class="fin-pagination__nav">
                    {% if pagination.has_prev %}
                    <a class="fin-pagination__btn" href="{{ url_for('financeiro.extrato_lotes_detalhe', lotes=lotes_param, page=pagination.prev_num, per_page=per_page, status_match=request.args.get('status_match'), cnpj=filtro_cnpj) }}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    {% endif %}

                    {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if p %}
                            {% if p == pagination.page %}
                            <span class="fin-pagination__btn active">{{ p }}</span>
                            {% else %}
                            <a class="fin-pagination__btn" href="{{ url_for('financeiro.extrato_lotes_detalhe', lotes=lotes_param, page=p, per_page=per_page, status_match=request.args.get('status_match'), cnpj=filtro_cnpj) }}">{{ p }}</a>
                            {% endif %}
                        {% else %}
                            <span class="fin-pagination__btn" style="cursor: default;">...</span>
                        {% endif %}
                    {% endfor %}

                    {% if pagination.has_next %}
                    <a class="fin-pagination__btn" href="{{ url_for('financeiro.extrato_lotes_detalhe', lotes=lotes_param, page=pagination.next_num, per_page=per_page, status_match=request.args.get('status_match'), cnpj=filtro_cnpj) }}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/financeiro/extrato.js') }}"></script>
<script>
const loteIds = [{% for lote in lotes %}{{ lote.id }}{% if not loop.last %}, {% endif %}{% endfor %}];

function executarMatchingMultiplos() {
    if (!confirm(`Executar matching automatico para ${loteIds.length} lote(s)?`)) return;

    const btn = document.getElementById('btnMatching');
    const textoOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

    let processados = 0;
    let erros = [];

    function processarProximoLote(index) {
        if (index >= loteIds.length) {
            if (erros.length > 0) {
                alert(`Matching concluido com ${erros.length} erro(s)`);
            } else {
                alert('Matching concluido com sucesso!');
            }
            location.reload();
            return;
        }

        fetch(`/financeiro/extrato/executar-matching/${loteIds[index]}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(data => {
            processados++;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Lote ${processados}/${loteIds.length}...`;
            if (!data.success) {
                erros.push(`Lote ${loteIds[index]}: ${data.error}`);
            }
            processarProximoLote(index + 1);
        })
        .catch(err => {
            erros.push(`Lote ${loteIds[index]}: ${err}`);
            processarProximoLote(index + 1);
        });
    }

    processarProximoLote(0);
}

function aprovarTodosMultiplos() {
    if (!confirm('Aprovar todos os itens com match unico em todos os lotes?')) return;

    fetch('/financeiro/extrato/api/aprovar-todos-multiplos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lote_ids: loteIds })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(`${data.aprovados} itens aprovados`);
            location.reload();
        } else {
            alert(data.error || 'Erro ao aprovar');
        }
    });
}

function conciliarMultiplos() {
    if (!confirm('Conciliar todos os itens aprovados em todos os lotes?')) return;

    const btn = event.target;
    const textoOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conciliando...';

    fetch('/financeiro/extrato/api/conciliar-multiplos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lote_ids: loteIds })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(`${data.conciliados} itens conciliados`);
            location.reload();
        } else {
            alert(data.error || 'Erro ao conciliar');
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
        }
    })
    .catch(err => {
        alert('Erro de conexao');
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    });
}
</script>
{% endblock %}
