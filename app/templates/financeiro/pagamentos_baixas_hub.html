{% extends "base.html" %}

{% block title %}Baixa de Pagamentos - Contas a Pagar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/financeiro/extrato.css') }}">
{% endblock %}

{% block content %}
<div class="fin-container premium-page">
    <!-- ================================================================== -->
    <!-- HEADER                                                              -->
    <!-- ================================================================== -->
    <header class="fin-header reveal">
        <div class="fin-header__content">
            <nav class="fin-breadcrumb">
                <a href="{{ url_for('financeiro.contas_pagar_hub') }}" class="fin-breadcrumb__item">
                    <i class="fas fa-home"></i> Contas a Pagar
                </a>
                <span class="fin-breadcrumb__separator">/</span>
                <span class="fin-breadcrumb__current">Baixa de Pagamentos</span>
            </nav>
            <h1 class="fin-header__title">
                <i class="fas fa-file-import"></i>
                Baixa de Pagamentos
            </h1>
            <p class="fin-header__subtitle">
                Vincular pagamentos do extrato bancario a titulos de fornecedores
            </p>
        </div>
        <div class="fin-header__actions">
            <a href="{{ url_for('financeiro.contas_pagar_hub') }}" class="btn-ext btn-ext--ghost">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                <i class="fas fa-sun theme-toggle__icon theme-toggle__icon--light"></i>
                <i class="fas fa-moon theme-toggle__icon theme-toggle__icon--dark"></i>
            </button>
        </div>
    </header>

    <!-- ================================================================== -->
    <!-- IMPORTAR DO EXTRATO                                                 -->
    <!-- ================================================================== -->
    <div class="fin-section">
        <div class="fin-section__header">
            <h2 class="fin-section__title">
                <i class="fas fa-download"></i>
                Importar do Extrato Bancario
            </h2>
        </div>
        <div class="fin-section__content">
            {% if extratos_disponiveis %}
            <div style="padding: 1.25rem;">
                <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 1rem;">
                    Selecione um extrato para importar as linhas de saida (pagamentos):
                </p>
                <div class="fin-table-wrapper">
                    <table class="fin-table">
                        <thead>
                            <tr>
                                <th>Extrato</th>
                                <th>Journal</th>
                                <th>Data</th>
                                <th class="text-center">Status</th>
                                <th class="text-end">Acoes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for extrato in extratos_disponiveis %}
                            <tr>
                                <td>{{ extrato.statement_name or extrato.nome }}</td>
                                <td><span class="fin-badge fin-badge--muted">{{ extrato.journal_code }}</span></td>
                                <td class="fin-text-mono">{{ extrato.data_extrato.strftime('%d/%m/%Y') if extrato.data_extrato else '-' }}</td>
                                <td class="text-center">
                                    <span class="fin-badge {% if extrato.status == 'CONCLUIDO' %}fin-badge--success{% else %}fin-badge--warning{% endif %}">
                                        {{ extrato.status }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <form action="{{ url_for('financeiro.pagamentos_importar_extrato', extrato_lote_id=extrato.id) }}" method="POST" style="display: inline;">
                                        <button type="submit" class="btn-ext btn-ext--primary btn-ext--sm">
                                            <i class="fas fa-download"></i> Importar Saidas
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="fin-empty">
                <div class="fin-empty__icon"><i class="fas fa-file-invoice"></i></div>
                <div class="fin-empty__title">Nenhum extrato disponivel</div>
                <div class="fin-empty__text">
                    Importe um extrato primeiro em
                    <a href="{{ url_for('financeiro.extrato_hub') }}" class="fin-link">Extrato Bancario</a>.
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- FILTROS                                                             -->
    <!-- ================================================================== -->
    <div class="fin-filters">
        <form method="GET" class="fin-filters__grid">
            <div class="fin-filter-group">
                <label class="fin-filter-group__label">Status</label>
                <select name="status" class="fin-filter-group__input fin-filter-group__select" onchange="this.form.submit()">
                    <option value="">Todos</option>
                    <option value="IMPORTADO" {% if status_filtro == 'IMPORTADO' %}selected{% endif %}>Importado</option>
                    <option value="AGUARDANDO_APROVACAO" {% if status_filtro == 'AGUARDANDO_APROVACAO' %}selected{% endif %}>Aguardando Aprovacao</option>
                    <option value="PROCESSANDO" {% if status_filtro == 'PROCESSANDO' %}selected{% endif %}>Processando</option>
                    <option value="CONCLUIDO" {% if status_filtro == 'CONCLUIDO' %}selected{% endif %}>Concluido</option>
                </select>
            </div>
        </form>
    </div>

    <!-- ================================================================== -->
    <!-- LISTA DE LOTES                                                      -->
    <!-- ================================================================== -->
    <div class="fin-section">
        <div class="fin-section__header">
            <h2 class="fin-section__title">
                <i class="fas fa-layer-group"></i>
                Lotes de Pagamentos
                {% if lotes.items %}
                <span class="fin-section__badge">{{ lotes.total }}</span>
                {% endif %}
            </h2>
        </div>
        <div class="fin-section__content">
            {% if lotes.items %}
            <div class="fin-table-wrapper">
                <table class="fin-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">ID</th>
                            <th>Nome</th>
                            <th>Journal</th>
                            <th>Data</th>
                            <th class="text-center">Itens</th>
                            <th class="text-end">Valor Total</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Progresso</th>
                            <th class="text-end">Acoes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lote in lotes.items %}
                        <tr>
                            <td class="fin-text-mono">{{ lote.id }}</td>
                            <td>
                                <a href="{{ url_for('financeiro.pagamentos_baixas_lote_detalhe', lote_id=lote.id) }}" class="fin-link">
                                    {{ lote.nome[:50] }}{% if lote.nome|length > 50 %}...{% endif %}
                                </a>
                            </td>
                            <td><span class="fin-badge fin-badge--muted">{{ lote.journal_code or '-' }}</span></td>
                            <td class="fin-text-mono">{{ lote.data_inicio.strftime('%d/%m/%Y') if lote.data_inicio else '-' }}</td>
                            <td class="text-center fin-text-mono">{{ lote.total_linhas }}</td>
                            <td class="text-end">
                                <span class="fin-valor-destaque--sm">R$ {{ '{:,.2f}'.format(lote.valor_total or 0) }}</span>
                            </td>
                            <td class="text-center">
                                <span class="fin-badge
                                    {% if lote.status == 'CONCLUIDO' %}fin-badge--success
                                    {% elif lote.status == 'PROCESSANDO' %}fin-badge--primary
                                    {% elif lote.status == 'AGUARDANDO_APROVACAO' %}fin-badge--warning
                                    {% elif lote.status == 'ERRO' %}fin-badge--danger
                                    {% else %}fin-badge--muted{% endif %}">
                                    {{ lote.status }}
                                </span>
                            </td>
                            <td class="text-center">
                                {% if lote.total_linhas > 0 %}
                                <div class="fin-progress" style="min-width: 100px;">
                                    <div class="fin-progress__bar fin-progress__bar--success" style="width: {{ (lote.linhas_sucesso / lote.total_linhas * 100)|int }}%">
                                        {{ lote.linhas_sucesso }}
                                    </div>
                                    {% if lote.linhas_erro %}
                                    <div class="fin-progress__bar fin-progress__bar--danger" style="width: {{ (lote.linhas_erro / lote.total_linhas * 100)|int }}%">
                                        {{ lote.linhas_erro }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <a href="{{ url_for('financeiro.pagamentos_baixas_lote_detalhe', lote_id=lote.id) }}" class="btn-ext btn-ext--ghost btn-ext--sm">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginacao -->
            {% if lotes.pages > 1 %}
            <div class="fin-pagination">
                <div class="fin-pagination__info">
                    Pagina <strong>{{ lotes.page }}</strong> de <strong>{{ lotes.pages }}</strong>
                </div>
                <nav class="fin-pagination__nav">
                    {% for page_num in lotes.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if page_num %}
                            <a href="{{ url_for('financeiro.pagamentos_baixas_hub', page=page_num, status=status_filtro) }}"
                               class="fin-pagination__btn {% if page_num == lotes.page %}active{% endif %}">
                                {{ page_num }}
                            </a>
                        {% else %}
                            <span class="fin-pagination__btn fin-pagination__ellipsis">...</span>
                        {% endif %}
                    {% endfor %}
                </nav>
            </div>
            {% endif %}

            {% else %}
            <div class="fin-empty">
                <div class="fin-empty__icon"><i class="fas fa-inbox"></i></div>
                <div class="fin-empty__title">Nenhum lote de pagamentos encontrado</div>
                <div class="fin-empty__text">Importe um extrato bancario para comecar.</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/financeiro/extrato.js') }}"></script>
{% endblock %}
