{% extends "base.html" %}

{% block title %}Contas a Receber - Central{% endblock %}

{% block extra_css %}
<style>
    .hub-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .hub-card {
        border: none;
        border-radius: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        height: 100%;
    }

    .hub-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .hub-card .card-body {
        padding: 2rem;
    }

    .hub-icon {
        width: 80px;
        height: 80px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin-bottom: 1.5rem;
    }

    .hub-icon.primary {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .hub-icon.info {
        background: linear-gradient(135deg, #007bff 0%, #17a2b8 100%);
        color: white;
    }

    .hub-icon.warning {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
    }

    .hub-icon.secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
    }

    .hub-card h4 {
        color: #343a40;
        font-weight: 600;
        margin-bottom: 0.75rem;
    }

    .hub-card p {
        color: #6c757d;
        font-size: 0.95rem;
        margin-bottom: 1.5rem;
    }

    .hub-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 0.75rem;
    }

    .stats-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #343a40;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-hub {
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 hub-container">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-1">
                <i class="fas fa-file-invoice-dollar text-success"></i>
                Contas a Receber
            </h2>
            <p class="text-muted mb-0">
                Central de gestão de contas a receber - Dados sincronizados do Odoo
            </p>
        </div>
    </div>

    <!-- Estatísticas Rápidas -->
    <div class="stats-container" id="statsContainer">
        <div class="row">
            <div class="col-md-3 stat-item">
                <div class="stat-value" id="statTotal">-</div>
                <div class="stat-label">Total de Títulos</div>
            </div>
            <div class="col-md-3 stat-item">
                <div class="stat-value" id="statFB">-</div>
                <div class="stat-label">FB (Fábrica)</div>
            </div>
            <div class="col-md-3 stat-item">
                <div class="stat-value" id="statSC">-</div>
                <div class="stat-label">SC (Santa Catarina)</div>
            </div>
            <div class="col-md-3 stat-item">
                <div class="stat-value" id="statCD">-</div>
                <div class="stat-label">CD (Centro Dist.)</div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-12 text-center">
                <small class="text-muted">
                    <i class="fas fa-sync-alt"></i>
                    Última sincronização: <span id="ultimaSync">-</span>
                </small>
            </div>
        </div>
    </div>

    <!-- Cards de Navegação - Linha 1: Principais -->
    <div class="row g-4 mb-4">
        <!-- Consultar Títulos -->
        <div class="col-md-6 col-lg-4">
            <div class="card hub-card position-relative">
                <span class="badge bg-success hub-badge">PRINCIPAL</span>
                <div class="card-body">
                    <div class="hub-icon primary">
                        <i class="fas fa-search-dollar"></i>
                    </div>
                    <h4>Consultar Títulos</h4>
                    <p>
                        Visualize e gerencie todos os títulos a receber com filtros avançados,
                        ordenação e paginação. Acesse informações de entrega e agendamento.
                    </p>
                    <a href="{{ url_for('financeiro.listar_contas_receber') }}" class="btn btn-success btn-hub w-100">
                        <i class="fas fa-table me-2"></i>
                        Acessar Listagem
                    </a>
                </div>
            </div>
        </div>

        <!-- Exportar Relatórios -->
        <div class="col-md-6 col-lg-4">
            <div class="card hub-card">
                <div class="card-body">
                    <div class="hub-icon info">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <h4>Exportar Relatórios</h4>
                    <p>
                        Exporte dados para Excel ou acesse via API JSON para integração
                        com Power Query e outras ferramentas de análise.
                    </p>
                    <a href="{{ url_for('financeiro.contas_receber_exportar') }}" class="btn btn-primary btn-hub w-100">
                        <i class="fas fa-download me-2"></i>
                        Exportar Dados
                    </a>
                </div>
            </div>
        </div>

        <!-- Sincronização -->
        <div class="col-md-6 col-lg-4">
            <div class="card hub-card">
                <div class="card-body">
                    <div class="hub-icon warning">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <h4>Sincronização</h4>
                    <p>
                        Sincronize dados com o Odoo manualmente.
                        A sincronização automática ocorre a cada 30 minutos.
                    </p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-warning btn-hub flex-grow-1" onclick="sincronizarOdoo()" id="btnSincronizar">
                            <i class="fas fa-cloud-download-alt me-2"></i>
                            Rápida (7 dias)
                        </button>
                        <button class="btn btn-outline-warning btn-hub" onclick="abrirModalSincronizacao()" title="Sincronização por período">
                            <i class="fas fa-calendar-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Sincronização por Período -->
    <div class="modal fade" id="modalSincronizacao" tabindex="-1" aria-labelledby="modalSincronizacaoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modalSincronizacaoLabel">
                        <i class="fas fa-sync-alt me-2"></i>
                        Sincronização por Período
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">
                        Escolha o período para sincronizar os dados de Contas a Receber do Odoo.
                        Use para importação inicial ou reprocessamento de períodos específicos.
                    </p>

                    <!-- Opções rápidas -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Opções Rápidas</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDias(7)">
                                7 dias
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDias(15)">
                                15 dias
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDias(30)">
                                30 dias
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDias(60)">
                                60 dias
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDias(90)">
                                90 dias
                            </button>
                        </div>
                    </div>

                    <hr>

                    <!-- Período personalizado -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Período Personalizado</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label small text-muted">Data Início</label>
                                <input type="date" class="form-control" id="syncDataInicio">
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted">Data Fim (opcional)</label>
                                <input type="date" class="form-control" id="syncDataFim">
                            </div>
                        </div>
                        <small class="text-muted">
                            Se não informar Data Fim, busca todos os registros a partir da Data Início.
                        </small>
                    </div>

                    <!-- Resumo -->
                    <div class="alert alert-info small" id="syncResumo">
                        <i class="fas fa-info-circle me-1"></i>
                        Selecione um período para sincronizar.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" onclick="executarSincronizacaoPeriodo()" id="btnSincronizarPeriodo">
                        <i class="fas fa-sync-alt me-2"></i>
                        Sincronizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de Navegação - Linha 2: Configurações -->
    <h5 class="text-muted mb-3"><i class="fas fa-cogs"></i> Configurações</h5>
    <div class="row g-4">
        <!-- Tipos (Confirmação, Ação, etc) -->
        <div class="col-md-6 col-lg-3">
            <div class="card hub-card">
                <div class="card-body">
                    <div class="hub-icon secondary">
                        <i class="fas fa-tags"></i>
                    </div>
                    <h4>Tipos</h4>
                    <p>
                        Gerencie tipos de Confirmação, Ação Necessária e Abatimento.
                    </p>
                    <a href="{{ url_for('financeiro.listar_tipos') }}" class="btn btn-secondary btn-hub w-100">
                        <i class="fas fa-cog me-2"></i>
                        Gerenciar Tipos
                    </a>
                </div>
            </div>
        </div>

        <!-- Abatimentos (Cadastro geral) -->
        <div class="col-md-6 col-lg-3">
            <div class="card hub-card">
                <div class="card-body">
                    <div class="hub-icon" style="background: linear-gradient(135deg, #fd7e14 0%, #dc3545 100%); color: white;">
                        <i class="fas fa-minus-circle"></i>
                    </div>
                    <h4>Abatimentos</h4>
                    <p>
                        Visualize e gerencie todos os abatimentos cadastrados no sistema.
                    </p>
                    <a href="{{ url_for('financeiro.listar_abatimentos') }}" class="btn btn-outline-danger btn-hub w-100">
                        <i class="fas fa-list me-2"></i>
                        Ver Abatimentos
                    </a>
                </div>
            </div>
        </div>

        <!-- Liberação Antecipação -->
        <div class="col-md-6 col-lg-3">
            <div class="card hub-card">
                <div class="card-body">
                    <div class="hub-icon" style="background: linear-gradient(135deg, #20c997 0%, #28a745 100%); color: white;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h4>Liberação Antecipação</h4>
                    <p>
                        Configure dias úteis para liberação de antecipação por cliente.
                    </p>
                    <a href="{{ url_for('financeiro.listar_liberacao_antecipacao') }}" class="btn btn-outline-success btn-hub w-100">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Configurar
                    </a>
                </div>
            </div>
        </div>

        <!-- Baixa de Títulos via Excel -->
        <div class="col-md-6 col-lg-3">
            <div class="card hub-card position-relative">
                <span class="badge bg-info hub-badge">NOVO</span>
                <div class="card-body">
                    <div class="hub-icon" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); color: white;">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h4>Baixa via Excel</h4>
                    <p>
                        Importe baixas de títulos em lote a partir de arquivo Excel.
                    </p>
                    <a href="{{ url_for('financeiro.baixas_hub') }}" class="btn btn-outline-purple btn-hub w-100" style="border-color: #6f42c1; color: #6f42c1;">
                        <i class="fas fa-upload me-2"></i>
                        Importar Baixas
                    </a>
                </div>
            </div>
        </div>

        <!-- Conciliação via Extrato -->
        <div class="col-md-6 col-lg-3">
            <div class="card hub-card position-relative">
                <span class="badge bg-success hub-badge">NOVO</span>
                <div class="card-body">
                    <div class="hub-icon" style="background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); color: white;">
                        <i class="fas fa-university"></i>
                    </div>
                    <h4>Conciliação Extrato</h4>
                    <p>
                        Concilie recebimentos do extrato bancário com títulos a receber.
                    </p>
                    <a href="{{ url_for('financeiro.extrato_hub') }}" class="btn btn-outline-info btn-hub w-100">
                        <i class="fas fa-link me-2"></i>
                        Conciliar
                    </a>
                </div>
            </div>
        </div>

    </div>

    <!-- Informações Adicionais -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Sobre os Dados
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6><i class="fas fa-database text-primary"></i> Fonte de Dados</h6>
                            <p class="text-muted small">
                                Dados extraídos do modelo <code>account.move.line</code> do Odoo,
                                filtrados por 11 regras de negócio.
                            </p>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-sync text-success"></i> Sincronização</h6>
                            <p class="text-muted small">
                                Automática a cada 30 minutos via scheduler.
                                Janela de 120 minutos para alterações incrementais.
                            </p>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-link text-info"></i> Enriquecimento</h6>
                            <p class="text-muted small">
                                Dados enriquecidos com informações de entregas, agendamentos
                                e status de finalização do sistema local.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Carregar estatísticas ao abrir a página
document.addEventListener('DOMContentLoaded', function() {
    carregarEstatisticas();
});

function carregarEstatisticas() {
    fetch("{{ url_for('financeiro.status_contas_receber') }}")
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('statTotal').textContent = data.total.toLocaleString('pt-BR');

                // Por empresa
                data.por_empresa.forEach(emp => {
                    if (emp.empresa.includes('FB')) {
                        document.getElementById('statFB').textContent = emp.total.toLocaleString('pt-BR');
                    } else if (emp.empresa.includes('SC')) {
                        document.getElementById('statSC').textContent = emp.total.toLocaleString('pt-BR');
                    } else if (emp.empresa.includes('CD')) {
                        document.getElementById('statCD').textContent = emp.total.toLocaleString('pt-BR');
                    }
                });

                // Última sincronização
                if (data.ultima_sincronizacao) {
                    const dataSync = new Date(data.ultima_sincronizacao);
                    document.getElementById('ultimaSync').textContent = dataSync.toLocaleString('pt-BR');
                } else {
                    document.getElementById('ultimaSync').textContent = 'Nunca';
                }
            }
        })
        .catch(error => {
            console.error('Erro ao carregar estatísticas:', error);
        });
}

function sincronizarOdoo() {
    const btn = document.getElementById('btnSincronizar');
    const textoOriginal = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sincronizando...';

    fetch("{{ url_for('financeiro.sincronizar_contas_receber_odoo') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            toastr.success(
                `Novos: ${data.novos} | Atualizados: ${data.atualizados} | Enriquecidos: ${data.enriquecidos}`,
                'Sincronização Concluída!'
            );
            // Recarregar estatísticas
            carregarEstatisticas();
        } else {
            toastr.error(data.error || 'Erro desconhecido', 'Erro na Sincronização');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        toastr.error('Erro ao conectar com o servidor', 'Erro');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    });
}

// =============================================
// MODAL DE SINCRONIZAÇÃO POR PERÍODO
// =============================================

let modalSincronizacao = null;

function abrirModalSincronizacao() {
    if (!modalSincronizacao) {
        modalSincronizacao = new bootstrap.Modal(document.getElementById('modalSincronizacao'));
    }

    // Limpar campos
    document.getElementById('syncDataInicio').value = '';
    document.getElementById('syncDataFim').value = '';
    atualizarResumoSync();

    modalSincronizacao.show();
}

function setDias(dias) {
    const hoje = new Date();
    const dataInicio = new Date(hoje);
    dataInicio.setDate(hoje.getDate() - dias);

    // Formatar como YYYY-MM-DD usando timezone local (evita bug UTC)
    const formatarData = (d) => {
        const ano = d.getFullYear();
        const mes = String(d.getMonth() + 1).padStart(2, '0');
        const dia = String(d.getDate()).padStart(2, '0');
        return `${ano}-${mes}-${dia}`;
    };

    document.getElementById('syncDataInicio').value = formatarData(dataInicio);
    document.getElementById('syncDataFim').value = formatarData(hoje);

    atualizarResumoSync();
}

// Helper para parsear data YYYY-MM-DD sem conversão de timezone (evita bug UTC → local)
function parseLocalDate(dateStr) {
    const [year, month, day] = dateStr.split('-').map(Number);
    return new Date(year, month - 1, day);  // month é 0-indexed em JS
}

function atualizarResumoSync() {
    const dataInicio = document.getElementById('syncDataInicio').value;
    const dataFim = document.getElementById('syncDataFim').value;
    const resumo = document.getElementById('syncResumo');

    if (!dataInicio) {
        resumo.className = 'alert alert-info small';
        resumo.innerHTML = '<i class="fas fa-info-circle me-1"></i> Selecione um período para sincronizar.';
        return;
    }

    const inicio = parseLocalDate(dataInicio);
    const inicioFormatado = inicio.toLocaleDateString('pt-BR');

    if (dataFim) {
        const fim = parseLocalDate(dataFim);
        const fimFormatado = fim.toLocaleDateString('pt-BR');
        const dias = Math.ceil((fim - inicio) / (1000 * 60 * 60 * 24)) + 1;

        resumo.className = 'alert alert-warning small';
        resumo.innerHTML = `<i class="fas fa-calendar-check me-1"></i> Sincronizar de <strong>${inicioFormatado}</strong> até <strong>${fimFormatado}</strong> (${dias} dias)`;
    } else {
        resumo.className = 'alert alert-warning small';
        resumo.innerHTML = `<i class="fas fa-calendar-check me-1"></i> Sincronizar a partir de <strong>${inicioFormatado}</strong> até hoje`;
    }
}

// Event listeners para atualizar resumo
document.getElementById('syncDataInicio')?.addEventListener('change', atualizarResumoSync);
document.getElementById('syncDataFim')?.addEventListener('change', atualizarResumoSync);

function executarSincronizacaoPeriodo() {
    const dataInicio = document.getElementById('syncDataInicio').value;
    const dataFim = document.getElementById('syncDataFim').value;

    if (!dataInicio) {
        toastr.warning('Informe a Data Início', 'Campo obrigatório');
        return;
    }

    const btn = document.getElementById('btnSincronizarPeriodo');
    const textoOriginal = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sincronizando...';

    const payload = { data_inicio: dataInicio };
    if (dataFim) {
        payload.data_fim = dataFim;
    }

    fetch("{{ url_for('financeiro.sincronizar_contas_receber_odoo') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            toastr.success(
                `Período: ${data.periodo}<br>Novos: ${data.novos} | Atualizados: ${data.atualizados} | Enriquecidos: ${data.enriquecidos}`,
                'Sincronização Concluída!'
            );
            // Fechar modal e recarregar estatísticas
            modalSincronizacao.hide();
            carregarEstatisticas();
        } else {
            toastr.error(data.error || 'Erro desconhecido', 'Erro na Sincronização');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        toastr.error('Erro ao conectar com o servidor', 'Erro');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    });
}
</script>
{% endblock %}
