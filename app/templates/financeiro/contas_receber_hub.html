{% extends "base.html" %}

{% block title %}Contas a Receber - Central{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/financeiro/extrato.css') }}">
{% endblock %}

{% block content %}
<div class="fin-container premium-page">
    <!-- ================================================================== -->
    <!-- HEADER                                                              -->
    <!-- ================================================================== -->
    <header class="fin-header reveal">
        <div class="fin-header__content">
            <h1 class="fin-header__title">
                <i class="fas fa-file-invoice-dollar"></i>
                Contas a Receber
            </h1>
            <p class="fin-header__subtitle">
                Central de gestão de contas a receber - Dados sincronizados do Odoo
            </p>
        </div>
        <div class="fin-header__actions">
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                <i class="fas fa-sun theme-toggle__icon theme-toggle__icon--light"></i>
                <i class="fas fa-moon theme-toggle__icon theme-toggle__icon--dark"></i>
            </button>
        </div>
    </header>

    <!-- ================================================================== -->
    <!-- ESTATÍSTICAS RÁPIDAS                                               -->
    <!-- ================================================================== -->
    <div class="fin-stats-grid" id="statsContainer">
        <div class="fin-stat-card">
            <div class="fin-stat-card__value" id="statTotal">-</div>
            <div class="fin-stat-card__label">Total de Títulos</div>
        </div>
        <div class="fin-stat-card">
            <div class="fin-stat-card__value" id="statFB">-</div>
            <div class="fin-stat-card__label">FB (Fábrica)</div>
        </div>
        <div class="fin-stat-card">
            <div class="fin-stat-card__value" id="statSC">-</div>
            <div class="fin-stat-card__label">SC (Santa Catarina)</div>
        </div>
        <div class="fin-stat-card">
            <div class="fin-stat-card__value" id="statCD">-</div>
            <div class="fin-stat-card__label">CD (Centro Dist.)</div>
        </div>
    </div>

    <div class="fin-sync-info">
        <i class="fas fa-sync-alt"></i>
        Última sincronização: <span id="ultimaSync">-</span>
    </div>

    <!-- ================================================================== -->
    <!-- CARDS PRINCIPAIS                                                    -->
    <!-- ================================================================== -->
    <div class="fin-hub-section">
        <h2 class="fin-hub-section__title">
            <i class="fas fa-star"></i>
            Principais
        </h2>

        <div class="fin-hub-grid">
            <!-- Consultar Títulos -->
            <a href="{{ url_for('financeiro.listar_contas_receber') }}" class="fin-hub-card fin-hub-card--primary">
                <span class="fin-hub-card__badge fin-hub-card__badge--success">PRINCIPAL</span>
                <div class="fin-hub-card__icon fin-hub-card__icon--success">
                    <i class="fas fa-search-dollar"></i>
                </div>
                <h3 class="fin-hub-card__title">Consultar Títulos</h3>
                <p class="fin-hub-card__desc">
                    Visualize e gerencie todos os títulos a receber com filtros avançados,
                    ordenação e paginação. Acesse informações de entrega e agendamento.
                </p>
                <span class="fin-hub-card__action">
                    <i class="fas fa-table"></i>
                    Acessar Listagem
                </span>
            </a>

            <!-- Exportar Relatórios -->
            <a href="{{ url_for('financeiro.contas_receber_exportar') }}" class="fin-hub-card">
                <div class="fin-hub-card__icon fin-hub-card__icon--info">
                    <i class="fas fa-file-export"></i>
                </div>
                <h3 class="fin-hub-card__title">Exportar Relatórios</h3>
                <p class="fin-hub-card__desc">
                    Exporte dados para Excel ou acesse via API JSON para integração
                    com Power Query e outras ferramentas de análise.
                </p>
                <span class="fin-hub-card__action">
                    <i class="fas fa-download"></i>
                    Exportar Dados
                </span>
            </a>

            <!-- Sincronização -->
            <div class="fin-hub-card fin-hub-card--interactive">
                <div class="fin-hub-card__icon fin-hub-card__icon--warning">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <h3 class="fin-hub-card__title">Sincronização</h3>
                <p class="fin-hub-card__desc">
                    Sincronize dados com o Odoo manualmente.
                    A sincronização automática ocorre a cada 30 minutos.
                </p>
                <div class="fin-hub-card__buttons">
                    <button class="btn-ext btn-ext--warning" onclick="sincronizarOdoo()" id="btnSincronizar">
                        <i class="fas fa-cloud-download-alt"></i>
                        Rápida (7 dias)
                    </button>
                    <button class="btn-ext btn-ext--outline" onclick="abrirModalSincronizacao()" title="Sincronização por período">
                        <i class="fas fa-calendar-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- CONFIGURAÇÕES                                                       -->
    <!-- ================================================================== -->
    <div class="fin-hub-section">
        <h2 class="fin-hub-section__title">
            <i class="fas fa-cogs"></i>
            Configurações
        </h2>

        <div class="fin-hub-grid fin-hub-grid--sm">
            <!-- Tipos -->
            <a href="{{ url_for('financeiro.listar_tipos') }}" class="fin-hub-card fin-hub-card--compact">
                <div class="fin-hub-card__icon fin-hub-card__icon--secondary">
                    <i class="fas fa-tags"></i>
                </div>
                <h3 class="fin-hub-card__title">Tipos</h3>
                <p class="fin-hub-card__desc">
                    Gerencie tipos de Confirmação, Ação Necessária e Abatimento.
                </p>
            </a>

            <!-- Abatimentos -->
            <a href="{{ url_for('financeiro.listar_abatimentos') }}" class="fin-hub-card fin-hub-card--compact">
                <div class="fin-hub-card__icon fin-hub-card__icon--danger">
                    <i class="fas fa-minus-circle"></i>
                </div>
                <h3 class="fin-hub-card__title">Abatimentos</h3>
                <p class="fin-hub-card__desc">
                    Visualize e gerencie todos os abatimentos cadastrados no sistema.
                </p>
            </a>

            <!-- Liberação Antecipação -->
            <a href="{{ url_for('financeiro.listar_liberacao_antecipacao') }}" class="fin-hub-card fin-hub-card--compact">
                <div class="fin-hub-card__icon fin-hub-card__icon--success">
                    <i class="fas fa-clock"></i>
                </div>
                <h3 class="fin-hub-card__title">Liberação Antecipação</h3>
                <p class="fin-hub-card__desc">
                    Configure dias úteis para liberação de antecipação por cliente.
                </p>
            </a>

            <!-- Baixa via Excel -->
            <a href="{{ url_for('financeiro.baixas_hub') }}" class="fin-hub-card fin-hub-card--compact">
                <span class="fin-hub-card__badge fin-hub-card__badge--info">NOVO</span>
                <div class="fin-hub-card__icon fin-hub-card__icon--purple">
                    <i class="fas fa-file-excel"></i>
                </div>
                <h3 class="fin-hub-card__title">Baixa via Excel</h3>
                <p class="fin-hub-card__desc">
                    Importe baixas de títulos em lote a partir de arquivo Excel.
                </p>
            </a>

            <!-- Conciliação Extrato -->
            <a href="{{ url_for('financeiro.extrato_hub') }}" class="fin-hub-card fin-hub-card--compact">
                <span class="fin-hub-card__badge fin-hub-card__badge--success">NOVO</span>
                <div class="fin-hub-card__icon fin-hub-card__icon--cyan">
                    <i class="fas fa-university"></i>
                </div>
                <h3 class="fin-hub-card__title">Conciliação Extrato</h3>
                <p class="fin-hub-card__desc">
                    Concilie recebimentos do extrato bancário com títulos a receber.
                </p>
            </a>

            <!-- Correção de Datas -->
            <a href="{{ url_for('financeiro.correcao_datas_index') }}" class="fin-hub-card fin-hub-card--compact">
                <span class="fin-hub-card__badge fin-hub-card__badge--warning">CIEL IT</span>
                <div class="fin-hub-card__icon fin-hub-card__icon--danger">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <h3 class="fin-hub-card__title">Correção Datas</h3>
                <p class="fin-hub-card__desc">
                    Corrige datas de lançamento incorretas em NFs de Crédito.
                </p>
            </a>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- INFORMAÇÕES SOBRE DADOS                                            -->
    <!-- ================================================================== -->
    <div class="fin-info-panel">
        <div class="fin-info-panel__header">
            <i class="fas fa-info-circle"></i>
            Sobre os Dados
        </div>
        <div class="fin-info-panel__body">
            <div class="fin-info-panel__grid">
                <div class="fin-info-panel__item">
                    <h4><i class="fas fa-database"></i> Fonte de Dados</h4>
                    <p>
                        Dados extraídos do modelo <code>account.move.line</code> do Odoo,
                        filtrados por 11 regras de negócio.
                    </p>
                </div>
                <div class="fin-info-panel__item">
                    <h4><i class="fas fa-sync"></i> Sincronização</h4>
                    <p>
                        Automática a cada 30 minutos via scheduler.
                        Janela de 120 minutos para alterações incrementais.
                    </p>
                </div>
                <div class="fin-info-panel__item">
                    <h4><i class="fas fa-link"></i> Enriquecimento</h4>
                    <p>
                        Dados enriquecidos com informações de entregas, agendamentos
                        e status de finalização do sistema local.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ====================================================================== -->
<!-- MODAL DE SINCRONIZAÇÃO POR PERÍODO                                     -->
<!-- ====================================================================== -->
<div class="modal fade fin-modal" id="modalSincronizacao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sync-alt"></i>
                    Sincronização por Período
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="fin-modal__hint">
                    Escolha o período para sincronizar os dados de Contas a Receber do Odoo.
                    Use para importação inicial ou reprocessamento de períodos específicos.
                </p>

                <!-- Opções rápidas -->
                <div class="fin-form-group">
                    <label class="fin-form-group__label">Opções Rápidas</label>
                    <div class="fin-quick-options">
                        <button type="button" class="fin-quick-btn" onclick="setDias(7)">7 dias</button>
                        <button type="button" class="fin-quick-btn" onclick="setDias(15)">15 dias</button>
                        <button type="button" class="fin-quick-btn" onclick="setDias(30)">30 dias</button>
                        <button type="button" class="fin-quick-btn" onclick="setDias(60)">60 dias</button>
                        <button type="button" class="fin-quick-btn" onclick="setDias(90)">90 dias</button>
                    </div>
                </div>

                <hr class="fin-divider">

                <!-- Período personalizado -->
                <div class="fin-form-group">
                    <label class="fin-form-group__label">Período Personalizado</label>
                    <div class="fin-form-row">
                        <div class="fin-form-col">
                            <label class="fin-form-col__label">Data Início</label>
                            <input type="date" class="fin-input" id="syncDataInicio">
                        </div>
                        <div class="fin-form-col">
                            <label class="fin-form-col__label">Data Fim (opcional)</label>
                            <input type="date" class="fin-input" id="syncDataFim">
                        </div>
                    </div>
                    <small class="fin-form-group__hint">
                        Se não informar Data Fim, busca todos os registros a partir da Data Início.
                    </small>
                </div>

                <!-- Resumo -->
                <div class="fin-alert fin-alert--info" id="syncResumo">
                    <i class="fas fa-info-circle"></i>
                    Selecione um período para sincronizar.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-ext btn-ext--ghost" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn-ext btn-ext--warning" onclick="executarSincronizacaoPeriodo()" id="btnSincronizarPeriodo">
                    <i class="fas fa-sync-alt"></i>
                    Sincronizar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/financeiro/extrato.js') }}"></script>
<script>
// =============================================
// ESTATÍSTICAS
// =============================================

document.addEventListener('DOMContentLoaded', function() {
    carregarEstatisticas();
});

function carregarEstatisticas() {
    fetch("{{ url_for('financeiro.status_contas_receber') }}")
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('statTotal').textContent = data.total.toLocaleString('pt-BR');

                // Por empresa
                data.por_empresa.forEach(emp => {
                    if (emp.empresa.includes('FB')) {
                        document.getElementById('statFB').textContent = emp.total.toLocaleString('pt-BR');
                    } else if (emp.empresa.includes('SC')) {
                        document.getElementById('statSC').textContent = emp.total.toLocaleString('pt-BR');
                    } else if (emp.empresa.includes('CD')) {
                        document.getElementById('statCD').textContent = emp.total.toLocaleString('pt-BR');
                    }
                });

                // Última sincronização
                if (data.ultima_sincronizacao) {
                    const dataSync = new Date(data.ultima_sincronizacao);
                    document.getElementById('ultimaSync').textContent = dataSync.toLocaleString('pt-BR');
                } else {
                    document.getElementById('ultimaSync').textContent = 'Nunca';
                }
            }
        })
        .catch(error => {
            console.error('Erro ao carregar estatísticas:', error);
        });
}

// =============================================
// SINCRONIZAÇÃO RÁPIDA
// =============================================

function sincronizarOdoo() {
    const btn = document.getElementById('btnSincronizar');
    const textoOriginal = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';

    fetch("{{ url_for('financeiro.sincronizar_contas_receber_odoo') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            toastr.success(
                `Novos: ${data.novos} | Atualizados: ${data.atualizados} | Enriquecidos: ${data.enriquecidos}`,
                'Sincronização Concluída!'
            );
            carregarEstatisticas();
        } else {
            toastr.error(data.error || 'Erro desconhecido', 'Erro na Sincronização');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        toastr.error('Erro ao conectar com o servidor', 'Erro');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    });
}

// =============================================
// MODAL DE SINCRONIZAÇÃO POR PERÍODO
// =============================================

let modalSincronizacao = null;

function abrirModalSincronizacao() {
    if (!modalSincronizacao) {
        modalSincronizacao = new bootstrap.Modal(document.getElementById('modalSincronizacao'));
    }

    // Limpar campos
    document.getElementById('syncDataInicio').value = '';
    document.getElementById('syncDataFim').value = '';
    atualizarResumoSync();

    modalSincronizacao.show();
}

function setDias(dias) {
    const hoje = new Date();
    const dataInicio = new Date(hoje);
    dataInicio.setDate(hoje.getDate() - dias);

    const formatarData = (d) => {
        const ano = d.getFullYear();
        const mes = String(d.getMonth() + 1).padStart(2, '0');
        const dia = String(d.getDate()).padStart(2, '0');
        return `${ano}-${mes}-${dia}`;
    };

    document.getElementById('syncDataInicio').value = formatarData(dataInicio);
    document.getElementById('syncDataFim').value = formatarData(hoje);

    atualizarResumoSync();
}

function parseLocalDate(dateStr) {
    const [year, month, day] = dateStr.split('-').map(Number);
    return new Date(year, month - 1, day);
}

function atualizarResumoSync() {
    const dataInicio = document.getElementById('syncDataInicio').value;
    const dataFim = document.getElementById('syncDataFim').value;
    const resumo = document.getElementById('syncResumo');

    if (!dataInicio) {
        resumo.className = 'fin-alert fin-alert--info';
        resumo.innerHTML = '<i class="fas fa-info-circle"></i> Selecione um período para sincronizar.';
        return;
    }

    const inicio = parseLocalDate(dataInicio);
    const inicioFormatado = inicio.toLocaleDateString('pt-BR');

    if (dataFim) {
        const fim = parseLocalDate(dataFim);
        const fimFormatado = fim.toLocaleDateString('pt-BR');
        const dias = Math.ceil((fim - inicio) / (1000 * 60 * 60 * 24)) + 1;

        resumo.className = 'fin-alert fin-alert--warning';
        resumo.innerHTML = `<i class="fas fa-calendar-check"></i> Sincronizar de <strong>${inicioFormatado}</strong> até <strong>${fimFormatado}</strong> (${dias} dias)`;
    } else {
        resumo.className = 'fin-alert fin-alert--warning';
        resumo.innerHTML = `<i class="fas fa-calendar-check"></i> Sincronizar a partir de <strong>${inicioFormatado}</strong> até hoje`;
    }
}

// Event listeners para atualizar resumo
document.getElementById('syncDataInicio')?.addEventListener('change', atualizarResumoSync);
document.getElementById('syncDataFim')?.addEventListener('change', atualizarResumoSync);

function executarSincronizacaoPeriodo() {
    const dataInicio = document.getElementById('syncDataInicio').value;
    const dataFim = document.getElementById('syncDataFim').value;

    if (!dataInicio) {
        toastr.warning('Informe a Data Início', 'Campo obrigatório');
        return;
    }

    const btn = document.getElementById('btnSincronizarPeriodo');
    const textoOriginal = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';

    const payload = { data_inicio: dataInicio };
    if (dataFim) {
        payload.data_fim = dataFim;
    }

    fetch("{{ url_for('financeiro.sincronizar_contas_receber_odoo') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            toastr.success(
                `Período: ${data.periodo}<br>Novos: ${data.novos} | Atualizados: ${data.atualizados} | Enriquecidos: ${data.enriquecidos}`,
                'Sincronização Concluída!'
            );
            modalSincronizacao.hide();
            carregarEstatisticas();
        } else {
            toastr.error(data.error || 'Erro desconhecido', 'Erro na Sincronização');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        toastr.error('Erro ao conectar com o servidor', 'Erro');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    });
}
</script>
{% endblock %}
