{% extends "base.html" %}

{% block title %}Lote #{{ lote.id }} - CNAB400{% endblock %}

{% block extra_css %}
{# Styles moved to modules/_financeiro.css #}
{% endblock %}

{% block content %}
<div class="lote-container">
    <!-- ================================================================== -->
    <!-- HEADER -->
    <!-- ================================================================== -->
    <header class="lote-header">
        <a href="{{ url_for('cnab400.index') }}" class="lote-header__back">
            <i class="fas fa-arrow-left"></i>
            Voltar para CNAB400
        </a>
        <div class="lote-header__row">
            <div>
                <h1 class="lote-header__title">
                    <i class="fas fa-file-invoice-dollar"></i>
                    Lote #{{ lote.id }} - {{ lote.arquivo_nome }}
                </h1>
                <div class="lote-header__meta">
                    <span class="lote-meta-item">
                        <i class="fas fa-university"></i>
                        {{ lote.banco_codigo }} - {{ lote.banco_nome or 'N/D' }}
                    </span>
                    <span class="lote-meta-item">
                        <i class="fas fa-calendar"></i>
                        {% if lote.data_arquivo %}
                            {{ lote.data_arquivo.strftime('%d/%m/%Y') }}
                        {% else %}
                            N/D
                        {% endif %}
                    </span>
                    <span class="lote-meta-item">
                        <i class="fas fa-user"></i>
                        {{ lote.processado_por or 'Sistema' }}
                    </span>
                    {% set status_class = lote.status|lower|replace('_', '_') %}
                    <span class="status-badge status-badge--{{ status_class }}">
                        {{ lote.status }}
                    </span>
                </div>
            </div>
            <div class="lote-header__actions">
                {# SIMPLIFICACAO 21/01/2026: Removidos botoes de acao manual #}
                {# Baixa e automatica durante importacao CNAB #}
                {# Reprocessamento e automatico na sync de titulos e importacao de extrato #}
                {% if stats.sem_match > 0 %}
                <a href="{{ url_for('cnab400.lote_sem_match', lote_id=lote.id) }}"
                   class="btn-lote btn-lote--outline"
                   title="Itens aguardando titulo ou extrato para match automatico">
                    <i class="fas fa-clock"></i>
                    Pendentes ({{ stats.sem_match }})
                </a>
                {% endif %}
                {% if stats.processados > 0 %}
                <span class="btn-lote btn-lote--success" style="cursor: default;">
                    <i class="fas fa-check-double"></i>
                    {{ stats.processados }} Baixados Automaticamente
                </span>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- ================================================================== -->
    <!-- ALERTS -->
    <!-- ================================================================== -->
    {% if stats.sem_match > 0 and lote.status == 'AGUARDANDO_REVISAO' %}
    <div class="alert-box alert-box--warning">
        <div class="alert-box__icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="alert-box__content">
            <div class="alert-box__title">{{ stats.sem_match }} itens aguardando processamento</div>
            <div>Estes itens serao processados automaticamente quando:
                <ul style="margin: 0.5rem 0 0 1rem; padding: 0;">
                    <li>Titulos forem sincronizados do Odoo (itens sem titulo)</li>
                    <li>Extrato bancario for importado (itens sem extrato)</li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    {% if lote.status == 'CONCLUIDO' %}
    <div class="alert-box alert-box--success">
        <div class="alert-box__icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="alert-box__content">
            <div class="alert-box__title">Lote concluido com sucesso!</div>
            <div>Todas as baixas foram executadas. Valor total liquidado: R$ {{ stats.valor_liquidado|numero_br(2) }}</div>
        </div>
    </div>
    {% endif %}

    <!-- ================================================================== -->
    <!-- STATS -->
    <!-- ================================================================== -->
    <div class="lote-stats">
        <div class="lote-stat">
            <div class="lote-stat__value">{{ stats.total }}</div>
            <div class="lote-stat__label">Total</div>
        </div>
        <div class="lote-stat">
            <div class="lote-stat__value lote-stat__value--success">{{ stats.liquidados }}</div>
            <div class="lote-stat__label">Liquidados</div>
        </div>
        <div class="lote-stat">
            <div class="lote-stat__value lote-stat__value--info">{{ stats.confirmados }}</div>
            <div class="lote-stat__label">Confirmados</div>
        </div>
        <div class="lote-stat">
            <div class="lote-stat__value">{{ stats.baixados }}</div>
            <div class="lote-stat__label">Baixados</div>
        </div>
        <div class="lote-stat">
            <div class="lote-stat__value lote-stat__value--success">{{ stats.com_match }}</div>
            <div class="lote-stat__label">Com Match</div>
        </div>
        <div class="lote-stat">
            <div class="lote-stat__value lote-stat__value--danger">{{ stats.sem_match }}</div>
            <div class="lote-stat__label">Sem Match</div>
        </div>
        <div class="lote-stat">
            <div class="lote-stat__value lote-stat__value--warning">{{ stats.ja_pagos }}</div>
            <div class="lote-stat__label">Ja Pagos</div>
        </div>
        <div class="lote-stat">
            <div class="lote-stat__value">{{ stats.processados }}</div>
            <div class="lote-stat__label">Processados</div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- TABELA DE ITENS -->
    <!-- ================================================================== -->
    <div class="lote-section">
        <div class="lote-section__header">
            <h2 class="lote-section__title">
                <i class="fas fa-list"></i>
                Itens do Lote
            </h2>
            <div>
                <span class="text-muted">Valor liquidado: </span>
                <span class="valor-display valor-display--positive valor-display--highlight">
                    R$ {{ stats.valor_liquidado|numero_br(2) }}
                </span>
            </div>
        </div>
        <div class="table-scroll">
            <table class="lote-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ocorrencia</th>
                        <th>Seu Numero</th>
                        <th>NF/Parcela</th>
                        <th>CNPJ Cliente</th>
                        <th>Data Ocorr.</th>
                        <th>Vencimento</th>
                        <th>Valor Titulo</th>
                        <th>Valor Pago</th>
                        <th>Match Titulo</th>
                        <th>Extrato</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in itens %}
                    {# Ignorar entradas (codigo 02) e baixas sem valor (codigo 10 sem valor_pago) #}
                    {% if item.codigo_ocorrencia != '02' and not (item.codigo_ocorrencia == '10' and not item.valor_pago) %}
                    <tr>
                        <td>{{ item.numero_linha }}</td>
                        <td>
                            <span class="ocorrencia-badge ocorrencia-badge--{{ item.codigo_ocorrencia }}">
                                {{ item.codigo_ocorrencia }} - {{ item.descricao_ocorrencia }}
                            </span>
                        </td>
                        <td><code>{{ item.seu_numero or '-' }}</code></td>
                        <td>
                            {% if item.nf_extraida and item.parcela_extraida %}
                                <strong>{{ item.nf_extraida }}</strong> / {{ item.parcela_extraida }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.cnpj_cliente %}
                                <small title="{{ item.nome_cliente or 'Cliente' }}">{{ item.cnpj_cliente }}</small>
                            {% elif item.cnpj_pagador %}
                                <small class="text-muted" title="CNPJ do arquivo CNAB (empresa)">{{ item.cnpj_pagador }}</small>
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.data_ocorrencia %}
                                {{ item.data_ocorrencia.strftime('%d/%m/%Y') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if item.data_vencimento %}
                                {{ item.data_vencimento.strftime('%d/%m/%Y') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="valor-display">
                            {% if item.valor_titulo %}
                                R$ {{ item.valor_titulo|numero_br(2) }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="valor-display valor-display--positive">
                            {% if item.valor_pago %}
                                R$ {{ item.valor_pago|numero_br(2) }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% set match_class = {
                                'MATCH_ENCONTRADO': 'encontrado',
                                'SEM_MATCH': 'sem_match',
                                'JA_PAGO': 'ja_pago',
                                'NAO_APLICAVEL': 'nao_aplicavel',
                                'FORMATO_INVALIDO': 'formato_invalido',
                                'PENDENTE': 'pendente',
                                'PROCESSADO': 'processado',
                                'ERRO': 'erro'
                            } %}
                            <span class="match-badge match-badge--{{ match_class.get(item.status_match, 'pendente') }}">
                                {% if item.status_match == 'MATCH_ENCONTRADO' %}
                                    <i class="fas fa-check"></i>
                                {% elif item.status_match == 'SEM_MATCH' %}
                                    <i class="fas fa-times"></i>
                                {% elif item.status_match == 'PROCESSADO' %}
                                    <i class="fas fa-check-double"></i>
                                {% endif %}
                                {{ item.status_match|replace('_', ' ') }}
                            </span>
                            {% if item.erro_mensagem %}
                            <span class="error-tooltip">
                                <i class="fas fa-info-circle error-tooltip__icon"></i>
                                <span class="error-tooltip__text">{{ item.erro_mensagem }}</span>
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {# Status do match com extrato bancario #}
                            {% set extrato_status = item.status_match_extrato or 'PENDENTE' %}
                            {% set extrato_class = {
                                'MATCH_ENCONTRADO': 'match',
                                'SEM_MATCH': 'sem_match',
                                'NAO_APLICAVEL': 'nao_aplicavel',
                                'PENDENTE': 'pendente',
                                'CONCILIADO': 'conciliado'
                            } %}
                            <span class="extrato-badge extrato-badge--{{ extrato_class.get(extrato_status, 'pendente') }}">
                                {% if extrato_status == 'MATCH_ENCONTRADO' %}
                                    <i class="fas fa-link"></i> Vinculado
                                {% elif extrato_status == 'CONCILIADO' %}
                                    <i class="fas fa-check"></i> Conciliado
                                {% elif extrato_status == 'SEM_MATCH' %}
                                    <i class="fas fa-unlink"></i> S/ Extrato
                                {% elif extrato_status == 'NAO_APLICAVEL' %}
                                    -
                                {% else %}
                                    <i class="fas fa-clock"></i> Pendente
                                {% endif %}
                            </span>
                            {% if item.match_score_extrato %}
                            <small class="text-muted d-block">Score: {{ item.match_score_extrato }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {# SIMPLIFICACAO 21/01/2026: Status em vez de botoes de acao #}
                            {% if item.processado %}
                            <span class="match-badge match-badge--processado" title="Baixado automaticamente">
                                <i class="fas fa-check-double"></i> Baixado
                            </span>
                            {% elif item.status_match == 'MATCH_ENCONTRADO' and item.extrato_item_id %}
                            <span class="match-badge match-badge--pendente" title="Aguardando proxima importacao">
                                <i class="fas fa-clock"></i> Aguardando
                            </span>
                            {% elif item.status_match == 'SEM_MATCH' %}
                            <span class="match-badge match-badge--sem_match" title="Sincronize titulos do Odoo">
                                <i class="fas fa-sync"></i> S/ Titulo
                            </span>
                            {% elif item.status_match == 'MATCH_ENCONTRADO' and not item.extrato_item_id %}
                            <span class="match-badge match-badge--pendente" title="Importe extrato para vincular">
                                <i class="fas fa-file-invoice"></i> S/ Extrato
                            </span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{# Modal de vinculacao manual REMOVIDO (21/01/2026) #}
{# Fluxo simplificado: matching e baixa sao automaticos #}
{% endblock %}

{% block scripts %}
<script>
/**
 * CNAB400 Lote Detalhe - JavaScript
 *
 * SIMPLIFICACAO (21/01/2026):
 * - Removidos botoes de acao manual (Reprocessar, Matching Extrato, Executar Baixas)
 * - Removidos botoes individuais (Baixar Item, Vincular Item)
 * - Removido modal de vinculacao manual
 *
 * O fluxo agora e 100% automatico:
 * - Baixa automatica durante importacao CNAB
 * - Reprocessamento automatico na sync de titulos
 * - Vinculacao automatica na importacao de extrato
 *
 * Este script agora e apenas para exibicao de dados.
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('CNAB400 Lote Detalhe - Modo visualizacao (fluxo automatico)');
    const loteId = {{ lote.id }};
    console.log('Lote ID:', loteId);

    // Tooltips (se houver Bootstrap)
    if (typeof bootstrap !== 'undefined') {
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
    }
});
</script>
{% endblock %}
