{% extends "base.html" %}

{% block title %}Comprovantes de Pagamento{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<style>
    /* Upload & resultados */
    .status-novo { color: var(--bs-success); }
    .status-duplicado { color: var(--bs-warning); }
    .status-erro { color: var(--bs-danger); }
    .status-vinculado { color: var(--bs-info); }
    .status-sem_match { color: var(--bs-secondary); }
    .status-ja_vinculado { color: var(--bs-warning); }

    /* Modal de match - candidatos */
    .score-alto { background-color: #198754 !important; }
    .score-medio { background-color: #fd7e14 !important; }
    .score-baixo { background-color: #dc3545 !important; }
    .match-candidato { border-left: 4px solid transparent; padding: 10px; margin-bottom: 8px; cursor: pointer; }
    .match-candidato:hover { background-color: #f0f8ff; }
    .match-candidato.score-alto-border { border-left-color: #198754; }
    .match-candidato.score-medio-border { border-left-color: #fd7e14; }
    .match-candidato.score-baixo-border { border-left-color: #dc3545; }

    /* Tabela comprovantes - Stacked cells */
    #tabela-comprovantes { font-size: 0.88em; }
    #tabela-comprovantes td { vertical-align: middle; padding: 6px 8px; line-height: 1.35; }
    #tabela-comprovantes thead th { font-size: 0.82em; padding: 8px; white-space: nowrap; }

    /* Pipeline badges empilhados */
    .pipeline-badges { display: flex; flex-direction: column; gap: 3px; align-items: flex-start; }
    .pipeline-badges .badge { font-size: 0.72em; padding: 2px 6px; white-space: nowrap; }

    /* Odoo links */
    .odoo-link { text-decoration: none; font-size: 0.85em; margin: 0 2px; }
    .odoo-link:hover { opacity: 0.8; }
    .reconciled-check { font-size: 0.55em; vertical-align: super; color: #198754; margin-left: 1px; }

    /* Modal de detalhes */
    .det-section { margin-bottom: 1rem; }
    .det-section h6 { border-bottom: 2px solid #dee2e6; padding-bottom: 4px; margin-bottom: 8px; font-size: 0.9em; }
    .det-row { display: flex; padding: 2px 0; font-size: 0.85em; border-bottom: 1px solid #f8f9fa; }
    .det-row:last-child { border-bottom: none; }
    .det-label { width: 190px; font-weight: 500; color: #6c757d; flex-shrink: 0; }
    .det-value { flex: 1; word-break: break-all; }
    .det-value.mono { font-family: monospace; font-size: 0.92em; }
    .det-odoo-link { text-decoration: none; }
    .det-odoo-link:hover { text-decoration: underline; }

    /* Filter bar */
    .filter-bar {
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 10px 15px;
        font-size: 0.85em;
    }
    .filter-bar .form-check-label { font-size: 0.9em; }
    .filter-bar .badge-filtro-ativo { font-size: 0.7em; }
    #dropdown-confianca .form-check { padding: 3px 8px 3px 28px; border-radius: 4px; }
    #dropdown-confianca .form-check:hover { background: #f0f4ff; }
    #dropdown-confianca .form-check-label { cursor: pointer; font-size: 0.85em; white-space: nowrap; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="max-width: 1400px;">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <i class="fas fa-receipt text-warning"></i>
                Comprovantes de Pagamento de Boleto
            </h2>
            <small class="text-muted">
                <span id="total-comprovantes">{{ total_comprovantes }}</span> comprovante(s) importado(s)
            </small>
        </div>
        <a href="{{ url_for('financeiro.dashboard') }}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Central Financeira
        </a>
    </div>

    <!-- Painel de Progresso (oculto) -->
    <div id="painel-progresso" class="card shadow-sm mb-4" style="display: none;">
        <div class="card-header bg-primary text-white">
            <strong><i class="fas fa-cog fa-spin me-2"></i> Processando Comprovantes</strong>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span id="progresso-texto">Iniciando...</span>
                    <span id="progresso-contagem">0/0</span>
                </div>
                <div class="progress" style="height: 20px;">
                    <div id="progresso-barra" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">0%</div>
                </div>
            </div>
            <div class="row text-center mb-3">
                <div class="col-4">
                    <div class="rounded p-2" style="background: var(--bs-success-bg-subtle);">
                        <div class="fs-4 fw-bold text-success" id="stat-novos">0</div>
                        <small class="text-muted">Novos</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="rounded p-2" style="background: var(--bs-warning-bg-subtle);">
                        <div class="fs-4 fw-bold text-warning" id="stat-duplicados">0</div>
                        <small class="text-muted">Duplicados</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="rounded p-2" style="background: var(--bs-danger-bg-subtle);">
                        <div class="fs-4 fw-bold text-danger" id="stat-erros">0</div>
                        <small class="text-muted">Erros</small>
                    </div>
                </div>
            </div>
            <div id="lista-resultados" class="small" style="max-height: 250px; overflow-y: auto;"></div>
        </div>
        <div class="card-footer" id="progresso-footer" style="display: none;">
            <button class="btn btn-outline-secondary btn-sm" onclick="fecharProgresso()">
                <i class="fas fa-times"></i> Fechar
            </button>
        </div>
    </div>

    <!-- Card de Upload -->
    <div id="card-upload" class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <strong><i class="fas fa-cloud-upload-alt"></i> Importar Comprovantes</strong>
        </div>
        <div class="card-body">
            <!-- Inputs ocultos (fora de qualquer container clicável) -->
            <input type="file" id="input-arquivos" accept=".pdf" multiple style="display: none;">
            <input type="file" id="input-pasta" webkitdirectory style="display: none;">

            <!-- Botões de seleção -->
            <div class="d-flex gap-2 mb-3">
                <button type="button" class="btn btn-outline-secondary" id="btn-selecionar-arquivos">
                    <i class="fas fa-file-pdf"></i> Selecionar Arquivo(s)
                </button>
                <button type="button" class="btn btn-outline-secondary" id="btn-selecionar-pasta">
                    <i class="fas fa-folder-open"></i> Selecionar Pasta
                </button>
            </div>

            <!-- Lista de arquivos selecionados -->
            <div id="arquivos-selecionados" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong><i class="fas fa-list me-1"></i> Arquivos Selecionados</strong>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-limpar">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                </div>
                <div id="lista-selecionados" class="list-group list-group-flush small"
                     style="max-height: 200px; overflow-y: auto;"></div>
            </div>

            <hr>
            <button type="button" id="btn-processar" class="btn btn-primary" disabled>
                <i class="fas fa-upload"></i> Processar <span id="contagem-arquivos">(0 arquivos)</span>
            </button>
        </div>
    </div>

    <!-- Card de Upload OFX -->
    <div id="card-upload-ofx" class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <strong><i class="fas fa-file-code text-info"></i> Importar Extrato OFX</strong>
            <small class="text-muted ms-2">Vincular comprovantes com extrato bancario e Odoo</small>
        </div>
        <div class="card-body">
            <!-- Inputs ocultos -->
            <input type="file" id="input-ofx" accept=".ofx" multiple style="display: none;">
            <input type="file" id="input-ofx-pasta" webkitdirectory style="display: none;">

            <!-- Botoes de selecao -->
            <div class="d-flex gap-2 mb-3">
                <button type="button" class="btn btn-outline-info" id="btn-selecionar-ofx">
                    <i class="fas fa-file-code"></i> Selecionar Arquivo(s)
                </button>
                <button type="button" class="btn btn-outline-info" id="btn-selecionar-ofx-pasta">
                    <i class="fas fa-folder-open"></i> Selecionar Pasta
                </button>
            </div>

            <!-- Lista de arquivos OFX selecionados -->
            <div id="ofx-arquivos-selecionados" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong><i class="fas fa-list me-1"></i> Arquivos OFX Selecionados</strong>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-limpar-ofx">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                </div>
                <div id="ofx-lista-selecionados" class="list-group list-group-flush small"
                     style="max-height: 200px; overflow-y: auto;"></div>
            </div>

            <hr>
            <button type="button" id="btn-processar-ofx" class="btn btn-info text-white" disabled>
                <i class="fas fa-link"></i> Importar e Vincular <span id="ofx-contagem-arquivos">(0 arquivos)</span>
            </button>
        </div>
        <!-- Resultado da vinculação OFX -->
        <div id="ofx-resultado" class="card-footer" style="display: none;">
            <div class="row text-center mb-2">
                <div class="col">
                    <div class="fs-5 fw-bold text-info" id="ofx-stat-total">0</div>
                    <small class="text-muted">Transacoes</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-success" id="ofx-stat-vinculados">0</div>
                    <small class="text-muted">Vinculados</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-primary" id="ofx-stat-odoo">0</div>
                    <small class="text-muted">Com Odoo</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-warning" id="ofx-stat-sem-comp">0</div>
                    <small class="text-muted">Sem Comprovante</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-secondary" id="ofx-stat-sem-odoo">0</div>
                    <small class="text-muted">Sem Odoo</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-muted" id="ofx-stat-ja-vinculados">0</div>
                    <small class="text-muted">Ja Vinculados</small>
                </div>
            </div>
            <div id="ofx-lista-detalhes" class="small" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Card de Match com Odoo -->
    <div id="card-match" class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <strong><i class="fas fa-search-dollar text-success"></i> Match com Faturas Odoo</strong>
            <small class="text-muted ms-2">Vincular comprovantes com faturas de fornecedor</small>
        </div>
        <div class="card-body">
            <div class="row align-items-end mb-3">
                <div class="col-md-3">
                    <label class="form-label small">Data Inicio</label>
                    <input type="date" id="match-data-inicio" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Data Fim</label>
                    <input type="date" id="match-data-fim" class="form-control form-control-sm">
                </div>
                <div class="col-md-6">
                    <button type="button" id="btn-executar-match" class="btn btn-success">
                        <i class="fas fa-search-dollar"></i> Executar Match (Todos Pendentes)
                    </button>
                </div>
            </div>
            <div id="match-progresso" style="display: none;">
                <div class="d-flex align-items-center mb-2">
                    <div class="spinner-border spinner-border-sm text-success me-2" role="status"></div>
                    <span id="match-progresso-texto">Enfileirando...</span>
                    <span class="ms-auto small text-muted" id="match-progresso-contagem"></span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div id="match-progresso-barra" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
                <div class="mt-1 small text-muted" id="match-progresso-detalhe"></div>
            </div>
        </div>
        <!-- Resultado do Match -->
        <div id="match-resultado" class="card-footer" style="display: none;">
            <div class="row text-center mb-2">
                <div class="col">
                    <div class="fs-5 fw-bold text-primary" id="match-stat-processados">0</div>
                    <small class="text-muted">Processados</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-success" id="match-stat-com-match">0</div>
                    <small class="text-muted">Com Match</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-warning" id="match-stat-sem-match">0</div>
                    <small class="text-muted">Sem Match</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-danger" id="match-stat-erros">0</div>
                    <small class="text-muted">Erros</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Card de Lançamento no Odoo -->
    <div id="card-lancamento" class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <strong><i class="fas fa-paper-plane text-primary"></i> Lançar Pagamentos no Odoo</strong>
            <small class="text-muted ms-2">Criar payments e reconciliar títulos + extratos</small>
        </div>
        <div class="card-body">
            <div class="d-flex align-items-center">
                <button type="button" id="btn-executar-lancamento" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Lançar Todos Confirmados
                </button>
                <small class="text-muted ms-3">Processa todos os comprovantes com status CONFIRMADO</small>
            </div>
            <div id="lancamento-progresso" style="display: none;" class="mt-3">
                <div class="d-flex align-items-center mb-2">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                    <span id="lancamento-progresso-texto">Enfileirando...</span>
                    <span class="ms-auto small text-muted" id="lancamento-progresso-contagem"></span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div id="lancamento-progresso-barra" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
                <div class="mt-1 small text-muted" id="lancamento-progresso-detalhe"></div>
            </div>
        </div>
        <div id="lancamento-resultado" class="card-footer" style="display: none;">
            <div class="row text-center mb-2">
                <div class="col">
                    <div class="fs-5 fw-bold text-primary" id="lancamento-stat-total">0</div>
                    <small class="text-muted">Total</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-success" id="lancamento-stat-sucesso">0</div>
                    <small class="text-muted">Lançados</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-danger" id="lancamento-stat-erros">0</div>
                    <small class="text-muted">Erros</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Comprovantes -->
    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <strong><i class="fas fa-table"></i> Comprovantes Importados</strong>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                        data-bs-target="#filtros-comprovantes" aria-expanded="false"
                        aria-controls="filtros-comprovantes" id="btn-toggle-filtros">
                    <i class="fas fa-filter"></i> Filtros
                    <span class="badge bg-primary badge-filtro-ativo" id="badge-filtros-ativos" style="display:none;">0</span>
                </button>
                <button type="button" id="btn-confirmar-selecionados" class="btn btn-sm btn-success"
                        style="display: none;" onclick="confirmarSelecionados()">
                    <i class="fas fa-check-double"></i> Confirmar Selecionados (<span id="contagem-selecionados">0</span>)
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="recarregarTabela()">
                    <i class="fas fa-sync"></i> Atualizar
                </button>
            </div>
        </div>
        <!-- Filter Bar (collapsible) -->
        <div class="collapse" id="filtros-comprovantes">
            <div class="filter-bar">
                <div class="d-flex flex-wrap align-items-center gap-3">
                    <span class="text-muted small fw-bold"><i class="fas fa-filter me-1"></i>Filtros:</span>

                    <!-- Dropdown Multiplo: % Confianca -->
                    <div class="dropdown d-inline-block">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                id="btn-filtro-confianca" data-bs-toggle="dropdown" data-bs-auto-close="outside"
                                aria-expanded="false">
                            <i class="fas fa-percentage me-1"></i>Confiança
                            <span class="badge bg-primary ms-1" id="badge-confianca-count" style="display:none;">0</span>
                        </button>
                        <div class="dropdown-menu p-2" id="dropdown-confianca" style="min-width: 200px;">
                            <div class="small text-muted mb-1 px-1">Valores distintos:</div>
                            <div id="confianca-checks-container">
                                <div class="text-muted small px-1"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="d-flex justify-content-between px-1">
                                <a href="#" class="small" id="confianca-selecionar-todos">Todos</a>
                                <a href="#" class="small" id="confianca-limpar">Limpar</a>
                            </div>
                        </div>
                    </div>

                    <span class="text-muted">|</span>

                    <!-- Checkboxes Pipeline -->
                    <div class="form-check form-check-inline mb-0">
                        <input class="form-check-input filtro-check" type="checkbox" id="filtro-ofx" value="ofx">
                        <label class="form-check-label" for="filtro-ofx">OFX</label>
                    </div>
                    <div class="form-check form-check-inline mb-0">
                        <input class="form-check-input filtro-check" type="checkbox" id="filtro-extrato" value="extrato">
                        <label class="form-check-label" for="filtro-extrato">Extrato</label>
                    </div>
                    <div class="form-check form-check-inline mb-0">
                        <input class="form-check-input filtro-check" type="checkbox" id="filtro-match" value="match">
                        <label class="form-check-label" for="filtro-match">Match</label>
                    </div>
                    <div class="form-check form-check-inline mb-0">
                        <input class="form-check-input filtro-check" type="checkbox" id="filtro-confirmado" value="confirmado">
                        <label class="form-check-label" for="filtro-confirmado">Confirmado</label>
                    </div>
                    <div class="form-check form-check-inline mb-0">
                        <input class="form-check-input filtro-check" type="checkbox" id="filtro-baixado" value="baixado">
                        <label class="form-check-label" for="filtro-baixado">Baixado</label>
                    </div>

                    <span class="text-muted">|</span>

                    <!-- Limpar Filtros -->
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-limpar-filtros"
                            title="Limpar todos os filtros">
                        <i class="fas fa-eraser"></i> Limpar
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="tabela-comprovantes" class="table table-striped table-hover mb-0" style="width: 100%;">
                    <thead>
                        <tr>
                            <th class="text-center" style="width: 35px;">
                                <input type="checkbox" id="check-todos" class="form-check-input"
                                       title="Selecionar todos pendentes">
                            </th>
                            <th>Data</th>
                            <th>Beneficiário</th>
                            <th>Documento</th>
                            <th>Pipeline</th>
                            <th class="text-end">Valores</th>
                            <th>Ações</th>
                            <th>Arquivo</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Candidatos de Match -->
    <div class="modal fade" id="modalCandidatos" tabindex="-1" aria-labelledby="modalCandidatosLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCandidatosLabel">
                        <i class="fas fa-search-dollar text-success"></i> Candidatos de Match
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Info do comprovante -->
                    <div class="card mb-3">
                        <div class="card-body py-2">
                            <div class="row small">
                                <div class="col-md-4">
                                    <strong>Beneficiario:</strong> <span id="modal-benef"></span>
                                </div>
                                <div class="col-md-2">
                                    <strong>CNPJ:</strong> <span id="modal-cnpj"></span>
                                </div>
                                <div class="col-md-2">
                                    <strong>N. Doc:</strong> <span id="modal-doc"></span>
                                </div>
                                <div class="col-md-2">
                                    <strong>Valor:</strong> <span id="modal-valor" class="fw-bold"></span>
                                </div>
                                <div class="col-md-2">
                                    <strong>Vencimento:</strong> <span id="modal-venc"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="modal-loading" class="text-center py-4">
                        <div class="spinner-border text-success" role="status"></div>
                        <div class="mt-2">Buscando candidatos no Odoo...</div>
                    </div>

                    <!-- Lista de candidatos -->
                    <div id="modal-candidatos-lista" style="display: none;"></div>

                    <!-- Sem candidatos -->
                    <div id="modal-sem-candidatos" style="display: none;" class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <div>Nenhum candidato encontrado no Odoo.</div>
                    </div>

                    <!-- Vinculacao manual -->
                    <hr>
                    <div class="card">
                        <div class="card-header bg-light py-2">
                            <strong class="small"><i class="fas fa-edit"></i> Vinculacao Manual</strong>
                        </div>
                        <div class="card-body py-2">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-3">
                                    <label class="form-label small">NF</label>
                                    <input type="text" id="manual-nf" class="form-control form-control-sm" placeholder="Ex: 12345">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Parcela</label>
                                    <input type="number" id="manual-parcela" class="form-control form-control-sm" value="1" min="1">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Empresa</label>
                                    <select id="manual-company" class="form-select form-select-sm">
                                        <option value="1">NACOM GOYA - FB (1)</option>
                                        <option value="3">NACOM GOYA - SC (3)</option>
                                        <option value="4">NACOM GOYA - CD (4)</option>
                                        <option value="5">LA FAMIGLIA - LF (5)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" id="btn-vincular-manual" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-link"></i> Vincular Manual
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================================================================
         MODAL DE DETALHES — Todos os campos organizados por seção
         =================================================================== -->
    <div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title" id="modalDetalhesLabel">
                        <i class="fas fa-info-circle text-primary me-2"></i>Detalhes do Comprovante
                        <span id="det-agendamento" class="text-muted ms-2" style="font-size:0.85em"></span>
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" id="modalDetalhesBody">
                    <!-- Conteúdo preenchido dinamicamente via JS -->
                </div>
                <div class="modal-footer py-1">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // =========================================================================
    // SELEÇÃO DE ARQUIVOS / PASTA
    // =========================================================================
    const inputArquivos = document.getElementById('input-arquivos');
    const inputPasta = document.getElementById('input-pasta');
    const listaSelecionados = document.getElementById('lista-selecionados');
    const divSelecionados = document.getElementById('arquivos-selecionados');
    const btnProcessar = document.getElementById('btn-processar');
    const contagemArquivos = document.getElementById('contagem-arquivos');
    const btnLimpar = document.getElementById('btn-limpar');

    let arquivosSelecionados = [];

    // Botão "Selecionar Arquivo(s)"
    document.getElementById('btn-selecionar-arquivos').addEventListener('click', () => {
        inputArquivos.click();
    });

    // Botão "Selecionar Pasta"
    document.getElementById('btn-selecionar-pasta').addEventListener('click', () => {
        inputPasta.click();
    });

    inputArquivos.addEventListener('change', () => {
        const files = Array.from(inputArquivos.files);
        adicionarArquivos(files);
        inputArquivos.value = '';
    });

    inputPasta.addEventListener('change', () => {
        const files = Array.from(inputPasta.files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
        adicionarArquivos(files);
        inputPasta.value = '';
    });

    btnLimpar.addEventListener('click', () => {
        arquivosSelecionados = [];
        atualizarLista();
    });

    function adicionarArquivos(files) {
        for (const f of files) {
            // Evitar duplicados pelo nome
            if (!arquivosSelecionados.find(a => a.name === f.name)) {
                arquivosSelecionados.push(f);
            }
        }
        atualizarLista();
    }

    function atualizarLista() {
        if (arquivosSelecionados.length === 0) {
            divSelecionados.style.display = 'none';
            btnProcessar.disabled = true;
            contagemArquivos.textContent = '(0 arquivos)';
            return;
        }

        divSelecionados.style.display = 'block';
        btnProcessar.disabled = false;
        contagemArquivos.textContent = `(${arquivosSelecionados.length} arquivo${arquivosSelecionados.length > 1 ? 's' : ''})`;

        listaSelecionados.innerHTML = arquivosSelecionados.map((f, i) => `
            <div class="list-group-item d-flex justify-content-between align-items-center py-1">
                <span><i class="fas fa-file-pdf text-danger me-2"></i>${f.name}</span>
                <button class="btn btn-sm btn-link text-danger p-0" onclick="removerArquivo(${i})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }

    window.removerArquivo = function(idx) {
        arquivosSelecionados.splice(idx, 1);
        atualizarLista();
    };

    // =========================================================================
    // FETCH COM RETRY (proteção SSL/conexão)
    // =========================================================================
    async function fetchComRetry(url, options, maxRetries = 3) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const resp = await fetch(url, options);
                return resp;
            } catch (err) {
                console.warn(`Tentativa ${i + 1}/${maxRetries} falhou: ${err.message}`);
                if (i < maxRetries - 1) {
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                    continue;
                }
                throw err;
            }
        }
    }

    // =========================================================================
    // CSRF HEADER
    // =========================================================================
    function getCsrfHeaders() {
        const csrf = document.querySelector('meta[name="csrf-token"]');
        return csrf ? { 'X-CSRFToken': csrf.content } : {};
    }

    // =========================================================================
    // UPLOAD / PROCESSAMENTO — DECISÃO AUTOMÁTICA
    // =========================================================================
    const LIMITE_MODO_SINCRONO = 5;   // Até 5 arquivos → síncrono
    const CHUNK_SIZE = 50;            // PDFs por request no modo batch

    btnProcessar.addEventListener('click', async () => {
        if (arquivosSelecionados.length === 0) return;

        if (arquivosSelecionados.length <= LIMITE_MODO_SINCRONO) {
            await processarSincrono();
        } else {
            await processarBatch();
        }
    });

    // =========================================================================
    // MODO SÍNCRONO (1-5 PDFs — uso diário)
    // =========================================================================
    async function processarSincrono() {
        iniciarPainel();

        const barra = document.getElementById('progresso-barra');
        const texto = document.getElementById('progresso-texto');
        const contagem = document.getElementById('progresso-contagem');
        const statNovos = document.getElementById('stat-novos');
        const statDuplicados = document.getElementById('stat-duplicados');
        const statErros = document.getElementById('stat-erros');
        const listaResultados = document.getElementById('lista-resultados');

        let totalNovos = 0, totalDuplicados = 0, totalErros = 0;
        const total = arquivosSelecionados.length;

        for (let i = 0; i < total; i++) {
            const arquivo = arquivosSelecionados[i];
            const pct = Math.round(((i) / total) * 100);

            texto.textContent = `Processando: ${arquivo.name}`;
            contagem.textContent = `${i + 1}/${total}`;
            barra.style.width = pct + '%';
            barra.textContent = pct + '%';

            const formData = new FormData();
            formData.append('arquivos', arquivo);

            try {
                const resp = await fetchComRetry(
                    '{{ url_for("financeiro.comprovantes_api_upload") }}',
                    { method: 'POST', body: formData, headers: getCsrfHeaders() }
                );

                if (!resp.ok) {
                    throw new Error(`Servidor retornou erro ${resp.status}`);
                }

                const contentType = resp.headers.get('content-type') || '';
                if (!contentType.includes('application/json')) {
                    throw new Error(`Resposta inesperada do servidor (${resp.status})`);
                }

                const data = await resp.json();

                if (data.sucesso) {
                    totalNovos += data.novos;
                    totalDuplicados += data.duplicados;
                    totalErros += data.erros;

                    if (data.arquivos && data.arquivos.length > 0) {
                        for (const det of data.arquivos[0].detalhes) {
                            adicionarDetalhe(listaResultados, det, arquivo.name);
                        }
                    }
                } else {
                    totalErros++;
                    listaResultados.innerHTML += `
                        <div class="status-erro mb-1">
                            &#x274C; <strong>${arquivo.name}</strong> — ${data.mensagem || 'Erro desconhecido'}
                        </div>`;
                }
            } catch (err) {
                totalErros++;
                listaResultados.innerHTML += `
                    <div class="status-erro mb-1">
                        &#x274C; <strong>${arquivo.name}</strong> — Erro de conexão: ${err.message}
                    </div>`;
            }

            statNovos.textContent = totalNovos;
            statDuplicados.textContent = totalDuplicados;
            statErros.textContent = totalErros;
        }

        finalizarPainel('Concluído!', total, total);
    }

    // =========================================================================
    // MODO BATCH (>5 PDFs — via RQ + polling Redis)
    // =========================================================================
    async function processarBatch() {
        iniciarPainel();

        const barra = document.getElementById('progresso-barra');
        const texto = document.getElementById('progresso-texto');
        const contagem = document.getElementById('progresso-contagem');
        const statNovos = document.getElementById('stat-novos');
        const statDuplicados = document.getElementById('stat-duplicados');
        const statErros = document.getElementById('stat-erros');
        const listaResultados = document.getElementById('lista-resultados');

        const total = arquivosSelecionados.length;
        const totalChunks = Math.ceil(total / CHUNK_SIZE);

        texto.textContent = `Enviando ${total} arquivo(s) em ${totalChunks} lote(s)...`;
        contagem.textContent = `0/${total}`;

        // ---- ETAPA 1: Enviar chunks para o servidor ----
        let batchIds = [];
        let totalEnviados = 0;

        for (let c = 0; c < totalChunks; c++) {
            const inicio = c * CHUNK_SIZE;
            const chunk = arquivosSelecionados.slice(inicio, inicio + CHUNK_SIZE);

            const formData = new FormData();
            for (const arq of chunk) {
                formData.append('arquivos', arq);
            }

            texto.textContent = `Enviando lote ${c + 1}/${totalChunks} (${chunk.length} arquivo(s))...`;

            try {
                const resp = await fetchComRetry(
                    '{{ url_for("financeiro.comprovantes_api_upload_batch") }}',
                    { method: 'POST', body: formData, headers: getCsrfHeaders() }
                );

                const data = await resp.json();

                if (data.sucesso) {
                    batchIds.push({
                        id: data.batch_id,
                        total: data.total_arquivos,
                    });
                    totalEnviados += data.total_arquivos;
                    listaResultados.innerHTML += `
                        <div class="text-info mb-1">
                            <i class="fas fa-check-circle"></i> Lote ${c + 1} enviado: ${data.total_arquivos} arquivo(s) enfileirado(s)
                        </div>`;
                } else {
                    listaResultados.innerHTML += `
                        <div class="status-erro mb-1">
                            &#x274C; Lote ${c + 1} falhou: ${data.mensagem || 'Erro desconhecido'}
                        </div>`;
                }
            } catch (err) {
                listaResultados.innerHTML += `
                    <div class="status-erro mb-1">
                        &#x274C; Lote ${c + 1} — Erro de conexão: ${err.message}
                    </div>`;
            }

            // Progresso de envio (fase de upload)
            const pctEnvio = Math.round(((c + 1) / totalChunks) * 10); // 0-10% é envio
            barra.style.width = pctEnvio + '%';
            barra.textContent = pctEnvio + '%';
        }

        if (batchIds.length === 0) {
            texto.textContent = 'Nenhum lote foi enviado com sucesso.';
            barra.classList.remove('progress-bar-animated');
            barra.classList.add('bg-danger');
            document.getElementById('progresso-footer').style.display = 'block';
            arquivosSelecionados = [];
            atualizarLista();
            return;
        }

        // ---- ETAPA 2: Polling de progresso via Redis ----
        texto.textContent = `Processando ${totalEnviados} arquivo(s) no servidor...`;

        // Armazena detalhes já exibidos para evitar repetição
        let detalhesExibidos = 0;

        const pollingInterval = setInterval(async () => {
            try {
                // Acumular progresso de todos os batches
                let acum = {
                    arquivos_processados: 0,
                    total_arquivos: 0,
                    novos: 0,
                    duplicados: 0,
                    erros: 0,
                    arquivo_atual: null,
                    status: 'processando',
                    detalhes: [],
                    concluidos: 0,
                };

                for (const batch of batchIds) {
                    try {
                        const resp = await fetch(
                            `/financeiro/comprovantes/api/batch/${batch.id}/status`
                        );
                        if (resp.ok) {
                            const status = await resp.json();
                            acum.arquivos_processados += (status.arquivos_processados || 0);
                            acum.total_arquivos += (status.total_arquivos || batch.total);
                            acum.novos += (status.novos || 0);
                            acum.duplicados += (status.duplicados || 0);
                            acum.erros += (status.erros || 0);

                            if (status.detalhes) {
                                acum.detalhes = acum.detalhes.concat(status.detalhes);
                            }

                            if (status.arquivo_atual) {
                                acum.arquivo_atual = status.arquivo_atual;
                            }

                            if (status.status === 'concluido' || status.status === 'erro' || status.status === 'parcial') {
                                acum.concluidos++;
                            }
                        }
                    } catch (e) {
                        // Erro de polling (rede) — ignora e tenta novamente
                        console.warn(`Erro ao consultar batch ${batch.id}:`, e);
                    }
                }

                // Atualizar UI
                const pct = acum.total_arquivos > 0
                    ? Math.round(10 + (acum.arquivos_processados / acum.total_arquivos) * 90)
                    : 10;

                barra.style.width = pct + '%';
                barra.textContent = pct + '%';
                contagem.textContent = `${acum.arquivos_processados}/${acum.total_arquivos}`;
                statNovos.textContent = acum.novos;
                statDuplicados.textContent = acum.duplicados;
                statErros.textContent = acum.erros;

                if (acum.arquivo_atual) {
                    texto.textContent = `Processando: ${acum.arquivo_atual}`;
                }

                // Exibir novos detalhes
                if (acum.detalhes.length > detalhesExibidos) {
                    const novosDetalhes = acum.detalhes.slice(detalhesExibidos);
                    for (const det of novosDetalhes) {
                        adicionarDetalhe(listaResultados, det, det.arquivo || '');
                    }
                    detalhesExibidos = acum.detalhes.length;
                    // Auto-scroll para o final
                    listaResultados.scrollTop = listaResultados.scrollHeight;
                }

                // Verificar conclusão de TODOS os batches
                if (acum.concluidos >= batchIds.length) {
                    clearInterval(pollingInterval);
                    finalizarPainel(
                        `Concluído! ${acum.novos} novo(s), ${acum.duplicados} duplicado(s), ${acum.erros} erro(s)`,
                        acum.arquivos_processados,
                        acum.total_arquivos
                    );
                    recarregarTabela();
                }
            } catch (err) {
                console.warn('Erro no polling de progresso:', err);
            }
        }, 2000); // Polling a cada 2 segundos

        // Resetar seleção (arquivos já foram enviados ao servidor)
        arquivosSelecionados = [];
        atualizarLista();
    }

    // =========================================================================
    // FUNÇÕES AUXILIARES DE UI
    // =========================================================================
    function iniciarPainel() {
        const painel = document.getElementById('painel-progresso');
        painel.style.display = 'block';
        document.getElementById('card-upload').style.display = 'none';
        document.getElementById('progresso-footer').style.display = 'none';

        const barra = document.getElementById('progresso-barra');
        barra.style.width = '0%';
        barra.textContent = '0%';
        barra.className = 'progress-bar progress-bar-striped progress-bar-animated';

        document.getElementById('progresso-texto').textContent = 'Iniciando...';
        document.getElementById('progresso-contagem').textContent = '0/0';
        document.getElementById('stat-novos').textContent = '0';
        document.getElementById('stat-duplicados').textContent = '0';
        document.getElementById('stat-erros').textContent = '0';
        document.getElementById('lista-resultados').innerHTML = '';
    }

    function finalizarPainel(mensagem, processados, total) {
        const barra = document.getElementById('progresso-barra');
        barra.style.width = '100%';
        barra.textContent = '100%';
        barra.classList.remove('progress-bar-animated');
        barra.classList.add('bg-success');

        document.getElementById('progresso-texto').textContent = mensagem;
        document.getElementById('progresso-contagem').textContent = `${processados}/${total}`;
        document.getElementById('progresso-footer').style.display = 'block';

        arquivosSelecionados = [];
        atualizarLista();
        recarregarTabela();
    }

    function adicionarDetalhe(container, det, nomeArquivo) {
        const icon = det.status === 'novo' ? '&#x2705;' :
                     det.status === 'duplicado' ? '&#x26A0;&#xFE0F;' : '&#x274C;';
        container.innerHTML += `
            <div class="status-${det.status} mb-1">
                ${icon} <strong>${nomeArquivo}</strong>
                ${det.pagina ? ' p.' + det.pagina : ''}
                — ${det.mensagem || det.status}
                ${det.numero_agendamento ? '(Agend: ' + det.numero_agendamento + ')' : ''}
            </div>`;
    }

    window.fecharProgresso = function() {
        document.getElementById('painel-progresso').style.display = 'none';
        document.getElementById('card-upload').style.display = 'block';
    };

    // =========================================================================
    // DATATABLE
    // =========================================================================
    // Helper: formatar moeda BR
    function fmtBRL(val) {
        if (val == null) return '-';
        return 'R$ ' + val.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // Helper: truncar texto
    function truncar(txt, max) {
        if (!txt) return '-';
        return txt.length > max ? txt.substring(0, max) + '...' : txt;
    }

    // Helper: comparar datas DD/MM/YYYY e retornar dias de diferença
    function diasAtraso(dataPgto, dataVenc) {
        if (!dataPgto || !dataVenc) return null;
        var pParts = dataPgto.split('/');
        var vParts = dataVenc.split('/');
        if (pParts.length !== 3 || vParts.length !== 3) return null;
        var pgto = new Date(pParts[2], pParts[1] - 1, pParts[0]);
        var venc = new Date(vParts[2], vParts[1] - 1, vParts[0]);
        return Math.round((pgto - venc) / (1000 * 60 * 60 * 24));
    }

    const tabela = $('#tabela-comprovantes').DataTable({
        ajax: {
            url: '{{ url_for("financeiro.comprovantes_api_dados") }}',
            dataSrc: 'dados',
        },
        columns: [
            // ── COL 0: CHECKBOX (só para PENDENTE) ──
            {
                data: null,
                render: function(val, type, row) {
                    if (type !== 'display') return '';
                    if (row.lancamento_status === 'PENDENTE' && row.lancamento_id) {
                        return '<input type="checkbox" class="form-check-input check-item" ' +
                               'data-lancamento-id="' + row.lancamento_id + '" ' +
                               'data-comprovante-id="' + row.id + '">';
                    }
                    return '';
                },
                className: 'text-center',
                orderable: false,
                searchable: false,
                width: '35px',
            },
            // ── COL 1: DATA (Data Pgto + Vencimento + Atraso) ──
            {
                data: 'data_pagamento',
                render: function(val, type, row) {
                    if (type !== 'display') return val || '';
                    var html = '<div class="fw-semibold" style="font-size:0.88em">' + (val || '-') + '</div>';
                    if (row.data_vencimento) {
                        html += '<div style="font-size:0.75em" class="text-muted">Venc: ' + row.data_vencimento + '</div>';
                    }
                    var dias = diasAtraso(val, row.data_vencimento);
                    if (dias !== null) {
                        if (dias > 0) {
                            html += '<div><span class="badge bg-danger-subtle text-danger" style="font-size:0.68em">' +
                                    dias + 'd atraso</span></div>';
                        } else {
                            html += '<div><span class="badge bg-success-subtle text-success" style="font-size:0.68em">' +
                                    'Em dia</span></div>';
                        }
                    }
                    return html;
                },
                defaultContent: '-',
                width: '85px',
            },
            // ── COL 2: BENEFICIÁRIO (Nome + CNPJ + Pagador/Partner) ──
            {
                data: 'beneficiario_razao_social',
                render: function(val, type, row) {
                    if (type !== 'display') return val || '';
                    var nome = truncar(val, 40);
                    var html = '<div class="fw-semibold" style="font-size:0.85em" title="' + (val || '') + '">' + nome + '</div>';
                    // L2: CNPJ + badge Financeira
                    if (row.beneficiario_cnpj_cpf) {
                        html += '<div style="font-size:0.75em;font-family:monospace" class="text-muted">' +
                                row.beneficiario_cnpj_cpf;
                        if (row.lancamento_beneficiario_e_financeira) {
                            html += ' <span class="badge bg-warning text-dark" style="font-size:0.85em">Financeira</span>';
                        }
                        html += '</div>';
                    }
                    // L3: Partner Odoo (se match) ou Pagador resumido
                    if (row.lancamento_odoo_partner_name) {
                        html += '<div style="font-size:0.72em" class="text-info">' +
                                '<i class="fas fa-building me-1"></i>' +
                                truncar(row.lancamento_odoo_partner_name, 35) + '</div>';
                    } else if (row.pagador_razao_social) {
                        html += '<div style="font-size:0.72em" class="text-muted">' +
                                '<i class="fas fa-wallet me-1"></i>Pago por: ' +
                                truncar(row.pagador_razao_social, 30) + '</div>';
                    }
                    return html;
                },
                defaultContent: '-',
                width: '240px',
            },
            // ── COL 3: DOCUMENTO (N.Doc + Agendamento + NF/Parcela) ──
            {
                data: 'numero_documento',
                render: function(val, type, row) {
                    if (type !== 'display') return val || '';
                    var html = '<div class="fw-medium" style="font-size:0.85em;font-family:monospace">' +
                               (val || '-') + '</div>';
                    if (row.numero_agendamento) {
                        html += '<div style="font-size:0.75em" class="text-muted">Agend: ' +
                                row.numero_agendamento + '</div>';
                    }
                    // L3: NF parseada + parcela (enrichment)
                    if (row.lancamento_nf_numero) {
                        html += '<div style="font-size:0.72em">' +
                                '<span class="badge bg-primary-subtle text-primary-emphasis">NF ' +
                                row.lancamento_nf_numero;
                        if (row.lancamento_parcela) {
                            html += '/' + row.lancamento_parcela;
                        }
                        html += '</span></div>';
                    }
                    return html;
                },
                defaultContent: '-',
                width: '140px',
            },
            // ── COL 4: PIPELINE (OFX + Extrato + Status/Score/Reconcile) ──
            {
                data: 'lancamento_status',
                render: function(val, type, row) {
                    // Para ordenacao: usar match_score numerico (null = -1 para ir pro final)
                    if (type === 'sort') {
                        return row.lancamento_match_score != null ? row.lancamento_match_score : -1;
                    }
                    if (type !== 'display') return val || '';
                    var html = '<div class="pipeline-badges">';

                    // L1: OFX
                    if (row.ofx_fitid) {
                        html += '<span class="badge bg-info" title="FITID: ' + row.ofx_fitid + '">' +
                                '<i class="fas fa-link me-1"></i>OFX</span>';
                    } else {
                        html += '<span class="badge bg-light text-muted">' +
                                '<i class="fas fa-minus me-1"></i>OFX</span>';
                    }

                    // L2: Extrato Odoo
                    if (row.odoo_statement_line_id) {
                        var recIcon = row.odoo_is_reconciled
                            ? '<i class="fas fa-check-double ms-1" title="Conciliado no Odoo"></i>' : '';
                        html += '<span class="badge bg-success" title="Statement Line: ' + row.odoo_statement_line_id + '">' +
                                '<i class="fas fa-university me-1"></i>Extrato' + recIcon + '</span>';
                    } else if (row.ofx_fitid) {
                        html += '<span class="badge bg-warning text-dark" title="OFX vinculado mas sem extrato no Odoo">' +
                                '<i class="fas fa-exclamation-triangle me-1"></i>Extrato</span>';
                    } else {
                        html += '<span class="badge bg-light text-muted">' +
                                '<i class="fas fa-minus me-1"></i>Extrato</span>';
                    }

                    // L3: Status + Score + Reconciliação
                    if (!val) {
                        html += '<span class="badge bg-light text-muted">' +
                                '<i class="fas fa-minus me-1"></i>Match</span>';
                    } else if (val === 'PENDENTE') {
                        var scoreHtml = '';
                        if (row.lancamento_match_score != null) {
                            var sCls = row.lancamento_match_score >= 85 ? 'text-white' :
                                       row.lancamento_match_score >= 60 ? '' : 'text-white';
                            scoreHtml = ' ' + row.lancamento_match_score + '%';
                        }
                        html += '<span class="badge bg-warning text-dark" title="Aguardando confirmacao">' +
                                '<i class="fas fa-clock me-1"></i>Pendente' + scoreHtml + '</span>';
                    } else if (val === 'CONFIRMADO') {
                        var scoreC = row.lancamento_match_score != null ? ' ' + row.lancamento_match_score + '%' : '';
                        html += '<span class="badge bg-info text-white" title="Pronto para lancar">' +
                                '<i class="fas fa-check me-1"></i>Confirmado' + scoreC + '</span>';
                    } else if (val === 'LANCADO') {
                        var tooltip = 'Baixado no Odoo';
                        if (row.lancamento_odoo_payment_name) tooltip += ' | ' + row.lancamento_odoo_payment_name;
                        if (row.lancamento_lancado_em) tooltip += ' | ' + row.lancamento_lancado_em;
                        var reconcIcons = '';
                        if (row.lancamento_odoo_full_reconcile_id) {
                            reconcIcons += '<i class="fas fa-link ms-1" title="Titulo conciliado (Full Reconcile ' +
                                           row.lancamento_odoo_full_reconcile_id + ')"></i>';
                        }
                        if (row.lancamento_odoo_full_reconcile_extrato_id) {
                            reconcIcons += '<i class="fas fa-university ms-1" title="Extrato conciliado (Full Reconcile ' +
                                           row.lancamento_odoo_full_reconcile_extrato_id + ')"></i>';
                        }
                        html += '<span class="badge bg-success" title="' + tooltip + '">' +
                                '<i class="fas fa-check-double me-1"></i>Baixado' + reconcIcons + '</span>';
                    } else if (row.lancamento_erro) {
                        html += '<span class="badge bg-danger" title="Erro: ' +
                                (row.lancamento_erro || '').substring(0, 200) + '">' +
                                '<i class="fas fa-exclamation-circle me-1"></i>Erro</span>';
                    } else {
                        html += '<span class="badge bg-secondary">' + val + '</span>';
                    }

                    html += '</div>';
                    return html;
                },
                className: 'text-center',
                defaultContent: '-',
                width: '120px',
            },
            // ── COL 5: VALORES (Vl.Pago + Vl.Doc + Desc/Juros/Diff) ──
            {
                data: 'valor_pago',
                render: function(val, type, row) {
                    if (type === 'sort' || type === 'filter') return val || 0;
                    // L1: Valor Pago (destaque)
                    var html = '<div class="fw-bold text-primary" style="font-size:0.92em">' +
                               fmtBRL(val) + '</div>';
                    // L2: Valor Documento
                    if (row.valor_documento != null && row.valor_documento !== val) {
                        html += '<div style="font-size:0.72em" class="text-muted">Doc: ' +
                                fmtBRL(row.valor_documento) + '</div>';
                    }
                    // L3: Desconto / Juros / Diferença Odoo
                    var extras = [];
                    if (row.valor_desconto_abatimento && row.valor_desconto_abatimento !== 0) {
                        extras.push('<span class="text-success">-' + fmtBRL(row.valor_desconto_abatimento) + '</span>');
                    }
                    if (row.valor_juros_multa && row.valor_juros_multa !== 0) {
                        extras.push('<span class="text-danger">+' + fmtBRL(row.valor_juros_multa) + '</span>');
                    }
                    if (row.lancamento_diferenca_valor != null) {
                        var absDiff = Math.abs(row.lancamento_diferenca_valor);
                        var diffCls = absDiff < 0.01 ? 'text-success' : 'text-danger';
                        var diffSign = row.lancamento_diferenca_valor >= 0 ? '+' : '-';
                        var diffFmt = 'R$ ' + absDiff.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        extras.push('<span class="' + diffCls + '" title="Diferenca vs titulo Odoo">\u0394' + diffSign + diffFmt + '</span>');
                    }
                    if (extras.length > 0) {
                        html += '<div style="font-size:0.72em">' + extras.join(' ') + '</div>';
                    }
                    return html;
                },
                className: 'text-end',
                width: '150px',
            },
            // ── COL 6: AÇÕES (Match btn + Lançar btn + Links Odoo) ──
            {
                data: 'id',
                render: function(val, type, row) {
                    var html = '<div class="d-flex flex-column align-items-center gap-1">';

                    // L1: Botões de ação
                    html += '<div class="btn-group btn-group-sm">';
                    html += '<button class="btn btn-outline-success py-0 px-1" ' +
                            'onclick="abrirModalMatch(' + val + ')" title="Buscar match no Odoo">' +
                            '<i class="fas fa-search-dollar"></i></button>';
                    if (row.lancamento_status === 'CONFIRMADO' && row.lancamento_id) {
                        html += '<button class="btn btn-primary py-0 px-1" ' +
                                'onclick="lancarIndividual(' + row.lancamento_id + ')" title="Lancar no Odoo">' +
                                '<i class="fas fa-paper-plane"></i></button>';
                    }
                    html += '</div>';

                    // L2: Links Odoo (título, extrato, payment) com check de reconciliação
                    var links = [];
                    var odooBase = 'https://odoo.nacomgoya.com.br/web#';

                    if (row.lancamento_odoo_move_id) {
                        var recCheck1 = row.lancamento_odoo_full_reconcile_id
                            ? '<i class="fas fa-check reconciled-check" title="Conciliado"></i>' : '';
                        links.push(
                            '<a href="' + odooBase + 'id=' + row.lancamento_odoo_move_id +
                            '&model=account.move&view_type=form" target="_blank" ' +
                            'class="odoo-link text-primary" title="Titulo (account.move ' +
                            row.lancamento_odoo_move_id + ')">' +
                            '<i class="fas fa-file-invoice"></i>' + recCheck1 + '</a>'
                        );
                    }
                    if (row.odoo_statement_line_id) {
                        var recCheck2 = row.lancamento_odoo_full_reconcile_extrato_id
                            ? '<i class="fas fa-check reconciled-check" title="Extrato conciliado"></i>' : '';
                        links.push(
                            '<a href="' + odooBase + 'id=' + row.odoo_statement_line_id +
                            '&model=account.bank.statement.line&view_type=form" target="_blank" ' +
                            'class="odoo-link text-info" title="Extrato (statement.line ' +
                            row.odoo_statement_line_id + ')">' +
                            '<i class="fas fa-university"></i>' + recCheck2 + '</a>'
                        );
                    }
                    if (row.lancamento_odoo_payment_id) {
                        links.push(
                            '<a href="' + odooBase + 'id=' + row.lancamento_odoo_payment_id +
                            '&model=account.payment&view_type=form" target="_blank" ' +
                            'class="odoo-link text-success" title="Payment (' +
                            (row.lancamento_odoo_payment_name || row.lancamento_odoo_payment_id) + ')">' +
                            '<i class="fas fa-credit-card"></i></a>'
                        );
                    }
                    if (links.length > 0) {
                        html += '<div class="d-flex gap-1">' + links.join('') + '</div>';
                    }

                    html += '</div>';
                    return html;
                },
                className: 'text-center',
                orderable: false,
                width: '90px',
            },
            // ── COL 7: ARQUIVO (Nome + PDF btn + Data importação) ──
            {
                data: 'arquivo_origem',
                render: function(val, type, row) {
                    if (type !== 'display') return val || '';
                    var nome = truncar(val, 22);
                    var pdfBtn = '';
                    if (row.arquivo_s3_path) {
                        pdfBtn = ' <a href="#" onclick="abrirPdfComprovante(' + row.id +
                                 '); return false;" class="text-danger" title="Abrir PDF (p.' +
                                 (row.pagina_origem || '?') + ')">' +
                                 '<i class="fas fa-file-pdf"></i></a>';
                    }
                    var html = '<div style="font-size:0.8em" title="' + (val || '') + '">' +
                               nome + pdfBtn + '</div>';
                    if (row.importado_em) {
                        html += '<div style="font-size:0.7em" class="text-muted">' +
                                row.importado_em + '</div>';
                    }
                    return html;
                },
                defaultContent: '-',
                width: '120px',
            },
            // ── COL 8: DETALHES (botão info → modal) ──
            {
                data: null,
                render: function(val, type, row) {
                    return '<button class="btn btn-sm btn-outline-secondary py-0 px-1" ' +
                           'onclick="abrirModalDetalhes(this)" title="Ver todos os detalhes">' +
                           '<i class="fas fa-info-circle"></i></button>';
                },
                className: 'text-center',
                orderable: false,
                searchable: false,
                width: '35px',
            },
        ],
        order: [[1, 'desc']],
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json',
        },
        pageLength: 25,
        autoWidth: false,
        scrollX: false,
    });

    window.recarregarTabela = function() {
        tabela.ajax.reload(function() {
            // Resetar checkboxes apos reload
            document.getElementById('check-todos').checked = false;
            atualizarBtnConfirmar();
            // Repopular dropdown de confianca com valores atualizados
            popularFiltroConfianca();
            // Contador atualizado automaticamente pelo evento 'draw'
        });
    };

    // =========================================================================
    // CHECKBOXES + CONFIRMAÇÃO EM LOTE
    // =========================================================================

    function atualizarBtnConfirmar() {
        const selecionados = document.querySelectorAll('.check-item:checked');
        const btn = document.getElementById('btn-confirmar-selecionados');
        const contagem = document.getElementById('contagem-selecionados');

        contagem.textContent = selecionados.length;
        btn.style.display = selecionados.length > 0 ? 'inline-block' : 'none';
    }

    // Checkbox "selecionar todos" no header
    document.getElementById('check-todos').addEventListener('change', function() {
        const checked = this.checked;
        document.querySelectorAll('.check-item').forEach(function(cb) {
            cb.checked = checked;
        });
        atualizarBtnConfirmar();
    });

    // Delegacao de eventos para checkboxes individuais (DataTable recria o DOM)
    $('#tabela-comprovantes').on('change', '.check-item', function() {
        atualizarBtnConfirmar();

        // Atualizar estado do "check-todos"
        const total = document.querySelectorAll('.check-item').length;
        const marcados = document.querySelectorAll('.check-item:checked').length;
        document.getElementById('check-todos').checked = (total > 0 && total === marcados);
    });

    // Confirmar selecionados em lote
    window.confirmarSelecionados = async function() {
        const selecionados = document.querySelectorAll('.check-item:checked');
        if (selecionados.length === 0) return;

        const lancamentoIds = Array.from(selecionados).map(function(cb) {
            return parseInt(cb.dataset.lancamentoId);
        });

        if (!confirm('Confirmar ' + lancamentoIds.length + ' match(es) selecionado(s)?')) return;

        const btn = document.getElementById('btn-confirmar-selecionados');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Confirmando...';

        try {
            const resp = await fetchComRetry(
                '/financeiro/comprovantes/api/match/confirmar-batch',
                {
                    method: 'POST',
                    body: JSON.stringify({ lancamento_ids: lancamentoIds }),
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCsrfHeaders()
                    }
                }
            );

            const data = await resp.json();

            if (data.sucesso) {
                var msg = data.confirmados + ' de ' + data.total_solicitados + ' confirmado(s).';
                if (data.erros && data.erros.length > 0) {
                    msg += '\n\n' + data.erros.length + ' erro(s):';
                    data.erros.forEach(function(e) {
                        msg += '\n- ID ' + e.lancamento_id + ': ' + e.erro;
                    });
                }
                alert(msg);
                recarregarTabela();
            } else {
                alert('Erro: ' + (data.erro || 'Erro desconhecido'));
            }
        } catch (err) {
            alert('Erro de conexao: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check-double"></i> Confirmar Selecionados (<span id="contagem-selecionados">0</span>)';
            btn.style.display = 'none';
            document.getElementById('check-todos').checked = false;
        }
    };

    // =========================================================================
    // ABRIR PDF DO COMPROVANTE (via presigned URL)
    // =========================================================================
    window.abrirPdfComprovante = async function(comprovanteId) {
        try {
            const resp = await fetch(`/financeiro/comprovantes/api/${comprovanteId}/pdf`);
            const data = await resp.json();

            if (data.sucesso && data.url) {
                window.open(data.url, '_blank');
            } else {
                alert('PDF nao disponivel: ' + (data.mensagem || 'Erro desconhecido'));
            }
        } catch (err) {
            alert('Erro ao abrir PDF: ' + err.message);
        }
    };

    // =========================================================================
    // UPLOAD OFX — Vincular com comprovantes e Odoo (multi-arquivo + pasta)
    // =========================================================================
    const inputOfx = document.getElementById('input-ofx');
    const inputOfxPasta = document.getElementById('input-ofx-pasta');
    const btnProcessarOfx = document.getElementById('btn-processar-ofx');
    const btnLimparOfx = document.getElementById('btn-limpar-ofx');
    const ofxListaSelecionados = document.getElementById('ofx-lista-selecionados');
    const ofxDivSelecionados = document.getElementById('ofx-arquivos-selecionados');
    const ofxContagemArquivos = document.getElementById('ofx-contagem-arquivos');

    let arquivosOfxSelecionados = [];

    // Botao "Selecionar Arquivo(s) OFX"
    document.getElementById('btn-selecionar-ofx').addEventListener('click', () => {
        inputOfx.click();
    });

    // Botao "Selecionar Pasta"
    document.getElementById('btn-selecionar-ofx-pasta').addEventListener('click', () => {
        inputOfxPasta.click();
    });

    inputOfx.addEventListener('change', () => {
        const files = Array.from(inputOfx.files).filter(f => f.name.toLowerCase().endsWith('.ofx'));
        adicionarArquivosOfx(files);
        inputOfx.value = '';
    });

    inputOfxPasta.addEventListener('change', () => {
        const files = Array.from(inputOfxPasta.files).filter(f => f.name.toLowerCase().endsWith('.ofx'));
        adicionarArquivosOfx(files);
        inputOfxPasta.value = '';
    });

    btnLimparOfx.addEventListener('click', () => {
        arquivosOfxSelecionados = [];
        atualizarListaOfx();
    });

    function adicionarArquivosOfx(files) {
        for (const f of files) {
            // Evitar duplicados pelo nome
            if (!arquivosOfxSelecionados.find(a => a.name === f.name)) {
                arquivosOfxSelecionados.push(f);
            }
        }
        atualizarListaOfx();
    }

    function atualizarListaOfx() {
        if (arquivosOfxSelecionados.length === 0) {
            ofxDivSelecionados.style.display = 'none';
            btnProcessarOfx.disabled = true;
            ofxContagemArquivos.textContent = '(0 arquivos)';
            return;
        }

        ofxDivSelecionados.style.display = 'block';
        btnProcessarOfx.disabled = false;
        ofxContagemArquivos.textContent = `(${arquivosOfxSelecionados.length} arquivo${arquivosOfxSelecionados.length > 1 ? 's' : ''})`;

        ofxListaSelecionados.innerHTML = arquivosOfxSelecionados.map((f, i) => `
            <div class="list-group-item d-flex justify-content-between align-items-center py-1">
                <span><i class="fas fa-file-code text-info me-2"></i>${f.name}</span>
                <button class="btn btn-sm btn-link text-danger p-0" onclick="removerArquivoOfx(${i})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }

    window.removerArquivoOfx = function(idx) {
        arquivosOfxSelecionados.splice(idx, 1);
        atualizarListaOfx();
    };

    // --- Processamento sequencial de multiplos OFX ---
    btnProcessarOfx.addEventListener('click', async () => {
        if (arquivosOfxSelecionados.length === 0) return;

        btnProcessarOfx.disabled = true;
        const totalArquivos = arquivosOfxSelecionados.length;

        // Acumuladores de stats
        let totalTransacoes = 0, totalVinculados = 0, totalOdoo = 0;
        let totalSemComp = 0, totalSemOdoo = 0, totalJaVinculados = 0;
        let todosDetalhes = [];
        let erros = [];

        for (let i = 0; i < totalArquivos; i++) {
            const arquivo = arquivosOfxSelecionados[i];
            btnProcessarOfx.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processando ${i + 1}/${totalArquivos}...`;

            const formData = new FormData();
            formData.append('arquivo_ofx', arquivo);

            try {
                const resp = await fetchComRetry(
                    '{{ url_for("financeiro.comprovantes_api_upload_ofx") }}',
                    { method: 'POST', body: formData, headers: getCsrfHeaders() }
                );

                // Verificar se resposta e OK
                if (!resp.ok) {
                    const ct = resp.headers.get('content-type') || '';
                    if (ct.includes('application/json')) {
                        const errData = await resp.json();
                        throw new Error(errData.message || errData.mensagem || `Erro ${resp.status}`);
                    }
                    throw new Error(`Servidor retornou erro ${resp.status}`);
                }

                // Verificar content-type antes de parsear JSON
                const ct = resp.headers.get('content-type') || '';
                if (!ct.includes('application/json')) {
                    throw new Error('Sessao expirada. Recarregue a pagina e tente novamente.');
                }

                const data = await resp.json();

                // Acumular stats
                totalTransacoes += (data.total_transacoes || 0);
                totalVinculados += (data.vinculados_comprovante || 0);
                totalOdoo += (data.vinculados_odoo || 0);
                totalSemComp += (data.sem_comprovante || 0);
                totalSemOdoo += (data.sem_odoo || 0);
                totalJaVinculados += (data.ja_vinculados || 0);

                if (data.detalhes && data.detalhes.length > 0) {
                    todosDetalhes = todosDetalhes.concat(data.detalhes);
                }

            } catch (err) {
                erros.push({ arquivo: arquivo.name, erro: err.message });
                // Se sessao expirou, parar e recarregar
                if (err.message.includes('Sessao expirada') || err.message.includes('csrf')) {
                    alert('Sessao expirada. A pagina sera recarregada.');
                    window.location.reload();
                    return;
                }
            }
        }

        // Mostrar resultado agregado
        const resultado = document.getElementById('ofx-resultado');
        resultado.style.display = 'block';

        document.getElementById('ofx-stat-total').textContent = totalTransacoes;
        document.getElementById('ofx-stat-vinculados').textContent = totalVinculados;
        document.getElementById('ofx-stat-odoo').textContent = totalOdoo;
        document.getElementById('ofx-stat-sem-comp').textContent = totalSemComp;
        document.getElementById('ofx-stat-sem-odoo').textContent = totalSemOdoo;
        document.getElementById('ofx-stat-ja-vinculados').textContent = totalJaVinculados;

        // Detalhes
        const listaDetalhes = document.getElementById('ofx-lista-detalhes');
        listaDetalhes.innerHTML = '';

        // Mostrar erros primeiro
        for (const e of erros) {
            listaDetalhes.innerHTML += `
                <div class="mb-1 border-bottom pb-1 text-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>${e.arquivo}</strong> — ${e.erro}
                </div>`;
        }

        // Mostrar detalhes de transacoes
        for (const det of todosDetalhes) {
            const iconComp = det.status_comprovante === 'vinculado' ? '&#x2705;' :
                             det.status_comprovante === 'ja_vinculado' ? '&#x26A0;&#xFE0F;' :
                             det.status_comprovante === 'sem_match' ? '&#x2796;' : '&#x274C;';
            const iconOdoo = det.status_odoo === 'vinculado' ? '&#x2705;' :
                             det.status_odoo === 'sem_match' ? '&#x2796;' :
                             det.status_odoo === 'nao_buscou' ? '&#x2B1C;' : '&#x274C;';

            const valorStr = det.valor != null
                ? 'R$ ' + Math.abs(det.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                : '';

            listaDetalhes.innerHTML += `
                <div class="mb-1 border-bottom pb-1">
                    <span title="Comprovante">${iconComp}</span>
                    <span title="Odoo">${iconOdoo}</span>
                    <strong>CHECKNUM ${det.checknum || '?'}</strong>
                    ${det.data ? ' — ' + det.data : ''}
                    ${valorStr ? ' — ' + valorStr : ''}
                    <br><small class="text-muted">${det.mensagem || ''}</small>
                </div>`;
        }

        // Recarregar tabela para mostrar novas vinculacoes
        recarregarTabela();

        // Mostrar resumo de erros se houver
        if (erros.length > 0) {
            alert(`Processamento concluido com ${erros.length} erro(s). Verifique os detalhes.`);
        }

        btnProcessarOfx.disabled = false;
        btnProcessarOfx.innerHTML = '<i class="fas fa-link"></i> Importar e Vincular <span id="ofx-contagem-arquivos">(0 arquivos)</span>';

        // Limpar selecao apos processar
        arquivosOfxSelecionados = [];
        atualizarListaOfx();
    });

    // =========================================================================
    // MATCH COM FATURAS ODOO
    // =========================================================================

    // --- Executar Match Batch (via RQ + polling) ---
    let matchPollingInterval = null;

    document.getElementById('btn-executar-match').addEventListener('click', async () => {
        const btnMatch = document.getElementById('btn-executar-match');
        const progresso = document.getElementById('match-progresso');
        const resultado = document.getElementById('match-resultado');

        btnMatch.disabled = true;
        btnMatch.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enfileirando...';
        progresso.style.display = 'block';
        resultado.style.display = 'none';

        const dataInicio = document.getElementById('match-data-inicio').value;
        const dataFim = document.getElementById('match-data-fim').value;

        const body = {};
        if (dataInicio) body.data_inicio = dataInicio;
        if (dataFim) body.data_fim = dataFim;

        try {
            const resp = await fetchComRetry(
                '/financeiro/comprovantes/api/match/executar',
                {
                    method: 'POST',
                    body: JSON.stringify(body),
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCsrfHeaders()
                    }
                }
            );

            const data = await resp.json();

            if (data.sucesso && data.batch_id) {
                btnMatch.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando em background...';
                document.getElementById('match-progresso-texto').textContent = 'Iniciando matching...';
                document.getElementById('match-progresso-contagem').textContent = '';
                document.getElementById('match-progresso-detalhe').textContent = '';
                document.getElementById('match-progresso-barra').style.width = '0%';

                // Iniciar polling de progresso
                iniciarPollingMatch(data.batch_id, btnMatch, progresso, resultado);
            } else {
                alert('Erro ao enfileirar: ' + (data.erro || 'Erro desconhecido'));
                finalizarMatchUI(btnMatch, progresso);
            }
        } catch (err) {
            alert('Erro de conexao: ' + err.message);
            finalizarMatchUI(btnMatch, progresso);
        }
    });

    function iniciarPollingMatch(batchId, btnMatch, progresso, resultado) {
        if (matchPollingInterval) clearInterval(matchPollingInterval);

        matchPollingInterval = setInterval(async () => {
            try {
                const resp = await fetch(`/financeiro/comprovantes/api/match/progresso/${batchId}`);
                const data = await resp.json();

                if (data.status === 'processando') {
                    const processados = data.processados || 0;
                    const total = data.total || 0;
                    const pct = total > 0 ? Math.round((processados / total) * 100) : 0;

                    document.getElementById('match-progresso-barra').style.width = pct + '%';
                    document.getElementById('match-progresso-texto').textContent = `Processando comprovantes...`;
                    document.getElementById('match-progresso-contagem').textContent = `${processados}/${total} (${pct}%)`;

                    const comMatch = data.com_match || 0;
                    const semMatch = data.sem_match || 0;
                    const erros = data.erros || 0;
                    const ultimoDoc = data.ultimo_doc || '';
                    document.getElementById('match-progresso-detalhe').textContent =
                        `${comMatch} com match, ${semMatch} sem match, ${erros} erros` +
                        (ultimoDoc ? ` | Doc: ${ultimoDoc}` : '');

                    // Atualizar stats parciais
                    document.getElementById('match-stat-processados').textContent = processados;
                    document.getElementById('match-stat-com-match').textContent = comMatch;
                    document.getElementById('match-stat-sem-match').textContent = semMatch;
                    document.getElementById('match-stat-erros').textContent = erros;
                    resultado.style.display = 'block';

                } else if (data.status === 'concluido') {
                    clearInterval(matchPollingInterval);
                    matchPollingInterval = null;

                    const stats = data.estatisticas || {};
                    document.getElementById('match-stat-processados').textContent = stats.processados || 0;
                    document.getElementById('match-stat-com-match').textContent = stats.com_match || 0;
                    document.getElementById('match-stat-sem-match').textContent = stats.sem_match || 0;
                    document.getElementById('match-stat-erros').textContent = stats.erros || 0;
                    resultado.style.display = 'block';

                    document.getElementById('match-progresso-barra').style.width = '100%';
                    document.getElementById('match-progresso-barra').classList.remove('progress-bar-animated');
                    document.getElementById('match-progresso-texto').textContent = 'Matching concluido!';
                    document.getElementById('match-progresso-contagem').textContent = '';
                    document.getElementById('match-progresso-detalhe').textContent = '';

                    setTimeout(() => {
                        finalizarMatchUI(btnMatch, progresso);
                        recarregarTabela();
                    }, 2000);

                } else if (data.status === 'erro') {
                    clearInterval(matchPollingInterval);
                    matchPollingInterval = null;

                    document.getElementById('match-progresso-texto').textContent = 'Erro no processamento';
                    document.getElementById('match-progresso-barra').classList.add('bg-danger');
                    document.getElementById('match-progresso-barra').classList.remove('bg-success');
                    document.getElementById('match-progresso-detalhe').textContent = data.ultimo_doc || '';

                    setTimeout(() => {
                        finalizarMatchUI(btnMatch, progresso);
                        recarregarTabela();
                    }, 3000);

                } else if (data.status === 'nao_encontrado') {
                    // Job ainda nao comecou — aguardar
                    document.getElementById('match-progresso-texto').textContent = 'Aguardando worker...';
                }

            } catch (err) {
                console.warn('Erro no polling de progresso match:', err);
            }
        }, 2000); // Polling a cada 2 segundos
    }

    function finalizarMatchUI(btnMatch, progresso) {
        btnMatch.disabled = false;
        btnMatch.innerHTML = '<i class="fas fa-search-dollar"></i> Executar Match (Todos Pendentes)';
        progresso.style.display = 'none';

        // Resetar barra
        const barra = document.getElementById('match-progresso-barra');
        barra.style.width = '0%';
        barra.classList.add('progress-bar-animated');
        barra.classList.remove('bg-danger');
        barra.classList.add('bg-success');
    }

    // --- Modal de Candidatos ---
    let comprovanteAtualId = null;

    window.abrirModalMatch = async function(comprovanteId) {
        comprovanteAtualId = comprovanteId;

        const modal = new bootstrap.Modal(document.getElementById('modalCandidatos'));
        document.getElementById('modal-loading').style.display = 'block';
        document.getElementById('modal-candidatos-lista').style.display = 'none';
        document.getElementById('modal-sem-candidatos').style.display = 'none';

        // Limpar info anterior
        document.getElementById('modal-benef').textContent = '...';
        document.getElementById('modal-cnpj').textContent = '...';
        document.getElementById('modal-doc').textContent = '...';
        document.getElementById('modal-valor').textContent = '...';
        document.getElementById('modal-venc').textContent = '...';

        modal.show();

        try {
            const resp = await fetch(`/financeiro/comprovantes/api/match/${comprovanteId}/candidatos`);
            const data = await resp.json();

            document.getElementById('modal-loading').style.display = 'none';

            if (data.sucesso && data.comprovante) {
                const comp = data.comprovante;
                document.getElementById('modal-benef').textContent = comp.beneficiario_razao_social || '-';
                document.getElementById('modal-cnpj').textContent = comp.beneficiario_cnpj_cpf || '-';
                document.getElementById('modal-doc').textContent = comp.numero_documento || '-';
                document.getElementById('modal-valor').textContent = comp.valor_documento != null
                    ? 'R$ ' + comp.valor_documento.toLocaleString('pt-BR', {minimumFractionDigits: 2})
                    : '-';
                document.getElementById('modal-venc').textContent = comp.data_vencimento || '-';
            }

            if (data.candidatos && data.candidatos.length > 0) {
                renderizarCandidatos(data.candidatos);
            } else {
                document.getElementById('modal-sem-candidatos').style.display = 'block';
            }

        } catch (err) {
            document.getElementById('modal-loading').style.display = 'none';
            document.getElementById('modal-sem-candidatos').style.display = 'block';
            document.getElementById('modal-sem-candidatos').innerHTML =
                '<i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>' +
                '<div class="text-danger">Erro: ' + err.message + '</div>';
        }
    };

    function renderizarCandidatos(candidatos) {
        const container = document.getElementById('modal-candidatos-lista');
        container.style.display = 'block';
        container.innerHTML = '';

        for (const cand of candidatos) {
            const scoreClass = cand.score >= 85 ? 'score-alto-border' :
                               cand.score >= 60 ? 'score-medio-border' : 'score-baixo-border';
            const scoreBg = cand.score >= 85 ? 'score-alto' :
                            cand.score >= 60 ? 'score-medio' : 'score-baixo';
            const financeira = cand.beneficiario_e_financeira
                ? '<span class="badge bg-warning text-dark ms-2">Financeira</span>' : '';

            const valorOriginal = cand.odoo_valor_original != null
                ? 'R$ ' + cand.odoo_valor_original.toLocaleString('pt-BR', {minimumFractionDigits: 2})
                : '-';
            const valorRecalc = cand.odoo_valor_recalculado != null
                ? '<br><small class="text-info">Recalc: R$ ' +
                  cand.odoo_valor_recalculado.toLocaleString('pt-BR', {minimumFractionDigits: 2}) +
                  '</small>'
                : '';
            const diff = cand.diferenca_valor != null
                ? 'R$ ' + cand.diferenca_valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})
                : '-';

            container.innerHTML += `
                <div class="match-candidato ${scoreClass} border rounded" data-move-line-id="${cand.odoo_move_line_id}">
                    <div class="row align-items-center">
                        <div class="col-md-1 text-center">
                            <span class="badge ${scoreBg} fs-6">${cand.score}%</span>
                        </div>
                        <div class="col-md-3">
                            <strong>${cand.odoo_partner_name || '-'}</strong>${financeira}
                            <br><small class="text-muted">Move: ${cand.odoo_move_name || '-'}</small>
                        </div>
                        <div class="col-md-2">
                            <strong>NF:</strong> ${cand.nf_numero || '-'}
                            <br><strong>Parcela:</strong> ${cand.parcela || '-'}
                        </div>
                        <div class="col-md-2">
                            <strong>Valor:</strong> ${valorOriginal}${valorRecalc}
                        </div>
                        <div class="col-md-1">
                            <strong>Diff:</strong> ${diff}
                        </div>
                        <div class="col-md-1">
                            <strong>Venc:</strong><br>
                            <small>${cand.odoo_vencimento_fmt || '-'}</small>
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-sm btn-success"
                                    onclick="salvarEConfirmarMatch(${comprovanteAtualId}, ${JSON.stringify(cand).replace(/"/g, '&quot;')})">
                                <i class="fas fa-check"></i> Confirmar
                            </button>
                        </div>
                    </div>
                    <div class="mt-1">
                        <small class="text-muted">${(cand.criterios || []).join(' | ')}</small>
                    </div>
                </div>`;
        }
    }

    window.salvarEConfirmarMatch = async function(comprovanteId, candidato) {
        if (!confirm('Confirmar este match?\n\nFornecedor: ' + (candidato.odoo_partner_name || '-') +
                      '\nNF: ' + (candidato.nf_numero || '-') + ' / Parcela: ' + (candidato.parcela || '-') +
                      '\nScore: ' + candidato.score + '%')) {
            return;
        }

        try {
            // Primeiro executar match individual para salvar
            const respMatch = await fetchComRetry(
                '/financeiro/comprovantes/api/match/executar',
                {
                    method: 'POST',
                    body: JSON.stringify({ comprovante_ids: [comprovanteId] }),
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCsrfHeaders()
                    }
                }
            );
            await respMatch.json();

            // Buscar lancamento criado para este comprovante + move_line
            const respResultados = await fetch(
                `/financeiro/comprovantes/api/match/resultados?comprovante_id=${comprovanteId}&status=PENDENTE`
            );
            const dadosResultados = await respResultados.json();

            if (dadosResultados.lancamentos && dadosResultados.lancamentos.length > 0) {
                // Encontrar o lancamento com o mesmo move_line_id
                const lancamento = dadosResultados.lancamentos.find(
                    l => l.odoo_move_line_id === candidato.odoo_move_line_id
                ) || dadosResultados.lancamentos[0];

                // Confirmar
                const respConfirmar = await fetchComRetry(
                    `/financeiro/comprovantes/api/match/${lancamento.id}/confirmar`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getCsrfHeaders()
                        }
                    }
                );
                const resultado = await respConfirmar.json();

                if (resultado.sucesso) {
                    alert('Match confirmado com sucesso!');
                    bootstrap.Modal.getInstance(document.getElementById('modalCandidatos')).hide();
                    recarregarTabela();
                } else {
                    alert('Erro ao confirmar: ' + (resultado.erro || 'Erro desconhecido'));
                }
            } else {
                alert('Nenhum lancamento encontrado para confirmar. Tente executar o match batch primeiro.');
            }
        } catch (err) {
            alert('Erro: ' + err.message);
        }
    };

    // --- Vinculacao Manual ---
    document.getElementById('btn-vincular-manual').addEventListener('click', async () => {
        if (!comprovanteAtualId) return;

        const nf = document.getElementById('manual-nf').value.trim();
        const parcela = document.getElementById('manual-parcela').value;
        const companyId = document.getElementById('manual-company').value;

        if (!nf) {
            alert('Informe o numero da NF.');
            return;
        }

        const btn = document.getElementById('btn-vincular-manual');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Vinculando...';

        try {
            const resp = await fetchComRetry(
                `/financeiro/comprovantes/api/match/${comprovanteAtualId}/vincular-manual`,
                {
                    method: 'POST',
                    body: JSON.stringify({
                        nf: nf,
                        parcela: parseInt(parcela),
                        company_id: parseInt(companyId),
                    }),
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCsrfHeaders()
                    }
                }
            );

            const data = await resp.json();

            if (data.sucesso) {
                alert('Vinculacao manual confirmada!');
                bootstrap.Modal.getInstance(document.getElementById('modalCandidatos')).hide();
                recarregarTabela();
            } else {
                alert('Erro: ' + (data.erro || 'Erro desconhecido'));
            }
        } catch (err) {
            alert('Erro de conexao: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-link"></i> Vincular Manual';
        }
    });

    // =========================================================================
    // LANÇAMENTO INDIVIDUAL (SÍNCRONO)
    // =========================================================================
    window.lancarIndividual = async function(lancamentoId) {
        if (!confirm('Confirma o lançamento deste pagamento no Odoo?\n\nIsso irá criar um payment, baixar o título e reconciliar com o extrato.')) {
            return;
        }

        try {
            const resp = await fetchComRetry(
                `/financeiro/comprovantes/api/match/${lancamentoId}/lancar`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCsrfHeaders()
                    }
                }
            );

            const data = await resp.json();

            if (data.sucesso) {
                alert(`Lançamento realizado com sucesso!\n\nPayment: ${data.payment_name}\nID: ${data.payment_id}`);
                recarregarTabela();
            } else {
                alert('Erro no lançamento: ' + (data.erro || 'Erro desconhecido'));
                recarregarTabela();
            }
        } catch (err) {
            alert('Erro de conexão: ' + err.message);
        }
    };

    // =========================================================================
    // LANÇAMENTO BATCH (ASSÍNCRONO VIA RQ + POLLING)
    // =========================================================================
    let lancamentoPollingInterval = null;

    document.getElementById('btn-executar-lancamento').addEventListener('click', async () => {
        if (!confirm('Confirma o lançamento de TODOS os comprovantes CONFIRMADOS no Odoo?\n\nIsso irá criar payments, baixar títulos e reconciliar com extratos.')) {
            return;
        }

        const btnLanc = document.getElementById('btn-executar-lancamento');
        const progresso = document.getElementById('lancamento-progresso');
        const resultado = document.getElementById('lancamento-resultado');

        btnLanc.disabled = true;
        btnLanc.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enfileirando...';
        progresso.style.display = 'block';
        resultado.style.display = 'none';

        try {
            const resp = await fetchComRetry(
                '/financeiro/comprovantes/api/lancamento/executar',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCsrfHeaders()
                    }
                }
            );

            const data = await resp.json();

            if (data.sucesso && data.batch_id) {
                btnLanc.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando em background...';
                document.getElementById('lancamento-progresso-texto').textContent = 'Iniciando lançamentos...';
                document.getElementById('lancamento-progresso-contagem').textContent = '';
                document.getElementById('lancamento-progresso-detalhe').textContent = '';
                document.getElementById('lancamento-progresso-barra').style.width = '0%';

                iniciarPollingLancamento(data.batch_id, btnLanc, progresso, resultado);
            } else {
                alert('Erro ao enfileirar: ' + (data.erro || 'Erro desconhecido'));
                finalizarLancamentoUI(btnLanc, progresso);
            }
        } catch (err) {
            alert('Erro de conexão: ' + err.message);
            finalizarLancamentoUI(btnLanc, progresso);
        }
    });

    function iniciarPollingLancamento(batchId, btnLanc, progresso, resultado) {
        if (lancamentoPollingInterval) clearInterval(lancamentoPollingInterval);

        lancamentoPollingInterval = setInterval(async () => {
            try {
                const resp = await fetch(`/financeiro/comprovantes/api/lancamento/progresso/${batchId}`);
                const data = await resp.json();

                if (data.status === 'processando') {
                    const processados = data.processados || 0;
                    const total = data.total || 0;
                    const pct = total > 0 ? Math.round((processados / total) * 100) : 0;

                    document.getElementById('lancamento-progresso-barra').style.width = pct + '%';
                    document.getElementById('lancamento-progresso-texto').textContent = 'Lançando pagamentos...';
                    document.getElementById('lancamento-progresso-contagem').textContent = `${processados}/${total} (${pct}%)`;

                    const sucesso = data.sucesso || 0;
                    const erros = data.erros || 0;
                    const ultimoPayment = data.ultimo_payment || '';
                    document.getElementById('lancamento-progresso-detalhe').textContent =
                        `${sucesso} lançados, ${erros} erros` +
                        (ultimoPayment ? ` | Payment: ${ultimoPayment}` : '');

                    document.getElementById('lancamento-stat-total').textContent = total;
                    document.getElementById('lancamento-stat-sucesso').textContent = sucesso;
                    document.getElementById('lancamento-stat-erros').textContent = erros;
                    resultado.style.display = 'block';

                } else if (data.status === 'concluido') {
                    clearInterval(lancamentoPollingInterval);
                    lancamentoPollingInterval = null;

                    const stats = data.estatisticas || {};
                    document.getElementById('lancamento-stat-total').textContent = stats.total || 0;
                    document.getElementById('lancamento-stat-sucesso').textContent = stats.sucesso || 0;
                    document.getElementById('lancamento-stat-erros').textContent = stats.erros || 0;
                    resultado.style.display = 'block';

                    document.getElementById('lancamento-progresso-barra').style.width = '100%';
                    document.getElementById('lancamento-progresso-barra').classList.remove('progress-bar-animated');
                    document.getElementById('lancamento-progresso-texto').textContent = 'Lançamentos concluídos!';
                    document.getElementById('lancamento-progresso-contagem').textContent = '';
                    document.getElementById('lancamento-progresso-detalhe').textContent = '';

                    setTimeout(() => {
                        finalizarLancamentoUI(btnLanc, progresso);
                        recarregarTabela();
                    }, 2000);

                } else if (data.status === 'erro') {
                    clearInterval(lancamentoPollingInterval);
                    lancamentoPollingInterval = null;

                    document.getElementById('lancamento-progresso-texto').textContent = 'Erro no processamento';
                    document.getElementById('lancamento-progresso-barra').classList.add('bg-danger');
                    document.getElementById('lancamento-progresso-barra').classList.remove('bg-primary');
                    document.getElementById('lancamento-progresso-detalhe').textContent = data.ultimo_payment || '';

                    setTimeout(() => {
                        finalizarLancamentoUI(btnLanc, progresso);
                        recarregarTabela();
                    }, 3000);

                } else if (data.status === 'nao_encontrado') {
                    document.getElementById('lancamento-progresso-texto').textContent = 'Aguardando worker...';
                }

            } catch (err) {
                console.warn('Erro no polling de progresso lançamento:', err);
            }
        }, 2000);
    }

    function finalizarLancamentoUI(btnLanc, progresso) {
        btnLanc.disabled = false;
        btnLanc.innerHTML = '<i class="fas fa-paper-plane"></i> Lançar Todos Confirmados';
        progresso.style.display = 'none';

        const barra = document.getElementById('lancamento-progresso-barra');
        barra.style.width = '0%';
        barra.classList.add('progress-bar-animated');
        barra.classList.remove('bg-danger');
        barra.classList.add('bg-primary');
    }

    // =========================================================================
    // MODAL DE DETALHES — Exibe TODOS os campos do comprovante + lançamento
    // =========================================================================
    window.abrirModalDetalhes = function(btn) {
        var tr = $(btn).closest('tr');
        var rowData = tabela.row(tr).data();
        if (!rowData) return;

        var odooBase = 'https://odoo.nacomgoya.com.br/web#';

        // Helper: valor ou traço cinza
        function v(val) {
            if (val == null || val === '' || val === undefined) return '<span class="text-muted">-</span>';
            return val;
        }
        // Helper: valor monetário
        function m(val) {
            if (val == null) return '<span class="text-muted">-</span>';
            return 'R$ ' + val.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        // Helper: badge colorido
        function badge(val, cls) {
            if (!val) return '<span class="text-muted">-</span>';
            return '<span class="badge ' + cls + '">' + val + '</span>';
        }
        // Helper: link Odoo
        function odooLink(id, model, label) {
            if (!id) return '<span class="text-muted">-</span>';
            var txt = label || id;
            return '<a href="' + odooBase + 'id=' + id + '&model=' + model +
                   '&view_type=form" target="_blank" class="det-odoo-link text-primary">' +
                   '<i class="fas fa-external-link-alt me-1"></i>' + txt + '</a>';
        }
        // Helper: boolean badge
        function boolBadge(val) {
            if (val === true) return '<span class="badge bg-success">Sim</span>';
            if (val === false) return '<span class="badge bg-danger">Não</span>';
            return '<span class="text-muted">-</span>';
        }
        // Helper: construir linha
        function row(label, value) {
            return '<div class="det-row"><div class="det-label">' + label +
                   '</div><div class="det-value">' + value + '</div></div>';
        }
        // Helper: construir linha mono
        function rowMono(label, value) {
            return '<div class="det-row"><div class="det-label">' + label +
                   '</div><div class="det-value mono">' + v(value) + '</div></div>';
        }

        // Atualizar título
        document.getElementById('det-agendamento').textContent =
            rowData.numero_agendamento ? '# ' + rowData.numero_agendamento : '';

        var html = '<div class="row">';

        // ── COLUNA ESQUERDA ──
        html += '<div class="col-lg-6">';

        // SEÇÃO 1: Comprovante (dados do boleto/PDF)
        html += '<div class="det-section">';
        html += '<h6><i class="fas fa-file-invoice text-primary me-2"></i>Comprovante (Boleto)</h6>';
        html += rowMono('N. Agendamento', rowData.numero_agendamento);
        html += rowMono('N. Documento', rowData.numero_documento);
        html += rowMono('Nosso Número', rowData.nosso_numero);
        html += row('Tipo Documento', v(rowData.tipo_documento));
        html += rowMono('Linha Digitável', rowData.linha_digitavel);
        html += row('Instituição Emissora', v(rowData.instituicao_emissora));
        html += row('Cooperativa / Conta', v(rowData.cooperativa) + ' / ' + v(rowData.conta));
        html += row('Situação', v(rowData.situacao));
        html += rowMono('Autenticação', rowData.autenticacao);
        html += row('Data Comprovante', v(rowData.data_comprovante));
        html += row('Data Realizado', v(rowData.data_realizado));
        html += '</div>';

        // SEÇÃO 2: Beneficiário & Pagador
        html += '<div class="det-section">';
        html += '<h6><i class="fas fa-building text-success me-2"></i>Beneficiário & Pagador</h6>';
        html += row('Beneficiário', v(rowData.beneficiario_razao_social));
        html += rowMono('CNPJ Beneficiário', rowData.beneficiario_cnpj_cpf);
        html += row('Nome Fantasia', v(rowData.beneficiario_nome_fantasia));
        html += '<hr class="my-1">';
        html += row('Pagador', v(rowData.pagador_razao_social));
        html += rowMono('CNPJ Pagador', rowData.pagador_cnpj_cpf);
        html += row('Nome Fantasia Pagador', v(rowData.pagador_nome_fantasia));
        html += '</div>';

        // SEÇÃO 3: Valores & Datas
        html += '<div class="det-section">';
        html += '<h6><i class="fas fa-dollar-sign text-warning me-2"></i>Valores & Datas</h6>';
        html += row('Valor Documento', m(rowData.valor_documento));
        html += row('Desconto / Abatimento', m(rowData.valor_desconto_abatimento));
        html += row('Juros / Multa', m(rowData.valor_juros_multa));
        html += row('<strong>Valor Pago</strong>',
                    '<strong class="text-primary">' + m(rowData.valor_pago) + '</strong>');
        html += row('Data Pagamento', v(rowData.data_pagamento));
        html += row('Data Vencimento', v(rowData.data_vencimento));
        html += '</div>';

        // SEÇÃO 8: Metadados de Importação
        html += '<div class="det-section">';
        html += '<h6><i class="fas fa-upload text-secondary me-2"></i>Metadados de Importação</h6>';
        html += row('Arquivo Origem', v(rowData.arquivo_origem));
        html += row('Página', v(rowData.pagina_origem));
        html += row('Importado por', v(rowData.importado_por));
        html += row('Importado em', v(rowData.importado_em));
        html += rowMono('S3 Path', rowData.arquivo_s3_path);
        html += '</div>';

        html += '</div>'; // fim col-lg-6 esquerda

        // ── COLUNA DIREITA ──
        html += '<div class="col-lg-6">';

        // SEÇÃO 4: Vínculo OFX (Extrato Bancário)
        html += '<div class="det-section">';
        html += '<h6><i class="fas fa-file-alt text-info me-2"></i>Vínculo OFX (Extrato Bancário)</h6>';
        if (rowData.ofx_fitid) {
            html += rowMono('FITID', rowData.ofx_fitid);
            html += rowMono('Checknum', rowData.ofx_checknum);
            html += row('Memo', v(rowData.ofx_memo));
            html += row('Valor OFX', m(rowData.ofx_valor));
            html += row('Data OFX', v(rowData.ofx_data));
            html += row('Arquivo OFX', v(rowData.ofx_arquivo_origem));
        } else {
            html += '<div class="text-muted text-center py-2"><i class="fas fa-minus-circle me-1"></i>Sem vínculo OFX</div>';
        }
        html += '</div>';

        // SEÇÃO 5: Vínculo Odoo (Extrato)
        html += '<div class="det-section">';
        html += '<h6><i class="fas fa-university text-success me-2"></i>Vínculo Odoo (Extrato)</h6>';
        if (rowData.odoo_statement_line_id) {
            html += row('Statement Line ID', odooLink(rowData.odoo_statement_line_id, 'account.bank.statement.line', 'Line #' + rowData.odoo_statement_line_id));
            html += row('Move ID', odooLink(rowData.odoo_move_id, 'account.move', 'Move #' + rowData.odoo_move_id));
            html += row('Statement ID', v(rowData.odoo_statement_id));
            html += row('Journal ID', v(rowData.odoo_journal_id));
            html += row('Conciliado?', boolBadge(rowData.odoo_is_reconciled));
            html += row('Vinculado em', v(rowData.odoo_vinculado_em));
        } else {
            html += '<div class="text-muted text-center py-2"><i class="fas fa-minus-circle me-1"></i>Sem vínculo com extrato Odoo</div>';
        }
        html += '</div>';

        // SEÇÃO 6: Match / Lançamento (condicional)
        if (rowData.lancamento_status) {
            html += '<div class="det-section">';
            html += '<h6><i class="fas fa-search-dollar text-primary me-2"></i>Match / Lançamento</h6>';

            // Status badge
            var statusBadge = '';
            if (rowData.lancamento_status === 'PENDENTE') statusBadge = badge('PENDENTE', 'bg-warning text-dark');
            else if (rowData.lancamento_status === 'CONFIRMADO') statusBadge = badge('CONFIRMADO', 'bg-info text-white');
            else if (rowData.lancamento_status === 'LANCADO') statusBadge = badge('BAIXADO', 'bg-success');
            else if (rowData.lancamento_status === 'REJEITADO') statusBadge = badge('REJEITADO', 'bg-danger');
            else statusBadge = badge(rowData.lancamento_status, 'bg-secondary');

            // Score badge
            var scoreBadge = '<span class="text-muted">-</span>';
            if (rowData.lancamento_match_score != null) {
                var sClass = rowData.lancamento_match_score >= 85 ? 'bg-success' :
                             rowData.lancamento_match_score >= 60 ? 'bg-warning text-dark' : 'bg-danger';
                scoreBadge = '<span class="badge ' + sClass + '">' + rowData.lancamento_match_score + '%</span>';
            }

            html += row('Status', statusBadge);
            html += row('Score', scoreBadge);
            html += row('NF / Parcela', v(rowData.lancamento_nf_numero) +
                        (rowData.lancamento_parcela ? ' / ' + rowData.lancamento_parcela : ''));
            html += row('Partner Odoo', v(rowData.lancamento_odoo_partner_name) +
                        (rowData.lancamento_odoo_partner_cnpj ? ' <span class="text-muted" style="font-size:0.85em">(' + rowData.lancamento_odoo_partner_cnpj + ')</span>' : ''));
            html += row('Company ID', v(rowData.lancamento_odoo_company_id));
            html += row('Fatura (move)',
                        (rowData.lancamento_odoo_move_name ? rowData.lancamento_odoo_move_name + ' ' : '') +
                        (rowData.lancamento_odoo_move_id ? odooLink(rowData.lancamento_odoo_move_id, 'account.move', '#' + rowData.lancamento_odoo_move_id) : v(null)));
            html += row('Move Line ID', rowData.lancamento_odoo_move_line_id ? odooLink(rowData.lancamento_odoo_move_line_id, 'account.move.line', '#' + rowData.lancamento_odoo_move_line_id) : v(null));
            html += row('Valor Original', m(rowData.lancamento_odoo_valor_original));
            html += row('Valor Residual', m(rowData.lancamento_odoo_valor_residual));
            html += row('Valor Recalculado', m(rowData.lancamento_odoo_valor_recalculado));
            html += row('Vencimento Odoo', v(rowData.lancamento_odoo_vencimento));

            // Diferença valor
            if (rowData.lancamento_diferenca_valor != null) {
                var absDiff = Math.abs(rowData.lancamento_diferenca_valor);
                var diffCls = absDiff < 0.01 ? 'text-success' : 'text-danger';
                var diffSign = rowData.lancamento_diferenca_valor >= 0 ? '+' : '-';
                var diffFmt = 'R$ ' + absDiff.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                html += row('Diferença', '<span class="' + diffCls + '">' + diffSign + diffFmt + '</span>');
            } else {
                html += row('Diferença', v(null));
            }

            html += row('Financeira?', boolBadge(rowData.lancamento_beneficiario_e_financeira));

            // Match critérios (JSON → lista)
            if (rowData.lancamento_match_criterios) {
                try {
                    var criterios = JSON.parse(rowData.lancamento_match_criterios);
                    var criteriosHtml = '<ul class="mb-0 ps-3" style="font-size:0.88em">';
                    if (Array.isArray(criterios)) {
                        criterios.forEach(function(c) {
                            criteriosHtml += '<li>' + c + '</li>';
                        });
                    } else if (typeof criterios === 'object') {
                        Object.keys(criterios).forEach(function(k) {
                            criteriosHtml += '<li><strong>' + k + '</strong>: ' + criterios[k] + '</li>';
                        });
                    }
                    criteriosHtml += '</ul>';
                    html += row('Critérios Match', criteriosHtml);
                } catch(e) {
                    html += row('Critérios Match', '<span style="font-size:0.85em">' + rowData.lancamento_match_criterios + '</span>');
                }
            }

            html += row('Criado em', v(rowData.lancamento_criado_em));
            html += row('Confirmado em / por', v(rowData.lancamento_confirmado_em) +
                        (rowData.lancamento_confirmado_por ? ' — ' + rowData.lancamento_confirmado_por : ''));
            html += '</div>';
        }

        // SEÇÃO 7: Lançamento Odoo (só se LANCADO)
        if (rowData.lancamento_status === 'LANCADO') {
            html += '<div class="det-section">';
            html += '<h6><i class="fas fa-check-double text-success me-2"></i>Lançamento Odoo (Baixa)</h6>';
            html += row('Payment ID', odooLink(rowData.lancamento_odoo_payment_id, 'account.payment', '#' + rowData.lancamento_odoo_payment_id));
            html += row('Payment Name', v(rowData.lancamento_odoo_payment_name));
            html += row('Lançado em / por', v(rowData.lancamento_lancado_em) +
                        (rowData.lancamento_lancado_por ? ' — ' + rowData.lancamento_lancado_por : ''));
            html += row('Full Reconcile Título', v(rowData.lancamento_odoo_full_reconcile_id));
            html += row('Full Reconcile Extrato', v(rowData.lancamento_odoo_full_reconcile_extrato_id));
            html += row('Debit Line ID', rowData.lancamento_odoo_debit_line_id ? odooLink(rowData.lancamento_odoo_debit_line_id, 'account.move.line', '#' + rowData.lancamento_odoo_debit_line_id) : v(null));
            html += row('Credit Line ID', rowData.lancamento_odoo_credit_line_id ? odooLink(rowData.lancamento_odoo_credit_line_id, 'account.move.line', '#' + rowData.lancamento_odoo_credit_line_id) : v(null));

            if (rowData.lancamento_erro) {
                html += row('Erro', '<span class="badge bg-danger">' + rowData.lancamento_erro + '</span>');
            }
            html += '</div>';
        }

        // Erro sem ser LANCADO
        if (rowData.lancamento_status && rowData.lancamento_status !== 'LANCADO' && rowData.lancamento_erro) {
            html += '<div class="det-section">';
            html += '<h6><i class="fas fa-exclamation-triangle text-danger me-2"></i>Erro</h6>';
            html += row('Mensagem', '<span class="text-danger" style="font-size:0.88em">' + rowData.lancamento_erro + '</span>');
            html += '</div>';
        }

        // Se NÃO tem lançamento
        if (!rowData.lancamento_status) {
            html += '<div class="det-section">';
            html += '<h6><i class="fas fa-search-dollar text-muted me-2"></i>Match / Lançamento</h6>';
            html += '<div class="text-muted text-center py-2"><i class="fas fa-minus-circle me-1"></i>Sem match realizado</div>';
            html += '</div>';
        }

        html += '</div>'; // fim col-lg-6 direita
        html += '</div>'; // fim row

        document.getElementById('modalDetalhesBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('modalDetalhes')).show();
    };

    // =========================================================================
    // FILTROS CLIENT-SIDE (DataTables custom search)
    // =========================================================================

    // Popular dropdown de confianca com valores DISTINTOS dos dados
    function popularFiltroConfianca() {
        var dados = tabela.rows().data().toArray();
        var valoresSet = new Set();
        dados.forEach(function(row) {
            var s = row.lancamento_match_score;
            valoresSet.add(s != null ? s : '__sem__');
        });

        // Preservar selecoes atuais
        var selecionados = new Set();
        document.querySelectorAll('.confianca-check:checked').forEach(function(cb) {
            selecionados.add(cb.value);
        });

        var valores = Array.from(valoresSet).sort(function(a, b) {
            if (a === '__sem__') return 1;
            if (b === '__sem__') return -1;
            return b - a; // decrescente
        });

        var container = document.getElementById('confianca-checks-container');
        container.innerHTML = '';

        valores.forEach(function(v) {
            var id = 'confianca-val-' + (v === '__sem__' ? 'sem' : v);
            var label = v === '__sem__' ? 'Sem Match' : v + '%';
            var badgeCls = v === '__sem__' ? 'bg-light text-muted' :
                           v >= 85 ? 'bg-success' :
                           v >= 60 ? 'bg-warning text-dark' : 'bg-danger';
            var checked = selecionados.has(String(v)) ? ' checked' : '';

            var div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = '<input class="form-check-input confianca-check" type="checkbox" ' +
                            'id="' + id + '" value="' + v + '"' + checked + '>' +
                            '<label class="form-check-label d-flex align-items-center gap-2" for="' + id + '">' +
                            '<span class="badge ' + badgeCls + '" style="min-width:42px">' + label + '</span>' +
                            '</label>';
            container.appendChild(div);
        });
    }

    // Chamar apos primeiro carregamento da tabela
    tabela.on('init.dt', function() {
        popularFiltroConfianca();
    });

    // Custom search function registrada no DataTables
    $.fn.dataTable.ext.search.push(function(settings, searchData, dataIndex) {
        // Aplicar apenas na tabela de comprovantes
        if (settings.nTable.id !== 'tabela-comprovantes') return true;

        var rowData = tabela.row(dataIndex).data();
        if (!rowData) return true;

        // --- 1. Filtro de Confianca (dropdown com checkboxes) ---
        var confiancaSel = [];
        document.querySelectorAll('.confianca-check:checked').forEach(function(cb) {
            confiancaSel.push(cb.value);
        });

        if (confiancaSel.length > 0) {
            var score = rowData.lancamento_match_score;
            var matchConfianca = false;

            for (var i = 0; i < confiancaSel.length; i++) {
                if (confiancaSel[i] === '__sem__' && score == null) { matchConfianca = true; break; }
                if (parseInt(confiancaSel[i]) === score) { matchConfianca = true; break; }
            }

            if (!matchConfianca) return false;
        }

        // --- 2. Checkboxes (OR entre si, AND com confianca) ---
        var checkOFX = document.getElementById('filtro-ofx').checked;
        var checkExtrato = document.getElementById('filtro-extrato').checked;
        var checkMatch = document.getElementById('filtro-match').checked;
        var checkConfirmado = document.getElementById('filtro-confirmado').checked;
        var checkBaixado = document.getElementById('filtro-baixado').checked;

        var algumCheckAtivo = checkOFX || checkExtrato || checkMatch || checkConfirmado || checkBaixado;

        if (algumCheckAtivo) {
            var matchCheck = false;

            if (checkOFX && rowData.ofx_fitid) matchCheck = true;
            if (checkExtrato && rowData.odoo_statement_line_id) matchCheck = true;
            if (checkMatch && rowData.lancamento_status) matchCheck = true;
            if (checkConfirmado && rowData.lancamento_status === 'CONFIRMADO') matchCheck = true;
            if (checkBaixado && rowData.lancamento_status === 'LANCADO') matchCheck = true;

            if (!matchCheck) return false;
        }

        return true;
    });

    // Event handlers para mudanca nos filtros
    $('#dropdown-confianca').on('change', '.confianca-check', function() {
        tabela.draw();
    });

    $('.filtro-check').on('change', function() {
        tabela.draw();
    });

    // Links "Todos" e "Limpar" dentro do dropdown de confianca
    $('#confianca-selecionar-todos').on('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.confianca-check').forEach(function(cb) { cb.checked = true; });
        tabela.draw();
    });
    $('#confianca-limpar').on('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.confianca-check').forEach(function(cb) { cb.checked = false; });
        tabela.draw();
    });

    // Limpar todos os filtros (botao geral)
    document.getElementById('btn-limpar-filtros').addEventListener('click', function() {
        // Reset checkboxes de confianca
        document.querySelectorAll('.confianca-check').forEach(function(cb) {
            cb.checked = false;
        });
        // Reset checkboxes de pipeline
        document.querySelectorAll('.filtro-check').forEach(function(cb) {
            cb.checked = false;
        });
        tabela.draw();
    });

    // Atualizar badges de filtros ativos e contador total
    function atualizarContadorFiltros() {
        var count = 0;

        // Contar checkboxes de confianca selecionados
        var confiancaCount = document.querySelectorAll('.confianca-check:checked').length;
        count += confiancaCount;

        // Atualizar badge do botao de confianca
        var badgeConf = document.getElementById('badge-confianca-count');
        if (confiancaCount > 0) {
            badgeConf.textContent = confiancaCount;
            badgeConf.style.display = 'inline';
        } else {
            badgeConf.style.display = 'none';
        }

        // Contar checkboxes de pipeline marcados
        document.querySelectorAll('.filtro-check:checked').forEach(function() { count++; });

        // Atualizar badge geral (botao Filtros)
        var badge = document.getElementById('badge-filtros-ativos');
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }

        // Atualizar total (filtrado vs total)
        var info = tabela.page.info();
        var el = document.getElementById('total-comprovantes');
        if (count > 0) {
            el.textContent = info.recordsDisplay + ' de ' + info.recordsTotal;
        } else {
            el.textContent = info.recordsTotal;
        }
    }

    // Atualizar contador a cada redraw da tabela
    tabela.on('draw', function() {
        atualizarContadorFiltros();
    });

});
</script>
{% endblock %}
