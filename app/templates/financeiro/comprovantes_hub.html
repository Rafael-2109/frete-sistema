{% extends "base.html" %}

{% block title %}Comprovantes de Pagamento{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<style>
    .status-novo { color: var(--bs-success); }
    .status-duplicado { color: var(--bs-warning); }
    .status-erro { color: var(--bs-danger); }
    .status-vinculado { color: var(--bs-info); }
    .status-sem_match { color: var(--bs-secondary); }
    .status-ja_vinculado { color: var(--bs-warning); }
    .badge-ofx { font-size: 0.7em; }
    .badge-odoo { font-size: 0.7em; }
    .badge-match { font-size: 0.7em; cursor: pointer; }
    .score-alto { background-color: #198754 !important; }
    .score-medio { background-color: #fd7e14 !important; }
    .score-baixo { background-color: #dc3545 !important; }
    .match-candidato { border-left: 4px solid transparent; padding: 10px; margin-bottom: 8px; cursor: pointer; }
    .match-candidato:hover { background-color: #f0f8ff; }
    .match-candidato.score-alto-border { border-left-color: #198754; }
    .match-candidato.score-medio-border { border-left-color: #fd7e14; }
    .match-candidato.score-baixo-border { border-left-color: #dc3545; }
    .badge-status { font-size: 0.7em; }
    .odoo-link { text-decoration: none; font-size: 0.85em; margin: 0 2px; }
    .odoo-link:hover { opacity: 0.8; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="max-width: 1400px;">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <i class="fas fa-receipt text-warning"></i>
                Comprovantes de Pagamento de Boleto
            </h2>
            <small class="text-muted">
                <span id="total-comprovantes">{{ total_comprovantes }}</span> comprovante(s) importado(s)
            </small>
        </div>
        <a href="{{ url_for('financeiro.dashboard') }}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Central Financeira
        </a>
    </div>

    <!-- Painel de Progresso (oculto) -->
    <div id="painel-progresso" class="card shadow-sm mb-4" style="display: none;">
        <div class="card-header bg-primary text-white">
            <strong><i class="fas fa-cog fa-spin me-2"></i> Processando Comprovantes</strong>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span id="progresso-texto">Iniciando...</span>
                    <span id="progresso-contagem">0/0</span>
                </div>
                <div class="progress" style="height: 20px;">
                    <div id="progresso-barra" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">0%</div>
                </div>
            </div>
            <div class="row text-center mb-3">
                <div class="col-4">
                    <div class="rounded p-2" style="background: var(--bs-success-bg-subtle);">
                        <div class="fs-4 fw-bold text-success" id="stat-novos">0</div>
                        <small class="text-muted">Novos</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="rounded p-2" style="background: var(--bs-warning-bg-subtle);">
                        <div class="fs-4 fw-bold text-warning" id="stat-duplicados">0</div>
                        <small class="text-muted">Duplicados</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="rounded p-2" style="background: var(--bs-danger-bg-subtle);">
                        <div class="fs-4 fw-bold text-danger" id="stat-erros">0</div>
                        <small class="text-muted">Erros</small>
                    </div>
                </div>
            </div>
            <div id="lista-resultados" class="small" style="max-height: 250px; overflow-y: auto;"></div>
        </div>
        <div class="card-footer" id="progresso-footer" style="display: none;">
            <button class="btn btn-outline-secondary btn-sm" onclick="fecharProgresso()">
                <i class="fas fa-times"></i> Fechar
            </button>
        </div>
    </div>

    <!-- Card de Upload -->
    <div id="card-upload" class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <strong><i class="fas fa-cloud-upload-alt"></i> Importar Comprovantes</strong>
        </div>
        <div class="card-body">
            <!-- Inputs ocultos (fora de qualquer container clicável) -->
            <input type="file" id="input-arquivos" accept=".pdf" multiple style="display: none;">
            <input type="file" id="input-pasta" webkitdirectory style="display: none;">

            <!-- Botões de seleção -->
            <div class="d-flex gap-2 mb-3">
                <button type="button" class="btn btn-outline-secondary" id="btn-selecionar-arquivos">
                    <i class="fas fa-file-pdf"></i> Selecionar Arquivo(s)
                </button>
                <button type="button" class="btn btn-outline-secondary" id="btn-selecionar-pasta">
                    <i class="fas fa-folder-open"></i> Selecionar Pasta
                </button>
            </div>

            <!-- Lista de arquivos selecionados -->
            <div id="arquivos-selecionados" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong><i class="fas fa-list me-1"></i> Arquivos Selecionados</strong>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-limpar">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                </div>
                <div id="lista-selecionados" class="list-group list-group-flush small"
                     style="max-height: 200px; overflow-y: auto;"></div>
            </div>

            <hr>
            <button type="button" id="btn-processar" class="btn btn-primary" disabled>
                <i class="fas fa-upload"></i> Processar <span id="contagem-arquivos">(0 arquivos)</span>
            </button>
        </div>
    </div>

    <!-- Card de Upload OFX -->
    <div id="card-upload-ofx" class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <strong><i class="fas fa-file-code text-info"></i> Importar Extrato OFX</strong>
            <small class="text-muted ms-2">Vincular comprovantes com extrato bancario e Odoo</small>
        </div>
        <div class="card-body">
            <input type="file" id="input-ofx" accept=".ofx" style="display: none;">

            <div class="d-flex gap-2 mb-3">
                <button type="button" class="btn btn-outline-info" id="btn-selecionar-ofx">
                    <i class="fas fa-file-code"></i> Selecionar Arquivo OFX
                </button>
            </div>

            <div id="ofx-arquivo-selecionado" style="display: none;" class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-file-code text-info me-2"></i> <strong id="ofx-nome-arquivo"></strong></span>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-limpar-ofx">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                </div>
            </div>

            <button type="button" id="btn-processar-ofx" class="btn btn-info text-white" disabled>
                <i class="fas fa-link"></i> Importar e Vincular
            </button>
        </div>
        <!-- Resultado da vinculação OFX -->
        <div id="ofx-resultado" class="card-footer" style="display: none;">
            <div class="row text-center mb-2">
                <div class="col">
                    <div class="fs-5 fw-bold text-info" id="ofx-stat-total">0</div>
                    <small class="text-muted">Transacoes</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-success" id="ofx-stat-vinculados">0</div>
                    <small class="text-muted">Vinculados</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-primary" id="ofx-stat-odoo">0</div>
                    <small class="text-muted">Com Odoo</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-warning" id="ofx-stat-sem-comp">0</div>
                    <small class="text-muted">Sem Comprovante</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-secondary" id="ofx-stat-sem-odoo">0</div>
                    <small class="text-muted">Sem Odoo</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-muted" id="ofx-stat-ja-vinculados">0</div>
                    <small class="text-muted">Ja Vinculados</small>
                </div>
            </div>
            <div id="ofx-lista-detalhes" class="small" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Card de Match com Odoo -->
    <div id="card-match" class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <strong><i class="fas fa-search-dollar text-success"></i> Match com Faturas Odoo</strong>
            <small class="text-muted ms-2">Vincular comprovantes com faturas de fornecedor</small>
        </div>
        <div class="card-body">
            <div class="row align-items-end mb-3">
                <div class="col-md-3">
                    <label class="form-label small">Data Inicio</label>
                    <input type="date" id="match-data-inicio" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Data Fim</label>
                    <input type="date" id="match-data-fim" class="form-control form-control-sm">
                </div>
                <div class="col-md-6">
                    <button type="button" id="btn-executar-match" class="btn btn-success">
                        <i class="fas fa-search-dollar"></i> Executar Match (Todos Pendentes)
                    </button>
                </div>
            </div>
            <div id="match-progresso" style="display: none;">
                <div class="d-flex align-items-center mb-2">
                    <div class="spinner-border spinner-border-sm text-success me-2" role="status"></div>
                    <span id="match-progresso-texto">Enfileirando...</span>
                    <span class="ms-auto small text-muted" id="match-progresso-contagem"></span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div id="match-progresso-barra" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
                <div class="mt-1 small text-muted" id="match-progresso-detalhe"></div>
            </div>
        </div>
        <!-- Resultado do Match -->
        <div id="match-resultado" class="card-footer" style="display: none;">
            <div class="row text-center mb-2">
                <div class="col">
                    <div class="fs-5 fw-bold text-primary" id="match-stat-processados">0</div>
                    <small class="text-muted">Processados</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-success" id="match-stat-com-match">0</div>
                    <small class="text-muted">Com Match</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-warning" id="match-stat-sem-match">0</div>
                    <small class="text-muted">Sem Match</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-danger" id="match-stat-erros">0</div>
                    <small class="text-muted">Erros</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Card de Lançamento no Odoo -->
    <div id="card-lancamento" class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <strong><i class="fas fa-paper-plane text-primary"></i> Lançar Pagamentos no Odoo</strong>
            <small class="text-muted ms-2">Criar payments e reconciliar títulos + extratos</small>
        </div>
        <div class="card-body">
            <div class="d-flex align-items-center">
                <button type="button" id="btn-executar-lancamento" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Lançar Todos Confirmados
                </button>
                <small class="text-muted ms-3">Processa todos os comprovantes com status CONFIRMADO</small>
            </div>
            <div id="lancamento-progresso" style="display: none;" class="mt-3">
                <div class="d-flex align-items-center mb-2">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                    <span id="lancamento-progresso-texto">Enfileirando...</span>
                    <span class="ms-auto small text-muted" id="lancamento-progresso-contagem"></span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div id="lancamento-progresso-barra" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
                <div class="mt-1 small text-muted" id="lancamento-progresso-detalhe"></div>
            </div>
        </div>
        <div id="lancamento-resultado" class="card-footer" style="display: none;">
            <div class="row text-center mb-2">
                <div class="col">
                    <div class="fs-5 fw-bold text-primary" id="lancamento-stat-total">0</div>
                    <small class="text-muted">Total</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-success" id="lancamento-stat-sucesso">0</div>
                    <small class="text-muted">Lançados</small>
                </div>
                <div class="col">
                    <div class="fs-5 fw-bold text-danger" id="lancamento-stat-erros">0</div>
                    <small class="text-muted">Erros</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Comprovantes -->
    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <strong><i class="fas fa-table"></i> Comprovantes Importados</strong>
            <button class="btn btn-sm btn-outline-primary" onclick="recarregarTabela()">
                <i class="fas fa-sync"></i> Atualizar
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="tabela-comprovantes" class="table table-striped table-hover mb-0" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Data Pgto</th>
                            <th>Beneficiário</th>
                            <th>Pagador</th>
                            <th>N. Documento</th>
                            <th>N. Agendamento</th>
                            <th>OFX</th>
                            <th>Odoo</th>
                            <th>Match</th>
                            <th>Status</th>
                            <th>Links</th>
                            <th class="text-end">Vl. Documento</th>
                            <th class="text-end">Desconto</th>
                            <th class="text-end">Juros/Multa</th>
                            <th class="text-end">Vl. Pago</th>
                            <th>Vencimento</th>
                            <th>Arquivo</th>
                            <th>PDF</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Candidatos de Match -->
    <div class="modal fade" id="modalCandidatos" tabindex="-1" aria-labelledby="modalCandidatosLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCandidatosLabel">
                        <i class="fas fa-search-dollar text-success"></i> Candidatos de Match
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Info do comprovante -->
                    <div class="card mb-3">
                        <div class="card-body py-2">
                            <div class="row small">
                                <div class="col-md-4">
                                    <strong>Beneficiario:</strong> <span id="modal-benef"></span>
                                </div>
                                <div class="col-md-2">
                                    <strong>CNPJ:</strong> <span id="modal-cnpj"></span>
                                </div>
                                <div class="col-md-2">
                                    <strong>N. Doc:</strong> <span id="modal-doc"></span>
                                </div>
                                <div class="col-md-2">
                                    <strong>Valor:</strong> <span id="modal-valor" class="fw-bold"></span>
                                </div>
                                <div class="col-md-2">
                                    <strong>Vencimento:</strong> <span id="modal-venc"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="modal-loading" class="text-center py-4">
                        <div class="spinner-border text-success" role="status"></div>
                        <div class="mt-2">Buscando candidatos no Odoo...</div>
                    </div>

                    <!-- Lista de candidatos -->
                    <div id="modal-candidatos-lista" style="display: none;"></div>

                    <!-- Sem candidatos -->
                    <div id="modal-sem-candidatos" style="display: none;" class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <div>Nenhum candidato encontrado no Odoo.</div>
                    </div>

                    <!-- Vinculacao manual -->
                    <hr>
                    <div class="card">
                        <div class="card-header bg-light py-2">
                            <strong class="small"><i class="fas fa-edit"></i> Vinculacao Manual</strong>
                        </div>
                        <div class="card-body py-2">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-3">
                                    <label class="form-label small">NF</label>
                                    <input type="text" id="manual-nf" class="form-control form-control-sm" placeholder="Ex: 12345">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Parcela</label>
                                    <input type="number" id="manual-parcela" class="form-control form-control-sm" value="1" min="1">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Empresa</label>
                                    <select id="manual-company" class="form-select form-select-sm">
                                        <option value="1">NACOM GOYA - FB (1)</option>
                                        <option value="3">NACOM GOYA - SC (3)</option>
                                        <option value="4">NACOM GOYA - CD (4)</option>
                                        <option value="5">LA FAMIGLIA - LF (5)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" id="btn-vincular-manual" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-link"></i> Vincular Manual
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // =========================================================================
    // SELEÇÃO DE ARQUIVOS / PASTA
    // =========================================================================
    const inputArquivos = document.getElementById('input-arquivos');
    const inputPasta = document.getElementById('input-pasta');
    const listaSelecionados = document.getElementById('lista-selecionados');
    const divSelecionados = document.getElementById('arquivos-selecionados');
    const btnProcessar = document.getElementById('btn-processar');
    const contagemArquivos = document.getElementById('contagem-arquivos');
    const btnLimpar = document.getElementById('btn-limpar');

    let arquivosSelecionados = [];

    // Botão "Selecionar Arquivo(s)"
    document.getElementById('btn-selecionar-arquivos').addEventListener('click', () => {
        inputArquivos.click();
    });

    // Botão "Selecionar Pasta"
    document.getElementById('btn-selecionar-pasta').addEventListener('click', () => {
        inputPasta.click();
    });

    inputArquivos.addEventListener('change', () => {
        const files = Array.from(inputArquivos.files);
        adicionarArquivos(files);
        inputArquivos.value = '';
    });

    inputPasta.addEventListener('change', () => {
        const files = Array.from(inputPasta.files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
        adicionarArquivos(files);
        inputPasta.value = '';
    });

    btnLimpar.addEventListener('click', () => {
        arquivosSelecionados = [];
        atualizarLista();
    });

    function adicionarArquivos(files) {
        for (const f of files) {
            // Evitar duplicados pelo nome
            if (!arquivosSelecionados.find(a => a.name === f.name)) {
                arquivosSelecionados.push(f);
            }
        }
        atualizarLista();
    }

    function atualizarLista() {
        if (arquivosSelecionados.length === 0) {
            divSelecionados.style.display = 'none';
            btnProcessar.disabled = true;
            contagemArquivos.textContent = '(0 arquivos)';
            return;
        }

        divSelecionados.style.display = 'block';
        btnProcessar.disabled = false;
        contagemArquivos.textContent = `(${arquivosSelecionados.length} arquivo${arquivosSelecionados.length > 1 ? 's' : ''})`;

        listaSelecionados.innerHTML = arquivosSelecionados.map((f, i) => `
            <div class="list-group-item d-flex justify-content-between align-items-center py-1">
                <span><i class="fas fa-file-pdf text-danger me-2"></i>${f.name}</span>
                <button class="btn btn-sm btn-link text-danger p-0" onclick="removerArquivo(${i})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }

    window.removerArquivo = function(idx) {
        arquivosSelecionados.splice(idx, 1);
        atualizarLista();
    };

    // =========================================================================
    // FETCH COM RETRY (proteção SSL/conexão)
    // =========================================================================
    async function fetchComRetry(url, options, maxRetries = 3) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const resp = await fetch(url, options);
                return resp;
            } catch (err) {
                console.warn(`Tentativa ${i + 1}/${maxRetries} falhou: ${err.message}`);
                if (i < maxRetries - 1) {
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                    continue;
                }
                throw err;
            }
        }
    }

    // =========================================================================
    // CSRF HEADER
    // =========================================================================
    function getCsrfHeaders() {
        const csrf = document.querySelector('meta[name="csrf-token"]');
        return csrf ? { 'X-CSRFToken': csrf.content } : {};
    }

    // =========================================================================
    // UPLOAD / PROCESSAMENTO — DECISÃO AUTOMÁTICA
    // =========================================================================
    const LIMITE_MODO_SINCRONO = 5;   // Até 5 arquivos → síncrono
    const CHUNK_SIZE = 50;            // PDFs por request no modo batch

    btnProcessar.addEventListener('click', async () => {
        if (arquivosSelecionados.length === 0) return;

        if (arquivosSelecionados.length <= LIMITE_MODO_SINCRONO) {
            await processarSincrono();
        } else {
            await processarBatch();
        }
    });

    // =========================================================================
    // MODO SÍNCRONO (1-5 PDFs — uso diário)
    // =========================================================================
    async function processarSincrono() {
        iniciarPainel();

        const barra = document.getElementById('progresso-barra');
        const texto = document.getElementById('progresso-texto');
        const contagem = document.getElementById('progresso-contagem');
        const statNovos = document.getElementById('stat-novos');
        const statDuplicados = document.getElementById('stat-duplicados');
        const statErros = document.getElementById('stat-erros');
        const listaResultados = document.getElementById('lista-resultados');

        let totalNovos = 0, totalDuplicados = 0, totalErros = 0;
        const total = arquivosSelecionados.length;

        for (let i = 0; i < total; i++) {
            const arquivo = arquivosSelecionados[i];
            const pct = Math.round(((i) / total) * 100);

            texto.textContent = `Processando: ${arquivo.name}`;
            contagem.textContent = `${i + 1}/${total}`;
            barra.style.width = pct + '%';
            barra.textContent = pct + '%';

            const formData = new FormData();
            formData.append('arquivos', arquivo);

            try {
                const resp = await fetchComRetry(
                    '{{ url_for("financeiro.comprovantes_api_upload") }}',
                    { method: 'POST', body: formData, headers: getCsrfHeaders() }
                );

                const data = await resp.json();

                if (data.sucesso) {
                    totalNovos += data.novos;
                    totalDuplicados += data.duplicados;
                    totalErros += data.erros;

                    if (data.arquivos && data.arquivos.length > 0) {
                        for (const det of data.arquivos[0].detalhes) {
                            adicionarDetalhe(listaResultados, det, arquivo.name);
                        }
                    }
                } else {
                    totalErros++;
                    listaResultados.innerHTML += `
                        <div class="status-erro mb-1">
                            &#x274C; <strong>${arquivo.name}</strong> — ${data.mensagem || 'Erro desconhecido'}
                        </div>`;
                }
            } catch (err) {
                totalErros++;
                listaResultados.innerHTML += `
                    <div class="status-erro mb-1">
                        &#x274C; <strong>${arquivo.name}</strong> — Erro de conexão: ${err.message}
                    </div>`;
            }

            statNovos.textContent = totalNovos;
            statDuplicados.textContent = totalDuplicados;
            statErros.textContent = totalErros;
        }

        finalizarPainel('Concluído!', total, total);
    }

    // =========================================================================
    // MODO BATCH (>5 PDFs — via RQ + polling Redis)
    // =========================================================================
    async function processarBatch() {
        iniciarPainel();

        const barra = document.getElementById('progresso-barra');
        const texto = document.getElementById('progresso-texto');
        const contagem = document.getElementById('progresso-contagem');
        const statNovos = document.getElementById('stat-novos');
        const statDuplicados = document.getElementById('stat-duplicados');
        const statErros = document.getElementById('stat-erros');
        const listaResultados = document.getElementById('lista-resultados');

        const total = arquivosSelecionados.length;
        const totalChunks = Math.ceil(total / CHUNK_SIZE);

        texto.textContent = `Enviando ${total} arquivo(s) em ${totalChunks} lote(s)...`;
        contagem.textContent = `0/${total}`;

        // ---- ETAPA 1: Enviar chunks para o servidor ----
        let batchIds = [];
        let totalEnviados = 0;

        for (let c = 0; c < totalChunks; c++) {
            const inicio = c * CHUNK_SIZE;
            const chunk = arquivosSelecionados.slice(inicio, inicio + CHUNK_SIZE);

            const formData = new FormData();
            for (const arq of chunk) {
                formData.append('arquivos', arq);
            }

            texto.textContent = `Enviando lote ${c + 1}/${totalChunks} (${chunk.length} arquivo(s))...`;

            try {
                const resp = await fetchComRetry(
                    '{{ url_for("financeiro.comprovantes_api_upload_batch") }}',
                    { method: 'POST', body: formData, headers: getCsrfHeaders() }
                );

                const data = await resp.json();

                if (data.sucesso) {
                    batchIds.push({
                        id: data.batch_id,
                        total: data.total_arquivos,
                    });
                    totalEnviados += data.total_arquivos;
                    listaResultados.innerHTML += `
                        <div class="text-info mb-1">
                            <i class="fas fa-check-circle"></i> Lote ${c + 1} enviado: ${data.total_arquivos} arquivo(s) enfileirado(s)
                        </div>`;
                } else {
                    listaResultados.innerHTML += `
                        <div class="status-erro mb-1">
                            &#x274C; Lote ${c + 1} falhou: ${data.mensagem || 'Erro desconhecido'}
                        </div>`;
                }
            } catch (err) {
                listaResultados.innerHTML += `
                    <div class="status-erro mb-1">
                        &#x274C; Lote ${c + 1} — Erro de conexão: ${err.message}
                    </div>`;
            }

            // Progresso de envio (fase de upload)
            const pctEnvio = Math.round(((c + 1) / totalChunks) * 10); // 0-10% é envio
            barra.style.width = pctEnvio + '%';
            barra.textContent = pctEnvio + '%';
        }

        if (batchIds.length === 0) {
            texto.textContent = 'Nenhum lote foi enviado com sucesso.';
            barra.classList.remove('progress-bar-animated');
            barra.classList.add('bg-danger');
            document.getElementById('progresso-footer').style.display = 'block';
            arquivosSelecionados = [];
            atualizarLista();
            return;
        }

        // ---- ETAPA 2: Polling de progresso via Redis ----
        texto.textContent = `Processando ${totalEnviados} arquivo(s) no servidor...`;

        // Armazena detalhes já exibidos para evitar repetição
        let detalhesExibidos = 0;

        const pollingInterval = setInterval(async () => {
            try {
                // Acumular progresso de todos os batches
                let acum = {
                    arquivos_processados: 0,
                    total_arquivos: 0,
                    novos: 0,
                    duplicados: 0,
                    erros: 0,
                    arquivo_atual: null,
                    status: 'processando',
                    detalhes: [],
                    concluidos: 0,
                };

                for (const batch of batchIds) {
                    try {
                        const resp = await fetch(
                            `/financeiro/comprovantes/api/batch/${batch.id}/status`
                        );
                        if (resp.ok) {
                            const status = await resp.json();
                            acum.arquivos_processados += (status.arquivos_processados || 0);
                            acum.total_arquivos += (status.total_arquivos || batch.total);
                            acum.novos += (status.novos || 0);
                            acum.duplicados += (status.duplicados || 0);
                            acum.erros += (status.erros || 0);

                            if (status.detalhes) {
                                acum.detalhes = acum.detalhes.concat(status.detalhes);
                            }

                            if (status.arquivo_atual) {
                                acum.arquivo_atual = status.arquivo_atual;
                            }

                            if (status.status === 'concluido' || status.status === 'erro' || status.status === 'parcial') {
                                acum.concluidos++;
                            }
                        }
                    } catch (e) {
                        // Erro de polling (rede) — ignora e tenta novamente
                        console.warn(`Erro ao consultar batch ${batch.id}:`, e);
                    }
                }

                // Atualizar UI
                const pct = acum.total_arquivos > 0
                    ? Math.round(10 + (acum.arquivos_processados / acum.total_arquivos) * 90)
                    : 10;

                barra.style.width = pct + '%';
                barra.textContent = pct + '%';
                contagem.textContent = `${acum.arquivos_processados}/${acum.total_arquivos}`;
                statNovos.textContent = acum.novos;
                statDuplicados.textContent = acum.duplicados;
                statErros.textContent = acum.erros;

                if (acum.arquivo_atual) {
                    texto.textContent = `Processando: ${acum.arquivo_atual}`;
                }

                // Exibir novos detalhes
                if (acum.detalhes.length > detalhesExibidos) {
                    const novosDetalhes = acum.detalhes.slice(detalhesExibidos);
                    for (const det of novosDetalhes) {
                        adicionarDetalhe(listaResultados, det, det.arquivo || '');
                    }
                    detalhesExibidos = acum.detalhes.length;
                    // Auto-scroll para o final
                    listaResultados.scrollTop = listaResultados.scrollHeight;
                }

                // Verificar conclusão de TODOS os batches
                if (acum.concluidos >= batchIds.length) {
                    clearInterval(pollingInterval);
                    finalizarPainel(
                        `Concluído! ${acum.novos} novo(s), ${acum.duplicados} duplicado(s), ${acum.erros} erro(s)`,
                        acum.arquivos_processados,
                        acum.total_arquivos
                    );
                    recarregarTabela();
                }
            } catch (err) {
                console.warn('Erro no polling de progresso:', err);
            }
        }, 2000); // Polling a cada 2 segundos

        // Resetar seleção (arquivos já foram enviados ao servidor)
        arquivosSelecionados = [];
        atualizarLista();
    }

    // =========================================================================
    // FUNÇÕES AUXILIARES DE UI
    // =========================================================================
    function iniciarPainel() {
        const painel = document.getElementById('painel-progresso');
        painel.style.display = 'block';
        document.getElementById('card-upload').style.display = 'none';
        document.getElementById('progresso-footer').style.display = 'none';

        const barra = document.getElementById('progresso-barra');
        barra.style.width = '0%';
        barra.textContent = '0%';
        barra.className = 'progress-bar progress-bar-striped progress-bar-animated';

        document.getElementById('progresso-texto').textContent = 'Iniciando...';
        document.getElementById('progresso-contagem').textContent = '0/0';
        document.getElementById('stat-novos').textContent = '0';
        document.getElementById('stat-duplicados').textContent = '0';
        document.getElementById('stat-erros').textContent = '0';
        document.getElementById('lista-resultados').innerHTML = '';
    }

    function finalizarPainel(mensagem, processados, total) {
        const barra = document.getElementById('progresso-barra');
        barra.style.width = '100%';
        barra.textContent = '100%';
        barra.classList.remove('progress-bar-animated');
        barra.classList.add('bg-success');

        document.getElementById('progresso-texto').textContent = mensagem;
        document.getElementById('progresso-contagem').textContent = `${processados}/${total}`;
        document.getElementById('progresso-footer').style.display = 'block';

        arquivosSelecionados = [];
        atualizarLista();
        recarregarTabela();
    }

    function adicionarDetalhe(container, det, nomeArquivo) {
        const icon = det.status === 'novo' ? '&#x2705;' :
                     det.status === 'duplicado' ? '&#x26A0;&#xFE0F;' : '&#x274C;';
        container.innerHTML += `
            <div class="status-${det.status} mb-1">
                ${icon} <strong>${nomeArquivo}</strong>
                ${det.pagina ? ' p.' + det.pagina : ''}
                — ${det.mensagem || det.status}
                ${det.numero_agendamento ? '(Agend: ' + det.numero_agendamento + ')' : ''}
            </div>`;
    }

    window.fecharProgresso = function() {
        document.getElementById('painel-progresso').style.display = 'none';
        document.getElementById('card-upload').style.display = 'block';
    };

    // =========================================================================
    // DATATABLE
    // =========================================================================
    const tabela = $('#tabela-comprovantes').DataTable({
        ajax: {
            url: '{{ url_for("financeiro.comprovantes_api_dados") }}',
            dataSrc: 'dados',
        },
        columns: [
            { data: 'data_pagamento', defaultContent: '-' },
            {
                data: 'beneficiario_razao_social',
                render: function(val, type, row) {
                    if (!val) return '-';
                    var html = '<div>' + val + '</div>';
                    if (row.beneficiario_cnpj_cpf) {
                        html += '<small class="text-muted">' + row.beneficiario_cnpj_cpf + '</small>';
                    }
                    return html;
                },
                defaultContent: '-',
            },
            {
                data: 'pagador_razao_social',
                render: function(val, type, row) {
                    if (!val) return '-';
                    var html = '<div>' + val + '</div>';
                    if (row.pagador_cnpj_cpf) {
                        html += '<small class="text-muted">' + row.pagador_cnpj_cpf + '</small>';
                    }
                    return html;
                },
                defaultContent: '-',
            },
            { data: 'numero_documento', defaultContent: '-' },
            { data: 'numero_agendamento', defaultContent: '-' },
            {
                data: 'ofx_fitid',
                render: function(val, type, row) {
                    if (!val) return '<span class="badge bg-light text-muted badge-ofx">—</span>';
                    return '<span class="badge bg-info badge-ofx" title="FITID: ' + val + '">' +
                           '<i class="fas fa-link me-1"></i>OFX</span>';
                },
                defaultContent: '-',
                className: 'text-center',
            },
            {
                data: 'odoo_statement_line_id',
                render: function(val, type, row) {
                    if (!val) {
                        if (row.ofx_fitid) {
                            return '<span class="badge bg-warning text-dark badge-odoo" title="FITID vinculado mas sem linha no Odoo">' +
                                   '<i class="fas fa-exclamation-triangle me-1"></i>Pendente</span>';
                        }
                        return '<span class="badge bg-light text-muted badge-odoo">—</span>';
                    }
                    var title = 'Line ID: ' + val;
                    if (row.odoo_move_id) title += ' | Move: ' + row.odoo_move_id;
                    if (row.odoo_is_reconciled) title += ' | Conciliado';
                    return '<span class="badge bg-success badge-odoo" title="' + title + '">' +
                           '<i class="fas fa-check-circle me-1"></i>Odoo</span>';
                },
                defaultContent: '-',
                className: 'text-center',
            },
            {
                data: 'id',
                render: function(val, type, row) {
                    return '<button class="btn btn-sm btn-outline-success badge-match" ' +
                           'onclick="abrirModalMatch(' + val + ')" title="Buscar match no Odoo">' +
                           '<i class="fas fa-search-dollar"></i></button>';
                },
                className: 'text-center',
                orderable: false,
            },
            // Coluna STATUS (badge com ação de lançar)
            {
                data: 'lancamento_status',
                render: function(val, type, row) {
                    if (!val) return '<span class="badge bg-light text-muted badge-status">\u2014</span>';

                    if (val === 'PENDENTE') {
                        return '<span class="badge bg-warning text-dark badge-status" title="Match encontrado, aguardando confirmação">' +
                               '<i class="fas fa-clock me-1"></i>Pendente</span>';
                    }

                    if (val === 'CONFIRMADO') {
                        return '<span class="badge bg-info text-white badge-status me-1" title="Confirmado, pronto para lançar">' +
                               '<i class="fas fa-check me-1"></i>Confirmado</span>' +
                               '<button class="btn btn-sm btn-primary py-0 px-1" style="font-size: 0.7em;" ' +
                               'onclick="lancarIndividual(' + row.lancamento_id + ')" title="Lançar no Odoo">' +
                               '<i class="fas fa-paper-plane"></i></button>';
                    }

                    if (val === 'LANCADO') {
                        var tooltip = 'Baixado no Odoo';
                        if (row.lancamento_odoo_payment_name) tooltip += ' | Payment: ' + row.lancamento_odoo_payment_name;
                        if (row.lancamento_lancado_em) tooltip += ' | Em: ' + row.lancamento_lancado_em;
                        return '<span class="badge bg-success badge-status" title="' + tooltip + '">' +
                               '<i class="fas fa-check-double me-1"></i>Baixado</span>';
                    }

                    // Status com erro
                    if (row.lancamento_erro) {
                        return '<span class="badge bg-danger badge-status" title="Erro: ' +
                               row.lancamento_erro.substring(0, 200) + '">' +
                               '<i class="fas fa-exclamation-circle me-1"></i>Erro</span>';
                    }

                    return '<span class="badge bg-secondary badge-status">' + val + '</span>';
                },
                className: 'text-center',
                defaultContent: '-',
            },
            // Coluna LINKS para Odoo (título, extrato, payment)
            {
                data: 'lancamento_odoo_move_id',
                render: function(val, type, row) {
                    var links = [];
                    var odooBase = 'https://odoo.nacomgoya.com.br/web#';

                    // Link para título (account.move do lançamento)
                    if (val) {
                        links.push(
                            '<a href="' + odooBase + 'id=' + val + '&model=account.move&view_type=form" ' +
                            'target="_blank" class="odoo-link text-primary" title="Título (account.move ' + val + ')">' +
                            '<i class="fas fa-file-invoice"></i></a>'
                        );
                    }

                    // Link para extrato (account.bank.statement.line)
                    if (row.odoo_statement_line_id) {
                        links.push(
                            '<a href="' + odooBase + 'id=' + row.odoo_statement_line_id +
                            '&model=account.bank.statement.line&view_type=form" ' +
                            'target="_blank" class="odoo-link text-info" title="Extrato (statement.line ' + row.odoo_statement_line_id + ')">' +
                            '<i class="fas fa-university"></i></a>'
                        );
                    }

                    // Link para payment (account.payment) — só quando LANCADO
                    if (row.lancamento_odoo_payment_id) {
                        links.push(
                            '<a href="' + odooBase + 'id=' + row.lancamento_odoo_payment_id +
                            '&model=account.payment&view_type=form" ' +
                            'target="_blank" class="odoo-link text-success" title="Payment (' +
                            (row.lancamento_odoo_payment_name || row.lancamento_odoo_payment_id) + ')">' +
                            '<i class="fas fa-credit-card"></i></a>'
                        );
                    }

                    return links.length > 0 ? links.join(' ') : '<span class="text-muted">\u2014</span>';
                },
                className: 'text-center',
                orderable: false,
                defaultContent: '-',
            },
            {
                data: 'valor_documento',
                render: function(val) {
                    if (val == null) return '-';
                    return 'R$ ' + val.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                },
                className: 'text-end',
            },
            {
                data: 'valor_desconto_abatimento',
                render: function(val) {
                    if (val == null || val === 0) return '-';
                    return 'R$ ' + val.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                },
                className: 'text-end',
            },
            {
                data: 'valor_juros_multa',
                render: function(val) {
                    if (val == null || val === 0) return '-';
                    return 'R$ ' + val.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                },
                className: 'text-end',
            },
            {
                data: 'valor_pago',
                render: function(val) {
                    if (val == null) return '-';
                    return 'R$ ' + val.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                },
                className: 'text-end fw-bold',
            },
            { data: 'data_vencimento', defaultContent: '-' },
            { data: 'arquivo_origem', defaultContent: '-' },
            {
                data: 'arquivo_s3_path',
                render: function(val, type, row) {
                    if (!val) return '<span class="text-muted">\u2014</span>';
                    return '<button class="btn btn-sm btn-outline-primary" ' +
                           'onclick="abrirPdfComprovante(' + row.id + ')" ' +
                           'title="Abrir PDF (p. ' + (row.pagina_origem || '?') + ')">' +
                           '<i class="fas fa-file-pdf"></i></button>';
                },
                className: 'text-center',
                orderable: false,
            },
        ],
        order: [[0, 'desc']],
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json',
        },
        pageLength: 25,
        responsive: true,
    });

    window.recarregarTabela = function() {
        tabela.ajax.reload(function() {
            const info = tabela.page.info();
            document.getElementById('total-comprovantes').textContent = info.recordsTotal;
        });
    };

    // =========================================================================
    // ABRIR PDF DO COMPROVANTE (via presigned URL)
    // =========================================================================
    window.abrirPdfComprovante = async function(comprovanteId) {
        try {
            const resp = await fetch(`/financeiro/comprovantes/api/${comprovanteId}/pdf`);
            const data = await resp.json();

            if (data.sucesso && data.url) {
                window.open(data.url, '_blank');
            } else {
                alert('PDF nao disponivel: ' + (data.mensagem || 'Erro desconhecido'));
            }
        } catch (err) {
            alert('Erro ao abrir PDF: ' + err.message);
        }
    };

    // =========================================================================
    // UPLOAD OFX — Vincular com comprovantes e Odoo
    // =========================================================================
    const inputOfx = document.getElementById('input-ofx');
    const btnProcessarOfx = document.getElementById('btn-processar-ofx');
    const btnLimparOfx = document.getElementById('btn-limpar-ofx');
    const ofxNomeArquivo = document.getElementById('ofx-nome-arquivo');
    const ofxArquivoSelecionado = document.getElementById('ofx-arquivo-selecionado');

    let arquivoOfx = null;

    // Botão "Selecionar Arquivo OFX"
    document.getElementById('btn-selecionar-ofx').addEventListener('click', () => {
        inputOfx.click();
    });

    inputOfx.addEventListener('change', () => {
        if (inputOfx.files.length > 0) {
            selecionarOfx(inputOfx.files[0]);
        }
        inputOfx.value = '';
    });

    btnLimparOfx.addEventListener('click', () => {
        arquivoOfx = null;
        ofxArquivoSelecionado.style.display = 'none';
        btnProcessarOfx.disabled = true;
    });

    function selecionarOfx(file) {
        arquivoOfx = file;
        ofxNomeArquivo.textContent = file.name;
        ofxArquivoSelecionado.style.display = 'block';
        btnProcessarOfx.disabled = false;
    }

    btnProcessarOfx.addEventListener('click', async () => {
        if (!arquivoOfx) return;

        btnProcessarOfx.disabled = true;
        btnProcessarOfx.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

        const formData = new FormData();
        formData.append('arquivo_ofx', arquivoOfx);

        try {
            const resp = await fetchComRetry(
                '{{ url_for("financeiro.comprovantes_api_upload_ofx") }}',
                { method: 'POST', body: formData, headers: getCsrfHeaders() }
            );

            const data = await resp.json();

            // Mostrar resultado
            const resultado = document.getElementById('ofx-resultado');
            resultado.style.display = 'block';

            document.getElementById('ofx-stat-total').textContent = data.total_transacoes || 0;
            document.getElementById('ofx-stat-vinculados').textContent = data.vinculados_comprovante || 0;
            document.getElementById('ofx-stat-odoo').textContent = data.vinculados_odoo || 0;
            document.getElementById('ofx-stat-sem-comp').textContent = data.sem_comprovante || 0;
            document.getElementById('ofx-stat-sem-odoo').textContent = data.sem_odoo || 0;
            document.getElementById('ofx-stat-ja-vinculados').textContent = data.ja_vinculados || 0;

            // Detalhes
            const listaDetalhes = document.getElementById('ofx-lista-detalhes');
            listaDetalhes.innerHTML = '';

            if (data.detalhes && data.detalhes.length > 0) {
                for (const det of data.detalhes) {
                    const iconComp = det.status_comprovante === 'vinculado' ? '&#x2705;' :
                                     det.status_comprovante === 'ja_vinculado' ? '&#x26A0;&#xFE0F;' :
                                     det.status_comprovante === 'sem_match' ? '&#x2796;' : '&#x274C;';
                    const iconOdoo = det.status_odoo === 'vinculado' ? '&#x2705;' :
                                     det.status_odoo === 'sem_match' ? '&#x2796;' :
                                     det.status_odoo === 'nao_buscou' ? '&#x2B1C;' : '&#x274C;';

                    const valorStr = det.valor != null
                        ? 'R$ ' + Math.abs(det.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                        : '';

                    listaDetalhes.innerHTML += `
                        <div class="mb-1 border-bottom pb-1">
                            <span title="Comprovante">${iconComp}</span>
                            <span title="Odoo">${iconOdoo}</span>
                            <strong>CHECKNUM ${det.checknum || '?'}</strong>
                            ${det.data ? ' — ' + det.data : ''}
                            ${valorStr ? ' — ' + valorStr : ''}
                            <br><small class="text-muted">${det.mensagem || ''}</small>
                        </div>`;
                }
            }

            // Recarregar tabela para mostrar novas vinculações
            recarregarTabela();

        } catch (err) {
            alert('Erro ao processar OFX: ' + err.message);
        } finally {
            btnProcessarOfx.disabled = false;
            btnProcessarOfx.innerHTML = '<i class="fas fa-link"></i> Importar e Vincular';
        }
    });

    // =========================================================================
    // MATCH COM FATURAS ODOO
    // =========================================================================

    // --- Executar Match Batch (via RQ + polling) ---
    let matchPollingInterval = null;

    document.getElementById('btn-executar-match').addEventListener('click', async () => {
        const btnMatch = document.getElementById('btn-executar-match');
        const progresso = document.getElementById('match-progresso');
        const resultado = document.getElementById('match-resultado');

        btnMatch.disabled = true;
        btnMatch.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enfileirando...';
        progresso.style.display = 'block';
        resultado.style.display = 'none';

        const dataInicio = document.getElementById('match-data-inicio').value;
        const dataFim = document.getElementById('match-data-fim').value;

        const body = {};
        if (dataInicio) body.data_inicio = dataInicio;
        if (dataFim) body.data_fim = dataFim;

        try {
            const resp = await fetchComRetry(
                '/financeiro/comprovantes/api/match/executar',
                {
                    method: 'POST',
                    body: JSON.stringify(body),
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCsrfHeaders()
                    }
                }
            );

            const data = await resp.json();

            if (data.sucesso && data.batch_id) {
                btnMatch.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando em background...';
                document.getElementById('match-progresso-texto').textContent = 'Iniciando matching...';
                document.getElementById('match-progresso-contagem').textContent = '';
                document.getElementById('match-progresso-detalhe').textContent = '';
                document.getElementById('match-progresso-barra').style.width = '0%';

                // Iniciar polling de progresso
                iniciarPollingMatch(data.batch_id, btnMatch, progresso, resultado);
            } else {
                alert('Erro ao enfileirar: ' + (data.erro || 'Erro desconhecido'));
                finalizarMatchUI(btnMatch, progresso);
            }
        } catch (err) {
            alert('Erro de conexao: ' + err.message);
            finalizarMatchUI(btnMatch, progresso);
        }
    });

    function iniciarPollingMatch(batchId, btnMatch, progresso, resultado) {
        if (matchPollingInterval) clearInterval(matchPollingInterval);

        matchPollingInterval = setInterval(async () => {
            try {
                const resp = await fetch(`/financeiro/comprovantes/api/match/progresso/${batchId}`);
                const data = await resp.json();

                if (data.status === 'processando') {
                    const processados = data.processados || 0;
                    const total = data.total || 0;
                    const pct = total > 0 ? Math.round((processados / total) * 100) : 0;

                    document.getElementById('match-progresso-barra').style.width = pct + '%';
                    document.getElementById('match-progresso-texto').textContent = `Processando comprovantes...`;
                    document.getElementById('match-progresso-contagem').textContent = `${processados}/${total} (${pct}%)`;

                    const comMatch = data.com_match || 0;
                    const semMatch = data.sem_match || 0;
                    const erros = data.erros || 0;
                    const ultimoDoc = data.ultimo_doc || '';
                    document.getElementById('match-progresso-detalhe').textContent =
                        `${comMatch} com match, ${semMatch} sem match, ${erros} erros` +
                        (ultimoDoc ? ` | Doc: ${ultimoDoc}` : '');

                    // Atualizar stats parciais
                    document.getElementById('match-stat-processados').textContent = processados;
                    document.getElementById('match-stat-com-match').textContent = comMatch;
                    document.getElementById('match-stat-sem-match').textContent = semMatch;
                    document.getElementById('match-stat-erros').textContent = erros;
                    resultado.style.display = 'block';

                } else if (data.status === 'concluido') {
                    clearInterval(matchPollingInterval);
                    matchPollingInterval = null;

                    const stats = data.estatisticas || {};
                    document.getElementById('match-stat-processados').textContent = stats.processados || 0;
                    document.getElementById('match-stat-com-match').textContent = stats.com_match || 0;
                    document.getElementById('match-stat-sem-match').textContent = stats.sem_match || 0;
                    document.getElementById('match-stat-erros').textContent = stats.erros || 0;
                    resultado.style.display = 'block';

                    document.getElementById('match-progresso-barra').style.width = '100%';
                    document.getElementById('match-progresso-barra').classList.remove('progress-bar-animated');
                    document.getElementById('match-progresso-texto').textContent = 'Matching concluido!';
                    document.getElementById('match-progresso-contagem').textContent = '';
                    document.getElementById('match-progresso-detalhe').textContent = '';

                    setTimeout(() => {
                        finalizarMatchUI(btnMatch, progresso);
                        recarregarTabela();
                    }, 2000);

                } else if (data.status === 'erro') {
                    clearInterval(matchPollingInterval);
                    matchPollingInterval = null;

                    document.getElementById('match-progresso-texto').textContent = 'Erro no processamento';
                    document.getElementById('match-progresso-barra').classList.add('bg-danger');
                    document.getElementById('match-progresso-barra').classList.remove('bg-success');
                    document.getElementById('match-progresso-detalhe').textContent = data.ultimo_doc || '';

                    setTimeout(() => {
                        finalizarMatchUI(btnMatch, progresso);
                        recarregarTabela();
                    }, 3000);

                } else if (data.status === 'nao_encontrado') {
                    // Job ainda nao comecou — aguardar
                    document.getElementById('match-progresso-texto').textContent = 'Aguardando worker...';
                }

            } catch (err) {
                console.warn('Erro no polling de progresso match:', err);
            }
        }, 2000); // Polling a cada 2 segundos
    }

    function finalizarMatchUI(btnMatch, progresso) {
        btnMatch.disabled = false;
        btnMatch.innerHTML = '<i class="fas fa-search-dollar"></i> Executar Match (Todos Pendentes)';
        progresso.style.display = 'none';

        // Resetar barra
        const barra = document.getElementById('match-progresso-barra');
        barra.style.width = '0%';
        barra.classList.add('progress-bar-animated');
        barra.classList.remove('bg-danger');
        barra.classList.add('bg-success');
    }

    // --- Modal de Candidatos ---
    let comprovanteAtualId = null;

    window.abrirModalMatch = async function(comprovanteId) {
        comprovanteAtualId = comprovanteId;

        const modal = new bootstrap.Modal(document.getElementById('modalCandidatos'));
        document.getElementById('modal-loading').style.display = 'block';
        document.getElementById('modal-candidatos-lista').style.display = 'none';
        document.getElementById('modal-sem-candidatos').style.display = 'none';

        // Limpar info anterior
        document.getElementById('modal-benef').textContent = '...';
        document.getElementById('modal-cnpj').textContent = '...';
        document.getElementById('modal-doc').textContent = '...';
        document.getElementById('modal-valor').textContent = '...';
        document.getElementById('modal-venc').textContent = '...';

        modal.show();

        try {
            const resp = await fetch(`/financeiro/comprovantes/api/match/${comprovanteId}/candidatos`);
            const data = await resp.json();

            document.getElementById('modal-loading').style.display = 'none';

            if (data.sucesso && data.comprovante) {
                const comp = data.comprovante;
                document.getElementById('modal-benef').textContent = comp.beneficiario_razao_social || '-';
                document.getElementById('modal-cnpj').textContent = comp.beneficiario_cnpj_cpf || '-';
                document.getElementById('modal-doc').textContent = comp.numero_documento || '-';
                document.getElementById('modal-valor').textContent = comp.valor_documento != null
                    ? 'R$ ' + comp.valor_documento.toLocaleString('pt-BR', {minimumFractionDigits: 2})
                    : '-';
                document.getElementById('modal-venc').textContent = comp.data_vencimento || '-';
            }

            if (data.candidatos && data.candidatos.length > 0) {
                renderizarCandidatos(data.candidatos);
            } else {
                document.getElementById('modal-sem-candidatos').style.display = 'block';
            }

        } catch (err) {
            document.getElementById('modal-loading').style.display = 'none';
            document.getElementById('modal-sem-candidatos').style.display = 'block';
            document.getElementById('modal-sem-candidatos').innerHTML =
                '<i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>' +
                '<div class="text-danger">Erro: ' + err.message + '</div>';
        }
    };

    function renderizarCandidatos(candidatos) {
        const container = document.getElementById('modal-candidatos-lista');
        container.style.display = 'block';
        container.innerHTML = '';

        for (const cand of candidatos) {
            const scoreClass = cand.score >= 85 ? 'score-alto-border' :
                               cand.score >= 60 ? 'score-medio-border' : 'score-baixo-border';
            const scoreBg = cand.score >= 85 ? 'score-alto' :
                            cand.score >= 60 ? 'score-medio' : 'score-baixo';
            const financeira = cand.beneficiario_e_financeira
                ? '<span class="badge bg-warning text-dark ms-2">Financeira</span>' : '';

            const valorOriginal = cand.odoo_valor_original != null
                ? 'R$ ' + cand.odoo_valor_original.toLocaleString('pt-BR', {minimumFractionDigits: 2})
                : '-';
            const valorRecalc = cand.odoo_valor_recalculado != null
                ? '<br><small class="text-info">Recalc: R$ ' +
                  cand.odoo_valor_recalculado.toLocaleString('pt-BR', {minimumFractionDigits: 2}) +
                  '</small>'
                : '';
            const diff = cand.diferenca_valor != null
                ? 'R$ ' + cand.diferenca_valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})
                : '-';

            container.innerHTML += `
                <div class="match-candidato ${scoreClass} border rounded" data-move-line-id="${cand.odoo_move_line_id}">
                    <div class="row align-items-center">
                        <div class="col-md-1 text-center">
                            <span class="badge ${scoreBg} fs-6">${cand.score}%</span>
                        </div>
                        <div class="col-md-3">
                            <strong>${cand.odoo_partner_name || '-'}</strong>${financeira}
                            <br><small class="text-muted">Move: ${cand.odoo_move_name || '-'}</small>
                        </div>
                        <div class="col-md-2">
                            <strong>NF:</strong> ${cand.nf_numero || '-'}
                            <br><strong>Parcela:</strong> ${cand.parcela || '-'}
                        </div>
                        <div class="col-md-2">
                            <strong>Valor:</strong> ${valorOriginal}${valorRecalc}
                        </div>
                        <div class="col-md-1">
                            <strong>Diff:</strong> ${diff}
                        </div>
                        <div class="col-md-1">
                            <strong>Venc:</strong><br>
                            <small>${cand.odoo_vencimento_fmt || '-'}</small>
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-sm btn-success"
                                    onclick="salvarEConfirmarMatch(${comprovanteAtualId}, ${JSON.stringify(cand).replace(/"/g, '&quot;')})">
                                <i class="fas fa-check"></i> Confirmar
                            </button>
                        </div>
                    </div>
                    <div class="mt-1">
                        <small class="text-muted">${(cand.criterios || []).join(' | ')}</small>
                    </div>
                </div>`;
        }
    }

    window.salvarEConfirmarMatch = async function(comprovanteId, candidato) {
        if (!confirm('Confirmar este match?\n\nFornecedor: ' + (candidato.odoo_partner_name || '-') +
                      '\nNF: ' + (candidato.nf_numero || '-') + ' / Parcela: ' + (candidato.parcela || '-') +
                      '\nScore: ' + candidato.score + '%')) {
            return;
        }

        try {
            // Primeiro executar match individual para salvar
            const respMatch = await fetchComRetry(
                '/financeiro/comprovantes/api/match/executar',
                {
                    method: 'POST',
                    body: JSON.stringify({ comprovante_ids: [comprovanteId] }),
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCsrfHeaders()
                    }
                }
            );
            await respMatch.json();

            // Buscar lancamento criado para este comprovante + move_line
            const respResultados = await fetch(
                `/financeiro/comprovantes/api/match/resultados?comprovante_id=${comprovanteId}&status=PENDENTE`
            );
            const dadosResultados = await respResultados.json();

            if (dadosResultados.lancamentos && dadosResultados.lancamentos.length > 0) {
                // Encontrar o lancamento com o mesmo move_line_id
                const lancamento = dadosResultados.lancamentos.find(
                    l => l.odoo_move_line_id === candidato.odoo_move_line_id
                ) || dadosResultados.lancamentos[0];

                // Confirmar
                const respConfirmar = await fetchComRetry(
                    `/financeiro/comprovantes/api/match/${lancamento.id}/confirmar`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getCsrfHeaders()
                        }
                    }
                );
                const resultado = await respConfirmar.json();

                if (resultado.sucesso) {
                    alert('Match confirmado com sucesso!');
                    bootstrap.Modal.getInstance(document.getElementById('modalCandidatos')).hide();
                    recarregarTabela();
                } else {
                    alert('Erro ao confirmar: ' + (resultado.erro || 'Erro desconhecido'));
                }
            } else {
                alert('Nenhum lancamento encontrado para confirmar. Tente executar o match batch primeiro.');
            }
        } catch (err) {
            alert('Erro: ' + err.message);
        }
    };

    // --- Vinculacao Manual ---
    document.getElementById('btn-vincular-manual').addEventListener('click', async () => {
        if (!comprovanteAtualId) return;

        const nf = document.getElementById('manual-nf').value.trim();
        const parcela = document.getElementById('manual-parcela').value;
        const companyId = document.getElementById('manual-company').value;

        if (!nf) {
            alert('Informe o numero da NF.');
            return;
        }

        const btn = document.getElementById('btn-vincular-manual');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Vinculando...';

        try {
            const resp = await fetchComRetry(
                `/financeiro/comprovantes/api/match/${comprovanteAtualId}/vincular-manual`,
                {
                    method: 'POST',
                    body: JSON.stringify({
                        nf: nf,
                        parcela: parseInt(parcela),
                        company_id: parseInt(companyId),
                    }),
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCsrfHeaders()
                    }
                }
            );

            const data = await resp.json();

            if (data.sucesso) {
                alert('Vinculacao manual confirmada!');
                bootstrap.Modal.getInstance(document.getElementById('modalCandidatos')).hide();
                recarregarTabela();
            } else {
                alert('Erro: ' + (data.erro || 'Erro desconhecido'));
            }
        } catch (err) {
            alert('Erro de conexao: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-link"></i> Vincular Manual';
        }
    });

    // =========================================================================
    // LANÇAMENTO INDIVIDUAL (SÍNCRONO)
    // =========================================================================
    window.lancarIndividual = async function(lancamentoId) {
        if (!confirm('Confirma o lançamento deste pagamento no Odoo?\n\nIsso irá criar um payment, baixar o título e reconciliar com o extrato.')) {
            return;
        }

        try {
            const resp = await fetchComRetry(
                `/financeiro/comprovantes/api/match/${lancamentoId}/lancar`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCsrfHeaders()
                    }
                }
            );

            const data = await resp.json();

            if (data.sucesso) {
                alert(`Lançamento realizado com sucesso!\n\nPayment: ${data.payment_name}\nID: ${data.payment_id}`);
                recarregarTabela();
            } else {
                alert('Erro no lançamento: ' + (data.erro || 'Erro desconhecido'));
                recarregarTabela();
            }
        } catch (err) {
            alert('Erro de conexão: ' + err.message);
        }
    };

    // =========================================================================
    // LANÇAMENTO BATCH (ASSÍNCRONO VIA RQ + POLLING)
    // =========================================================================
    let lancamentoPollingInterval = null;

    document.getElementById('btn-executar-lancamento').addEventListener('click', async () => {
        if (!confirm('Confirma o lançamento de TODOS os comprovantes CONFIRMADOS no Odoo?\n\nIsso irá criar payments, baixar títulos e reconciliar com extratos.')) {
            return;
        }

        const btnLanc = document.getElementById('btn-executar-lancamento');
        const progresso = document.getElementById('lancamento-progresso');
        const resultado = document.getElementById('lancamento-resultado');

        btnLanc.disabled = true;
        btnLanc.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enfileirando...';
        progresso.style.display = 'block';
        resultado.style.display = 'none';

        try {
            const resp = await fetchComRetry(
                '/financeiro/comprovantes/api/lancamento/executar',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCsrfHeaders()
                    }
                }
            );

            const data = await resp.json();

            if (data.sucesso && data.batch_id) {
                btnLanc.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando em background...';
                document.getElementById('lancamento-progresso-texto').textContent = 'Iniciando lançamentos...';
                document.getElementById('lancamento-progresso-contagem').textContent = '';
                document.getElementById('lancamento-progresso-detalhe').textContent = '';
                document.getElementById('lancamento-progresso-barra').style.width = '0%';

                iniciarPollingLancamento(data.batch_id, btnLanc, progresso, resultado);
            } else {
                alert('Erro ao enfileirar: ' + (data.erro || 'Erro desconhecido'));
                finalizarLancamentoUI(btnLanc, progresso);
            }
        } catch (err) {
            alert('Erro de conexão: ' + err.message);
            finalizarLancamentoUI(btnLanc, progresso);
        }
    });

    function iniciarPollingLancamento(batchId, btnLanc, progresso, resultado) {
        if (lancamentoPollingInterval) clearInterval(lancamentoPollingInterval);

        lancamentoPollingInterval = setInterval(async () => {
            try {
                const resp = await fetch(`/financeiro/comprovantes/api/lancamento/progresso/${batchId}`);
                const data = await resp.json();

                if (data.status === 'processando') {
                    const processados = data.processados || 0;
                    const total = data.total || 0;
                    const pct = total > 0 ? Math.round((processados / total) * 100) : 0;

                    document.getElementById('lancamento-progresso-barra').style.width = pct + '%';
                    document.getElementById('lancamento-progresso-texto').textContent = 'Lançando pagamentos...';
                    document.getElementById('lancamento-progresso-contagem').textContent = `${processados}/${total} (${pct}%)`;

                    const sucesso = data.sucesso || 0;
                    const erros = data.erros || 0;
                    const ultimoPayment = data.ultimo_payment || '';
                    document.getElementById('lancamento-progresso-detalhe').textContent =
                        `${sucesso} lançados, ${erros} erros` +
                        (ultimoPayment ? ` | Payment: ${ultimoPayment}` : '');

                    document.getElementById('lancamento-stat-total').textContent = total;
                    document.getElementById('lancamento-stat-sucesso').textContent = sucesso;
                    document.getElementById('lancamento-stat-erros').textContent = erros;
                    resultado.style.display = 'block';

                } else if (data.status === 'concluido') {
                    clearInterval(lancamentoPollingInterval);
                    lancamentoPollingInterval = null;

                    const stats = data.estatisticas || {};
                    document.getElementById('lancamento-stat-total').textContent = stats.total || 0;
                    document.getElementById('lancamento-stat-sucesso').textContent = stats.sucesso || 0;
                    document.getElementById('lancamento-stat-erros').textContent = stats.erros || 0;
                    resultado.style.display = 'block';

                    document.getElementById('lancamento-progresso-barra').style.width = '100%';
                    document.getElementById('lancamento-progresso-barra').classList.remove('progress-bar-animated');
                    document.getElementById('lancamento-progresso-texto').textContent = 'Lançamentos concluídos!';
                    document.getElementById('lancamento-progresso-contagem').textContent = '';
                    document.getElementById('lancamento-progresso-detalhe').textContent = '';

                    setTimeout(() => {
                        finalizarLancamentoUI(btnLanc, progresso);
                        recarregarTabela();
                    }, 2000);

                } else if (data.status === 'erro') {
                    clearInterval(lancamentoPollingInterval);
                    lancamentoPollingInterval = null;

                    document.getElementById('lancamento-progresso-texto').textContent = 'Erro no processamento';
                    document.getElementById('lancamento-progresso-barra').classList.add('bg-danger');
                    document.getElementById('lancamento-progresso-barra').classList.remove('bg-primary');
                    document.getElementById('lancamento-progresso-detalhe').textContent = data.ultimo_payment || '';

                    setTimeout(() => {
                        finalizarLancamentoUI(btnLanc, progresso);
                        recarregarTabela();
                    }, 3000);

                } else if (data.status === 'nao_encontrado') {
                    document.getElementById('lancamento-progresso-texto').textContent = 'Aguardando worker...';
                }

            } catch (err) {
                console.warn('Erro no polling de progresso lançamento:', err);
            }
        }, 2000);
    }

    function finalizarLancamentoUI(btnLanc, progresso) {
        btnLanc.disabled = false;
        btnLanc.innerHTML = '<i class="fas fa-paper-plane"></i> Lançar Todos Confirmados';
        progresso.style.display = 'none';

        const barra = document.getElementById('lancamento-progresso-barra');
        barra.style.width = '0%';
        barra.classList.add('progress-bar-animated');
        barra.classList.remove('bg-danger');
        barra.classList.add('bg-primary');
    }
});
</script>
{% endblock %}
