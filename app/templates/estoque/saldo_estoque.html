{% extends "base.html" %}

{% block title %}Saldo de Estoque - Proje√ß√£o 29 Dias{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">
                                <i class="fas fa-chart-line"></i>
                                M√≥dulo 4 - Saldo de Estoque
                            </h4>
                            <small>Proje√ß√£o de estoque para 29 dias (D0 at√© D+28) com unifica√ß√£o de c√≥digos</small>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-light" onclick="filtrarProdutos()">
                                <i class="fas fa-filter"></i> Filtros
                            </button>
                            <button type="button" class="btn btn-outline-light" onclick="recarregarDados()">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Estat√≠sticas -->
                <div class="card-body pb-0">
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5 class="mb-0">{{ estatisticas.total_produtos }}</h5>
                                    <small>Total Produtos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 class="mb-0">{{ estatisticas.produtos_ok }}</h5>
                                    <small>Status OK</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h5 class="mb-0">{{ estatisticas.produtos_atencao }}</h5>
                                    <small>Aten√ß√£o</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h5 class="mb-0">{{ estatisticas.produtos_criticos }}</h5>
                                    <small>Cr√≠ticos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-secondary text-white">
                                <div class="card-body text-center">
                                    <h5 class="mb-0">{{ estatisticas.produtos_exibidos }}</h5>
                                    <small>Exibidos</small>
                                </div>
                            </div>
                        </div>
                        {% if limite_exibicao %}
                        <div class="col-md-2">
                            <div class="alert alert-warning mb-0 small text-center">
                                <i class="fas fa-info-circle"></i><br>
                                Limitado a 50 produtos para performance
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Tabela Principal -->
                <div class="card-body">
                    {% if produtos %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabelaEstoque">
                            <thead class="table-dark">
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Produto</th>
                                    <th>Est. Inicial (D0)</th>
                                    <th>Carteira</th>
                                    <th>Ruptura 7d</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for produto in produtos %}
                                <tr data-codigo="{{ produto.cod_produto }}">
                                    <td>
                                        <strong>{{ produto.cod_produto }}</strong>
                                    </td>
                                    <td>{{ produto.nome_produto }}</td>
                                    <td class="text-end">
                                        <span class="badge {% if produto.estoque_inicial <= 0 %}bg-danger{% elif produto.estoque_inicial < 10 %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ "%.0f"|format(produto.estoque_inicial) }}
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        {% if produto.qtd_total_carteira > 0 %}
                                            <span class="text-primary">{{ "%.1f"|format(produto.qtd_total_carteira) }}</span>
                                        {% else %}
                                            <span class="text-muted">Em breve</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <span class="badge {% if produto.previsao_ruptura <= 0 %}bg-danger{% elif produto.previsao_ruptura < 10 %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ "%.0f"|format(produto.previsao_ruptura) }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if produto.status_ruptura == 'CR√çTICO' %}
                                            <span class="badge bg-danger">üî¥ CR√çTICO</span>
                                        {% elif produto.status_ruptura == 'ATEN√á√ÉO' %}
                                            <span class="badge bg-warning text-dark">üü° ATEN√á√ÉO</span>
                                        {% else %}
                                            <span class="badge bg-success">üü¢ OK</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" 
                                                    class="btn btn-outline-info" 
                                                    onclick="verProjecaoCompleta('{{ produto.cod_produto }}')"
                                                    title="Ver proje√ß√£o 29 dias">
                                                <i class="fas fa-chart-line"></i>
                                            </button>
                                            {% if current_user.nivel == 'admin' %}
                                            <button type="button" 
                                                    class="btn btn-outline-warning" 
                                                    onclick="abrirModalAjuste('{{ produto.cod_produto }}', '{{ produto.nome_produto }}')"
                                                    title="Ajustar estoque">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhum produto com movimenta√ß√£o de estoque encontrado</h5>
                        <p class="text-muted">
                            Importe dados no m√≥dulo de 
                            <a href="{{ url_for('estoque.listar_movimentacoes') }}">Movimenta√ß√µes de Estoque</a>
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Proje√ß√£o Completa -->
<div class="modal fade" id="modalProjecao" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line"></i>
                    Proje√ß√£o Completa - 29 Dias
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="loadingProjecao" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Carregando proje√ß√£o...</p>
                </div>
                <div id="conteudoProjecao" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Ajuste de Estoque -->
{% if current_user.nivel == 'admin' %}
<div class="modal fade" id="modalAjuste" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i>
                    Ajustar Estoque
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formAjuste">
                <div class="modal-body">
                    <input type="hidden" id="ajusteCodProduto">
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Produto:</strong></label>
                        <div id="ajusteNomeProduto" class="form-control-plaintext"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ajusteQuantidade" class="form-label">
                            <i class="fas fa-balance-scale"></i>
                            Quantidade de Ajuste:
                        </label>
                        <input type="number" 
                               class="form-control" 
                               id="ajusteQuantidade" 
                               step="0.001" 
                               placeholder="Ex: 10 (entrada) ou -5 (sa√≠da)"
                               required>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i>
                            Use valores positivos para entrada e negativos para sa√≠da
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ajusteMotivo" class="form-label">
                            <i class="fas fa-comment"></i>
                            Motivo do Ajuste:
                        </label>
                        <textarea class="form-control" 
                                  id="ajusteMotivo" 
                                  rows="3"
                                  placeholder="Descreva o motivo do ajuste..."
                                  required></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Aten√ß√£o:</strong> Este ajuste gerar√° automaticamente uma movimenta√ß√£o de estoque do tipo "AJUSTE".
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i>
                        Processar Ajuste
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal de Filtros -->
<div class="modal fade" id="modalFiltros" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-filter"></i>
                    Filtros Avan√ßados
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formFiltros">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="filtroCodigo" class="form-label">C√≥digo do Produto:</label>
                        <input type="text" class="form-control" id="filtroCodigo" placeholder="Digite o c√≥digo...">
                    </div>
                    
                    <div class="mb-3">
                        <label for="filtroStatus" class="form-label">Status de Ruptura:</label>
                        <select class="form-select" id="filtroStatus">
                            <option value="">Todos os status</option>
                            <option value="OK">üü¢ OK</option>
                            <option value="ATEN√á√ÉO">üü° Aten√ß√£o</option>
                            <option value="CR√çTICO">üî¥ Cr√≠tico</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="filtroLimite" class="form-label">Limite de Produtos:</label>
                        <select class="form-select" id="filtroLimite">
                            <option value="50">50 produtos</option>
                            <option value="100">100 produtos</option>
                            <option value="200">200 produtos</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-outline-warning" onclick="limparFiltros()">Limpar</button>
                    <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Fun√ß√µes JavaScript para interatividade
function verProjecaoCompleta(codProduto) {
    $('#modalProjecao').modal('show');
    $('#loadingProjecao').show();
    $('#conteudoProjecao').hide();
    
    fetch(`/estoque/saldo-estoque/api/produto/${codProduto}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                gerarTabelaProjecao(data.produto);
            } else {
                $('#conteudoProjecao').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Erro ao carregar proje√ß√£o: ${data.error}
                    </div>
                `);
            }
            $('#loadingProjecao').hide();
            $('#conteudoProjecao').show();
        })
        .catch(error => {
            $('#conteudoProjecao').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro de conex√£o: ${error.message}
                </div>
            `);
            $('#loadingProjecao').hide();
            $('#conteudoProjecao').show();
        });
}

function gerarTabelaProjecao(produto) {
    let html = `
        <div class="mb-3">
            <h6><strong>Produto:</strong> ${produto.cod_produto} - ${produto.nome_produto}</h6>
            <div class="row">
                <div class="col-md-4">
                    <span class="badge bg-info">Estoque Inicial: ${produto.estoque_inicial.toFixed(1)}</span>
                </div>
                <div class="col-md-4">
                    <span class="badge bg-warning text-dark">Ruptura 7d: ${produto.previsao_ruptura.toFixed(1)}</span>
                </div>
                <div class="col-md-4">
                    <span class="badge ${produto.status_ruptura === 'CR√çTICO' ? 'bg-danger' : produto.status_ruptura === 'ATEN√á√ÉO' ? 'bg-warning text-dark' : 'bg-success'}">
                        ${produto.status_ruptura}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Dia</th>
                        <th>Data</th>
                        <th>Est. Inicial</th>
                        <th>Sa√≠da Prev.</th>
                        <th>Produ√ß√£o</th>
                        <th>Est. Final</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    produto.projecao_29_dias.forEach(dia => {
        const corEstoque = dia.estoque_final <= 0 ? 'text-danger fw-bold' : 
                          dia.estoque_final < 10 ? 'text-warning fw-bold' : 'text-success';
        
        html += `
            <tr>
                <td>D${dia.dia === 0 ? '0' : '+' + dia.dia}</td>
                <td>${dia.data_formatada}</td>
                <td class="text-end">${dia.estoque_inicial.toFixed(1)}</td>
                <td class="text-end">${dia.saida_prevista > 0 ? dia.saida_prevista.toFixed(1) : '-'}</td>
                <td class="text-end">${dia.producao_programada > 0 ? dia.producao_programada.toFixed(1) : '-'}</td>
                <td class="text-end ${corEstoque}">${dia.estoque_final.toFixed(1)}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle"></i>
            <strong>Observa√ß√µes:</strong>
            <ul class="mb-0 mt-2">
                <li>Sa√≠da prevista ser√° calculada quando implementar a carteira de pedidos</li>
                <li>Produ√ß√£o baseada na programa√ß√£o j√° cadastrada</li>
                <li>C√≥digos unificados s√£o considerados automaticamente</li>
            </ul>
        </div>
    `;
    
    $('#conteudoProjecao').html(html);
}

function abrirModalAjuste(codProduto, nomeProduto) {
    $('#ajusteCodProduto').val(codProduto);
    $('#ajusteNomeProduto').text(`${codProduto} - ${nomeProduto}`);
    $('#ajusteQuantidade').val('');
    $('#ajusteMotivo').val('');
    $('#modalAjuste').modal('show');
}

function filtrarProdutos() {
    $('#modalFiltros').modal('show');
}

function limparFiltros() {
    $('#filtroCodigo').val('');
    $('#filtroStatus').val('');
    $('#filtroLimite').val('50');
}

function recarregarDados() {
    location.reload();
}

// Eventos
{% if current_user.nivel == 'admin' %}
$('#formAjuste').on('submit', function(e) {
    e.preventDefault();
    
    const codProduto = $('#ajusteCodProduto').val();
    const quantidade = parseFloat($('#ajusteQuantidade').val());
    const motivo = $('#ajusteMotivo').val();
    
    if (!quantidade || quantidade === 0) {
        alert('Quantidade deve ser diferente de zero!');
        return;
    }
    
    if (!motivo.trim()) {
        alert('Motivo √© obrigat√≥rio!');
        return;
    }
    
    // Confirmar ajuste
    const tipoAjuste = quantidade > 0 ? 'ENTRADA' : 'SA√çDA';
    const confirmacao = confirm(`Confirma o ajuste de ${tipoAjuste} de ${Math.abs(quantidade)} unidades?\n\nMotivo: ${motivo}`);
    
    if (!confirmacao) return;
    
    // Enviar ajuste
    fetch('/estoque/saldo-estoque/processar-ajuste', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            cod_produto: codProduto,
            qtd_ajuste: quantidade,
            motivo: motivo
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            $('#modalAjuste').modal('hide');
            recarregarDados();
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        alert('Erro de conex√£o: ' + error.message);
    });
});
{% endif %}

$('#formFiltros').on('submit', function(e) {
    e.preventDefault();
    
    const codigo = $('#filtroCodigo').val();
    const status = $('#filtroStatus').val();
    const limite = $('#filtroLimite').val();
    
    const params = new URLSearchParams();
    if (codigo) params.append('codigo_produto', codigo);
    if (status) params.append('status_ruptura', status);
    if (limite) params.append('limite', limite);
    
    fetch(`/estoque/saldo-estoque/filtrar?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Recarregar p√°gina com filtros aplicados
                const url = new URL(window.location);
                params.forEach((value, key) => url.searchParams.set(key, value));
                window.location.href = url.toString();
            } else {
                alert('Erro ao aplicar filtros: ' + data.error);
            }
        })
        .catch(error => {
            alert('Erro de conex√£o: ' + error.message);
        });
});
</script>
{% endblock %} 