{% extends "base.html" %}

{% block title %}Editar Movimenta√ß√£o{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-edit"></i> Editar Movimenta√ß√£o
                <small class="text-muted">{{ movimentacao.cod_produto }} - {{ movimentacao.tipo_movimentacao }}</small>
            </h1>
        </div>
    </div>

    <!-- Formul√°rio de Edi√ß√£o -->
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-exchange-alt"></i> Dados da Movimenta√ß√£o
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('estoque.processar_edicao_movimentacao', id=movimentacao.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <!-- Produto (C√≥digo n√£o pode ser alterado) -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-barcode"></i> C√≥digo do Produto
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       value="{{ movimentacao.cod_produto }}"
                                       readonly>
                                <div class="form-text">
                                    O c√≥digo do produto n√£o pode ser alterado
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="nome_produto" class="form-label">
                                    <i class="fas fa-tag"></i> Nome do Produto *
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="nome_produto" 
                                       name="nome_produto"
                                       value="{{ movimentacao.nome_produto }}"
                                       required>
                            </div>
                        </div>

                        <!-- Dados da Movimenta√ß√£o -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="tipo_movimentacao" class="form-label">
                                    <i class="fas fa-arrows-alt"></i> Tipo de Movimenta√ß√£o *
                                </label>
                                <select class="form-select" id="tipo_movimentacao" name="tipo_movimentacao" required>
                                    <option value="">Selecione o tipo</option>
                                    <option value="EST INICIAL" {{ 'selected' if movimentacao.tipo_movimentacao == 'EST INICIAL' }}>üì¶ EST INICIAL - Estoque Inicial</option>
                                    <option value="PRODU√á√ÉO" {{ 'selected' if movimentacao.tipo_movimentacao == 'PRODU√á√ÉO' }}>üè≠ PRODU√á√ÉO - Produ√ß√£o</option>
                                    <option value="AVARIA" {{ 'selected' if movimentacao.tipo_movimentacao == 'AVARIA' }}>‚ö†Ô∏è AVARIA - Avaria/Perda</option>
                                    <option value="DEVOLU√á√ÉO" {{ 'selected' if movimentacao.tipo_movimentacao == 'DEVOLU√á√ÉO' }}>üîÑ DEVOLU√á√ÉO - Devolu√ß√£o</option>
                                    <option value="RETRABALHO" {{ 'selected' if movimentacao.tipo_movimentacao == 'RETRABALHO' }}>üîß RETRABALHO - Retrabalho</option>
                                    <option value="AJUSTE" {{ 'selected' if movimentacao.tipo_movimentacao == 'AJUSTE' }}>‚öñÔ∏è AJUSTE - Ajuste Manual</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="data_movimentacao" class="form-label">
                                    <i class="fas fa-calendar"></i> Data da Movimenta√ß√£o *
                                </label>
                                <input type="date" 
                                       class="form-control" 
                                       id="data_movimentacao" 
                                       name="data_movimentacao"
                                       value="{{ movimentacao.data_movimentacao.strftime('%Y-%m-%d') if movimentacao.data_movimentacao else '' }}"
                                       required>
                            </div>
                            <div class="col-md-4">
                                <label for="qtd_movimentacao" class="form-label">
                                    <i class="fas fa-calculator"></i> Quantidade *
                                </label>
                                <input type="number" 
                                       class="form-control" 
                                       id="qtd_movimentacao" 
                                       name="qtd_movimentacao"
                                       step="0.001"
                                       value="{{ movimentacao.qtd_movimentacao }}"
                                       required>
                                <div class="form-text">
                                    Use valores negativos para sa√≠das
                                </div>
                            </div>
                        </div>

                        <!-- Localiza√ß√£o e Documenta√ß√£o -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="local_movimentacao" class="form-label">
                                    <i class="fas fa-map-marker-alt"></i> Local da Movimenta√ß√£o *
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="local_movimentacao" 
                                       name="local_movimentacao"
                                       value="{{ movimentacao.local_movimentacao or '' }}"
                                       required>
                            </div>
                            <div class="col-md-6">
                                <label for="documento_origem" class="form-label">
                                    <i class="fas fa-file-alt"></i> Documento de Origem
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="documento_origem" 
                                       name="documento_origem"
                                       value="{{ movimentacao.documento_origem or '' }}">
                            </div>
                        </div>

                        <!-- Observa√ß√µes -->
                        <div class="mb-3">
                            <label for="observacao" class="form-label">
                                <i class="fas fa-comment"></i> Observa√ß√µes
                            </label>
                            <textarea class="form-control" 
                                      id="observacao" 
                                      name="observacao"
                                      rows="3">{{ movimentacao.observacao or '' }}</textarea>
                        </div>

                        <!-- Informa√ß√µes de Auditoria -->
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Informa√ß√µes da Movimenta√ß√£o:</h6>
                            <ul class="mb-0">
                                <li><strong>ID:</strong> {{ movimentacao.id }}</li>
                                <li><strong>Criado por:</strong> {{ movimentacao.created_by or 'N/A' }}</li>
                                <li><strong>Criado em:</strong> {{ movimentacao.created_at | formatar_data_hora_brasil if movimentacao.created_at else 'N/A' }}</li>
                                {% if movimentacao.updated_by %}
                                <li><strong>√öltima atualiza√ß√£o:</strong> {{ movimentacao.updated_by }} em {{ movimentacao.updated_at | formatar_data_hora_brasil }}</li>
                                {% endif %}
                            </ul>
                        </div>

                        <!-- Bot√µes -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('estoque.listar_movimentacoes') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                            <div>
                                <a href="{{ url_for('estoque.visualizar_movimentacao', id=movimentacao.id) }}" class="btn btn-info me-2">
                                    <i class="fas fa-eye"></i> Visualizar
                                </a>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-save"></i> Salvar Altera√ß√µes
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Valida√ß√£o de quantidade baseada no tipo
$('#tipo_movimentacao').on('change', function() {
    const tipo = $(this).val();
    const qtdField = $('#qtd_movimentacao');
    
    if (tipo === 'AVARIA' || tipo === 'SAIDA') {
        qtdField.attr('placeholder', 'Digite valor negativo (Ex: -50)');
    } else if (tipo === 'PRODU√á√ÉO' || tipo === 'EST INICIAL') {
        qtdField.attr('placeholder', 'Digite valor positivo (Ex: 100)');
    } else {
        qtdField.attr('placeholder', 'Ex: 100 ou -50');
    }
});

// Valida√ß√£o do formul√°rio
$('form').on('submit', function(e) {
    const quantidade = parseFloat($('#qtd_movimentacao').val());
    
    if (isNaN(quantidade) || quantidade === 0) {
        e.preventDefault();
        alert('Quantidade deve ser um n√∫mero diferente de zero!');
        return;
    }
    
    // Confirma√ß√£o final
    const tipoMov = $('#tipo_movimentacao option:selected').text();
    const confirmacao = confirm(
        `Confirma as altera√ß√µes na movimenta√ß√£o?\n\n` +
        `Tipo: ${tipoMov}\n` +
        `Quantidade: ${quantidade}\n` +
        `Data: ${$('#data_movimentacao').val()}`
    );
    
    if (!confirmacao) {
        e.preventDefault();
    }
});
</script>
{% endblock %} 