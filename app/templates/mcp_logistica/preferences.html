{% extends "base.html" %}

{% block title %}MCP Logística - Preferências{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='mcp_logistica/style.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('mcp_logistica.index') }}">MCP Logística</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Preferências</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <h1 class="page-title mb-4">
                <i class="fas fa-cog"></i> Preferências do Usuário
            </h1>
        </div>
    </div>

    <form id="preferences-form" method="POST" action="{{ url_for('mcp_logistica.save_preferences') }}">
        <div class="row">
            <!-- Display Preferences -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-desktop"></i> Preferências de Exibição</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="default_output_format" class="form-label">Formato de Saída Padrão:</label>
                            <select class="form-select" id="default_output_format" name="default_output_format">
                                <option value="table" {% if preferences.default_output_format == 'table' %}selected{% endif %}>Tabela</option>
                                <option value="json" {% if preferences.default_output_format == 'json' %}selected{% endif %}>JSON</option>
                                <option value="summary" {% if preferences.default_output_format == 'summary' %}selected{% endif %}>Resumo</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="default_limit" class="form-label">Limite de Resultados Padrão:</label>
                            <input type="number" class="form-control" id="default_limit" name="default_limit" 
                                value="{{ preferences.default_limit|default(100) }}" min="1" max="1000">
                        </div>

                        <div class="mb-3">
                            <label for="items_per_page" class="form-label">Itens por Página:</label>
                            <select class="form-select" id="items_per_page" name="items_per_page">
                                <option value="10" {% if preferences.items_per_page == 10 %}selected{% endif %}>10</option>
                                <option value="25" {% if preferences.items_per_page == 25 %}selected{% endif %}>25</option>
                                <option value="50" {% if preferences.items_per_page == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if preferences.items_per_page == 100 %}selected{% endif %}>100</option>
                            </select>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="show_sql_query" name="show_sql_query" 
                                {% if preferences.show_sql_query %}checked{% endif %}>
                            <label class="form-check-label" for="show_sql_query">
                                Mostrar SQL gerado nas consultas
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="auto_refresh" name="auto_refresh" 
                                {% if preferences.auto_refresh %}checked{% endif %}>
                            <label class="form-check-label" for="auto_refresh">
                                Atualização automática de resultados
                            </label>
                        </div>

                        <div class="mb-3" id="refresh_interval_container" {% if not preferences.auto_refresh %}style="display: none;"{% endif %}>
                            <label for="refresh_interval" class="form-label">Intervalo de Atualização (segundos):</label>
                            <input type="number" class="form-control" id="refresh_interval" name="refresh_interval" 
                                value="{{ preferences.refresh_interval|default(30) }}" min="5" max="300">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Query Preferences -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-search"></i> Preferências de Consulta</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="language" class="form-label">Idioma de Consulta:</label>
                            <select class="form-select" id="language" name="language">
                                <option value="pt-br" {% if preferences.language == 'pt-br' %}selected{% endif %}>Português (Brasil)</option>
                                <option value="en" {% if preferences.language == 'en' %}selected{% endif %}>English</option>
                                <option value="es" {% if preferences.language == 'es' %}selected{% endif %}>Español</option>
                            </select>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="save_query_history" name="save_query_history" 
                                {% if preferences.save_query_history %}checked{% endif %}>
                            <label class="form-check-label" for="save_query_history">
                                Salvar histórico de consultas
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="suggest_queries" name="suggest_queries" 
                                {% if preferences.suggest_queries %}checked{% endif %}>
                            <label class="form-check-label" for="suggest_queries">
                                Sugerir consultas baseadas no histórico
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="enable_shortcuts" name="enable_shortcuts" 
                                {% if preferences.enable_shortcuts %}checked{% endif %}>
                            <label class="form-check-label" for="enable_shortcuts">
                                Habilitar atalhos de teclado
                            </label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Consultas Favoritas:</label>
                            <div id="favorite-queries-list" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                {% if preferences.favorite_queries %}
                                    {% for query in preferences.favorite_queries %}
                                    <div class="favorite-query-item d-flex justify-content-between align-items-center mb-2">
                                        <span>{{ query }}</span>
                                        <button type="button" class="btn btn-sm btn-danger remove-favorite" data-query="{{ query }}">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted mb-0">Nenhuma consulta favorita salva.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification Preferences -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-bell"></i> Notificações</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="notify_query_complete" name="notify_query_complete" 
                                {% if preferences.notify_query_complete %}checked{% endif %}>
                            <label class="form-check-label" for="notify_query_complete">
                                Notificar quando consultas longas forem concluídas
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="notify_errors" name="notify_errors" 
                                {% if preferences.notify_errors %}checked{% endif %}>
                            <label class="form-check-label" for="notify_errors">
                                Notificar sobre erros de consulta
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="notify_alerts" name="notify_alerts" 
                                {% if preferences.notify_alerts %}checked{% endif %}>
                            <label class="form-check-label" for="notify_alerts">
                                Notificar sobre alertas do sistema
                            </label>
                        </div>

                        <div class="mb-3">
                            <label for="notification_sound" class="form-label">Som de Notificação:</label>
                            <select class="form-select" id="notification_sound" name="notification_sound">
                                <option value="none" {% if preferences.notification_sound == 'none' %}selected{% endif %}>Sem som</option>
                                <option value="bell" {% if preferences.notification_sound == 'bell' %}selected{% endif %}>Sino</option>
                                <option value="chime" {% if preferences.notification_sound == 'chime' %}selected{% endif %}>Chime</option>
                                <option value="alert" {% if preferences.notification_sound == 'alert' %}selected{% endif %}>Alerta</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Preferences -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-download"></i> Preferências de Exportação</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="default_export_format" class="form-label">Formato de Exportação Padrão:</label>
                            <select class="form-select" id="default_export_format" name="default_export_format">
                                <option value="csv" {% if preferences.default_export_format == 'csv' %}selected{% endif %}>CSV</option>
                                <option value="excel" {% if preferences.default_export_format == 'excel' %}selected{% endif %}>Excel</option>
                                <option value="json" {% if preferences.default_export_format == 'json' %}selected{% endif %}>JSON</option>
                                <option value="pdf" {% if preferences.default_export_format == 'pdf' %}selected{% endif %}>PDF</option>
                            </select>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="include_headers" name="include_headers" 
                                {% if preferences.include_headers %}checked{% endif %}>
                            <label class="form-check-label" for="include_headers">
                                Incluir cabeçalhos na exportação
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="include_metadata" name="include_metadata" 
                                {% if preferences.include_metadata %}checked{% endif %}>
                            <label class="form-check-label" for="include_metadata">
                                Incluir metadados (data, query, etc.)
                            </label>
                        </div>

                        <div class="mb-3">
                            <label for="csv_delimiter" class="form-label">Delimitador CSV:</label>
                            <select class="form-select" id="csv_delimiter" name="csv_delimiter">
                                <option value="," {% if preferences.csv_delimiter == ',' %}selected{% endif %}>Vírgula (,)</option>
                                <option value=";" {% if preferences.csv_delimiter == ';' %}selected{% endif %}>Ponto e vírgula (;)</option>
                                <option value="\t" {% if preferences.csv_delimiter == '\t' %}selected{% endif %}>Tab</option>
                                <option value="|" {% if preferences.csv_delimiter == '|' %}selected{% endif %}>Pipe (|)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Buttons -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <button type="submit" class="btn btn-primary" id="save-preferences">
                            <i class="fas fa-save"></i> Salvar Preferências
                        </button>
                        <button type="button" class="btn btn-secondary" id="reset-preferences">
                            <i class="fas fa-undo"></i> Restaurar Padrões
                        </button>
                        <a href="{{ url_for('mcp_logistica.index') }}" class="btn btn-light">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Success/Error Messages -->
{% if message %}
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-{{ message.type }} text-white">
            <strong class="me-auto">{{ message.title }}</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            {{ message.text }}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='mcp_logistica/preferences.js') }}"></script>
{% endblock %}