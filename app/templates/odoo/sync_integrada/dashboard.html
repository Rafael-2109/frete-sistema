{% extends "base.html" %}

{% block title %}Sincroniza√ß√£o Integrada Segura{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-shield-alt"></i> Sincroniza√ß√£o Integrada Segura
                        <span class="badge bg-light text-success ml-2">SEQU√äNCIA AUTOM√ÅTICA</span>
                    </h4>
                </div>
                <div class="card-body">

                    <!-- ‚úÖ EXPLICA√á√ÉO DA SEQU√äNCIA SEGURA -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-success">
                                <h5 class="alert-heading">
                                    <i class="fas fa-check-circle"></i> Sequ√™ncia Autom√°tica Segura
                                </h5>
                                <p class="mb-2">
                                    Este bot√£o executa automaticamente a sincroniza√ß√£o na <strong>sequ√™ncia
                                        CORRETA</strong>
                                    para eliminar qualquer risco de perda de dados:
                                </p>
                                <ol class="mb-2">
                                    <li><strong>1¬∫ FATURAMENTO</strong> - Preserva todas as NFs no sistema</li>
                                    <li><strong>2¬∫ CARTEIRA</strong> - Atualiza pedidos sem risco de perda</li>
                                </ol>
                                <hr>
                                <p class="mb-0">
                                    <i class="fas fa-shield-alt text-success"></i>
                                    <strong>Prote√ß√£o Total:</strong> Elimina o risco humano de executar na ordem errada
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- üìä STATUS ATUAL DO SISTEMA -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div
                                class="card border-{{ 'success' if status.nivel_risco == 'BAIXO' else ('warning' if status.nivel_risco == 'M√âDIO' else 'danger') }}">
                                <div
                                    class="card-header bg-{{ 'success' if status.nivel_risco == 'BAIXO' else ('warning' if status.nivel_risco == 'M√âDIO' else 'danger') }} text-white">
                                    <h6 class="mb-0"><i class="fas fa-chart-line"></i> Status do Sistema</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <strong>N√≠vel de Risco:</strong>
                                        <span
                                            class="badge bg-{{ 'success' if status.nivel_risco == 'BAIXO' else ('warning' if status.nivel_risco == 'M√âDIO' else 'danger') }}">
                                            {{ status.nivel_risco }}
                                        </span>
                                    </div>

                                    {% if status.ultima_sync_faturamento %}
                                    <div class="mb-2">
                                        <small class="text-muted">√öltimo Faturamento:</small><br>
                                        <strong>{{ status.ultima_sync_faturamento }}</strong>
                                    </div>
                                    {% endif %}

                                    {% if status.ultima_sync_carteira %}
                                    <div class="mb-2">
                                        <small class="text-muted">√öltima Carteira:</small><br>
                                        <strong>{{ status.ultima_sync_carteira }}</strong>
                                    </div>
                                    {% endif %}

                                    <div class="mt-3">
                                        <small class="text-muted">Recomenda√ß√£o:</small><br>
                                        <strong>{{ status.recomendacao }}</strong>
                                    </div>

                                    {% if status.alertas %}
                                    <div class="mt-3">
                                        <small class="text-muted">Alertas:</small>
                                        {% for alerta in status.alertas %}
                                        <div class="alert alert-warning alert-sm mt-1 mb-1">
                                            <small>{{ alerta }}</small>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <!-- üîß CIRCUIT BREAKER DO ODOO -->
                            <div class="card border-info mb-3" id="circuit-breaker-card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-shield-alt"></i> Circuit Breaker Odoo
                                        <span class="badge bg-light text-info ml-2" id="cb-state-badge">...</span>
                                    </h6>
                                </div>
                                <div class="card-body" id="cb-card-body">
                                    <div class="text-center">
                                        <div class="spinner-border spinner-border-sm text-info" role="status">
                                            <span class="sr-only">Carregando...</span>
                                        </div>
                                        <p class="mb-0 mt-2"><small>Carregando status...</small></p>
                                    </div>
                                </div>
                            </div>

                            <!-- üîÑ BOT√ÉO PRINCIPAL DE SINCRONIZA√á√ÉO -->
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-sync"></i> Sincroniza√ß√£o Segura</h6>
                                </div>
                                <div class="card-body text-center">
                                    {% if status.pode_sincronizar %}

                                    <form method="POST"
                                        action="{{ url_for('sync_integrada.executar_sincronizacao_segura') }}"
                                        onsubmit="return confirmarSincronizacaoSegura()">

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="usar_filtro_carteira"
                                                id="filtro_carteira" checked>
                                            <label class="form-check-label" for="filtro_carteira">
                                                <strong>Filtrar Carteira Pendente</strong>
                                                <small class="text-muted d-block">
                                                    Sincronizar apenas pedidos n√£o entregues
                                                </small>
                                            </label>
                                        </div>

                                        <button type="submit" class="btn btn-success btn-lg" id="btn-sync-seguro">
                                            <i class="fas fa-shield-alt"></i>
                                            <strong>SINCRONIZAR TUDO (SEGURO)</strong>
                                            <small class="d-block mt-1">üîÑ Faturamento ‚Üí Carteira</small>
                                        </button>

                                    </form>

                                    <hr>

                                    <!-- ‚úÖ VANTAGENS DA SINCRONIZA√á√ÉO SEGURA -->
                                    <div class="text-left">
                                        <small class="text-muted">
                                            <strong>Vantagens desta opera√ß√£o:</strong><br>
                                            ‚úÖ Sequ√™ncia autom√°tica correta<br>
                                            ‚úÖ Zero risco de perda de NFs<br>
                                            ‚úÖ Prote√ß√£o total das separa√ß√µes<br>
                                            ‚úÖ Recomposi√ß√£o autom√°tica<br>
                                            ‚úÖ Um clique apenas
                                        </small>
                                    </div>

                                    {% else %}

                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>Sincroniza√ß√£o Bloqueada</strong>
                                        <p class="mb-1">{{ status.get('erro', 'Sistema n√£o permite sincroniza√ß√£o no
                                            momento') }}</p>
                                    </div>

                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üîÑ BOT√ïES DE A√á√ÉO -->
                    <div class="row mb-4">
                        <div class="col-12 text-center">
                            <a href="{{ url_for('sync_integrada.listar_pedidos_para_sincronizar') }}" class="btn btn-primary btn-lg mr-3">
                                <i class="fas fa-sync-alt"></i>
                                <strong>SINCRONIZAR PEDIDO</strong>
                                <small class="d-block mt-1">Sincronizar pedidos individuais</small>
                            </a>
                            <a href="{{ url_for('sync_integrada.fallback_dashboard') }}" class="btn btn-warning btn-lg">
                                <i class="fas fa-download"></i>
                                <strong>IMPORTAR DO ODOO</strong>
                                <small class="d-block mt-1">2o Fallback - Importar pedidos/NFs</small>
                            </a>
                        </div>
                    </div>

                    <!-- üéØ COMPARA√á√ÉO: ANTES vs AGORA -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-balance-scale"></i> Compara√ß√£o: Processo Anterior
                                        vs Processo Seguro</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-danger">‚ùå Processo Anterior (Risco)</h6>
                                            <div class="bg-light p-3 rounded">
                                                <ol>
                                                    <li>üîÑ Sincronizar Carteira primeiro</li>
                                                    <li>üìä Sincronizar Faturamento depois</li>
                                                    <li>üö® <strong>RISCO:</strong> Pedidos faturados perdidos</li>
                                                    <li>‚ö†Ô∏è Separa√ß√µes cotadas perdem NFs</li>
                                                    <li>üò∞ Dependia de lembrar da ordem</li>
                                                </ol>
                                                <div class="alert alert-danger alert-sm">
                                                    <strong>Problema:</strong> Risco humano de executar na ordem errada
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-success">‚úÖ Processo Seguro (Autom√°tico)</h6>
                                            <div class="bg-light p-3 rounded">
                                                <ol>
                                                    <li>üìä Sincronizar Faturamento PRIMEIRO</li>
                                                    <li>üîç Validar integridade</li>
                                                    <li>üîÑ Sincronizar Carteira DEPOIS</li>
                                                    <li>‚úÖ <strong>PROTE√á√ÉO:</strong> NFs preservadas</li>
                                                    <li>üéØ Sequ√™ncia autom√°tica sempre</li>
                                                </ol>
                                                <div class="alert alert-success alert-sm">
                                                    <strong>Vantagem:</strong> Elimina completamente o risco humano
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- üöÄ SISTEMA DE CONFIRMA√á√ÉO E FEEDBACK -->
<script>
    function confirmarSincronizacaoSegura() {
        const confirmMsg = `üîÑ SINCRONIZA√á√ÉO INTEGRADA SEGURA

‚úÖ SEQU√äNCIA AUTOM√ÅTICA:
1. üìä FATURAMENTO sincronizado primeiro
2. üîç Valida√ß√£o de integridade executada
3. üîÑ CARTEIRA sincronizada depois
4. üõ°Ô∏è Prote√ß√£o autom√°tica de pr√©-separa√ß√µes

üéØ VANTAGENS:
‚úÖ Zero risco de perda de NFs
‚úÖ Sequ√™ncia correta garantida
‚úÖ Processo completamente autom√°tico
‚úÖ Elimina erro humano

Esta √© a forma MAIS SEGURA de sincronizar.

Executar sincroniza√ß√£o integrada segura?`;

        return confirm(confirmMsg);
    }

    function confirmarSincPedido(numPedido) {
        const confirmMsg = `üîÑ SINCRONIZAR PEDIDO: ${numPedido}

üìã O QUE VAI ACONTECER:

‚úÖ SE ENCONTRADO NO ODOO:
   ‚Ä¢ Atualiza quantidades e dados
   ‚Ä¢ Mant√©m separa√ß√µes existentes
   ‚Ä¢ Aplica altera√ß√µes conforme Odoo

‚ùå SE N√ÉO ENCONTRADO NO ODOO:
   ‚Ä¢ Exclui pedido completamente
   ‚Ä¢ Remove TODAS as Separacao (sincronizado_nf=False)
   ‚Ä¢ Cancela EmbarqueItems relacionados

‚ö†Ô∏è Esta a√ß√£o √© IRREVERS√çVEL se o pedido for exclu√≠do.

Deseja continuar?`;

        return confirm(confirmMsg);
    }

    // Feedback visual durante opera√ß√£o
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        const btnSync = document.getElementById('btn-sync-seguro');

        if (form && btnSync) {
            form.addEventListener('submit', function (e) {
                // Alterar bot√£o para mostrar progresso
                btnSync.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <strong>SINCRONIZANDO...</strong>
                <small class="d-block mt-1">‚è≥ Executando sequ√™ncia segura...</small>
            `;
                btnSync.disabled = true;
                btnSync.className = 'btn btn-warning btn-lg';

                // Timeout de seguran√ßa
                setTimeout(function () {
                    if (btnSync.disabled) {
                        btnSync.innerHTML = `
                        <i class="fas fa-shield-alt"></i>
                        <strong>SINCRONIZAR TUDO (SEGURO)</strong>
                        <small class="d-block mt-1">üîÑ Faturamento ‚Üí Carteira</small>
                    `;
                        btnSync.disabled = false;
                        btnSync.className = 'btn btn-success btn-lg';
                    }
                }, 60000); // 60 segundos
            });
        }

        // üîß Circuit Breaker - Carregar status
        loadCircuitBreakerStatus();
        setInterval(loadCircuitBreakerStatus, 10000); // Atualiza a cada 10s
    });

    // üîß Fun√ß√µes do Circuit Breaker
    async function loadCircuitBreakerStatus() {
        try {
            const response = await fetch('/admin/circuit-breaker/status');

            if (!response.ok) {
                if (response.status === 401) {
                    renderCircuitBreakerError('Fa√ßa login para ver o status');
                    return;
                } else if (response.status === 403) {
                    renderCircuitBreakerError('Sem permiss√£o para ver status');
                    return;
                }
                renderCircuitBreakerError(`Erro ${response.status}: ${response.statusText}`);
                return;
            }

            const data = await response.json();

            if (data.success) {
                renderCircuitBreakerStatus(data.circuit_breaker);
            } else {
                renderCircuitBreakerError(data.error || 'Erro ao carregar status');
            }
        } catch (error) {
            console.error('Erro ao carregar Circuit Breaker:', error);
            renderCircuitBreakerError(`Erro de conex√£o: ${error.message}`);
        }
    }

    function renderCircuitBreakerStatus(status) {
        const badge = document.getElementById('cb-state-badge');
        const cardBody = document.getElementById('cb-card-body');
        const card = document.getElementById('circuit-breaker-card');

        // Estados e cores
        const stateConfig = {
            'CLOSED': {
                icon: 'üü¢',
                text: 'NORMAL',
                color: 'success',
                description: 'Odoo funcionando normalmente'
            },
            'OPEN': {
                icon: 'üî¥',
                text: 'BLOQUEADO',
                color: 'danger',
                description: 'Odoo indispon√≠vel - Sistema protegido'
            },
            'HALF_OPEN': {
                icon: 'üü°',
                text: 'TESTANDO',
                color: 'warning',
                description: 'Verificando se Odoo voltou'
            }
        };

        const config = stateConfig[status.state] || stateConfig['CLOSED'];

        // Atualizar badge
        badge.className = `badge bg-light text-${config.color} ml-2`;
        badge.textContent = `${config.icon} ${config.text}`;

        // Atualizar borda do card
        card.className = `card border-${config.color} mb-3`;

        // Renderizar conte√∫do
        let html = `
            <div class="mb-2">
                <strong>${config.description}</strong>
            </div>

            <div class="row text-center mb-3">
                <div class="col-4">
                    <small class="text-muted">Chamadas</small>
                    <div class="h5 mb-0">${status.total_calls}</div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Sucessos</small>
                    <div class="h5 mb-0 text-success">${status.total_successes}</div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Falhas</small>
                    <div class="h5 mb-0 text-danger">${status.total_failures}</div>
                </div>
            </div>
        `;

        // Informa√ß√µes espec√≠ficas por estado
        if (status.state === 'OPEN' && status.time_until_retry !== null) {
            html += `
                <div class="alert alert-warning alert-sm mb-2">
                    <small>
                        <i class="fas fa-clock"></i>
                        Pr√≥xima tentativa em <strong>${Math.ceil(status.time_until_retry)}s</strong>
                    </small>
                </div>
            `;
        }

        if (status.state === 'CLOSED' && status.failure_count > 0) {
            html += `
                <div class="alert alert-info alert-sm mb-2">
                    <small>
                        <i class="fas fa-info-circle"></i>
                        Falhas consecutivas: <strong>${status.failure_count}/${status.failure_threshold}</strong>
                    </small>
                </div>
            `;
        }

        // Bot√£o de reset (apenas para admins e se circuit estiver aberto ou com falhas)
        {% if current_user.perfil == 'administrador' %}
        if (status.state === 'OPEN' || status.failure_count > 0) {
            html += `
                <button onclick="resetCircuitBreaker()" class="btn btn-sm btn-outline-primary btn-block">
                    <i class="fas fa-redo"></i> Resetar Circuit Breaker
                </button>
            `;
        }
        {% endif %}

        // Link para dashboard detalhado
        html += `
            <div class="mt-2 text-center">
                <a href="/admin/circuit-breaker/dashboard" target="_blank" class="btn btn-sm btn-link">
                    <i class="fas fa-chart-line"></i> Ver Dashboard Completo
                </a>
            </div>
        `;

        cardBody.innerHTML = html;
    }

    function renderCircuitBreakerError(message) {
        const cardBody = document.getElementById('cb-card-body');
        cardBody.innerHTML = `
            <div class="alert alert-warning alert-sm mb-0">
                <small><i class="fas fa-exclamation-triangle"></i> ${message}</small>
            </div>
        `;
    }

    async function resetCircuitBreaker() {
        if (!confirm('üîÑ RESETAR CIRCUIT BREAKER\n\nIsso for√ßar√° novas tentativas de conex√£o com o Odoo.\n\nApenas fa√ßa isso se souber que o Odoo voltou.\n\nContinuar?')) {
            return;
        }

        try {
            const response = await fetch('/admin/circuit-breaker/reset', {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                alert('‚úÖ Circuit Breaker resetado com sucesso!\n\nO sistema tentar√° conectar ao Odoo novamente.');
                loadCircuitBreakerStatus();
            } else {
                alert('‚ùå Erro ao resetar: ' + data.error);
            }
        } catch (error) {
            alert('‚ùå Erro na requisi√ß√£o: ' + error.message);
        }
    }
</script>

{% endblock %}