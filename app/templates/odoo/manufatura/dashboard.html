{% extends "base.html" %}

{% block title %}Integração Manufatura/Odoo - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-3">
                <i class="fas fa-sync-alt me-2"></i>
                Integração Manufatura/Odoo
            </h1>
        </div>
    </div>

    <!-- Cards de Estatísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        Total Sincronizações
                    </div>
                    <div class="h5 mb-0 font-weight-bold">{{ stats.total_sincronizacoes }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                        Sucesso
                    </div>
                    <div class="h5 mb-0 font-weight-bold">{{ stats.sucesso }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                        Erros
                    </div>
                    <div class="h5 mb-0 font-weight-bold">{{ stats.erro }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                        Registros Processados
                    </div>
                    <div class="h5 mb-0 font-weight-bold">{{ stats.registros_processados }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações de Sincronização -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-cogs me-2"></i>
                Ações de Sincronização
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Requisições de Compras -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-file-invoice fa-3x text-primary mb-3"></i>
                            <h5 class="card-title">Requisições de Compras</h5>
                            <p class="card-text small">Importar requisições do Odoo</p>
                            <button class="btn btn-primary btn-sm" onclick="sincronizar('requisicoes')">
                                <i class="fas fa-download"></i> Importar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pedidos de Compras -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-shopping-cart fa-3x text-success mb-3"></i>
                            <h5 class="card-title">Pedidos de Compras</h5>
                            <p class="card-text small">Importar pedidos confirmados</p>
                            <button class="btn btn-success btn-sm" onclick="sincronizar('pedidos')">
                                <i class="fas fa-download"></i> Importar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ordens de Produção -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-industry fa-3x text-warning mb-3"></i>
                            <h5 class="card-title">Ordens de Produção</h5>
                            <p class="card-text small">Sincronizar com Odoo</p>
                            <button class="btn btn-warning btn-sm" onclick="sincronizar('producao')">
                                <i class="fas fa-sync"></i> Sincronizar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ordens MTO -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-magic fa-3x text-info mb-3"></i>
                            <h5 class="card-title">Ordens MTO</h5>
                            <p class="card-text small">Gerar automaticamente</p>
                            <button class="btn btn-info btn-sm" onclick="sincronizar('ordens-mto')">
                                <i class="fas fa-plus"></i> Gerar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sincronização Completa -->
            <div class="row mt-4">
                <div class="col-12 text-center">
                    <hr>
                    <button class="btn btn-lg btn-primary" onclick="sincronizacaoCompleta()">
                        <i class="fas fa-sync-alt"></i> Sincronização Completa
                    </button>
                    <p class="text-muted mt-2">
                        <small>Executa todas as sincronizações na sequência correta</small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Histórico de Sincronizações -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-history me-2"></i>
                Histórico de Sincronizações
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>Registros</th>
                            <th>Erros</th>
                            <th>Tempo</th>
                            <th>Mensagem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr>
                            <td>{{ log.data_execucao.strftime('%d/%m/%Y %H:%M') if log.data_execucao else '-' }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ log.tipo_integracao }}</span>
                            </td>
                            <td>
                                {% if log.status == 'sucesso' %}
                                <span class="badge bg-success">Sucesso</span>
                                {% else %}
                                <span class="badge bg-danger">Erro</span>
                                {% endif %}
                            </td>
                            <td>{{ log.registros_processados or 0 }}</td>
                            <td>{{ log.registros_erro or 0 }}</td>
                            <td>{{ log.tempo_execucao|round(1) if log.tempo_execucao else '-' }}s</td>
                            <td>{{ log.mensagem[:100] if log.mensagem else '-' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center">Nenhum log encontrado</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Progresso -->
<div class="modal fade" id="modalProgresso" tabindex="-1" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sincronizando...</h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="sr-only">Carregando...</span>
                </div>
                <p id="mensagemProgresso">Processando...</p>
            </div>
        </div>
    </div>
</div>

<script>
    function sincronizar(tipo) {
        var url = '';
        var mensagem = '';

        switch (tipo) {
            case 'requisicoes':
                url = '{{ url_for("manufatura_odoo.importar_requisicoes") }}';
                mensagem = 'Importando requisições de compras...';
                break;
            case 'pedidos':
                url = '{{ url_for("manufatura_odoo.importar_pedidos") }}';
                mensagem = 'Importando pedidos de compras...';
                break;
            case 'producao':
                url = '{{ url_for("manufatura_odoo.sincronizar_producao") }}';
                mensagem = 'Sincronizando ordens de produção...';
                break;
            case 'ordens-mto':
                url = '{{ url_for("manufatura_odoo.gerar_ordens_mto") }}';
                mensagem = 'Gerando ordens MTO...';
                break;
        }

        $('#mensagemProgresso').text(mensagem);
        $('#modalProgresso').modal('show');

        $.post(url)
            .done(function (response) {
                $('#modalProgresso').modal('hide');

                if (response.sucesso) {
                    alert('✅ Sincronização concluída com sucesso!');
                } else {
                    alert('❌ Erro na sincronização: ' + (response.erro || 'Erro desconhecido'));
                }

                // Recarregar a página para atualizar logs
                location.reload();
            })
            .fail(function (xhr) {
                $('#modalProgresso').modal('hide');
                alert('❌ Erro na requisição: ' + xhr.responseText);
            });
    }

    function sincronizacaoCompleta() {
        if (!confirm('Executar sincronização completa?\n\nIsso pode levar alguns minutos.')) {
            return;
        }

        $('#mensagemProgresso').text('Executando sincronização completa...');
        $('#modalProgresso').modal('show');

        $.post('{{ url_for("manufatura_odoo.sincronizacao_completa") }}')
            .done(function (response) {
                $('#modalProgresso').modal('hide');

                var mensagem = '';
                if (response.sucesso) {
                    mensagem = '✅ Sincronização completa executada com sucesso!\n\n';
                } else {
                    mensagem = '⚠️ Sincronização parcial - algumas etapas falharam\n\n';
                }

                // Mostrar detalhes das etapas
                if (response.etapas) {
                    response.etapas.forEach(function (etapa) {
                        if (etapa.sucesso) {
                            mensagem += '✅ ' + etapa.etapa + ': ' + (etapa.registros || 0) + ' registros\n';
                        } else {
                            mensagem += '❌ ' + etapa.etapa + ': ' + (etapa.erro || 'Erro') + '\n';
                        }
                    });
                }

                mensagem += '\nTempo total: ' + (response.tempo_total || 0).toFixed(1) + 's';

                alert(mensagem);
                location.reload();
            })
            .fail(function (xhr) {
                $('#modalProgresso').modal('hide');
                alert('❌ Erro crítico na sincronização: ' + xhr.responseText);
            });
    }

    // Atualizar página a cada 30 segundos
    setTimeout(function () {
        location.reload();
    }, 30000);
</script>
{% endblock %}