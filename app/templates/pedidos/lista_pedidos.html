{% extends "base.html" %}

{% block extra_css %}
<style>
/* 🎨 Estilos customizados para a lista de pedidos */
.table th {
    font-size: 0.85rem;
    font-weight: 600;
    white-space: nowrap;
}

.table td {
    font-size: 0.9rem;
    vertical-align: middle;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
    transform: scale(1.001);
    transition: all 0.2s ease;
}

.badge {
    font-size: 0.75rem;
}

.form-check-input:disabled {
    opacity: 0.5;
}

/* Cores para status */
.table-success {
    background-color: rgba(25, 135, 84, 0.1) !important;
}

.table-primary {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.table-warning {
    background-color: rgba(255, 193, 7, 0.1) !important;
}

.table-light {
    background-color: rgba(248, 249, 250, 0.5) !important;
}

/* Responsividade para telas menores */
@media (max-width: 768px) {
    .table th, .table td {
        font-size: 0.8rem;
        padding: 0.5rem 0.25rem;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
}

/* Animação para filtros */
.card {
    transition: box-shadow 0.2s ease;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Botões de ação */
.btn-outline-primary:hover,
.btn-outline-info:hover {
    transform: scale(1.05);
    transition: transform 0.2s ease;
}

/* Loading state para checkbox */
.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

/* Estilo para botões de filtro */
.filtro-btn {
    margin-right: 8px;
    margin-bottom: 8px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.filtro-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.15);
}

.filtro-data {
    font-weight: 500;
    padding: 6px 12px;
}

.filtro-status {
    padding: 8px 15px;
    font-weight: 500;
}

.filtros-container {
    padding: 12px;
    background-color: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 15px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1>Listagem de Pedidos</h1>

    <!-- 🔍 FORMULÁRIO DE FILTROS APRIMORADO -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-filter"></i> Filtros de Pesquisa
            </h5>
        </div>
        <div class="card-body">
            <form method="POST">
                {{ filtro_form.csrf_token }}
                
                <!-- Primeira linha de filtros -->
                <div class="row mb-3">
                    <div class="col-md-2">
                        <label for="numero_pedido" class="form-label">
                            {{ filtro_form.numero_pedido.label }}
                        </label>
                        {{ filtro_form.numero_pedido(class="form-control", id="numero_pedido", placeholder="Ex: PED001") }}
                    </div>
            
                    <div class="col-md-2">
                        <label for="cnpj_cpf" class="form-label">
                            {{ filtro_form.cnpj_cpf.label }}
                        </label>
                        {{ filtro_form.cnpj_cpf(class="form-control", id="cnpj_cpf", placeholder="Ex: 12.345.678") }}
                    </div>

                    <!-- ✨ NOVO: Campo de busca por cliente -->
                    <div class="col-md-3">
                        <label for="cliente" class="form-label">
                            <i class="fas fa-building"></i> {{ filtro_form.cliente.label }}
                        </label>
                        {{ filtro_form.cliente(class="form-control", id="cliente", placeholder="Ex: Nome da Empresa") }}
                    </div>

                    <div class="col-md-2">
                        <label for="uf" class="form-label">
                            {{ filtro_form.uf.label }}
                        </label>
                        {{ filtro_form.uf(class="form-select", id="uf") }}
                    </div>

                    <!-- ✨ NOVO: Filtro por status -->
                    <div class="col-md-2">
                        <label for="status" class="form-label">
                            <i class="fas fa-flag"></i> {{ filtro_form.status.label }}
                        </label>
                        {{ filtro_form.status(class="form-select", id="status") }}
                    </div>


                </div>

                <!-- Segunda linha de filtros -->
                <div class="row mb-3">
                    <div class="col-md-2">
                        <label for="rota" class="form-label">
                            {{ filtro_form.rota.label }}
                        </label>
                        {{ filtro_form.rota(class="form-select", id="rota") }}
                    </div>

                    <div class="col-md-2">
                        <label for="sub_rota" class="form-label">
                            {{ filtro_form.sub_rota.label }}
                        </label>
                        {{ filtro_form.sub_rota(class="form-select", id="sub_rota") }}
                    </div>

                    <div class="col-md-2">
                        <label for="expedicao_inicio" class="form-label">
                            {{ filtro_form.expedicao_inicio.label }}
                        </label>
                        {{ filtro_form.expedicao_inicio(class="form-control", id="expedicao_inicio", type="date") }}
                    </div>

                    <div class="col-md-2">
                        <label for="expedicao_fim" class="form-label">
                            {{ filtro_form.expedicao_fim.label }}
                        </label>
                        {{ filtro_form.expedicao_fim(class="form-control", id="expedicao_fim", type="date") }}
                    </div>
                </div>

                {# -------- LINHA ÚNICA: Ações  ·  Datas/Aberto (centro)  ·  Status -------- #}
            <div class="filtros-container acoes-filtros">
            <div class="row align-items-center gx-2 gy-2">

                {# ▸ ESQUERDA – Aplicar / Limpar #}
                <div class="col-auto">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search"></i> Aplicar Filtros
                </button>
                <a href="{{ url_for('pedidos.lista_pedidos') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Limpar Filtros
                </a>
                </div>

                            {# ▸ CENTRO – Datas + Aberto empilhado (cresce e centraliza) #}
                            <div class="col text-center">
                            <div class="d-inline-flex flex-wrap justify-content-center gap-2">
                                {% for key, dados in contadores_data.items() %}
                                <div class="d-flex flex-column align-items-center filtro-pair">
                                    <!-- DATA -->
                                    <a href="{{ url_for('pedidos.lista_pedidos',
                                                        data=dados.data.strftime('%Y-%m-%d')) }}"
                                    class="btn btn-sm filtro-data
                                        {% if filtro_data_ativo == dados.data.strftime('%Y-%m-%d') %}
                                        btn-primary
                                        {% else %}btn-outline-primary{% endif %}">
                                    <i class="far fa-calendar-check"></i>
                                    {{ dados.data.strftime('%d/%m/%Y') }}
                                    <span class="badge bg-light text-dark">{{ dados.total }}</span>
                                    </a>
                                    <!-- ABERTO -->
                                    <a href="{{ url_for('pedidos.lista_pedidos',
                                                        data=dados.data.strftime('%Y-%m-%d'),
                                                        status='abertos') }}"
                                    class="btn btn-sm filtro-aberto mt-1
                                        {% if filtro_data_ativo == dados.data.strftime('%Y-%m-%d')
                                            and filtro_status_ativo == 'abertos' %}
                                        btn-info
                                        {% else %}btn-outline-info{% endif %}">
                                    <i class="fas fa-clock"></i> Aberto
                                    <span class="badge bg-light text-dark">{{ dados.abertos }}</span>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                            </div>

                            {# ▸ DIREITA – Filtros de Status #}
                            <div class="col-auto d-flex flex-wrap gap-2 justify-content-end">
                            <a href="{{ url_for('pedidos.lista_pedidos') }}"
                                class="btn btn-sm filtro-status
                                {% if not filtro_status_ativo %}btn-secondary
                                {% else %}btn-outline-secondary{% endif %}">
                                <i class="fas fa-list"></i> Todos
                                <span class="badge bg-light text-dark">{{ contadores_status.todos }}</span>
                            </a>
                            <a href="{{ url_for('pedidos.lista_pedidos', status='abertos') }}"
                                class="btn btn-sm filtro-status
                                {% if filtro_status_ativo == 'abertos' %}btn-info
                                {% else %}btn-outline-info{% endif %}">
                                <i class="fas fa-clock"></i> Abertos
                                <span class="badge bg-light text-dark">{{ contadores_status.abertos }}</span>
                            </a>
                            <a href="{{ url_for('pedidos.lista_pedidos', status='cotados') }}"
                                class="btn btn-sm filtro-status
                                {% if filtro_status_ativo == 'cotados' %}btn-warning
                                {% else %}btn-outline-warning{% endif %}">
                                <i class="fas fa-calculator"></i> Cotados
                                <span class="badge bg-light text-dark">{{ contadores_status.cotados }}</span>
                            </a>
                            <a href="{{ url_for('pedidos.lista_pedidos', status='nf_cd') }}"
                                class="btn btn-sm filtro-status
                                {% if filtro_status_ativo == 'nf_cd' %}btn-danger
                                {% else %}btn-outline-danger{% endif %}">
                                <i class="fas fa-undo"></i> NF no CD
                                <span class="badge bg-light text-dark">{{ contadores_status.nf_cd }}</span>
                            </a>
                            </div>

                        </div>
                    </div>

                
                </div>
            </form>
        </div>
    </div>

    <!-- 📋 FORMULÁRIO PARA SELECIONAR PEDIDOS E COTAR FRETE -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-tasks"></i> Seleção de Pedidos para Cotação
            </h5>
            <div>
                <!-- Contador de pedidos selecionados -->
                <span id="selected-count" class="badge bg-primary me-2" style="display: none;"></span>
            </div>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('cotacao.iniciar_cotacao') }}" onsubmit="return confirmCotacao()">
                {{ cotar_form.hidden_tag() }}
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <!-- Botão para cotar frete -->
                    <button type="submit" class="btn btn-secondary" disabled id="btnCotarFrete">
                        <i class="fas fa-calculator"></i> Cotar Frete
                    </button>
                    
                    <!-- Botão para cotação manual -->
                    <button type="button" class="btn btn-warning" disabled id="btnCotacaoManual" onclick="abrirCotacaoManual()">
                        <i class="fas fa-edit"></i> Cotação Manual
                    </button>
                    
                    <!-- Botão para embarque FOB -->
                    <button type="button" class="btn btn-info" disabled id="btnEmbarqueFOB" onclick="abrirEmbarqueFOB()">
                        <i class="fas fa-ship"></i> Embarque FOB
                    </button>
                    
                    <!-- Ações adicionais -->
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.querySelector('thead input[type=checkbox]').click()">
                            <i class="fas fa-check-square"></i> Selecionar Todos
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.querySelectorAll('input[name=pedido_ids]:checked').forEach(cb => cb.checked = false); updateSelectedCount(); updateCotarButton();">
                            <i class="fas fa-times"></i> Limpar Seleção
                        </button>
                        <a href="{{ url_for('pedidos.atualizar_status') }}" class="btn btn-outline-warning btn-sm" onclick="return confirm('Confirma a atualização de todos os status dos pedidos?')">
                            <i class="fas fa-sync-alt"></i> Atualizar Status
                        </a>
                    </div>
                </div>

        <!-- 📊 INFORMAÇÕES ESTATÍSTICAS -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    <strong>{{ pedidos|length }}</strong> pedidos encontrados
                </div>
            </div>
        </div>

        <table class="table table-bordered table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <!-- Checkbox do "selecionar todos" -->
                    <th style="width: 40px;">
                        <input type="checkbox" onclick="toggleAll(this)" title="Selecionar todos">
                    </th>
                    <!-- ✨ NOVA COLUNA: Status -->
                    <th style="width: 100px;">
                        <i class="fas fa-flag"></i> Status
                    </th>
                    <th style="width: 50px;">#</th>
                    <th style="width: 120px;">Nº Pedido</th>
                    <th style="width: 100px;">Data Pedido</th>
                    <th style="width: 140px;">CNPJ/CPF</th>
                    <th>Razão Social</th>
                    <th style="width: 120px;">Cidade</th>
                    <th style="width: 60px;">UF</th>
                    <th style="width: 100px;">Valor Total</th>
                    <th style="width: 80px;">Peso (kg)</th>
                    <th style="width: 80px;">Rota</th>
                    <th style="width: 100px;"><i class="fas fa-truck"></i> Expedição</th>
                    <th style="width: 80px;">NF</th>
                    <th style="width: 120px;">Ações</th>

                </tr>
            </thead>
            <tbody>
            {% for p in pedidos %}
              <tr class="
                {% if p.status_calculado == 'FATURADO' %}table-success
                {% elif p.status_calculado == 'EMBARCADO' %}table-primary  
                {% elif p.status_calculado == 'COTADO' %}table-warning
                {% else %}table-light
                {% endif %}
              ">
                <!-- Checkbox individual -->
                <td class="text-center">
                  <input type="checkbox" name="pedido_ids" value="{{ p.id }}"
                    {% if p.status_calculado not in ['ABERTO', 'COTADO', 'NF no CD'] %}disabled title="Pedido já processado"{% endif %}>
                </td>
                
                <!-- ✨ NOVA COLUNA: Status -->
                <td class="text-center">
                  <span class="{{ p.status_badge_class }}">
                    {% if p.status_calculado == 'NF no CD' %}
                      <i class="fas fa-undo"></i> NF no CD
                    {% elif p.status_calculado == 'FATURADO' %}
                      <i class="fas fa-check-circle"></i> Faturado
                    {% elif p.status_calculado == 'EMBARCADO' %}
                      <i class="fas fa-truck"></i> Embarcado
                    {% elif p.status_calculado == 'COTADO' %}
                      <i class="fas fa-calculator"></i> Cotado
                    {% else %}
                      <i class="fas fa-clock"></i> Aberto
                    {% endif %}
                  </span>
                </td>
                
                <td class="text-center">
                  <small class="text-muted">{{ loop.index }}</small>
                </td>
                
                <td>
                  <strong>{{ p.num_pedido }}</strong>
                  {% if p.protocolo %}
                    <br><small class="text-muted"><i class="fas fa-barcode"></i> {{ p.protocolo | formatar_protocolo }}</small>
                  {% else %}
                    <br><small class="text-muted">Sem protocolo</small>
                  {% endif %}
                </td>
                
                <td>
                  {% if p.data_pedido %}
                    {{ p.data_pedido|formatar_data("%d/%m/%Y") }}
                  {% endif %}
                </td>
                
                <td>
                  <small>{{ p.cnpj_cpf or '' }}</small>
                </td>
                
                <td>
                  <strong>{{ p.raz_social_red or '' }}</strong>
                  {% if p.observ_ped_1 %}
                    <br><small class="text-muted" title="{{ p.observ_ped_1 }}">
                      <i class="fas fa-comment"></i> {{ p.observ_ped_1[:30] }}{% if p.observ_ped_1|length > 30 %}...{% endif %}
                    </small>
                  {% endif %}
                </td>
                
                <td>
                  {{ p.nome_cidade or '' }}
                  {% if p.roteirizacao %}
                    <br><small class="text-info">{{ p.roteirizacao }}</small>
                  {% endif %}
                </td>
                
                <td class="text-center">
                  {% if p.cod_uf %}
                    <span class="badge bg-secondary">{{ p.cod_uf }}</span>
                  {% endif %}
                  {% if p.rota and p.rota != p.cod_uf %}
                    <br><small class="text-primary">{{ p.rota }}</small>
                  {% endif %}
                </td>
                
                <td class="text-end">
                  {% if p.valor_saldo_total %}
                    <strong>{{ p.valor_saldo_total|valor_br(0) }}</strong>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                
                <td class="text-end">
                  {% if p.peso_total %}
                    {{ p.peso_total|numero_br(0) }} kg
                    {% if p.pallet_total %}
                      <br><small class="text-muted">{{ p.pallet_total|numero_br(1) }} pal</small>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                
                <td class="text-center">
                  {% if p.rota %}
                    <span class="badge bg-info">{{ p.rota }}</span>
                  {% endif %}
                  {% if p.sub_rota %}
                    <br><small>{{ p.sub_rota }}</small>
                  {% endif %}
                </td>
                
                <td class="text-center">
                  {% if p.expedicao %}
                    <strong>{{ p.expedicao | formatar_data_brasil }}</strong>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                  {% if p.agendamento and p.agendamento != p.expedicao %}
                    <br><small class="text-success"><i class="fas fa-calendar-alt"></i> {{ p.agendamento | formatar_data_brasil }}</small>
                  {% elif p.agendamento and not p.expedicao %}
                    <small class="text-success"><i class="fas fa-calendar-alt"></i> {{ p.agendamento | formatar_data_brasil }}</small>
                  {% endif %}
                </td>
                
                <td class="text-center">
                  {% if p.nf %}
                    <span class="badge bg-success">{{ p.nf }}</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                  {% if p.data_embarque %}
                    <br><small class="text-primary">Emb: {{ p.data_embarque | formatar_data_hora_brasil }}</small>
                  {% endif %}
                </td>
                
                <!-- ✅ NOVA COLUNA: Ações -->
                <td class="text-center">
                  {% if p.status_calculado == 'ABERTO' %}
                    <!-- Botões para pedidos com status ABERTO -->
                    <div class="btn-group-vertical btn-group-sm" role="group">
                      <a href="{{ url_for('pedidos.editar_pedido', pedido_id=p.id) }}" 
                         class="btn btn-outline-primary btn-sm" 
                         title="Editar pedido">
                        <i class="fas fa-edit"></i>
                      </a>
                      <button type="button" 
                              class="btn btn-outline-danger btn-sm" 
                              title="Excluir pedido"
                              onclick="confirmarExclusao({{ p.id }}, '{{ p.num_pedido }}')">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  {% else %}
                    <!-- Pedidos processados não podem ser editados/excluídos -->
                    <span class="text-muted" title="Pedido já processado - não pode ser editado">
                      <i class="fas fa-lock"></i>
                    </span>
                  {% endif %}
                </td>

              </tr>
            {% endfor %}
            
            {% if not pedidos %}
              <tr>
                <td colspan="15" class="text-center py-4">
                  <div class="text-muted">
                    <i class="fas fa-search fa-2x mb-2"></i>
                    <br>Nenhum pedido encontrado com os filtros aplicados.
                    <br><small>Tente ajustar os critérios de busca.</small>
                  </div>
                </td>
              </tr>
            {% endif %}
            </tbody>
        </table>
            </form>
        </div>
    </div>
</div>

<!-- 🚀 JavaScript aprimorado para funcionalidades da tabela -->
<script>
// Função para selecionar/deselecionar todos os checkboxes
function toggleAll(source) {
    const checkboxes = document.querySelectorAll('input[name="pedido_ids"]:not([disabled])');
    const selectedCount = document.getElementById('selected-count');
    
    for (let checkbox of checkboxes) {
        checkbox.checked = source.checked;
    }
    
    updateSelectedCount();
    updateCotarButton();
}

// Atualiza o contador de pedidos selecionados
function updateSelectedCount() {
    const selectedCheckboxes = document.querySelectorAll('input[name="pedido_ids"]:checked');
    const countElement = document.getElementById('selected-count');
    const count = selectedCheckboxes.length;
    
    if (countElement) {
        if (count > 0) {
            countElement.textContent = `${count} pedido(s) selecionado(s)`;
            countElement.style.display = 'inline';
        } else {
            countElement.style.display = 'none';
        }
    }
}

// Atualiza o estado do botão "Cotar Frete"
function updateCotarButton() {
    const selectedCheckboxes = document.querySelectorAll('input[name="pedido_ids"]:checked');
    const cotarButton = document.getElementById('btnCotarFrete');
    const cotacaoManualButton = document.getElementById('btnCotacaoManual');
    const embarqueFOBButton = document.getElementById('btnEmbarqueFOB');
    
    console.log('[DEBUG] updateCotarButton executada');
    console.log('[DEBUG] Checkboxes selecionados:', selectedCheckboxes.length);
    console.log('[DEBUG] Botão encontrado:', cotarButton ? 'SIM' : 'NÃO');
    
    if (cotarButton) {
        if (selectedCheckboxes.length > 0) {
            cotarButton.disabled = false;
            cotarButton.innerHTML = `<i class="fas fa-calculator"></i> Cotar Frete (${selectedCheckboxes.length})`;
            cotarButton.classList.remove('btn-secondary');
            cotarButton.classList.add('btn-success');
            console.log('[DEBUG] Botão HABILITADO com', selectedCheckboxes.length, 'pedidos');
        } else {
            cotarButton.disabled = true;
            cotarButton.innerHTML = '<i class="fas fa-calculator"></i> Cotar Frete';
            cotarButton.classList.remove('btn-success');
            cotarButton.classList.add('btn-secondary');
            console.log('[DEBUG] Botão DESABILITADO');
        }
    } else {
        console.error('[ERROR] Botão de cotar frete não encontrado!');
    }
    
    // Controla também o botão de cotação manual
    if (cotacaoManualButton) {
        cotacaoManualButton.disabled = selectedCheckboxes.length === 0;
        if (selectedCheckboxes.length > 0) {
            cotacaoManualButton.innerHTML = `<i class="fas fa-edit"></i> Cotação Manual (${selectedCheckboxes.length})`;
        } else {
            cotacaoManualButton.innerHTML = '<i class="fas fa-edit"></i> Cotação Manual';
        }
    }
    
    // Controla também o botão de embarque FOB
    if (embarqueFOBButton) {
        embarqueFOBButton.disabled = selectedCheckboxes.length === 0;
        if (selectedCheckboxes.length > 0) {
            embarqueFOBButton.innerHTML = `<i class="fas fa-ship"></i> Embarque FOB (${selectedCheckboxes.length})`;
        } else {
            embarqueFOBButton.innerHTML = '<i class="fas fa-ship"></i> Embarque FOB';
        }
    }
}

// Função para abrir cotação manual
function abrirCotacaoManual() {
    const selectedCheckboxes = document.querySelectorAll('input[name="pedido_ids"]:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('Por favor, selecione pelo menos um pedido para cotação manual.');
        return false;
    }
    
    // Coleta os IDs dos pedidos selecionados
    const pedidoIds = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    // Cria formulário temporário para enviar os dados via POST
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("pedidos.cotacao_manual") }}';
    
    // Adiciona o token CSRF
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    // Adiciona os IDs dos pedidos
    pedidoIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'pedido_ids';
        input.value = id;
        form.appendChild(input);
    });
    
    // Adiciona o formulário ao body e submete
    document.body.appendChild(form);
    form.submit();
}

// Adiciona event listeners para todos os checkboxes individuais
document.addEventListener('DOMContentLoaded', function() {
    const individualCheckboxes = document.querySelectorAll('input[name="pedido_ids"]');
    
    individualCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
            updateCotarButton();
            
            // Atualiza o checkbox "selecionar todos"
            const selectAllCheckbox = document.querySelector('thead input[type="checkbox"]');
            const enabledCheckboxes = document.querySelectorAll('input[name="pedido_ids"]:not([disabled])');
            const checkedCheckboxes = document.querySelectorAll('input[name="pedido_ids"]:checked');
            
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = enabledCheckboxes.length > 0 && checkedCheckboxes.length === enabledCheckboxes.length;
            }
        });
    });
    
    // Inicializa o estado dos botões
    updateSelectedCount();
    updateCotarButton();
    
    // Adiciona funcionalidade de busca rápida na tabela
    const searchInput = document.getElementById('quick-search');
    if (searchInput) {
        searchInput.addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll('tbody tr');
            
            rows.forEach(function(row) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    }
});

// Função para aplicar filtro rápido por status
function filterByStatus(status) {
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(function(row) {
        if (status === 'all') {
            row.style.display = '';
        } else {
            const statusBadge = row.querySelector('.badge');
            if (statusBadge && statusBadge.textContent.toLowerCase().includes(status.toLowerCase())) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
}

// Função para confirmar ação em pedidos selecionados
function confirmCotacao() {
    const selectedCheckboxes = document.querySelectorAll('input[name="pedido_ids"]:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('Por favor, selecione pelo menos um pedido para cotar.');
        return false;
    }
    
    const count = selectedCheckboxes.length;
    const message = `Confirma a cotação de ${count} pedido(s) selecionado(s)?`;
    
    return confirm(message);
}

// Função para abrir embarque FOB
function abrirEmbarqueFOB() {
    const selectedCheckboxes = document.querySelectorAll('input[name="pedido_ids"]:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('Por favor, selecione pelo menos um pedido para embarque FOB.');
        return false;
    }
    
    // Coleta os IDs dos pedidos selecionados
    const pedidoIds = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    // Cria formulário temporário para enviar os dados via POST
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("pedidos.embarque_fob") }}';
    
    // Adiciona o token CSRF
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    // Adiciona os IDs dos pedidos
    pedidoIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'pedido_ids';
        input.value = id;
        form.appendChild(input);
    });
    
    // Adiciona o formulário ao body e submete
    document.body.appendChild(form);
    form.submit();
}

// ✅ NOVA FUNÇÃO: Confirmar exclusão de pedido
function confirmarExclusao(pedidoId, numeroPedido) {
    const mensagem = `Tem certeza que deseja excluir o pedido ${numeroPedido}?\n\n` +
                    `⚠️ ATENÇÃO: Esta ação também removerá todos os itens de separação relacionados e NÃO PODE SER DESFEITA!`;
    
    if (confirm(mensagem)) {
        // Cria formulário para excluir via POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/pedidos/excluir/${pedidoId}`;
        
        // Adiciona o token CSRF
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        // Adiciona o formulário ao body e submete
        document.body.appendChild(form);
        form.submit();
    }
}

/* ---- BOTÕES DE FILTRO (cores e espaçamento) ---- */
.filtro-pair {                     /* agrupa Data+Aberto */
    border-radius: 6px;            /* cantos suaves */
}

.filtro-data, .filtro-aberto, .filtro-status {
    font-weight: 600;
    box-shadow: 0 1px 3px rgba(0,0,0,.08);
}

/* contraste maior no estado outline */
.btn-outline-primary.filtro-data   { background:#e9f2ff; }
.btn-outline-warning.filtro-aberto { background:#fff9e6; }
.btn-outline-secondary.filtro-status { background:#f2f2f2; }

.filtro-data:hover,
.filtro-aberto:hover,
.filtro-status:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

/* badge um pouquinho menor pra caber bem */
.filtro-data .badge,
.filtro-aberto .badge,
.filtro-status .badge {
    font-size: .65rem;
    font-weight: 500;
    padding: 0 .4em;
}

/* remove margem antiga e usa gap do flex   */
.filtro-btn { margin:0!important; }        /* neutraliza suas antigas margens */

/* empilha Data/Aberto sem estourar largura */
.filtro-pair { min-width: 120px; }          /* mesma base p/ todos */
.filtro-pair .btn { width: 100%; }           /* botão ocupa 100%   */

/* alinhar melhor no mobile */
@media (max-width: 576px) {
  .filtros-container .ms-auto { margin-left: 0 !important; } /* status abaixo */
}


</script>
{% endblock %}
