{% extends "base.html" %}

{% block title %}Leitura de Pedidos PDF{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">
            <i class="fas fa-file-pdf"></i> Leitura de Pedidos em PDF
        </h1>
        <a href="{{ url_for('carteira.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>

    <!-- Card Principal -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-upload"></i> Upload de Arquivo PDF
                    </h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Selecione o arquivo PDF</label>
                            <input type="file" class="form-control" id="fileInput" name="file" accept=".pdf" required>
                            <div class="form-text">Formatos suportados: PDF de Proposta de Compra</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="formatoSelect" class="form-label">Formato do Pedido</label>
                            <select class="form-select" id="formatoSelect" name="formato">
                                <option value="auto">Detectar Automaticamente</option>
                                <option value="atacadao">Atacadão - Proposta de Compra</option>
                                <!-- Adicionar outros formatos no futuro -->
                                <option value="sendas" disabled>Sendas/Assaí (Em breve)</option>
                                <option value="tenda" disabled>Tenda (Em breve)</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-cog"></i> Processar PDF
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Área de Resultados -->
            <div id="resultArea" class="mt-4" style="display: none;">
                <!-- Resumo Geral -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle"></i> Dados Extraídos com Sucesso
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="summaryArea"></div>
                        
                        <!-- Botões de Export -->
                        <div class="mt-3">
                            <button id="btnExportExcel" class="btn btn-success" style="display: none;">
                                <i class="fas fa-file-excel"></i> Exportar Excel
                            </button>
                            <button id="btnExportCSV" class="btn btn-info ms-2" style="display: none;">
                                <i class="fas fa-file-csv"></i> Exportar CSV
                            </button>
                            <button id="btnSaveOdoo" class="btn btn-warning ms-2" disabled>
                                <i class="fas fa-database"></i> Salvar no Odoo (Em breve)
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Cards de Filiais -->
                <div id="cardsFiliais"></div>
            </div>
            
            <!-- Área de Erros -->
            <div id="errorArea" class="mt-4" style="display: none;">
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Erros ao Processar</h5>
                    <ul id="errorList" class="mb-0"></ul>
                </div>
            </div>
            
            <!-- Área de Avisos -->
            <div id="warningArea" class="mt-4" style="display: none;">
                <div class="alert alert-warning">
                    <h5><i class="fas fa-info-circle"></i> Avisos</h5>
                    <ul id="warningList" class="mb-0"></ul>
                </div>
            </div>
        </div>
        
        <!-- Coluna Lateral - Instruções -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-question-circle"></i> Como Funciona
                    </h6>
                </div>
                <div class="card-body">
                    <h6>Processo de Extração</h6>
                    <ol class="small">
                        <li>Faça upload do PDF do pedido</li>
                        <li>O sistema detecta automaticamente o formato</li>
                        <li>Extrai os dados principais:
                            <ul>
                                <li>CNPJ da filial de entrega</li>
                                <li>Código do produto (sem sufixo)</li>
                                <li>Quantidade em caixas</li>
                                <li>Valor unitário</li>
                            </ul>
                        </li>
                        <li>Busca dados do cliente no sistema</li>
                        <li>Agrupa pedidos por CNPJ</li>
                        <li>Permite exportar para Excel/CSV</li>
                    </ol>
                    
                    <h6 class="mt-3">Formatos Suportados</h6>
                    <ul class="small">
                        <li><strong>Atacadão:</strong> Proposta de Compra (CCPMERM01)</li>
                        <li class="text-muted">Sendas/Assaí: Em desenvolvimento</li>
                        <li class="text-muted">Tenda: Em desenvolvimento</li>
                    </ul>
                    
                    <h6 class="mt-3">Validações Aplicadas</h6>
                    <ul class="small">
                        <li>Mantém formatação original do CNPJ</li>
                        <li>Busca dados do cliente (UF, Cidade, Nome)</li>
                        <li>Extrai código base (antes do hífen)</li>
                        <li>Converte valores para formato numérico</li>
                        <li>Valida quantidades positivas</li>
                        <li>Calcula valor total automaticamente</li>
                    </ul>
                </div>
            </div>
            
            <!-- Card de Exemplo -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-file-alt"></i> Exemplo de Dados Extraídos
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Campo</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>CNPJ Filial</td>
                                    <td>75.315.333/0183-18</td>
                                </tr>
                                <tr>
                                    <td>Cliente</td>
                                    <td>Atacadão SA</td>
                                </tr>
                                <tr>
                                    <td>Local</td>
                                    <td>JACAREI - SP</td>
                                </tr>
                                <tr>
                                    <td>Código</td>
                                    <td>35642</td>
                                </tr>
                                <tr>
                                    <td>Descrição</td>
                                    <td>AZEITONA VERDE</td>
                                </tr>
                                <tr>
                                    <td>Qtde</td>
                                    <td>770</td>
                                </tr>
                                <tr>
                                    <td>Vlr Unit</td>
                                    <td>199,48</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    let currentSessionKey = null;
    
    // Upload e processamento
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const fileInput = $('#fileInput')[0];
        
        if (!fileInput.files.length) {
            alert('Por favor, selecione um arquivo PDF');
            return;
        }
        
        // Mostra loading
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Processando...').prop('disabled', true);
        
        // Limpa resultados anteriores
        $('#resultArea, #errorArea, #warningArea').hide();
        
        $.ajax({
            url: '{{ url_for("leitura_pedidos.upload") }}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    currentSessionKey = response.session_key;
                    showResults(response);
                } else {
                    showErrors(response.errors || ['Erro ao processar arquivo']);
                }
            },
            error: function(xhr) {
                console.error('Erro na requisição:', xhr);
                const response = xhr.responseJSON || {};
                
                // Melhora o tratamento de erros
                let errorMessages = [];
                if (response.errors && Array.isArray(response.errors)) {
                    errorMessages = response.errors;
                } else if (response.error) {
                    errorMessages = [response.error];
                } else if (xhr.responseText) {
                    try {
                        const text = xhr.responseText;
                        if (text.length < 500) {
                            errorMessages = ['Erro ao processar: ' + text];
                        } else {
                            errorMessages = ['Erro ao processar arquivo. Verifique o console para mais detalhes.'];
                            console.error('Resposta completa:', text);
                        }
                    } catch(e) {
                        errorMessages = ['Erro ao processar arquivo'];
                    }
                } else {
                    errorMessages = ['Erro desconhecido ao processar arquivo'];
                }
                
                showErrors(errorMessages);
            },
            complete: function() {
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });
    
    function showResults(response) {
        // Valida se response tem os dados necessários
        if (!response || !response.summary) {
            showErrors(['Resposta inválida do servidor']);
            return;
        }
        
        // Mostra resumo geral
        const summary = response.summary;
        let summaryHtml = `
            <div class="row">
                <div class="col-md-3">
                    <div class="text-center">
                        <h6>Total de Itens</h6>
                        <h4 class="text-primary">${summary.total_itens || 0}</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h6>Filiais</h6>
                        <h4 class="text-info">${summary.total_filiais || 0}</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h6>Produtos</h6>
                        <h4 class="text-success">${summary.total_produtos || 0}</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h6>Valor Total</h6>
                        <h4 class="text-warning">R$ ${formatMoney(summary.valor_total || 0)}</h4>
                    </div>
                </div>
            </div>
        `;
        
        $('#summaryArea').html(summaryHtml);
        
        // Cria cards por filial
        const cardsContainer = $('#cardsFiliais');
        cardsContainer.empty();
        
        if (summary.por_filial && summary.por_filial.length > 0) {
            summary.por_filial.forEach(function(filial, index) {
                // Cria um card para cada filial
                const cardHtml = createFilialCard(filial, index);
                cardsContainer.append(cardHtml);
            });
        }
        
        // Mostra área de resultados e botões de export
        $('#resultArea').show();
        $('#btnExportExcel, #btnExportCSV').show();
        
        // Mostra avisos se houver
        if (response.warnings && response.warnings.length > 0) {
            showWarnings(response.warnings);
        }
    }
    
    function createFilialCard(filial, index) {
        // Valida dados da filial
        if (!filial) {
            return '';
        }
        
        // Determina a cor do card baseado no índice
        const colors = ['primary', 'success', 'info', 'warning', 'secondary'];
        const color = colors[index % colors.length];
        
        // Header do card com informações da filial
        let cardHtml = `
            <div class="card mb-3 border-${color}">
                <div class="card-header bg-${color} text-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-0">
                                <i class="fas fa-building"></i> ${filial.nome_cliente || 'Cliente não identificado'}
                            </h5>
                            <small>
                                CNPJ: ${filial.cnpj} | 
                                ${filial.municipio || 'Cidade não identificada'} - ${filial.estado || 'UF'}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <div>
                                <strong>${filial.itens || 0}</strong> itens<br>
                                <strong>R$ ${formatMoney(filial.valor || 0)}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">
                        <i class="fas fa-map-marker-alt"></i> Local de Entrega: <strong>${filial.local || 'Não especificado'}</strong>
                    </p>
                    
                    <!-- Tabela de produtos -->
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Cód. Atacadão</th>
                                    <th>Nosso Código</th>
                                    <th>Descrição</th>
                                    <th class="text-end">Qtde</th>
                                    <th class="text-end">Vlr Unit</th>
                                    <th class="text-end">Vlr Total</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        // Adiciona produtos da filial
        if (filial.produtos && filial.produtos.length > 0) {
            filial.produtos.forEach(function(produto) {
                const nossoCodigoClass = produto.nosso_codigo ? '' : 'text-danger';
                const nossoCodigoText = produto.nosso_codigo || '<i class="fas fa-exclamation-triangle"></i> Sem De-Para';
                
                cardHtml += `
                    <tr>
                        <td><span class="badge bg-secondary">${produto.codigo || ''}</span></td>
                        <td class="${nossoCodigoClass}"><strong>${nossoCodigoText}</strong></td>
                        <td>${produto.descricao || ''}</td>
                        <td class="text-end">${produto.quantidade || 0}</td>
                        <td class="text-end">R$ ${formatMoney(produto.valor_unitario || 0)}</td>
                        <td class="text-end">R$ ${formatMoney(produto.valor_total || 0)}</td>
                    </tr>
                `;
            });
        }
        
        // Footer do card com totais
        cardHtml += `
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="3">Total</th>
                                    <th class="text-end">${filial.quantidade || 0}</th>
                                    <th></th>
                                    <th class="text-end">R$ ${formatMoney(filial.valor || 0)}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        return cardHtml;
    }
    
    function showErrors(errors) {
        const errorList = $('#errorList');
        errorList.empty();
        
        errors.forEach(function(error) {
            errorList.append(`<li>${error}</li>`);
        });
        
        $('#errorArea').show();
    }
    
    function showWarnings(warnings) {
        const warningList = $('#warningList');
        warningList.empty();
        
        warnings.forEach(function(warning) {
            warningList.append(`<li>${warning}</li>`);
        });
        
        $('#warningArea').show();
    }
    
    function formatMoney(value) {
        return new Intl.NumberFormat('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }
    
    // Export Excel
    $('#btnExportExcel').on('click', function() {
        if (currentSessionKey) {
            window.location.href = `{{ url_for("leitura_pedidos.export", format="excel", session_key="") }}${currentSessionKey}`;
        }
    });
    
    // Export CSV
    $('#btnExportCSV').on('click', function() {
        if (currentSessionKey) {
            window.location.href = `{{ url_for("leitura_pedidos.export", format="csv", session_key="") }}${currentSessionKey}`;
        }
    });
});
</script>

{% endblock %}