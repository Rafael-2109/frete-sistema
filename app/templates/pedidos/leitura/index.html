{% extends "base.html" %}

{% block title %}Importador de Pedidos de Redes{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">
            <i class="fas fa-file-pdf"></i> Importador de Pedidos de Redes
        </h1>
        <div>
            <a href="{{ url_for('leitura_pedidos.historico') }}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-history"></i> Historico
            </a>
            <a href="{{ url_for('carteira.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Card Principal -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-upload"></i> Upload de Arquivo PDF
                    </h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Selecione o arquivo PDF</label>
                            <input type="file" class="form-control" id="fileInput" name="file" accept=".pdf" required>
                            <div class="form-text">Formatos suportados: Proposta ou Pedido de Compra das redes</div>
                        </div>

                        <div class="mb-3">
                            <label for="formatoSelect" class="form-label">Formato do Documento</label>
                            <select class="form-select" id="formatoSelect" name="formato">
                                <option value="auto">Detectar Automaticamente</option>
                                <option value="atacadao_proposta">Atacadao - Proposta de Compra</option>
                                <option value="atacadao_pedido">Atacadao - Pedido de Compra</option>
                                <option value="assai_pedido">Assai/Sendas - Pedido de Compra</option>
                                <option value="tenda" disabled>Tenda (Em breve)</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-cog"></i> Processar PDF
                        </button>
                    </form>
                </div>
            </div>

            <!-- Card de Identificacao do Documento -->
            <div id="identificacaoCard" class="card mt-4" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-id-card"></i> Documento Identificado
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Rede:</strong>
                            <h4 id="idRede" class="text-primary">-</h4>
                        </div>
                        <div class="col-md-3">
                            <strong>Tipo:</strong>
                            <h4 id="idTipo" class="text-info">-</h4>
                        </div>
                        <div class="col-md-3">
                            <strong>Numero:</strong>
                            <h4 id="idNumero" class="text-secondary">-</h4>
                        </div>
                        <div class="col-md-3">
                            <strong>Confianca:</strong>
                            <h4 id="idConfianca" class="text-success">-</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerta de Itens sem De-Para (Produtos) -->
            <div id="alertaDepara" class="alert alert-warning mt-4" style="display: none;">
                <h5><i class="fas fa-exclamation-triangle"></i> Itens sem De-Para</h5>
                <p>Existem itens que nao possuem mapeamento De-Para. Complete o cadastro antes de inserir no Odoo.</p>
                <button class="btn btn-warning" onclick="abrirModalDepara()">
                    <i class="fas fa-link"></i> Cadastrar De-Para
                </button>
            </div>

            <!-- Alerta de Filiais sem De-Para (CNPJ) - Cadastro Inline -->
            <div id="alertaFiliaisDepara" class="alert alert-danger mt-4" style="display: none;">
                <h5><i class="fas fa-store-slash"></i> Filiais sem Cadastro</h5>
                <p class="mb-2">
                    As seguintes lojas nao possuem De-Para de filial cadastrado.
                    <strong>Cadastre os CNPJs abaixo para prosseguir com a importacao.</strong>
                </p>
                <div class="table-responsive mb-3">
                    <table class="table table-sm table-bordered bg-white">
                        <thead class="table-danger">
                            <tr>
                                <th style="width: 80px;">Num. Loja</th>
                                <th style="width: 200px;">Nome da Loja</th>
                                <th style="width: 280px;">CNPJ</th>
                                <th style="width: 150px;">Cidade</th>
                                <th style="width: 60px;">UF</th>
                                <th style="width: 60px;">Itens</th>
                                <th style="width: 100px;">Valor</th>
                                <th style="width: 80px;">Acao</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyFiliaisSemDepara">
                            <!-- Preenchido dinamicamente -->
                        </tbody>
                    </table>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" id="btnSalvarTodasFiliais" disabled>
                        <i class="fas fa-save"></i> Salvar Todas e Reprocessar
                    </button>
                    <button class="btn btn-outline-secondary" onclick="reprocessarDados()">
                        <i class="fas fa-sync"></i> Apenas Reprocessar
                    </button>
                    <a href="{{ url_for('portal.sendas_depara.index_filiais') }}" class="btn btn-outline-danger" target="_blank">
                        <i class="fas fa-external-link-alt"></i> Abrir Cadastro Completo
                    </a>
                </div>
                <small class="text-muted mt-2 d-block">
                    <i class="fas fa-info-circle"></i> Digite pelo menos 3 caracteres no campo CNPJ para buscar clientes cadastrados.
                </small>
            </div>

            <!-- Alerta de Divergencia de Precos -->
            <div id="alertaDivergencia" class="alert alert-danger mt-4" style="display: none;">
                <h5><i class="fas fa-exclamation-circle"></i> Divergencia de Precos</h5>
                <p class="mb-0">Foram encontradas divergencias entre os precos do documento e a tabela cadastrada.</p>
                <p class="mb-0"><small>Edite os precos ou informe a justificativa para aprovar.</small></p>
            </div>

            <!-- Secao de Agregacao de Divergencias (NOVO) -->
            <div id="secaoDivergenciasAgregadas" class="card mt-4 border-danger" style="display: none;">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Resumo de Divergencias de Preco
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Justificativa Global -->
                    <div class="alert alert-warning mb-3">
                        <div class="row align-items-end">
                            <div class="col-md-9">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-edit"></i> Justificativa Global
                                </label>
                                <textarea id="justificativaGlobal" class="form-control" rows="2"
                                    placeholder="Informe a justificativa que sera aplicada a todos os pedidos com divergencia..."></textarea>
                            </div>
                            <div class="col-md-3">
                                <button id="btnAplicarJustificativaGlobal" class="btn btn-warning w-100">
                                    <i class="fas fa-check-double"></i> Aplicar a Todos
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Divergencias Agregadas -->
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="tabelaDivergenciasAgregadas">
                            <thead class="table-danger">
                                <tr>
                                    <th>Cliente / CNPJ</th>
                                    <th>UF</th>
                                    <th>Cod. Rede</th>
                                    <th>Nosso Cod.</th>
                                    <th>Descricao</th>
                                    <th class="text-end">Qtde</th>
                                    <th class="text-end">Preco Doc</th>
                                    <th class="text-end">Preco Tabela</th>
                                    <th class="text-end" style="width: 120px;">Preco Final</th>
                                    <th class="text-end">Dif %</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyDivergenciasAgregadas">
                                <!-- Preenchido dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Area de Resultados -->
            <div id="resultArea" class="mt-4" style="display: none;">
                <!-- Resumo Geral -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle"></i> Dados Extraidos com Sucesso
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="summaryArea"></div>

                        <!-- Botoes de Acao -->
                        <div class="mt-3">
                            <button id="btnExportExcel" class="btn btn-success" style="display: none;">
                                <i class="fas fa-file-excel"></i> Exportar Excel
                            </button>
                            <button id="btnExportCSV" class="btn btn-info ms-2" style="display: none;">
                                <i class="fas fa-file-csv"></i> Exportar CSV
                            </button>
                            <button id="btnInserirTodosOdoo" class="btn btn-warning ms-2" style="display: none;">
                                <i class="fas fa-database"></i> Inserir Todos no Odoo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Indicador de Progresso -->
                <div id="progressArea" class="card mb-3" style="display: none;">
                    <div class="card-body">
                        <h6 class="mb-2">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span id="progressText">Inserindo pedidos no Odoo...</span>
                        </h6>
                        <div class="progress" style="height: 25px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <span id="progressPercent">0%</span>
                            </div>
                        </div>
                        <small id="progressDetail" class="text-muted mt-1 d-block"></small>
                    </div>
                </div>

                <!-- Cards de Filiais -->
                <div id="cardsFiliais"></div>
            </div>

            <!-- Area de Erros -->
            <div id="errorArea" class="mt-4" style="display: none;">
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Erros ao Processar</h5>
                    <ul id="errorList" class="mb-0"></ul>
                </div>
            </div>

            <!-- Area de Avisos -->
            <div id="warningArea" class="mt-4" style="display: none;">
                <div class="alert alert-warning">
                    <h5><i class="fas fa-info-circle"></i> Avisos</h5>
                    <ul id="warningList" class="mb-0"></ul>
                </div>
            </div>
        </div>

        <!-- Coluna Lateral - Instrucoes -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-question-circle"></i> Como Funciona
                    </h6>
                </div>
                <div class="card-body">
                    <h6>Fluxo do Importador</h6>
                    <ol class="small">
                        <li><strong>Upload:</strong> Faca upload do PDF</li>
                        <li><strong>Identificacao:</strong> Sistema detecta rede e tipo</li>
                        <li><strong>Extracao:</strong> Dados sao extraidos automaticamente</li>
                        <li><strong>De-Para:</strong> Codigos sao convertidos para Nacom</li>
                        <li><strong>Validacao:</strong> Precos sao validados contra tabela</li>
                        <li><strong>Aprovacao:</strong> Divergencias requerem justificativa</li>
                        <li><strong>Insercao:</strong> Pedido e criado no Odoo</li>
                    </ol>

                    <h6 class="mt-3">Redes Suportadas</h6>
                    <ul class="small">
                        <li><strong>Atacadao:</strong> Proposta e Pedido de Compra</li>
                        <li><strong>Assai/Sendas:</strong> Pedido de Compra (Lote)</li>
                        <li class="text-muted">Tenda: Em desenvolvimento</li>
                    </ul>

                    <h6 class="mt-3">Validacoes Realizadas</h6>
                    <ul class="small">
                        <li>Identificacao automatica da rede</li>
                        <li>Conversao De-Para de codigos</li>
                        <li>Validacao de precos vs Tabela de Precos</li>
                        <li>Verificacao de cliente no Odoo</li>
                        <li>Verificacao de produtos no Odoo</li>
                    </ul>
                </div>
            </div>

            <!-- Card de Configuracoes -->
            <div class="card mt-3">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-cog"></i> Configuracoes
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('leitura_pedidos.tabela_precos') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-dollar-sign"></i> Tabela de Precos
                        </a>
                        <a href="{{ url_for('leitura_pedidos.regioes') }}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-map"></i> Mapeamento UF → Regiao
                        </a>
                    </div>
                    <p class="small text-muted mt-2 mb-0">
                        Configure precos e regioes para validacao automatica dos pedidos.
                    </p>
                </div>
            </div>

            <!-- Card de Monitoramento -->
            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line"></i> Monitoramento
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('leitura_pedidos.fila_impostos') }}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-calculator"></i> Fila de Impostos
                        </a>
                    </div>
                    <p class="small text-muted mt-2 mb-0">
                        Acompanhe o calculo de impostos dos pedidos em tempo real.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal De-Para -->
<div class="modal fade" id="modalDepara" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-link"></i> Cadastrar De-Para
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Itens sem mapeamento De-Para:</p>
                <table class="table table-sm" id="tabelaDepara">
                    <thead>
                        <tr>
                            <th>Codigo Rede</th>
                            <th>Descricao</th>
                            <th>Nosso Codigo</th>
                            <th>Acao</th>
                        </tr>
                    </thead>
                    <tbody id="deparaBody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="reprocessarDados()">
                    <i class="fas fa-sync"></i> Reprocessar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Resultado Odoo -->
<div class="modal fade" id="modalResultadoOdoo" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" id="modalResultadoHeader">
                <h5 class="modal-title">
                    <i class="fas fa-database"></i> Resultado da Insercao
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalResultadoBody">
                <!-- Resultado sera preenchido dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    let currentSessionKey = null;
    let currentResponse = null;

    // Configura CSRF token para todas as requisicoes AJAX
    const csrfToken = '{{ csrf_token() }}';
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrfToken);
            }
        }
    });

    // Upload e processamento
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const fileInput = $('#fileInput')[0];

        if (!fileInput.files.length) {
            alert('Por favor, selecione um arquivo PDF');
            return;
        }

        // Mostra loading
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Processando...').prop('disabled', true);

        // Limpa resultados anteriores
        $('#resultArea, #errorArea, #warningArea, #identificacaoCard, #alertaDepara, #alertaFiliaisDepara, #alertaDivergencia, #secaoDivergenciasAgregadas').hide();

        $.ajax({
            url: '{{ url_for("leitura_pedidos.upload") }}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    currentSessionKey = response.session_key;
                    currentResponse = response;
                    showResults(response);
                } else {
                    showErrors(response.errors || ['Erro ao processar arquivo']);
                }
            },
            error: function(xhr) {
                console.error('Erro na requisicao:', xhr);
                const response = xhr.responseJSON || {};
                let errorMessages = [];
                if (response.errors && Array.isArray(response.errors)) {
                    errorMessages = response.errors;
                } else if (response.error) {
                    errorMessages = [response.error];
                } else {
                    errorMessages = ['Erro desconhecido ao processar arquivo'];
                }
                showErrors(errorMessages);
            },
            complete: function() {
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });

    function showResults(response) {
        if (!response || !response.summary) {
            showErrors(['Resposta invalida do servidor']);
            return;
        }

        // Mostra identificacao
        if (response.identificacao) {
            $('#idRede').text(response.identificacao.rede || '-');
            $('#idTipo').text(response.identificacao.tipo || '-');
            $('#idNumero').text(response.identificacao.numero_documento || '-');
            $('#idConfianca').text((response.identificacao.confianca * 100).toFixed(0) + '%');
            $('#identificacaoCard').show();
        }

        // Mostra alerta de De-Para de produtos se necessario
        if (response.itens_sem_depara && response.itens_sem_depara.length > 0) {
            $('#alertaDepara').show();
            populateDeParaModal(response.itens_sem_depara, response.identificacao?.rede || 'ATACADAO');
        }

        // Mostra alerta de filiais sem De-Para (CNPJ) se necessario
        if (response.filiais_sem_depara && response.filiais_sem_depara.length > 0) {
            $('#alertaFiliaisDepara').show();
            populateFiliaisSemDepara(response.filiais_sem_depara);
        }

        // Mostra alerta de divergencia se necessario
        if (response.tem_divergencia) {
            $('#alertaDivergencia').show();
            // Mostra e popula seção de divergências agregadas
            if (response.divergencias_agregadas && response.divergencias_agregadas.length > 0) {
                popularTabelaDivergenciasAgregadas(response.divergencias_agregadas);
                $('#secaoDivergenciasAgregadas').show();
            }
        }

        // Mostra resumo geral
        const summary = response.summary;
        let summaryHtml = `
            <div class="row">
                <div class="col-md-2">
                    <div class="text-center">
                        <h6>Total Itens</h6>
                        <h4 class="text-primary">${summary.total_itens || 0}</h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="text-center">
                        <h6>Filiais</h6>
                        <h4 class="text-info">${summary.total_filiais || 0}</h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="text-center">
                        <h6>Produtos</h6>
                        <h4 class="text-success">${summary.total_produtos || 0}</h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="text-center">
                        <h6>Sem De-Para</h6>
                        <h4 class="${(summary.sem_depara || 0) > 0 ? 'text-danger' : 'text-success'}">${summary.sem_depara || 0}</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <h6>Valor Total</h6>
                        <h4 class="text-warning">R$ ${formatMoney(summary.valor_total || 0)}</h4>
                    </div>
                </div>
            </div>
        `;

        $('#summaryArea').html(summaryHtml);

        // Cria cards por filial
        const cardsContainer = $('#cardsFiliais');
        cardsContainer.empty();

        if (summary.por_filial && summary.por_filial.length > 0) {
            summary.por_filial.forEach(function(filial, index) {
                const cardHtml = createFilialCard(filial, index, response.validacao_precos);
                cardsContainer.append(cardHtml);
            });
        }

        // Mostra area de resultados e botoes
        $('#resultArea').show();
        $('#btnExportExcel, #btnExportCSV').show();

        // Mostra botao de inserir todos apenas se pode inserir (sem itens sem De-Para)
        if (response.pode_inserir) {
            $('#btnInserirTodosOdoo').show().prop('disabled', false);
        } else {
            $('#btnInserirTodosOdoo').show().prop('disabled', true);
        }

        // Mostra avisos se houver
        if (response.warnings && response.warnings.length > 0) {
            showWarnings(response.warnings);
        }
    }

    function createFilialCard(filial, index, validacao_precos) {
        if (!filial) return '';

        const colors = ['primary', 'success', 'info', 'warning', 'secondary'];
        const color = colors[index % colors.length];
        const cnpjSafe = filial.cnpj.replace(/[^0-9]/g, ''); // Remove pontuacao para usar como ID

        // Verifica divergencia da filial
        let temDivergenciaFilial = false;
        let validacoesFilial = [];
        if (validacao_precos && validacao_precos.por_filial) {
            const valFilial = validacao_precos.por_filial.find(v => v.cnpj === filial.cnpj);
            if (valFilial) {
                temDivergenciaFilial = valFilial.tem_divergencia;
                validacoesFilial = valFilial.validacoes || [];
            }
        }

        // Verifica se pode inserir esta filial
        const temSemDepara = (filial.sem_depara || 0) > 0;
        const podeInserir = !temSemDepara;

        let headerClass = `bg-${color}`;
        if (temDivergenciaFilial) {
            headerClass = 'bg-danger';
        } else if (temSemDepara) {
            headerClass = 'bg-warning';
        }

        let cardHtml = `
            <div class="card mb-3 border-${color}" id="card-filial-${cnpjSafe}" data-cnpj="${filial.cnpj}" data-tem-divergencia="${temDivergenciaFilial}">
                <div class="card-header ${headerClass} text-white">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">
                                ${filial.numero_loja ? `<span class="badge bg-light text-dark me-2">${filial.numero_loja}</span>` : ''}
                                <i class="fas fa-building"></i> ${filial.nome_cliente || 'Cliente nao identificado'}
                                ${temDivergenciaFilial ? '<span class="badge bg-light text-danger ms-2"><i class="fas fa-exclamation-circle"></i> Divergencia</span>' : ''}
                                ${temSemDepara ? '<span class="badge bg-light text-warning ms-2"><i class="fas fa-link"></i> Sem De-Para</span>' : ''}
                            </h5>
                            <small>
                                CNPJ: ${filial.cnpj} |
                                ${filial.municipio || 'Cidade nao identificada'} - ${filial.estado || 'UF'}
                                ${filial.numero_pedido_cliente ? `| <strong>Pedido: ${filial.numero_pedido_cliente}</strong>` : ''}
                            </small>
                        </div>
                        <div class="col-md-3 text-end">
                            <div>
                                <strong>${filial.itens || 0}</strong> itens<br>
                                <strong>R$ ${formatMoney(filial.valor || 0)}</strong>
                            </div>
                        </div>
                        <div class="col-md-3 text-end">
                            <button class="btn btn-sm ${podeInserir ? 'btn-light' : 'btn-secondary'} btn-inserir-filial"
                                data-cnpj="${filial.cnpj}"
                                data-nome="${filial.nome_cliente || ''}"
                                data-tem-divergencia="${temDivergenciaFilial}"
                                ${!podeInserir ? 'disabled title="Complete o De-Para primeiro"' : ''}>
                                <i class="fas fa-database"></i> Inserir Odoo
                            </button>
                            <span id="status-filial-${cnpjSafe}" class="ms-2" style="display: none;"></span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">
                        <i class="fas fa-map-marker-alt"></i> Local de Entrega: <strong>${filial.local || 'Nao especificado'}</strong>
                    </p>
        `;

        // Campo de justificativa se tiver divergencia
        if (temDivergenciaFilial) {
            cardHtml += `
                    <div class="alert alert-danger py-2 mb-2">
                        <small><i class="fas fa-exclamation-circle"></i> Esta filial possui divergencia de precos. Informe a justificativa para aprovar:</small>
                        <textarea class="form-control form-control-sm mt-1 justificativa-filial"
                            id="justificativa-${cnpjSafe}"
                            data-cnpj="${filial.cnpj}"
                            rows="2"
                            placeholder="Justificativa obrigatoria..."></textarea>
                    </div>
            `;
        }

        cardHtml += `
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Cod. Rede</th>
                                    <th>Nosso Cod.</th>
                                    <th>Descricao</th>
                                    <th class="text-end">Qtde</th>
                                    <th class="text-end">Vlr Doc</th>
                                    <th class="text-end">Vlr Tabela</th>
                                    <th class="text-end">Vlr Final</th>
                                    <th class="text-end">Dif %</th>
                                </tr>
                            </thead>
                            <tbody>
        `;

        if (filial.produtos && filial.produtos.length > 0) {
            filial.produtos.forEach(function(produto) {
                // Busca validacao do produto
                const validacao = validacoesFilial.find(v => v.codigo === produto.nosso_codigo);
                const divergente = validacao?.divergente || false;
                const precoTabela = validacao?.preco_tabela;
                const difPercentual = validacao?.diferenca_percentual || 0;

                const nossoCodigoClass = produto.nosso_codigo ? '' : 'text-danger';
                const nossoCodigoText = produto.nosso_codigo || '<i class="fas fa-exclamation-triangle"></i> Sem De-Para';

                // Usa nossa descrição quando disponível, senão usa descrição do PDF
                const descricaoExibir = produto.nossa_descricao || produto.descricao || '';

                const rowClass = divergente ? 'table-danger' : (produto.nosso_codigo ? '' : 'table-warning');

                // Campo de preço final - editável para divergentes, texto para os demais
                let vlrFinalHtml;
                if (divergente) {
                    vlrFinalHtml = `
                        <input type="number" step="0.01" min="0"
                            class="form-control form-control-sm preco-editavel-filial text-end"
                            style="width: 90px;"
                            data-cnpj="${filial.cnpj}"
                            data-codigo="${produto.codigo}"
                            data-preco-original="${produto.valor_unitario}"
                            value="${produto.valor_unitario || 0}"
                            onchange="atualizarPrecoFilial(this)">
                    `;
                } else {
                    vlrFinalHtml = `R$ ${formatMoney(produto.valor_unitario || 0)}`;
                }

                cardHtml += `
                    <tr class="${rowClass}">
                        <td><span class="badge bg-secondary">${produto.codigo || ''}</span></td>
                        <td class="${nossoCodigoClass}"><strong>${nossoCodigoText}</strong></td>
                        <td>${descricaoExibir}</td>
                        <td class="text-end">${produto.quantidade || 0}</td>
                        <td class="text-end">R$ ${formatMoney(produto.valor_unitario || 0)}</td>
                        <td class="text-end">${precoTabela !== null && precoTabela !== undefined ? 'R$ ' + formatMoney(precoTabela) : '-'}</td>
                        <td class="text-end">${vlrFinalHtml}</td>
                        <td class="text-end ${divergente ? 'text-danger fw-bold' : ''}">${precoTabela !== null && precoTabela !== undefined ? (difPercentual > 0 ? '+' : '') + difPercentual.toFixed(2) + '%' : '-'}</td>
                    </tr>
                `;
            });
        }

        cardHtml += `
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="3">Total</th>
                                    <th class="text-end">${filial.quantidade || 0}</th>
                                    <th class="text-end" colspan="4">R$ ${formatMoney(filial.valor || 0)}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        `;

        return cardHtml;
    }

    // Armazena filiais para cadastro inline
    var filiaisPendentes = [];

    // Popula tabela de filiais sem De-Para com inputs para cadastro inline
    function populateFiliaisSemDepara(filiais) {
        const tbody = $('#tbodyFiliaisSemDepara');
        tbody.empty();
        filiaisPendentes = filiais || [];

        if (!filiais || filiais.length === 0) {
            tbody.append('<tr><td colspan="8" class="text-center">Nenhuma filial sem cadastro</td></tr>');
            $('#btnSalvarTodasFiliais').prop('disabled', true);
            return;
        }

        filiais.forEach(function(filial, index) {
            const row = $(`
                <tr data-index="${index}" data-numero-loja="${filial.numero_loja || ''}" data-nome-loja="${filial.nome_loja_pdf || ''}">
                    <td><strong>${filial.numero_loja || '-'}</strong></td>
                    <td>${filial.nome_loja_pdf || '-'}</td>
                    <td style="position: relative;">
                        <div class="position-relative">
                            <input type="text" class="form-control form-control-sm cnpj-input"
                                id="cnpj_${index}"
                                placeholder="Digite CNPJ ou razao social..."
                                autocomplete="off">
                            <div class="cnpj-dropdown" id="dropdown_${index}" style="display: none; max-height: 250px; overflow-y: auto;"></div>
                        </div>
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm cidade-input"
                            id="cidade_${index}" placeholder="Cidade">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm uf-input"
                            id="uf_${index}" placeholder="UF" maxlength="2" style="text-transform: uppercase;">
                    </td>
                    <td class="text-center">${filial.quantidade_itens || 0}</td>
                    <td class="text-end">R$ ${formatMoney(filial.valor_total || 0)}</td>
                    <td>
                        <button class="btn btn-sm btn-success btn-salvar-filial" data-index="${index}" title="Salvar esta filial">
                            <i class="fas fa-save"></i>
                        </button>
                        <span class="badge bg-success d-none status-salvo" id="status_${index}">
                            <i class="fas fa-check"></i>
                        </span>
                    </td>
                </tr>
            `);
            tbody.append(row);
        });

        // Configura busca de CNPJ com debounce
        let searchTimeout = null;
        $('.cnpj-input').on('input', function() {
            const input = $(this);
            const index = input.attr('id').split('_')[1];
            const query = input.val().trim();
            const dropdown = $(`#dropdown_${index}`);

            clearTimeout(searchTimeout);

            if (query.length < 3) {
                dropdown.hide().empty();
                return;
            }

            searchTimeout = setTimeout(function() {
                buscarClientes(query, index);
            }, 300);
        });

        // Fecha dropdown ao clicar fora
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.position-relative').length) {
                $('.cnpj-dropdown').hide();
            }
        });

        // Evento para salvar filial individual
        $('.btn-salvar-filial').on('click', function() {
            const index = $(this).data('index');
            salvarFilialDepara(index);
        });

        // Atualiza estado do botao "Salvar Todas"
        atualizarBotaoSalvarTodas();
    }

    // Busca clientes por CNPJ ou razao social
    function buscarClientes(query, index) {
        $.ajax({
            url: '{{ url_for("leitura_pedidos.api_buscar_clientes") }}',
            type: 'GET',
            data: { q: query },
            success: function(response) {
                const dropdown = $(`#dropdown_${index}`);
                dropdown.empty();

                if (response.success && response.clientes.length > 0) {
                    response.clientes.forEach(function(cliente) {
                        const item = $(`
                            <a class="dropdown-item" href="#"
                                data-cnpj="${cliente.cnpj}"
                                data-cidade="${cliente.cidade || ''}"
                                data-uf="${cliente.uf || ''}">
                                <strong>${formatarCnpj(cliente.cnpj)}</strong><br>
                                <small class="text-muted">${cliente.razao_social} - ${cliente.cidade || ''}/${cliente.uf || ''}</small>
                            </a>
                        `);
                        item.on('click', function(e) {
                            e.preventDefault();
                            $(`#cnpj_${index}`).val($(this).data('cnpj'));
                            $(`#cidade_${index}`).val($(this).data('cidade'));
                            $(`#uf_${index}`).val($(this).data('uf'));
                            dropdown.hide();
                            atualizarBotaoSalvarTodas();
                        });
                        dropdown.append(item);
                    });
                    dropdown.show();
                } else {
                    dropdown.append('<span class="dropdown-item text-muted">Nenhum cliente encontrado</span>');
                    dropdown.show();
                }
            },
            error: function() {
                console.error('Erro ao buscar clientes');
            }
        });
    }

    // Formata CNPJ para exibicao
    function formatarCnpj(cnpj) {
        if (!cnpj) return '-';
        cnpj = cnpj.toString().replace(/\D/g, '');
        if (cnpj.length === 14) {
            return cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
        }
        return cnpj;
    }

    // Salva uma filial De-Para
    function salvarFilialDepara(index) {
        const row = $(`tr[data-index="${index}"]`);
        const numeroLoja = row.data('numero-loja');
        const nomeLoja = row.data('nome-loja');
        const cnpj = $(`#cnpj_${index}`).val().trim();
        const cidade = $(`#cidade_${index}`).val().trim();
        const uf = $(`#uf_${index}`).val().trim().toUpperCase();

        if (!cnpj) {
            if (typeof toastr !== 'undefined') {
                toastr.warning('Informe o CNPJ para a loja ' + numeroLoja);
            } else {
                alert('Informe o CNPJ para a loja ' + numeroLoja);
            }
            return;
        }

        const btn = row.find('.btn-salvar-filial');
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

        $.ajax({
            url: '{{ url_for("leitura_pedidos.api_cadastrar_filial_depara") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                numero_loja: numeroLoja,
                nome_loja: nomeLoja,
                cnpj: cnpj,
                cidade: cidade,
                uf: uf
            }),
            success: function(response) {
                if (response.success) {
                    // Remove a linha da tabela com animacao
                    row.fadeOut(300, function() {
                        $(this).remove();

                        // Verifica se ainda ha filiais pendentes
                        const filiaisRestantes = $('#tbodyFiliaisSemDepara tr').length;
                        if (filiaisRestantes === 0) {
                            // Esconde o alerta e mostra mensagem de sucesso
                            $('#alertaFiliaisDepara').fadeOut(300);
                            if (typeof toastr !== 'undefined') {
                                toastr.info('Todas as filiais foram cadastradas! Clique em "Processar PDF" para reprocessar.');
                            }
                        }
                    });

                    if (typeof toastr !== 'undefined') {
                        toastr.success(response.message);
                    }
                } else {
                    btn.prop('disabled', false).html('<i class="fas fa-save"></i>');
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.error || 'Erro ao cadastrar filial');
                    } else {
                        alert(response.error || 'Erro ao cadastrar filial');
                    }
                }
            },
            error: function(xhr) {
                btn.prop('disabled', false).html('<i class="fas fa-save"></i>');
                const msg = xhr.responseJSON?.error || 'Erro ao cadastrar filial';
                if (typeof toastr !== 'undefined') {
                    toastr.error(msg);
                } else {
                    alert(msg);
                }
            }
        });
    }

    // Atualiza o estado do botao "Salvar Todas"
    function atualizarBotaoSalvarTodas() {
        const filiasPreenchidas = $('#tbodyFiliaisSemDepara tr').filter(function() {
            const cnpj = $(this).find('.cnpj-input').val();
            return cnpj && cnpj.trim().length > 0 && !$(this).hasClass('table-success');
        }).length;

        const totalPendentes = $('#tbodyFiliaisSemDepara tr:not(.table-success)').length;

        if (filiasPreenchidas > 0 && filiasPreenchidas === totalPendentes) {
            $('#btnSalvarTodasFiliais').prop('disabled', false);
        } else {
            $('#btnSalvarTodasFiliais').prop('disabled', true);
        }
    }

    // Salva todas as filiais de uma vez
    $('#btnSalvarTodasFiliais').on('click', function() {
        const btn = $(this);
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Salvando...');

        const rows = $('#tbodyFiliaisSemDepara tr:not(.table-success)');
        let salvos = 0;
        let erros = 0;
        const total = rows.length;

        rows.each(function() {
            const index = $(this).data('index');
            const numeroLoja = $(this).data('numero-loja');
            const nomeLoja = $(this).data('nome-loja');
            const cnpj = $(`#cnpj_${index}`).val().trim();
            const cidade = $(`#cidade_${index}`).val().trim();
            const uf = $(`#uf_${index}`).val().trim().toUpperCase();

            if (!cnpj) {
                erros++;
                verificarConclusao();
                return;
            }

            $.ajax({
                url: '{{ url_for("leitura_pedidos.api_cadastrar_filial_depara") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    numero_loja: numeroLoja,
                    nome_loja: nomeLoja,
                    cnpj: cnpj,
                    cidade: cidade,
                    uf: uf
                }),
                success: function(response) {
                    if (response.success) {
                        salvos++;
                        // Remove a linha com animacao
                        $(`tr[data-index="${index}"]`).fadeOut(300, function() {
                            $(this).remove();
                        });
                    } else {
                        erros++;
                    }
                    verificarConclusao();
                },
                error: function() {
                    erros++;
                    verificarConclusao();
                }
            });
        });

        function verificarConclusao() {
            if (salvos + erros === total) {
                if (erros === 0) {
                    btn.html('<i class="fas fa-check"></i> Todas Salvas!');
                    // Esconde o alerta apos um breve delay para a animacao das linhas
                    setTimeout(function() {
                        $('#alertaFiliaisDepara').fadeOut(300);
                    }, 500);
                    if (typeof toastr !== 'undefined') {
                        toastr.success('Todas as filiais foram cadastradas! Clique em "Processar PDF" para reprocessar.');
                    }
                } else {
                    btn.prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Todas e Reprocessar');
                    if (typeof toastr !== 'undefined') {
                        toastr.warning(`${salvos} salvas, ${erros} com erro`);
                    }
                }
            }
        }
    });

    function populateDeParaModal(itens, rede) {
        const tbody = $('#deparaBody');
        tbody.empty();

        itens.forEach(function(item, index) {
            tbody.append(`
                <tr>
                    <td>
                        <strong>${item.codigo_rede}</strong>
                    </td>
                    <td>${item.descricao || '-'}</td>
                    <td>
                        <input type="text" class="form-control form-control-sm nosso-codigo-input"
                            id="nosso_codigo_${index}" data-codigo-rede="${item.codigo_rede}"
                            data-descricao="${item.descricao}" data-rede="${rede}"
                            placeholder="Digite nosso codigo">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-success btn-salvar-depara" data-index="${index}">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="btn btn-sm btn-info btn-validar-odoo" data-index="${index}">
                            <i class="fas fa-check"></i>
                        </button>
                    </td>
                </tr>
            `);
        });

        // Evento para salvar De-Para
        $('.btn-salvar-depara').off('click').on('click', function() {
            const index = $(this).data('index');
            const input = $(`#nosso_codigo_${index}`);
            const codigoNosso = input.val().trim();
            const codigoRede = input.data('codigo-rede');
            const descricao = input.data('descricao');
            const rede = input.data('rede');

            if (!codigoNosso) {
                alert('Digite nosso codigo');
                return;
            }

            salvarDepara(codigoRede, codigoNosso, descricao, rede, $(this));
        });

        // Evento para validar no Odoo
        $('.btn-validar-odoo').off('click').on('click', function() {
            const index = $(this).data('index');
            const input = $(`#nosso_codigo_${index}`);
            const codigo = input.val().trim();

            if (!codigo) {
                alert('Digite nosso codigo para validar');
                return;
            }

            validarProdutoOdoo(codigo, $(this));
        });
    }

    function salvarDepara(codigoRede, codigoNosso, descricao, rede, btn) {
        const originalHtml = btn.html();
        btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

        $.ajax({
            url: '{{ url_for("leitura_pedidos.criar_depara") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                codigo_rede: codigoRede,
                codigo_nosso: codigoNosso,
                descricao_rede: descricao,
                rede: rede
            }),
            success: function(response) {
                if (response.success) {
                    btn.html('<i class="fas fa-check"></i>').removeClass('btn-success').addClass('btn-secondary');
                    if (typeof toastr !== 'undefined') {
                        toastr.success('De-Para salvo com sucesso!');
                    } else {
                        alert('De-Para salvo com sucesso!');
                    }
                } else {
                    btn.html(originalHtml).prop('disabled', false);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.error || 'Erro ao salvar De-Para');
                    } else {
                        alert(response.error || 'Erro ao salvar De-Para');
                    }
                }
            },
            error: function(xhr) {
                btn.html(originalHtml).prop('disabled', false);
                if (typeof toastr !== 'undefined') {
                    toastr.error('Erro ao salvar De-Para');
                } else {
                    alert('Erro ao salvar De-Para');
                }
            }
        });
    }

    function validarProdutoOdoo(codigo, btn) {
        const originalHtml = btn.html();
        btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

        $.ajax({
            url: '{{ url_for("leitura_pedidos.validar_produto_odoo") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ codigo: codigo }),
            success: function(response) {
                btn.html(originalHtml).prop('disabled', false);
                if (response.existe) {
                    if (typeof toastr !== 'undefined') {
                        toastr.success(`Produto ${codigo} encontrado no Odoo (ID: ${response.product_id})`);
                    } else {
                        alert(`Produto ${codigo} encontrado no Odoo (ID: ${response.product_id})`);
                    }
                } else {
                    if (typeof toastr !== 'undefined') {
                        toastr.warning(`Produto ${codigo} NAO encontrado no Odoo`);
                    } else {
                        alert(`Produto ${codigo} NAO encontrado no Odoo`);
                    }
                }
            },
            error: function(xhr) {
                btn.html(originalHtml).prop('disabled', false);
                if (typeof toastr !== 'undefined') {
                    toastr.error('Erro ao validar produto');
                } else {
                    alert('Erro ao validar produto');
                }
            }
        });
    }

    window.abrirModalDepara = function() {
        $('#modalDepara').modal('show');
    };

    window.reprocessarDados = function() {
        if (!currentSessionKey) return;

        $.ajax({
            url: '{{ url_for("leitura_pedidos.reprocessar") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ session_key: currentSessionKey }),
            success: function(response) {
                if (response.success) {
                    currentResponse.summary = response.summary;
                    currentResponse.itens_sem_depara = response.itens_sem_depara;
                    currentResponse.pode_inserir = response.pode_inserir;

                    // Atualiza interface
                    if (response.itens_sem_depara.length === 0) {
                        $('#alertaDepara').hide();
                        $('#btnInserirOdoo').prop('disabled', false);
                        $('#modalDepara').modal('hide');
                        if (typeof toastr !== 'undefined') {
                            toastr.success('Todos os itens agora possuem De-Para!');
                        } else {
                            alert('Todos os itens agora possuem De-Para!');
                        }
                    } else {
                        populateDeParaModal(response.itens_sem_depara, currentResponse.identificacao?.rede || 'ATACADAO');
                        if (typeof toastr !== 'undefined') {
                            toastr.info(`Ainda restam ${response.itens_sem_depara.length} itens sem De-Para`);
                        }
                    }

                    // Atualiza cards
                    showResults(currentResponse);
                }
            },
            error: function() {
                if (typeof toastr !== 'undefined') {
                    toastr.error('Erro ao reprocessar dados');
                } else {
                    alert('Erro ao reprocessar dados');
                }
            }
        });
    };

    // Evento para botoes de inserir filial individual (delegado)
    $(document).on('click', '.btn-inserir-filial', function() {
        if (!currentSessionKey) return;

        const btn = $(this);
        const cnpj = btn.data('cnpj');
        const nome = btn.data('nome');
        const temDivergencia = btn.data('tem-divergencia') === true || btn.data('tem-divergencia') === 'true';
        const cnpjSafe = cnpj.replace(/[^0-9]/g, '');

        // Verifica justificativa para filiais com divergencia
        let justificativa = '';
        if (temDivergencia) {
            justificativa = $(`#justificativa-${cnpjSafe}`).val() || '';
            if (!justificativa.trim()) {
                if (typeof toastr !== 'undefined') {
                    toastr.error('Informe a justificativa para aprovar esta filial com divergencia');
                } else {
                    alert('Informe a justificativa para aprovar esta filial com divergencia');
                }
                $(`#justificativa-${cnpjSafe}`).focus();
                return;
            }
        }

        const originalHtml = btn.html();
        btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

        // Prepara justificativas por filial
        const justificativasPorFilial = {};
        if (justificativa) {
            justificativasPorFilial[cnpj] = justificativa;
        }

        $.ajax({
            url: '{{ url_for("leitura_pedidos.inserir_odoo") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                session_key: currentSessionKey,
                cnpj_filial: cnpj,
                justificativas_por_filial: justificativasPorFilial
            }),
            success: function(response) {
                const resultado = response.resultados && response.resultados[0];
                if (resultado && resultado.sucesso) {
                    btn.html('<i class="fas fa-check"></i> Inserido').removeClass('btn-light').addClass('btn-success').prop('disabled', true);
                    $(`#status-filial-${cnpjSafe}`).html(`<span class="badge bg-success">${resultado.order_name}</span>`).show();
                    if (typeof toastr !== 'undefined') {
                        toastr.success(`Pedido ${resultado.order_name} criado para ${nome}`);
                    }
                } else {
                    btn.html(originalHtml).prop('disabled', false);
                    const erro = resultado?.mensagem || response.error || 'Erro ao inserir';
                    $(`#status-filial-${cnpjSafe}`).html(`<span class="badge bg-danger">Erro</span>`).show();
                    if (typeof toastr !== 'undefined') {
                        toastr.error(erro);
                    } else {
                        alert(erro);
                    }
                }
            },
            error: function(xhr) {
                btn.html(originalHtml).prop('disabled', false);
                const resp = xhr.responseJSON || {};
                $(`#status-filial-${cnpjSafe}`).html(`<span class="badge bg-danger">Erro</span>`).show();
                if (typeof toastr !== 'undefined') {
                    toastr.error(resp.error || 'Erro ao inserir no Odoo');
                } else {
                    alert(resp.error || 'Erro ao inserir no Odoo');
                }
            }
        });
    });

    // Inserir TODOS no Odoo (com progresso)
    $('#btnInserirTodosOdoo').on('click', function() {
        if (!currentSessionKey) return;
        if (!currentResponse || !currentResponse.summary || !currentResponse.summary.por_filial) return;

        const filiais = currentResponse.summary.por_filial;
        const filiaisParaInserir = filiais.filter(f => (f.sem_depara || 0) === 0);

        if (filiaisParaInserir.length === 0) {
            if (typeof toastr !== 'undefined') {
                toastr.warning('Nenhuma filial disponivel para inserir');
            } else {
                alert('Nenhuma filial disponivel para inserir');
            }
            return;
        }

        // Coleta justificativas por filial
        const justificativasPorFilial = {};
        let faltaJustificativa = false;

        filiaisParaInserir.forEach(function(filial) {
            const cnpjSafe = filial.cnpj.replace(/[^0-9]/g, '');
            const $textarea = $(`#justificativa-${cnpjSafe}`);
            if ($textarea.length > 0) {
                const justificativa = $textarea.val() || '';
                if (!justificativa.trim()) {
                    faltaJustificativa = true;
                    $textarea.addClass('is-invalid');
                } else {
                    justificativasPorFilial[filial.cnpj] = justificativa;
                    $textarea.removeClass('is-invalid');
                }
            }
        });

        if (faltaJustificativa) {
            if (typeof toastr !== 'undefined') {
                toastr.error('Preencha todas as justificativas para filiais com divergencia');
            } else {
                alert('Preencha todas as justificativas para filiais com divergencia');
            }
            return;
        }

        // Mostra progresso
        const btn = $(this);
        const originalHtml = btn.html();
        btn.html('<i class="fas fa-spinner fa-spin"></i> Inserindo...').prop('disabled', true);

        $('#progressArea').show();
        $('#progressBar').css('width', '0%');
        $('#progressPercent').text('0%');
        $('#progressText').text('Iniciando insercao...');

        // Insere filiais uma a uma para mostrar progresso
        inserirFiliaisSequencialmente(filiaisParaInserir, justificativasPorFilial, 0, [], function(resultados) {
            btn.html(originalHtml).prop('disabled', false);
            $('#progressArea').hide();
            showResultadoOdoo({
                success: resultados.some(r => r.sucesso),
                todos_sucesso: resultados.every(r => r.sucesso),
                resultados: resultados
            });
        });
    });

    function inserirFiliaisSequencialmente(filiais, justificativas, index, resultados, callback) {
        if (index >= filiais.length) {
            callback(resultados);
            return;
        }

        const filial = filiais[index];
        const cnpj = filial.cnpj;
        const cnpjSafe = cnpj.replace(/[^0-9]/g, '');
        const total = filiais.length;
        const atual = index + 1;
        const percent = Math.round((atual / total) * 100);

        // Atualiza progresso
        $('#progressBar').css('width', percent + '%');
        $('#progressPercent').text(percent + '%');
        $('#progressText').text(`Inserindo filial ${atual} de ${total}...`);
        $('#progressDetail').text(`${filial.nome_cliente || 'Cliente'} - ${cnpj}`);

        // Marca botao como processando
        const btn = $(`.btn-inserir-filial[data-cnpj="${cnpj}"]`);
        btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

        const justificativasPorFilial = {};
        if (justificativas[cnpj]) {
            justificativasPorFilial[cnpj] = justificativas[cnpj];
        }

        $.ajax({
            url: '{{ url_for("leitura_pedidos.inserir_odoo") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                session_key: currentSessionKey,
                cnpj_filial: cnpj,
                justificativas_por_filial: justificativasPorFilial
            }),
            success: function(response) {
                const resultado = response.resultados && response.resultados[0];
                if (resultado) {
                    resultados.push(resultado);
                    if (resultado.sucesso) {
                        btn.html('<i class="fas fa-check"></i>').removeClass('btn-light').addClass('btn-success');
                        $(`#status-filial-${cnpjSafe}`).html(`<span class="badge bg-success">${resultado.order_name}</span>`).show();
                    } else {
                        btn.html('<i class="fas fa-times"></i>').removeClass('btn-light').addClass('btn-danger');
                        $(`#status-filial-${cnpjSafe}`).html(`<span class="badge bg-danger">Erro</span>`).show();
                    }
                }
                // Proximo
                setTimeout(function() {
                    inserirFiliaisSequencialmente(filiais, justificativas, index + 1, resultados, callback);
                }, 300);
            },
            error: function(xhr) {
                const resp = xhr.responseJSON || {};
                resultados.push({
                    cnpj: cnpj,
                    nome_cliente: filial.nome_cliente,
                    sucesso: false,
                    mensagem: resp.error || 'Erro de conexao'
                });
                btn.html('<i class="fas fa-times"></i>').removeClass('btn-light').addClass('btn-danger');
                $(`#status-filial-${cnpjSafe}`).html(`<span class="badge bg-danger">Erro</span>`).show();

                // Proximo
                setTimeout(function() {
                    inserirFiliaisSequencialmente(filiais, justificativas, index + 1, resultados, callback);
                }, 300);
            }
        });
    }

    function showResultadoOdoo(response) {
        const modal = $('#modalResultadoOdoo');
        const header = $('#modalResultadoHeader');
        const body = $('#modalResultadoBody');

        if (response.todos_sucesso) {
            header.removeClass('bg-danger bg-warning').addClass('bg-success text-white');
        } else if (response.success) {
            header.removeClass('bg-danger bg-success').addClass('bg-warning');
        } else {
            header.removeClass('bg-success bg-warning').addClass('bg-danger text-white');
        }

        let html = '<table class="table table-sm"><thead><tr><th>Cliente</th><th>Resultado</th><th>Pedido</th></tr></thead><tbody>';

        response.resultados.forEach(function(r) {
            const statusClass = r.sucesso ? 'table-success' : 'table-danger';
            html += `
                <tr class="${statusClass}">
                    <td>
                        <strong>${r.nome_cliente || 'N/A'}</strong><br>
                        <small>${r.cnpj}</small>
                    </td>
                    <td>
                        ${r.sucesso ? '<i class="fas fa-check text-success"></i> Sucesso' : '<i class="fas fa-times text-danger"></i> Erro'}
                        <br><small>${r.mensagem}</small>
                    </td>
                    <td>
                        ${r.order_name ? `<strong>${r.order_name}</strong><br><small>ID: ${r.order_id}</small>` : '-'}
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        body.html(html);
        modal.modal('show');
    }

    function showErrors(errors) {
        const errorList = $('#errorList');
        errorList.empty();
        errors.forEach(function(error) {
            errorList.append(`<li>${error}</li>`);
        });
        $('#errorArea').show();
    }

    function showWarnings(warnings) {
        const warningList = $('#warningList');
        warningList.empty();
        warnings.forEach(function(warning) {
            warningList.append(`<li>${warning}</li>`);
        });
        $('#warningArea').show();
    }

    function formatMoney(value) {
        return new Intl.NumberFormat('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }

    // Export Excel
    $('#btnExportExcel').on('click', function() {
        if (currentSessionKey) {
            window.location.href = `{{ url_for("leitura_pedidos.export", format="excel", session_key="") }}${currentSessionKey}`;
        }
    });

    // Export CSV
    $('#btnExportCSV').on('click', function() {
        if (currentSessionKey) {
            window.location.href = `{{ url_for("leitura_pedidos.export", format="csv", session_key="") }}${currentSessionKey}`;
        }
    });

    // ============================================================================
    // NOVAS FUNCOES - Divergencias Agregadas e Edicao de Preco
    // ============================================================================

    // Popula tabela de divergencias agregadas
    function popularTabelaDivergenciasAgregadas(divergenciasAgregadas) {
        const tbody = $('#tbodyDivergenciasAgregadas');
        tbody.empty();

        if (!divergenciasAgregadas || divergenciasAgregadas.length === 0) {
            tbody.append('<tr><td colspan="10" class="text-center">Nenhuma divergencia encontrada</td></tr>');
            return;
        }

        divergenciasAgregadas.forEach(function(filial) {
            const cnpjSafe = filial.cnpj.replace(/[^0-9]/g, '');

            filial.itens_divergentes.forEach(function(item, itemIndex) {
                const rowId = `div_${cnpjSafe}_${item.codigo_rede}`;
                const diferencaClass = item.diferenca_percentual > 0 ? 'text-danger' : 'text-success';
                const diferencaPrefix = item.diferenca_percentual > 0 ? '+' : '';

                let html = `
                    <tr id="${rowId}" data-cnpj="${filial.cnpj}" data-codigo="${item.codigo_rede}">
                        ${itemIndex === 0 ? `
                        <td rowspan="${filial.itens_divergentes.length}">
                            <strong>${filial.nome_cliente}</strong><br>
                            <small class="text-muted">${filial.cnpj}</small>
                        </td>
                        <td rowspan="${filial.itens_divergentes.length}">
                            <span class="badge bg-secondary">${filial.uf}</span>
                        </td>
                        ` : ''}
                        <td><code>${item.codigo_rede}</code></td>
                        <td><code>${item.nosso_codigo || '-'}</code></td>
                        <td><small>${item.descricao || item.nossa_descricao || '-'}</small></td>
                        <td class="text-end">${item.quantidade}</td>
                        <td class="text-end">R$ ${formatMoney(item.preco_documento)}</td>
                        <td class="text-end">R$ ${formatMoney(item.preco_tabela || 0)}</td>
                        <td class="text-end">
                            <input type="number" step="0.01" min="0"
                                class="form-control form-control-sm preco-editavel text-end"
                                style="width: 100px;"
                                data-cnpj="${filial.cnpj}"
                                data-codigo="${item.codigo_rede}"
                                data-preco-original="${item.preco_documento}"
                                value="${item.preco_final || item.preco_documento}"
                                onchange="atualizarPreco(this)">
                        </td>
                        <td class="text-end ${diferencaClass}">
                            <strong>${diferencaPrefix}${(item.diferenca_percentual || 0).toFixed(1)}%</strong>
                        </td>
                    </tr>
                `;
                tbody.append(html);
            });
        });
    }

    // Atualiza preco via AJAX
    window.atualizarPreco = function(input) {
        const cnpj = $(input).data('cnpj');
        const codigoRede = $(input).data('codigo');
        const novoPreco = parseFloat($(input).val()) || 0;
        const precoOriginal = parseFloat($(input).data('preco-original')) || 0;

        if (novoPreco <= 0) {
            alert('Preco deve ser maior que zero');
            $(input).val(precoOriginal);
            return;
        }

        // Desabilita input enquanto salva
        $(input).prop('disabled', true);

        $.ajax({
            url: '{{ url_for("leitura_pedidos.editar_preco") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                session_key: currentSessionKey,
                cnpj: cnpj,
                codigo_rede: codigoRede,
                novo_preco: novoPreco
            }),
            success: function(response) {
                if (response.success) {
                    // Atualiza estilo do input para indicar alteracao
                    if (Math.abs(novoPreco - precoOriginal) > 0.01) {
                        $(input).addClass('bg-warning-subtle');
                    } else {
                        $(input).removeClass('bg-warning-subtle');
                    }

                    // Sincroniza com input na tabela da filial (se existir)
                    sincronizarPrecoFilial(cnpj, codigoRede, novoPreco);

                    // Feedback visual
                    $(input).addClass('border-success').delay(1000).queue(function(){
                        $(this).removeClass('border-success').dequeue();
                    });
                } else {
                    alert('Erro ao atualizar preco: ' + response.error);
                    $(input).val(precoOriginal);
                }
            },
            error: function(xhr) {
                const resp = xhr.responseJSON || {};
                const msg = resp.error || xhr.statusText || 'Erro desconhecido';
                console.error('Erro ao atualizar preco:', xhr.status, msg, xhr);
                alert('Erro ao atualizar preco: ' + msg + ' (Status: ' + xhr.status + ')');
                $(input).val(precoOriginal);
            },
            complete: function() {
                $(input).prop('disabled', false);
            }
        });
    };

    // Sincroniza preco da area de divergencias para tabela da filial
    function sincronizarPrecoFilial(cnpj, codigoRede, novoPreco) {
        const inputFilial = $(`.preco-editavel-filial[data-cnpj="${cnpj}"][data-codigo="${codigoRede}"]`);
        if (inputFilial.length > 0 && parseFloat(inputFilial.val()) !== novoPreco) {
            inputFilial.val(novoPreco.toFixed(2));
            inputFilial.addClass('bg-warning-subtle');
        }
    }

    // Sincroniza preco da tabela da filial para area de divergencias
    function sincronizarPrecoDivergencias(cnpj, codigoRede, novoPreco) {
        const inputDivergencia = $(`.preco-editavel[data-cnpj="${cnpj}"][data-codigo="${codigoRede}"]`);
        if (inputDivergencia.length > 0 && parseFloat(inputDivergencia.val()) !== novoPreco) {
            inputDivergencia.val(novoPreco.toFixed(2));
            inputDivergencia.addClass('bg-warning-subtle');
        }
    }

    // Atualiza preco a partir da tabela da filial (sincroniza com divergencias)
    window.atualizarPrecoFilial = function(input) {
        const cnpj = $(input).data('cnpj');
        const codigoRede = $(input).data('codigo');
        const novoPreco = parseFloat($(input).val()) || 0;
        const precoOriginal = parseFloat($(input).data('preco-original')) || 0;

        if (novoPreco <= 0) {
            alert('Preco deve ser maior que zero');
            $(input).val(precoOriginal);
            return;
        }

        // Desabilita input enquanto salva
        $(input).prop('disabled', true);

        $.ajax({
            url: '{{ url_for("leitura_pedidos.editar_preco") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                session_key: currentSessionKey,
                cnpj: cnpj,
                codigo_rede: codigoRede,
                novo_preco: novoPreco
            }),
            success: function(response) {
                if (response.success) {
                    // Atualiza estilo do input para indicar alteracao
                    if (Math.abs(novoPreco - precoOriginal) > 0.01) {
                        $(input).addClass('bg-warning-subtle');
                    } else {
                        $(input).removeClass('bg-warning-subtle');
                    }

                    // Sincroniza com input na area de divergencias
                    sincronizarPrecoDivergencias(cnpj, codigoRede, novoPreco);

                    // Feedback visual
                    $(input).addClass('border-success').delay(1000).queue(function(){
                        $(this).removeClass('border-success').dequeue();
                    });
                } else {
                    alert('Erro ao atualizar preco: ' + response.error);
                    $(input).val(precoOriginal);
                }
            },
            error: function(xhr) {
                const resp = xhr.responseJSON || {};
                const msg = resp.error || xhr.statusText || 'Erro desconhecido';
                console.error('Erro ao atualizar preco (filial):', xhr.status, msg, xhr);
                alert('Erro ao atualizar preco: ' + msg + ' (Status: ' + xhr.status + ')');
                $(input).val(precoOriginal);
            },
            complete: function() {
                $(input).prop('disabled', false);
            }
        });
    };

    // Aplicar justificativa global
    $('#btnAplicarJustificativaGlobal').on('click', function() {
        const justificativa = $('#justificativaGlobal').val().trim();

        if (!justificativa) {
            alert('Por favor, informe uma justificativa');
            return;
        }

        if (!currentSessionKey) {
            alert('Sessao expirada. Recarregue a pagina e processe o arquivo novamente.');
            return;
        }

        const btn = $(this);
        const originalText = btn.html();
        btn.html('<i class="fas fa-spinner fa-spin"></i> Aplicando...').prop('disabled', true);

        $.ajax({
            url: '{{ url_for("leitura_pedidos.aplicar_justificativa_global") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                session_key: currentSessionKey,
                justificativa: justificativa
            }),
            success: function(response) {
                if (response.success) {
                    alert(response.message);

                    // Preenche campo de justificativa em todas as filiais divergentes
                    $('.justificativa-filial').each(function() {
                        const card = $(this).closest('.card');
                        if (card.hasClass('border-danger') || card.find('.badge-danger').length > 0) {
                            $(this).val(justificativa);
                        }
                    });

                    // Feedback visual
                    $('#justificativaGlobal').addClass('border-success');
                    setTimeout(function() {
                        $('#justificativaGlobal').removeClass('border-success');
                    }, 2000);
                } else {
                    alert('Erro: ' + response.error);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON || {};
                alert('Erro ao aplicar justificativa: ' + (response.error || 'Erro desconhecido'));
            },
            complete: function() {
                btn.html(originalText).prop('disabled', false);
            }
        });
    });

    // ============================================================================
    // FIM NOVAS FUNCOES
    // ============================================================================
});
</script>

{% endblock %}
