{% extends "base.html" %}

{% block title %}Auditoria de Lançamentos Odoo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-clipboard-check"></i> Auditoria de Lançamentos Odoo
            </h1>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosAuditoria"
                    aria-expanded="true">
                    <i class="fas fa-filter"></i> Filtros
                </button>
            </h5>
        </div>
        <div class="collapse show" id="filtrosAuditoria">
            <div class="card-body">
                <form method="GET">
                    <div class="row">
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-control">
                                <option value="">Todos</option>
                                <option value="SUCESSO" {% if filtro_status == 'SUCESSO' %}selected{% endif %}>Sucesso</option>
                                <option value="ERRO" {% if filtro_status == 'ERRO' %}selected{% endif %}>Com Erro</option>
                                <option value="INCOMPLETO" {% if filtro_status == 'INCOMPLETO' %}selected{% endif %}>Incompleto</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Tipo</label>
                            <select name="tipo" class="form-control">
                                <option value="">Todos</option>
                                <option value="frete" {% if filtro_tipo == 'frete' %}selected{% endif %}>Frete</option>
                                <option value="despesa" {% if filtro_tipo == 'despesa' %}selected{% endif %}>Despesa Extra</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Data Início</label>
                            <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Data Fim</label>
                            <input type="date" name="data_fim" class="form-control" value="{{ data_fim }}">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <a href="{{ url_for('fretes.auditoria_lancamentos') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Limpar
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Jobs em Processamento (Fila Assíncrona) -->
    <div class="card mb-4 border-primary" id="cardJobsPendentes">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-sync-alt fa-spin me-2" id="iconSyncJobs"></i>
                Jobs em Processamento
                <span class="badge bg-light text-primary ms-2" id="badgeTotalJobs">0</span>
            </h5>
            <button class="btn btn-sm btn-light" onclick="carregarJobsPendentes()" title="Atualizar">
                <i class="fas fa-refresh"></i>
            </button>
        </div>
        <div class="card-body" id="containerJobsPendentes">
            <div class="text-center text-muted py-3" id="loadingJobs">
                <div class="spinner-border spinner-border-sm" role="status"></div>
                Carregando jobs...
            </div>
            <!-- Jobs serão carregados aqui via JS -->
        </div>
    </div>

    <!-- Estatísticas rápidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="text-muted mb-1">Total</h5>
                    <h3 class="mb-0">{{ total }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h5 class="mb-1">Sucesso</h5>
                    <h3 class="mb-0">{{ lancamentos | selectattr('status', 'equalto', 'SUCESSO') | list | length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h5 class="mb-1">Com Erro</h5>
                    <h3 class="mb-0">{{ lancamentos | selectattr('status', 'equalto', 'ERRO') | list | length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning">
                <div class="card-body text-center">
                    <h5 class="mb-1">Incompleto</h5>
                    <h3 class="mb-0">{{ lancamentos | selectattr('status', 'equalto', 'INCOMPLETO') | list | length }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de lançamentos -->
    <div class="card">
        <div class="card-body">
            {% if lancamentos %}
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="tabelaAuditoria">
                    <thead class="table-dark">
                        <tr>
                            <th width="40"></th>
                            <th>Tipo</th>
                            <th>CTe/Chave</th>
                            <th>Referência</th>
                            <th>Etapas</th>
                            <th>IDs Odoo</th>
                            <th>Executado</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lanc in lancamentos %}
                        <tr class="lancamento-row {% if lanc.status == 'ERRO' %}table-danger{% elif lanc.status == 'INCOMPLETO' %}table-warning{% endif %}"
                            data-chave="{{ lanc.chave_cte }}"
                            data-frete-id="{{ lanc.frete_id or '' }}"
                            data-despesa-id="{{ lanc.despesa_extra_id or '' }}">
                            <td>
                                <button class="btn btn-sm btn-outline-secondary btn-expand" type="button">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </td>
                            <td>
                                {% if lanc.tipo == 'frete' %}
                                <span class="badge bg-primary">Frete</span>
                                {% else %}
                                <span class="badge bg-info">Despesa</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ lanc.chave_cte[:20] }}...</small>
                            </td>
                            <td>
                                {% if lanc.frete and lanc.frete.cte %}
                                <strong>CTe {{ lanc.frete.cte.numero_cte }}</strong><br>
                                <small>{{ lanc.frete.transportadora.nome_curto if lanc.frete.transportadora else 'N/A' }}</small>
                                {% elif lanc.despesa and lanc.despesa.cte %}
                                <strong>CTe {{ lanc.despesa.cte.numero_cte }}</strong><br>
                                <small>{{ lanc.despesa.tipo_despesa }} - R$ {{ "%.2f"|format(lanc.despesa.valor_despesa) }}</small>
                                {% else %}
                                <small class="text-muted">N/A</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="progress" style="height: 20px; width: 100px;">
                                    <div class="progress-bar {% if lanc.status == 'SUCESSO' %}bg-success{% elif lanc.status == 'ERRO' %}bg-danger{% else %}bg-warning{% endif %}"
                                         style="width: {{ (lanc.ultima_etapa / 16 * 100)|int }}%">
                                        {{ lanc.ultima_etapa }}/16
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if lanc.dfe_id %}
                                <span class="badge bg-secondary" title="DFe ID">D:{{ lanc.dfe_id }}</span>
                                {% endif %}
                                {% if lanc.po_id %}
                                <span class="badge bg-secondary" title="PO ID">P:{{ lanc.po_id }}</span>
                                {% endif %}
                                {% if lanc.invoice_id %}
                                <span class="badge bg-secondary" title="Invoice ID">I:{{ lanc.invoice_id }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ lanc.ultimo_executado.strftime('%d/%m/%Y %H:%M') if lanc.ultimo_executado else 'N/A' }}</small><br>
                                <small class="text-muted">{{ lanc.executado_por }}</small>
                            </td>
                            <td>
                                {% if lanc.status == 'SUCESSO' %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> Sucesso</span>
                                {% elif lanc.status == 'ERRO' %}
                                <span class="badge bg-danger"><i class="fas fa-times"></i> Erro</span>
                                {% else %}
                                <span class="badge bg-warning"><i class="fas fa-clock"></i> Incompleto</span>
                                {% endif %}
                            </td>
                        </tr>
                        <!-- Linha de detalhes (oculta inicialmente) -->
                        <tr class="detalhes-row d-none" data-parent="{{ lanc.chave_cte }}">
                            <td colspan="8" class="bg-light p-3">
                                <div class="detalhes-content">
                                    <div class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        Carregando etapas...
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginação -->
            {% if total_pages > 1 %}
            <nav aria-label="Paginação">
                <ul class="pagination justify-content-center">
                    {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page - 1 }}&status={{ filtro_status }}&tipo={{ filtro_tipo }}&data_inicio={{ data_inicio }}&data_fim={{ data_fim }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                        {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ p }}&status={{ filtro_status }}&tipo={{ filtro_tipo }}&data_inicio={{ data_inicio }}&data_fim={{ data_fim }}">{{ p }}</a>
                        </li>
                        {% elif p == page - 3 or p == page + 3 %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page + 1 }}&status={{ filtro_status }}&tipo={{ filtro_tipo }}&data_inicio={{ data_inicio }}&data_fim={{ data_fim }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Nenhum lançamento encontrado com os filtros selecionados.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// =================== JOBS PENDENTES ===================
let intervalJobsPendentes = null;

function carregarJobsPendentes() {
    const container = document.getElementById('containerJobsPendentes');
    const badge = document.getElementById('badgeTotalJobs');
    const iconSync = document.getElementById('iconSyncJobs');
    const card = document.getElementById('cardJobsPendentes');

    fetch('/fretes/jobs/pendentes')
        .then(response => response.json())
        .then(data => {
            if (!data.sucesso) {
                container.innerHTML = `<div class="alert alert-danger mb-0">${data.erro}</div>`;
                return;
            }

            const total = data.total_pendentes + data.total_processando;
            badge.textContent = total;

            // Esconder card se não houver jobs
            if (total === 0 && data.total_falhados === 0) {
                card.classList.add('d-none');
                iconSync.classList.remove('fa-spin');
                return;
            }

            card.classList.remove('d-none');
            iconSync.classList.add('fa-spin');

            let html = '';

            // Jobs em processamento
            if (data.jobs_processando.length > 0) {
                html += '<div class="mb-3">';
                html += '<h6 class="text-success"><i class="fas fa-cog fa-spin me-1"></i> Em Processamento</h6>';
                html += '<div class="accordion" id="accordionProcessando">';
                data.jobs_processando.forEach((job, idx) => {
                    html += renderJobAccordion(job, 'processando', idx);
                });
                html += '</div></div>';
            }

            // Jobs na fila
            if (data.jobs_pendentes.length > 0) {
                html += '<div class="mb-3">';
                html += '<h6 class="text-primary"><i class="fas fa-hourglass-half me-1"></i> Na Fila</h6>';
                html += '<div class="accordion" id="accordionPendentes">';
                data.jobs_pendentes.forEach((job, idx) => {
                    html += renderJobAccordion(job, 'pendente', idx);
                });
                html += '</div></div>';
            }

            // Jobs falhados
            if (data.jobs_falhados.length > 0) {
                html += '<div class="mb-3">';
                html += '<h6 class="text-danger"><i class="fas fa-times-circle me-1"></i> Falhados Recentemente</h6>';
                html += '<div class="accordion" id="accordionFalhados">';
                data.jobs_falhados.forEach((job, idx) => {
                    html += renderJobAccordion(job, 'falhado', idx);
                });
                html += '</div></div>';
            }

            if (html === '') {
                html = '<div class="text-center text-muted py-2"><i class="fas fa-check-circle text-success"></i> Nenhum job em processamento</div>';
                iconSync.classList.remove('fa-spin');
            }

            container.innerHTML = html;

            // Se tem jobs em processamento, atualizar a cada 3 segundos
            if (data.total_processando > 0 || data.total_pendentes > 0) {
                if (!intervalJobsPendentes) {
                    intervalJobsPendentes = setInterval(carregarJobsPendentes, 3000);
                }
            } else {
                if (intervalJobsPendentes) {
                    clearInterval(intervalJobsPendentes);
                    intervalJobsPendentes = null;
                }
            }
        })
        .catch(error => {
            container.innerHTML = `<div class="alert alert-warning mb-0">Erro ao carregar jobs: ${error}</div>`;
        });
}

function renderJobAccordion(job, tipo, idx) {
    const tipoLabel = job.args?.tipo || 'job';
    const id = job.args?.frete_id || job.args?.despesa_id || job.args?.fatura_id || job.job_id;

    let badgeClass = 'bg-primary';
    let badgeIcon = 'hourglass-half';
    if (tipo === 'processando') {
        badgeClass = 'bg-success';
        badgeIcon = 'cog fa-spin';
    } else if (tipo === 'falhado') {
        badgeClass = 'bg-danger';
        badgeIcon = 'times';
    }

    let tipoIcone = 'file-invoice';
    let tipoBadge = 'secondary';
    if (tipoLabel === 'frete') {
        tipoIcone = 'truck';
        tipoBadge = 'primary';
    } else if (tipoLabel === 'despesa') {
        tipoIcone = 'receipt';
        tipoBadge = 'info';
    } else if (tipoLabel === 'lote') {
        tipoIcone = 'layer-group';
        tipoBadge = 'warning';
    }

    const createdAt = job.created_at ? new Date(job.created_at).toLocaleString('pt-BR') : '-';
    const startedAt = job.started_at ? new Date(job.started_at).toLocaleString('pt-BR') : null;

    let html = `
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#job${tipo}${idx}">
                <span class="badge ${badgeClass} me-2"><i class="fas fa-${badgeIcon}"></i></span>
                <span class="badge bg-${tipoBadge} me-2"><i class="fas fa-${tipoIcone}"></i> ${tipoLabel.toUpperCase()}</span>
                <span class="me-2">#${id}</span>
                <small class="text-muted">por ${job.args?.usuario || 'N/A'}</small>
            </button>
        </h2>
        <div id="job${tipo}${idx}" class="accordion-collapse collapse">
            <div class="accordion-body py-2">
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">Job ID:</small> <code>${job.job_id}</code><br>
                        <small class="text-muted">Criado:</small> ${createdAt}
                        ${startedAt ? `<br><small class="text-muted">Iniciado:</small> ${startedAt}` : ''}
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">Status:</small> <span class="badge ${badgeClass}">${job.status_display}</span>
                        ${job.error ? `<br><small class="text-danger">${job.error}</small>` : ''}
                    </div>
                </div>
            </div>
        </div>
    </div>`;

    return html;
}

// =================== DETALHES DE LANÇAMENTOS ===================
document.addEventListener('DOMContentLoaded', function() {
    // Carregar jobs pendentes ao iniciar
    carregarJobsPendentes();

    // Expandir/recolher detalhes
    document.querySelectorAll('.btn-expand').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            const chave = row.dataset.chave;
            const freteId = row.dataset.freteId;
            const despesaId = row.dataset.despesaId;
            const detalhesRow = document.querySelector(`.detalhes-row[data-parent="${chave}"]`);
            const icon = this.querySelector('i');

            if (detalhesRow.classList.contains('d-none')) {
                // Expandir
                detalhesRow.classList.remove('d-none');
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');

                // Carregar detalhes via AJAX
                let url = `/fretes/api/auditoria-lancamentos/${chave}`;
                if (freteId) url += `?frete_id=${freteId}`;
                else if (despesaId) url += `?despesa_id=${despesaId}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const content = detalhesRow.querySelector('.detalhes-content');
                        if (data.etapas && data.etapas.length > 0) {
                            let html = '<div class="table-responsive"><table class="table table-sm table-bordered mb-0">';
                            html += '<thead><tr><th>Etapa</th><th>Descrição</th><th>Modelo</th><th>Ação</th><th>Status</th><th>Tempo</th><th>Mensagem</th></tr></thead>';
                            html += '<tbody>';
                            data.etapas.forEach(function(etapa) {
                                const statusClass = etapa.status === 'SUCESSO' ? 'table-success' : (etapa.status === 'ERRO' ? 'table-danger' : '');
                                html += `<tr class="${statusClass}">`;
                                html += `<td><strong>${etapa.etapa}</strong></td>`;
                                html += `<td>${etapa.etapa_descricao}</td>`;
                                html += `<td><small>${etapa.modelo_odoo}</small></td>`;
                                html += `<td><small>${etapa.acao}${etapa.metodo_odoo ? ' / ' + etapa.metodo_odoo : ''}</small></td>`;
                                html += `<td>`;
                                if (etapa.status === 'SUCESSO') {
                                    html += '<span class="badge bg-success">OK</span>';
                                } else if (etapa.status === 'ERRO') {
                                    html += '<span class="badge bg-danger">ERRO</span>';
                                } else {
                                    html += `<span class="badge bg-secondary">${etapa.status}</span>`;
                                }
                                html += `</td>`;
                                html += `<td>${etapa.tempo_execucao_ms ? etapa.tempo_execucao_ms + 'ms' : '-'}</td>`;
                                html += `<td>`;
                                if (etapa.mensagem) {
                                    html += `<small>${etapa.mensagem.substring(0, 100)}${etapa.mensagem.length > 100 ? '...' : ''}</small>`;
                                }
                                if (etapa.erro_detalhado) {
                                    html += `<br><small class="text-danger">${etapa.erro_detalhado.substring(0, 200)}...</small>`;
                                }
                                html += `</td>`;
                                html += '</tr>';
                            });
                            html += '</tbody></table></div>';

                            // IDs do Odoo
                            const lastEtapa = data.etapas[data.etapas.length - 1];
                            if (lastEtapa.dfe_id || lastEtapa.purchase_order_id || lastEtapa.invoice_id) {
                                html += '<div class="mt-2">';
                                html += '<small class="text-muted">IDs Odoo: ';
                                if (lastEtapa.dfe_id) html += `DFe: ${lastEtapa.dfe_id} `;
                                if (lastEtapa.purchase_order_id) html += `| PO: ${lastEtapa.purchase_order_id} `;
                                if (lastEtapa.invoice_id) html += `| Invoice: ${lastEtapa.invoice_id}`;
                                html += '</small></div>';
                            }

                            content.innerHTML = html;
                        } else {
                            content.innerHTML = '<div class="alert alert-warning mb-0">Nenhuma etapa encontrada.</div>';
                        }
                    })
                    .catch(error => {
                        detalhesRow.querySelector('.detalhes-content').innerHTML =
                            '<div class="alert alert-danger mb-0">Erro ao carregar detalhes: ' + error + '</div>';
                    });
            } else {
                // Recolher
                detalhesRow.classList.add('d-none');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        });
    });
});
</script>
{% endblock %}
