{% extends "base.html" %}

{% block title %}Auditoria de Lançamentos Odoo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-clipboard-check"></i> Auditoria de Lançamentos Odoo
            </h1>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosAuditoria"
                    aria-expanded="true">
                    <i class="fas fa-filter"></i> Filtros
                </button>
            </h5>
        </div>
        <div class="collapse show" id="filtrosAuditoria">
            <div class="card-body">
                <form method="GET">
                    <div class="row">
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-control">
                                <option value="">Todos</option>
                                <option value="SUCESSO" {% if filtro_status == 'SUCESSO' %}selected{% endif %}>Sucesso</option>
                                <option value="ERRO" {% if filtro_status == 'ERRO' %}selected{% endif %}>Com Erro</option>
                                <option value="INCOMPLETO" {% if filtro_status == 'INCOMPLETO' %}selected{% endif %}>Incompleto</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Tipo</label>
                            <select name="tipo" class="form-control">
                                <option value="">Todos</option>
                                <option value="frete" {% if filtro_tipo == 'frete' %}selected{% endif %}>Frete</option>
                                <option value="despesa" {% if filtro_tipo == 'despesa' %}selected{% endif %}>Despesa Extra</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Data Início</label>
                            <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Data Fim</label>
                            <input type="date" name="data_fim" class="form-control" value="{{ data_fim }}">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <a href="{{ url_for('fretes.auditoria_lancamentos') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Limpar
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Jobs em Processamento (Fila Assíncrona) -->
    <div class="card mb-4 border-primary" id="cardJobsPendentes">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-sync-alt fa-spin me-2" id="iconSyncJobs"></i>
                Jobs em Processamento
                <span class="badge bg-light text-primary ms-2" id="badgeTotalJobs">0</span>
            </h5>
            <button class="btn btn-sm btn-light" onclick="carregarJobsPendentes()" title="Atualizar">
                <i class="fas fa-refresh"></i>
            </button>
        </div>
        <div class="card-body" id="containerJobsPendentes">
            <div class="text-center text-muted py-3" id="loadingJobs">
                <div class="spinner-border spinner-border-sm" role="status"></div>
                Carregando jobs...
            </div>
            <!-- Jobs serão carregados aqui via JS -->
        </div>
    </div>

    <!-- Estatísticas rápidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <h5 class="text-muted mb-1">Total</h5>
                    <h3 class="mb-0">{{ total }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card stat-card-success">
                <div class="card-body text-center">
                    <h5 class="mb-1">Sucesso</h5>
                    <h3 class="mb-0">{{ lancamentos | selectattr('status', 'equalto', 'SUCESSO') | list | length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card stat-card-danger">
                <div class="card-body text-center">
                    <h5 class="mb-1">Com Erro</h5>
                    <h3 class="mb-0">{{ lancamentos | selectattr('status', 'equalto', 'ERRO') | list | length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <h5 class="mb-1">Incompleto</h5>
                    <h3 class="mb-0">{{ lancamentos | selectattr('status', 'equalto', 'INCOMPLETO') | list | length }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de lançamentos -->
    <div class="card">
        <div class="card-body">
            {% if lancamentos %}
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="tabelaAuditoria">
                    <thead class="table-dark">
                        <tr>
                            <th width="40"></th>
                            <th>Tipo</th>
                            <th>CTe</th>
                            <th>Frete/Fatura</th>
                            <th>Etapas</th>
                            <th>IDs Odoo</th>
                            <th>Executado</th>
                            <th>Status</th>
                            <th width="100">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lanc in lancamentos %}
                        <tr class="lancamento-row {% if lanc.status == 'ERRO' %}table-danger{% elif lanc.status == 'INCOMPLETO' %}table-warning{% endif %}"
                            data-chave="{{ lanc.chave_cte }}"
                            data-frete-id="{{ lanc.frete_id or '' }}"
                            data-despesa-id="{{ lanc.despesa_extra_id or '' }}">
                            <td>
                                <button class="btn btn-sm btn-outline-secondary btn-expand" type="button">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </td>
                            <td>
                                {% if lanc.tipo == 'frete' %}
                                <span class="badge bg-primary">Frete</span>
                                {% else %}
                                <span class="badge bg-info">Despesa</span>
                                {% endif %}
                            </td>
                            <td>
                                {# CTe e Transportadora #}
                                {% if lanc.frete and lanc.frete.cte %}
                                <strong>{{ lanc.frete.cte.numero_cte }}</strong><br>
                                <small class="text-muted">{{ lanc.frete.transportadora.nome_curto if lanc.frete.transportadora else 'N/A' }}</small>
                                {% elif lanc.despesa and lanc.despesa.cte %}
                                <strong>{{ lanc.despesa.cte.numero_cte }}</strong><br>
                                <small class="text-muted">{{ lanc.despesa.tipo_despesa }}</small>
                                {% else %}
                                <small class="text-muted" title="{{ lanc.chave_cte }}">{{ lanc.chave_cte[:15] }}...</small>
                                {% endif %}
                            </td>
                            <td>
                                {# Frete, Fatura e NFs #}
                                {% if lanc.frete %}
                                <a href="{{ url_for('fretes.visualizar_frete', frete_id=lanc.frete.id) }}" class="text-decoration-none" target="_blank">
                                    <strong>#{{ lanc.frete.id }}</strong>
                                </a>
                                {% if lanc.frete.fatura_frete %}
                                <br><small><i class="fas fa-file-invoice text-primary"></i> {{ lanc.frete.fatura_frete.numero_fatura }}</small>
                                {% endif %}
                                {% if lanc.frete.numeros_nfs %}
                                <br><small class="text-muted" title="{{ lanc.frete.numeros_nfs }}"><i class="fas fa-receipt"></i> NFs: {{ lanc.frete.numeros_nfs[:20] }}{% if lanc.frete.numeros_nfs|length > 20 %}...{% endif %}</small>
                                {% endif %}
                                {% if lanc.frete.valor_cte %}
                                <br><small class="text-success"><strong>R$ {{ "%.2f"|format(lanc.frete.valor_cte) }}</strong></small>
                                {% endif %}
                                {% elif lanc.despesa %}
                                <a href="{{ url_for('fretes.visualizar_frete', frete_id=lanc.despesa.frete_id) }}" class="text-decoration-none" target="_blank">
                                    <strong>Desp. #{{ lanc.despesa.id }}</strong>
                                </a>
                                <br><small>{{ lanc.despesa.tipo_despesa }}</small>
                                <br><small class="text-success"><strong>R$ {{ "%.2f"|format(lanc.despesa.valor_despesa) }}</strong></small>
                                {% else %}
                                <small class="text-muted">N/A</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="progress" style="height: 20px; width: 100px;">
                                    <div class="progress-bar {% if lanc.status == 'SUCESSO' %}bg-success{% elif lanc.status == 'ERRO' %}bg-danger{% else %}bg-warning{% endif %}"
                                         style="width: {{ (lanc.ultima_etapa / 16 * 100)|int }}%">
                                        {{ lanc.ultima_etapa }}/16
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if lanc.dfe_id %}
                                <a href="https://odoo.nacomgoya.com.br/web#id={{ lanc.dfe_id }}&model=l10n_br_ciel_it_account.dfe&view_type=form"
                                   target="_blank" class="badge bg-info text-white text-decoration-none" title="Abrir DFe no Odoo">
                                    <i class="fas fa-external-link-alt me-1"></i>D:{{ lanc.dfe_id }}
                                </a>
                                {% endif %}
                                {% if lanc.po_id %}
                                <a href="https://odoo.nacomgoya.com.br/web#id={{ lanc.po_id }}&model=purchase.order&view_type=form"
                                   target="_blank" class="badge bg-primary text-white text-decoration-none" title="Abrir PO no Odoo">
                                    <i class="fas fa-external-link-alt me-1"></i>P:{{ lanc.po_id }}
                                </a>
                                {% endif %}
                                {% if lanc.invoice_id %}
                                <a href="https://odoo.nacomgoya.com.br/web#id={{ lanc.invoice_id }}&model=account.move&view_type=form"
                                   target="_blank" class="badge bg-success text-white text-decoration-none" title="Abrir Invoice no Odoo">
                                    <i class="fas fa-external-link-alt me-1"></i>I:{{ lanc.invoice_id }}
                                </a>
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ lanc.ultimo_executado.strftime('%d/%m/%Y %H:%M') if lanc.ultimo_executado else 'N/A' }}</small><br>
                                <small class="text-muted">{{ lanc.executado_por }}</small>
                            </td>
                            <td>
                                {% if lanc.status == 'SUCESSO' %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> Sucesso</span>
                                {% elif lanc.status == 'ERRO' %}
                                <span class="badge bg-danger"><i class="fas fa-times"></i> Erro</span>
                                {% else %}
                                <span class="badge bg-warning"><i class="fas fa-clock"></i> Incompleto</span>
                                {% endif %}
                            </td>
                            <td>
                                {# Botão de reprocessar para ERRO ou INCOMPLETO #}
                                {% if lanc.status in ['ERRO', 'INCOMPLETO'] %}
                                    {% if lanc.tipo == 'frete' and lanc.frete %}
                                    <button class="btn btn-sm btn-outline-primary btn-reprocessar"
                                            data-tipo="frete"
                                            data-id="{{ lanc.frete.id }}"
                                            data-chave="{{ lanc.chave_cte }}"
                                            title="Retomar lançamento do frete #{{ lanc.frete.id }}">
                                        <i class="fas fa-redo"></i> Retomar
                                    </button>
                                    {% elif lanc.tipo == 'despesa' and lanc.despesa %}
                                    <button class="btn btn-sm btn-outline-info btn-reprocessar"
                                            data-tipo="despesa"
                                            data-id="{{ lanc.despesa.id }}"
                                            title="Retomar lançamento da despesa #{{ lanc.despesa.id }}">
                                        <i class="fas fa-redo"></i> Retomar
                                    </button>
                                    {% endif %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        <!-- Linha de detalhes (oculta inicialmente) -->
                        <tr class="detalhes-row d-none" data-parent="{{ lanc.chave_cte }}">
                            <td colspan="9" class="bg-light p-3">
                                <div class="detalhes-content">
                                    <div class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        Carregando etapas...
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginação -->
            {% if total_pages > 1 %}
            <nav aria-label="Paginação">
                <ul class="pagination justify-content-center">
                    {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page - 1 }}&status={{ filtro_status }}&tipo={{ filtro_tipo }}&data_inicio={{ data_inicio }}&data_fim={{ data_fim }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                        {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ p }}&status={{ filtro_status }}&tipo={{ filtro_tipo }}&data_inicio={{ data_inicio }}&data_fim={{ data_fim }}">{{ p }}</a>
                        </li>
                        {% elif p == page - 3 or p == page + 3 %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page + 1 }}&status={{ filtro_status }}&tipo={{ filtro_tipo }}&data_inicio={{ data_inicio }}&data_fim={{ data_fim }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Nenhum lançamento encontrado com os filtros selecionados.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// =================== JOBS PENDENTES ===================
let intervalJobsPendentes = null;

function carregarJobsPendentes() {
    const container = document.getElementById('containerJobsPendentes');
    const badge = document.getElementById('badgeTotalJobs');
    const iconSync = document.getElementById('iconSyncJobs');
    const card = document.getElementById('cardJobsPendentes');

    fetch('/fretes/jobs/pendentes')
        .then(response => response.json())
        .then(data => {
            if (!data.sucesso) {
                container.innerHTML = `<div class="alert alert-danger mb-0">${data.erro}</div>`;
                return;
            }

            const total = data.total_pendentes + data.total_processando;
            badge.textContent = total;

            // Esconder card se não houver jobs
            if (total === 0 && data.total_falhados === 0) {
                card.classList.add('d-none');
                iconSync.classList.remove('fa-spin');
                return;
            }

            card.classList.remove('d-none');
            iconSync.classList.add('fa-spin');

            let html = '';

            // Jobs em processamento
            if (data.jobs_processando.length > 0) {
                html += '<div class="mb-3">';
                html += '<h6 class="text-success"><i class="fas fa-cog fa-spin me-1"></i> Em Processamento</h6>';
                html += '<div class="accordion" id="accordionProcessando">';
                data.jobs_processando.forEach((job, idx) => {
                    html += renderJobAccordion(job, 'processando', idx);
                });
                html += '</div></div>';
            }

            // Jobs na fila
            if (data.jobs_pendentes.length > 0) {
                html += '<div class="mb-3">';
                html += '<h6 class="text-primary"><i class="fas fa-hourglass-half me-1"></i> Na Fila</h6>';
                html += '<div class="accordion" id="accordionPendentes">';
                data.jobs_pendentes.forEach((job, idx) => {
                    html += renderJobAccordion(job, 'pendente', idx);
                });
                html += '</div></div>';
            }

            // Jobs falhados
            if (data.jobs_falhados.length > 0) {
                html += '<div class="mb-3">';
                html += '<h6 class="text-danger"><i class="fas fa-times-circle me-1"></i> Falhados Recentemente</h6>';
                html += '<div class="accordion" id="accordionFalhados">';
                data.jobs_falhados.forEach((job, idx) => {
                    html += renderJobAccordion(job, 'falhado', idx);
                });
                html += '</div></div>';
            }

            if (html === '') {
                html = '<div class="text-center text-muted py-2"><i class="fas fa-check-circle text-success"></i> Nenhum job em processamento</div>';
                iconSync.classList.remove('fa-spin');
            }

            container.innerHTML = html;

            // Se tem jobs em processamento, atualizar a cada 3 segundos
            if (data.total_processando > 0 || data.total_pendentes > 0) {
                if (!intervalJobsPendentes) {
                    intervalJobsPendentes = setInterval(carregarJobsPendentes, 3000);
                }
            } else {
                if (intervalJobsPendentes) {
                    clearInterval(intervalJobsPendentes);
                    intervalJobsPendentes = null;
                }
            }
        })
        .catch(error => {
            container.innerHTML = `<div class="alert alert-warning mb-0">Erro ao carregar jobs: ${error}</div>`;
        });
}

function renderJobAccordion(job, tipo, idx) {
    const tipoLabel = job.args?.tipo || 'job';
    const id = job.args?.frete_id || job.args?.despesa_id || job.args?.fatura_id || job.job_id;

    let badgeClass = 'bg-primary';
    let badgeIcon = 'hourglass-half';
    if (tipo === 'processando') {
        badgeClass = 'bg-success';
        badgeIcon = 'cog fa-spin';
    } else if (tipo === 'falhado') {
        badgeClass = 'bg-danger';
        badgeIcon = 'times';
    }

    let tipoIcone = 'file-invoice';
    let tipoBadge = 'secondary';
    if (tipoLabel === 'frete') {
        tipoIcone = 'truck';
        tipoBadge = 'primary';
    } else if (tipoLabel === 'despesa') {
        tipoIcone = 'receipt';
        tipoBadge = 'info';
    } else if (tipoLabel === 'lote') {
        tipoIcone = 'layer-group';
        tipoBadge = 'warning';
    }

    const createdAt = job.created_at ? new Date(job.created_at).toLocaleString('pt-BR') : '-';
    const startedAt = job.started_at ? new Date(job.started_at).toLocaleString('pt-BR') : null;

    // Informações extras
    const cteNumero = job.args?.cte_numero;
    const transportadora = job.args?.transportadora;
    const faturaNumero = job.args?.fatura_numero;
    const valor = job.args?.valor_cte || job.args?.valor;
    const tipoDespesa = job.args?.tipo_despesa;
    const totalFretes = job.args?.total_fretes;

    // Título mais informativo
    let tituloExtra = '';
    if (cteNumero) tituloExtra = `CTe ${cteNumero}`;
    else if (faturaNumero) tituloExtra = `Fat. ${faturaNumero}`;
    if (transportadora) tituloExtra += tituloExtra ? ` - ${transportadora}` : transportadora;
    if (tipoDespesa) tituloExtra = tipoDespesa;
    if (totalFretes) tituloExtra += ` (${totalFretes} fretes)`;

    // Para lotes em processamento, adicionar área de progresso em tempo real
    let loteProgressoHtml = '';
    if (tipoLabel === 'lote' && tipo === 'processando' && job.args?.fatura_id) {
        loteProgressoHtml = `
            <div class="mt-2 pt-2 border-top" id="loteProgresso${job.args.fatura_id}">
                <div class="text-center text-muted">
                    <small><i class="fas fa-spinner fa-spin"></i> Carregando progresso...</small>
                </div>
            </div>`;
        // Iniciar polling do progresso
        setTimeout(() => carregarProgressoLote(job.args.fatura_id), 500);
    }

    let html = `
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#job${tipo}${idx}">
                <span class="badge ${badgeClass} me-2"><i class="fas fa-${badgeIcon}"></i></span>
                <span class="badge bg-${tipoBadge} me-2"><i class="fas fa-${tipoIcone}"></i> ${tipoLabel.toUpperCase()}</span>
                <span class="me-2">#${id}</span>
                ${tituloExtra ? `<span class="badge bg-light text-dark me-2">${tituloExtra}</span>` : ''}
                ${valor ? `<span class="badge bg-secondary me-2">R$ ${valor.toFixed(2)}</span>` : ''}
                <small class="text-muted">por ${job.args?.usuario || 'N/A'}</small>
            </button>
        </h2>
        <div id="job${tipo}${idx}" class="accordion-collapse collapse">
            <div class="accordion-body py-2">
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">Job ID:</small> <code>${job.job_id}</code><br>
                        <small class="text-muted">Criado:</small> ${createdAt}
                        ${startedAt ? `<br><small class="text-muted">Iniciado:</small> ${startedAt}` : ''}
                        ${faturaNumero ? `<br><small class="text-muted">Fatura:</small> <strong>${faturaNumero}</strong>` : ''}
                        ${cteNumero ? `<br><small class="text-muted">CTe:</small> <strong>${cteNumero}</strong>` : ''}
                        ${transportadora ? `<br><small class="text-muted">Transp.:</small> ${transportadora}` : ''}
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">Status:</small> <span class="badge ${badgeClass}">${job.status_display}</span>
                        ${valor ? `<br><small class="text-muted">Valor:</small> <strong>R$ ${valor.toFixed(2)}</strong>` : ''}
                        ${totalFretes ? `<br><small class="text-muted">Total Fretes:</small> ${totalFretes}` : ''}
                        ${job.error ? `<br><small class="text-danger">${job.error}</small>` : ''}
                    </div>
                </div>
                ${loteProgressoHtml}
            </div>
        </div>
    </div>`;

    return html;
}

// =================== PROGRESSO DE LOTE EM TEMPO REAL ===================
let loteIntervals = {};

function carregarProgressoLote(faturaId) {
    fetch(`/fretes/lote/${faturaId}/progresso`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById(`loteProgresso${faturaId}`);
            if (!container) return;

            if (!data.sucesso || !data.encontrado) {
                container.innerHTML = '<small class="text-muted">Aguardando início...</small>';
                // Continuar polling
                if (!loteIntervals[faturaId]) {
                    loteIntervals[faturaId] = setInterval(() => carregarProgressoLote(faturaId), 3000);
                }
                return;
            }

            const p = data.progresso;
            const totalItens = p.total_fretes + p.total_despesas;
            const processados = p.fretes_processados + p.despesas_processadas;
            const percentual = totalItens > 0 ? Math.round((processados / totalItens) * 100) : 0;

            let statusClass = 'bg-primary';
            if (p.status === 'concluido') statusClass = 'bg-success';
            else if (p.status === 'erro') statusClass = 'bg-danger';

            let html = `
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong>${p.item_atual}</strong>
                        <span class="badge ${statusClass}">${processados}/${totalItens}</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${statusClass} progress-bar-striped progress-bar-animated"
                             style="width: ${percentual}%">${percentual}%</div>
                    </div>
                    <small class="text-muted">${p.item_atual_etapa || ''}</small>
                </div>
                <div class="row small">
                    <div class="col-4">
                        <span class="text-success"><i class="fas fa-check"></i> ${p.fretes_sucesso + p.despesas_sucesso} OK</span>
                    </div>
                    <div class="col-4">
                        <span class="text-warning"><i class="fas fa-forward"></i> ${p.fretes_skip + p.despesas_skip} Skip</span>
                    </div>
                    <div class="col-4">
                        <span class="text-danger"><i class="fas fa-times"></i> ${p.fretes_erro + p.despesas_erro} Erro</span>
                    </div>
                </div>
            `;

            // Mostrar detalhes dos itens processados
            if (p.detalhes && p.detalhes.length > 0) {
                html += '<div class="mt-2 pt-2 border-top"><small class="text-muted">Itens processados:</small><div class="mt-1">';
                p.detalhes.forEach(item => {
                    let icon = 'check text-success';
                    if (item.skipped) icon = 'forward text-warning';
                    else if (!item.success) icon = 'times text-danger';
                    html += `<span class="badge bg-light text-dark me-1 mb-1"><i class="fas fa-${icon}"></i> ${item.tipo === 'frete' ? 'F' : 'D'}#${item.id}</span>`;
                });
                html += '</div></div>';
            }

            container.innerHTML = html;

            // Se concluído ou erro, parar polling
            if (p.status === 'concluido' || p.status === 'erro') {
                if (loteIntervals[faturaId]) {
                    clearInterval(loteIntervals[faturaId]);
                    delete loteIntervals[faturaId];
                }
            } else {
                // Continuar polling
                if (!loteIntervals[faturaId]) {
                    loteIntervals[faturaId] = setInterval(() => carregarProgressoLote(faturaId), 2000);
                }
            }
        })
        .catch(error => {
            console.error('Erro ao carregar progresso do lote:', error);
        });
}

// =================== REPROCESSAR LANÇAMENTO ===================
function reprocessarLancamento(tipo, id, btn) {
    // Desabilitar botão e mostrar loading
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    // Determinar URL baseado no tipo
    let url;
    if (tipo === 'frete') {
        url = `/fretes/${id}/lancar-odoo`;  // Hífen, não underscore
    } else if (tipo === 'despesa') {
        url = `/fretes/despesas/${id}/lancar_odoo`;  // Despesa usa underscore
    } else {
        alert('Tipo de lançamento desconhecido: ' + tipo);
        btn.disabled = false;
        btn.innerHTML = originalHtml;
        return;
    }

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})  // Body vazio mas válido para evitar erro 400
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            // Sucesso - mostrar mensagem e atualizar botão
            btn.classList.remove('btn-outline-primary', 'btn-outline-info');
            btn.classList.add('btn-success');
            btn.innerHTML = '<i class="fas fa-check"></i> Enfileirado';

            // Mostrar toast ou alerta
            const toast = document.createElement('div');
            toast.className = 'alert alert-success alert-dismissible fade show position-fixed';
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <strong><i class="fas fa-check-circle"></i> Sucesso!</strong><br>
                ${tipo === 'frete' ? 'Frete' : 'Despesa'} #${id} enfileirado para reprocessamento.<br>
                <small>Job ID: ${data.job_id}</small>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);

            // Recarregar jobs pendentes para mostrar o novo
            setTimeout(() => carregarJobsPendentes(), 1000);
        } else {
            // Erro - restaurar botão e mostrar mensagem
            btn.disabled = false;
            btn.innerHTML = originalHtml;

            const toast = document.createElement('div');
            toast.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <strong><i class="fas fa-times-circle"></i> Erro!</strong><br>
                ${data.mensagem || 'Erro desconhecido'}<br>
                <small>${data.erro || ''}</small>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 8000);
        }
    })
    .catch(error => {
        console.error('Erro ao reprocessar:', error);
        btn.disabled = false;
        btn.innerHTML = originalHtml;

        const toast = document.createElement('div');
        toast.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <strong><i class="fas fa-times-circle"></i> Erro de conexão!</strong><br>
            Não foi possível conectar ao servidor.<br>
            <small>${error}</small>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 8000);
    });
}

// =================== DETALHES DE LANÇAMENTOS ===================
document.addEventListener('DOMContentLoaded', function() {
    // Carregar jobs pendentes ao iniciar
    carregarJobsPendentes();

    // Handler para botões de reprocessar
    document.querySelectorAll('.btn-reprocessar').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const tipo = this.dataset.tipo;
            const id = this.dataset.id;

            if (confirm(`Deseja retomar o lançamento ${tipo === 'frete' ? 'do frete' : 'da despesa'} #${id}?`)) {
                reprocessarLancamento(tipo, id, this);
            }
        });
    });

    // Expandir/recolher detalhes
    document.querySelectorAll('.btn-expand').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            const chave = row.dataset.chave;
            const freteId = row.dataset.freteId;
            const despesaId = row.dataset.despesaId;
            const detalhesRow = document.querySelector(`.detalhes-row[data-parent="${chave}"]`);
            const icon = this.querySelector('i');

            if (detalhesRow.classList.contains('d-none')) {
                // Expandir
                detalhesRow.classList.remove('d-none');
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');

                // Carregar detalhes via AJAX
                let url = `/fretes/api/auditoria-lancamentos/${chave}`;
                if (freteId) url += `?frete_id=${freteId}`;
                else if (despesaId) url += `?despesa_id=${despesaId}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const content = detalhesRow.querySelector('.detalhes-content');
                        if (data.etapas && data.etapas.length > 0) {
                            let html = '<div class="table-responsive"><table class="table table-sm table-bordered mb-0">';
                            html += '<thead><tr><th>Etapa</th><th>Descrição</th><th>Modelo</th><th>Ação</th><th>Status</th><th>Tempo</th><th>Mensagem</th></tr></thead>';
                            html += '<tbody>';
                            data.etapas.forEach(function(etapa) {
                                const statusClass = etapa.status === 'SUCESSO' ? 'table-success' : (etapa.status === 'ERRO' ? 'table-danger' : '');
                                html += `<tr class="${statusClass}">`;
                                html += `<td><strong>${etapa.etapa}</strong></td>`;
                                html += `<td>${etapa.etapa_descricao}</td>`;
                                html += `<td><small>${etapa.modelo_odoo}</small></td>`;
                                html += `<td><small>${etapa.acao}${etapa.metodo_odoo ? ' / ' + etapa.metodo_odoo : ''}</small></td>`;
                                html += `<td>`;
                                if (etapa.status === 'SUCESSO') {
                                    html += '<span class="badge bg-success">OK</span>';
                                } else if (etapa.status === 'ERRO') {
                                    html += '<span class="badge bg-danger">ERRO</span>';
                                } else {
                                    html += `<span class="badge bg-secondary">${etapa.status}</span>`;
                                }
                                html += `</td>`;
                                html += `<td>${etapa.tempo_execucao_ms ? etapa.tempo_execucao_ms + 'ms' : '-'}</td>`;
                                html += `<td>`;
                                if (etapa.mensagem) {
                                    html += `<small>${etapa.mensagem.substring(0, 100)}${etapa.mensagem.length > 100 ? '...' : ''}</small>`;
                                }
                                if (etapa.erro_detalhado) {
                                    html += `<br><small class="text-danger">${etapa.erro_detalhado.substring(0, 200)}...</small>`;
                                }
                                html += `</td>`;
                                html += '</tr>';
                            });
                            html += '</tbody></table></div>';

                            // IDs do Odoo - Links clicáveis
                            const lastEtapa = data.etapas[data.etapas.length - 1];
                            if (lastEtapa.dfe_id || lastEtapa.purchase_order_id || lastEtapa.invoice_id) {
                                html += '<div class="mt-2">';
                                html += '<small class="text-muted">IDs Odoo:</small> ';
                                if (lastEtapa.dfe_id) {
                                    html += `<a href="https://odoo.nacomgoya.com.br/web#id=${lastEtapa.dfe_id}&model=l10n_br_ciel_it_account.dfe&view_type=form" target="_blank" class="badge bg-info text-white text-decoration-none me-1" title="Abrir DFe no Odoo"><i class="fas fa-external-link-alt me-1"></i>DFe: ${lastEtapa.dfe_id}</a>`;
                                }
                                if (lastEtapa.purchase_order_id) {
                                    html += `<a href="https://odoo.nacomgoya.com.br/web#id=${lastEtapa.purchase_order_id}&model=purchase.order&view_type=form" target="_blank" class="badge bg-primary text-white text-decoration-none me-1" title="Abrir PO no Odoo"><i class="fas fa-external-link-alt me-1"></i>PO: ${lastEtapa.purchase_order_id}</a>`;
                                }
                                if (lastEtapa.invoice_id) {
                                    html += `<a href="https://odoo.nacomgoya.com.br/web#id=${lastEtapa.invoice_id}&model=account.move&view_type=form" target="_blank" class="badge bg-success text-white text-decoration-none" title="Abrir Invoice no Odoo"><i class="fas fa-external-link-alt me-1"></i>Invoice: ${lastEtapa.invoice_id}</a>`;
                                }
                                html += '</div>';
                            }

                            content.innerHTML = html;
                        } else {
                            content.innerHTML = '<div class="alert alert-warning mb-0">Nenhuma etapa encontrada.</div>';
                        }
                    })
                    .catch(error => {
                        detalhesRow.querySelector('.detalhes-content').innerHTML =
                            '<div class="alert alert-danger mb-0">Erro ao carregar detalhes: ' + error + '</div>';
                    });
            } else {
                // Recolher
                detalhesRow.classList.add('d-none');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        });
    });
});
</script>
{% endblock %}
