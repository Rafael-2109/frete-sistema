{% extends "base.html" %}

{% block title %}Auditoria de Lançamentos Odoo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-clipboard-check"></i> Auditoria de Lançamentos Odoo
            </h1>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosAuditoria"
                    aria-expanded="true">
                    <i class="fas fa-filter"></i> Filtros
                </button>
            </h5>
        </div>
        <div class="collapse show" id="filtrosAuditoria">
            <div class="card-body">
                <form method="GET">
                    <div class="row">
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-control">
                                <option value="">Todos</option>
                                <option value="SUCESSO" {% if filtro_status == 'SUCESSO' %}selected{% endif %}>Sucesso</option>
                                <option value="ERRO" {% if filtro_status == 'ERRO' %}selected{% endif %}>Com Erro</option>
                                <option value="INCOMPLETO" {% if filtro_status == 'INCOMPLETO' %}selected{% endif %}>Incompleto</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Tipo</label>
                            <select name="tipo" class="form-control">
                                <option value="">Todos</option>
                                <option value="frete" {% if filtro_tipo == 'frete' %}selected{% endif %}>Frete</option>
                                <option value="despesa" {% if filtro_tipo == 'despesa' %}selected{% endif %}>Despesa Extra</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Data Início</label>
                            <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Data Fim</label>
                            <input type="date" name="data_fim" class="form-control" value="{{ data_fim }}">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <a href="{{ url_for('fretes.auditoria_lancamentos') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Limpar
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Estatísticas rápidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="text-muted mb-1">Total</h5>
                    <h3 class="mb-0">{{ total }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h5 class="mb-1">Sucesso</h5>
                    <h3 class="mb-0">{{ lancamentos | selectattr('status', 'equalto', 'SUCESSO') | list | length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h5 class="mb-1">Com Erro</h5>
                    <h3 class="mb-0">{{ lancamentos | selectattr('status', 'equalto', 'ERRO') | list | length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning">
                <div class="card-body text-center">
                    <h5 class="mb-1">Incompleto</h5>
                    <h3 class="mb-0">{{ lancamentos | selectattr('status', 'equalto', 'INCOMPLETO') | list | length }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de lançamentos -->
    <div class="card">
        <div class="card-body">
            {% if lancamentos %}
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="tabelaAuditoria">
                    <thead class="table-dark">
                        <tr>
                            <th width="40"></th>
                            <th>Tipo</th>
                            <th>CTe/Chave</th>
                            <th>Referência</th>
                            <th>Etapas</th>
                            <th>IDs Odoo</th>
                            <th>Executado</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lanc in lancamentos %}
                        <tr class="lancamento-row {% if lanc.status == 'ERRO' %}table-danger{% elif lanc.status == 'INCOMPLETO' %}table-warning{% endif %}"
                            data-chave="{{ lanc.chave_cte }}"
                            data-frete-id="{{ lanc.frete_id or '' }}"
                            data-despesa-id="{{ lanc.despesa_extra_id or '' }}">
                            <td>
                                <button class="btn btn-sm btn-outline-secondary btn-expand" type="button">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </td>
                            <td>
                                {% if lanc.tipo == 'frete' %}
                                <span class="badge bg-primary">Frete</span>
                                {% else %}
                                <span class="badge bg-info">Despesa</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ lanc.chave_cte[:20] }}...</small>
                            </td>
                            <td>
                                {% if lanc.frete and lanc.frete.cte %}
                                <strong>CTe {{ lanc.frete.cte.numero_cte }}</strong><br>
                                <small>{{ lanc.frete.transportadora.nome_curto if lanc.frete.transportadora else 'N/A' }}</small>
                                {% elif lanc.despesa and lanc.despesa.cte %}
                                <strong>CTe {{ lanc.despesa.cte.numero_cte }}</strong><br>
                                <small>{{ lanc.despesa.tipo_despesa }} - R$ {{ "%.2f"|format(lanc.despesa.valor_despesa) }}</small>
                                {% else %}
                                <small class="text-muted">N/A</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="progress" style="height: 20px; width: 100px;">
                                    <div class="progress-bar {% if lanc.status == 'SUCESSO' %}bg-success{% elif lanc.status == 'ERRO' %}bg-danger{% else %}bg-warning{% endif %}"
                                         style="width: {{ (lanc.ultima_etapa / 16 * 100)|int }}%">
                                        {{ lanc.ultima_etapa }}/16
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if lanc.dfe_id %}
                                <span class="badge bg-secondary" title="DFe ID">D:{{ lanc.dfe_id }}</span>
                                {% endif %}
                                {% if lanc.po_id %}
                                <span class="badge bg-secondary" title="PO ID">P:{{ lanc.po_id }}</span>
                                {% endif %}
                                {% if lanc.invoice_id %}
                                <span class="badge bg-secondary" title="Invoice ID">I:{{ lanc.invoice_id }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ lanc.ultimo_executado.strftime('%d/%m/%Y %H:%M') if lanc.ultimo_executado else 'N/A' }}</small><br>
                                <small class="text-muted">{{ lanc.executado_por }}</small>
                            </td>
                            <td>
                                {% if lanc.status == 'SUCESSO' %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> Sucesso</span>
                                {% elif lanc.status == 'ERRO' %}
                                <span class="badge bg-danger"><i class="fas fa-times"></i> Erro</span>
                                {% else %}
                                <span class="badge bg-warning"><i class="fas fa-clock"></i> Incompleto</span>
                                {% endif %}
                            </td>
                        </tr>
                        <!-- Linha de detalhes (oculta inicialmente) -->
                        <tr class="detalhes-row d-none" data-parent="{{ lanc.chave_cte }}">
                            <td colspan="8" class="bg-light p-3">
                                <div class="detalhes-content">
                                    <div class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        Carregando etapas...
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginação -->
            {% if total_pages > 1 %}
            <nav aria-label="Paginação">
                <ul class="pagination justify-content-center">
                    {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page - 1 }}&status={{ filtro_status }}&tipo={{ filtro_tipo }}&data_inicio={{ data_inicio }}&data_fim={{ data_fim }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                        {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ p }}&status={{ filtro_status }}&tipo={{ filtro_tipo }}&data_inicio={{ data_inicio }}&data_fim={{ data_fim }}">{{ p }}</a>
                        </li>
                        {% elif p == page - 3 or p == page + 3 %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page + 1 }}&status={{ filtro_status }}&tipo={{ filtro_tipo }}&data_inicio={{ data_inicio }}&data_fim={{ data_fim }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Nenhum lançamento encontrado com os filtros selecionados.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Expandir/recolher detalhes
    document.querySelectorAll('.btn-expand').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            const chave = row.dataset.chave;
            const freteId = row.dataset.freteId;
            const despesaId = row.dataset.despesaId;
            const detalhesRow = document.querySelector(`.detalhes-row[data-parent="${chave}"]`);
            const icon = this.querySelector('i');

            if (detalhesRow.classList.contains('d-none')) {
                // Expandir
                detalhesRow.classList.remove('d-none');
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');

                // Carregar detalhes via AJAX
                let url = `/fretes/api/auditoria-lancamentos/${chave}`;
                if (freteId) url += `?frete_id=${freteId}`;
                else if (despesaId) url += `?despesa_id=${despesaId}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const content = detalhesRow.querySelector('.detalhes-content');
                        if (data.etapas && data.etapas.length > 0) {
                            let html = '<div class="table-responsive"><table class="table table-sm table-bordered mb-0">';
                            html += '<thead><tr><th>Etapa</th><th>Descrição</th><th>Modelo</th><th>Ação</th><th>Status</th><th>Tempo</th><th>Mensagem</th></tr></thead>';
                            html += '<tbody>';
                            data.etapas.forEach(function(etapa) {
                                const statusClass = etapa.status === 'SUCESSO' ? 'table-success' : (etapa.status === 'ERRO' ? 'table-danger' : '');
                                html += `<tr class="${statusClass}">`;
                                html += `<td><strong>${etapa.etapa}</strong></td>`;
                                html += `<td>${etapa.etapa_descricao}</td>`;
                                html += `<td><small>${etapa.modelo_odoo}</small></td>`;
                                html += `<td><small>${etapa.acao}${etapa.metodo_odoo ? ' / ' + etapa.metodo_odoo : ''}</small></td>`;
                                html += `<td>`;
                                if (etapa.status === 'SUCESSO') {
                                    html += '<span class="badge bg-success">OK</span>';
                                } else if (etapa.status === 'ERRO') {
                                    html += '<span class="badge bg-danger">ERRO</span>';
                                } else {
                                    html += `<span class="badge bg-secondary">${etapa.status}</span>`;
                                }
                                html += `</td>`;
                                html += `<td>${etapa.tempo_execucao_ms ? etapa.tempo_execucao_ms + 'ms' : '-'}</td>`;
                                html += `<td>`;
                                if (etapa.mensagem) {
                                    html += `<small>${etapa.mensagem.substring(0, 100)}${etapa.mensagem.length > 100 ? '...' : ''}</small>`;
                                }
                                if (etapa.erro_detalhado) {
                                    html += `<br><small class="text-danger">${etapa.erro_detalhado.substring(0, 200)}...</small>`;
                                }
                                html += `</td>`;
                                html += '</tr>';
                            });
                            html += '</tbody></table></div>';

                            // IDs do Odoo
                            const lastEtapa = data.etapas[data.etapas.length - 1];
                            if (lastEtapa.dfe_id || lastEtapa.purchase_order_id || lastEtapa.invoice_id) {
                                html += '<div class="mt-2">';
                                html += '<small class="text-muted">IDs Odoo: ';
                                if (lastEtapa.dfe_id) html += `DFe: ${lastEtapa.dfe_id} `;
                                if (lastEtapa.purchase_order_id) html += `| PO: ${lastEtapa.purchase_order_id} `;
                                if (lastEtapa.invoice_id) html += `| Invoice: ${lastEtapa.invoice_id}`;
                                html += '</small></div>';
                            }

                            content.innerHTML = html;
                        } else {
                            content.innerHTML = '<div class="alert alert-warning mb-0">Nenhuma etapa encontrada.</div>';
                        }
                    })
                    .catch(error => {
                        detalhesRow.querySelector('.detalhes-content').innerHTML =
                            '<div class="alert alert-danger mb-0">Erro ao carregar detalhes: ' + error + '</div>';
                    });
            } else {
                // Recolher
                detalhesRow.classList.add('d-none');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        });
    });
});
</script>
{% endblock %}
