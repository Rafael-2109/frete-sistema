{% extends "base.html" %}

{% block title %}Frete #{{ frete.id }}{% endblock %}

{% block extra_css %}
<style>
/* ==========================================================================
   VISUALIZAR FRETE - Theme-aware Styles
   ========================================================================== */

/* === BADGES DE STATUS === */
.badge-status {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.35em 0.65em;
    border-radius: 0.375rem;
}

/* Status: PENDENTE - Amarelo */
.badge-status-pendente {
    background-color: var(--bs-warning) !important;
    color: #ffffff !important;
}

/* Status: EM_TRATATIVA - Info/Cyan */
.badge-status-tratativa {
    background-color: var(--bs-info) !important;
    color: #fff !important;
}

/* Status: APROVADO - Verde */
.badge-status-aprovado {
    background-color: var(--bs-success) !important;
    color: #fff !important;
}

/* Status: REJEITADO - Vermelho */
.badge-status-rejeitado {
    background-color: var(--bs-danger) !important;
    color: #fff !important;
}

/* Status: PAGO - Prim√°rio */
.badge-status-pago {
    background-color: var(--bs-primary) !important;
    color: #0a1628 !important;
}

/* Status: LANCADO - Theme-aware */
.badge-status-lancado {
    background-color: var(--bs-tertiary-bg) !important;
    color: var(--bs-body-color) !important;
    border: 1px solid var(--bs-border-color);
}

/* Status: CANCELADO - Secund√°rio */
.badge-status-cancelado {
    background-color: var(--bs-secondary) !important;
    color: #fff !important;
}

/* === BADGES DE VALORES === */
.badge-valor-positivo {
    background-color: var(--bs-danger) !important;
    color: #fff !important;
}

.badge-valor-negativo {
    background-color: var(--bs-success) !important;
    color: #fff !important;
}

.badge-valor-info {
    background-color: var(--bs-info) !important;
    color: #fff !important;
}

/* === BADGES DE MOVIMENTO === */
.badge-movimento-entrada {
    background-color: var(--bs-success) !important;
    color: #fff !important;
}

.badge-movimento-saida {
    background-color: var(--bs-danger) !important;
    color: #fff !important;
}

/* === CARD HEADER THEME === */
.card-header-theme {
    background-color: var(--bs-tertiary-bg) !important;
    color: var(--bs-body-color) !important;
    border-bottom: 1px solid var(--bs-border-color) !important;
}

/* === ALERTS (sobrescreve estilos inline) === */
.alert-success {
    background-color: rgba(var(--bs-success-rgb), 0.15) !important;
    border-color: rgba(var(--bs-success-rgb), 0.3) !important;
    color: var(--bs-body-color) !important;
}

.alert-warning {
    background-color: rgba(var(--bs-warning-rgb), 0.15) !important;
    border-color: rgba(var(--bs-warning-rgb), 0.3) !important;
    color: var(--bs-body-color) !important;
}

/* Light mode - alerts mais contrastantes */
[data-bs-theme="light"] .alert-success,
[data-theme="light"] .alert-success {
    background-color: #d1e7dd !important;
    color: #0f5132 !important;
}

[data-bs-theme="light"] .alert-warning,
[data-theme="light"] .alert-warning {
    background-color: #fff3cd !important;
    color: #664d03 !important;
}

/* === BORDER LEFT HIGHLIGHT === */
.border-left-success {
    border-left: 4px solid var(--bs-success) !important;
}

.border-left-info {
    border-left: 4px solid var(--bs-info) !important;
}

.border-left-warning {
    border-left: 4px solid var(--bs-warning) !important;
}

/* === TABLE THEAD THEME === */
.table-thead-theme {
    background-color: var(--bs-tertiary-bg) !important;
}

.table-thead-theme th {
    background-color: var(--bs-tertiary-bg) !important;
    color: var(--bs-body-color) !important;
    border-bottom: 2px solid var(--bs-border-color) !important;
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-file-invoice"></i> Frete #{{ frete.id }}
                {% if frete.status == 'PENDENTE' %}
                <span class="badge badge-status badge-status-pendente ms-2">{{ frete.status }}</span>
                {% elif frete.status == 'EM_TRATATIVA' %}
                <span class="badge badge-status badge-status-tratativa ms-2">EM TRATATIVA</span>
                {% elif frete.status == 'APROVADO' %}
                <span class="badge badge-status badge-status-aprovado ms-2">{{ frete.status }}</span>
                {% elif frete.status == 'REJEITADO' %}
                <span class="badge badge-status badge-status-rejeitado ms-2">{{ frete.status }}</span>
                {% elif frete.status == 'PAGO' %}
                <span class="badge badge-status badge-status-pago ms-2">{{ frete.status }}</span>
                {% elif frete.status == 'LANCADO' %}
                <span class="badge badge-status badge-status-lancado ms-2">{{ frete.status }}</span>
                {% else %}
                <span class="badge badge-status badge-status-cancelado ms-2">{{ frete.status }}</span>
                {% endif %}
            </h1>
        </div>
    </div>

    <!-- A√ß√µes -->
    <div class="row mb-4">
        <div class="col-12">
            <a href="{{ url_for('fretes.listar_fretes') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar √† Lista
            </a>

            {% if not frete.fatura_frete or frete.fatura_frete.status_conferencia != 'CONFERIDO' %}
            <a href="{{ url_for('fretes.editar_frete', frete_id=frete.id) }}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Editar Frete
            </a>
            {% else %}
            <button class="btn btn-primary" disabled title="Frete bloqueado - fatura conferida">
                <i class="fas fa-lock"></i> Frete Bloqueado
            </button>
            {% endif %}


            <a href="{{ url_for('embarques.visualizar_embarque', id=frete.embarque_id) }}" class="btn btn-info">
                <i class="fas fa-truck"></i> Ver Embarque
            </a>

            <!-- Bot√£o Lan√ßar no Odoo -->
            {% if not frete.odoo_invoice_id %}
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalLancarOdoo">
                <i class="fas fa-cloud-upload-alt"></i> Lan√ßar no Odoo
            </button>
            {% else %}
            <button type="button" class="btn btn-success" disabled title="J√° lan√ßado no Odoo">
                <i class="fas fa-check-circle"></i> Lan√ßado no Odoo
            </button>
            {% endif %}

            {% if not frete.fatura_frete or frete.fatura_frete.status_conferencia != 'CONFERIDO' %}
            <!-- ‚úÖ NOVO: Bot√£o Cancelar CTe (fluxo reverso) -->
            {% if frete.numero_cte %}
            <form method="POST" action="{{ url_for('fretes.cancelar_cte', frete_id=frete.id) }}"
                style="display: inline-block;"
                onsubmit="return confirm('üîÑ Cancelar CTe: O CTe ser√° removido mas o frete ser√° mantido (status PENDENTE). Confirma?')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-undo"></i> Cancelar CTe
                </button>
            </form>
            {% endif %}

            <!-- Bot√£o Excluir CTe/Frete -->
            <form method="POST" action="{{ url_for('fretes.excluir_frete', frete_id=frete.id) }}"
                style="display: inline-block;"
                onsubmit="return confirm('‚ö†Ô∏è EXCLUIR COMPLETO: Esta a√ß√£o ir√° excluir PERMANENTEMENTE este CTe/Frete e todas as suas movimenta√ß√µes. Tem certeza?')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Excluir Tudo
                </button>
            </form>
            {% else %}
            <button class="btn btn-danger" disabled title="N√£o √© poss√≠vel excluir CTe de fatura conferida">
                <i class="fas fa-lock"></i> CTe Protegido
            </button>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Dados principais do frete -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> Dados do Frete
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-building"></i> Cliente</h6>
                            <p><strong>CNPJ:</strong> {{ frete.cnpj_cliente }}</p>
                            <p><strong>Raz√£o Social:</strong> {{ frete.nome_cliente }}</p>
                            <p><strong>UF/Cidade Destino:</strong> {{ frete.uf_destino }}/{{ frete.cidade_destino }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-truck"></i> Transporte</h6>
                            <p><strong>Transportadora:</strong> {{ frete.transportadora.razao_social }}</p>
                            <p><strong>Embarque:</strong>
                                <a href="{{ url_for('embarques.visualizar_embarque', id=frete.embarque_id) }}">
                                    #{{ frete.embarque.numero }}
                                </a>
                            </p>
                            <p><strong>Tipo de Carga:</strong>
                                {% if frete.tipo_carga == 'DIRETA' %}
                                <span class="badge bg-info" style="color: white; background-color: #17a2b8;">{{
                                    frete.tipo_carga }}</span>
                                {% else %}
                                <span class="badge bg-warning" style="color: #212529; background-color: #ffc107;">{{
                                    frete.tipo_carga }}</span>
                                {% endif %}
                            </p>
                            <p><strong>Modalidade:</strong> {{ frete.modalidade }}</p>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-weight"></i> Totais das NFs</h6>
                            <p><strong>Peso Total:</strong> {{ frete.peso_total|numero_br(2) }} kg</p>
                            <p><strong>Valor Total:</strong> {{ (frete.valor_total_nfs)|moeda_carteira }}</p>
                            <p><strong>Quantidade de NFs:</strong> {{ frete.quantidade_nfs }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-file-alt"></i> CTe e Fatura</h6>
                            {% if frete.numero_cte %}
                            <p><strong>N√∫mero CTe:</strong> {{ frete.numero_cte }}</p>
                            <p><strong>Data Emiss√£o:</strong> {{ frete.data_emissao_cte | formatar_data_segura if
                                frete.data_emissao_cte else 'N/A' }}</p>
                            <p><strong>Vencimento:</strong> {{ frete.vencimento | formatar_data_segura if
                                frete.vencimento else 'N/A' }}</p>
                            {% else %}
                            <p class="text-muted">CTe n√£o lan√ßado</p>
                            {% endif %}

                            {% if frete.fatura_frete %}
                            <p><strong>Fatura:</strong>
                                <a href="{{ url_for('fretes.visualizar_fatura', fatura_id=frete.fatura_frete.id) }}"
                                   class="badge bg-primary text-white"
                                   title="Ver detalhes da fatura {{ frete.fatura_frete.numero_fatura }}">
                                    <i class="fas fa-file-invoice"></i>
                                    {{ frete.fatura_frete.numero_fatura }}
                                </a>
                            </p>
                            <p><strong>Valor Fatura:</strong> {{ (frete.fatura_frete.valor_total_fatura)|moeda_carteira
                                }}</p>
                            {% else %}
                            <p class="text-muted">N√£o vinculado a fatura</p>
                            {% endif %}
                        </div>
                    </div>

                    <hr>

                    <h6><i class="fas fa-list"></i> Notas Fiscais Inclu√≠das</h6>
                    <div class="bg-light p-3 rounded">
                        {% if frete.numeros_nfs %}
                        {% set nfs_list = frete.numeros_nfs.split(',') %}
                        {% for nf in nfs_list %}
                        {% if nf.strip() %}
                        <span class="badge bg-primary mr-1 mb-1" style="color: white; background-color: #007bff;">{{
                            nf.strip() }}</span>
                        {% endif %}
                        {% endfor %}
                        {% else %}
                        <span class="text-muted">Nenhuma nota fiscal informada</span>
                        {% endif %}
                    </div>

                    <hr>

                    <!-- ‚úÖ SE√á√ÉO DESTACADA: CTes Vinculados -->
                    <h6><i class="fas fa-link"></i> CTes Vinculados ao Frete</h6>
                    {% if ctes_vinculados and ctes_vinculados|length > 0 %}
                        {% for cte in ctes_vinculados %}
                        <div class="alert {% if loop.index == 1 %}alert-success{% else %}alert-info{% endif %} mb-2" role="alert"
                             style="border-left: 4px solid {% if loop.index == 1 %}#28a745{% else %}#17a2b8{% endif %};">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-2">
                                        <i class="fas fa-{% if loop.index == 1 %}check-circle{% else %}info-circle{% endif %}"></i>
                                        CTe {% if loop.index == 1 %}Principal{% else %}#{{ loop.index }}{% endif %}
                                        {% if cte.vinculado_manualmente %}
                                        <span class="badge bg-primary ms-2" title="Vinculado manualmente em {{ cte.vinculado_em | formatar_data_segura if cte.vinculado_em else 'N/A' }}">
                                            <i class="fas fa-hand-pointer"></i> Manual
                                        </span>
                                        {% endif %}
                                        {% if cte.tipo_cte %}
                                        <span class="badge bg-secondary ms-1">{{ cte.tipo_cte_descricao }}</span>
                                        {% endif %}
                                        {% if cte.odoo_status_descricao %}
                                        <span class="badge bg-{% if cte.odoo_status_codigo == '06' %}success{% elif cte.odoo_status_codigo == '01' %}secondary{% else %}warning{% endif %} ms-1">
                                            {{ cte.odoo_status_descricao }}
                                        </span>
                                        {% endif %}
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>N√∫mero/S√©rie:</strong> {{ cte.numero_cte }}/{{ cte.serie_cte }}</p>
                                            <p class="mb-1"><strong>Chave:</strong> <code class="text-dark small">{{ cte.chave_acesso }}</code></p>
                                            <p class="mb-1"><strong>Emitente:</strong> {{ cte.nome_emitente }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Valor Total:</strong> <span class="badge bg-success">{{ (cte.valor_total or 0)|moeda_carteira }}</span></p>
                                            <p class="mb-1"><strong>Data Emiss√£o:</strong> {{ cte.data_emissao | formatar_data_segura if cte.data_emissao else 'N/A' }}</p>
                                            {% if cte.vencimento %}
                                            <p class="mb-1"><strong>Vencimento:</strong> {{ cte.vencimento | formatar_data_segura }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if cte.numeros_nfs %}
                                    <p class="mb-0 mt-1"><strong>NFs:</strong>
                                        {% set cte_nfs = cte.numeros_nfs.split(',') %}
                                        {% for nf in cte_nfs[:5] %}
                                        {% if nf.strip() %}
                                        <span class="badge bg-secondary me-1">{{ nf.strip() }}</span>
                                        {% endif %}
                                        {% endfor %}
                                        {% if cte_nfs|length > 5 %}<span class="text-muted small">+{{ cte_nfs|length - 5 }} NFs</span>{% endif %}
                                    </p>
                                    {% endif %}
                                </div>
                                <div class="ms-3 text-end">
                                    <a href="{{ url_for('cte.detalhar_cte', cte_id=cte.id) }}"
                                       class="btn btn-{% if loop.index == 1 %}success{% else %}info{% endif %} btn-sm mb-1 d-block"
                                       target="_blank"
                                       title="Ver detalhes completos do CTe">
                                        <i class="fas fa-external-link-alt"></i> Ver CTe
                                    </a>
                                    {% if cte.cte_pdf_path %}
                                    <a href="{{ url_for('cte.visualizar_pdf', cte_id=cte.id) }}"
                                       class="btn btn-danger btn-sm d-block"
                                       target="_blank"
                                       title="Baixar PDF do CTe">
                                        <i class="fas fa-file-pdf"></i> PDF
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        {% if ctes_vinculados|length > 1 %}
                        <div class="alert alert-warning mb-3" role="alert">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Aten√ß√£o:</strong> Este frete possui {{ ctes_vinculados|length }} CTes vinculados. Verifique se est√° correto ou se h√° duplica√ß√£o.
                        </div>
                        {% endif %}
                    {% else %}
                    <div class="alert alert-warning mb-3" role="alert" style="border-left: 4px solid #ffc107;">
                        <h6 class="alert-heading mb-2">
                            <i class="fas fa-exclamation-triangle"></i> Nenhum CTe Vinculado
                        </h6>
                        <p class="mb-0">
                            Este frete ainda n√£o possui um CTe vinculado diretamente.
                            {% if ctes_relacionados and ctes_relacionados|length > 0 %}
                            Verifique os CTes relacionados abaixo ou edite o frete para vincular manualmente.
                            {% else %}
                            Use o bot√£o "Editar Frete" para vincular um CTe manualmente.
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}

                    <!-- CTes Relacionados do Odoo (Sugest√µes) -->
                    {% if ctes_relacionados and ctes_relacionados|length > 0 %}
                    <h6 class="mt-3"><i class="fas fa-search"></i> Outros CTes Relacionados (Sugest√µes)</h6>
                    <div class="bg-light p-3 rounded">
                        <p class="text-muted small mb-2">
                            <i class="fas fa-info-circle"></i> CTes importados do Odoo com NFs em comum e mesmo prefixo de CNPJ da transportadora
                        </p>
                        <div class="d-flex flex-wrap gap-2">
                            {% for cte in ctes_relacionados %}
                            {% set ja_vinculado = ctes_vinculados and cte in ctes_vinculados %}
                            {% if not ja_vinculado %}
                            <div class="btn-group mb-1" role="group">
                                <a href="{{ url_for('cte.detalhar_cte', cte_id=cte.id) }}"
                                   class="btn btn-sm btn-outline-info d-flex align-items-center"
                                   title="CTe {{ cte.numero_cte }}/{{ cte.serie_cte }} - {{ cte.nome_emitente }} - {{ (cte.valor_total or 0)|moeda_carteira }}{% if cte.odoo_status_descricao %} - {{ cte.odoo_status_descricao }}{% endif %}"
                                   target="_blank">
                                    <i class="fas fa-external-link-alt me-1"></i>
                                    CTe {{ cte.numero_cte }}{% if cte.serie_cte %}/{{ cte.serie_cte }}{% endif %}
                                    <span class="badge bg-info ms-1" style="color: white;">{{ (cte.valor_total or 0)|moeda_carteira }}</span>
                                    {% if cte.odoo_status_descricao %}
                                    <span class="badge bg-{% if cte.odoo_status_codigo == '06' %}success{% elif cte.odoo_status_codigo == '01' %}secondary{% else %}warning{% endif %} ms-1" style="color: white;">
                                        {{ cte.odoo_status_descricao }}
                                    </span>
                                    {% endif %}
                                </a>
                                {% if cte.cte_pdf_path %}
                                <a href="{{ url_for('cte.visualizar_pdf', cte_id=cte.id) }}"
                                   class="btn btn-sm btn-danger"
                                   title="Baixar PDF do CTe {{ cte.numero_cte }}"
                                   target="_blank">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                                {% else %}
                                <button class="btn btn-sm btn-secondary" disabled title="PDF n√£o dispon√≠vel">
                                    <i class="fas fa-file-pdf"></i>
                                </button>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Dados da tabela utilizada -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table"></i> Tabela de Frete Utilizada
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Nome da Tabela:</strong> {{ frete.tabela_nome_tabela or 'N/A' }}</p>
                            <p><strong>Valor por Kg:</strong> {{ frete.tabela_valor_kg|moeda_carteira if
                                frete.tabela_valor_kg else 'N/A' }}</p>
                            <p><strong>Percentual Valor:</strong> {{ frete.tabela_percentual_valor|numero_br(4) if
                                frete.tabela_percentual_valor else 'N/A' }}%</p>
                            <p><strong>Frete M√≠nimo Peso:</strong> {{ frete.tabela_frete_minimo_peso|numero_br(2) if
                                frete.tabela_frete_minimo_peso else 'N/A' }} kg</p>
                            <p><strong>Frete M√≠nimo Valor:</strong> {{ frete.tabela_frete_minimo_valor|moeda_carteira
                                if frete.tabela_frete_minimo_valor else 'N/A' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>GRIS:</strong> {{ frete.tabela_percentual_gris|numero_br(4) if
                                frete.tabela_percentual_gris else 'N/A' }}%</p>
                            <p><strong>ADV:</strong> {{ frete.tabela_percentual_adv|numero_br(4) if
                                frete.tabela_percentual_adv else 'N/A' }}%</p>
                            <p><strong>RCA:</strong> {{ frete.tabela_percentual_rca|numero_br(4) if
                                frete.tabela_percentual_rca else 'N/A' }}%</p>
                            <p><strong>Ped√°gio/100kg:</strong> {{ frete.tabela_pedagio_por_100kg|moeda_carteira if
                                frete.tabela_pedagio_por_100kg else 'N/A' }}</p>
                            <p><strong>Valor Despacho:</strong> {{ (frete.tabela_valor_despacho)|moeda_carteira if
                                frete.tabela_valor_despacho else 'N/A' }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Valores do frete -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-dollar-sign"></i> Valores do Frete
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="font-weight-bold text-primary">Valor Cotado</label>
                        <div class="h4 text-primary">{{ (frete.valor_cotado)|moeda_carteira }}</div>
                        <small class="text-muted">Calculado pela tabela</small>
                    </div>

                    {% if frete.valor_cte %}
                    <div class="mb-3">
                        <label class="font-weight-bold text-info">Valor CTe</label>
                        <div class="h4 text-info">{{ (frete.valor_cte)|moeda_carteira }}</div>
                        <small class="text-muted">Cobrado pela transportadora</small>
                        {% if frete.valor_cotado %}
                        {% set diferenca_cte = frete.diferenca_cotado_cte() %}
                        {% if diferenca_cte != 0 %}
                        <div class="mt-1">
                            {% if diferenca_cte > 0 %}
                            <span class="badge bg-danger" style="color: white; background-color: #dc3545;">+{{
                                (diferenca_cte)|moeda_carteira }}</span>
                            {% else %}
                            <span class="badge bg-success" style="color: white; background-color: #28a745;">{{
                                (diferenca_cte)|moeda_carteira }}</span>
                            {% endif %}
                            <small class="text-muted d-block">
                                {% if diferenca_cte > 0 %}Acima{% else %}Abaixo{% endif %} do cotado
                            </small>
                        </div>
                        {% endif %}
                        {% set classificacao_cte = frete.classificacao_valor_cte_cotado() %}
                        {% if classificacao_cte %}
                        <div class="mt-1">
                            <small class="badge bg-info" style="color: white; background-color: #17a2b8;">{{
                                classificacao_cte }}</small>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if frete.valor_considerado %}
                    <div class="mb-3">
                        <label class="font-weight-bold text-success">Valor Considerado</label>
                        <div class="h4 text-success">{{ (frete.valor_considerado)|moeda_carteira }}</div>
                        <small class="text-muted">Valor v√°lido definido</small>
                    </div>
                    {% endif %}

                    {% if frete.valor_pago %}
                    <div class="mb-3">
                        <label class="font-weight-bold text-dark">Valor Pago</label>
                        <div class="h4 text-dark">{{ (frete.valor_pago)|moeda_carteira }}</div>
                        <small class="text-muted">Valor efetivamente pago</small>
                        {% if frete.valor_considerado %}
                        {% set diferenca_pago = frete.diferenca_considerado_pago() %}
                        {% if diferenca_pago != 0 %}
                        <div class="mt-1">
                            {% if diferenca_pago > 0 %}
                            <span class="badge bg-warning" style="color: #212529; background-color: #ffc107;">+{{
                                (diferenca_pago)|moeda_carteira }}</span>
                            {% else %}
                            <span class="badge bg-info" style="color: white; background-color: #17a2b8;">{{
                                (diferenca_pago)|moeda_carteira }}</span>
                            {% endif %}
                            <small class="text-muted d-block">
                                Diferen√ßa para conta corrente
                            </small>
                        </div>
                        {% endif %}
                        {% set classificacao_pago = frete.classificacao_valor_pago_considerado() %}
                        {% if classificacao_pago %}
                        <div class="mt-1">
                            {% if 'abaixo' in classificacao_pago %}
                            <small class="badge bg-success" style="color: white; background-color: #28a745;">{{
                                classificacao_pago }}</small>
                            {% elif 'deve' in classificacao_pago %}
                            <small class="badge bg-warning" style="color: #212529; background-color: #ffc107;">{{
                                classificacao_pago }}</small>
                            {% else %}
                            <small class="badge bg-secondary" style="color: white; background-color: #6c757d;">{{
                                classificacao_pago }}</small>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if frete.desconsiderar_diferenca %}
                    <div class="alert alert-warning">
                        <small><i class="fas fa-exclamation-triangle"></i> Diferen√ßa desconsiderada</small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Card Status Odoo -->
            <div class="card mb-4" id="odoo-status">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cloud"></i> Status Odoo
                    </h5>
                </div>
                <div class="card-body">
                    {% if frete.odoo_invoice_id %}
                        <!-- LAN√áADO -->
                        <div class="alert alert-success mb-3">
                            <i class="fas fa-check-circle"></i> <strong>Lan√ßado no Odoo</strong>
                        </div>

                        <div class="mb-2">
                            <small class="text-muted">DFe ID:</small>
                            <div>
                                {% if frete.odoo_dfe_id %}
                                <a href="https://odoo.nacomgoya.com.br/web#id={{ frete.odoo_dfe_id }}&model=l10n_br_ciel_it_account.dfe&view_type=form"
                                   target="_blank"
                                   class="badge bg-info text-white text-decoration-none"
                                   title="Abrir DFe {{ frete.odoo_dfe_id }} no Odoo">
                                    <i class="fas fa-external-link-alt me-1"></i>{{ frete.odoo_dfe_id }}
                                </a>
                                {% else %}
                                <strong>N/A</strong>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-2">
                            <small class="text-muted">Purchase Order ID:</small>
                            <div>
                                {% if frete.odoo_purchase_order_id %}
                                <a href="https://odoo.nacomgoya.com.br/web#id={{ frete.odoo_purchase_order_id }}&model=purchase.order&view_type=form"
                                   target="_blank"
                                   class="badge bg-primary text-white text-decoration-none"
                                   title="Abrir PO {{ frete.odoo_purchase_order_id }} no Odoo">
                                    <i class="fas fa-external-link-alt me-1"></i>{{ frete.odoo_purchase_order_id }}
                                </a>
                                {% else %}
                                <strong>N/A</strong>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted">Invoice ID:</small>
                            <div>
                                {% if frete.odoo_invoice_id %}
                                <a href="https://odoo.nacomgoya.com.br/web#id={{ frete.odoo_invoice_id }}&model=account.move&view_type=form"
                                   target="_blank"
                                   class="badge bg-success text-white text-decoration-none"
                                   title="Abrir Invoice {{ frete.odoo_invoice_id }} no Odoo">
                                    <i class="fas fa-external-link-alt me-1"></i>{{ frete.odoo_invoice_id }}
                                </a>
                                {% else %}
                                <strong>N/A</strong>
                                {% endif %}
                            </div>
                        </div>

                        <hr>

                        <div class="mb-2">
                            <small class="text-muted">Lan√ßado em:</small>
                            <div>{{ frete.lancado_odoo_em.strftime('%d/%m/%Y %H:%M') if frete.lancado_odoo_em else 'N/A' }}</div>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted">Lan√ßado por:</small>
                            <div>{{ frete.lancado_odoo_por or 'N/A' }}</div>
                        </div>

                        <a href="{{ url_for('fretes.auditoria_odoo', frete_id=frete.id) }}"
                           class="btn btn-sm btn-outline-primary w-100">
                            <i class="fas fa-history"></i> Ver Auditoria Completa
                        </a>

                    {% else %}
                        <!-- N√ÉO LAN√áADO -->
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Ainda n√£o lan√ßado no Odoo</strong>
                            <p class="mb-0 mt-2">
                                <small>Use o bot√£o "Lan√ßar no Odoo" no topo da p√°gina para iniciar o processo de lan√ßamento.</small>
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Status e aprova√ß√£o -->
            {% if frete.requer_aprovacao or (frete.aprovacao and frete.aprovacao|length > 0) %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-check-circle"></i> Aprova√ß√£o
                    </h6>
                </div>
                <div class="card-body">
                    {% if frete.aprovacao and frete.aprovacao|length > 0 %}
                    {% set aprovacao = frete.aprovacao[0] %}
                    <p><strong>Status:</strong>
                        {% if aprovacao.status == 'PENDENTE' %}
                        <span class="badge badge-status badge-status-pendente">{{ aprovacao.status }}</span>
                        {% elif aprovacao.status == 'APROVADO' %}
                        <span class="badge badge-status badge-status-aprovado">{{ aprovacao.status }}</span>
                        {% else %}
                        <span class="badge badge-status badge-status-rejeitado">{{ aprovacao.status }}</span>
                        {% endif %}
                    </p>
                    <p><strong>Solicitado por:</strong> {{ aprovacao.solicitado_por }}</p>
                    <p><strong>Em:</strong> {{ aprovacao.solicitado_em | formatar_data_hora_brasil }}</p>
                    {% if aprovacao.motivo_solicitacao %}
                    <p><strong>Motivo:</strong> {{ aprovacao.motivo_solicitacao }}</p>
                    {% endif %}
                    {% if aprovacao.aprovador %}
                    <p><strong>Aprovador:</strong> {{ aprovacao.aprovador }}</p>
                    <p><strong>Aprovado em:</strong> {{ aprovacao.aprovado_em | formatar_data_hora_brasil if
                        aprovacao.aprovado_em else 'N/A' }}</p>
                    {% endif %}
                    {% if aprovacao.observacoes_aprovacao %}
                    <p><strong>Observa√ß√µes:</strong> {{ aprovacao.observacoes_aprovacao }}</p>
                    {% endif %}
                    {% elif frete.requer_aprovacao %}
                    <div class="alert alert-warning">
                        <small>Este frete requer aprova√ß√£o</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Despesas extras -->
    {% if despesas_extras %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-circle"></i> Despesas Extras
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Motivo</th>
                                    <th>Documento</th>
                                    <th>Fatura</th>
                                    <th>CTe Vinculado</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>Odoo</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for despesa in despesas_extras %}
                                <tr>
                                    <td>
                                        {{ despesa.tipo_despesa }}<br>
                                        <small class="text-muted">{{ despesa.setor_responsavel }}</small>
                                    </td>
                                    <td>{{ despesa.motivo_despesa[:20] }}{% if despesa.motivo_despesa|length > 20 %}...{% endif %}</td>
                                    <td>
                                        <span class="badge {% if despesa.tipo_documento == 'CTe' %}bg-primary{% else %}bg-secondary{% endif %}">
                                            {{ despesa.tipo_documento }}
                                        </span><br>
                                        {% if despesa.numero_documento == 'PENDENTE_FATURA' or despesa.numero_documento == 'PENDENTE_DOCUMENTO' %}
                                        <small class="text-warning"><i class="fas fa-clock"></i> Pendente</small>
                                        {% else %}
                                        <small>{{ despesa.numero_documento }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if despesa.fatura_frete %}
                                        <a href="{{ url_for('fretes.visualizar_fatura', fatura_id=despesa.fatura_frete.id) }}"
                                            class="badge bg-primary text-white text-decoration-none"
                                            title="Ver fatura {{ despesa.fatura_frete.numero_fatura }}">
                                            <i class="fas fa-file-invoice"></i> {{ despesa.fatura_frete.numero_fatura[:10] }}{% if despesa.fatura_frete.numero_fatura|length > 10 %}...{% endif %}
                                        </a>
                                        {% else %}
                                        <!-- Permite vincular fatura mesmo ap√≥s lan√ßamento -->
                                        <a href="{{ url_for('fretes.vincular_despesa_fatura', despesa_id=despesa.id) }}"
                                            class="btn btn-sm btn-outline-warning"
                                            title="Vincular a uma fatura">
                                            <i class="fas fa-link"></i> Vincular
                                        </a>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if despesa.cte %}
                                        <span class="badge bg-info">{{ despesa.cte.numero_cte }}</span>
                                        <br><small class="text-muted">Complementar</small>
                                        {% elif despesa.tipo_documento and despesa.tipo_documento.upper() == 'CTE' %}
                                        <span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Pendente</span>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ (despesa.valor_despesa)|moeda_carteira }}</td>
                                    <td>
                                        <span class="badge
                                            {% if despesa.status == 'PENDENTE' %}bg-warning text-dark
                                            {% elif despesa.status == 'VINCULADO_CTE' %}bg-info
                                            {% elif despesa.status == 'LANCADO_ODOO' %}bg-success
                                            {% elif despesa.status == 'LANCADO' %}bg-primary
                                            {% elif despesa.status == 'CANCELADO' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ despesa.status_descricao if despesa.status_descricao else despesa.status }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if despesa.odoo_invoice_id %}
                                        <span class="badge bg-success" title="Invoice ID: {{ despesa.odoo_invoice_id }}">
                                            <i class="fas fa-check"></i>
                                        </span>
                                        {% elif despesa.tipo_documento and despesa.tipo_documento.upper() == 'CTE' %}
                                        <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i></span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical" role="group">
                                            <!-- Bot√µes de CTe e Odoo para despesas tipo CTe (aceita CTE ou CTe) -->
                                            {% if despesa.tipo_documento and despesa.tipo_documento.upper() == 'CTE' %}
                                                {% if despesa.status == 'LANCADO_ODOO' %}
                                                <!-- J√° lan√ßado no Odoo -->
                                                <a href="{{ url_for('fretes.auditoria_despesa_odoo', despesa_id=despesa.id) }}"
                                                    class="btn btn-sm btn-outline-success mb-1"
                                                    title="Ver auditoria Odoo">
                                                    <i class="fas fa-history"></i> Auditoria
                                                </a>
                                                {% elif despesa.status == 'VINCULADO_CTE' %}
                                                <!-- CTe vinculado, pode lan√ßar no Odoo -->
                                                <button onclick="abrirModalLancarDespesaOdoo({{ despesa.id }}, '{{ despesa.vencimento_despesa.strftime('%Y-%m-%d') if despesa.vencimento_despesa else '' }}')"
                                                    class="btn btn-sm btn-success mb-1"
                                                    title="Lan√ßar no Odoo">
                                                    <i class="fas fa-cloud-upload-alt"></i> Odoo
                                                </button>
                                                <form method="POST" action="{{ url_for('fretes.desvincular_cte_despesa', despesa_id=despesa.id) }}" style="display: inline-block;">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                                    <button type="submit" class="btn btn-sm btn-outline-warning mb-1"
                                                        onclick="return confirm('Desvincular CTe desta despesa?')"
                                                        title="Desvincular CTe">
                                                        <i class="fas fa-unlink"></i>
                                                    </button>
                                                </form>
                                                {% else %}
                                                <!-- Sem CTe vinculado, vincular -->
                                                <a href="{{ url_for('fretes.vincular_cte_despesa', despesa_id=despesa.id) }}"
                                                    class="btn btn-sm btn-warning mb-1"
                                                    title="Vincular CTe Complementar">
                                                    <i class="fas fa-link"></i> Vincular CTe
                                                </a>
                                                {% endif %}
                                            {% else %}
                                                <!-- NFS/Recibo - Marcar como lan√ßado com modal -->
                                                {% if despesa.status != 'LANCADO' and despesa.status != 'LANCADO_ODOO' %}
                                                <button onclick="abrirModalLancarNfsRecibo({{ despesa.id }}, '{{ despesa.tipo_documento }}', '{{ despesa.numero_documento or '' }}', '{{ despesa.vencimento_despesa.strftime('%Y-%m-%d') if despesa.vencimento_despesa else '' }}')"
                                                    class="btn btn-sm btn-primary mb-1"
                                                    title="Lan√ßar despesa (informar documento e anexar comprovante)">
                                                    <i class="fas fa-check"></i> Lan√ßar
                                                </button>
                                                {% elif despesa.status == 'LANCADO' %}
                                                <span class="badge bg-success mb-1" title="Despesa j√° lan√ßada">
                                                    <i class="fas fa-check-circle"></i> Lan√ßado
                                                </span>
                                                {% if despesa.comprovante_path %}
                                                <a href="{{ url_for('fretes.download_comprovante_despesa', despesa_id=despesa.id) }}"
                                                    class="btn btn-sm btn-outline-success mb-1"
                                                    title="Baixar comprovante">
                                                    <i class="fas fa-file-download"></i>
                                                </a>
                                                {% endif %}
                                                {% endif %}
                                            {% endif %}

                                            <!-- Bot√£o Anexar/Ver Emails -->
                                            {% if despesa.emails_anexados %}
                                            <a href="{{ url_for('emails.visualizar_email', email_id=despesa.emails_anexados[0].id) }}"
                                                class="btn btn-sm btn-outline-info mb-1"
                                                title="Ver emails anexados">
                                                <i class="fas fa-envelope"></i> ({{ despesa.emails_anexados|length }})
                                            </a>
                                            {% else %}
                                            <button onclick="abrirModalAnexarEmail({{ despesa.id }})"
                                                class="btn btn-sm btn-outline-secondary mb-1"
                                                title="Anexar email">
                                                <i class="fas fa-paperclip"></i>
                                            </button>
                                            {% endif %}

                                            <!-- Bot√£o Excluir Despesa -->
                                            {% if despesa.status not in ['LANCADO_ODOO', 'LANCADO'] %}
                                            <form method="POST"
                                                action="{{ url_for('fretes.excluir_despesa_extra', despesa_id=despesa.id) }}"
                                                style="display: inline-block;"
                                                onsubmit="return confirm('Confirma a exclus√£o desta despesa extra {{ despesa.tipo_despesa }}?')">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    title="Excluir despesa extra">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="font-weight-bold">
                                    <td colspan="5">Total Despesas Extras:</td>
                                    <td>{{ (despesas_extras|sum(attribute='valor_despesa')|moeda_carteira) }}</td>
                                    <td colspan="4"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Emails Anexados -->
    {% if emails_anexados %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-envelope"></i> Emails Anexados ({{ emails_anexados|length }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Arquivo</th>
                                    <th>Assunto</th>
                                    <th>Remetente</th>
                                    <th>Data Envio</th>
                                    <th>Despesa</th>
                                    <th>Anexado em</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for email in emails_anexados %}
                                <tr>
                                    <td>
                                        <i class="fas fa-file-alt text-primary"></i>
                                        {{ email.nome_arquivo[:30] }}{% if email.nome_arquivo|length > 30 %}...{% endif %}
                                    </td>
                                    <td>
                                        {{ email.assunto[:40] if email.assunto else 'Sem assunto' }}{% if email.assunto and email.assunto|length > 40 %}...{% endif %}
                                    </td>
                                    <td>{{ email.remetente[:30] if email.remetente else '-' }}{% if email.remetente and email.remetente|length > 30 %}...{% endif %}</td>
                                    <td>
                                        {% if email.data_envio %}
                                            {{ email.data_envio.strftime('%d/%m/%Y %H:%M') }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>
                                            {{ email.despesa_extra.tipo_despesa }}<br>
                                            {{ (email.despesa_extra.valor_despesa)|moeda_carteira }}
                                        </small>
                                    </td>
                                    <td>
                                        <small>
                                            {{ email.criado_em.strftime('%d/%m/%Y %H:%M') }}<br>
                                            por {{ email.criado_por[:15] if email.criado_por else 'Sistema' }}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('emails.visualizar_email', email_id=email.id) }}" 
                                               class="btn btn-info btn-sm" 
                                               title="Visualizar">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('emails.download_email', email_id=email.id) }}" 
                                               class="btn btn-success btn-sm" 
                                               title="Baixar">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <a href="{{ url_for('emails.excluir_email', email_id=email.id) }}" 
                                               class="btn btn-danger btn-sm"
                                               onclick="return confirm('Tem certeza que deseja excluir este email?')"
                                               title="Excluir">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if emails_anexados|length > 0 %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Dica:</strong> Clique em <i class="fas fa-eye"></i> para ver detalhes do email, 
                        <i class="fas fa-download"></i> para baixar o arquivo .msg original ou 
                        <i class="fas fa-trash"></i> para excluir.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Movimenta√ß√µes da conta corrente -->
    {% if movimentacoes_conta %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exchange-alt"></i> Movimenta√ß√µes da Conta Corrente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mov in movimentacoes_conta %}
                                <tr>
                                    <td>
                                        {% if mov.tipo_movimentacao == 'CREDITO' %}
                                        <span class="badge bg-success"
                                            style="color: white; background-color: #28a745;">{{ mov.tipo_movimentacao
                                            }}</span>
                                        {% elif mov.tipo_movimentacao == 'DEBITO' %}
                                        <span class="badge bg-danger"
                                            style="color: white; background-color: #dc3545;">{{ mov.tipo_movimentacao
                                            }}</span>
                                        {% else %}
                                        <span class="badge bg-info" style="color: white; background-color: #17a2b8;">{{
                                            mov.tipo_movimentacao }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ mov.descricao }}</td>
                                    <td>{{ (mov.valor_diferenca)|moeda_carteira }}</td>
                                    <td>
                                        {% if mov.status == 'ATIVO' %}
                                        <span class="badge bg-warning"
                                            style="color: #212529; background-color: #ffc107;">{{ mov.status }}</span>
                                        {% elif mov.status == 'COMPENSADO' %}
                                        <span class="badge bg-success"
                                            style="color: white; background-color: #28a745;">{{ mov.status }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary"
                                            style="color: white; background-color: #6c757d;">{{ mov.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ mov.criado_em | formatar_data_hora_brasil }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Observa√ß√µes -->
    {% if frete.observacoes_aprovacao %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-comment"></i> Observa√ß√µes
                    </h6>
                </div>
                <div class="card-body">
                    {{ frete.observacoes_aprovacao }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal para Anexar Email -->
<div class="modal fade" id="modalAnexarEmail" tabindex="-1" aria-labelledby="modalAnexarEmailLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAnexarEmailLabel">
                    <i class="fas fa-paperclip"></i> Anexar Email √† Despesa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formAnexarEmail" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" id="despesa_id_modal" name="despesa_id">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label for="arquivo_email" class="form-label">
                            <i class="fas fa-envelope"></i> Arquivo de Email (.msg)
                        </label>
                        <input type="file" class="form-control" id="arquivo_email" name="arquivo_email" 
                               accept=".msg" required>
                        <div class="form-text">Selecione o arquivo .msg do email</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes_email" class="form-label">
                            <i class="fas fa-comment"></i> Observa√ß√µes (opcional)
                        </label>
                        <textarea class="form-control" id="observacoes_email" name="observacoes" 
                                  rows="2" placeholder="Adicione observa√ß√µes sobre este email..."></textarea>
                    </div>
                    
                    <div id="preview_email" class="alert alert-info d-none">
                        <h6>Preview do Email:</h6>
                        <div id="preview_content"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnAnexarEmail">
                        <i class="fas fa-upload"></i> Anexar Email
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Fun√ß√£o para abrir o modal de anexar email
function abrirModalAnexarEmail(despesaId) {
    document.getElementById('despesa_id_modal').value = despesaId;
    document.getElementById('formAnexarEmail').reset();
    document.getElementById('preview_email').classList.add('d-none');
    
    const modal = new bootstrap.Modal(document.getElementById('modalAnexarEmail'));
    modal.show();
}

// Preview do arquivo selecionado
document.getElementById('arquivo_email').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const preview = document.getElementById('preview_email');
        const content = document.getElementById('preview_content');
        
        preview.classList.remove('d-none');
        content.innerHTML = `
            <p><strong>Arquivo:</strong> ${file.name}</p>
            <p><strong>Tamanho:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
        `;
    }
});

// Submeter formul√°rio via AJAX
document.getElementById('formAnexarEmail').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const despesaId = document.getElementById('despesa_id_modal').value;
    const btnSubmit = document.getElementById('btnAnexarEmail');
    
    // Desabilita o bot√£o e mostra loading
    btnSubmit.disabled = true;
    btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Anexando...';
    
    fetch(`/fretes/despesa/${despesaId}/anexar-email-ajax`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fecha o modal
            bootstrap.Modal.getInstance(document.getElementById('modalAnexarEmail')).hide();
            
            // Mostra mensagem de sucesso
            alert('Email anexado com sucesso!');
            
            // Recarrega a p√°gina para mostrar o email anexado
            location.reload();
        } else {
            alert('Erro ao anexar email: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao anexar email. Por favor, tente novamente.');
    })
    .finally(() => {
        // Reabilita o bot√£o
        btnSubmit.disabled = false;
        btnSubmit.innerHTML = '<i class="fas fa-upload"></i> Anexar Email';
    });
});

// ========================================
// MODAL E L√ìGICA DE LAN√áAMENTO NO ODOO
// ========================================

// Fun√ß√£o para lan√ßar frete no Odoo
function lancarFreteOdoo() {
    const modal = document.getElementById('modalLancarOdoo');
    const btnLancar = document.getElementById('btnLancarOdoo');
    const dataVencimento = document.getElementById('dataVencimentoOdoo').value;
    const progressContainer = document.getElementById('progressLancamento');
    const progressBar = progressContainer.querySelector('.progress-bar');
    const progressText = document.getElementById('progressText');

    // Valida√ß√£o
    if (!dataVencimento) {
        alert('Por favor, informe a data de vencimento');
        return;
    }

    // Desabilitar bot√£o e mostrar progresso
    btnLancar.disabled = true;
    btnLancar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Lan√ßando...';
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = 'Iniciando lan√ßamento...';

    // Fazer requisi√ß√£o
    fetch('{{ url_for("fretes.lancar_frete_odoo", frete_id=frete.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            data_vencimento: dataVencimento
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            // Atualizar progresso
            const etapas = data.etapas_concluidas || 0;
            const percentual = Math.round((etapas / 16) * 100);
            progressBar.style.width = percentual + '%';
            progressBar.classList.remove('bg-primary');
            progressBar.classList.add('bg-success');
            progressText.textContent = `‚úÖ ${data.mensagem}`;

            // Mostrar sucesso
            alert(`‚úÖ Lan√ßamento conclu√≠do com sucesso!\n\nEtapas: ${etapas}/16\nDFe ID: ${data.dfe_id}\nPO ID: ${data.purchase_order_id}\nInvoice ID: ${data.invoice_id}`);

            // Recarregar p√°gina ap√≥s 2 segundos
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            // Mostrar erro
            progressBar.classList.remove('bg-primary');
            progressBar.classList.add('bg-danger');
            progressText.textContent = `‚ùå ${data.mensagem}`;

            alert(`‚ùå Erro no lan√ßamento:\n\n${data.mensagem}\n\nDetalhes: ${data.erro || 'N/A'}\n\nEtapas conclu√≠das: ${data.etapas_concluidas || 0}/16`);

            // Reabilitar bot√£o
            btnLancar.disabled = false;
            btnLancar.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Lan√ßar no Odoo';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        progressBar.classList.remove('bg-primary');
        progressBar.classList.add('bg-danger');
        progressText.textContent = '‚ùå Erro na comunica√ß√£o';

        alert('‚ùå Erro ao lan√ßar frete no Odoo:\n\n' + error);

        // Reabilitar bot√£o
        btnLancar.disabled = false;
        btnLancar.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Lan√ßar no Odoo';
    });
}
</script>

<!-- Modal Lan√ßamento Odoo -->
<div class="modal fade" id="modalLancarOdoo" tabindex="-1" aria-labelledby="modalLancarOdooLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLancarOdooLabel">
                    <i class="fas fa-cloud-upload-alt"></i> Lan√ßar Frete no Odoo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Processo Automatizado</strong><br>
                    Este processo executar√° automaticamente <strong>16 etapas</strong> no Odoo:
                    <ul class="mt-2 mb-0">
                        <li>Lan√ßamento no DF-e (6 etapas)</li>
                        <li>Cria√ß√£o e confirma√ß√£o do Purchase Order (5 etapas)</li>
                        <li>Cria√ß√£o da Invoice (2 etapas)</li>
                        <li>Confirma√ß√£o final da Invoice (3 etapas)</li>
                    </ul>
                </div>

                {% if frete.vencimento %}
                <div class="alert alert-success">
                    <i class="fas fa-calendar-check"></i>
                    Vencimento atual do frete: <strong>{{ frete.vencimento.strftime('%d/%m/%Y') }}</strong>
                </div>
                {% endif %}

                <div class="mb-3">
                    <label for="dataVencimentoOdoo" class="form-label">
                        <i class="fas fa-calendar"></i> Data de Vencimento
                    </label>
                    <input type="date"
                           class="form-control"
                           id="dataVencimentoOdoo"
                           {% if frete.vencimento %}
                           value="{{ frete.vencimento.strftime('%Y-%m-%d') }}"
                           {% endif %}
                           required>
                    <small class="form-text text-muted">
                        Data em que o frete dever√° ser pago no Odoo
                    </small>
                </div>

                <!-- Barra de Progresso -->
                <div id="progressLancamento" style="display: none;">
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                             role="progressbar"
                             style="width: 0%">
                        </div>
                    </div>
                    <p id="progressText" class="text-center text-muted mb-0"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnLancarOdoo" onclick="lancarFreteOdoo()">
                    <i class="fas fa-cloud-upload-alt"></i> Lan√ßar no Odoo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Lan√ßamento Despesa no Odoo -->
<div class="modal fade" id="modalLancarDespesaOdoo" tabindex="-1" aria-labelledby="modalLancarDespesaOdooLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLancarDespesaOdooLabel">
                    <i class="fas fa-cloud-upload-alt"></i> Lan√ßar Despesa Extra no Odoo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="despesa_id_odoo">

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Processo Automatizado</strong><br>
                    Este processo executar√° automaticamente <strong>16 etapas</strong> no Odoo
                    para lan√ßar o CTe Complementar da despesa extra.
                </div>

                <div class="mb-3">
                    <label for="dataVencimentoDespesaOdoo" class="form-label">
                        <i class="fas fa-calendar"></i> Data de Vencimento
                    </label>
                    <input type="date"
                           class="form-control"
                           id="dataVencimentoDespesaOdoo"
                           required>
                    <small class="form-text text-muted">
                        Data em que a despesa dever√° ser paga no Odoo
                    </small>
                </div>

                <!-- Barra de Progresso -->
                <div id="progressLancamentoDespesa" style="display: none;">
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                             role="progressbar"
                             style="width: 0%">
                        </div>
                    </div>
                    <p id="progressTextDespesa" class="text-center text-muted mb-0"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnLancarDespesaOdoo" onclick="lancarDespesaOdoo()">
                    <i class="fas fa-cloud-upload-alt"></i> Lan√ßar no Odoo
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Fun√ß√£o para abrir modal de lan√ßamento de despesa no Odoo
function abrirModalLancarDespesaOdoo(despesaId, vencimento) {
    document.getElementById('despesa_id_odoo').value = despesaId;
    document.getElementById('dataVencimentoDespesaOdoo').value = vencimento || '';
    document.getElementById('progressLancamentoDespesa').style.display = 'none';

    const modal = new bootstrap.Modal(document.getElementById('modalLancarDespesaOdoo'));
    modal.show();
}

// Fun√ß√£o para lan√ßar despesa no Odoo
function lancarDespesaOdoo() {
    const despesaId = document.getElementById('despesa_id_odoo').value;
    const dataVencimento = document.getElementById('dataVencimentoDespesaOdoo').value;
    const btnLancar = document.getElementById('btnLancarDespesaOdoo');
    const progressContainer = document.getElementById('progressLancamentoDespesa');
    const progressBar = progressContainer.querySelector('.progress-bar');
    const progressText = document.getElementById('progressTextDespesa');

    // Valida√ß√£o
    if (!dataVencimento) {
        alert('Por favor, informe a data de vencimento');
        return;
    }

    // Desabilitar bot√£o e mostrar progresso
    btnLancar.disabled = true;
    btnLancar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Lan√ßando...';
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
    progressText.textContent = 'Iniciando lan√ßamento...';

    // Fazer requisi√ß√£o
    fetch(`/fretes/despesas/${despesaId}/lancar_odoo`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            data_vencimento: dataVencimento
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            // Atualizar progresso
            const etapas = data.etapas_concluidas || 0;
            const percentual = Math.round((etapas / 16) * 100);
            progressBar.style.width = percentual + '%';
            progressBar.classList.remove('bg-primary');
            progressBar.classList.add('bg-success');
            progressText.textContent = `${data.mensagem}`;

            // Mostrar sucesso
            alert(`Lan√ßamento conclu√≠do com sucesso!\n\nEtapas: ${etapas}/16\nDFe ID: ${data.dfe_id}\nPO ID: ${data.purchase_order_id}\nInvoice ID: ${data.invoice_id}`);

            // Recarregar p√°gina ap√≥s 2 segundos
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            // Mostrar erro
            progressBar.classList.remove('bg-primary');
            progressBar.classList.add('bg-danger');
            progressText.textContent = `${data.mensagem}`;

            alert(`Erro no lan√ßamento:\n\n${data.mensagem}\n\nDetalhes: ${data.erro || 'N/A'}\n\nEtapas conclu√≠das: ${data.etapas_concluidas || 0}/16`);

            // Reabilitar bot√£o
            btnLancar.disabled = false;
            btnLancar.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Lan√ßar no Odoo';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        progressBar.classList.remove('bg-primary');
        progressBar.classList.add('bg-danger');
        progressText.textContent = 'Erro na comunica√ß√£o';

        alert('Erro ao lan√ßar despesa no Odoo:\n\n' + error);

        // Reabilitar bot√£o
        btnLancar.disabled = false;
        btnLancar.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Lan√ßar no Odoo';
    });
}

// ========================================
// MODAL E L√ìGICA DE LAN√áAMENTO NFS/RECIBO
// ========================================

// Fun√ß√£o para abrir modal de lan√ßamento NFS/Recibo
function abrirModalLancarNfsRecibo(despesaId, tipoDocumento, numeroDocumento, vencimento) {
    document.getElementById('despesa_id_nfs').value = despesaId;
    document.getElementById('tipo_documento_nfs').value = tipoDocumento || 'NFS';
    document.getElementById('numero_documento_nfs').value = numeroDocumento || '';
    document.getElementById('vencimento_nfs').value = vencimento || '';
    document.getElementById('comprovante_nfs').value = '';
    document.getElementById('preview_comprovante').classList.add('d-none');

    const modal = new bootstrap.Modal(document.getElementById('modalLancarNfsRecibo'));
    modal.show();
}

// Preview do arquivo selecionado
document.getElementById('comprovante_nfs')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const preview = document.getElementById('preview_comprovante');
        const content = document.getElementById('preview_comprovante_content');

        preview.classList.remove('d-none');
        content.innerHTML = `
            <p class="mb-0"><strong>Arquivo:</strong> ${file.name}</p>
            <p class="mb-0"><strong>Tamanho:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
        `;
    }
});

// Submeter formul√°rio de lan√ßamento NFS/Recibo via AJAX
document.getElementById('formLancarNfsRecibo')?.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const despesaId = document.getElementById('despesa_id_nfs').value;
    const btnSubmit = document.getElementById('btnLancarNfsRecibo');

    // Valida√ß√£o
    const numeroDocumento = document.getElementById('numero_documento_nfs').value;
    if (!numeroDocumento || numeroDocumento.trim() === '') {
        alert('Por favor, informe o n√∫mero do documento.');
        return;
    }

    // Desabilita o bot√£o e mostra loading
    btnSubmit.disabled = true;
    btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Lan√ßando...';

    fetch(`/fretes/despesas/${despesaId}/lancar_nfs_recibo`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fecha o modal
            bootstrap.Modal.getInstance(document.getElementById('modalLancarNfsRecibo')).hide();

            // Mostra mensagem de sucesso
            alert('Despesa lan√ßada com sucesso!');

            // Recarrega a p√°gina
            location.reload();
        } else {
            alert('Erro ao lan√ßar despesa: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao lan√ßar despesa. Por favor, tente novamente.');
    })
    .finally(() => {
        // Reabilita o bot√£o
        btnSubmit.disabled = false;
        btnSubmit.innerHTML = '<i class="fas fa-check"></i> Lan√ßar Despesa';
    });
});
</script>

<!-- Modal Lan√ßamento NFS/Recibo -->
<div class="modal fade" id="modalLancarNfsRecibo" tabindex="-1" aria-labelledby="modalLancarNfsReciboLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalLancarNfsReciboLabel">
                    <i class="fas fa-file-invoice"></i> Lan√ßar Despesa Extra
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formLancarNfsRecibo" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" id="despesa_id_nfs" name="despesa_id">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Aten√ß√£o:</strong> Informe os dados do documento e anexe o comprovante (opcional).
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="tipo_documento_nfs" class="form-label">
                                <i class="fas fa-file-alt"></i> Tipo do Documento <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="tipo_documento_nfs" name="tipo_documento" required>
                                <option value="NFS">Nota Fiscal de Servi√ßo</option>
                                <option value="RECIBO">Recibo</option>
                                <option value="BOLETO">Boleto</option>
                                <option value="OUTROS">Outros</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="numero_documento_nfs" class="form-label">
                                <i class="fas fa-hashtag"></i> N√∫mero do Documento <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="numero_documento_nfs" name="numero_documento"
                                   required placeholder="Ex: 12345">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="vencimento_nfs" class="form-label">
                            <i class="fas fa-calendar"></i> Data de Vencimento
                        </label>
                        <input type="date" class="form-control" id="vencimento_nfs" name="vencimento">
                        <div class="form-text">Opcional - Data de vencimento do pagamento</div>
                    </div>

                    <div class="mb-3">
                        <label for="comprovante_nfs" class="form-label">
                            <i class="fas fa-paperclip"></i> Comprovante (PDF, imagem)
                        </label>
                        <input type="file" class="form-control" id="comprovante_nfs" name="comprovante"
                               accept=".pdf,.png,.jpg,.jpeg">
                        <div class="form-text">Opcional - Anexe o comprovante de pagamento</div>
                    </div>

                    <div id="preview_comprovante" class="alert alert-secondary d-none">
                        <h6><i class="fas fa-file"></i> Arquivo selecionado:</h6>
                        <div id="preview_comprovante_content"></div>
                    </div>

                    <div class="mb-3">
                        <label for="observacoes_lancamento_nfs" class="form-label">
                            <i class="fas fa-comment"></i> Observa√ß√µes
                        </label>
                        <textarea class="form-control" id="observacoes_lancamento_nfs" name="observacoes"
                                  rows="2" placeholder="Observa√ß√µes sobre o lan√ßamento..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnLancarNfsRecibo">
                        <i class="fas fa-check"></i> Lan√ßar Despesa
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}