{% extends "base.html" %}

{% block title %}Lista de Fretes{% endblock %}

{% block extra_css %}
<style>
/* ==========================================================================
   LISTAR FRETES - Theme-aware Status Badges
   ========================================================================== */

/* Badge base */
.badge-status {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.35em 0.65em;
    border-radius: 0.375rem;
}

/* Status: PENDENTE - Amarelo */
.badge-status-pendente {
    background-color: var(--bs-warning) !important;
    color: #ffffff !important;
}

/* Status: EM_TRATATIVA - Info/Cyan */
.badge-status-tratativa {
    background-color: var(--bs-info) !important;
    color: #fff !important;
}

/* Status: APROVADO - Verde */
.badge-status-aprovado {
    background-color: var(--bs-success) !important;
    color: #fff !important;
}

/* Status: REJEITADO - Vermelho */
.badge-status-rejeitado {
    background-color: var(--bs-danger) !important;
    color: #fff !important;
}

/* Status: PAGO - Primário */
.badge-status-pago {
    background-color: var(--bs-primary) !important;
    color: #0a1628 !important;
}

/* Status: LANCADO - Theme-aware */
.badge-status-lancado {
    background-color: var(--bs-tertiary-bg) !important;
    color: var(--bs-body-color) !important;
    border: 1px solid var(--bs-border-color);
}

/* Status: CANCELADO - Secundário */
.badge-status-cancelado {
    background-color: var(--bs-secondary) !important;
    color: #fff !important;
}

/* Odoo status badges - Theme-aware */
.badge-odoo-ok {
    background-color: var(--bs-success) !important;
    color: #ffffff !important;
}

.badge-odoo-pendente {
    background-color: var(--bs-warning) !important;
    color: #ffffff !important;
}

/* Em dark mode, warning é mais claro então texto escuro */
[data-bs-theme="dark"] .badge-odoo-pendente,
[data-theme="dark"] .badge-odoo-pendente {
    color: #212529 !important;
}

/* ==========================================================================
   COMPONENTES - Theme-aware
   ========================================================================== */

.card-header-theme {
    background-color: var(--bs-tertiary-bg) !important;
    color: var(--bs-body-color) !important;
    border-bottom: 1px solid var(--bs-border-color) !important;
}

.table-thead-theme {
    background-color: var(--bs-tertiary-bg) !important;
}

.table-thead-theme th {
    background-color: var(--bs-tertiary-bg) !important;
    color: var(--bs-body-color) !important;
    border-bottom: 2px solid var(--bs-border-color) !important;
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-list"></i> Lista de Fretes
            </h1>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header card-header-theme">
            <h5 class="mb-0">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosFrete"
                    aria-expanded="false">
                    <i class="fas fa-filter"></i> Filtros
                </button>
            </h5>
        </div>
        <div class="collapse" id="filtrosFrete">
            <div class="card-body">
                <form method="GET">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <div class="row">
                        <div class="col-md-2">
                            {{ form.frete_id.label(class="form-label") }}
                            {{ form.frete_id(class="form-control", placeholder="Ex: 12345") }}
                            {% if form.frete_id.description %}
                            <small class="form-text text-muted">{{ form.frete_id.description }}</small>
                            {% endif %}
                        </div>
                        <div class="col-md-2">
                            {{ form.embarque_numero.label(class="form-label") }}
                            {{ form.embarque_numero(class="form-control") }}
                        </div>
                        <div class="col-md-2">
                            {{ form.cnpj_cliente.label(class="form-label") }}
                            {{ form.cnpj_cliente(class="form-control") }}
                        </div>
                        <div class="col-md-3">
                            {{ form.nome_cliente.label(class="form-label") }}
                            {{ form.nome_cliente(class="form-control") }}
                        </div>
                        <div class="col-md-3">
                            {{ form.numero_cte.label(class="form-label") }}
                            {{ form.numero_cte(class="form-control") }}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            {{ form.numero_fatura.label(class="form-label") }}
                            {{ form.numero_fatura(class="form-control") }}
                        </div>
                        <div class="col-md-3">
                            {{ form.numero_nf.label(class="form-label") }}
                            {{ form.numero_nf(class="form-control") }}
                            {% if form.numero_nf.description %}
                            <small class="form-text text-muted">{{ form.numero_nf.description }}</small>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            {{ form.transportadora_id.label(class="form-label") }}
                            {{ form.transportadora_id(class="form-control") }}
                        </div>
                        <div class="col-md-3">
                            {{ form.status.label(class="form-label") }}
                            {{ form.status(class="form-control") }}
                        </div>
                        <div class="col-md-3">
                            {{ form.data_inicio.label(class="form-label") }}
                            {{ form.data_inicio(class="form-control") }}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            {{ form.data_fim.label(class="form-label") }}
                            {{ form.data_fim(class="form-control") }}
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                            <a href="{{ url_for('fretes.listar_fretes') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Limpar
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Ações -->
    <div class="row mb-3">
        <div class="col-12">
            <a href="{{ url_for('fretes.lancar_cte') }}" class="btn btn-success">
                <i class="fas fa-plus"></i> Lançar CTe
            </a>
            <a href="{{ url_for('fretes.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Dashboard
            </a>
        </div>
    </div>

    <!-- Lista de fretes -->
    <div class="card">
        <div class="card-body">
            {% if fretes.items %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-thead-theme">
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>CNPJ</th>
                            <th>Embarque</th>
                            <th>Transportadora</th>
                            <th>Fatura</th>
                            <th>CTe</th>
                            <th>Valor Cotado</th>
                            <th>Valor CTe</th>
                            <th>Valor Considerado</th>
                            <th>Valor Pago</th>
                            <th>Status</th>
                            <th>Odoo</th>
                            <th>Criado em</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for frete in fretes.items %}
                        <tr>
                            <td>{{ frete.id }}</td>
                            <td title="{{ frete.nome_cliente }}">{{ frete.nome_cliente[:30] }}</td>
                            <td>{{ frete.cnpj_cliente }}</td>
                            <td>
                                <a href="{{ url_for('embarques.visualizar_embarque', id=frete.embarque_id) }}">
                                    #{{ frete.embarque.numero }}
                                </a>
                            </td>
                            <td title="{{ frete.transportadora.razao_social }}">
                                {{ frete.transportadora.razao_social[:20] }}
                            </td>
                            <td>
                                {% if frete.fatura_frete %}
                                <a href="{{ url_for('fretes.listar_faturas') }}"
                                    title="Ver fatura {{ frete.fatura_frete.numero_fatura }}">
                                    {{ frete.fatura_frete.numero_fatura[:15] }}
                                </a>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if frete.numero_cte %}
                                {{ frete.numero_cte }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ (frete.valor_cotado)|moeda_carteira }}</td>
                            <td>
                                {% if frete.valor_cte %}
                                {{ (frete.valor_cte)|moeda_carteira }}
                                {% if frete.valor_cotado %}
                                {% set diferenca = frete.diferenca_cotado_cte() %}
                                {% if diferenca != 0 %}
                                <br><small class="{% if diferenca > 0 %}text-danger{% else %}text-success{% endif %}">
                                    {% if diferenca > 0 %}+{% endif %}{{ (diferenca)|moeda_carteira }}
                                </small>
                                {% endif %}
                                {% endif %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if frete.valor_considerado %}
                                {{ (frete.valor_considerado)|moeda_carteira }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if frete.valor_pago %}
                                {{ (frete.valor_pago)|moeda_carteira }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if frete.status == 'PENDENTE' %}
                                <span class="badge badge-status badge-status-pendente">{{ frete.status }}</span>
                                {% elif frete.status == 'EM_TRATATIVA' %}
                                <span class="badge badge-status badge-status-tratativa">EM TRATATIVA</span>
                                {% elif frete.status == 'APROVADO' %}
                                <span class="badge badge-status badge-status-aprovado">{{ frete.status }}</span>
                                {% elif frete.status == 'REJEITADO' %}
                                <span class="badge badge-status badge-status-rejeitado">{{ frete.status }}</span>
                                {% elif frete.status == 'PAGO' %}
                                <span class="badge badge-status badge-status-pago">{{ frete.status }}</span>
                                {% elif frete.status == 'LANCADO' %}
                                <span class="badge badge-status badge-status-lancado">{{ frete.status }}</span>
                                {% elif frete.status == 'CANCELADO' %}
                                <span class="badge badge-status badge-status-cancelado">{{ frete.status }}</span>
                                {% else %}
                                <span class="badge badge-status badge-status-cancelado">{{ frete.status }}</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if frete.odoo_invoice_id %}
                                    <a href="{{ url_for('fretes.visualizar_frete', frete_id=frete.id) }}#odoo-status"
                                       title="Lançado no Odoo - Invoice ID: {{ frete.odoo_invoice_id }}"
                                       class="text-decoration-none">
                                        <span class="badge badge-status badge-odoo-ok">
                                            <i class="fas fa-check-circle"></i> OK
                                        </span>
                                    </a>
                                {% else %}
                                    <span class="badge badge-status badge-odoo-pendente"
                                          title="Ainda não lançado no Odoo">
                                        <i class="fas fa-clock"></i> Pendente
                                    </span>
                                {% endif %}
                            </td>
                            <td>{{ frete.criado_em | formatar_data_segura }}</td>
                            <td>
                                <a href="{{ url_for('fretes.visualizar_frete', frete_id=frete.id) }}"
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if frete.status != 'CANCELADO' %}
                                <a href="{{ url_for('fretes.editar_frete', frete_id=frete.id) }}"
                                    class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginação -->
            {% if fretes.pages > 1 %}
            <nav aria-label="Paginação de fretes">
                <ul class="pagination justify-content-center">
                    {% if fretes.has_prev %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('fretes.listar_fretes', page=fretes.prev_num) }}">Anterior</a>
                    </li>
                    {% endif %}

                    {% for page_num in fretes.iter_pages() %}
                    {% if page_num %}
                    {% if page_num != fretes.page %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('fretes.listar_fretes', page=page_num) }}">{{ page_num
                            }}</a>
                    </li>
                    {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% endif %}
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if fretes.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('fretes.listar_fretes', page=fretes.next_num) }}">Próxima</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i>
                Nenhum frete encontrado.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}