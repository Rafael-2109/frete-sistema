{% extends "base.html" %}

{% block title %}Lançamento de Fretes - Freteiros{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1><i class="fas fa-truck"></i> Lançamento de Fretes - Freteiros</h1>
    
    <!-- ✅ FILTROS AVANÇADOS -->
    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosFreteiros" 
                        aria-expanded="false">
                    <i class="fas fa-filter"></i> Filtros
                </button>
            </h5>
        </div>
        <div class="collapse" id="filtrosFreteiros">
            <div class="card-body">
                <form method="GET">
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            {{ filtro_form.transportadora_id.label(class="form-label") }}
                            {{ filtro_form.transportadora_id(class="form-select") }}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Mostra apenas fretes de embarques que já saíram (com data de embarque preenchida)
                            </small>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                            <a href="{{ url_for('fretes.lancamento_freteiros') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Limpar
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
        <!-- Resumo dos Filtros Aplicados -->
    {% if filtro_form.transportadora_id.data %}
    <div class="alert alert-info">
        <i class="fas fa-filter"></i> <strong>Filtro aplicado:</strong>
        {% for choice_id, choice_name in filtro_form.transportadora_id.choices %}
            {% if choice_id|string == filtro_form.transportadora_id.data|string %}
                Freteiro: <strong>{{ choice_name }}</strong>
            {% endif %}
        {% endfor %}
        | <strong>{{ dados_freteiros|length }}</strong> freteiro(s) com pendências encontrado(s)
    </div>
    {% else %}
    <div class="alert alert-light">
        <i class="fas fa-truck"></i> <strong>{{ dados_freteiros|length }}</strong> freteiro(s) com pendências encontrado(s)
        <small class="text-muted">(apenas embarques com data de embarque preenchida)</small>
    </div>
    {% endif %}
    
    {% if not dados_freteiros %}
        <div class="alert alert-info">
            <h5>Nenhuma pendência encontrada</h5>
            <p>Não há freteiros com fretes ou despesas pendentes no momento.</p>
        </div>
    {% else %}
        {% for dados in dados_freteiros %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <div class="row">
                    <div class="col-md-8">
                        <h5>
                            <input type="checkbox" class="form-check-input me-2 transportadora-checkbox" 
                                   id="transportadora_{{ dados.freteiro.id }}" 
                                   data-transportadora-id="{{ dados.freteiro.id }}">
                            {{ dados.freteiro.razao_social }}
                        </h5>
                        <small>{{ dados.total_pendencias }} pendência(s)</small>
                    </div>
                    <div class="col-md-4">
                        <form method="POST" 
                              action="{{ url_for('fretes.emitir_fatura_freteiro', transportadora_id=dados.freteiro.id) }}" 
                              class="fatura-form" 
                              data-transportadora-id="{{ dados.freteiro.id }}"
                              id="form_{{ dados.freteiro.id }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <!-- Campos hidden para valores considerados alterados -->
                            <div id="valores_considerados_{{ dados.freteiro.id }}"></div>
                            <div class="input-group">
                                {{ form.data_vencimento(class="form-control", required=True) }}
                                <button type="submit" class="btn btn-success emitir-fatura-btn" 
                                        data-transportadora-id="{{ dados.freteiro.id }}" disabled>
                                    Emitir Fatura
                                </button>
                            </div>
                            <small id="status_{{ dados.freteiro.id }}">Preencha a data</small>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                {% if dados.fretes_por_embarque %}
                    <h6><i class="fas fa-truck-loading"></i> Fretes Pendentes</h6>
                    
                    {% for embarque_id, embarque_data in dados.fretes_por_embarque.items() %}
                        <!-- Cabeçalho do Embarque -->
                        <div class="card mb-3 border-secondary">
                            <div class="card-header bg-light">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-center">
                                            <h6 class="mb-0 me-3">
                                                <input type="checkbox" class="form-check-input me-2 embarque-checkbox" 
                                                       id="embarque_{{ embarque_id }}" 
                                                       data-embarque-id="{{ embarque_id }}"
                                                       data-transportadora-id="{{ dados.freteiro.id }}">
                                                <i class="fas fa-box"></i>
                                                {% if embarque_data.embarque.modalidade %}
                                                    <span class="badge bg-secondary me-2">{{ embarque_data.embarque.modalidade }}</span>
                                                {% endif %}
                                                <a href="{{ url_for('embarques.visualizar_embarque', id=embarque_id) }}" 
                                                   target="_blank" class="text-decoration-none">
                                                    Embarque {{ embarque_id }}
                                                </a>
                                                <span class="badge bg-info ms-2">{{ embarque_data.fretes|length }} fretes</span>
                                            </h6>
                                            
                                            <!-- Indicadores do Embarque (na mesma linha) -->
                                            {% set peso_total_calc = 0 %}
                                            {% set valor_nf_total_calc = 0 %}
                                            {% set valor_considerado_total_calc = 0 %}
                                            {% for frete_calc in embarque_data.fretes %}
                                                {% set peso_total_calc = peso_total_calc + (frete_calc.peso_total or 0) %}
                                                {% set valor_nf_total_calc = valor_nf_total_calc + (frete_calc.valor_nf or 0) %}
                                                {% set valor_considerado_total_calc = valor_considerado_total_calc + (frete_calc.valor_considerado or frete_calc.valor_cotado or 0) %}
                                            {% endfor %}
                                            <div class="ms-3" id="indicadores_embarque_{{ embarque_id }}">
                                                <small class="text-muted fw-bold">
                                                    {% if peso_total_calc > 0 %}
                                                        R$ {{ "{:.2f}".format(valor_considerado_total_calc / peso_total_calc) }}/kg
                                                    {% else %}
                                                        R$ 0,00/kg
                                                    {% endif %}
                                                    |
                                                    {% if valor_nf_total_calc > 0 %}
                                                        {{ "{:.1f}".format((valor_considerado_total_calc / valor_nf_total_calc) * 100) }}% s/ NF
                                                    {% else %}
                                                        0,0% s/ NF
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        {% set total_embarque = embarque_data.fretes | sum(attribute='valor_considerado') or embarque_data.fretes | sum(attribute='valor_cotado') or 0 %}
                                        <strong>Subtotal: R$ <span id="subtotal_{{ embarque_id }}">{{ "{:,.2f}".format(total_embarque) }}</span></strong>
                                        <div class="mt-1">
                                            <small class="text-muted">Valor Considerado:</small>
                                            <input type="number" step="0.01" min="0" 
                                                   class="form-control form-control-sm d-inline-block valor-considerado"
                                                   style="width: 120px;" 
                                                   id="valor_considerado_{{ embarque_id }}"
                                                   data-embarque-id="{{ embarque_id }}"
                                                   data-transportadora-id="{{ dados.freteiro.id }}"
                                                   data-total-original="{{ total_embarque }}"
                                                   placeholder="{{ "{:.2f}".format(total_embarque) }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tabela de Fretes do Embarque -->
                            <div class="card-body p-2">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped mb-0">
                                        <thead class="table-dark">
                                            <tr>
                                                <th style="width: 40px; text-align: center;">Sel</th>
                                                <th style="width: 250px;">Cliente</th>
                                                <th style="width: 100px; text-align: center;">NFs</th>
                                                <th style="width: 150px; text-align: center;">Destino</th>
                                                <th style="width: 80px; text-align: right;">Peso NF</th>
                                                <th style="width: 100px; text-align: right;">Valor NF</th>
                                                <th style="width: 100px; text-align: right;">Valor Cotado</th>
                                                <th style="width: 110px; text-align: right;">Valor Considerado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% set peso_total_embarque = 0 %}
                                            {% set valor_nf_total_embarque = 0 %}
                                            {% set valor_cotado_total_embarque = 0 %}
                                            {% set valor_considerado_total_embarque = 0 %}
                                            
                                            {% for frete in embarque_data.fretes %}
                                                {% set peso_frete = frete.peso_total or 0 %}
                                                {% set valor_nf_frete = frete.valor_nf or 0 %}
                                                {% set valor_cotado_frete = frete.valor_cotado or 0 %}
                                                {% set valor_considerado_frete = frete.valor_considerado or frete.valor_cotado or 0 %}
                                                
                                                {% set peso_total_embarque = peso_total_embarque + peso_frete %}
                                                {% set valor_nf_total_embarque = valor_nf_total_embarque + valor_nf_frete %}
                                                {% set valor_cotado_total_embarque = valor_cotado_total_embarque + valor_cotado_frete %}
                                                {% set valor_considerado_total_embarque = valor_considerado_total_embarque + valor_considerado_frete %}
                                                
                                            <tr class="frete-row" data-frete-id="{{ frete.id }}">
                                                <td style="text-align: center;">
                                                    <input type="checkbox" class="form-check-input frete-checkbox" 
                                                           name="fretes_selecionados" 
                                                           value="{{ frete.id }}" 
                                                           data-embarque-id="{{ embarque_id }}"
                                                           data-transportadora-id="{{ dados.freteiro.id }}"
                                                           data-peso="{{ peso_frete }}"
                                                           data-valor-nf="{{ valor_nf_frete }}"
                                                           data-valor-cotado="{{ valor_cotado_frete }}"
                                                           data-valor-considerado="{{ valor_considerado_frete }}">
                                                </td>
                                                <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                                                    title="{{ frete.nome_cliente }}">
                                                    {{ frete.nome_cliente }}
                                                </td>
                                                <td style="text-align: center;">
                                                    <small title="{{ frete.numeros_nfs }}">
                                                        {{ frete.numeros_nfs[:20] }}{% if frete.numeros_nfs|length > 20 %}...{% endif %}
                                                    </small>
                                                </td>
                                                <td style="text-align: center;">
                                                    <small>{{ frete.cidade_destino }}/{{ frete.uf_destino }}</small>
                                                </td>
                                                <td style="text-align: right;">
                                                    <small>{{ "{:,.0f}".format(peso_frete) }} kg</small>
                                                </td>
                                                <td style="text-align: right;">
                                                    <small>R$ {{ "{:,.2f}".format(valor_nf_frete) }}</small>
                                                </td>
                                                <td style="text-align: right;">
                                                    <small>R$ {{ "{:,.2f}".format(valor_cotado_frete) }}</small>
                                                </td>
                                                <td style="text-align: right;">
                                                    <strong class="valor-considerado-individual" data-frete-id="{{ frete.id }}">
                                                        R$ {{ "{:,.2f}".format(valor_considerado_frete) }}
                                                    </strong>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            
                                            <!-- Linha de Totalizador do Embarque -->
                                            <tr class="table-info">
                                                <td style="text-align: center;"><i class="fas fa-calculator"></i></td>
                                                <td><span class="text-muted fw-bold">-</span></td>
                                                <td style="text-align: center;"><span class="text-muted fw-bold">-</span></td>
                                                <td style="text-align: center;"><span class="text-muted fw-bold">Total</span></td>
                                                <td style="text-align: right;" id="peso_total_embarque_{{ embarque_id }}">
                                                    <span class="text-muted fw-bold">{{ "{:,.0f}".format(peso_total_embarque) }} kg</span>
                                                </td>
                                                <td style="text-align: right;" id="valor_nf_total_embarque_{{ embarque_id }}">
                                                    <span class="text-muted fw-bold">R$ {{ "{:,.2f}".format(valor_nf_total_embarque) }}</span>
                                                </td>
                                                <td style="text-align: right;" id="valor_cotado_total_embarque_{{ embarque_id }}">
                                                    <span class="text-muted fw-bold">R$ {{ "{:,.2f}".format(valor_cotado_total_embarque) }}</span>
                                                </td>
                                                <td style="text-align: right;" id="valor_considerado_total_embarque_{{ embarque_id }}">
                                                    <span class="text-muted fw-bold">R$ {{ "{:,.2f}".format(valor_considerado_total_embarque) }}</span>
                                                </td>
                                            </tr>

                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- 🆕 Despesas Extras do Embarque -->
                                {% if embarque_data.despesas_extras %}
                                    <div class="mt-3">
                                        <h6 class="text-warning"><i class="fas fa-receipt"></i> Despesas Extras do Embarque</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-warning">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th width="40">Sel</th>
                                                        <th>Descrição</th>
                                                        <th>Cliente</th>
                                                        <th>NFs</th>
                                                        <th width="120">Valor Original</th>
                                                        <th width="150">Valor Considerado</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for despesa in embarque_data.despesas_extras %}
                                                    <tr>
                                                        <td>
                                                            <input type="checkbox" class="form-check-input despesa-checkbox" 
                                                                   name="despesas_selecionadas" 
                                                                   value="{{ despesa.id }}" 
                                                                   data-transportadora-id="{{ dados.freteiro.id }}"
                                                                   data-embarque-id="{{ embarque_id }}"
                                                                   data-valor-original="{{ despesa.valor_despesa }}"
                                                                   data-despesa-id="{{ despesa.id }}">
                                                        </td>
                                                        <td>
                                                            <strong>{{ despesa.tipo_despesa }}</strong><br>
                                                            <small class="text-muted">{{ despesa.motivo_despesa }}</small>
                                                        </td>
                                                        <td>
                                                            <small class="fw-bold" title="{{ despesa.frete.nome_cliente }}">
                                                                {{ despesa.frete.nome_cliente[:20] }}{% if despesa.frete.nome_cliente|length > 20 %}...{% endif %}
                                                            </small>
                                                        </td>
                                                        <td>
                                                            <small class="text-primary" title="{{ despesa.frete.numeros_nfs }}">
                                                                {{ despesa.frete.numeros_nfs[:15] }}{% if despesa.frete.numeros_nfs|length > 15 %}...{% endif %}
                                                            </small>
                                                        </td>
                                                        <td class="text-end">
                                                            <small>R$ {{ "{:,.2f}".format(despesa.valor_despesa) }}</small>
                                                        </td>
                                                        <td class="text-end">
                                                            <div class="input-group input-group-sm">
                                                                <span class="input-group-text">R$</span>
                                                                <input type="number" step="0.01" min="0" 
                                                                       class="form-control valor-despesa-considerado"
                                                                       data-despesa-id="{{ despesa.id }}"
                                                                       data-transportadora-id="{{ dados.freteiro.id }}"
                                                                       data-valor-original="{{ despesa.valor_despesa }}"
                                                                       placeholder="{{ '{:.2f}'.format(despesa.valor_despesa) }}"
                                                                       title="Deixe vazio para usar valor original">
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                    
                    <!-- Total Geral da Transportadora -->
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-chart-line"></i> RESUMO GERAL - {{ dados.freteiro.razao_social }}</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead class="table-primary">
                                        <tr>
                                            <th style="text-align: center;">Embarques</th>
                                            <th style="text-align: right;">Peso Total (kg)</th>
                                            <th style="text-align: right;">Valor NF Total</th>
                                            <th style="text-align: right;">Fretes (Cotado)</th>
                                            <th style="text-align: right;">Fretes (Considerado)</th>
                                            <th style="text-align: right;">Despesas Extras</th>
                                            <th style="text-align: right;"><strong>VALOR TOTAL</strong></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="table-success fw-bold">
                                            <td style="text-align: center;">
                                                <span class="badge bg-success">{{ dados.fretes_por_embarque|length }}</span>
                                            </td>
                                            <td style="text-align: right;" id="peso_total_transportadora_{{ dados.freteiro.id }}">
                                                <strong>{{ "{:,.0f}".format(dados.peso_total or 0) }} kg</strong>
                                            </td>
                                            <td style="text-align: right;" id="valor_nf_total_transportadora_{{ dados.freteiro.id }}">
                                                <strong>R$ {{ "{:,.2f}".format(dados.valor_nf_total or 0) }}</strong>
                                            </td>
                                            <td style="text-align: right;" id="valor_cotado_total_transportadora_{{ dados.freteiro.id }}">
                                                <strong>R$ {{ "{:,.2f}".format(dados.valor_cotado_total or 0) }}</strong>
                                            </td>
                                            <td style="text-align: right;" id="valor_considerado_fretes_transportadora_{{ dados.freteiro.id }}">
                                                <strong>R$ {{ "{:,.2f}".format(dados.total_valor - (dados.despesas_extras | sum(attribute='valor_despesa') if dados.despesas_extras else 0)) }}</strong>
                                            </td>
                                            <td style="text-align: right;" id="valor_despesas_transportadora_{{ dados.freteiro.id }}">
                                                {% set total_despesas = 0 %}
                                                {% for embarque_id, embarque_data in dados.fretes_por_embarque.items() %}
                                                    {% if embarque_data.despesas_extras %}
                                                        {% set total_despesas = total_despesas + (embarque_data.despesas_extras | sum(attribute='valor_despesa')) %}
                                                    {% endif %}
                                                {% endfor %}
                                                <strong>R$ {{ "{:,.2f}".format(total_despesas) }}</strong>
                                            </td>
                                            <td style="text-align: right; background-color: #198754; color: white;" id="valor_total_final_transportadora_{{ dados.freteiro.id }}">
                                                <strong>R$ {{ "{:,.2f}".format(dados.total_valor) }}</strong>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Indicadores adicionais -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <strong>R$/kg Médio:</strong> 
                                        <span id="reais_por_kg_transportadora_{{ dados.freteiro.id }}_display">
                                            {% if dados.peso_total and dados.peso_total > 0 %}
                                                R$ {{ "{:.2f}".format(dados.total_valor / dados.peso_total) }}/kg
                                            {% else %}
                                                R$ 0,00/kg
                                            {% endif %}
                                        </span>
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <strong>% Frete s/ NF:</strong> 
                                        <span id="percentual_total_transportadora_{{ dados.freteiro.id }}_display">
                                            {% if dados.valor_nf_total and dados.valor_nf_total > 0 %}
                                                {{ "{:.2f}".format((dados.total_valor / dados.valor_nf_total) * 100) }}%
                                            {% else %}
                                                0,00%
                                            {% endif %}
                                        </span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
                

            </div>
            </form> <!-- 🔧 FECHAMENTO DO FORMULÁRIO - Agora todos os checkboxes estão incluídos -->
        </div>
        {% endfor %}
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Função para calcular rateio por peso
    function calcularRateio(embarqueId, valorTotal) {
        const fretesEmbarque = document.querySelectorAll(`input[data-embarque-id="${embarqueId}"]`);
        let pesoTotal = 0;
        
        // Calcula peso total
        fretesEmbarque.forEach(frete => {
            pesoTotal += parseFloat(frete.getAttribute('data-peso') || 0);
        });
        
        if (pesoTotal === 0) return;
        
        // Distribui valor proporcionalmente ao peso
        fretesEmbarque.forEach(frete => {
            const peso = parseFloat(frete.getAttribute('data-peso') || 0);
            const valorRateado = (peso / pesoTotal) * valorTotal;
            
            // Atualiza o valor considerado individual
            const freteId = frete.value;
            const elementoValor = document.querySelector(`.valor-considerado-individual[data-frete-id="${freteId}"]`);
            if (elementoValor) {
                elementoValor.textContent = `R$ ${valorRateado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            }
            
            // Atualiza o data-attribute
            frete.setAttribute('data-valor-considerado-rateado', valorRateado.toFixed(2));
        });
    }
    
    // Função para atualizar subtotal do embarque
    function atualizarSubtotalEmbarque(embarqueId) {
        const fretesEmbarque = document.querySelectorAll(`input[data-embarque-id="${embarqueId}"]`);
        let subtotal = 0;
        
        fretesEmbarque.forEach(frete => {
            const valorConsiderado = parseFloat(frete.getAttribute('data-valor-considerado-rateado') || 
                                             frete.getAttribute('data-valor-considerado') || 0);
            subtotal += valorConsiderado;
        });
        
        const elementoSubtotal = document.getElementById(`subtotal_${embarqueId}`);
        if (elementoSubtotal) {
            elementoSubtotal.textContent = subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }
    }
    
    // Função para atualizar total geral da transportadora
    function atualizarTotalGeral(transportadoraId) {
        const todosFretes = document.querySelectorAll(`input[name="fretes_selecionados"][data-transportadora-id="${transportadoraId}"]`);
        const todasDespesas = document.querySelectorAll(`input[name="despesas_selecionadas"][data-transportadora-id="${transportadoraId}"]`);
        
        let pesoTotalTransp = 0;
        let valorNfTotalTransp = 0;
        let valorCotadoTotalTransp = 0;
        let valorConsideradoTotalTransp = 0;
        let valorDespesasTotalTransp = 0;
        
        // Calcula totais dos fretes
        todosFretes.forEach(frete => {
            const peso = parseFloat(frete.getAttribute('data-peso') || 0);
            const valorNf = parseFloat(frete.getAttribute('data-valor-nf') || 0);
            const valorCotado = parseFloat(frete.getAttribute('data-valor-cotado') || 0);
            const valorConsiderado = parseFloat(frete.getAttribute('data-valor-considerado-rateado') || 
                                             frete.getAttribute('data-valor-considerado') || 0);
            
            pesoTotalTransp += peso;
            valorNfTotalTransp += valorNf;
            valorCotadoTotalTransp += valorCotado;
            valorConsideradoTotalTransp += valorConsiderado;
        });
        
        // Calcula totais das despesas extras
        todasDespesas.forEach(despesa => {
            const despesaId = despesa.getAttribute('data-despesa-id');
            const campoValor = document.querySelector(`.valor-despesa-considerado[data-despesa-id="${despesaId}"]`);
            const valorConsiderado = campoValor && campoValor.value ? 
                parseFloat(campoValor.value) : 
                parseFloat(despesa.getAttribute('data-valor-original') || 0);
            
            valorDespesasTotalTransp += valorConsiderado;
        });
        
        const valorTotalFinal = valorConsideradoTotalTransp + valorDespesasTotalTransp;
        
        // Atualiza elementos da transportadora
        const elementoPeso = document.getElementById(`peso_total_transportadora_${transportadoraId}`);
        if (elementoPeso) {
            elementoPeso.innerHTML = `<strong>${pesoTotalTransp.toLocaleString('pt-BR', {minimumFractionDigits: 0})} kg</strong>`;
        }
        
        const elementoValorNf = document.getElementById(`valor_nf_total_transportadora_${transportadoraId}`);
        if (elementoValorNf) {
            elementoValorNf.innerHTML = `<strong>R$ ${valorNfTotalTransp.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>`;
        }
        
        const elementoValorCotado = document.getElementById(`valor_cotado_total_transportadora_${transportadoraId}`);
        if (elementoValorCotado) {
            elementoValorCotado.innerHTML = `<strong>R$ ${valorCotadoTotalTransp.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>`;
        }
        
        const elementoValorConsideradoFretes = document.getElementById(`valor_considerado_fretes_transportadora_${transportadoraId}`);
        if (elementoValorConsideradoFretes) {
            elementoValorConsideradoFretes.innerHTML = `<strong>R$ ${valorConsideradoTotalTransp.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>`;
        }
        
        const elementoValorDespesas = document.getElementById(`valor_despesas_transportadora_${transportadoraId}`);
        if (elementoValorDespesas) {
            elementoValorDespesas.innerHTML = `<strong>R$ ${valorDespesasTotalTransp.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>`;
        }
        
        const elementoValorTotalFinal = document.getElementById(`valor_total_final_transportadora_${transportadoraId}`);
        if (elementoValorTotalFinal) {
            elementoValorTotalFinal.innerHTML = `<strong>R$ ${valorTotalFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>`;
        }
        
        // Atualiza total das despesas extras na tabela
        const elementoTotalDespesas = document.getElementById(`total_despesas_transportadora_${transportadoraId}`);
        if (elementoTotalDespesas) {
            elementoTotalDespesas.innerHTML = `<strong>R$ ${valorDespesasTotalTransp.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>`;
        }
        
        // Atualiza indicadores adicionais
        const elementoReaisKg = document.getElementById(`reais_por_kg_transportadora_${transportadoraId}_display`);
        if (elementoReaisKg) {
            const reaisKg = pesoTotalTransp > 0 ? valorTotalFinal / pesoTotalTransp : 0;
            elementoReaisKg.textContent = `R$ ${reaisKg.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}/kg`;
        }
        
        const elementoPercentual = document.getElementById(`percentual_total_transportadora_${transportadoraId}_display`);
        if (elementoPercentual) {
            const percentual = valorNfTotalTransp > 0 ? (valorTotalFinal / valorNfTotalTransp) * 100 : 0;
            elementoPercentual.textContent = `${percentual.toLocaleString('pt-BR', {minimumFractionDigits: 1, maximumFractionDigits: 1})}%`;
        }
    }
    
    // Função para atualizar totalizadores e indicadores de embarque
    function atualizarTotalizadoresEmbarque(embarqueId) {
        const fretesEmbarque = document.querySelectorAll(`input[name="fretes_selecionados"][data-embarque-id="${embarqueId}"]`);
        let pesoTotalEmb = 0;
        let valorNfTotalEmb = 0;
        let valorCotadoTotalEmb = 0;
        let valorConsideradoTotalEmb = 0;
        
        fretesEmbarque.forEach(frete => {
            const peso = parseFloat(frete.getAttribute('data-peso') || 0);
            const valorNf = parseFloat(frete.getAttribute('data-valor-nf') || 0);
            const valorCotado = parseFloat(frete.getAttribute('data-valor-cotado') || 0);
            const valorConsiderado = parseFloat(frete.getAttribute('data-valor-considerado-rateado') || 
                                             frete.getAttribute('data-valor-considerado') || 0);
            
            pesoTotalEmb += peso;
            valorNfTotalEmb += valorNf;
            valorCotadoTotalEmb += valorCotado;
            valorConsideradoTotalEmb += valorConsiderado;
        });
        
        // Atualiza totalizadores do embarque
        const elementoPesoEmb = document.getElementById(`peso_total_embarque_${embarqueId}`);
        if (elementoPesoEmb) {
            elementoPesoEmb.innerHTML = `<span class="text-muted fw-bold">${pesoTotalEmb.toLocaleString('pt-BR', {minimumFractionDigits: 0})} kg</span>`;
        }
        
        const elementoValorNfEmb = document.getElementById(`valor_nf_total_embarque_${embarqueId}`);
        if (elementoValorNfEmb) {
            elementoValorNfEmb.innerHTML = `<span class="text-muted fw-bold">R$ ${valorNfTotalEmb.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>`;
        }
        
        const elementoValorCotadoEmb = document.getElementById(`valor_cotado_total_embarque_${embarqueId}`);
        if (elementoValorCotadoEmb) {
            elementoValorCotadoEmb.innerHTML = `<span class="text-muted fw-bold">R$ ${valorCotadoTotalEmb.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>`;
        }
        
        const elementoValorConsideradoEmb = document.getElementById(`valor_considerado_total_embarque_${embarqueId}`);
        if (elementoValorConsideradoEmb) {
            elementoValorConsideradoEmb.innerHTML = `<span class="text-muted fw-bold">R$ ${valorConsideradoTotalEmb.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>`;
        }
        
        // Atualiza indicadores do embarque no cabeçalho
        const indicadoresEmbarque = document.getElementById(`indicadores_embarque_${embarqueId}`);
        if (indicadoresEmbarque) {
            const reaisKgEmb = pesoTotalEmb > 0 ? valorConsideradoTotalEmb / pesoTotalEmb : 0;
            const percentualEmb = valorNfTotalEmb > 0 ? (valorConsideradoTotalEmb / valorNfTotalEmb) * 100 : 0;
            
            indicadoresEmbarque.innerHTML = `
                <small class="text-muted fw-bold">
                    R$ ${reaisKgEmb.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}/kg
                    |
                    ${percentualEmb.toLocaleString('pt-BR', {minimumFractionDigits: 1, maximumFractionDigits: 1})}% s/ NF
                </small>
            `;
        }
    }
    
    // Função para atualizar status do botão
    function atualizarStatusBotao(transportadoraId) {
        const dataVencimento = document.querySelector(`form[data-transportadora-id="${transportadoraId}"] input[name="data_vencimento"]`);
        const botaoEmitir = document.querySelector(`.emitir-fatura-btn[data-transportadora-id="${transportadoraId}"]`);
        const statusText = document.getElementById(`status_${transportadoraId}`);
        
        const itensSelecionados = document.querySelectorAll(`input[name="fretes_selecionados"][data-transportadora-id="${transportadoraId}"]:checked, input[name="despesas_selecionadas"][data-transportadora-id="${transportadoraId}"]:checked`).length;
        const temData = dataVencimento && dataVencimento.value.trim() !== '';
        
        if (!temData) {
            botaoEmitir.disabled = true;
            statusText.textContent = 'Preencha a data de vencimento';
        } else if (itensSelecionados === 0) {
            botaoEmitir.disabled = true;
            statusText.textContent = 'Selecione pelo menos um item';
        } else {
            botaoEmitir.disabled = false;
            statusText.textContent = `Pronto: ${itensSelecionados} item(ns) selecionado(s)`;
        }
    }
    
    // Event listeners para campos de valor considerado
    document.querySelectorAll('.valor-considerado').forEach(input => {
        input.addEventListener('change', function() {
            const embarqueId = this.getAttribute('data-embarque-id');
            const transportadoraId = this.getAttribute('data-transportadora-id');
            const valorOriginal = parseFloat(this.getAttribute('data-total-original'));
            const novoValor = parseFloat(this.value) || valorOriginal;
            
            // Se valor foi alterado, fazer rateio
            if (novoValor !== valorOriginal) {
                calcularRateio(embarqueId, novoValor);
            }
            
            atualizarSubtotalEmbarque(embarqueId);
            atualizarTotalizadoresEmbarque(embarqueId);
            atualizarTotalGeral(transportadoraId);
        });
    });
    
    // Event listeners para checkboxes de embarque
    document.querySelectorAll('.embarque-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const embarqueId = this.getAttribute('data-embarque-id');
            const transportadoraId = this.getAttribute('data-transportadora-id');
            const isChecked = this.checked;
            
            // Seleciona/deseleciona todos os fretes do embarque
            document.querySelectorAll(`input[data-embarque-id="${embarqueId}"]`).forEach(item => {
                if (item.name === 'fretes_selecionados' || item.name === 'despesas_selecionadas') {
                    item.checked = isChecked;
                }
            });
            
            atualizarStatusBotao(transportadoraId);
        });
    });
    
    // Event listeners para checkboxes de transportadora
    document.querySelectorAll('.transportadora-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const transportadoraId = this.getAttribute('data-transportadora-id');
            const isChecked = this.checked;
            
            // Seleciona/deseleciona todos os itens da transportadora
            document.querySelectorAll(`input[data-transportadora-id="${transportadoraId}"]`).forEach(item => {
                if (item.name === 'fretes_selecionados' || item.name === 'despesas_selecionadas') {
                    item.checked = isChecked;
                }
            });
            
            // Seleciona/deseleciona checkboxes de embarque
            document.querySelectorAll(`.embarque-checkbox[data-transportadora-id="${transportadoraId}"]`).forEach(embarque => {
                embarque.checked = isChecked;
            });
            
            atualizarStatusBotao(transportadoraId);
        });
    });
    
    // Event listeners para checkboxes individuais de fretes
    document.querySelectorAll('input[name="fretes_selecionados"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const transportadoraId = this.getAttribute('data-transportadora-id');
            const embarqueId = this.getAttribute('data-embarque-id');
            
            // Verifica se todos os fretes do embarque estão selecionados
            const fretesEmbarque = document.querySelectorAll(`input[name="fretes_selecionados"][data-embarque-id="${embarqueId}"]`);
            const fretesSelecionados = document.querySelectorAll(`input[name="fretes_selecionados"][data-embarque-id="${embarqueId}"]:checked`);
            
            const checkboxEmbarque = document.getElementById(`embarque_${embarqueId}`);
            if (checkboxEmbarque) {
                checkboxEmbarque.checked = (fretesEmbarque.length === fretesSelecionados.length);
            }
            
            atualizarStatusBotao(transportadoraId);
        });
    });
    
    // Event listeners para campos de valor das despesas extras
    document.querySelectorAll('.valor-despesa-considerado').forEach(input => {
        input.addEventListener('change', function() {
            const transportadoraId = this.getAttribute('data-transportadora-id');
            atualizarTotalGeral(transportadoraId);
        });
    });
    
    // Event listeners para checkboxes de despesas
    document.querySelectorAll('input[name="despesas_selecionadas"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const transportadoraId = this.getAttribute('data-transportadora-id');
            atualizarTotalGeral(transportadoraId);  // Atualiza total quando despesa é selecionada/deselecionada
            atualizarStatusBotao(transportadoraId);
        });
    });
    
    // Event listeners para campos de data
    document.querySelectorAll('input[name="data_vencimento"]').forEach(input => {
        input.addEventListener('change', function() {
            const form = this.closest('form');
            const transportadoraId = form.getAttribute('data-transportadora-id');
            atualizarStatusBotao(transportadoraId);
        });
    });
    
    // Event listeners para submit dos formulários
    document.querySelectorAll('.fatura-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const transportadoraId = this.getAttribute('data-transportadora-id');
            const containerValores = document.getElementById(`valores_considerados_${transportadoraId}`);
            
            // Limpa campos hidden existentes
            containerValores.innerHTML = '';
            
            // Adiciona campos hidden para valores considerados alterados (fretes)
            document.querySelectorAll(`.valor-considerado[data-transportadora-id="${transportadoraId}"]`).forEach(input => {
                if (input.value && input.value.trim() !== '') {
                    const embarqueId = input.getAttribute('data-embarque-id');
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = `valor_considerado_${embarqueId}`;
                    hiddenInput.value = input.value;
                    containerValores.appendChild(hiddenInput);
                }
            });
            
            // Adiciona campos hidden para valores das despesas extras alterados
            document.querySelectorAll(`.valor-despesa-considerado[data-transportadora-id="${transportadoraId}"]`).forEach(input => {
                if (input.value && input.value.trim() !== '') {
                    const despesaId = input.getAttribute('data-despesa-id');
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = `valor_despesa_${despesaId}`;
                    hiddenInput.value = input.value;
                    containerValores.appendChild(hiddenInput);
                }
            });
        });
    });
    
    // Inicialização - atualiza status dos botões e totalizadores
    document.querySelectorAll('.transportadora-checkbox').forEach(checkbox => {
        const transportadoraId = checkbox.getAttribute('data-transportadora-id');
        atualizarStatusBotao(transportadoraId);
    });
    
    // 🔧 INICIALIZAÇÃO: Calcula totalizadores de todos os embarques no carregamento
    document.querySelectorAll('.embarque-checkbox').forEach(checkbox => {
        const embarqueId = checkbox.getAttribute('data-embarque-id');
        const transportadoraId = checkbox.getAttribute('data-transportadora-id');
        atualizarTotalizadoresEmbarque(embarqueId);
        atualizarTotalGeral(transportadoraId);
    });

    // ✅ Filtros agora são controlados pelo formulário HTML - funções antigas removidas
});
</script>

{% endblock %} 