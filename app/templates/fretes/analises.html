{% extends "base.html" %}

{% block title %}Análises de Fretes{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
    }

    .filter-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-bottom: 15px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .metric-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-value {
        font-size: 24px;
        font-weight: bold;
        color: #212529;
    }

    .table-analises th {
        background-color: #f8f9fa;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
    }

    .table-analises td {
        vertical-align: middle;
    }

    .badge-percentual {
        font-size: 12px;
        padding: 5px 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3">
                <i class="fas fa-chart-bar"></i> Análises de Fretes
            </h1>
            <p class="text-muted">Análises detalhadas de custos de frete por região, transportadora e veículo</p>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-card">
        <form method="GET" action="{{ url_for('fretes.analises') }}" id="formFiltros">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="data_inicio" class="form-label">Data Início</label>
                    <input type="date" class="form-control" id="data_inicio" name="data_inicio"
                           value="{{ data_inicio }}">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="data_fim" class="form-label">Data Fim</label>
                    <input type="date" class="form-control" id="data_fim" name="data_fim"
                           value="{{ data_fim }}">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="transportadora_id" class="form-label">Transportadora</label>
                    <select class="form-select" id="transportadora_id" name="transportadora_id">
                        <option value="">Todas</option>
                        {% for t in transportadoras %}
                        <option value="{{ t.id }}" {% if transportadora_id|string == t.id|string %}selected{% endif %}>
                            {{ t.razao_social }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="uf" class="form-label">UF</label>
                    <select class="form-select" id="uf" name="uf">
                        <option value="">Todas</option>
                        {% for u in ufs %}
                        <option value="{{ u }}" {% if uf == u %}selected{% endif %}>{{ u }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-1 mb-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter"></i>
                    </button>
                </div>
            </div>

            <!-- Tipo de Análise -->
            <div class="row">
                <div class="col-12">
                    <label class="form-label">Tipo de Análise Detalhada</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_uf" value="uf"
                               {% if tipo_analise == 'uf' or not tipo_analise %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_uf">
                            <i class="fas fa-map-marked-alt"></i> UF
                        </label>

                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_cidade" value="cidade"
                               {% if tipo_analise == 'cidade' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_cidade">
                            <i class="fas fa-city"></i> Cidade
                        </label>

                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_subrota" value="subrota"
                               {% if tipo_analise == 'subrota' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_subrota">
                            <i class="fas fa-route"></i> Sub-rota
                        </label>

                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_transportadora" value="transportadora"
                               {% if tipo_analise == 'transportadora' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_transportadora">
                            <i class="fas fa-truck"></i> Transportadora
                        </label>

                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_cliente" value="cliente"
                               {% if tipo_analise == 'cliente' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_cliente">
                            <i class="fas fa-building"></i> Cliente
                        </label>

                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_mes" value="mes"
                               {% if tipo_analise == 'mes' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_mes">
                            <i class="fas fa-calendar"></i> Mês
                        </label>

                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_modalidade" value="modalidade"
                               {% if tipo_analise == 'modalidade' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_modalidade">
                            <i class="fas fa-truck-moving"></i> Veículo
                        </label>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Gráficos Principais -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-map-marked-alt"></i> Análise por UF</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartUF"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-truck"></i> Análise por Transportadora</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartTransportadora"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Dados Detalhados -->
    {% if dados %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table"></i> Dados Detalhados -
                        {% if tipo_analise == 'uf' %}Por UF
                        {% elif tipo_analise == 'cidade' %}Por Cidade
                        {% elif tipo_analise == 'subrota' %}Por Sub-rota
                        {% elif tipo_analise == 'transportadora' %}Por Transportadora
                        {% elif tipo_analise == 'cliente' %}Por Cliente
                        {% elif tipo_analise == 'mes' %}Por Mês
                        {% elif tipo_analise == 'modalidade' %}Por Veículo
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm table-analises">
                            <thead>
                                <tr>
                                    {% if tipo_analise == 'uf' %}
                                    <th>UF</th>
                                    {% elif tipo_analise == 'cidade' %}
                                    <th>Cidade</th>
                                    <th>UF</th>
                                    {% elif tipo_analise == 'subrota' %}
                                    <th>Sub-rota</th>
                                    <th>UF</th>
                                    {% elif tipo_analise == 'transportadora' %}
                                    <th>Transportadora</th>
                                    {% elif tipo_analise == 'cliente' %}
                                    <th>Cliente</th>
                                    <th>CNPJ</th>
                                    {% elif tipo_analise == 'mes' %}
                                    <th>Período</th>
                                    {% elif tipo_analise == 'modalidade' %}
                                    <th>Veículo</th>
                                    {% endif %}
                                    <th class="text-end">Qtd Fretes</th>
                                    <th class="text-end">Frete (R$)</th>
                                    <th class="text-end">Despesas (R$)</th>
                                    <th class="text-end">Custo Total (R$)</th>
                                    <th class="text-end">Valor NF (R$)</th>
                                    <th class="text-end">Peso (KG)</th>
                                    <th class="text-end">% s/ Valor</th>
                                    <th class="text-end">R$/KG</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in dados %}
                                <tr>
                                    {% if tipo_analise == 'uf' %}
                                    <td><strong>{{ item.uf }}</strong></td>
                                    {% elif tipo_analise == 'cidade' %}
                                    <td>{{ item.cidade }}</td>
                                    <td><span class="badge bg-primary">{{ item.uf }}</span></td>
                                    {% elif tipo_analise == 'subrota' %}
                                    <td>{{ item.sub_rota }}</td>
                                    <td><span class="badge bg-primary">{{ item.uf }}</span></td>
                                    {% elif tipo_analise == 'transportadora' %}
                                    <td>{{ item.transportadora }}</td>
                                    {% elif tipo_analise == 'cliente' %}
                                    <td>{{ item.cliente[:40] }}...</td>
                                    <td><small>{{ item.cnpj_cliente }}</small></td>
                                    {% elif tipo_analise == 'mes' %}
                                    <td>{{ item.periodo }}</td>
                                    {% elif tipo_analise == 'modalidade' %}
                                    <td>{{ item.modalidade }}</td>
                                    {% endif %}
                                    <td class="text-end">{{ item.qtd_fretes }}</td>
                                    <td class="text-end">{{ item.valor_frete|moeda_carteira }}</td>
                                    <td class="text-end">{{ item.valor_despesa|moeda_carteira }}</td>
                                    <td class="text-end"><strong>{{ item.total_custo|moeda_carteira }}</strong></td>
                                    <td class="text-end">{{ item.valor_nf|moeda_carteira }}</td>
                                    <td class="text-end">{{ "%.2f"|format(item.peso) }}</td>
                                    <td class="text-end">
                                        <span class="badge badge-percentual
                                            {% if item.percentual_valor < 5 %}bg-success
                                            {% elif item.percentual_valor < 10 %}bg-warning text-dark
                                            {% else %}bg-danger{% endif %}">
                                            {{ "%.2f"|format(item.percentual_valor) }}%
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ "%.2f"|format(item.valor_por_kg) }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Auto-submit form quando mudar tipo de análise
document.querySelectorAll('input[name="tipo_analise"]').forEach(radio => {
    radio.addEventListener('change', () => {
        document.getElementById('formFiltros').submit();
    });
});

// Dados dos gráficos vindos do backend
const dadosUF = {{ dados_uf | tojson }};
const dadosTransportadora = {{ dados_transportadora | tojson }};

// Gráfico por UF
const ctxUF = document.getElementById('chartUF').getContext('2d');
const chartUF = new Chart(ctxUF, {
    type: 'bar',
    data: {
        labels: dadosUF.map(d => d.uf),
        datasets: [
            {
                label: '% s/ Valor NF',
                data: dadosUF.map(d => d.percentual_valor),
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                yAxisID: 'y'
            },
            {
                label: 'R$/KG',
                data: dadosUF.map(d => d.valor_por_kg),
                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1,
                yAxisID: 'y1'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        plugins: {
            tooltip: {
                callbacks: {
                    afterLabel: function(context) {
                        const index = context.dataIndex;
                        const item = dadosUF[index];
                        return [
                            `Fretes: ${item.qtd_fretes}`,
                            `Custo: R$ ${item.total_custo.toFixed(2)}`,
                            `Valor NF: R$ ${item.valor_nf.toFixed(2)}`,
                            `Peso: ${item.peso.toFixed(2)} KG`
                        ];
                    }
                }
            },
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: '% sobre Valor NF'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'R$/KG'
                },
                grid: {
                    drawOnChartArea: false,
                }
            }
        }
    }
});

// Gráfico por Transportadora
const ctxTransportadora = document.getElementById('chartTransportadora').getContext('2d');
const chartTransportadora = new Chart(ctxTransportadora, {
    type: 'bar',
    data: {
        labels: dadosTransportadora.map(d => {
            // Truncar nome longo para exibição
            const nome = d.transportadora;
            return nome.length > 20 ? nome.substring(0, 20) + '...' : nome;
        }),
        datasets: [
            {
                label: '% s/ Valor NF',
                data: dadosTransportadora.map(d => d.percentual_valor),
                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                yAxisID: 'y'
            },
            {
                label: 'R$/KG',
                data: dadosTransportadora.map(d => d.valor_por_kg),
                backgroundColor: 'rgba(255, 159, 64, 0.7)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1,
                yAxisID: 'y1'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        plugins: {
            tooltip: {
                callbacks: {
                    title: function(context) {
                        const index = context[0].dataIndex;
                        return dadosTransportadora[index].transportadora;
                    },
                    afterLabel: function(context) {
                        const index = context.dataIndex;
                        const item = dadosTransportadora[index];
                        return [
                            `Fretes: ${item.qtd_fretes}`,
                            `Custo: R$ ${item.total_custo.toFixed(2)}`,
                            `Valor NF: R$ ${item.valor_nf.toFixed(2)}`,
                            `Peso: ${item.peso.toFixed(2)} KG`
                        ];
                    }
                }
            },
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: '% sobre Valor NF'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'R$/KG'
                },
                grid: {
                    drawOnChartArea: false,
                }
            }
        }
    }
});
</script>
{% endblock %}
