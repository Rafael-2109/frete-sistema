{% extends "base.html" %}

{% block title %}An치lises de Fretes{% endblock %}

{% block styles %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
    }

    .filter-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-bottom: 15px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .metric-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-value {
        font-size: 24px;
        font-weight: bold;
        color: #212529;
    }

    .table-analises th {
        background-color: #f8f9fa;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
    }

    .table-analises td {
        vertical-align: middle;
    }

    .badge-percentual {
        font-size: 12px;
        padding: 5px 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabe칞alho -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3">
                <i class="fas fa-chart-bar"></i> An치lises de Fretes
            </h1>
            <p class="text-muted">An치lises detalhadas de custos de frete por regi칚o, transportadora e ve칤culo</p>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-card">
        <form method="GET" action="{{ url_for('fretes.analises') }}" id="formFiltros">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="data_inicio" class="form-label">Data In칤cio</label>
                    <input type="date" class="form-control" id="data_inicio" name="data_inicio"
                           value="{{ data_inicio }}">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="data_fim" class="form-label">Data Fim</label>
                    <input type="date" class="form-control" id="data_fim" name="data_fim"
                           value="{{ data_fim }}">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="transportadora_id" class="form-label">Transportadora</label>
                    <select class="form-select" id="transportadora_id" name="transportadora_id">
                        <option value="">Todas</option>
                        {% for t in transportadoras %}
                        <option value="{{ t.id }}" {% if transportadora_id|string == t.id|string %}selected{% endif %}>
                            {{ t.razao_social }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="uf" class="form-label">UF</label>
                    <select class="form-select" id="uf" name="uf">
                        <option value="">Todas</option>
                        {% for u in ufs %}
                        <option value="{{ u }}" {% if uf == u %}selected{% endif %}>{{ u }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-1 mb-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter"></i>
                    </button>
                </div>
            </div>

            <!-- Tipo de An치lise -->
            <div class="row">
                <div class="col-12">
                    <label class="form-label">Tipo de An치lise Detalhada</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_uf" value="uf"
                               {% if tipo_analise == 'uf' or not tipo_analise %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_uf">
                            <i class="fas fa-map-marked-alt"></i> UF
                        </label>

                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_cidade" value="cidade"
                               {% if tipo_analise == 'cidade' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_cidade">
                            <i class="fas fa-city"></i> Cidade
                        </label>

                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_subrota" value="subrota"
                               {% if tipo_analise == 'subrota' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_subrota">
                            <i class="fas fa-route"></i> Sub-rota
                        </label>

                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_transportadora" value="transportadora"
                               {% if tipo_analise == 'transportadora' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_transportadora">
                            <i class="fas fa-truck"></i> Transportadora
                        </label>

                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_cliente" value="cliente"
                               {% if tipo_analise == 'cliente' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_cliente">
                            <i class="fas fa-building"></i> Cliente
                        </label>

                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_mes" value="mes"
                               {% if tipo_analise == 'mes' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_mes">
                            <i class="fas fa-calendar"></i> M칡s
                        </label>

                        <input type="radio" class="btn-check" name="tipo_analise" id="tipo_modalidade" value="modalidade"
                               {% if tipo_analise == 'modalidade' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="tipo_modalidade">
                            <i class="fas fa-truck-moving"></i> Ve칤culo
                        </label>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Gr치ficos Principais -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-map-marked-alt"></i> An치lise por UF</h5>
                </div>
                <div class="card-body">
                    <div id="chartUF" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-truck"></i> An치lise por Transportadora</h5>
                </div>
                <div class="card-body">
                    <div id="chartTransportadora" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Dados Detalhados -->
    {% if dados %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table"></i> Dados Detalhados -
                        {% if tipo_analise == 'uf' %}Por UF
                        {% elif tipo_analise == 'cidade' %}Por Cidade
                        {% elif tipo_analise == 'subrota' %}Por Sub-rota
                        {% elif tipo_analise == 'transportadora' %}Por Transportadora
                        {% elif tipo_analise == 'cliente' %}Por Cliente
                        {% elif tipo_analise == 'mes' %}Por M칡s
                        {% elif tipo_analise == 'modalidade' %}Por Ve칤culo
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm table-analises">
                            <thead>
                                <tr>
                                    {% if tipo_analise == 'uf' %}
                                    <th>UF</th>
                                    {% elif tipo_analise == 'cidade' %}
                                    <th>Cidade</th>
                                    <th>UF</th>
                                    {% elif tipo_analise == 'subrota' %}
                                    <th>Sub-rota</th>
                                    <th>UF</th>
                                    {% elif tipo_analise == 'transportadora' %}
                                    <th>Transportadora</th>
                                    {% elif tipo_analise == 'cliente' %}
                                    <th>Cliente</th>
                                    <th>CNPJ</th>
                                    {% elif tipo_analise == 'mes' %}
                                    <th>Per칤odo</th>
                                    {% elif tipo_analise == 'modalidade' %}
                                    <th>Ve칤culo</th>
                                    {% endif %}
                                    <th class="text-end">Qtd Fretes</th>
                                    <th class="text-end">Frete (R$)</th>
                                    <th class="text-end">Despesas (R$)</th>
                                    <th class="text-end">Custo Total (R$)</th>
                                    <th class="text-end">Valor NF (R$)</th>
                                    <th class="text-end">Peso (KG)</th>
                                    <th class="text-end">% s/ Valor</th>
                                    <th class="text-end">R$/KG</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in dados %}
                                <tr>
                                    {% if tipo_analise == 'uf' %}
                                    <td><strong>{{ item.uf }}</strong></td>
                                    {% elif tipo_analise == 'cidade' %}
                                    <td>{{ item.cidade }}</td>
                                    <td><span class="badge bg-primary">{{ item.uf }}</span></td>
                                    {% elif tipo_analise == 'subrota' %}
                                    <td>{{ item.sub_rota }}</td>
                                    <td><span class="badge bg-primary">{{ item.uf }}</span></td>
                                    {% elif tipo_analise == 'transportadora' %}
                                    <td>{{ item.transportadora }}</td>
                                    {% elif tipo_analise == 'cliente' %}
                                    <td>{{ item.cliente[:40] }}...</td>
                                    <td><small>{{ item.cnpj_cliente }}</small></td>
                                    {% elif tipo_analise == 'mes' %}
                                    <td>{{ item.periodo }}</td>
                                    {% elif tipo_analise == 'modalidade' %}
                                    <td>{{ item.modalidade }}</td>
                                    {% endif %}
                                    <td class="text-end">{{ item.qtd_fretes }}</td>
                                    <td class="text-end">{{ item.valor_frete|moeda_carteira }}</td>
                                    <td class="text-end">{{ item.valor_despesa|moeda_carteira }}</td>
                                    <td class="text-end"><strong>{{ item.total_custo|moeda_carteira }}</strong></td>
                                    <td class="text-end">{{ item.valor_nf|moeda_carteira }}</td>
                                    <td class="text-end">{{ "%.2f"|format(item.peso) }}</td>
                                    <td class="text-end">
                                        <span class="badge badge-percentual
                                            {% if item.percentual_valor < 5 %}bg-success
                                            {% elif item.percentual_valor < 10 %}bg-warning text-dark
                                            {% else %}bg-danger{% endif %}">
                                            {{ "%.2f"|format(item.percentual_valor) }}%
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ "%.2f"|format(item.valor_por_kg) }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<!-- Google Charts -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script type="text/javascript">
// Auto-submit form quando mudar tipo de an치lise
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[name="tipo_analise"]').forEach(radio => {
        radio.addEventListener('change', () => {
            document.getElementById('formFiltros').submit();
        });
    });
});

// ========== DADOS DO BACKEND ==========
var dadosUF = {{ dados_uf | tojson | safe }};
var dadosTransportadora = {{ dados_transportadora | tojson | safe }};

console.log('游늵 Dados UF:', dadosUF);
console.log('游늵 Dados Transportadora:', dadosTransportadora);

// ========== CARREGAR GOOGLE CHARTS ==========
google.charts.load('current', {'packages':['corechart', 'bar']});
google.charts.setOnLoadCallback(desenharGraficos);

function desenharGraficos() {
    desenharGraficoUF();
    desenharGraficoTransportadora();
}

// ========== GR츼FICO POR UF ==========
function desenharGraficoUF() {
    var container = document.getElementById('chartUF');

    if (!dadosUF || dadosUF.length === 0) {
        container.innerHTML = '<div class="alert alert-info">Nenhum dado dispon칤vel para o per칤odo selecionado.</div>';
        return;
    }

    // Preparar dados para Google Charts
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'UF');
    data.addColumn('number', '% s/ Valor NF');
    data.addColumn({type: 'string', role: 'tooltip', p: {html: true}});
    data.addColumn('number', 'R$/KG');
    data.addColumn({type: 'string', role: 'tooltip', p: {html: true}});

    dadosUF.forEach(function(item) {
        var tooltipPercentual = '<div style="padding:10px;">' +
            '<strong>' + item.uf + '</strong><br>' +
            '<b>% s/ Valor NF:</b> ' + item.percentual_valor.toFixed(2) + '%<br>' +
            '<b>Fretes:</b> ' + item.qtd_fretes + '<br>' +
            '<b>Custo Total:</b> R$ ' + item.total_custo.toFixed(2) + '<br>' +
            '<b>Valor NF:</b> R$ ' + item.valor_nf.toFixed(2) + '<br>' +
            '<b>Peso:</b> ' + item.peso.toFixed(2) + ' KG' +
            '</div>';

        var tooltipRsKg = '<div style="padding:10px;">' +
            '<strong>' + item.uf + '</strong><br>' +
            '<b>R$/KG:</b> R$ ' + item.valor_por_kg.toFixed(2) + '<br>' +
            '<b>Fretes:</b> ' + item.qtd_fretes + '<br>' +
            '<b>Custo Total:</b> R$ ' + item.total_custo.toFixed(2) + '<br>' +
            '<b>Valor NF:</b> R$ ' + item.valor_nf.toFixed(2) + '<br>' +
            '<b>Peso:</b> ' + item.peso.toFixed(2) + ' KG' +
            '</div>';

        data.addRow([
            item.uf,
            item.percentual_valor,
            tooltipPercentual,
            item.valor_por_kg,
            tooltipRsKg
        ]);
    });

    var options = {
        title: 'An치lise por UF',
        width: '100%',
        height: 400,
        series: {
            0: {targetAxisIndex: 0, color: '#3498db'},
            1: {targetAxisIndex: 1, color: '#e74c3c'}
        },
        vAxes: {
            0: {title: '% sobre Valor NF'},
            1: {title: 'R$/KG'}
        },
        hAxis: {title: 'UF'},
        tooltip: {isHtml: true},
        legend: {position: 'top'}
    };

    var chart = new google.visualization.ColumnChart(container);
    chart.draw(data, options);
}

// ========== GR츼FICO POR TRANSPORTADORA ==========
function desenharGraficoTransportadora() {
    var container = document.getElementById('chartTransportadora');

    if (!dadosTransportadora || dadosTransportadora.length === 0) {
        container.innerHTML = '<div class="alert alert-info">Nenhum dado dispon칤vel para o per칤odo selecionado.</div>';
        return;
    }

    // Preparar dados para Google Charts
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Transportadora');
    data.addColumn('number', '% s/ Valor NF');
    data.addColumn({type: 'string', role: 'tooltip', p: {html: true}});
    data.addColumn('number', 'R$/KG');
    data.addColumn({type: 'string', role: 'tooltip', p: {html: true}});

    dadosTransportadora.forEach(function(item) {
        // Truncar nome longo
        var nomeExibicao = item.transportadora.length > 20
            ? item.transportadora.substring(0, 20) + '...'
            : item.transportadora;

        var tooltipPercentual = '<div style="padding:10px;">' +
            '<strong>' + item.transportadora + '</strong><br>' +
            '<b>% s/ Valor NF:</b> ' + item.percentual_valor.toFixed(2) + '%<br>' +
            '<b>Fretes:</b> ' + item.qtd_fretes + '<br>' +
            '<b>Custo Total:</b> R$ ' + item.total_custo.toFixed(2) + '<br>' +
            '<b>Valor NF:</b> R$ ' + item.valor_nf.toFixed(2) + '<br>' +
            '<b>Peso:</b> ' + item.peso.toFixed(2) + ' KG' +
            '</div>';

        var tooltipRsKg = '<div style="padding:10px;">' +
            '<strong>' + item.transportadora + '</strong><br>' +
            '<b>R$/KG:</b> R$ ' + item.valor_por_kg.toFixed(2) + '<br>' +
            '<b>Fretes:</b> ' + item.qtd_fretes + '<br>' +
            '<b>Custo Total:</b> R$ ' + item.total_custo.toFixed(2) + '<br>' +
            '<b>Valor NF:</b> R$ ' + item.valor_nf.toFixed(2) + '<br>' +
            '<b>Peso:</b> ' + item.peso.toFixed(2) + ' KG' +
            '</div>';

        data.addRow([
            nomeExibicao,
            item.percentual_valor,
            tooltipPercentual,
            item.valor_por_kg,
            tooltipRsKg
        ]);
    });

    var options = {
        title: 'An치lise por Transportadora',
        width: '100%',
        height: 400,
        series: {
            0: {targetAxisIndex: 0, color: '#2ecc71'},
            1: {targetAxisIndex: 1, color: '#f39c12'}
        },
        vAxes: {
            0: {title: '% sobre Valor NF'},
            1: {title: 'R$/KG'}
        },
        hAxis: {title: 'Transportadora', slantedText: true, slantedTextAngle: 45},
        tooltip: {isHtml: true},
        legend: {position: 'top'}
    };

    var chart = new google.visualization.ColumnChart(container);
    chart.draw(data, options);
}

// Redesenhar gr치ficos ao redimensionar janela
window.addEventListener('resize', function() {
    desenharGraficos();
});
</script>
{% endblock %}
