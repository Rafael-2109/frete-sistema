{% extends "base.html" %}

{% block title %}Visualizar Fatura - {{ fatura.numero_fatura }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-eye"></i> Visualizar Fatura - {{ fatura.numero_fatura }}</h2>
        <div>
            {% if fatura.status_conferencia != 'CONFERIDO' %}
            <a href="{{ url_for('fretes.editar_fatura', fatura_id=fatura.id) }}" class="btn btn-warning">
                <i class="fas fa-edit"></i> Editar
            </a>
            {% endif %}
            <a href="{{ url_for('fretes.listar_faturas') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar às Faturas
            </a>
        </div>
    </div>

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('fretes.index') }}">Fretes</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('fretes.listar_faturas') }}">Faturas</a></li>
            <li class="breadcrumb-item active">{{ fatura.numero_fatura }}</li>
        </ol>
    </nav>

    <!-- Dados da Fatura -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-file-invoice"></i> Dados da Fatura</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Informações Básicas</h6>
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Número da Fatura:</strong></td>
                            <td>{{ fatura.numero_fatura }}</td>
                        </tr>
                        <tr>
                            <td><strong>Transportadora:</strong></td>
                            <td>{{ fatura.transportadora.razao_social }}</td>
                        </tr>
                        <tr>
                            <td><strong>Data de Emissão:</strong></td>
                            <td>{{ fatura.data_emissao | formatar_data_segura if fatura.data_emissao else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Vencimento:</strong></td>
                            <td>{{ fatura.vencimento | formatar_data_segura if fatura.vencimento else 'N/A' }}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Valores e Status</h6>
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Valor Total:</strong></td>
                            <td><span class="h5 text-success">{{ (fatura.valor_total_fatura)|moeda_carteira }}</span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>
                                {% if fatura.status_conferencia == 'CONFERIDO' %}
                                <span class="badge bg-success">CONFERIDO</span>
                                {% elif fatura.status_conferencia == 'EM_CONFERENCIA' %}
                                <span class="badge bg-warning">EM CONFERÊNCIA</span>
                                {% else %}
                                <span class="badge bg-secondary">PENDENTE</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Criado em:</strong></td>
                            <td>{{ fatura.criado_em | formatar_data_hora_brasil if fatura.criado_em else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Criado por:</strong></td>
                            <td>{{ fatura.criado_por or 'N/A' }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumo de Vinculações -->
    <div class="card mt-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Resumo</h5>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h3 class="text-primary">{{ fatura.total_fretes() }}</h3>
                            <p class="mb-0">Fretes Vinculados</p>
                            <small class="text-muted">{{ (fatura.valor_total_fretes()|moeda_carteira) }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h3 class="text-warning">{{ fatura.total_despesas_extras() }}</h3>
                            <p class="mb-0">Despesas Extras</p>
                            <small class="text-muted">{{ (fatura.valor_total_despesas_extras()|moeda_carteira)
                                }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h3 class="text-success">{{ (fatura.valor_total_fretes() + fatura.valor_total_despesas_extras())|moeda_carteira }}</h3>
                            <p class="mb-0">Total Calculado</p>
                            <small class="text-muted">Fretes + Despesas</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body">
                            {% if fatura.arquivo_pdf %}
                            <a href="{{ url_for('fretes.download_pdf_fatura', fatura_id=fatura.id) }}" target="_blank"
                                class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-file-pdf"></i> Ver PDF
                            </a>
                            {% else %}
                            <p class="text-muted mb-0">Sem Anexo</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fretes Vinculados (se houver) -->
    {% if fatura.total_fretes() > 0 %}
    <div class="card mt-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-truck"></i> Fretes Vinculados ({{ fatura.total_fretes() }})</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th class="col-pedido">CTe</th>
                            <th class="col-nome">Cliente</th>
                            <th class="col-id">Embarque</th>
                            <th class="col-pedido">NFs Incluídas</th>
                            <th class="col-valor">Valor Cotado</th>
                            <th class="col-valor">Valor CTe</th>
                            <th class="col-valor">Valor Considerado</th>
                            <th class="col-valor">Valor Pago</th>
                            <th class="col-status">Status</th>
                            <th class="col-nowrap">Odoo</th>
                            <th class="col-acoes">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for frete in fatura.fretes %}
                        <tr>
                            <td>{{ frete.numero_cte or 'Pendente' }}</td>
                            <td title="{{ frete.nome_cliente }}">
                                {{ frete.nome_cliente[:30] }}{% if frete.nome_cliente|length > 30 %}...{% endif %}
                            </td>
                            <td>
                                {% if frete.embarque %}
                                <a href="{{ url_for('embarques.visualizar_embarque', id=frete.embarque.id) }}">
                                    #{{ frete.embarque.numero }}
                                </a>
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if frete.numeros_nfs %}
                                <span class="badge bg-info" title="NFs deste frete">
                                    {{ frete.quantidade_nfs or 0 }} NF(s)
                                </span>
                                <br><small class="text-muted">
                                    {{ frete.numeros_nfs[:50] }}{% if frete.numeros_nfs|length > 50 %}...{% endif %}
                                </small>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td><strong>{{ (frete.valor_cotado or 0)|moeda_carteira }}</strong></td>
                            <td><strong>{{ (frete.valor_cte or 0)|moeda_carteira }}</strong></td>
                            <td><strong>{{ (frete.valor_considerado or 0)|moeda_carteira }}</strong></td>
                            <td><strong>{{ (frete.valor_pago or 0)|moeda_carteira }}</strong></td>
                            <td>
                                {% if frete.status == 'APROVADO' %}
                                <span class="badge bg-success">{{ frete.status }}</span>
                                {% elif frete.status == 'PENDENTE' %}
                                <span class="badge bg-warning">{{ frete.status }}</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ frete.status }}</span>
                                {% endif %}
                            </td>
                            <!-- Status Odoo -->
                            <td>
                                {% if frete.status == 'LANCADO_ODOO' and frete.odoo_invoice_id %}
                                <span class="badge bg-success" title="Lançado no Odoo - Invoice ID: {{ frete.odoo_invoice_id }}">
                                    <i class="fas fa-check-circle"></i> OK
                                </span>
                                {% elif frete.odoo_erro %}
                                <span class="badge bg-danger" title="{{ frete.odoo_erro[:100] }}">
                                    <i class="fas fa-times-circle"></i> Erro
                                </span>
                                {% else %}
                                <span class="badge bg-secondary" title="Pendente de lançamento no Odoo">
                                    <i class="fas fa-clock"></i> Pendente
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('fretes.visualizar_frete', frete_id=frete.id) }}"
                                    class="btn btn-sm btn-outline-primary" title="Ver Frete">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if fatura.status_conferencia != 'CONFERIDO' %}
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        title="Remover da Fatura"
                                        onclick="confirmarRemoverFrete({{ frete.id }}, '{{ frete.numero_cte or 'Sem CTe' }}', '{{ frete.nome_cliente[:30] }}')">
                                    <i class="fas fa-unlink"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Despesas Extras Vinculadas (se houver) -->
    {% if fatura.total_despesas_extras() > 0 %}
    <div class="card mt-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-exclamation-circle"></i> Despesas Extras Vinculadas ({{
                fatura.total_despesas_extras() }})</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th class="col-id">ID</th>
                            <th class="col-nowrap">Tipo</th>
                            <th class="col-id">Frete</th>
                            <th class="col-nome">Cliente</th>
                            <th class="col-pedido">NFs Relacionadas</th>
                            <th class="col-pedido">Documento</th>
                            <th class="col-valor">Valor</th>
                            <th class="col-data">Vencimento</th>
                            <th class="col-nowrap">Odoo</th>
                            <th class="col-acoes">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for despesa in fatura.todas_despesas_extras() %}
                        <tr>
                            <td><strong>#{{ despesa.id }}</strong></td>
                            <td>
                                <span class="badge bg-info">{{ despesa.tipo_despesa }}</span>
                            </td>
                            <td>
                                <a href="{{ url_for('fretes.visualizar_frete', frete_id=despesa.frete.id) }}">
                                    Frete #{{ despesa.frete.id }}
                                </a>
                            </td>
                            <td title="{{ despesa.frete.nome_cliente }}">
                                {{ despesa.frete.nome_cliente[:25] }}{% if despesa.frete.nome_cliente|length > 25
                                %}...{% endif %}
                            </td>
                            <td>
                                {% if despesa.frete.numeros_nfs %}
                                <span class="badge bg-secondary" title="NFs do frete relacionado">
                                    {{ despesa.frete.quantidade_nfs or 0 }} NF(s)
                                </span>
                                <br><small class="text-muted">
                                    {{ despesa.frete.numeros_nfs[:30] }}{% if despesa.frete.numeros_nfs|length > 30
                                    %}...{% endif %}
                                </small>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ despesa.numero_documento or 'Pendente' }}</td>
                            <td><strong>{{ (despesa.valor_despesa)|moeda_carteira }}</strong></td>
                            <td>{{ despesa.vencimento_despesa | formatar_data_segura if despesa.vencimento_despesa else
                                'N/A' }}</td>
                            <!-- Status Odoo -->
                            <td>
                                {% if despesa.status == 'LANCADO_ODOO' and despesa.odoo_invoice_id %}
                                <span class="badge bg-success" title="Lançado no Odoo - Invoice ID: {{ despesa.odoo_invoice_id }}">
                                    <i class="fas fa-check-circle"></i> OK
                                </span>
                                {% elif despesa.odoo_erro %}
                                <span class="badge bg-danger" title="{{ despesa.odoo_erro[:100] if despesa.odoo_erro else 'Erro' }}">
                                    <i class="fas fa-times-circle"></i> Erro
                                </span>
                                {% else %}
                                <span class="badge bg-secondary" title="Pendente de lançamento no Odoo">
                                    <i class="fas fa-clock"></i> Pendente
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('fretes.visualizar_frete', frete_id=despesa.frete.id) }}"
                                    class="btn btn-sm btn-outline-primary" title="Ver Frete">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Conferência (se houver) -->
    {% if fatura.status_conferencia == 'CONFERIDO' and fatura.conferido_por %}
    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-check-circle"></i> Informações da Conferência</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Conferido por:</strong> {{ fatura.conferido_por }}</p>
                    <p><strong>Conferido em:</strong> {{ fatura.conferido_em | formatar_data_hora_brasil if
                        fatura.conferido_em else 'N/A' }}</p>
                </div>
                <div class="col-md-6">
                    {% if fatura.observacoes_conferencia %}
                    <p><strong>Observações:</strong></p>
                    <div class="alert alert-light">
                        {{ fatura.observacoes_conferencia }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ========================================
         CARD: LANÇAMENTO NO ODOO
         Exibe botão para lançar todos os CTes da fatura no Odoo
    ======================================== -->
    {% if fatura.status_conferencia == 'CONFERIDO' %}
    <div class="card mt-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-cloud-upload-alt"></i> Lançamento no Odoo</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h6>Status de Lançamento dos Documentos</h6>
                    <div id="resumo-lancamento">
                        <p><i class="fas fa-spinner fa-spin"></i> Carregando status...</p>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <button type="button" class="btn btn-success btn-lg" id="btnAbrirModalLancar"
                            onclick="abrirModalLancarOdoo()" disabled>
                        <i class="fas fa-cloud-upload-alt"></i> Lançar no Odoo
                    </button>
                    <p class="text-muted mt-2 small" id="info-lancamento">Verificando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Lançamento -->
    <div class="modal fade" id="modalLancarOdoo" tabindex="-1" aria-labelledby="modalLancarOdooLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalLancarOdooLabel">
                        <i class="fas fa-cloud-upload-alt"></i> Lançar Fatura no Odoo
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Deseja lançar os fretes e despesas desta fatura no Odoo?</h6>
                        <p class="mb-0">
                            Fatura: <strong>{{ fatura.numero_fatura }}</strong><br>
                            Transportadora: <strong>{{ fatura.transportadora.razao_social if fatura.transportadora else 'N/A' }}</strong>
                        </p>
                    </div>

                    <!-- Resumo do que será lançado -->
                    <div id="modal-resumo-lancamento">
                        <p><i class="fas fa-spinner fa-spin"></i> Carregando detalhes...</p>
                    </div>

                    <!-- Campo de vencimento (se não houver na fatura) -->
                    <div id="campo-vencimento" class="alert alert-info d-none">
                        <h6><i class="fas fa-calendar-alt"></i> Informe o Vencimento</h6>
                        <p class="mb-2">A fatura não possui vencimento cadastrado. Informe a data de vencimento para o lançamento:</p>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="date" class="form-control" id="inputVencimento" required>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Este vencimento será salvo na fatura e usado para todos os documentos.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Alerta de vencimentos passados -->
                    <div id="alerta-vencimentos" class="alert alert-warning d-none">
                        <h6><i class="fas fa-exclamation-triangle"></i> Atenção: Vencimento Passado!</h6>
                        <p class="mb-0" id="detalhe-vencimentos"></p>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="confirmarVencimentos">
                            <label class="form-check-label" for="confirmarVencimentos">
                                Confirmo que desejo lançar mesmo com vencimento passado
                            </label>
                        </div>
                    </div>

                    <div class="alert alert-secondary mt-3">
                        <small>
                            <i class="fas fa-clock"></i> O lançamento será processado em background.
                            Acompanhe o status na <a href="{{ url_for('fretes.auditoria_lancamentos') }}" target="_blank"><strong>Auditoria de Lançamentos Odoo</strong></a>.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success" id="btnConfirmarLancar" onclick="confirmarLancamentoOdoo()">
                        <i class="fas fa-cloud-upload-alt"></i> Confirmar Lançamento
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Fatura não conferida - não pode lançar -->
    <div class="card mt-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-cloud-upload-alt"></i> Lançamento no Odoo</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-warning mb-0">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Fatura não conferida.</strong>
                É necessário conferir a fatura antes de lançar os documentos no Odoo.
                <br><br>
                <a href="{{ url_for('fretes.conferir_fatura', fatura_id=fatura.id) }}" class="btn btn-warning">
                    <i class="fas fa-check-double"></i> Conferir Fatura
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Modal de Confirmação de Remoção de Frete -->
    <div class="modal fade" id="modalRemoverFrete" tabindex="-1" aria-labelledby="modalRemoverFreteLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalRemoverFreteLabel">
                        <i class="fas fa-unlink"></i> Remover Frete da Fatura
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> Atenção!</h6>
                        <p class="mb-0">Esta ação irá:</p>
                        <ul class="mb-0">
                            <li>Desvincular o frete desta fatura</li>
                            <li>Cancelar o CTe (se existir)</li>
                            <li>Limpar os dados de valor CTe e vencimento</li>
                            <li>Voltar o frete para status PENDENTE</li>
                        </ul>
                    </div>
                    <p><strong>Frete:</strong> <span id="modalFreteNumero"></span></p>
                    <p><strong>Cliente:</strong> <span id="modalFreteCliente"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarRemover" onclick="executarRemoverFrete()">
                        <i class="fas fa-unlink"></i> Confirmar Remoção
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ========================================
// LANÇAMENTO DE FATURA NO ODOO
// ========================================

let dadosLancamento = null;

// Carrega status de lançamento ao abrir a página
document.addEventListener('DOMContentLoaded', function() {
    {% if fatura.status_conferencia == 'CONFERIDO' %}
    carregarStatusLancamento();
    {% endif %}
});

function carregarStatusLancamento() {
    fetch('{{ url_for("fretes.verificar_status_lancamento_fatura", fatura_id=fatura.id) }}')
        .then(response => response.json())
        .then(data => {
            dadosLancamento = data;
            atualizarResumoLancamento(data);
        })
        .catch(error => {
            console.error('Erro ao carregar status:', error);
            document.getElementById('resumo-lancamento').innerHTML =
                '<p class="text-danger"><i class="fas fa-exclamation-circle"></i> Erro ao carregar status</p>';
        });
}

function atualizarResumoLancamento(data) {
    let html = '<table class="table table-sm">';
    html += '<tr><th>Tipo</th><th>Total</th><th>Já Lançados</th><th>Pendentes</th></tr>';

    // Fretes
    html += `<tr>
        <td><span class="badge bg-primary">CTes</span></td>
        <td>${data.total_fretes}</td>
        <td><span class="text-success">${data.fretes_lancados}</span></td>
        <td><span class="text-warning">${data.fretes_pendentes}</span></td>
    </tr>`;

    // Despesas
    html += `<tr>
        <td><span class="badge bg-warning text-dark">Despesas</span></td>
        <td>${data.total_despesas}</td>
        <td><span class="text-success">${data.despesas_lancadas}</span></td>
        <td><span class="text-warning">${data.despesas_pendentes}</span></td>
    </tr>`;

    html += '</table>';

    // Vencimentos passados
    if (data.vencimentos_passados && data.vencimentos_passados.length > 0) {
        html += `<p class="text-warning mb-0">
            <i class="fas fa-exclamation-triangle"></i>
            ${data.vencimentos_passados.length} documento(s) com vencimento passado
        </p>`;
    }

    document.getElementById('resumo-lancamento').innerHTML = html;

    // Habilita/desabilita botão
    const btnLancar = document.getElementById('btnAbrirModalLancar');
    const infoLancamento = document.getElementById('info-lancamento');

    const totalPendentes = data.fretes_pendentes + data.despesas_pendentes;

    if (totalPendentes > 0) {
        btnLancar.disabled = false;
        infoLancamento.innerHTML = `<span class="text-success">${totalPendentes} documento(s) para lançar</span>`;
    } else if (data.total_fretes + data.total_despesas === 0) {
        btnLancar.disabled = true;
        infoLancamento.innerHTML = '<span class="text-muted">Nenhum documento na fatura</span>';
    } else {
        btnLancar.disabled = true;
        infoLancamento.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Todos já lançados</span>';
    }
}

function abrirModalLancarOdoo() {
    if (!dadosLancamento) {
        alert('Aguarde carregar os dados...');
        return;
    }

    // Atualiza modal com detalhes
    let html = '<h6>Documentos a serem lançados:</h6>';
    html += '<ul class="list-group">';

    if (dadosLancamento.fretes_pendentes > 0) {
        html += `<li class="list-group-item d-flex justify-content-between">
            <span><i class="fas fa-file-alt text-primary"></i> CTes (Fretes)</span>
            <span class="badge bg-primary">${dadosLancamento.fretes_pendentes}</span>
        </li>`;
    }

    if (dadosLancamento.despesas_pendentes > 0) {
        html += `<li class="list-group-item d-flex justify-content-between">
            <span><i class="fas fa-receipt text-warning"></i> Despesas Extras</span>
            <span class="badge bg-warning text-dark">${dadosLancamento.despesas_pendentes}</span>
        </li>`;
    }

    html += '</ul>';
    document.getElementById('modal-resumo-lancamento').innerHTML = html;

    // Campo de vencimento (se não houver na fatura)
    const campoVencimento = document.getElementById('campo-vencimento');
    const inputVencimento = document.getElementById('inputVencimento');

    if (!dadosLancamento.vencimento_fatura) {
        campoVencimento.classList.remove('d-none');
        // Define data default como hoje + 30 dias
        const hoje = new Date();
        hoje.setDate(hoje.getDate() + 30);
        inputVencimento.value = hoje.toISOString().split('T')[0];
        inputVencimento.min = ''; // Permite datas passadas, mas pedirá confirmação
    } else {
        campoVencimento.classList.add('d-none');
    }

    // Alerta de vencimentos passados
    const alertaVencimentos = document.getElementById('alerta-vencimentos');
    const detalheVencimentos = document.getElementById('detalhe-vencimentos');
    const checkboxConfirmar = document.getElementById('confirmarVencimentos');
    const btnConfirmar = document.getElementById('btnConfirmarLancar');

    if (dadosLancamento.vencimento_passado) {
        alertaVencimentos.classList.remove('d-none');
        detalheVencimentos.innerHTML = `O vencimento da fatura (<strong>${formatarData(dadosLancamento.vencimento_fatura)}</strong>) é anterior a hoje.`;
        checkboxConfirmar.checked = false;
        btnConfirmar.disabled = true;

        // Habilita botão apenas se checkbox marcado
        checkboxConfirmar.onchange = function() {
            btnConfirmar.disabled = !this.checked;
        };
    } else {
        alertaVencimentos.classList.add('d-none');
        btnConfirmar.disabled = false;
    }

    // Listener para verificar vencimento digitado
    inputVencimento.onchange = function() {
        verificarVencimentoDigitado();
    };

    // Abre modal
    const modal = new bootstrap.Modal(document.getElementById('modalLancarOdoo'));
    modal.show();
}

function verificarVencimentoDigitado() {
    const inputVencimento = document.getElementById('inputVencimento');
    const alertaVencimentos = document.getElementById('alerta-vencimentos');
    const detalheVencimentos = document.getElementById('detalhe-vencimentos');
    const checkboxConfirmar = document.getElementById('confirmarVencimentos');
    const btnConfirmar = document.getElementById('btnConfirmarLancar');

    if (!inputVencimento.value) return;

    const vencimento = new Date(inputVencimento.value + 'T00:00:00');
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    if (vencimento < hoje) {
        alertaVencimentos.classList.remove('d-none');
        detalheVencimentos.innerHTML = `O vencimento informado (<strong>${formatarData(inputVencimento.value)}</strong>) é anterior a hoje.`;
        checkboxConfirmar.checked = false;
        btnConfirmar.disabled = true;

        checkboxConfirmar.onchange = function() {
            btnConfirmar.disabled = !this.checked;
        };
    } else {
        alertaVencimentos.classList.add('d-none');
        btnConfirmar.disabled = false;
    }
}

function formatarData(dataStr) {
    if (!dataStr) return 'N/A';
    const partes = dataStr.split('-');
    if (partes.length !== 3) return dataStr;
    return `${partes[2]}/${partes[1]}/${partes[0]}`;
}

function confirmarLancamentoOdoo() {
    const btnConfirmar = document.getElementById('btnConfirmarLancar');
    const inputVencimento = document.getElementById('inputVencimento');
    const checkboxConfirmar = document.getElementById('confirmarVencimentos');

    // Verifica se precisa informar vencimento
    let vencimento = dadosLancamento.vencimento_fatura;
    if (!vencimento) {
        if (!inputVencimento.value) {
            alert('Por favor, informe a data de vencimento.');
            inputVencimento.focus();
            return;
        }
        vencimento = inputVencimento.value;
    }

    // Verifica checkbox se há vencimento passado
    const vencimentoDate = new Date(vencimento + 'T00:00:00');
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    if (vencimentoDate < hoje && !checkboxConfirmar.checked) {
        alert('Por favor, confirme que deseja lançar mesmo com vencimento passado.');
        return;
    }

    // Desabilita botão e mostra loading
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enfileirando...';

    // Monta payload
    const payload = {
        data_vencimento: vencimento
    };

    // Envia requisição
    fetch('{{ url_for("fretes.lancar_lote_fatura", fatura_id=fatura.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            // Fecha modal
            bootstrap.Modal.getInstance(document.getElementById('modalLancarOdoo')).hide();

            // Mostra mensagem de sucesso
            alert(`✅ ${data.mensagem}\n\nJob ID: ${data.job_id}\n\nO processamento está sendo realizado em background.\nAcompanhe o status na tela de Auditoria de Lançamentos Odoo.`);

            // Recarrega página para atualizar status
            location.reload();
        } else {
            alert(`❌ Erro: ${data.mensagem}\n\n${data.erro || ''}`);
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Confirmar Lançamento';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao comunicar com o servidor. Tente novamente.');
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Confirmar Lançamento';
    });
}

// ========================================
// REMOVER FRETE DA FATURA
// ========================================

let freteParaRemover = null;

function confirmarRemoverFrete(freteId, numeroCte, nomeCliente) {
    freteParaRemover = freteId;

    // Atualiza dados no modal
    document.getElementById('modalFreteNumero').textContent = numeroCte;
    document.getElementById('modalFreteCliente').textContent = nomeCliente;

    // Abre modal
    const modal = new bootstrap.Modal(document.getElementById('modalRemoverFrete'));
    modal.show();
}

function executarRemoverFrete() {
    if (!freteParaRemover) {
        alert('Erro: Frete não identificado.');
        return;
    }

    const btnConfirmar = document.getElementById('btnConfirmarRemover');
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Removendo...';

    // Chama a API de desvincular frete da fatura
    fetch(`/fretes/${freteParaRemover}/desvincular_fatura`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => {
        // Verifica se foi redirecionado (comportamento normal da rota)
        if (response.redirected) {
            // Sucesso - recarrega a página atual para ver o resultado
            location.reload();
            return;
        }
        return response.text();
    })
    .then(data => {
        // Se chegou aqui sem redirect, recarrega para ver flash messages
        location.reload();
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao comunicar com o servidor. Tente novamente.');
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = '<i class="fas fa-unlink"></i> Confirmar Remoção';
    });
}
</script>
{% endblock %}