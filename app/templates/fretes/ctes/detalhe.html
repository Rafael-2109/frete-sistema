{% extends "base.html" %}

{% block title %}CTe {{ cte.numero_cte }}/{{ cte.serie_cte }} - Detalhes{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('fretes.index') }}">Fretes</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('cte.listar_ctes') }}">CTes</a></li>
                    <li class="breadcrumb-item active">CTe {{ cte.numero_cte }}/{{ cte.serie_cte }}</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="fas fa-file-invoice"></i> CTe {{ cte.numero_cte }}/{{ cte.serie_cte }}
                </h2>
                <div>
                    <a href="{{ url_for('cte.listar_ctes') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>

            {% if cte.tipo_cte == '1' %}
            <!-- Aviso de CTe Complementar no cabeçalho -->
            <div class="alert alert-warning mt-3 mb-0" role="alert">
                <i class="fas fa-info-circle"></i>
                <strong>Este é um CTe Complementar</strong> - complementa outro CTe existente.
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Coluna Principal -->
        <div class="col-md-8">
            <!-- Dados Principais -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Dados Principais</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="text-muted small">Chave de Acesso</label>
                            <div><strong>{{ cte.chave_acesso or '-' }}</strong></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="text-muted small">Número CTe</label>
                            <div><strong>{{ cte.numero_cte }}</strong></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="text-muted small">Data Emissão</label>
                            <div>{{ cte.data_emissao.strftime('%d/%m/%Y') if cte.data_emissao else '-' }}</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="text-muted small">Data Entrada</label>
                            <div>{{ cte.data_entrada.strftime('%d/%m/%Y') if cte.data_entrada else '-' }}</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="text-muted small">Status Odoo</label>
                            <div>
                                <span class="badge bg-{{ 'success' if cte.odoo_status_codigo == '06' else 'secondary' }}">
                                    {{ cte.odoo_status_descricao or '-' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Valor Total</label>
                            <div><strong class="text-success">{{ (cte.valor_total or 0)|moeda_carteira }}</strong></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Valor ICMS</label>
                            <div><strong class="text-info">{{ (cte.valor_icms or 0)|moeda_carteira }}</strong></div>
                        </div>
                    </div>

                    {% if cte.numeros_nfs %}
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="text-muted small">Notas Fiscais Contidas no CTe ({{ cte.numeros_nfs.split(',') | length }})</label>
                            <div>
                                {% for nf in cte.numeros_nfs.split(',') %}
                                <span class="badge bg-primary d-inline-block mb-1 me-1">NF {{ nf }}</span>
                                {% if loop.index % 5 == 0 %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- CTe Complementar / Original -->
            {% if cte.tipo_cte == '1' or (cte.ctes_complementares and cte.ctes_complementares.count() > 0) %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        {% if cte.tipo_cte == '1' %}
                        <i class="fas fa-file-invoice"></i> CTe Original
                        {% else %}
                        <i class="fas fa-list"></i> CTes Complementares
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if cte.tipo_cte == '1' %}
                    <!-- Este CTe É um complementar - Exibir dados do CTe Original -->

                    {% if cte.cte_original %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small">Número do CTe Original</label>
                            <div>
                                <a href="{{ url_for('cte.detalhar_cte', cte_id=cte.cte_original.id) }}"
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-arrow-left"></i> CTe {{ cte.cte_original.numero_cte }}/{{ cte.cte_original.serie_cte }}
                                </a>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Valor do CTe Original</label>
                            <div><strong class="text-success">{{ (cte.cte_original.valor_total or 0)|moeda_carteira }}</strong></div>
                        </div>
                    </div>

                    <!-- Exibir NFs do CTe Original -->
                    {% if cte.cte_original.numeros_nfs %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="text-muted small">Notas Fiscais do CTe Original ({{ cte.cte_original.numeros_nfs.split(',') | length }})</label>
                            <div>
                                {% for nf in cte.cte_original.numeros_nfs.split(',') %}
                                <span class="badge bg-primary d-inline-block mb-1 me-1">NF {{ nf }}</span>
                                {% if loop.index % 5 == 0 %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% else %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        CTe original não encontrado no sistema.
                        <br><small>Chave: {{ cte.cte_complementa_chave }}</small>
                    </div>
                    {% endif %}

                    {% if cte.motivo_complemento %}
                    <div class="row">
                        <div class="col-12">
                            <label class="text-muted small">Motivo do Complemento</label>
                            <div class="alert alert-info mb-0" style="white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word;">
                                {{ cte.motivo_complemento }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% else %}
                    <!-- Este CTe TEM complementares -->
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Este CTe possui {{ cte.ctes_complementares.count() }} complemento(s)</strong>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>CTe Complementar</th>
                                    <th>Data Emissão</th>
                                    <th>Motivo</th>
                                    <th>Valor</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cte_comp in cte.ctes_complementares %}
                                <tr>
                                    <td>
                                        <strong>{{ cte_comp.numero_cte }}/{{ cte_comp.serie_cte }}</strong>
                                    </td>
                                    <td>{{ cte_comp.data_emissao.strftime('%d/%m/%Y') if cte_comp.data_emissao else '-' }}</td>
                                    <td style="max-width: 300px;">
                                        <small class="d-block"
                                               style="white-space: normal;
                                                      word-break: break-word;
                                                      overflow-wrap: break-word;"
                                               title="{{ cte_comp.motivo_complemento }}">
                                            {{ cte_comp.motivo_complemento or '-' }}
                                        </small>
                                    </td>
                                    <td><strong class="text-success">{{ (cte_comp.valor_total or 0)|moeda_carteira }}</strong></td>
                                    <td>
                                        <a href="{{ url_for('cte.detalhar_cte', cte_id=cte_comp.id) }}"
                                           class="btn btn-sm btn-info"
                                           title="Ver Detalhes">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                                <tr class="table-secondary">
                                    <td colspan="3" class="text-end"><strong>Total Complementares:</strong></td>
                                    <td colspan="2">
                                        <strong class="text-success">
                                            {{ (cte.ctes_complementares | sum(attribute='valor_total') or 0)|moeda_carteira }}
                                        </strong>
                                    </td>
                                </tr>
                                <tr class="table-primary">
                                    <td colspan="3" class="text-end"><strong>Valor Total (Original + Complementares):</strong></td>
                                    <td colspan="2">
                                        <strong class="text-primary">
                                            {{ ((cte.valor_total or 0) + (cte.ctes_complementares | sum(attribute='valor_total') or 0))|moeda_carteira }}
                                        </strong>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Transportadora (Emitente) -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-truck"></i> Transportadora (Emitente)</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="text-muted small">Razão Social</label>
                            <div><strong>{{ cte.nome_emitente or '-' }}</strong></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="text-muted small">CNPJ</label>
                            <div>{{ cte.formatar_cnpj(cte.cnpj_emitente) if cte.cnpj_emitente else '-' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Partes Envolvidas -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Partes Envolvidas</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">CNPJ Remetente</label>
                            <div><strong>{{ cte.formatar_cnpj(cte.cnpj_remetente) if cte.cnpj_remetente else '-' }}</strong></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">CNPJ Destinatário</label>
                            <div><strong>{{ cte.formatar_cnpj(cte.cnpj_destinatario) if cte.cnpj_destinatario else '-' }}</strong></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">CNPJ Expedidor</label>
                            <div>{{ cte.formatar_cnpj(cte.cnpj_expedidor) if cte.cnpj_expedidor else '-' }}</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Tomador</label>
                            <div>
                                {% if cte.tomador == '0' or cte.tomador == '1' %}
                                    Remetente<br>
                                    <small class="text-muted">{{ cte.formatar_cnpj(cte.cnpj_remetente) if cte.cnpj_remetente else '-' }}</small>
                                {% elif cte.tomador == '2' %}
                                    Expedidor<br>
                                    <small class="text-muted">{{ cte.formatar_cnpj(cte.cnpj_expedidor) if cte.cnpj_expedidor else '-' }}</small>
                                {% elif cte.tomador == '3' %}
                                    Recebedor<br>
                                    <small class="text-muted">{{ cte.formatar_cnpj(cte.cnpj_destinatario) if cte.cnpj_destinatario else '-' }}</small>
                                {% elif cte.tomador == '4' %}
                                    Destinatário<br>
                                    <small class="text-muted">{{ cte.formatar_cnpj(cte.cnpj_destinatario) if cte.cnpj_destinatario else '-' }}</small>
                                {% else %}
                                    {{ cte.tomador or '-' }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Coluna Lateral -->
        <div class="col-md-4">
            {% if cte.tipo_cte == '1' %}
            <!-- CTe COMPLEMENTAR: Vínculo com Despesa Extra -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-link"></i> Vínculo com Despesa Extra</h5>
                </div>
                <div class="card-body">
                    {% set despesa_vinculada = cte.despesas_extras_vinculadas | first if cte.despesas_extras_vinculadas else none %}
                    {% if despesa_vinculada %}
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-check-circle"></i> <strong>Vinculado à Despesa</strong>
                        <hr>
                        <p class="mb-2"><strong>Despesa ID:</strong> #{{ despesa_vinculada.id }}</p>
                        <p class="mb-2"><strong>Tipo:</strong> {{ despesa_vinculada.tipo_despesa }}</p>
                        <p class="mb-2"><strong>Valor:</strong> {{ (despesa_vinculada.valor_despesa)|moeda_carteira }}</p>
                        <p class="mb-0"><strong>Status:</strong>
                            <span class="badge bg-{{ 'success' if despesa_vinculada.status == 'LANCADO_ODOO' else 'info' }}">
                                {{ despesa_vinculada.status }}
                            </span>
                        </p>
                    </div>

                    <div class="d-grid gap-2">
                        <a href="{{ url_for('fretes.visualizar_frete', frete_id=despesa_vinculada.frete_id) }}" class="btn btn-primary">
                            <i class="fas fa-eye"></i> Ver Frete da Despesa
                        </a>
                        {% if despesa_vinculada.status != 'LANCADO_ODOO' %}
                        <form method="POST" action="{{ url_for('fretes.desvincular_cte_despesa', despesa_id=despesa_vinculada.id) }}"
                              onsubmit="return confirm('Tem certeza que deseja desvincular este CTe da despesa?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="fas fa-unlink"></i> Desvincular
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle"></i> <strong>CTe Complementar</strong>
                        <p class="mb-0 mt-2">Este CTe deve ser vinculado a uma <strong>Despesa Extra</strong>, não a um Frete.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <!-- CTe NORMAL: Vínculo com Frete -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-link"></i> Vínculo com Frete</h5>
                </div>
                <div class="card-body">
                    {% if cte.frete_id %}
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-check-circle"></i> <strong>Vinculado</strong>
                        <hr>
                        <p class="mb-2"><strong>Frete ID:</strong> {{ cte.frete_id }}</p>
                        <p class="mb-2"><strong>Vinculado em:</strong> {{ cte.vinculado_em.strftime('%d/%m/%Y %H:%M') if cte.vinculado_em else '-' }}</p>
                        <p class="mb-2"><strong>Vinculado por:</strong> {{ cte.vinculado_por or '-' }}</p>
                        <p class="mb-0">
                            <strong>Tipo:</strong>
                            <span class="badge bg-{{ 'warning' if cte.vinculado_manualmente else 'info' }}">
                                {{ 'Manual' if cte.vinculado_manualmente else 'Automático' }}
                            </span>
                        </p>
                    </div>

                    <div class="d-grid gap-2">
                        <a href="{{ url_for('fretes.visualizar_frete', frete_id=cte.frete_id) }}" class="btn btn-primary">
                            <i class="fas fa-eye"></i> Ver Frete
                        </a>
                        <form method="POST" action="{{ url_for('cte.desvincular_frete', cte_id=cte.id) }}"
                              onsubmit="return confirm('Tem certeza que deseja desvincular este CTe do frete?');">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="fas fa-unlink"></i> Desvincular
                            </button>
                        </form>
                    </div>
                    {% else %}
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle"></i> <strong>Não Vinculado</strong>
                        <p class="mb-0 mt-2">Este CTe ainda não está vinculado a nenhum frete do sistema.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Fretes Sugeridos -->
            {% if fretes_relacionados and fretes_relacionados|length > 0 %}
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-search"></i> Fretes Sugeridos ({{ fretes_relacionados|length }})
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        <i class="fas fa-info-circle"></i> Fretes com NFs em comum e mesma transportadora
                    </p>

                    {% for item in fretes_relacionados %}
                    {% set frete = item.frete %}
                    {% set ctes_concorrentes = item.ctes_concorrentes %}
                    {% set ja_vinculado = item.ja_vinculado %}
                    {% set nfs_comuns = item.nfs_comuns %}

                    <div class="border rounded p-3 mb-3 {% if ja_vinculado %}bg-light{% endif %}">
                        <!-- Header do Frete -->
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong class="text-primary">Frete #{{ frete.id }}</strong>
                                {% if ja_vinculado %}
                                <span class="badge bg-secondary ms-1">Já vinculado</span>
                                {% endif %}
                            </div>
                            <span class="badge bg-success">{{ (frete.valor_cotado or 0)|moeda_carteira }}</span>
                        </div>

                        <!-- Dados do Frete -->
                        <div class="small mb-2">
                            <p class="mb-1"><strong>Cliente:</strong> {{ frete.nome_cliente[:30] }}{% if frete.nome_cliente|length > 30 %}...{% endif %}</p>
                            <p class="mb-1"><strong>Destino:</strong> {{ frete.cidade_destino }}/{{ frete.uf_destino }}</p>
                            <p class="mb-1"><strong>Embarque:</strong> #{{ frete.embarque.numero if frete.embarque else 'N/A' }}</p>
                            <p class="mb-1"><strong>NFs em comum:</strong>
                                {% for nf in nfs_comuns[:3] %}
                                <span class="badge bg-primary">{{ nf }}</span>
                                {% endfor %}
                                {% if nfs_comuns|length > 3 %}
                                <span class="text-muted">+{{ nfs_comuns|length - 3 }}</span>
                                {% endif %}
                            </p>
                        </div>

                        <!-- Alerta de CTes Concorrentes -->
                        {% if ctes_concorrentes and ctes_concorrentes|length > 0 %}
                        <div class="alert alert-warning mb-2 py-2 px-2">
                            <small>
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Atenção!</strong> Existem {{ ctes_concorrentes|length }} outro(s) CTe(s) que também vinculariam com este frete:
                                <ul class="mb-0 mt-1 ps-3">
                                    {% for cte_conc in ctes_concorrentes[:3] %}
                                    <li>
                                        <a href="{{ url_for('cte.detalhar_cte', cte_id=cte_conc.id) }}" target="_blank" class="text-decoration-none">
                                            CTe {{ cte_conc.numero_cte }}/{{ cte_conc.serie_cte }}
                                        </a>
                                        - {{ cte_conc.data_emissao.strftime('%d/%m/%Y') if cte_conc.data_emissao else 'S/D' }}
                                        - {{ (cte_conc.valor_total or 0)|moeda_carteira }}
                                    </li>
                                    {% endfor %}
                                    {% if ctes_concorrentes|length > 3 %}
                                    <li class="text-muted">... e mais {{ ctes_concorrentes|length - 3 }} CTe(s)</li>
                                    {% endif %}
                                </ul>
                                <div class="mt-1 text-danger">
                                    <i class="fas fa-info-circle"></i> Verifique se este CTe não é substituído/reemitido.
                                </div>
                            </small>
                        </div>
                        {% endif %}

                        <!-- Botões de Ação -->
                        <div class="d-grid gap-1">
                            <a href="{{ url_for('fretes.visualizar_frete', frete_id=frete.id) }}"
                               class="btn btn-sm btn-outline-primary"
                               target="_blank">
                                <i class="fas fa-eye"></i> Ver Frete
                            </a>

                            {% if not ja_vinculado %}
                            <form method="POST" action="{{ url_for('cte.vincular_frete', cte_id=cte.id) }}"
                                  onsubmit="return confirm('Confirma vincular este CTe ao Frete #{{ frete.id }}?{% if ctes_concorrentes and ctes_concorrentes|length > 0 %}\n\nATENÇÃO: Existem {{ ctes_concorrentes|length }} outro(s) CTe(s) que também poderiam vincular com este frete. Verifique se este é o CTe correto.{% endif %}');">
                                <input type="hidden" name="frete_id" value="{{ frete.id }}">
                                <button type="submit" class="btn btn-sm btn-success w-100">
                                    <i class="fas fa-link"></i> Vincular
                                </button>
                            </form>
                            {% else %}
                            <button class="btn btn-sm btn-secondary w-100" disabled
                                    title="Este frete já possui um CTe vinculado">
                                <i class="fas fa-lock"></i> Frete já vinculado
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% elif cte.tipo_cte != '1' and not cte.frete_id %}
            <!-- Nenhum frete sugerido encontrado (apenas para CTes não complementares sem vínculo) -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-search"></i> Fretes Sugeridos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-secondary mb-0">
                        <i class="fas fa-info-circle"></i>
                        Nenhum frete encontrado com NFs em comum.
                        <p class="mb-0 mt-2 small">
                            Verifique se o frete já foi criado no sistema ou se as NFs estão corretas.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- DESPESAS SUGERIDAS (para CTe Complementar) -->
            {% if cte.tipo_cte == '1' and despesas_sugeridas and despesas_sugeridas|length > 0 %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-search"></i> Despesas Sugeridas ({{ despesas_sugeridas|length }})
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        <i class="fas fa-info-circle"></i> Despesas extras com tipo CTe aguardando vinculação
                    </p>

                    {% for item in despesas_sugeridas %}
                    {% set despesa = item.despesa %}
                    {% set frete = item.frete %}
                    {% set prioridade = item.prioridade %}
                    {% set motivo = item.motivo %}

                    <div class="border rounded p-3 mb-3 {% if prioridade == 1 %}bg-light border-success{% endif %}">
                        <!-- Header -->
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong class="text-primary">Despesa #{{ despesa.id }}</strong>
                                <span class="badge bg-{% if prioridade == 1 %}success{% elif prioridade == 2 %}info{% else %}warning{% endif %} ms-1">
                                    P{{ prioridade }}
                                </span>
                            </div>
                            <span class="badge bg-success">{{ (despesa.valor_despesa or 0)|moeda_carteira }}</span>
                        </div>

                        <!-- Dados -->
                        <div class="small mb-2">
                            <p class="mb-1"><strong>Tipo:</strong> {{ despesa.tipo_despesa }}</p>
                            <p class="mb-1"><strong>Motivo:</strong> {{ despesa.motivo_despesa }}</p>
                            <p class="mb-1"><strong>Frete:</strong> #{{ frete.id }} - {{ frete.nome_cliente[:25] }}{% if frete.nome_cliente|length > 25 %}...{% endif %}</p>
                            <p class="mb-1 text-muted"><small><i class="fas fa-lightbulb"></i> {{ motivo }}</small></p>
                        </div>

                        <!-- Botões -->
                        <div class="d-grid gap-1">
                            <a href="{{ url_for('fretes.visualizar_frete', frete_id=frete.id) }}"
                               class="btn btn-sm btn-outline-primary"
                               target="_blank">
                                <i class="fas fa-eye"></i> Ver Frete
                            </a>

                            <form method="POST" action="{{ url_for('cte.vincular_despesa', cte_id=cte.id) }}"
                                  onsubmit="return confirm('Confirma vincular este CTe à Despesa #{{ despesa.id }}?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="despesa_id" value="{{ despesa.id }}">
                                <button type="submit" class="btn btn-sm btn-success w-100">
                                    <i class="fas fa-link"></i> Vincular à Despesa
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% elif cte.tipo_cte == '1' and not (cte.despesas_extras_vinculadas | first) %}
            <!-- CTe Complementar sem despesas sugeridas -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-search"></i> Despesas Sugeridas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-secondary mb-0">
                        <i class="fas fa-info-circle"></i>
                        Nenhuma despesa extra encontrada para vincular.
                        <p class="mb-0 mt-2 small">
                            Verifique se existe uma despesa extra com tipo "CTe" e status "Pendente" no sistema.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Arquivos -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-file"></i> Arquivos</h5>
                </div>
                <div class="card-body">
                    {% if cte.cte_pdf_path %}
                    <a href="{{ url_for('cte.visualizar_pdf', cte_id=cte.id) }}" class="btn btn-danger w-100 mb-2" target="_blank">
                        <i class="fas fa-file-pdf"></i> Visualizar PDF
                    </a>
                    {% else %}
                    <button class="btn btn-secondary w-100 mb-2" disabled>
                        <i class="fas fa-file-pdf"></i> PDF Não Disponível
                    </button>
                    {% endif %}

                    {% if cte.cte_xml_path %}
                    <a href="{{ url_for('cte.visualizar_xml', cte_id=cte.id) }}" class="btn btn-success w-100">
                        <i class="fas fa-file-code"></i> Baixar XML
                    </a>
                    {% else %}
                    <button class="btn btn-secondary w-100" disabled>
                        <i class="fas fa-file-code"></i> XML Não Disponível
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Dados Odoo -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-database"></i> Dados Odoo</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="text-muted small">DFe ID</label>
                        <div><strong>{{ cte.dfe_id }}</strong></div>
                    </div>
                    <div class="mb-2">
                        <label class="text-muted small">Nome Odoo</label>
                        <div>{{ cte.odoo_name or '-' }}</div>
                    </div>
                    <div class="mb-2">
                        <label class="text-muted small">Tipo Pedido</label>
                        <div>{{ cte.tipo_pedido or '-' }}</div>
                    </div>
                    <div class="mb-2">
                        <label class="text-muted small">Partner ID</label>
                        <div>{{ cte.odoo_partner_id or '-' }}</div>
                    </div>
                    <div class="mb-2">
                        <label class="text-muted small">Importado em</label>
                        <div>{{ cte.importado_em.strftime('%d/%m/%Y %H:%M') if cte.importado_em else '-' }}</div>
                    </div>
                    <div class="mb-0">
                        <label class="text-muted small">Atualizado em</label>
                        <div>{{ cte.atualizado_em.strftime('%d/%m/%Y %H:%M') if cte.atualizado_em else '-' }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
