{% extends "base.html" %}

{% block title %}Vincular CTe Manual - Despesa #{{ despesa.id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-search"></i> Vincular CTe Manual
                <small class="text-muted">Despesa #{{ despesa.id }}</small>
            </h1>
        </div>
    </div>

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('fretes.index') }}">Fretes</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('fretes.visualizar_frete', frete_id=frete.id) }}">Frete #{{ frete.id }}</a></li>
            <li class="breadcrumb-item active">Vincular CTe Manual</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Informações da Despesa -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-receipt"></i> Dados da Despesa
                    </h5>
                </div>
                <div class="card-body">
                    <p><strong>ID:</strong> #{{ despesa.id }}</p>
                    <p><strong>Tipo:</strong> {{ despesa.tipo_despesa }}</p>
                    <p><strong>Motivo:</strong> {{ despesa.motivo_despesa }}</p>
                    <p><strong>Setor:</strong> {{ despesa.setor_responsavel }}</p>
                    <p><strong>Valor:</strong> <span class="badge bg-success">{{ (despesa.valor_despesa)|moeda_carteira }}</span></p>
                    <p><strong>Status:</strong>
                        <span class="badge
                            {% if despesa.status == 'PENDENTE' %}bg-warning text-dark
                            {% elif despesa.status == 'VINCULADO_CTE' %}bg-info
                            {% elif despesa.status == 'LANCADO_ODOO' %}bg-success
                            {% elif despesa.status == 'LANCADO' %}bg-primary
                            {% else %}bg-secondary{% endif %}">
                            {{ despesa.status_descricao }}
                        </span>
                    </p>
                    {% if despesa.cte %}
                    <hr>
                    <p><strong>CTe Atual:</strong></p>
                    <div class="alert alert-info mb-0">
                        <strong>{{ despesa.cte.numero_cte }}</strong><br>
                        <small>{{ despesa.chave_cte }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-truck"></i> Frete Relacionado
                    </h6>
                </div>
                <div class="card-body">
                    <p><strong>Frete:</strong> #{{ frete.id }}</p>
                    <p><strong>Cliente:</strong> {{ frete.nome_cliente[:30] }}{% if frete.nome_cliente|length > 30 %}...{% endif %}</p>
                    <p><strong>CNPJ Cliente:</strong><br>
                        <code>{{ frete.cnpj_cliente or 'N/A' }}</code>
                    </p>
                    <p><strong>Transportadora:</strong> {{ frete.transportadora.razao_social[:30] }}{% if frete.transportadora.razao_social|length > 30 %}...{% endif %}</p>
                    <p><strong>CNPJ Transp.:</strong><br>
                        <code>{{ frete.transportadora.cnpj or 'N/A' }}</code>
                    </p>
                </div>
            </div>

            <a href="{{ url_for('fretes.visualizar_frete', frete_id=frete.id) }}" class="btn btn-secondary w-100 mb-3">
                <i class="fas fa-arrow-left"></i> Voltar ao Frete
            </a>

            <a href="{{ url_for('fretes.vincular_cte_despesa', despesa_id=despesa.id) }}" class="btn btn-outline-warning w-100">
                <i class="fas fa-magic"></i> Sugestão Automática
            </a>
        </div>

        <!-- Busca e Resultados -->
        <div class="col-md-9">
            <!-- Card de Filtros -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter"></i> Filtros de Busca
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="prefixo_transportadora" class="form-label">
                                <i class="fas fa-truck"></i> CNPJ Transportadora
                            </label>
                            <input type="text"
                                   class="form-control"
                                   id="prefixo_transportadora"
                                   name="prefixo_transportadora"
                                   value="{{ prefixo_transportadora }}"
                                   placeholder="Ex: 12.345.678"
                                   maxlength="14">
                            <small class="text-muted">Prefixo do CNPJ do emitente</small>
                        </div>
                        <div class="col-md-3">
                            <label for="prefixo_cliente" class="form-label">
                                <i class="fas fa-building"></i> CNPJ Cliente
                            </label>
                            <input type="text"
                                   class="form-control"
                                   id="prefixo_cliente"
                                   name="prefixo_cliente"
                                   value="{{ prefixo_cliente }}"
                                   placeholder="Ex: 87.654.321"
                                   maxlength="14">
                            <small class="text-muted">Prefixo do CNPJ remetente/destinatário</small>
                        </div>
                        <div class="col-md-3">
                            <label for="numero_cte" class="form-label">
                                <i class="fas fa-file-alt"></i> Número CTe
                            </label>
                            <input type="text"
                                   class="form-control"
                                   id="numero_cte"
                                   name="numero_cte"
                                   value="{{ numero_cte }}"
                                   placeholder="Ex: 123456">
                            <small class="text-muted">Busca por número do CTe</small>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="btn-group w-100">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                                <a href="{{ url_for('fretes.vincular_cte_manual_despesa', despesa_id=despesa.id) }}"
                                   class="btn btn-outline-secondary"
                                   title="Limpar filtros">
                                    <i class="fas fa-times"></i>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Informação sobre busca -->
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Busca Manual:</strong> Esta busca NÃO valida NFs em comum.
                Use quando o CTe complementar não está aparecendo na sugestão automática.
                Ao vincular manualmente, será registrada uma observação na despesa.
            </div>

            <!-- Resultados -->
            {% if ctes %}
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list"></i> CTes Encontrados
                        <span class="badge bg-light text-dark">{{ ctes|length }}</span>
                    </h5>
                    <small>
                        {% if filtros %}
                        Filtros:
                        {% if filtros.prefixo_transportadora %}Transp: {{ filtros.prefixo_transportadora }}{% endif %}
                        {% if filtros.prefixo_cliente %} | Cliente: {{ filtros.prefixo_cliente }}{% endif %}
                        {% if filtros.numero_cte %} | Nº: {{ filtros.numero_cte }}{% endif %}
                        {% endif %}
                    </small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>CTe</th>
                                    <th>Tipo</th>
                                    <th>Emitente</th>
                                    <th>Cliente</th>
                                    <th>Valor</th>
                                    <th>Emissão</th>
                                    <th>Status</th>
                                    <th class="text-center">Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cte in ctes %}
                                <tr class="{% if cte._ja_vinculado %}table-warning{% endif %}">
                                    <td>
                                        <strong>{{ cte.numero_cte }}</strong>/{{ cte.serie_cte }}<br>
                                        <small class="text-muted">{{ cte.chave_acesso[:20] }}...</small>
                                    </td>
                                    <td>
                                        {% if cte.tipo_cte == 'Complementar' or cte.tipo_cte == '1' %}
                                        <span class="badge bg-info">Complementar</span>
                                        {% else %}
                                        <span class="badge bg-primary">Normal</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ (cte.nome_emitente or 'N/A')[:25] }}{% if cte.nome_emitente and cte.nome_emitente|length > 25 %}...{% endif %}</small><br>
                                        <code class="small">{{ cte.cnpj_emitente or 'N/A' }}</code>
                                    </td>
                                    <td>
                                        <small>
                                            {% if cte.nome_destinatario %}
                                            {{ cte.nome_destinatario[:20] }}{% if cte.nome_destinatario|length > 20 %}...{% endif %}
                                            {% else %}
                                            {{ (cte.nome_remetente or 'N/A')[:20] }}{% if cte.nome_remetente and cte.nome_remetente|length > 20 %}...{% endif %}
                                            {% endif %}
                                        </small><br>
                                        <code class="small">{{ cte.cnpj_destinatario or cte.cnpj_remetente or 'N/A' }}</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ (cte.valor_total or 0)|moeda_carteira }}</span>
                                    </td>
                                    <td>
                                        {% if cte.data_emissao %}
                                        {{ cte.data_emissao.strftime('%d/%m/%Y') }}
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if cte._ja_vinculado %}
                                        <span class="badge bg-warning text-dark" title="Este CTe já está vinculado a outra despesa">
                                            <i class="fas fa-exclamation-triangle"></i> Em uso
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">Disponível</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <form method="POST" style="display: inline;">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="cte_id" value="{{ cte.id }}">
                                            <button type="submit"
                                                    class="btn btn-sm {% if cte._ja_vinculado %}btn-outline-warning{% else %}btn-success{% endif %}"
                                                    {% if cte._ja_vinculado %}
                                                    onclick="return confirm('Este CTe já está vinculado a outra despesa. Deseja vincular mesmo assim?')"
                                                    {% else %}
                                                    onclick="return confirm('Confirma vincular CTe {{ cte.numero_cte }} à despesa #{{ despesa.id }}?')"
                                                    {% endif %}>
                                                <i class="fas fa-link"></i> Vincular
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% if ctes|length >= 50 %}
                <div class="card-footer text-muted text-center">
                    <i class="fas fa-info-circle"></i> Mostrando apenas os 50 primeiros resultados. Refine sua busca para encontrar CTes específicos.
                </div>
                {% endif %}
            </div>
            {% else %}
            <!-- Nenhum resultado -->
            <div class="alert alert-warning">
                <h5><i class="fas fa-search"></i> Nenhum CTe Encontrado</h5>
                <p class="mb-0">
                    Não foram encontrados CTes com os filtros informados.
                    Tente ajustar os filtros ou verificar se o CTe foi sincronizado do Odoo.
                </p>
                {% if not prefixo_transportadora and not prefixo_cliente and not numero_cte %}
                <hr>
                <p class="mb-0">
                    <strong>Dica:</strong> Os campos foram preenchidos automaticamente com os dados do frete.
                    Clique em "Buscar" para ver os CTes correspondentes.
                </p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
