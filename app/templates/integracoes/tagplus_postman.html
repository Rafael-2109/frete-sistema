{% extends "base.html" %}

{% block title %}TagPlus - Autorização Estilo Postman{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">
                <i class="fas fa-key"></i> Autorização TagPlus (Estilo Postman)
                <a href="{{ url_for('tagplus.pagina_importacao') }}" class="btn btn-secondary float-right">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </h2>

            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 
                <strong>Como funciona no Postman:</strong>
                <ol class="mb-0">
                    <li>Configure OAuth 2.0 com suas credenciais</li>
                    <li>Use a URL de callback do Postman: <code>https://www.postman.com/oauth2/callback</code></li>
                    <li>Clique em "Get New Access Token"</li>
                    <li>Autorize no TagPlus</li>
                    <li>Receba os tokens automaticamente</li>
                </ol>
            </div>

            <!-- Passo 1: Gerar URL de Autorização -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-link"></i> Passo 1: Gerar URL de Autorização
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Client ID:</label>
                        <input type="text" class="form-control" id="client-id-postman" 
                               placeholder="Digite seu Client ID do TagPlus">
                    </div>
                    <button class="btn btn-primary" onclick="gerarUrlPostman()">
                        <i class="fas fa-link"></i> Gerar URL de Autorização
                    </button>
                    
                    <div id="url-resultado" class="mt-3"></div>
                </div>
            </div>

            <!-- Passo 2: Colar URL de Callback -->
            <div class="card mb-3">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">
                        <i class="fas fa-paste"></i> Passo 2: Colar URL de Callback
                    </h5>
                </div>
                <div class="card-body">
                    <p>Após autorizar no TagPlus, você será redirecionado para uma URL como:</p>
                    <code>https://www.postman.com/oauth2/callback?code=SEU_CODIGO&state=tagplus_auth</code>
                    
                    <div class="form-group mt-3">
                        <label>Cole a URL completa aqui:</label>
                        <input type="text" class="form-control" id="callback-url" 
                               placeholder="https://www.postman.com/oauth2/callback?code=...">
                    </div>
                    
                    <div class="form-group">
                        <label>Client Secret:</label>
                        <input type="password" class="form-control" id="client-secret-postman" 
                               placeholder="Digite seu Client Secret">
                    </div>
                    
                    <button class="btn btn-warning" onclick="trocarCodigoPostman()">
                        <i class="fas fa-exchange-alt"></i> Trocar Código por Tokens
                    </button>
                    
                    <div id="token-resultado" class="mt-3"></div>
                </div>
            </div>

            <!-- Passo 3: Usar Tokens -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check"></i> Passo 3: Usar os Tokens
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Access Token:</label>
                        <textarea class="form-control" id="access-token-result" rows="3" readonly
                                  placeholder="O Access Token aparecerá aqui após o Passo 2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Refresh Token:</label>
                        <input type="text" class="form-control" id="refresh-token-result" readonly
                               placeholder="O Refresh Token aparecerá aqui após o Passo 2">
                    </div>
                    
                    <button class="btn btn-success" onclick="testarTokenPostman()">
                        <i class="fas fa-check-circle"></i> Testar Token na API
                    </button>
                    
                    <div id="teste-resultado" class="mt-3"></div>
                    
                    <hr>
                    
                    <h6>Como usar no Postman:</h6>
                    <ol>
                        <li>Copie o Access Token acima</li>
                        <li>No Postman, vá em Authorization</li>
                        <li>Selecione "Bearer Token"</li>
                        <li>Cole o token no campo</li>
                        <li>Faça suas requisições para: <code>https://api.tagplus.com.br/v1/</code></li>
                    </ol>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-clock"></i> 
                        <strong>Validade dos Tokens:</strong><br>
                        • Access Token: 24 horas<br>
                        • Refresh Token: 15 dias
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function gerarUrlPostman() {
    const clientId = document.getElementById('client-id-postman').value;
    
    if (!clientId) {
        alert('Por favor, digite o Client ID');
        return;
    }
    
    // Gera URL estilo Postman
    const authUrl = 'https://developers.tagplus.com.br/oauth/authorize';
    const params = new URLSearchParams({
        response_type: 'code',
        client_id: clientId,
        redirect_uri: 'https://www.postman.com/oauth2/callback',
        scope: 'read write',
        state: 'tagplus_auth'
    });
    
    const fullUrl = `${authUrl}?${params}`;
    
    document.getElementById('url-resultado').innerHTML = `
        <div class="alert alert-success">
            <strong>URL de Autorização:</strong><br>
            <div class="input-group">
                <input type="text" class="form-control" value="${fullUrl}" id="auth-url-copy" readonly>
                <div class="input-group-append">
                    <button class="btn btn-secondary" onclick="copiarTexto('auth-url-copy')">
                        <i class="fas fa-copy"></i> Copiar
                    </button>
                </div>
            </div>
            <p class="mt-2 mb-0">
                <a href="${fullUrl}" target="_blank" class="btn btn-primary">
                    <i class="fas fa-external-link-alt"></i> Abrir em Nova Aba
                </a>
            </p>
        </div>`;
}

function trocarCodigoPostman() {
    const callbackUrl = document.getElementById('callback-url').value;
    const clientId = document.getElementById('client-id-postman').value;
    const clientSecret = document.getElementById('client-secret-postman').value;
    
    if (!callbackUrl || !clientId || !clientSecret) {
        alert('Preencha todos os campos');
        return;
    }
    
    document.getElementById('token-resultado').innerHTML = '<div class="alert alert-info">Processando...</div>';
    
    fetch('/integracoes/tagplus/api/postman/trocar-codigo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            callback_url: callbackUrl,
            client_id: clientId,
            client_secret: clientSecret
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('access-token-result').value = data.access_token;
            document.getElementById('refresh-token-result').value = data.refresh_token;
            
            document.getElementById('token-resultado').innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Tokens obtidos com sucesso!
                    <br>Válidos por: ${data.expires_in} segundos
                </div>`;
        } else {
            document.getElementById('token-resultado').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> ${data.erro}
                </div>`;
        }
    })
    .catch(error => {
        document.getElementById('token-resultado').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Erro: ${error}
            </div>`;
    });
}

function testarTokenPostman() {
    const accessToken = document.getElementById('access-token-result').value;
    
    if (!accessToken) {
        alert('Obtenha o Access Token primeiro');
        return;
    }
    
    document.getElementById('teste-resultado').innerHTML = '<div class="alert alert-info">Testando...</div>';
    
    fetch('/integracoes/tagplus/api/postman/testar-token', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            access_token: accessToken
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('teste-resultado').innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> ${data.mensagem}
                </div>`;
        } else {
            document.getElementById('teste-resultado').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> ${data.erro}
                </div>`;
        }
    })
    .catch(error => {
        document.getElementById('teste-resultado').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Erro: ${error}
            </div>`;
    });
}

function copiarTexto(elementId) {
    const input = document.getElementById(elementId);
    input.select();
    document.execCommand('copy');
    alert('Copiado para a área de transferência!');
}
</script>
{% endblock %}