{% extends "base.html" %}

{% block title %}Importação TagPlus{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">
                <i class="fas fa-sync"></i> Integração TagPlus (Tela Antiga)
                <div class="float-right">
                    <a href="/tagplus/oauth/" class="btn btn-success btn-lg">
                        <i class="fas fa-rocket"></i> Ir para Nova Tela de Importação
                    </a>
                </div>
            </h2>

            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <h4 class="alert-heading">⚠️ Esta tela está obsoleta!</h4>
                <p>Por favor, use a <strong><a href="/tagplus/oauth/" class="alert-link">nova tela de importação</a></strong> que possui:</p>
                <ul>
                    <li>✅ Autenticação OAuth2 simplificada</li>
                    <li>✅ Visualização de NFs antes da importação</li>
                    <li>✅ Seleção por data inicial e final</li>
                    <li>✅ Correção de pedidos integrada</li>
                </ul>
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>

            <!-- Conteúdo Removido - Apenas Link para Nova Tela -->
            <div class="text-center mt-5">
                <h3>Esta funcionalidade foi movida</h3>
                <p class="lead">Toda a importação agora é feita pela nova interface unificada.</p>
                <a href="/tagplus/oauth/" class="btn btn-primary btn-lg">
                    <i class="fas fa-arrow-right"></i> Acessar Nova Tela de Importação
                </a>
            </div>

            <!-- [CONTEÚDO REMOVIDO - USAR NOVA TELA] -->
            <div style="display: none;">
                <!-- Aba Importação Manual -->
                <div class="tab-pane fade show active" id="manual" role="tabpanel">
                    <!-- Alert sobre vinculação manual -->
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <i class="fas fa-info-circle"></i>
                        <strong>Notas Importantes:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Após importar as NFs, caso alguma não seja vinculada automaticamente através do score,
                            você pode usar o botão <strong>"Vincular NFs sem Separação"</strong> acima para fazer a vinculação manual.</li>
                            <li>Se alguma NF for importada sem número de pedido, use o botão <strong>"Corrigir Pedidos"</strong> no topo da página para adicionar o pedido e reprocessar o faturamento.</li>
                        </ul>
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="row">
                        <!-- Teste de Conexão -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-plug"></i> Teste de Conexão
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> 
                                        <strong>Como obter tokens de acesso:</strong><br>
                                        1. Acesse <a href="https://developers.tagplus.com.br/" target="_blank">developers.tagplus.com.br</a><br>
                                        2. Faça login com sua conta TagPlus<br>
                                        3. Crie um novo aplicativo<br>
                                        4. Use o Client ID para autorizar a aplicação<br>
                                        5. Após autorizar, você receberá os tokens de acesso
                                    </div>
                                    
                                    <!-- OAuth2 com Tokens (Recomendado) -->
                                    <div class="card mb-3">
                                        <div class="card-header bg-success text-white">
                                            <strong>Método 1: OAuth2 com Tokens (Recomendado)</strong>
                                        </div>
                                        <div class="card-body">
                                            <!-- Passo 1: Autorizar Aplicação -->
                                            <div class="mb-3 p-3 border rounded">
                                                <h6><i class="fas fa-key"></i> Passo 1: Autorizar Aplicação</h6>
                                                <div class="form-group">
                                                    <label>Client ID:</label>
                                                    <input type="text" class="form-control" id="client-id-auth" 
                                                           placeholder="Digite seu Client ID para autorizar">
                                                </div>
                                                <button class="btn btn-primary btn-block" onclick="autorizarAplicacao()">
                                                    <i class="fas fa-external-link-alt"></i> Autorizar Aplicação no TagPlus
                                                </button>
                                            </div>
                                            
                                            <!-- Passo 2: Usar Tokens -->
                                            <div class="p-3 border rounded">
                                                <h6><i class="fas fa-unlock"></i> Passo 2: Usar Tokens de Acesso</h6>
                                                <div class="form-group">
                                                    <label>Access Token:</label>
                                                    <textarea class="form-control" id="access-token" rows="2"
                                                              placeholder="Cole seu Access Token aqui"></textarea>
                                                </div>
                                                <div class="form-group">
                                                    <label>Refresh Token:</label>
                                                    <input type="text" class="form-control" id="refresh-token" 
                                                           placeholder="Cole seu Refresh Token aqui">
                                                </div>
                                                <div class="form-group">
                                                    <label>Client ID:</label>
                                                    <input type="text" class="form-control" id="client-id" 
                                                           placeholder="Digite seu Client ID">
                                                </div>
                                                <div class="form-group">
                                                    <label>Client Secret:</label>
                                                    <input type="password" class="form-control" id="client-secret" 
                                                           placeholder="Digite seu Client Secret">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- API Key -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <strong>Método 2: API Key</strong>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label>API Key:</label>
                                                <input type="text" class="form-control" id="api-key" 
                                                       placeholder="Cole sua API Key aqui">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Usuário/Senha -->
                                    <div class="card">
                                        <div class="card-header">
                                            <strong>Método 3: Usuário/Senha</strong>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label>Usuário:</label>
                                                <input type="text" class="form-control" id="usuario" value="rayssa">
                                            </div>
                                            <div class="form-group">
                                                <label>Senha:</label>
                                                <input type="password" class="form-control" id="senha" value="A12345">
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-info btn-block" onclick="testarConexao()">
                                        <i class="fas fa-check"></i> Testar Conexão
                                    </button>
                                    <div id="resultado-teste" class="mt-3"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Importar Clientes -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-users"></i> Importar Clientes
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        Importe os clientes primeiro antes de importar as NFs
                                    </p>
                                    <div class="form-group">
                                        <label>Limite (vazio = todos):</label>
                                        <input type="number" class="form-control" id="limite-clientes" 
                                               placeholder="Ex: 10">
                                    </div>
                                    <button class="btn btn-primary btn-block" onclick="importarClientes()">
                                        <i class="fas fa-download"></i> Importar Clientes
                                    </button>
                                    <div id="resultado-clientes" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Importar NFs -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-file-invoice"></i> Importar Notas Fiscais
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Data Início:</label>
                                                <input type="date" class="form-control" id="data-inicio" 
                                                       value="{{ (date.today() - timedelta(days=7)).strftime('%Y-%m-%d') }}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Data Fim:</label>
                                                <input type="date" class="form-control" id="data-fim" 
                                                       value="{{ date.today().strftime('%Y-%m-%d') }}">
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-success btn-block" onclick="importarNFs()">
                                        <i class="fas fa-download"></i> Importar Notas Fiscais
                                    </button>
                                    <div id="resultado-nfs" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Webhooks -->
                <div class="tab-pane fade" id="webhooks" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-warning">
                            <h5 class="mb-0">
                                <i class="fas fa-cog"></i> Configuração de Webhooks no TagPlus
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <strong>O que são Webhooks?</strong><br>
                                São notificações automáticas que o TagPlus envia quando algo acontece 
                                (nova NF, novo cliente, etc). É a forma mais eficiente de integração!
                            </div>

                            <h6>Configure estes dados no TagPlus:</h6>
                            
                            <table class="table table-bordered">
                                <tr>
                                    <th width="30%">Campo</th>
                                    <th>Valor a Preencher</th>
                                </tr>
                                <tr>
                                    <td><strong>Nome da integração</strong></td>
                                    <td><code>Importação Sistema Fretes</code></td>
                                </tr>
                                <tr>
                                    <td><strong>URL de Callback (NFe)</strong></td>
                                    <td>
                                        <code id="url-nfe">https://sistema-fretes.onrender.com/webhook/tagplus/nfe</code>
                                        <button class="btn btn-sm btn-secondary ml-2" 
                                                onclick="copiarTexto('url-nfe')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>URL de Callback (Cliente)</strong></td>
                                    <td>
                                        <code id="url-cliente">https://sistema-fretes.onrender.com/webhook/tagplus/cliente</code>
                                        <button class="btn btn-sm btn-secondary ml-2" 
                                                onclick="copiarTexto('url-cliente')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>X-Hub-Secret</strong></td>
                                    <td>
                                        <code id="webhook-secret">frete2024tagplus#secret</code>
                                        <button class="btn btn-sm btn-secondary ml-2" 
                                                onclick="copiarTexto('webhook-secret')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                </tr>
                            </table>

                            <div class="alert alert-warning mt-3">
                                <strong>Importante:</strong> Após configurar no TagPlus, teste usando a URL:
                                <br>
                                <code>https://sistema-fretes.onrender.com/webhook/tagplus/teste</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Função para copiar texto
function copiarTexto(elementId) {
    const texto = document.getElementById(elementId).textContent;
    navigator.clipboard.writeText(texto).then(() => {
        alert('Copiado para a área de transferência!');
    });
}

// Autorizar Aplicação
function autorizarAplicacao() {
    const clientId = document.getElementById('client-id-auth').value;
    
    if (!clientId) {
        alert('Por favor, digite o Client ID');
        return;
    }
    
    // Redireciona para autorização OAuth
    window.location.href = `/integracoes/tagplus/oauth/authorize?client_id=${encodeURIComponent(clientId)}`;
}

// Testar Conexão
function testarConexao() {
    const accessToken = document.getElementById('access-token').value;
    const refreshToken = document.getElementById('refresh-token').value;
    const clientId = document.getElementById('client-id').value;
    const clientSecret = document.getElementById('client-secret').value;
    const apiKey = document.getElementById('api-key').value;
    const usuario = document.getElementById('usuario').value;
    const senha = document.getElementById('senha').value;
    const resultado = document.getElementById('resultado-teste');
    
    resultado.innerHTML = '<div class="alert alert-info">Testando conexão...</div>';
    
    const dados = { usuario, senha };
    if (accessToken) dados.access_token = accessToken;
    if (refreshToken) dados.refresh_token = refreshToken;
    if (clientId) dados.client_id = clientId;
    if (clientSecret) dados.client_secret = clientSecret;
    if (apiKey) dados.api_key = apiKey;
    
    fetch('/integracoes/tagplus/api/testar-conexao', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultado.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> ${data.mensagem}
                </div>`;
        } else {
            resultado.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> ${data.erro}
                </div>`;
        }
    })
    .catch(error => {
        resultado.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Erro: ${error}
            </div>`;
    });
}

// Importar Clientes
function importarClientes() {
    const usuario = document.getElementById('usuario').value;
    const senha = document.getElementById('senha').value;
    const limite = document.getElementById('limite-clientes').value;
    const accessToken = document.getElementById('access-token').value;
    const refreshToken = document.getElementById('refresh-token').value;
    const clientId = document.getElementById('client-id').value;
    const clientSecret = document.getElementById('client-secret').value;
    const apiKey = document.getElementById('api-key').value;
    const resultado = document.getElementById('resultado-clientes');
    
    resultado.innerHTML = '<div class="alert alert-info">Importando clientes...</div>';
    
    const dados = { usuario, senha, limite: limite ? parseInt(limite) : null };
    if (accessToken) dados.access_token = accessToken;
    if (refreshToken) dados.refresh_token = refreshToken;
    if (clientId) dados.client_id = clientId;
    if (clientSecret) dados.client_secret = clientSecret;
    if (apiKey) dados.api_key = apiKey;
    
    fetch('/integracoes/tagplus/api/importar-clientes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const res = data.resultado;
            resultado.innerHTML = `
                <div class="alert alert-success">
                    <strong>Importação concluída!</strong><br>
                    • Novos: ${res.importados}<br>
                    • Atualizados: ${res.atualizados}<br>
                    • Erros: ${res.erros.length}
                </div>`;
        } else {
            resultado.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> ${data.erro}
                </div>`;
        }
    })
    .catch(error => {
        resultado.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Erro: ${error}
            </div>`;
    });
}

// Importar NFs
function importarNFs() {
    const usuario = document.getElementById('usuario').value;
    const senha = document.getElementById('senha').value;
    const dataInicio = document.getElementById('data-inicio').value;
    const dataFim = document.getElementById('data-fim').value;
    const accessToken = document.getElementById('access-token').value;
    const refreshToken = document.getElementById('refresh-token').value;
    const clientId = document.getElementById('client-id').value;
    const clientSecret = document.getElementById('client-secret').value;
    const apiKey = document.getElementById('api-key').value;
    const resultado = document.getElementById('resultado-nfs');
    
    resultado.innerHTML = '<div class="alert alert-info">Importando notas fiscais...</div>';
    
    const dados = { 
        usuario, 
        senha, 
        data_inicio: dataInicio,
        data_fim: dataFim
    };
    if (accessToken) dados.access_token = accessToken;
    if (refreshToken) dados.refresh_token = refreshToken;
    if (clientId) dados.client_id = clientId;
    if (clientSecret) dados.client_secret = clientSecret;
    if (apiKey) dados.api_key = apiKey;
    
    fetch('/integracoes/tagplus/api/importar-nfs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const res = data.resultado;
            let alertClass = 'alert-success';
            let alertMessage = '<strong>Importação concluída!</strong><br>';
            alertMessage += `• NFs importadas: ${res.notas_fiscais.importadas}<br>`;
            alertMessage += `• Itens importados: ${res.notas_fiscais.itens_importados}<br>`;

            if (res.notas_fiscais.pendentes > 0) {
                alertClass = 'alert-warning';
                alertMessage += `<br><strong>⚠️ ${res.notas_fiscais.pendentes} NFs sem pedido!</strong><br>`;
                alertMessage += `Use o botão <a href="/integracoes/tagplus/pendencias" class="btn btn-sm btn-info">Corrigir Pedidos</a> para adicionar os pedidos.<br>`;
            }

            if (res.notas_fiscais.erros > 0) {
                alertMessage += `• Erros: ${res.notas_fiscais.erros}<br>`;
            }

            resultado.innerHTML = `<div class="alert ${alertClass}">${alertMessage}</div>`;
        } else {
            resultado.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> ${data.erro}
                </div>`;
        }
    })
    .catch(error => {
        resultado.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Erro: ${error}
            </div>`;
    });
}
</script>
{% endblock %}