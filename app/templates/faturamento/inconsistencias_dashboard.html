{% extends "base.html" %}

{% block title %}Dashboard de Inconsistências - Faturamento{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                Central de Inconsistências
            </h1>
            <p class="text-muted mb-0">Gestão unificada de inconsistências e pendências do sistema</p>
        </div>
        <div>
            <a href="{{ url_for('faturamento.dashboard_faturamento') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
            </a>
        </div>
    </div>

    <!-- Cards de Resumo -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Inconsistências de Faturamento
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-inconsistencias">
                                {{ total_inconsistencias }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                NFs sem Separação
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-sem-separacao">
                                {{ total_sem_separacao }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-unlink fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Embarques com Erro
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-embarques-erro">
                                {{ total_embarques_erro }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-truck fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Resolvidas Hoje
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="resolvidas-hoje">
                                {{ resolvidas_hoje }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Abas de Conteúdo -->
    <div class="card shadow mb-4">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="inconsistencias-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="inconsistencias-tab" data-bs-toggle="tab" data-bs-target="#inconsistencias" type="button" role="tab" aria-controls="inconsistencias" aria-selected="true">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Inconsistências de Faturamento
                        <span class="badge bg-warning ms-1">{{ total_inconsistencias }}</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="embarques-tab" data-bs-toggle="tab" data-bs-target="#embarques" type="button" role="tab" aria-controls="embarques" aria-selected="false">
                        <i class="fas fa-truck"></i> 
                        Embarques com Erro
                        <span class="badge bg-info ms-1">{{ total_embarques_erro }}</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="explicacao-tab" data-bs-toggle="tab" data-bs-target="#explicacao" type="button" role="tab" aria-controls="explicacao" aria-selected="false">
                        <i class="fas fa-question-circle"></i> 
                        O que significa cada tipo?
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="card-body">
            <div class="tab-content" id="inconsistencias-content">
                <!-- Tab: Inconsistências -->
                <div class="tab-pane fade show active" id="inconsistencias" role="tabpanel">
                    {% if total_inconsistencias == 0 %}
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle"></i> Nenhuma inconsistência encontrada</h5>
                            <p>Não há inconsistências de faturamento no momento. Isso pode significar que:</p>
                            <ul>
                                <li>O processamento de faturamento ainda não foi executado</li>
                                <li>Todas as notas fiscais foram processadas corretamente</li>
                                <li>Todas as inconsistências anteriores foram resolvidas</li>
                            </ul>
                            <hr>
                            <p class="mb-0">
                                <strong>Para gerar inconsistências:</strong> Acesse o dashboard de faturamento e clique em 
                                <button class="btn btn-info btn-sm" disabled><i class="fas fa-play-circle"></i> Processar Pendências</button>
                            </p>
                        </div>
                    {% else %}
                        <div class="mb-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="filtrarTipo('todos')">
                                Todos
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="filtrarTipo('NF_SEM_SEPARACAO')">
                                Sem Separação
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="filtrarTipo('DIVERGENCIA_NF_EMBARQUE')">
                                Divergência Embarque
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover" id="tabela-inconsistencias">
                                <thead>
                                    <tr>
                                        <th>NF</th>
                                        <th>Tipo</th>
                                        <th>Pedido</th>
                                        <th>Cliente</th>
                                        <th>Produto</th>
                                        <th>Quantidade</th>
                                        <th>Observação</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for inc in inconsistencias %}
                                    <tr data-tipo="{{ inc.tipo }}">
                                        <td>
                                            <strong>{{ inc.numero_nf }}</strong>
                                        </td>
                                        <td>
                                            {% if inc.tipo == 'NF_SEM_SEPARACAO' %}
                                                <span class="badge bg-danger">Sem Separação</span>
                                            {% elif inc.tipo == 'DIVERGENCIA_NF_EMBARQUE' %}
                                                <span class="badge bg-warning">Divergência</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ inc.tipo }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ inc.num_pedido or '-' }}</td>
                                        <td>{{ inc.cliente[:30] }}...</td>
                                        <td>{{ inc.cod_produto }}</td>
                                        <td>{{ "{:,.0f}".format(inc.qtd_faturada or 0) }}</td>
                                        <td>
                                            <small class="text-muted">{{ inc.observacao_resolucao[:50] }}...</small>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-success" onclick="resolverInconsistencia({{ inc.id }})">
                                                <i class="fas fa-check"></i> Resolver
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Tab: Embarques com Erro -->
                <div class="tab-pane fade" id="embarques" role="tabpanel">
                    {% if total_embarques_erro == 0 %}
                        <div class="alert alert-info">
                            <h5><i class="fas fa-check-circle"></i> Nenhum embarque com erro</h5>
                            <p>Não há embarques com erro de validação no momento. Todos os embarques estão com suas NFs corretamente associadas.</p>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Embarques com erro de validação</strong> - Itens que precisam ter sua NF atualizada manualmente.
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Embarque</th>
                                        <th>Lote Separação</th>
                                        <th>Pedido</th>
                                        <th>Cliente</th>
                                        <th>NF Sugerida</th>
                                        <th>Erro</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in embarques_erro %}
                                    <tr>
                                        <td>{{ item.embarque_id }}</td>
                                        <td>
                                            <span class="badge bg-secondary">{{ item.separacao_lote_id }}</span>
                                        </td>
                                        <td>{{ item.num_pedido }}</td>
                                        <td>{{ item.cliente[:30] }}...</td>
                                        <td>
                                            {% if item.nf_sugerida %}
                                                <span class="badge bg-success">{{ item.nf_sugerida }}</span>
                                            {% else %}
                                                <span class="badge bg-danger">Não encontrada</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-danger">{{ item.erro_validacao[:50] }}...</small>
                                        </td>
                                        <td>
                                            <a href="{{ url_for('atualizar_nf.atualizar_nf_pendentes_view') }}" 
                                               class="btn btn-sm btn-primary">
                                                <i class="fas fa-edit"></i> Atualizar
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Tab: Explicações -->
                <div class="tab-pane fade" id="explicacao" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-unlink"></i> NF Sem Separação
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>O que é:</strong></p>
                                    <ul>
                                        <li>Nota Fiscal processada mas não encontrou embarque ativo para o pedido</li>
                                        <li>O pedido da NF não tem separação vinculada</li>
                                        <li>Pode indicar que o pedido foi cancelado ou não existe</li>
                                    </ul>
                                    <p><strong>Como resolver:</strong></p>
                                    <ol>
                                        <li>Verificar se o pedido existe e está ativo</li>
                                        <li>Verificar se há embarque criado para este pedido</li>
                                        <li>Se não houver, criar o embarque ou cancelar a NF</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-warning text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-exchange-alt"></i> Divergência NF x Embarque
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>O que é:</strong></p>
                                    <ul>
                                        <li>NF está vinculada a um embarque mas o número do pedido não corresponde</li>
                                        <li>Indica que a NF foi associada ao embarque errado</li>
                                        <li>Pode causar problemas na expedição</li>
                                    </ul>
                                    <p><strong>Como resolver:</strong></p>
                                    <ol>
                                        <li>Verificar o pedido correto da NF</li>
                                        <li>Localizar o embarque correto</li>
                                        <li>Corrigir a vinculação no sistema</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-truck"></i> Embarques com Erro
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>O que é:</strong></p>
                                    <ul>
                                        <li>Itens de embarque com erro de validação</li>
                                        <li>Precisam ter a NF atualizada manualmente</li>
                                        <li>Geralmente ocorre quando a NF não foi encontrada automaticamente</li>
                                    </ul>
                                    <p><strong>Como resolver:</strong></p>
                                    <ol>
                                        <li>Acessar a tela de atualização de NFs</li>
                                        <li>Verificar a NF sugerida pelo sistema</li>
                                        <li>Confirmar ou corrigir a NF manualmente</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-info-circle"></i> Informações Importantes
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Sobre as inconsistências:</strong></p>
                                    <ul>
                                        <li>São geradas automaticamente durante o processamento de faturamento</li>
                                        <li>Cada NF gera no máximo uma inconsistência de cada tipo</li>
                                        <li>Inconsistências resolvidas não aparecem mais na lista</li>
                                        <li>O sistema atualiza inconsistências existentes ao reprocessar</li>
                                    </ul>
                                    <div class="alert alert-warning mt-3">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>Importante:</strong> Resolva as inconsistências antes de gerar novos embarques para evitar problemas na expedição.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function filtrarTipo(tipo) {
    const linhas = document.querySelectorAll('#tabela-inconsistencias tbody tr');
    
    linhas.forEach(linha => {
        if (tipo === 'todos' || linha.dataset.tipo === tipo) {
            linha.style.display = '';
        } else {
            linha.style.display = 'none';
        }
    });
}

function resolverInconsistencia(id) {
    if (!confirm('Deseja marcar esta inconsistência como resolvida?')) {
        return;
    }
    
    fetch(`/faturamento/api/resolver-inconsistencia/${id}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            alert('Inconsistência resolvida com sucesso!');
            location.reload();
        } else {
            alert('Erro ao resolver inconsistência: ' + data.erro);
        }
    })
    .catch(error => {
        alert('Erro ao resolver inconsistência: ' + error);
    });
}
</script>
{% endblock %}