{% extends 'base.html' %}
{% block content %}
<div class="container-fluid mt-4">
  <h2>Relat√≥rios de Faturamento Importados</h2>
  
  <!-- üÜï CONTROLES DE INATIVA√á√ÉO -->
  <div class="row mb-3">
    <div class="col-md-8">
      <div class="btn-group" role="group">
        <button type="button" id="btnInativar" class="btn btn-warning" onclick="inativarSelecionadas()" disabled>
          üóëÔ∏è Inativar Selecionadas
        </button>
        <button type="button" id="btnSelecionarTodos" class="btn btn-outline-secondary" onclick="selecionarTodos()">
          ‚òëÔ∏è Selecionar Todos
        </button>
        <button type="button" id="btnDeselecionarTodos" class="btn btn-outline-secondary" onclick="deselecionarTodos()">
          ‚òê Desmarcar Todos
        </button>
      </div>
    </div>
    <div class="col-md-4 text-end">
      <div class="btn-group me-3" role="group">
        <a href="?mostrar_inativas=false{{ '&' + request.query_string.decode() if request.query_string and 'mostrar_inativas' not in request.query_string.decode() }}" 
           class="btn {% if not mostrar_inativas %}btn-success{% else %}btn-outline-success{% endif %} btn-sm">
          ‚úÖ Apenas Ativas
        </a>
        <a href="?mostrar_inativas=true{{ '&' + request.query_string.decode() if request.query_string and 'mostrar_inativas' not in request.query_string.decode() }}" 
           class="btn {% if mostrar_inativas %}btn-secondary{% else %}btn-outline-secondary{% endif %} btn-sm">
          üìã Todas
        </a>
      </div>
      <span id="contadorSelecionadas" class="badge bg-primary">0 selecionadas</span>
    </div>
  </div>

  <!-- =========== FILTROS =========== -->
  <form method="GET" class="row g-3 mb-4">
    <div class="col-md-3">
      <input type="text"
             name="numero_nf"
             class="form-control"
             placeholder="N√∫mero NF"
             value="{{ request.args.get('numero_nf', '') }}">
    </div>
    <div class="col-md-3">
      <input type="text"
             name="cnpj_cliente"
             class="form-control"
             placeholder="CNPJ Cliente"
             value="{{ request.args.get('cnpj_cliente', '') }}">
    </div>
    <div class="col-md-3">
      <input type="text"
             name="nome_cliente"
             class="form-control"
             placeholder="Nome Cliente"
             value="{{ request.args.get('nome_cliente', '') }}">
    </div>
    <div class="col-md-3">
      <input type="text"
             name="vendedor"
             class="form-control"
             placeholder="Vendedor"
             value="{{ request.args.get('vendedor', '') }}">
    </div>

    <div class="col-md-3">
      <button type="submit" class="btn btn-primary w-100">
        Filtrar
      </button>
    </div>
  </form>

  <!-- =========== TABELA COM ORDENA√á√ÉO =========== -->
  <form id="formInativacao">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <table class="table table-bordered table-hover table-striped">
      <thead>
        <tr>
          {# üÜï COLUNA DE SELE√á√ÉO #}
          <th style="width: 50px;">
            <input type="checkbox" id="checkboxTodos" onchange="toggleTodos()">
          </th>
          
          {# Para cada coluna orden√°vel, definimos a l√≥gica do "next_dir" #}

        {# NF #}
        {% set next_dir = 'desc' if sort=='numero_nf' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=numero_nf&direction={{ next_dir }}">
            NF
            {% if sort=='numero_nf' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# CNPJ #}
        {% set next_dir = 'desc' if sort=='cnpj_cliente' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=cnpj_cliente&direction={{ next_dir }}">
            CNPJ
            {% if sort=='cnpj_cliente' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Data Fatura #}
        {% set next_dir = 'desc' if sort=='data_fatura' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=data_fatura&direction={{ next_dir }}">
            Data Fatura
            {% if sort=='data_fatura' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Nome Cliente #}
        {% set next_dir = 'desc' if sort=='nome_cliente' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=nome_cliente&direction={{ next_dir }}">
            Cliente
            {% if sort=='nome_cliente' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Valor Total #}
        {% set next_dir = 'desc' if sort=='valor_total' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=valor_total&direction={{ next_dir }}">
            Valor Total
            {% if sort=='valor_total' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Transportadora #}
        {% set next_dir = 'desc' if sort=='nome_transportadora' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=nome_transportadora&direction={{ next_dir }}">
            Transportadora
            {% if sort=='nome_transportadora' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Munic√≠pio #}
        {% set next_dir = 'desc' if sort=='municipio' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=municipio&direction={{ next_dir }}">
            Munic√≠pio
            {% if sort=='municipio' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# UF #}
        {% set next_dir = 'desc' if sort=='estado' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=estado&direction={{ next_dir }}">
            UF
            {% if sort=='estado' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Incoterm #}
        {% set next_dir = 'desc' if sort=='incoterm' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=incoterm&direction={{ next_dir }}">
            Incoterm
            {% if sort=='incoterm' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Vendedor #}
        {% set next_dir = 'desc' if sort=='vendedor' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=vendedor&direction={{ next_dir }}">
            Vendedor
            {% if sort=='vendedor' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>
        
        {# üÜï STATUS #}
        <th style="width: 100px;">Status</th>
      </tr>
    </thead>

    <tbody>
      {% for r in relatorios %}
      <tr class="{% if not r.ativo %}table-secondary text-muted{% endif %}">
        {# üÜï CHECKBOX DE SELE√á√ÉO #}
        <td class="text-center">
          {% if r.ativo %}
            <input type="checkbox" class="checkbox-nf" name="nfs_selecionadas" value="{{ r.numero_nf }}" onchange="atualizarContador()">
          {% else %}
            <span class="text-muted">‚Äî</span>
          {% endif %}
        </td>
        
        <td>{{ r.numero_nf }}</td>
        <td>{{ r.cnpj_cliente }}</td>
        <td>{{ r.data_fatura | formatar_data_segura if r.data_fatura else '' }}</td>
        <td>{{ r.nome_cliente }}</td>
        <td>R$ {{ '%.2f'|format(r.valor_total or 0) }}</td>
        <td>{{ r.nome_transportadora }}</td>
        <td>{{ r.municipio }}</td>
        <td>{{ r.estado }}</td>
        <td>{{ r.incoterm }}</td>
        <td>{{ r.vendedor }}</td>
        
        {# üÜï STATUS #}
        <td class="text-center">
          {% if r.ativo %}
            <span class="badge bg-success">Ativa</span>
          {% else %}
            <span class="badge bg-secondary">Inativa</span>
            {% if r.inativado_em %}
              <br><small class="text-muted">{{ r.inativado_em | formatar_data_hora_brasil }}</small>
            {% endif %}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </form>

  <!-- =========== PAGINA√á√ÉO =========== -->
  {% if paginacao.pages > 1 %}
  <nav>
    <ul class="pagination pagination-sm">

      {% set args_no_page = request.args.copy() %}
      {% if 'page' in args_no_page %}
        {% set _ = args_no_page.pop('page') %}
      {% endif %}

      <!-- Primeira -->
      <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('faturamento.listar_relatorios',
          page=1, **args_no_page) }}">¬´</a>
      </li>

      <!-- Anterior -->
      <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('faturamento.listar_relatorios',
          page=paginacao.prev_num, **args_no_page) }}">‚Äπ</a>
      </li>

      <!-- P√°ginas ao redor -->
      {% for p in range(paginacao.page - 2, paginacao.page + 3) if p>0 and p<=paginacao.pages %}
        <li class="page-item {% if p == paginacao.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('faturamento.listar_relatorios',
            page=p, **args_no_page) }}">
            {{ p }}
          </a>
        </li>
      {% endfor %}

      <!-- Pr√≥xima -->
      <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('faturamento.listar_relatorios',
          page=paginacao.next_num, **args_no_page) }}">‚Ä∫</a>
      </li>

      <!-- √öltima -->
      <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('faturamento.listar_relatorios',
          page=paginacao.pages, **args_no_page) }}">¬ª</a>
      </li>
    </ul>
  </nav>
  <div class="text-center">
    Exibindo
    {{ (paginacao.page - 1) * paginacao.per_page + 1 }}
    ‚Äì
    {{ (paginacao.page - 1) * paginacao.per_page + paginacao.items|length }}
    de
    {{ paginacao.total }}
  </div>
  {% endif %}
</div>

<!-- üÜï JAVASCRIPT PARA CONTROLE DOS CHECKBOXES E INATIVA√á√ÉO -->
<script>
function toggleTodos() {
  const checkboxTodos = document.getElementById('checkboxTodos');
  const checkboxes = document.querySelectorAll('.checkbox-nf');
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = checkboxTodos.checked;
  });
  
  atualizarContador();
}

function selecionarTodos() {
  const checkboxes = document.querySelectorAll('.checkbox-nf');
  checkboxes.forEach(checkbox => checkbox.checked = true);
  document.getElementById('checkboxTodos').checked = true;
  atualizarContador();
}

function deselecionarTodos() {
  const checkboxes = document.querySelectorAll('.checkbox-nf');
  checkboxes.forEach(checkbox => checkbox.checked = false);
  document.getElementById('checkboxTodos').checked = false;
  atualizarContador();
}

function atualizarContador() {
  const checkboxesSelecionados = document.querySelectorAll('.checkbox-nf:checked');
  const contador = checkboxesSelecionados.length;
  
  document.getElementById('contadorSelecionadas').textContent = `${contador} selecionadas`;
  document.getElementById('btnInativar').disabled = contador === 0;
  
  // Atualiza estado do checkbox "todos"
  const totalCheckboxes = document.querySelectorAll('.checkbox-nf').length;
  const checkboxTodos = document.getElementById('checkboxTodos');
  
  if (contador === 0) {
    checkboxTodos.indeterminate = false;
    checkboxTodos.checked = false;
  } else if (contador === totalCheckboxes) {
    checkboxTodos.indeterminate = false;
    checkboxTodos.checked = true;
  } else {
    checkboxTodos.indeterminate = true;
  }
}

function inativarSelecionadas() {
  const checkboxesSelecionados = document.querySelectorAll('.checkbox-nf:checked');
  
  if (checkboxesSelecionados.length === 0) {
    alert('Selecione pelo menos uma NF para inativar!');
    return;
  }
  
  const nfs = Array.from(checkboxesSelecionados).map(cb => cb.value);
  const confirmacao = confirm(`Confirma a inativa√ß√£o de ${nfs.length} NF(s)?\n\nNFs: ${nfs.join(', ')}\n\n‚ö†Ô∏è As NFs inativadas ser√£o removidas do monitoramento!`);
  
  if (!confirmacao) return;
  
  // Bloqueia bot√£o durante processamento
  const btnInativar = document.getElementById('btnInativar');
  btnInativar.disabled = true;
  btnInativar.innerHTML = '‚è≥ Processando...';
  
  // Prepara dados para envio
  const formData = new FormData();
  formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
  
  nfs.forEach(nf => {
    formData.append('nfs_selecionadas', nf);
  });
  
  // Envia requisi√ß√£o
  fetch('{{ url_for("faturamento.inativar_nfs") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`‚úÖ ${data.message}`);
      location.reload();
    } else {
      alert(`‚ùå Erro: ${data.message}`);
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    alert('‚ùå Erro ao processar solicita√ß√£o!');
  })
  .finally(() => {
    btnInativar.disabled = false;
    btnInativar.innerHTML = 'üóëÔ∏è Inativar Selecionadas';
  });
}

// Inicializa contador na carga da p√°gina
document.addEventListener('DOMContentLoaded', function() {
  atualizarContador();
});
</script>
{% endblock %}
