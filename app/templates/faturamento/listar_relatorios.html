{% extends 'base.html' %}
{% block content %}

{# Vari√°vel para preservar filtros na ordena√ß√£o #}
{% set filtros_atuais = request.args.copy() %}
{% if 'sort' in filtros_atuais %}{% set _ = filtros_atuais.pop('sort') %}{% endif %}
{% if 'direction' in filtros_atuais %}{% set _ = filtros_atuais.pop('direction') %}{% endif %}
{% if 'page' in filtros_atuais %}{% set _ = filtros_atuais.pop('page') %}{% endif %}

<div class="container-fluid mt-4">
  <h2>Relat√≥rios de Faturamento Importados</h2>
  
  <!-- üÜï CONTROLES DE INATIVA√á√ÉO -->
  <div class="row mb-3">
    <div class="col-md-8">
      <div class="btn-group" role="group">
        <button type="button" id="btnInativar" class="btn btn-warning" onclick="inativarSelecionadas()" disabled>
          üóëÔ∏è Inativar Selecionadas
        </button>
        <button type="button" id="btnSelecionarTodos" class="btn btn-outline-secondary" onclick="selecionarTodos()">
          ‚òëÔ∏è Selecionar Todos
        </button>
        <button type="button" id="btnDeselecionarTodos" class="btn btn-outline-secondary" onclick="deselecionarTodos()">
          ‚òê Desmarcar Todos
        </button>
      </div>
    </div>
    <div class="col-md-4 text-end">
      <div class="btn-group me-3" role="group">
        <a href="?mostrar_inativas=false{{ '&' + request.query_string.decode() if request.query_string and 'mostrar_inativas' not in request.query_string.decode() }}" 
           class="btn {% if not mostrar_inativas %}btn-success{% else %}btn-outline-success{% endif %} btn-sm">
          ‚úÖ Apenas Ativas
        </a>
        <a href="?mostrar_inativas=true{{ '&' + request.query_string.decode() if request.query_string and 'mostrar_inativas' not in request.query_string.decode() }}" 
           class="btn {% if mostrar_inativas %}btn-secondary{% else %}btn-outline-secondary{% endif %} btn-sm">
          üìã Todas
        </a>
      </div>
      <span id="contadorSelecionadas" class="badge bg-primary">0 selecionadas</span>
    </div>
  </div>

  <!-- =========== FILTROS EXPANDIDOS =========== -->
  <form method="GET" class="mb-4" id="form-filtros-faturamento">
    <!-- Primeira linha de filtros -->
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <label class="form-label">N√∫mero NF</label>
        <input type="text"
               name="numero_nf"
               class="form-control"
               placeholder="N√∫mero NF"
               value="{{ request.args.get('numero_nf', '') }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">CNPJ Cliente</label>
        <input type="text"
               name="cnpj_cliente"
               class="form-control"
               placeholder="CNPJ Cliente"
               value="{{ request.args.get('cnpj_cliente', '') }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Nome Cliente</label>
        <input type="text"
               name="nome_cliente"
               class="form-control"
               placeholder="Nome Cliente"
               value="{{ request.args.get('nome_cliente', '') }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Vendedor</label>
        <input type="text"
               name="vendedor"
               class="form-control"
               placeholder="Vendedor"
               value="{{ request.args.get('vendedor', '') }}">
      </div>
    </div>

    <!-- üÜï SEGUNDA LINHA - NOVOS FILTROS SOLICITADOS -->
    <div class="row g-3 mb-3">
      <div class="col-md-2">
        <label class="form-label">üè∑Ô∏è Incoterm</label>
        <select name="incoterm" class="form-select">
          <option value="">Todos</option>
          {% for incoterm in incoterms_list %}
            <option value="{{ incoterm }}" 
                    {% if request.args.get('incoterm') == incoterm %}selected{% endif %}>
              {{ incoterm }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">üì¶ Pedido</label>
        <input type="text"
               name="origem"
               class="form-control"
               placeholder="N√∫mero do Pedido"
               value="{{ request.args.get('origem', '') }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">üìÖ Data de Fatura (De)</label>
        <input type="date"
               name="data_de"
               class="form-control"
               value="{{ request.args.get('data_de', '') }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">üìÖ Data de Fatura (At√©)</label>
        <input type="date"
               name="data_ate"
               class="form-control"
               value="{{ request.args.get('data_ate', '') }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">&nbsp;</label>
        <button type="submit" class="btn btn-primary w-100">
          üîç Filtrar
        </button>
      </div>
    </div>

    <!-- Bot√£o para limpar filtros -->
    <div class="row">
      <div class="col-12">
        <a href="{{ url_for('faturamento.listar_relatorios') }}" class="btn btn-outline-secondary btn-sm">
          üóëÔ∏è Limpar Filtros
        </a>
        <span class="text-muted ms-3">
          {% if request.args %}
            <small>Filtros ativos: {{ request.args|length }}</small>
          {% endif %}
        </span>
      </div>
    </div>
  </form>

  <!-- =========== TABELA COM ORDENA√á√ÉO =========== -->
  <form id="formInativacao">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <table class="table table-bordered table-hover table-striped">
      <thead>
        <tr>
          {# üÜï COLUNA DE SELE√á√ÉO #}
          <th style="width: 50px;">
            <input type="checkbox" id="checkboxTodos" onchange="toggleTodos()">
          </th>
          
          {# Para cada coluna orden√°vel, definimos a l√≥gica do "next_dir" #}

        {# NF #}
        {% set next_dir = 'desc' if sort=='numero_nf' and direction=='asc' else 'asc' %}
        <th>
          <a href="{{ url_for('faturamento.listar_relatorios', sort='numero_nf', direction=next_dir, **filtros_atuais) }}">
            NF
            {% if sort=='numero_nf' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# ORIGEM #}
        {% set next_dir = 'desc' if sort=='origem' and direction=='asc' else 'asc' %}
        <th>
          <a href="{{ url_for('faturamento.listar_relatorios', sort='origem', direction=next_dir, **filtros_atuais) }}">
            Origem
            {% if sort=='origem' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# CNPJ #}
        {% set next_dir = 'desc' if sort=='cnpj_cliente' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=cnpj_cliente&direction={{ next_dir }}">
            CNPJ
            {% if sort=='cnpj_cliente' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Data Fatura #}
        {% set next_dir = 'desc' if sort=='data_fatura' and direction=='asc' else 'asc' %}
        <th>
          <a href="{{ url_for('faturamento.listar_relatorios', sort='data_fatura', direction=next_dir, **filtros_atuais) }}">
            Data Fatura
            {% if sort=='data_fatura' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Nome Cliente #}
        {% set next_dir = 'desc' if sort=='nome_cliente' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=nome_cliente&direction={{ next_dir }}">
            Cliente
            {% if sort=='nome_cliente' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Valor Total #}
        {% set next_dir = 'desc' if sort=='valor_total' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=valor_total&direction={{ next_dir }}">
            Valor Total
            {% if sort=='valor_total' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# üÜï Peso Bruto #}
        {% set next_dir = 'desc' if sort=='peso_bruto' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=peso_bruto&direction={{ next_dir }}">
            Peso (kg)
            {% if sort=='peso_bruto' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Transportadora #}
        {% set next_dir = 'desc' if sort=='nome_transportadora' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=nome_transportadora&direction={{ next_dir }}">
            Transportadora
            {% if sort=='nome_transportadora' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Munic√≠pio #}
        {% set next_dir = 'desc' if sort=='municipio' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=municipio&direction={{ next_dir }}">
            Munic√≠pio
            {% if sort=='municipio' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# UF #}
        {% set next_dir = 'desc' if sort=='estado' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=estado&direction={{ next_dir }}">
            UF
            {% if sort=='estado' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Incoterm #}
        {% set next_dir = 'desc' if sort=='incoterm' and direction=='asc' else 'asc' %}
        <th>
          <a href="{{ url_for('faturamento.listar_relatorios', sort='incoterm', direction=next_dir, **filtros_atuais) }}">
            Incoterm
            {% if sort=='incoterm' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>

        {# Vendedor #}
        {% set next_dir = 'desc' if sort=='vendedor' and direction=='asc' else 'asc' %}
        <th>
          <a href="?sort=vendedor&direction={{ next_dir }}">
            Vendedor
            {% if sort=='vendedor' %}
              <span class="badge text-secondary">
                {{ '‚Üë' if direction=='asc' else '‚Üì' }}
              </span>
            {% endif %}
          </a>
        </th>
        
        {# üÜï STATUS #}
        <th style="width: 100px;">Status</th>
        
        {# üóëÔ∏è A√á√ïES - apenas para administradores #}
        {% if current_user.perfil == 'administrador' %}
        <th style="width: 100px;">A√ß√µes</th>
        {% endif %}
      </tr>
    </thead>

    <tbody>
      {% for r in relatorios %}
      <tr class="{% if not r.ativo %}table-secondary text-muted{% endif %}">
        {# üÜï CHECKBOX DE SELE√á√ÉO #}
        <td class="text-center">
          {% if r.ativo %}
            <input type="checkbox" class="checkbox-nf" name="nfs_selecionadas" value="{{ r.numero_nf }}" onchange="atualizarContador()">
          {% else %}
            <span class="text-muted">‚Äî</span>
          {% endif %}
        </td>
        
        <td>{{ r.numero_nf }}</td>
        <td>{{ r.origem or '-' }}</td>
        <td>{{ r.cnpj_cliente }}</td>
        <td>{{ r.data_fatura | formatar_data_segura if r.data_fatura else '' }}</td>
        <td>{{ r.nome_cliente }}</td>
        <td>R$ {{ '%.2f'|format(r.valor_total or 0) }}</td>
        <td>
          <div class="d-flex align-items-center justify-content-between">
            <span>
              {% if r.peso_bruto and r.peso_bruto > 0 %}
                {{ '%.2f'|format(r.peso_bruto) }} kg
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </span>
            <button type="button"
                    class="btn btn-sm {{ 'btn-info' if r.peso_bruto and r.peso_bruto > 0 else 'btn-warning' }} ms-2"
                    onclick="atualizarPeso('{{ r.numero_nf }}')"
                    title="{% if r.peso_bruto and r.peso_bruto > 0 %}Recalcular peso via CadastroPalletizacao{% else %}Calcular peso via CadastroPalletizacao{% endif %}">
              ‚öñÔ∏è {{ 'Recalc' if r.peso_bruto and r.peso_bruto > 0 else 'Calcular' }}
            </button>
          </div>
        </td>
        <td>{{ r.nome_transportadora }}</td>
        <td>{{ r.municipio }}</td>
        <td>{{ r.estado }}</td>
        <td>{{ r.incoterm }}</td>
        <td>{{ r.vendedor }}</td>
        
        {# üÜï STATUS #}
        <td class="text-center">
          {% if r.ativo %}
            <span class="badge bg-success">Ativa</span>
          {% else %}
            <span class="badge bg-secondary">Inativa</span>
            {% if r.inativado_em %}
              <br><small class="text-muted">{{ r.inativado_em | formatar_data_hora_brasil }}</small>
            {% endif %}
          {% endif %}
        </td>
        
        {# üóëÔ∏è A√á√ïES - BOT√ÉO EXCLUIR (apenas administradores) #}
        {% if current_user.perfil == 'administrador' %}
        <td class="text-center">
          <button type="button" 
                  class="btn btn-danger btn-sm" 
                  onclick="excluirNF('{{ r.numero_nf }}')"
                  title="Excluir NF permanentemente">
            üóëÔ∏è Excluir
          </button>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </form>

  <!-- =========== PAGINA√á√ÉO =========== -->
  {% if paginacao.pages > 1 %}
  <nav>
    <ul class="pagination pagination-sm">

      {% set args_no_page = request.args.copy() %}
      {% if 'page' in args_no_page %}
        {% set _ = args_no_page.pop('page') %}
      {% endif %}

      <!-- Primeira -->
      <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('faturamento.listar_relatorios',
          page=1, **args_no_page) }}">¬´</a>
      </li>

      <!-- Anterior -->
      <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('faturamento.listar_relatorios',
          page=paginacao.prev_num, **args_no_page) }}">‚Äπ</a>
      </li>

      <!-- P√°ginas ao redor -->
      {% for p in range(paginacao.page - 2, paginacao.page + 3) if p>0 and p<=paginacao.pages %}
        <li class="page-item {% if p == paginacao.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('faturamento.listar_relatorios',
            page=p, **args_no_page) }}">
            {{ p }}
          </a>
        </li>
      {% endfor %}

      <!-- Pr√≥xima -->
      <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('faturamento.listar_relatorios',
          page=paginacao.next_num, **args_no_page) }}">‚Ä∫</a>
      </li>

      <!-- √öltima -->
      <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('faturamento.listar_relatorios',
          page=paginacao.pages, **args_no_page) }}">¬ª</a>
      </li>
    </ul>
  </nav>
  <div class="text-center">
    Exibindo
    {{ (paginacao.page - 1) * paginacao.per_page + 1 }}
    ‚Äì
    {{ (paginacao.page - 1) * paginacao.per_page + paginacao.items|length }}
    de
    {{ paginacao.total }}
  </div>
  {% endif %}
</div>

<!-- üÜï JAVASCRIPT PARA CONTROLE DOS CHECKBOXES E INATIVA√á√ÉO -->
<script>
function toggleTodos() {
  const checkboxTodos = document.getElementById('checkboxTodos');
  const checkboxes = document.querySelectorAll('.checkbox-nf');
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = checkboxTodos.checked;
  });
  
  atualizarContador();
}

function selecionarTodos() {
  const checkboxes = document.querySelectorAll('.checkbox-nf');
  checkboxes.forEach(checkbox => checkbox.checked = true);
  document.getElementById('checkboxTodos').checked = true;
  atualizarContador();
}

function deselecionarTodos() {
  const checkboxes = document.querySelectorAll('.checkbox-nf');
  checkboxes.forEach(checkbox => checkbox.checked = false);
  document.getElementById('checkboxTodos').checked = false;
  atualizarContador();
}

function atualizarContador() {
  const checkboxesSelecionados = document.querySelectorAll('.checkbox-nf:checked');
  const contador = checkboxesSelecionados.length;
  
  document.getElementById('contadorSelecionadas').textContent = `${contador} selecionadas`;
  document.getElementById('btnInativar').disabled = contador === 0;
  
  // Atualiza estado do checkbox "todos"
  const totalCheckboxes = document.querySelectorAll('.checkbox-nf').length;
  const checkboxTodos = document.getElementById('checkboxTodos');
  
  if (contador === 0) {
    checkboxTodos.indeterminate = false;
    checkboxTodos.checked = false;
  } else if (contador === totalCheckboxes) {
    checkboxTodos.indeterminate = false;
    checkboxTodos.checked = true;
  } else {
    checkboxTodos.indeterminate = true;
  }
}

function inativarSelecionadas() {
  const checkboxesSelecionados = document.querySelectorAll('.checkbox-nf:checked');
  
  if (checkboxesSelecionados.length === 0) {
    alert('Selecione pelo menos uma NF para inativar!');
    return;
  }
  
  const nfs = Array.from(checkboxesSelecionados).map(cb => cb.value);
  const confirmacao = confirm(`Confirma a inativa√ß√£o de ${nfs.length} NF(s)?\n\nNFs: ${nfs.join(', ')}\n\n‚ö†Ô∏è As NFs inativadas ser√£o removidas do monitoramento!`);
  
  if (!confirmacao) return;
  
  // Bloqueia bot√£o durante processamento
  const btnInativar = document.getElementById('btnInativar');
  btnInativar.disabled = true;
  btnInativar.innerHTML = '‚è≥ Processando...';
  
  // Prepara dados para envio
  const formData = new FormData();
  formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
  
  nfs.forEach(nf => {
    formData.append('nfs_selecionadas', nf);
  });
  
  // Envia requisi√ß√£o
  fetch('{{ url_for("faturamento.inativar_nfs") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`‚úÖ ${data.message}`);
      location.reload();
    } else {
      alert(`‚ùå Erro: ${data.message}`);
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    alert('‚ùå Erro ao processar solicita√ß√£o!');
  })
  .finally(() => {
    btnInativar.disabled = false;
    btnInativar.innerHTML = 'üóëÔ∏è Inativar Selecionadas';
  });
}

// Inicializa contador na carga da p√°gina
document.addEventListener('DOMContentLoaded', function() {
  atualizarContador();
  
  // ===========================
  // AUTO SUBMIT PARA CAMPOS DE DATA
  // ===========================
  
  // Seleciona APENAS os campos de data do formul√°rio de filtros
  const camposDataFiltros = document.querySelectorAll('#form-filtros-faturamento input[type="date"]');
  
  // Fun√ß√£o para auto submit
  function autoSubmitFiltros() {
    const form = this.closest('form');
    if (form && form.id === 'form-filtros-faturamento') {
      form.submit();
    }
  }
  
  // Adiciona auto submit APENAS para os campos de filtro
  camposDataFiltros.forEach(campo => {
    campo.addEventListener('change', autoSubmitFiltros);
  });
  
  // Auto submit para selects (apenas Incoterm agora)
  const selectsFiltros = document.querySelectorAll('#form-filtros-faturamento select');
  selectsFiltros.forEach(select => {
    select.addEventListener('change', autoSubmitFiltros);
  });

  // ===========================
  // PRESERVAR FILTROS NOS LINKS DE ORDENA√á√ÉO
  // ===========================
  const currentUrl = new URL(window.location);
  
  // Para todos os links de ordena√ß√£o na tabela
  document.querySelectorAll('th a').forEach(link => {
    const linkUrl = new URL(link.href, window.location.origin);
    
    // Preserva todos os par√¢metros atuais exceto sort, direction e page
    currentUrl.searchParams.forEach((value, key) => {
      if (key !== 'sort' && key !== 'direction' && key !== 'page') {
        linkUrl.searchParams.set(key, value);
      }
    });
    
    // Atualiza o href do link
    link.href = linkUrl.toString();
  });
});

// üóëÔ∏è FUN√á√ÉO PARA EXCLUIR NF (apenas administradores)
function excluirNF(numeroNF) {
  // Confirma√ß√£o dupla para evitar exclus√µes acidentais
  const confirmacao1 = confirm(`‚ö†Ô∏è ATEN√á√ÉO: Voc√™ est√° prestes a EXCLUIR PERMANENTEMENTE a NF ${numeroNF}.\n\nEsta a√ß√£o ir√°:\n- Deletar a NF da tabela RelatorioFaturamentoImportado\n- Deletar TODAS as linhas de produtos desta NF\n\nDeseja continuar?`);
  
  if (!confirmacao1) return;
  
  const confirmacao2 = confirm(`‚ö†Ô∏è √öLTIMA CONFIRMA√á√ÉO:\n\nTem CERTEZA ABSOLUTA que deseja excluir a NF ${numeroNF}?\n\nEsta a√ß√£o N√ÉO pode ser desfeita!`);
  
  if (!confirmacao2) return;
  
  // Mostrar loading
  const btn = event.target;
  const textoOriginal = btn.innerHTML;
  btn.innerHTML = '‚è≥ Excluindo...';
  btn.disabled = true;
  
  // Fazer requisi√ß√£o DELETE para a API
  fetch(`/faturamento/api/excluir-nf/${numeroNF}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`‚úÖ NF ${numeroNF} exclu√≠da com sucesso!\n\n${data.produtos_deletados} produtos foram removidos.`);
      // Recarregar a p√°gina para atualizar a lista
      window.location.reload();
    } else {
      alert(`‚ùå Erro ao excluir NF: ${data.error}`);
      // Restaurar bot√£o
      btn.innerHTML = textoOriginal;
      btn.disabled = false;
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    alert(`‚ùå Erro ao excluir NF: ${error.message}`);
    // Restaurar bot√£o
    btn.innerHTML = textoOriginal;
    btn.disabled = false;
  });
}

// üÜï FUN√á√ÉO PARA ATUALIZAR PESO EM CASCATA
function atualizarPeso(numeroNF) {
  const confirmacao = confirm(`Atualizar peso da NF ${numeroNF}?\n\nIsso ir√°:\n‚úÖ Calcular peso via CadastroPalletizacao\n‚úÖ Atualizar FaturamentoProduto\n‚úÖ Atualizar EmbarqueItem\n‚úÖ Atualizar Embarque\n‚úÖ Recalcular Frete (peso + valor)`);

  if (!confirmacao) return;

  // Mostrar loading
  const btn = event.target;
  const textoOriginal = btn.innerHTML;
  btn.innerHTML = '‚è≥ Calculando...';
  btn.disabled = true;

  // Fazer requisi√ß√£o POST para a API
  fetch(`/faturamento/atualizar-peso/${numeroNF}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
    },
    credentials: 'same-origin'  // Importante para enviar cookies de sess√£o
  })
  .then(response => {
    // Verificar se foi redirecionado para login
    if (response.redirected && response.url.includes('/auth/login')) {
      alert('‚ùå Sess√£o expirada! Por favor, fa√ßa login novamente.');
      window.location.href = '/auth/login';
      return Promise.reject('Sess√£o expirada');
    }

    // Verificar se resposta √© JSON
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      throw new Error('Resposta n√£o √© JSON - poss√≠vel erro de autentica√ß√£o');
    }

    return response.json();
  })
  .then(data => {
    if (data.success) {
      const msg = `‚úÖ Peso atualizado com sucesso!\n\n` +
                  `üì¶ FaturamentoProduto: ${data.faturamento_produto?.atualizados || 0} itens\n` +
                  `üìä RelatorioFaturamento: ${data.relatorio?.peso_bruto?.toFixed(2) || 0} kg\n` +
                  `üöö EmbarqueItem: ${data.embarque_item?.atualizados || 0} itens (${data.embarque_item?.peso_total?.toFixed(2) || 0} kg, ${data.embarque_item?.pallets_total?.toFixed(2) || 0} pallets)\n` +
                  `üì¶ Embarque: ${data.embarque?.atualizados || 0} embarques\n` +
                  `üí∞ Frete: ${data.frete?.recalculados || 0} fretes recalculados`;

      alert(msg);
      // Recarregar a p√°gina para atualizar a lista
      window.location.reload();
    } else {
      alert(`‚ùå Erro ao atualizar peso: ${data.erro}`);
      // Restaurar bot√£o
      btn.innerHTML = textoOriginal;
      btn.disabled = false;
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    alert(`‚ùå Erro ao atualizar peso: ${error.message}`);
    // Restaurar bot√£o
    btn.innerHTML = textoOriginal;
    btn.disabled = false;
  });
}
</script>
{% endblock %}
