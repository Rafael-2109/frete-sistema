{% extends "base.html" %}

{% block title %}Detalhes do Rastreamento - Embarque #{{ rastreamento.embarque.numero }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #mapa-detalhes {
        height: 500px;
        width: 100%;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline-item {
        padding: 20px;
        background: #f8f9fa;
        border-left: 3px solid #28a745;
        margin-bottom: 20px;
        border-radius: 5px;
    }

    .timeline-item.chegada {
        border-left-color: #ffc107;
    }

    .timeline-item.entregue {
        border-left-color: #17a2b8;
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .timeline-title {
        font-weight: 600;
        color: #495057;
    }

    .timeline-time {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .status-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .status-card.ativo {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .status-card.proximo {
        background: linear-gradient(135deg, #ffc107 0%, #ff8b00 100%);
    }

    .status-card.entregue {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    }

    .metric-box {
        text-align: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        margin-bottom: 10px;
    }

    .metric-label {
        font-size: 0.8rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .metric-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-top: 5px;
    }

    .table-pings {
        font-size: 0.9rem;
    }

    .canhoto-preview {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-route"></i> Rastreamento GPS - Embarque #{{ rastreamento.embarque.numero }}</h2>
                    <p class="text-muted mb-0">Detalhes completos do rastreamento</p>
                </div>
                <a href="{{ url_for('rastreamento.dashboard_rastreamento') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
                </a>
            </div>

            <!-- Card de Status -->
            <div class="status-card {% if rastreamento.status == 'ATIVO' %}ativo{% elif rastreamento.status == 'CHEGOU_DESTINO' %}proximo{% elif rastreamento.status == 'ENTREGUE' %}entregue{% endif %}">
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-box">
                            <div class="metric-label">Status</div>
                            <div class="metric-value">
                                {% if rastreamento.status == 'ATIVO' %}
                                    ðŸšš EM TRÃ‚NSITO
                                {% elif rastreamento.status == 'CHEGOU_DESTINO' %}
                                    ðŸŽ¯ PRÃ“XIMO
                                {% elif rastreamento.status == 'ENTREGUE' %}
                                    âœ… ENTREGUE
                                {% else %}
                                    {{ rastreamento.status }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-box">
                            <div class="metric-label">Total de Pings</div>
                            <div class="metric-value">{{ pings|length }}</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-box">
                            <div class="metric-label">Ãšltimo Ping</div>
                            <div class="metric-value" style="font-size: 1.2rem;">
                                {% if rastreamento.ultimo_ping_em %}
                                    {{ rastreamento.ultimo_ping_em.strftime('%d/%m %H:%M') }}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-box">
                            <div class="metric-label">DistÃ¢ncia MÃ­nima</div>
                            <div class="metric-value">
                                {% if rastreamento.distancia_minima_atingida %}
                                    {{ (rastreamento.distancia_minima_atingida)|round(0)|int }} m
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mapa com HistÃ³rico da Rota -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-map"></i> Rota Percorrida</h5>
                </div>
                <div class="card-body p-3">
                    <div id="mapa-detalhes"></div>
                </div>
            </div>

            <div class="row">
                <!-- Timeline de Eventos -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-clock"></i> Timeline de Eventos</h5>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                <!-- Aceite LGPD -->
                                {% if rastreamento.aceite_lgpd_em %}
                                <div class="timeline-item">
                                    <div class="timeline-header">
                                        <span class="timeline-title">âœ… Aceite LGPD</span>
                                        <span class="timeline-time">{{ rastreamento.aceite_lgpd_em.strftime('%d/%m/%Y %H:%M:%S') }}</span>
                                    </div>
                                    <small class="text-muted">
                                        IP: {{ rastreamento.aceite_lgpd_ip or 'N/A' }}<br>
                                        User-Agent: {{ rastreamento.aceite_lgpd_user_agent[:50] if rastreamento.aceite_lgpd_user_agent else 'N/A' }}...
                                    </small>
                                </div>
                                {% endif %}

                                <!-- InÃ­cio do Rastreamento -->
                                {% if rastreamento.rastreamento_iniciado_em %}
                                <div class="timeline-item">
                                    <div class="timeline-header">
                                        <span class="timeline-title">ðŸš€ Rastreamento Iniciado</span>
                                        <span class="timeline-time">{{ rastreamento.rastreamento_iniciado_em.strftime('%d/%m/%Y %H:%M:%S') }}</span>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Chegada ao Destino -->
                                {% if rastreamento.chegou_destino_em %}
                                <div class="timeline-item chegada">
                                    <div class="timeline-header">
                                        <span class="timeline-title">ðŸŽ¯ Chegou ao Destino</span>
                                        <span class="timeline-time">{{ rastreamento.chegou_destino_em.strftime('%d/%m/%Y %H:%M:%S') }}</span>
                                    </div>
                                    <small class="text-muted">
                                        DistÃ¢ncia mÃ­nima: {{ (rastreamento.distancia_minima_atingida)|round(0)|int }} metros
                                    </small>
                                </div>
                                {% endif %}

                                <!-- Canhoto Enviado -->
                                {% if rastreamento.canhoto_enviado_em %}
                                <div class="timeline-item entregue">
                                    <div class="timeline-header">
                                        <span class="timeline-title">ðŸ“¸ Canhoto Enviado</span>
                                        <span class="timeline-time">{{ rastreamento.canhoto_enviado_em.strftime('%d/%m/%Y %H:%M:%S') }}</span>
                                    </div>
                                    {% if rastreamento.canhoto_latitude and rastreamento.canhoto_longitude %}
                                    <small class="text-muted">
                                        GPS: {{ rastreamento.canhoto_latitude }}, {{ rastreamento.canhoto_longitude }}
                                    </small>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Entrega Finalizada -->
                                {% if rastreamento.rastreamento_finalizado_em %}
                                <div class="timeline-item entregue">
                                    <div class="timeline-header">
                                        <span class="timeline-title">âœ… Rastreamento Finalizado</span>
                                        <span class="timeline-time">{{ rastreamento.rastreamento_finalizado_em.strftime('%d/%m/%Y %H:%M:%S') }}</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Canhoto (se existir) -->
                    {% if rastreamento.canhoto_arquivo %}
                    <div class="card mt-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-file-image"></i> Canhoto Assinado</h5>
                        </div>
                        <div class="card-body text-center">
                            <img src="{{ url_for('static', filename='uploads/canhotos/' + rastreamento.canhoto_arquivo.split('/')[-1]) }}"
                                 alt="Canhoto"
                                 class="canhoto-preview">
                            <div class="mt-3">
                                <a href="{{ url_for('static', filename='uploads/canhotos/' + rastreamento.canhoto_arquivo.split('/')[-1]) }}"
                                   class="btn btn-primary"
                                   download
                                   target="_blank">
                                    <i class="fas fa-download"></i> Baixar Canhoto
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Tabela de Pings GPS -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-warning">
                            <h5 class="mb-0"><i class="fas fa-satellite-dish"></i> HistÃ³rico de Pings GPS (Ãºltimos 50)</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-striped table-pings mb-0">
                                    <thead class="table-dark" style="position: sticky; top: 0; z-index: 10;">
                                        <tr>
                                            <th>Data/Hora</th>
                                            <th>DistÃ¢ncia</th>
                                            <th>Velocidade</th>
                                            <th>PrecisÃ£o</th>
                                            <th>Bateria</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ping in pings[:50] %}
                                        <tr>
                                            <td>{{ ping.criado_em.strftime('%d/%m %H:%M:%S') }}</td>
                                            <td>
                                                {% if ping.distancia_destino %}
                                                    {{ (ping.distancia_destino / 1000)|round(2) }} km
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if ping.velocidade %}
                                                    {{ ping.velocidade|round(0)|int }} km/h
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if ping.precisao %}
                                                    {{ ping.precisao|round(0)|int }} m
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if ping.bateria_nivel %}
                                                    <span class="badge {% if ping.bateria_nivel > 50 %}bg-success{% elif ping.bateria_nivel > 20 %}bg-warning{% else %}bg-danger{% endif %}">
                                                        {{ ping.bateria_nivel }}%
                                                    </span>
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Inicializar mapa
    const mapaDetalhes = L.map('mapa-detalhes');

    // Adicionar camada do OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(mapaDetalhes);

    // Dados da rota
    const historicoRota = {{ historico_rota|tojson|safe }};

    if (historicoRota && historicoRota.length > 0) {
        // Criar polyline com a rota
        const coordenadas = historicoRota.map(p => [p.latitude, p.longitude]);
        const polyline = L.polyline(coordenadas, {
            color: '#28a745',
            weight: 4,
            opacity: 0.7
        }).addTo(mapaDetalhes);

        // Ajustar zoom para mostrar toda a rota
        mapaDetalhes.fitBounds(polyline.getBounds());

        // Adicionar marcador de inÃ­cio (verde)
        const inicio = historicoRota[0];
        L.marker([inicio.latitude, inicio.longitude], {
            icon: L.divIcon({
                html: '<div style="font-size: 30px;">ðŸš€</div>',
                className: 'custom-marker',
                iconSize: [30, 30]
            })
        }).addTo(mapaDetalhes)
        .bindPopup(`<strong>InÃ­cio</strong><br>${inicio.timestamp}`);

        // Adicionar marcador de posiÃ§Ã£o atual (azul)
        const atual = historicoRota[historicoRota.length - 1];
        L.marker([atual.latitude, atual.longitude], {
            icon: L.divIcon({
                html: '<div style="font-size: 30px;">ðŸšš</div>',
                className: 'custom-marker',
                iconSize: [30, 30]
            })
        }).addTo(mapaDetalhes)
        .bindPopup(`
            <strong>PosiÃ§Ã£o Atual</strong><br>
            ${atual.timestamp}<br>
            ${atual.distancia_destino ? 'DistÃ¢ncia: ' + (atual.distancia_destino / 1000).toFixed(1) + ' km' : ''}
        `);

        // Adicionar marcadores intermediÃ¡rios (a cada 10 pings)
        historicoRota.forEach((ponto, index) => {
            if (index > 0 && index < historicoRota.length - 1 && index % 10 === 0) {
                L.circleMarker([ponto.latitude, ponto.longitude], {
                    radius: 4,
                    fillColor: '#007bff',
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(mapaDetalhes)
                .bindPopup(`${ponto.timestamp}`);
            }
        });
    } else {
        // Se nÃ£o hÃ¡ rota, centralizar no Brasil
        mapaDetalhes.setView([-15.7801, -47.9292], 4);
    }
</script>
{% endblock %}
