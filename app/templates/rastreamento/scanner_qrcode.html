<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#28a745">
    <title>Scanner QR Code - Rastreamento Nacom</title>

    <!-- Standalone CSS with design tokens -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/_rastreamento-standalone.css') }}">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: hsl(0, 0%, 0%);
            min-height: 100vh;
            color: white;
        }

        .header {
            background: linear-gradient(135deg, var(--standalone-primary) 0%, var(--standalone-secondary) 100%);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px hsla(0, 0%, 0%, 0.3);
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .btn-voltar {
            background: hsla(0, 0%, 100%, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .scanner-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 0 20px;
        }

        #reader {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px hsla(145, 63%, 42%, 0.3);
        }

        .instructions {
            background: hsla(0, 0%, 100%, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }

        .instructions p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .status {
            background: hsla(145, 63%, 42%, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .status.error {
            background: hsla(354, 70%, 54%, 0.2);
        }

        .status.success {
            background: hsla(145, 63%, 42%, 0.3);
            display: block;
        }

        .icon-large {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .btn-manual {
            background: hsla(0, 0%, 100%, 0.1);
            border: 2px solid hsla(0, 0%, 100%, 0.3);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 15px;
            cursor: pointer;
            margin-top: 20px;
            display: inline-block;
            text-decoration: none;
        }

        .btn-manual:hover {
            background: hsla(0, 0%, 100%, 0.2);
        }

        #manual-input {
            display: none;
            margin-top: 20px;
        }

        #manual-input input {
            width: 100%;
            padding: 15px;
            border: 2px solid hsla(0, 0%, 100%, 0.3);
            border-radius: 10px;
            background: hsla(0, 0%, 100%, 0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
        }

        #manual-input input::placeholder {
            color: hsla(0, 0%, 100%, 0.6);
        }

        #manual-input button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: var(--standalone-primary);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid hsla(0, 0%, 100%, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Escanear QR Code</h1>
        <a href="/rastreamento/app" class="btn-voltar">Voltar</a>
    </div>

    <div class="scanner-container">
        <div id="reader"></div>

        <div class="instructions">
            <p><strong>Instrucoes:</strong></p>
            <p>Aponte a camera para o <strong>QR Code</strong> do embarque.</p>
            <p>O reconhecimento sera automatico.</p>
        </div>

        <div class="status" id="status"></div>

        <div style="text-align: center;">
            <button class="btn-manual" onclick="toggleManualInput()">
                Digitar codigo manualmente
            </button>
        </div>

        <div id="manual-input">
            <input type="text" id="token-input" placeholder="Digite o codigo do embarque">
            <button onclick="processarTokenManual()">Confirmar</button>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Redirecionando...</p>
        </div>
    </div>

    <!-- HTML5 QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script>
        let html5QrCode = null;

        // Iniciar scanner ao carregar pagina
        window.addEventListener('load', iniciarScanner);

        function iniciarScanner() {
            const reader = document.getElementById('reader');

            html5QrCode = new Html5Qrcode("reader");

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode.start(
                { facingMode: "environment" }, // Camera traseira
                config,
                onScanSuccess,
                onScanError
            ).catch(err => {
                console.error('Erro ao iniciar camera:', err);
                mostrarStatus('error', 'Erro ao acessar camera. Verifique as permissoes.');
            });
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Code detectado:', decodedText);

            // Parar scanner
            html5QrCode.stop().then(() => {
                processarQRCode(decodedText);
            }).catch(err => {
                console.error('Erro ao parar scanner:', err);
                processarQRCode(decodedText);
            });
        }

        function onScanError(errorMessage) {
            // Ignorar erros de scan (muito verboso)
            // console.log('Erro scan:', errorMessage);
        }

        function processarQRCode(qrCodeText) {
            mostrarStatus('success', 'QR Code reconhecido!');

            try {
                // QR Code deve conter URL completa ou apenas o token
                let token = null;

                if (qrCodeText.includes('rastreamento/aceite/')) {
                    // URL completa: extrair token
                    token = qrCodeText.split('rastreamento/aceite/')[1].split('?')[0];
                } else if (qrCodeText.length > 10 && !qrCodeText.includes(' ')) {
                    // Apenas o token
                    token = qrCodeText;
                } else {
                    throw new Error('QR Code invalido');
                }

                // Mostrar loading
                document.getElementById('loading').style.display = 'block';
                document.getElementById('reader').style.display = 'none';

                // Redirecionar para tela de aceite LGPD
                setTimeout(() => {
                    window.location.href = '/rastreamento/aceite/' + token;
                }, 1000);

            } catch (error) {
                console.error('Erro ao processar QR Code:', error);
                mostrarStatus('error', 'QR Code invalido. Tente novamente.');

                // Reiniciar scanner apos 2 segundos
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        }

        function mostrarStatus(tipo, mensagem) {
            const status = document.getElementById('status');
            status.className = 'status ' + tipo;
            status.innerHTML = mensagem;
            status.style.display = 'block';
        }

        function toggleManualInput() {
            const manualInput = document.getElementById('manual-input');
            if (manualInput.style.display === 'none' || !manualInput.style.display) {
                manualInput.style.display = 'block';
                document.getElementById('token-input').focus();
            } else {
                manualInput.style.display = 'none';
            }
        }

        function processarTokenManual() {
            const token = document.getElementById('token-input').value.trim();

            if (!token) {
                alert('Digite o codigo do embarque');
                return;
            }

            if (token.length < 10) {
                alert('Codigo invalido');
                return;
            }

            // Processar como QR Code
            processarQRCode(token);
        }

        // Limpar ao sair
        window.addEventListener('beforeunload', () => {
            if (html5QrCode) {
                html5QrCode.stop().catch(err => console.error('Erro ao parar camera:', err));
            }
        });
    </script>
</body>
</html>
