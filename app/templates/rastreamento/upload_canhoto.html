<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#28a745">
    <title>Upload de Comprovante</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Standalone CSS with design tokens -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/_rastreamento-standalone.css') }}">

    <style>
        body {
            background: linear-gradient(135deg, var(--standalone-gradient-start) 0%, var(--standalone-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .upload-card {
            background: var(--standalone-bg-light);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            margin: 50px auto;
            box-shadow: 0 10px 40px hsla(0, 0%, 0%, 0.2);
        }

        .upload-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--standalone-primary) 0%, var(--standalone-secondary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: -80px auto 20px;
            box-shadow: 0 5px 20px hsla(145, 63%, 42%, 0.3);
        }

        .upload-icon i {
            font-size: 50px;
            color: white;
        }

        .upload-area {
            border: 3px dashed var(--standalone-primary);
            border-radius: 20px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--standalone-bg);
        }

        .upload-area:hover {
            background: var(--standalone-border);
            border-color: var(--standalone-secondary);
        }

        .upload-area.dragging {
            background: var(--standalone-primary-light);
            border-color: var(--standalone-primary);
        }

        .preview-container {
            margin-top: 20px;
            display: none;
        }

        .preview-image {
            max-width: 100%;
            border-radius: 15px;
            box-shadow: 0 5px 15px hsla(0, 0%, 0%, 0.1);
        }

        .btn-camera, .btn-enviar {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 15px;
            margin-top: 15px;
        }

        .btn-camera {
            background: linear-gradient(135deg, var(--standalone-info) 0%, hsl(207, 90%, 44%) 100%);
            border: none;
            color: white;
        }

        .btn-enviar {
            background: linear-gradient(135deg, var(--standalone-primary) 0%, var(--standalone-secondary) 100%);
            border: none;
            color: white;
        }

        .btn-enviar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .coordenadas-info {
            background: hsla(207, 90%, 54%, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin-top: 15px;
            font-size: 0.85rem;
            color: var(--standalone-text);
        }

        h3 {
            color: var(--standalone-text);
        }

        p {
            color: var(--standalone-text-muted);
        }

        .text-success {
            color: var(--standalone-primary) !important;
        }

        .text-muted {
            color: var(--standalone-text-muted) !important;
        }
    </style>
</head>
<body>
    <div class="upload-card">
        <div class="upload-icon">
            <i class="fas fa-camera"></i>
        </div>

        <h3 class="text-center mb-3 fw-bold">Comprovante de Entrega</h3>
        <p class="text-center">
            Tire uma foto do canhoto assinado pelo cliente
        </p>

        <!-- Area de Upload -->
        <div class="upload-area" id="uploadArea">
            <i class="fas fa-cloud-upload-alt fa-3x text-success mb-3"></i>
            <p class="mb-2"><strong>Clique para escolher arquivo</strong></p>
            <p class="text-muted small">ou arraste e solte aqui</p>
            <p class="text-muted small">JPG, JFIF, PNG ou PDF (max. 10MB)</p>
        </div>

        <input type="file" id="fileInput" accept="image/*,application/pdf" capture="environment" style="display: none;">

        <!-- Botao Camera (mobile) -->
        <button type="button" class="btn btn-camera" id="btnCamera">
            <i class="fas fa-camera"></i> Abrir Camera
        </button>

        <!-- Preview -->
        <div class="preview-container" id="previewContainer">
            <h5 class="mt-3 mb-2">Preview:</h5>
            <img id="previewImage" class="preview-image" alt="Preview">
            <button type="button" class="btn btn-outline-secondary btn-sm mt-2 w-100" id="btnRemover">
                <i class="fas fa-trash"></i> Remover e escolher outro
            </button>
        </div>

        <!-- Coordenadas GPS -->
        <div class="coordenadas-info" id="coordenadasInfo" style="display: none;">
            <i class="fas fa-map-marker-alt"></i>
            <strong>Localizacao capturada:</strong>
            <span id="coordenadasTexto">Obtendo...</span>
        </div>

        <!-- Alerta -->
        <div id="alertFeedback" class="alert mt-3 d-none" role="alert"></div>

        <!-- Botao Enviar -->
        <button type="button" class="btn btn-enviar" id="btnEnviar" disabled>
            <i class="fas fa-check-circle"></i> Confirmar Entrega
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const TOKEN = "{{ token }}";
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const btnCamera = document.getElementById('btnCamera');
        const btnEnviar = document.getElementById('btnEnviar');
        const btnRemover = document.getElementById('btnRemover');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const coordenadasInfo = document.getElementById('coordenadasInfo');
        const coordenadasTexto = document.getElementById('coordenadasTexto');
        const alertFeedback = document.getElementById('alertFeedback');

        let arquivoSelecionado = null;
        let coordenadasGPS = null;

        // Click na area de upload
        uploadArea.addEventListener('click', () => fileInput.click());

        // Botao camera
        btnCamera.addEventListener('click', () => fileInput.click());

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragging');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragging');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processarArquivo(files[0]);
            }
        });

        // Arquivo selecionado
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                processarArquivo(file);
            }
        });

        // Remover arquivo
        btnRemover.addEventListener('click', () => {
            arquivoSelecionado = null;
            fileInput.value = '';
            previewContainer.style.display = 'none';
            btnEnviar.disabled = true;
            uploadArea.style.display = 'block';
        });

        // Processar arquivo
        function processarArquivo(file) {
            // Validar tipo
            const tiposPermitidos = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            const extensoesPermitidas = ['jpg', 'jpeg', 'jfif', 'png', 'pdf'];
            const ext = file.name.split('.').pop().toLowerCase();
            if (!tiposPermitidos.includes(file.type) && !extensoesPermitidas.includes(ext)) {
                mostrarAlerta('Apenas arquivos JPG, JFIF, PNG ou PDF sao permitidos.', 'danger');
                return;
            }

            // Validar tamanho (10MB)
            if (file.size > 10 * 1024 * 1024) {
                mostrarAlerta('Arquivo muito grande. Maximo: 10MB', 'danger');
                return;
            }

            arquivoSelecionado = file;

            // Mostrar preview (apenas para imagens)
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                    uploadArea.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                // PDF - apenas mostrar nome
                previewImage.style.display = 'none';
                previewContainer.style.display = 'block';
                uploadArea.style.display = 'none';
            }

            btnEnviar.disabled = false;

            // Capturar GPS
            capturarCoordenadas();
        }

        // Capturar coordenadas GPS
        function capturarCoordenadas() {
            if ('geolocation' in navigator) {
                coordenadasInfo.style.display = 'block';
                coordenadasTexto.textContent = 'Obtendo...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        coordenadasGPS = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        coordenadasTexto.textContent = `${coordenadasGPS.latitude.toFixed(6)}, ${coordenadasGPS.longitude.toFixed(6)}`;
                        console.log('GPS capturado:', coordenadasGPS);
                    },
                    (error) => {
                        console.error('Erro ao capturar GPS:', error);
                        coordenadasTexto.textContent = 'Nao foi possivel obter localizacao';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.warn('Geolocalizacao nao suportada');
            }
        }

        // Enviar comprovante
        btnEnviar.addEventListener('click', async () => {
            if (!arquivoSelecionado) {
                mostrarAlerta('Selecione um arquivo primeiro.', 'warning');
                return;
            }

            btnEnviar.disabled = true;
            btnEnviar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Enviando...';

            try {
                const formData = new FormData();
                formData.append('canhoto', arquivoSelecionado);

                if (coordenadasGPS) {
                    formData.append('latitude', coordenadasGPS.latitude);
                    formData.append('longitude', coordenadasGPS.longitude);
                }

                const response = await fetch(`/rastreamento/api/upload_canhoto/${TOKEN}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta(data.message, 'success');
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 2000);
                } else {
                    mostrarAlerta(data.message || 'Erro ao enviar comprovante.', 'danger');
                    btnEnviar.disabled = false;
                    btnEnviar.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Entrega';
                }
            } catch (error) {
                console.error('Erro:', error);
                mostrarAlerta('Erro de conexao. Verifique sua internet e tente novamente.', 'danger');
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Entrega';
            }
        });

        function mostrarAlerta(mensagem, tipo) {
            alertFeedback.className = `alert alert-${tipo} mt-3`;
            alertFeedback.textContent = mensagem;
            alertFeedback.classList.remove('d-none');

            if (tipo === 'success') {
                setTimeout(() => {
                    alertFeedback.classList.add('d-none');
                }, 5000);
            }
        }
    </script>
</body>
</html>
