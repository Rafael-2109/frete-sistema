{% extends "base.html" %}

{% block title %}Acompanhamento de Clientes{% endblock %}

{% block content %}
<style>
    /* ChatGPT Dark Theme */
    .comercial-container {
        background-color: #202123;
        min-height: 100vh;
        margin-top: -1.5rem;
        padding-top: 2rem;
        color: #ececf1;
    }

    /* Breadcrumb Dark */
    .breadcrumb {
        background-color: #343541;
        border: 1px solid #444654;
        border-radius: 8px;
        padding: 0.75rem 1rem;
    }

    .breadcrumb-item a {
        color: #5865f2;
        text-decoration: none;
    }

    .breadcrumb-item a:hover {
        color: #7289da;
    }

    .breadcrumb-item.active {
        color: #c5c5d2;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        color: #565869;
    }

    /* Botões */
    .btn-dark-primary {
        background-color: #5865f2 !important;
        border: none;
        color: white !important;
        padding: 0.5rem 1.5rem;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .btn-dark-primary:hover {
        background-color: #4752c4 !important;
        transform: translateY(-1px);
    }

    .btn-dark-primary.active {
        background-color: #4752c4 !important;
        box-shadow: 0 2px 8px rgba(87, 101, 242, 0.3);
    }

    .btn-dark-secondary {
        background-color: transparent !important;
        border: 1px solid #444654;
        color: #c5c5d2 !important;
        padding: 0.5rem 1.5rem;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .btn-dark-secondary:hover {
        background-color: #40414f !important;
        border-color: #565869;
        color: #ececf1 !important;
    }

    .btn-dark-secondary.active {
        background-color: #40414f !important;
        border-color: #565869;
        color: #ececf1 !important;
    }

    /* Badges */
    .badge {
        padding: 0.35rem 0.65rem;
        border-radius: 6px;
        font-weight: 500;
    }

    .badge-info {
        background-color: #5865f2;
        color: white;
    }

    .badge-success {
        background-color: #43b581;
        color: white;
    }

    .badge-secondary {
        background-color: #4f545c;
        color: #c5c5d2;
    }

    .badge-warning {
        background-color: #faa61a;
        color: #202123;
    }

    .badge-primary {
        background-color: #5865f2;
        color: white;
    }

    /* Tabela Dark */
    .table-dark-custom {
        background-color: #343541;
        border: 1px solid #444654;
        border-radius: 12px;
        overflow: hidden;
    }

    .table-dark-custom table {
        margin-bottom: 0;
        background-color: #343541 !important;
    }

    .table-dark-custom thead {
        background-color: #40414f !important;
        border-bottom: 2px solid #565869;
    }

    .table-dark-custom thead th {
        background-color: #40414f !important;
        color: #c5c5d2 !important;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
        padding: 1rem;
        border: none !important;
    }

    .table-dark-custom tbody {
        background-color: #343541 !important;
    }

    .table-dark-custom tbody tr {
        background-color: #343541 !important;
        border-bottom: 1px solid #444654;
        transition: all 0.2s ease;
    }

    .table-dark-custom tbody tr:hover {
        background-color: #40414f !important;
    }

    .table-dark-custom tbody td {
        background-color: transparent !important;
        color: #ececf1 !important;
        padding: 0.75rem 1rem;
        border: none !important;
        vertical-align: middle;
    }

    /* Force dark theme on table */
    #tabelaClientes {
        background-color: #343541 !important;
        color: #ececf1 !important;
    }

    #tabelaClientes_wrapper {
        background-color: transparent !important;
    }

    .table {
        --bs-table-bg: transparent !important;
        background-color: #343541 !important;
        color: #ececf1 !important;
    }

    .table > :not(caption) > * > * {
        background-color: transparent !important;
        color: inherit !important;
        border-bottom-width: 1px;
        border-bottom-color: #444654 !important;
    }

    /* DataTable customization */
    .dataTables_wrapper {
        color: #ececf1;
    }

    .dataTables_length label,
    .dataTables_filter label {
        color: #c5c5d2;
    }

    .dataTables_length select,
    .dataTables_filter input {
        background-color: #40414f !important;
        border: 1px solid #565869 !important;
        color: #ececf1 !important;
        border-radius: 6px;
        padding: 0.375rem 0.75rem;
    }

    .dataTables_paginate .paginate_button {
        background-color: #40414f;
        border: 1px solid #444654;
        color: #c5c5d2 !important;
        border-radius: 6px;
        margin: 0 2px;
    }

    .dataTables_paginate .paginate_button:hover {
        background-color: #565869 !important;
        border-color: #565869 !important;
        color: #ececf1 !important;
    }

    .dataTables_paginate .paginate_button.current {
        background-color: #5865f2 !important;
        border-color: #5865f2 !important;
        color: white !important;
    }

    .dataTables_info {
        color: #8e8ea0;
    }

    /* Modal Dark */
    .modal-content {
        background-color: #343541;
        border: 1px solid #444654;
        color: #ececf1;
    }

    .modal-header {
        background-color: #40414f;
        border-bottom: 1px solid #565869;
    }

    .modal-footer {
        background-color: #40414f;
        border-top: 1px solid #565869;
    }

    .modal-title {
        color: #ececf1;
    }

    .btn-close {
        filter: invert(1);
    }

    /* Títulos e textos */
    h2, h4, h6 {
        color: #ececf1;
    }

    .text-muted {
        color: #8e8ea0 !important;
    }

    .text-monospace {
        font-family: 'Monaco', 'Menlo', monospace;
        color: #c5c5d2;
    }

    hr {
        border-color: #444654;
        opacity: 0.5;
    }

    /* Alertas */
    .alert-dark-info {
        background-color: #343541;
        border: 1px solid #444654;
        color: #c5c5d2;
        border-radius: 8px;
    }

    /* Valores e status */
    .text-success {
        color: #43b581 !important;
    }

    /* Ícones */
    .icon-primary { color: #7289da; }
    .icon-success { color: #43b581; }
    .icon-warning { color: #faa61a; }

    /* Botão de ação */
    .btn-action {
        background-color: #40414f;
        border: 1px solid #565869;
        color: #c5c5d2;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .btn-action:hover {
        background-color: #5865f2;
        border-color: #5865f2;
        color: white;
        transform: translateY(-1px);
    }

    /* Lista no modal */
    .list-unstyled li {
        padding: 0.25rem 0;
        color: #ececf1;
    }

    .list-group {
        background-color: #343541;
        border-radius: 8px;
    }

    .list-group-item {
        background-color: #40414f;
        border: 1px solid #444654;
        color: #ececf1;
        margin-bottom: 0.25rem;
    }

    /* Override Bootstrap table styles completely */
    .table-hover tbody tr:hover {
        background-color: #000000 !important;
        color: #ececf1 !important;
    }

    .table-hover tbody tr:hover td {
        background-color: transparent !important;
    }

    .table-striped > tbody > tr:nth-of-type(odd) {
        background-color: #343541 !important;
    }

    .table-striped > tbody > tr:nth-of-type(even) {
        background-color: #2d2e3a !important;
    }

    /* Remove any white backgrounds from Bootstrap */
    .bg-white,
    .bg-light {
        background-color: #343541 !important;
    }

    /* Fix DataTables specific backgrounds */
    div.dataTables_scrollBody {
        background-color: #343541 !important;
    }

    .dataTables_scrollHead,
    .dataTables_scrollHead table,
    .dataTables_scrollHead thead {
        background-color: #40414f !important;
    }

    .dataTables_scrollFoot,
    .dataTables_scrollFoot table,
    .dataTables_scrollFoot tfoot {
        background-color: #40414f !important;
    }

    /* Override any inline styles */
    [style*="background-color: white"],
    [style*="background-color:#fff"],
    [style*="background-color: #fff"],
    [style*="background-color:#ffffff"],
    [style*="background-color: #ffffff"] {
        background-color: #343541 !important;
    }
</style>

<div class="comercial-container">
    <div class="container-fluid">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('comercial.dashboard_diretoria') }}">
                        <i class="fas fa-home"></i> Diretoria
                    </a>
                </li>
                {% if equipe_filtro %}
                <li class="breadcrumb-item">
                    <a href="{{ url_for('comercial.vendedores_equipe', equipe_nome=equipe_filtro) }}">{{ equipe_filtro }}</a>
                </li>
                {% endif %}
                {% if vendedor_filtro %}
                <li class="breadcrumb-item active">{{ vendedor_filtro }}</li>
                {% endif %}
                <li class="breadcrumb-item active" aria-current="page">Clientes</li>
            </ol>
        </nav>

        <div class="row mb-4">
            <div class="col-12">
                <h2>
                    <i class="fas fa-building icon-success"></i> Acompanhamento de Clientes
                    {% if vendedor_filtro %}
                        - {{ vendedor_filtro }}
                    {% elif equipe_filtro %}
                        - Equipe {{ equipe_filtro }}
                    {% endif %}
                </h2>
                <hr>
            </div>
        </div>

        <!-- Filtros de Posição -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="btn-group" role="group">
                    <a href="?posicao=em_aberto{% if equipe_filtro %}&equipe={{ equipe_filtro }}{% endif %}{% if vendedor_filtro %}&vendedor={{ vendedor_filtro }}{% endif %}"
                       class="btn {% if filtro_posicao == 'em_aberto' %}btn-dark-primary active{% else %}btn-dark-secondary{% endif %}">
                        <i class="fas fa-clock"></i> Em Aberto
                    </a>
                    <a href="?posicao=todos{% if equipe_filtro %}&equipe={{ equipe_filtro }}{% endif %}{% if vendedor_filtro %}&vendedor={{ vendedor_filtro }}{% endif %}"
                       class="btn {% if filtro_posicao == 'todos' %}btn-dark-primary active{% else %}btn-dark-secondary{% endif %}">
                        <i class="fas fa-list"></i> Todos
                    </a>
                </div>

                <span class="ms-3 badge badge-info">
                    Total: {{ clientes|length }} cliente(s)
                </span>
                <span class="ms-2 badge badge-success">
                    Valor Total: R$ {{ "{:,.2f}".format(clientes|sum(attribute='valor_em_aberto')).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                </span>
            </div>
        </div>

        <!-- Tabela de Clientes -->
        <div class="row">
            <div class="col-12">
                <div class="table-responsive table-dark-custom">
                    <table class="table table-hover" id="tabelaClientes">
                        <thead>
                            <tr>
                                <th>CNPJ/CPF</th>
                                <th>Cliente</th>
                                <th>UF</th>
                                <th>Município</th>
                                <th>Vendedor</th>
                                <th>Agendamento</th>
                                <th class="text-center">Pedidos</th>
                                <th class="text-end">{% if filtro_posicao == 'em_aberto' %}Valor Em Aberto{% else %}Valor Total{% endif %}</th>
                                <th class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cliente in clientes %}
                            <tr>
                                <td>
                                    <small class="text-monospace">{{ cliente.cnpj_cpf }}</small>
                                </td>
                                <td>
                                    {% if cliente.raz_social and cliente.raz_social_red %}
                                        <span title="{{ cliente.raz_social }}">
                                            <span class="badge badge-info"></span>{{ cliente.raz_social[:30] }}{% if cliente.raz_social|length > 30 %}...{% endif %}</span>
                                            <br>
                                            <span class="badge badge-info">{{ cliente.raz_social_red }}</span>
                                        {% elif cliente.raz_social %}
                                            {{ cliente.raz_social }}
                                        {% elif cliente.raz_social_red %}
                                            {{ cliente.raz_social_red }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if cliente.estado %}
                                        <span class="badge badge-secondary">{{ cliente.estado }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cliente.municipio %}
                                        {{ cliente.municipio }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cliente.vendedor and cliente.equipe_vendas %}
                                        {{ cliente.vendedor }}
                                        <br>
                                        <span class="badge badge-info">{{ cliente.equipe_vendas }}</span>
                                    {% elif cliente.equipe_vendas %}
                                        <span class="badge badge-info">{{ cliente.equipe_vendas }}</span>
                                    {% elif cliente.vendedor %}
                                        {{ cliente.vendedor }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cliente.forma_agendamento %}
                                        <span class="badge badge-warning">{{ cliente.forma_agendamento }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <span class="badge badge-primary">{{ cliente.total_pedidos }}</span>
                                </td>
                                <td class="text-end">
                                    <strong class="{% if cliente.valor_em_aberto > 0 %}text-success{% else %}text-muted{% endif %}">
                                        R$ {{ "{:,.2f}".format(cliente.valor_em_aberto).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                    </strong>
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-action"
                                            onclick="verPedidos('{{ cliente.cnpj_cpf }}', '{{ cliente.raz_social or cliente.raz_social_red or cliente.cnpj_cpf }}')"
                                            title="Ver pedidos">
                                        <i class="fas fa-list-alt"></i> Pedidos
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% if not clientes %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-dark-info">
                    <i class="fas fa-info-circle"></i> Nenhum cliente encontrado com os filtros selecionados.
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Pedidos -->
<div class="modal fade" id="modalPedidos" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPedidosTitle">Pedidos do Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="pedidosContent" style="max-height: 70vh; overflow-y: auto;">
                <!-- Conteúdo será carregado via AJAX -->
                <div class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando pedidos...</p>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <div id="paginationInfo">
                    <!-- Info de paginação será carregada aqui -->
                </div>
                <div id="paginationControls">
                    <!-- Controles de paginação serão carregados aqui -->
                </div>
                <button type="button" class="btn btn-dark-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Variáveis globais para controle de paginação
    let currentPage = 1;
    let totalPages = 1;
    let currentCnpj = '';

    // Inicializar DataTable
    $(document).ready(function() {
        $('#tabelaClientes').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/pt-BR.json'
            },
            pageLength: 25,
            order: [[7, 'desc']], // Ordenar por valor
            columnDefs: [
                { orderable: false, targets: [8] } // Desabilitar ordenação na coluna de ações
            ]
        });
    });

    // Função para ver pedidos do cliente
    function verPedidos(cnpj, nomeCliente) {
        // Encodar CNPJ para evitar problemas com barras
        currentCnpj = encodeURIComponent(cnpj);
        currentPage = 1;

        // Atualizar título do modal
        $('#modalPedidosTitle').html(`Pedidos - ${nomeCliente}`);

        // Mostrar loading
        $('#pedidosContent').html(`
            <div class="text-center p-4">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-2">Carregando pedidos...</p>
            </div>
        `);

        // Limpar controles de paginação
        $('#paginationInfo').html('');
        $('#paginationControls').html('');

        // Abrir modal
        $('#modalPedidos').modal('show');

        // Carregar pedidos
        carregarPedidos(currentCnpj, 1);
    }

    // Função para carregar pedidos com paginação
    function carregarPedidos(cnpj, page) {
        currentPage = page;

        // cnpj já vem encodado da função verPedidos ou da paginação

        $.ajax({
            url: '/comercial/api/cliente/' + cnpj + '/pedidos',
            data: {
                posicao: '{{ filtro_posicao }}',
                page: page,
                per_page: 20
            },
            success: function(data) {
                // Atualizar info de paginação
                totalPages = data.total_pages;

                if (data.total === 0) {
                    $('#pedidosContent').html(`
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Nenhum pedido encontrado para este cliente.
                        </div>
                    `);
                    return;
                }

                // Criar tabela de pedidos
                let html = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Pedido</th>
                                    <th>Pedido Cliente</th>
                                    <th>Incoterm</th>
                                    <th>Método Entrega</th>
                                    <th>Data Pedido</th>
                                    <th>Status</th>
                                    <th class="text-end">Valor Total</th>
                                    <th class="text-end">Faturado</th>
                                    <th class="text-end">Entregue</th>
                                    <th class="text-end">Saldo Carteira</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Adicionar linhas de pedidos
                data.pedidos.forEach(function(pedido) {
                    // Determinar cor do status
                    let statusClass = '';
                    let statusIcon = '';
                    switch(pedido.status) {
                        case 'Em Aberto':
                            statusClass = 'badge-info';
                            statusIcon = 'fa-clock';
                            break;
                        case 'Parcialmente Faturado':
                            statusClass = 'badge-warning';
                            statusIcon = 'fa-tasks';
                            break;
                        case 'Parcialmente Entregue':
                            statusClass = 'badge-primary';
                            statusIcon = 'fa-truck';
                            break;
                        case 'Entregue':
                            statusClass = 'badge-success';
                            statusIcon = 'fa-check-circle';
                            break;
                        default:
                            statusClass = 'badge-secondary';
                            statusIcon = 'fa-question-circle';
                    }

                    html += `
                        <tr>
                            <td>
                                <span class="text-monospace">${pedido.num_pedido}</span>
                            </td>
                            <td>
                                ${pedido.pedido_cliente || '-'}
                            </td>
                            <td>
                                ${pedido.incoterm || '-'}
                            </td>
                            <td>
                                ${pedido.metodo_entrega_pedido || '-'}
                            </td>
                            <td>
                                ${pedido.data_pedido || '-'}
                            </td>
                            <td>
                                <span class="badge ${statusClass}">
                                    <i class="fas ${statusIcon}"></i> ${pedido.status}
                                </span>
                            </td>
                            <td class="text-end">
                                <strong>R$ ${formatarMoeda(pedido.valor_total_pedido)}</strong>
                            </td>
                            <td class="text-end ${pedido.valor_total_faturado > 0 ? 'text-warning' : ''}">
                                R$ ${formatarMoeda(pedido.valor_total_faturado)}
                            </td>
                            <td class="text-end ${pedido.valor_entregue > 0 ? 'text-success' : ''}">
                                R$ ${formatarMoeda(pedido.valor_entregue)}
                            </td>
                            <td class="text-end ${pedido.saldo_carteira > 0 ? 'text-info' : ''}">
                                R$ ${formatarMoeda(pedido.saldo_carteira)}
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                // Atualizar conteúdo
                $('#pedidosContent').html(html);

                // Atualizar info de paginação
                $('#paginationInfo').html(`
                    <span class="text-muted">
                        Mostrando ${((page - 1) * 20) + 1} a ${Math.min(page * 20, data.total)} de ${data.total} pedidos
                    </span>
                `);

                // Criar controles de paginação
                atualizarPaginacao(data.page, data.total_pages);
            },
            error: function() {
                $('#pedidosContent').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Erro ao carregar pedidos. Por favor, tente novamente.
                    </div>
                `);
            }
        });
    }

    // Função para atualizar controles de paginação
    function atualizarPaginacao(page, total_pages) {
        if (total_pages <= 1) {
            $('#paginationControls').html('');
            return;
        }

        let html = '<nav><ul class="pagination pagination-sm mb-0">';

        // Botão anterior
        html += `
            <li class="page-item ${page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="${page > 1 ? `carregarPedidos('${currentCnpj}', ${page - 1})` : 'return false;'}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;

        // Páginas
        let startPage = Math.max(1, page - 2);
        let endPage = Math.min(total_pages, page + 2);

        if (startPage > 1) {
            html += `
                <li class="page-item">
                    <a class="page-link" href="javascript:void(0)" onclick="carregarPedidos('${currentCnpj}', 1)">1</a>
                </li>
            `;
            if (startPage > 2) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `
                <li class="page-item ${i === page ? 'active' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="carregarPedidos('${currentCnpj}', ${i})">${i}</a>
                </li>
            `;
        }

        if (endPage < total_pages) {
            if (endPage < total_pages - 1) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
            html += `
                <li class="page-item">
                    <a class="page-link" href="javascript:void(0)" onclick="carregarPedidos('${currentCnpj}', ${total_pages})">${total_pages}</a>
                </li>
            `;
        }

        // Botão próximo
        html += `
            <li class="page-item ${page === total_pages ? 'disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="${page < total_pages ? `carregarPedidos('${currentCnpj}', ${page + 1})` : 'return false;'}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;

        html += '</ul></nav>';

        $('#paginationControls').html(html);
    }

    // Função auxiliar para formatar moeda
    function formatarMoeda(valor) {
        return valor.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
</script>
{% endblock %}