{% extends "base.html" %}

{% block title %}Acompanhamento de Clientes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='comercial/css/lista_clientes_responsive.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='comercial/css/cards_mobile.css') }}">
<style>
    /* Badges */
    .badge-info { background-color: var(--bs-info); color: white; }
    .badge-success { background-color: var(--bs-success); color: white; }
    .badge-secondary { background-color: var(--bs-secondary); color: white; }
    .badge-warning { background-color: var(--bs-warning); color: var(--text); }
    .badge-primary { background-color: var(--bs-primary); color: white; }

    /* Custom Table Styling */
    .table-custom {
        background: var(--bs-secondary-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 12px;
        overflow: hidden;
    }

    .table-custom table {
        margin-bottom: 0;
    }

    .table-custom thead th {
        background: var(--bs-tertiary-bg);
        color: var(--bs-secondary-color);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
        padding: 1rem;
        border-bottom: 2px solid var(--bs-border-color);
    }

    .table-custom tbody tr {
        border-bottom: 1px solid var(--bs-border-color);
        transition: all 0.2s ease;
    }

    .table-custom tbody tr:hover {
        background: var(--bs-tertiary-bg);
    }

    .table-custom tbody td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
    }

    /* DataTables Customization */
    .dataTables_wrapper {
        color: var(--bs-body-color);
    }

    .dataTables_length label,
    .dataTables_filter label {
        color: var(--bs-secondary-color);
    }

    .dataTables_length select,
    .dataTables_filter input {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color);
        color: var(--bs-body-color);
        border-radius: 6px;
        padding: 0.375rem 0.75rem;
    }

    .dataTables_paginate .paginate_button {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color);
        color: var(--bs-secondary-color) !important;
        border-radius: 6px;
        margin: 0 2px;
    }

    .dataTables_paginate .paginate_button:hover {
        background-color: var(--bs-secondary-bg) !important;
        border-color: var(--bs-border-color) !important;
        color: var(--bs-body-color) !important;
    }

    .dataTables_paginate .paginate_button.current {
        background-color: var(--bs-primary) !important;
        border-color: var(--bs-primary) !important;
        color: white !important;
    }

    .dataTables_info {
        color: var(--bs-secondary-color);
    }

    /* Modal Styling */
    .modal-content {
        background-color: var(--bs-secondary-bg);
        border: 1px solid var(--bs-border-color);
    }

    .modal-header {
        background-color: var(--bs-tertiary-bg);
        border-bottom: 1px solid var(--bs-border-color);
    }

    .modal-footer {
        background-color: var(--bs-tertiary-bg);
        border-top: 1px solid var(--bs-border-color);
    }

    /* Alert Custom */
    .alert-custom {
        background: var(--bs-secondary-bg);
        border: 1px solid var(--bs-border-color);
        color: var(--bs-secondary-color);
        border-radius: 8px;
    }

    /* Btn Action */
    .btn-action {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color);
        color: var(--bs-secondary-color);
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .btn-action:hover {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
        color: white;
        transform: translateY(-1px);
    }

    /* Card Filtros */
    .card-filtros {
        background: var(--bs-secondary-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 12px;
    }

    .card-filtros .card-header {
        background: var(--bs-tertiary-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 0.75rem 1rem;
    }

    .card-filtros .form-control,
    .card-filtros .form-select {
        background-color: var(--bs-tertiary-bg);
        border-color: var(--bs-border-color);
        color: var(--bs-body-color);
    }

    .card-filtros .form-control:focus,
    .card-filtros .form-select:focus {
        background-color: var(--bs-tertiary-bg);
        border-color: var(--bs-primary);
        color: var(--bs-body-color);
    }

    /* Text monospace */
    .text-monospace {
        font-family: 'JetBrains Mono', monospace;
        color: var(--bs-secondary-color);
    }

    /* Pedido row highlight */
    .pedido-row {
        background-color: var(--bs-tertiary-bg) !important;
    }

    .pedido-row:hover {
        background-color: var(--bs-secondary-bg) !important;
    }

    /* Expanded row styling */
    .pedido-row[style*="border-left"] {
        background-color: var(--bs-body-bg) !important;
    }

    /* Documentos accordion */
    .docs-content {
        background-color: var(--bs-body-bg);
    }

    /* Table secondary header */
    .table-secondary {
        background-color: var(--bs-tertiary-bg) !important;
    }

    .table-secondary th {
        color: var(--bs-secondary-color) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('comercial.dashboard_diretoria') }}">
                    <i class="fas fa-home"></i> Diretoria
                </a>
            </li>
            {% if equipe_filtro %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('comercial.vendedores_equipe', equipe_nome=equipe_filtro) }}">{{ equipe_filtro }}</a>
            </li>
            {% endif %}
            {% if vendedor_filtro %}
            <li class="breadcrumb-item active">{{ vendedor_filtro }}</li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">Clientes</li>
        </ol>
    </nav>

    <!-- Header da Página -->
    <header class="page-header">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">
                    <i class="fas fa-building text-success me-2"></i>
                    Acompanhamento de Clientes
                    {% if vendedor_filtro %}
                        - {{ vendedor_filtro }}
                    {% elif equipe_filtro %}
                        - Equipe {{ equipe_filtro }}
                    {% endif %}
                </h1>
                <small class="text-muted">
                    Lista de clientes e seus pedidos
                </small>
            </div>
        </div>
    </header>

    <!-- Filtros de Posição -->
    <section class="row mb-4">
        <div class="col-12">
            <div class="btn-group" role="group">
                <a href="?posicao=em_aberto{% if equipe_filtro %}&equipe={{ equipe_filtro }}{% endif %}{% if vendedor_filtro %}&vendedor={{ vendedor_filtro }}{% endif %}"
                   class="btn {% if filtro_posicao == 'em_aberto' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                    <i class="fas fa-clock"></i> Em Aberto
                </a>
                <a href="?posicao=todos{% if equipe_filtro %}&equipe={{ equipe_filtro }}{% endif %}{% if vendedor_filtro %}&vendedor={{ vendedor_filtro }}{% endif %}"
                   class="btn {% if filtro_posicao == 'todos' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                    <i class="fas fa-list"></i> Todos
                </a>
            </div>

            <span class="ms-3 badge badge-info">
                Total: {{ total_clientes }} cliente(s)
            </span>
            <span class="ms-2 badge badge-success">
                Valor Total: R$ {{ "{:,.2f}".format(valor_total).replace(',', 'X').replace('.', ',').replace('X', '.') }}
            </span>
        </div>
    </section>

    <!-- Card de Filtros Desktop -->
    <section class="row mb-4">
        <div class="col-12">
            <div class="card card-filtros" id="filtrosDesktop">
                <div class="card-header">
                    <span><i class="fas fa-filter me-1"></i> Filtros de Busca</span>
                </div>
                <div class="card-body">
                    <form id="formFiltros" method="GET" action="{{ url_for('comercial.lista_clientes') }}">
                        <!-- Manter filtros existentes como hidden -->
                        <input type="hidden" name="posicao" value="{{ filtro_posicao }}">
                        {% if equipe_filtro %}
                        <input type="hidden" name="equipe" value="{{ equipe_filtro }}">
                        {% endif %}
                        {% if vendedor_filtro %}
                        <input type="hidden" name="vendedor" value="{{ vendedor_filtro }}">
                        {% endif %}

                        <!-- Linha de Filtros Unificados -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="cnpj_cpf" class="form-label">CNPJ/CPF:</label>
                                <input type="text" class="form-control" id="cnpj_cpf" name="cnpj_cpf"
                                       value="{{ request.args.get('cnpj_cpf', '') }}"
                                       placeholder="Buscar CNPJ/CPF...">
                            </div>

                            <div class="col-md-4">
                                <label for="cliente" class="form-label">
                                    <i class="fas fa-building me-1"></i> Cliente:
                                </label>
                                <input type="text" class="form-control" id="cliente" name="cliente"
                                       value="{{ request.args.get('cliente', '') }}"
                                       placeholder="Buscar por razão social ou nome fantasia...">
                                <small class="text-muted">Busca em Razão Social e Nome Fantasia</small>
                            </div>

                            <div class="col-md-3">
                                <label for="pedido" class="form-label">
                                    <i class="fas fa-file-alt me-1"></i> Pedido:
                                </label>
                                <input type="text" class="form-control" id="pedido" name="pedido"
                                       value="{{ request.args.get('pedido', '') }}"
                                       placeholder="Número ou pedido do cliente...">
                                <small class="text-muted">Busca em Nº Pedido e Pedido Cliente</small>
                            </div>

                            <div class="col-md-2">
                                <label for="uf" class="form-label">UF:</label>
                                <select class="form-select" id="uf" name="uf">
                                    <option value="">Todas</option>
                                    {% for uf_item in ufs_disponiveis %}
                                    <option value="{{ uf_item }}" {% if request.args.get('uf') == uf_item %}selected{% endif %}>
                                        {{ uf_item }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Botões de Ação -->
                        <div class="row">
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-outline-secondary" onclick="limparFiltros()">
                                    <i class="fas fa-eraser"></i> Limpar Filtros
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                                <button type="button" class="btn btn-success" onclick="exportarExcel()">
                                    <i class="fas fa-file-excel"></i> Exportar Excel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Tabela de Clientes -->
    <section class="row">
        <div class="col-12">
            <div class="table-responsive table-custom">
                <table class="table table-hover" id="tabelaClientes">
                    <thead>
                        <tr>
                            <th>CNPJ/CPF</th>
                            <th>Cliente</th>
                            <th>UF</th>
                            <th>Município</th>
                            <th>Vendedor</th>
                            <th>Agendamento</th>
                            <th class="text-center">Pedidos</th>
                            <th class="text-end">{% if filtro_posicao == 'em_aberto' %}Valor Em Aberto{% else %}Valor Total{% endif %}</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cliente in clientes %}
                        <tr>
                            <td>
                                <small class="text-monospace">{{ cliente.cnpj_cpf }}</small>
                            </td>
                            <td>
                                {% if cliente.raz_social and cliente.raz_social_red %}
                                    <span title="{{ cliente.raz_social }}">
                                        <span class="badge badge-info"></span>{{ cliente.raz_social[:30] }}{% if cliente.raz_social|length > 30 %}...{% endif %}</span>
                                        <br>
                                        <span class="badge badge-info">{{ cliente.raz_social_red }}</span>
                                    {% elif cliente.raz_social %}
                                        {{ cliente.raz_social }}
                                    {% elif cliente.raz_social_red %}
                                        {{ cliente.raz_social_red }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                </span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if cliente.estado %}
                                    <span class="badge badge-secondary">{{ cliente.estado }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if cliente.municipio %}
                                    {{ cliente.municipio }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if cliente.vendedor and cliente.equipe_vendas %}
                                    {{ cliente.vendedor }}
                                    <br>
                                    <span class="badge badge-info">{{ cliente.equipe_vendas }}</span>
                                {% elif cliente.equipe_vendas %}
                                    <span class="badge badge-info">{{ cliente.equipe_vendas }}</span>
                                {% elif cliente.vendedor %}
                                    {{ cliente.vendedor }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if cliente.forma_agendamento %}
                                    <span class="badge badge-warning">{{ cliente.forma_agendamento }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <span class="badge badge-primary">{{ cliente.total_pedidos }}</span>
                            </td>
                            <td class="text-end">
                                <strong class="{% if cliente.valor_principal > 0 %}text-success{% else %}text-muted{% endif %}">
                                    R$ {{ "{:,.2f}".format(cliente.valor_principal).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                </strong>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-action"
                                        onclick="verPedidos('{{ cliente.cnpj_cpf }}', '{{ cliente.raz_social or cliente.raz_social_red or cliente.cnpj_cpf }}')"
                                        title="Ver pedidos">
                                    <i class="fas fa-list-alt"></i> Pedidos
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Versão Mobile: Cards de Clientes -->
    {% include 'comercial/partials/_clientes_mobile.html' %}

    {% if not clientes %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-custom">
                <i class="fas fa-info-circle"></i> Nenhum cliente encontrado com os filtros selecionados.
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Bottom Sheet de Filtros Mobile -->
{% include 'comercial/partials/_filtros_mobile.html' %}

<!-- Modal de Pedidos -->
<div class="modal fade" id="modalPedidos" tabindex="-1">
    <div class="modal-dialog modal-xl" style="max-width: 90%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPedidosTitle">Pedidos do Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="pedidosContent" style="max-height: 70vh; overflow-y: auto;">
                <!-- Conteúdo será carregado via AJAX -->
                <div class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando pedidos...</p>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <div id="paginationInfo">
                    <!-- Info de paginação será carregada aqui -->
                </div>
                <div id="paginationControls">
                    <!-- Controles de paginação serão carregados aqui -->
                </div>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Variáveis globais para controle de paginação
    let currentPage = 1;
    let totalPages = 1;
    let currentCnpj = '';

    // Inicializar DataTable
    $(document).ready(function() {
        $('#tabelaClientes').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/pt-BR.json'
            },
            pageLength: 25,
            order: [[7, 'desc']], // Ordenar por valor
            columnDefs: [
                { orderable: false, targets: [8] } // Desabilitar ordenação na coluna de ações
            ]
        });
    });

    // Função para limpar filtros
    function limparFiltros() {
        // Criar URL apenas com filtros básicos mantidos
        let url = '{{ url_for("comercial.lista_clientes") }}?posicao={{ filtro_posicao }}';
        {% if equipe_filtro %}
        url += '&equipe={{ equipe_filtro }}';
        {% endif %}
        {% if vendedor_filtro %}
        url += '&vendedor={{ vendedor_filtro }}';
        {% endif %}
        window.location.href = url;
    }

    // Função para exportar para Excel
    function exportarExcel() {
        // Capturar todos os parâmetros do filtro atual
        const params = new URLSearchParams(window.location.search);

        // Criar URL para exportação com os mesmos filtros
        const exportUrl = '{{ url_for("comercial.exportar_clientes_excel") }}?' + params.toString();

        // Abrir em nova janela para iniciar download
        window.open(exportUrl, '_blank');
    }

    // Função para ver pedidos do cliente
    function verPedidos(cnpj, nomeCliente) {
        // Encodar CNPJ para evitar problemas com barras
        currentCnpj = encodeURIComponent(cnpj);
        currentPage = 1;

        // Atualizar título do modal
        $('#modalPedidosTitle').html(`Pedidos - ${nomeCliente}`);

        // Mostrar loading
        $('#pedidosContent').html(`
            <div class="text-center p-4">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-2">Carregando pedidos...</p>
            </div>
        `);

        // Limpar controles de paginação
        $('#paginationInfo').html('');
        $('#paginationControls').html('');

        // Abrir modal
        $('#modalPedidos').modal('show');

        // Carregar pedidos
        carregarPedidos(currentCnpj, 1);
    }

    // Função para carregar pedidos com paginação
    function carregarPedidos(cnpj, page) {
        currentPage = page;

        // cnpj já vem encodado da função verPedidos ou da paginação

        const queryParams = new URLSearchParams(window.location.search);
        const requestData = {
            posicao: '{{ filtro_posicao }}',
            page: page,
            per_page: 20
        };
        ['pedido', 'num_pedido', 'pedido_cliente'].forEach(key => {
            const value = queryParams.get(key);
            if (value) {
                requestData[key] = value;
            }
        });

        $.ajax({
            url: '/comercial/api/cliente/' + cnpj + '/pedidos',
            data: requestData,
            success: function(data) {
                // Atualizar info de paginação
                totalPages = data.total_pages;

                if (data.total === 0) {
                    $('#pedidosContent').html(`
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Nenhum pedido encontrado para este cliente.
                        </div>
                    `);
                    return;
                }

                // DETECTAR SE É MOBILE E USAR RENDERIZAÇÃO APROPRIADA
                // ALTERADO: 991px para cobrir iPhones Pro Max e tablets pequenos
                if (window.innerWidth <= 991 && typeof renderizarPedidosMobile === 'function') {
                    // Renderizar cards mobile
                    renderizarPedidosMobile(data, page);
                    return;
                }

                // Criar tabela de pedidos (desktop)
                let html = `
                    <div style="overflow-x: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th width="5%"></th>
                                    <th>Pedido</th>
                                    <th>Pedido Cliente</th>
                                    <th>Incoterm</th>
                                    <th>Método Entrega</th>
                                    <th>Data Pedido</th>
                                    <th>Status</th>
                                    <th class="text-end">Valor Total</th>
                                    <th class="text-end">Faturado</th>
                                    <th class="text-end">Entregue</th>
                                    <th class="text-end">Saldo Carteira</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Adicionar linhas de pedidos
                data.pedidos.forEach(function(pedido) {
                    // Determinar cor do status
                    let statusClass = '';
                    let statusIcon = '';
                    switch(pedido.status) {
                        case 'Em Aberto':
                            statusClass = 'badge-info';
                            statusIcon = 'fa-clock';
                            break;
                        case 'Parcialmente Faturado':
                            statusClass = 'badge-warning';
                            statusIcon = 'fa-tasks';
                            break;
                        case 'Parcialmente Entregue':
                            statusClass = 'badge-primary';
                            statusIcon = 'fa-truck';
                            break;
                        case 'Entregue':
                            statusClass = 'badge-success';
                            statusIcon = 'fa-check-circle';
                            break;
                        default:
                            statusClass = 'badge-secondary';
                            statusIcon = 'fa-question-circle';
                    }

                    // ID único para o accordion
                    const pedidoId = pedido.num_pedido.replace(/[^a-zA-Z0-9]/g, '_');

                    html += `
                        <tr data-pedido="${pedido.num_pedido}" class="pedido-row">
                            <td class="text-center">
                                <button class="btn btn-sm btn-link p-0"
                                        onclick="toggleDocumentos('${pedido.num_pedido}', '${currentCnpj}')"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#docs_${pedidoId}"
                                        aria-expanded="false">
                                    <i class="fas fa-chevron-right" id="icon_${pedidoId}"></i>
                                </button>
                            </td>
                            <td>
                                <span class="text-monospace">${pedido.num_pedido}</span>
                            </td>
                            <td>
                                ${pedido.pedido_cliente || '-'}
                            </td>
                            <td>
                                ${pedido.incoterm || '-'}
                            </td>
                            <td>
                                ${pedido.metodo_entrega_pedido || '-'}
                            </td>
                            <td>
                                ${pedido.data_pedido || '-'}
                            </td>
                            <td>
                                <span class="badge ${statusClass}">
                                    <i class="fas ${statusIcon}"></i> ${pedido.status}
                                </span>
                            </td>
                            <td class="text-end">
                                <strong>R$ ${formatarMoeda(pedido.valor_total_pedido)}</strong>
                            </td>
                            <td class="text-end ${pedido.valor_total_faturado > 0 ? 'text-warning' : ''}">
                                R$ ${formatarMoeda(pedido.valor_total_faturado)}
                            </td>
                            <td class="text-end ${pedido.valor_entregue > 0 ? 'text-success' : ''}">
                                R$ ${formatarMoeda(pedido.valor_entregue)}
                            </td>
                            <td class="text-end ${pedido.saldo_carteira > 0 ? 'text-info' : ''}">
                                R$ ${formatarMoeda(pedido.saldo_carteira)}
                            </td>
                        </tr>
                        <tr>
                            <td colspan="11" class="p-0 border-0">
                                <div class="collapse" id="docs_${pedidoId}">
                                    <div class="card card-body m-2 me-3 docs-content" id="docsContent_${pedidoId}">
                                        <div class="text-center p-3">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <span class="ms-2">Carregando documentos...</span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                // Atualizar conteúdo
                $('#pedidosContent').html(html);

                // Atualizar info de paginação
                $('#paginationInfo').html(`
                    <span class="text-muted">
                        Mostrando ${((page - 1) * 20) + 1} a ${Math.min(page * 20, data.total)} de ${data.total} pedidos
                    </span>
                `);

                // Criar controles de paginação
                atualizarPaginacao(data.page, data.total_pages);
            },
            error: function() {
                $('#pedidosContent').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Erro ao carregar pedidos. Por favor, tente novamente.
                    </div>
                `);
            }
        });
    }

    // Função para atualizar controles de paginação
    function atualizarPaginacao(page, total_pages) {
        if (total_pages <= 1) {
            $('#paginationControls').html('');
            return;
        }

        let html = '<nav><ul class="pagination pagination-sm mb-0">';

        // Botão anterior
        html += `
            <li class="page-item ${page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="${page > 1 ? `carregarPedidos('${currentCnpj}', ${page - 1})` : 'return false;'}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;

        // Páginas
        let startPage = Math.max(1, page - 2);
        let endPage = Math.min(total_pages, page + 2);

        if (startPage > 1) {
            html += `
                <li class="page-item">
                    <a class="page-link" href="javascript:void(0)" onclick="carregarPedidos('${currentCnpj}', 1)">1</a>
                </li>
            `;
            if (startPage > 2) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `
                <li class="page-item ${i === page ? 'active' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="carregarPedidos('${currentCnpj}', ${i})">${i}</a>
                </li>
            `;
        }

        if (endPage < total_pages) {
            if (endPage < total_pages - 1) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
            html += `
                <li class="page-item">
                    <a class="page-link" href="javascript:void(0)" onclick="carregarPedidos('${currentCnpj}', ${total_pages})">${total_pages}</a>
                </li>
            `;
        }

        // Botão próximo
        html += `
            <li class="page-item ${page === total_pages ? 'disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="${page < total_pages ? `carregarPedidos('${currentCnpj}', ${page + 1})` : 'return false;'}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;

        html += '</ul></nav>';

        $('#paginationControls').html(html);
    }

    // Função auxiliar para formatar moeda
    function formatarMoeda(valor) {
        return valor.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Variável para controlar documentos já carregados
    let documentosCarregados = {};

    // Função para expandir/colapsar e carregar documentos
    function toggleDocumentos(numPedido, cnpj) {
        const pedidoId = numPedido.replace(/[^a-zA-Z0-9]/g, '_');
        const icon = document.getElementById(`icon_${pedidoId}`);
        const contentDiv = document.getElementById(`docsContent_${pedidoId}`);
        const pedidoRow = document.querySelector(`tr[data-pedido="${numPedido}"]`);

        // Alternar ícone e destaque da linha
        if (icon.classList.contains('fa-chevron-right')) {
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');

            // Destacar ainda mais a linha
            if (pedidoRow) {
                pedidoRow.style.borderLeft = '3px solid var(--bs-primary)';
            }

            // Carregar documentos se ainda não foram carregados
            if (!documentosCarregados[numPedido]) {
                carregarDocumentosPedido(numPedido, cnpj, pedidoId);
            }
        } else {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-right');

            // Voltar cor original da linha
            if (pedidoRow) {
                pedidoRow.style.borderLeft = 'none';
            }
        }
    }

    // Função para carregar documentos do pedido
    function carregarDocumentosPedido(numPedido, cnpj, pedidoId) {
        const contentDiv = document.getElementById(`docsContent_${pedidoId}`);

        // Decodificar CNPJ se necessário
        const cnpjDecoded = decodeURIComponent(cnpj);

        $.ajax({
            url: `/comercial/api/pedido/${encodeURIComponent(numPedido)}/documentos`,
            data: { cnpj: cnpjDecoded },
            success: function(data) {
                documentosCarregados[numPedido] = true;
                renderizarDocumentos(data, contentDiv);
            },
            error: function() {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger m-0">
                        <i class="fas fa-exclamation-circle"></i> Erro ao carregar documentos do pedido
                    </div>
                `;
            }
        });
    }

    // Função para renderizar documentos
    function renderizarDocumentos(data, contentDiv) {
        if (data.documentos.length === 0) {
            contentDiv.innerHTML = `
                <div class="alert alert-info m-0">
                    <i class="fas fa-info-circle"></i> Nenhum documento encontrado para este pedido
                </div>
            `;
            return;
        }

        let html = '<div class="table-responsive">';
        html += '<table class="table table-sm table-hover mb-0">';

        // Criar header da tabela baseado se cliente precisa agendamento
        if (data.cliente_precisa_agendamento) {
            // Com subseção de agendamento
            html += `
                <thead>
                    <tr class="table-secondary">
                        <th rowspan="2" width="3%"></th>
                        <th rowspan="2" width="7%" style="border-right: 2px solid var(--bs-border-color);">Tipo</th>
                        <th rowspan="2" class="text-end" width="12%" style="padding-right: 20px; border-right: 2px solid var(--bs-border-color);">Valor<br><small style="font-weight: normal;">Documento</small></th>
                        <th colspan="2" class="text-center" style="border-right: 2px solid var(--bs-border-color);">Faturamento</th>
                        <th colspan="2" class="text-center" style="border-right: 2px solid var(--bs-border-color);">Embarque</th>
                        <th colspan="3" class="text-center" style="border-right: 2px solid var(--bs-border-color);">Agendamento</th>
                        <th rowspan="2" class="text-center">Entrega<br><small style="font-weight: normal;">Realizada</small></th>
                    </tr>
                    <tr class="table-secondary">
                        <th width="7%">Nº NF</th>
                        <th width="10%" style="border-right: 2px solid var(--bs-border-color);">Data Fat.</th>
                        <th width="10%">Data Emb.</th>
                        <th width="15%" style="border-right: 2px solid var(--bs-border-color);">Transportadora</th>
                        <th width="10%">Data</th>
                        <th width="10%">Protocolo</th>
                        <th width="8%" style="border-right: 2px solid var(--bs-border-color);">Status</th>
                    </tr>
                </thead>
            `;
        } else {
            // Sem subseção de agendamento
            html += `
                <thead>
                    <tr class="table-secondary">
                        <th rowspan="2" width="3%"></th>
                        <th rowspan="2" width="7%" style="border-right: 2px solid var(--bs-border-color);">Tipo</th>
                        <th rowspan="2" class="text-end" width="12%" style="padding-right: 20px; border-right: 2px solid var(--bs-border-color);">Valor<br><small style="font-weight: normal;">Documento</small></th>
                        <th colspan="2" class="text-center" style="border-right: 2px solid var(--bs-border-color);">Faturamento</th>
                        <th colspan="2" class="text-center" style="border-right: 2px solid var(--bs-border-color);">Embarque</th>
                        <th rowspan="2" class="text-center" style="border-right: 2px solid var(--bs-border-color);">Entrega<br><small style="font-weight: normal;">Prevista</small></th>
                        <th rowspan="2" class="text-center">Entrega<br><small style="font-weight: normal;">Realizada</small></th>
                    </tr>
                    <tr class="table-secondary">
                        <th width="7%">Nº NF</th>
                        <th width="10%" style="border-right: 2px solid var(--bs-border-color);">Data Fat.</th>
                        <th width="10%">Data Emb.</th>
                        <th width="18%" style="border-right: 2px solid var(--bs-border-color);">Transportadora</th>
                    </tr>
                </thead>
            `;
        }

        html += '<tbody>';

        // Renderizar cada documento
        data.documentos.forEach(function(doc, index) {
            // Definir badge e cor por tipo
            let badgeClass = '';
            let badgeIcon = '';
            let tipoApi = '';
            let identificador = '';

            switch(doc.tipo) {
                case 'NF':
                    badgeClass = 'badge-success';
                    badgeIcon = 'fa-file-invoice';
                    tipoApi = 'NF';
                    identificador = doc.numero_nf;
                    break;
                case 'Separação':
                    badgeClass = 'badge-warning';
                    badgeIcon = 'fa-box-open';
                    tipoApi = 'Separacao';
                    identificador = doc.separacao_lote_id;
                    break;
                case 'Saldo':
                    badgeClass = 'badge-info';
                    badgeIcon = 'fa-calculator';
                    tipoApi = 'Saldo';
                    identificador = doc.num_pedido || data.num_pedido;
                    break;
            }

            // Criar ID único para o documento
            const docId = `${tipoApi}_${identificador}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');

            html += `<tr id="docRow_${docId}">`;

            // Coluna de expansão
            html += `<td class="text-center" style="cursor: pointer;" onclick="toggleProdutos('${docId}', '${tipoApi}', '${identificador || ''}', '${doc.num_pedido || ''}')">
                        <i class="fas fa-chevron-right" id="prodIcon_${docId}"></i>
                     </td>`;

            html += `<td style="border-right: 2px solid var(--bs-border-color);"><span class="badge ${badgeClass}"><i class="fas ${badgeIcon}"></i> ${doc.tipo}</span></td>`;

            // Valor (movido para o início)
            if (doc.valor && doc.valor !== '-') {
                html += `<td class="text-end" style="padding-right: 20px; border-right: 2px solid var(--bs-border-color);"><strong>R$ ${formatarMoeda(doc.valor)}</strong></td>`;
            } else {
                html += `<td class="text-end" style="padding-right: 20px; border-right: 2px solid var(--bs-border-color);">-</td>`;
            }

            // Faturamento
            html += `<td>${doc.numero_nf || '-'}</td>`;
            html += `<td style="border-right: 2px solid var(--bs-border-color);">${doc.data_faturamento || '-'}</td>`;

            // Embarque
            html += `<td>${doc.data_embarque || '-'}</td>`;
            html += `<td style="border-right: 2px solid var(--bs-border-color);">${doc.transportadora || '-'}</td>`;

            // Agendamento (se cliente precisar) ou Entrega Prevista
            if (data.cliente_precisa_agendamento) {
                html += `<td>${doc.data_agendamento || '-'}</td>`;
                html += `<td>${doc.protocolo_agendamento || '-'}</td>`;
                html += `<td style="border-right: 2px solid var(--bs-border-color);">${formatarStatusAgendamento(doc.status_agendamento)}</td>`;
            } else {
                html += `<td style="border-right: 2px solid var(--bs-border-color);">${doc.data_entrega_prevista || '-'}</td>`;
            }

            // Entrega Realizada
            html += `<td>${doc.data_entrega_realizada || '-'}</td>`;

            html += '</tr>';

            // Linha para produtos (inicialmente oculta)
            html += `<tr id="prodRow_${docId}" style="display: none;">`;
            html += `<td colspan="100%" style="padding: 0;">`;
            html += `<div id="prodContent_${docId}" style="padding-left: 40px; background-color: var(--bs-body-bg);">`;
            html += `<div class="text-center p-3 text-muted">`;
            html += `<i class="fas fa-spinner fa-spin"></i> Carregando produtos...`;
            html += `</div>`;
            html += `</div>`;
            html += `</td>`;
            html += `</tr>`;
        });

        html += '</tbody></table></div>';

        contentDiv.innerHTML = html;
    }

    // Função para formatar status de agendamento
    function formatarStatusAgendamento(status) {
        if (!status || status === '-') {
            return '-';
        }

        let badgeClass = '';
        let icon = '';

        switch(status.toLowerCase()) {
            case 'confirmado':
                badgeClass = 'badge-success';
                icon = 'fa-check';
                break;
            case 'aguardando':
                badgeClass = 'badge-warning';
                icon = 'fa-clock';
                break;
            default:
                badgeClass = 'badge-secondary';
                icon = 'fa-question';
        }

        return `<span class="badge ${badgeClass}"><i class="fas ${icon}"></i> ${status}</span>`;
    }

    // Cache para produtos carregados
    var produtosCarregados = {};

    // Função para alternar exibição de produtos
    function toggleProdutos(docId, tipo, identificador, numPedido) {
        const prodRow = document.getElementById(`prodRow_${docId}`);
        const icon = document.getElementById(`prodIcon_${docId}`);
        const docRow = document.getElementById(`docRow_${docId}`);

        if (prodRow.style.display === 'none') {
            // Expandir
            prodRow.style.display = '';
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');

            // Destacar linha do documento
            docRow.style.borderLeft = '3px solid var(--bs-primary)';

            // Verificar se já carregamos os produtos
            const cacheKey = `${tipo}_${identificador}`;
            if (!produtosCarregados[cacheKey]) {
                carregarProdutosDocumento(docId, tipo, identificador, numPedido);
            }
        } else {
            // Colapsar
            prodRow.style.display = 'none';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-right');

            // Remover destaque
            docRow.style.borderLeft = '';
        }
    }

    // Função para carregar produtos de um documento
    function carregarProdutosDocumento(docId, tipo, identificador, numPedido) {
        const contentDiv = document.getElementById(`prodContent_${docId}`);

        // URL da API
        let url = `/comercial/api/documento/${tipo}/${encodeURIComponent(identificador)}/produtos`;
        if (numPedido) {
            url += `?num_pedido=${encodeURIComponent(numPedido)}`;
        }

        $.ajax({
            url: url,
            type: 'GET',
            success: function(data) {
                // Guardar no cache
                const cacheKey = `${tipo}_${identificador}`;
                produtosCarregados[cacheKey] = data;

                // Renderizar produtos
                renderizarProdutos(data, contentDiv);
            },
            error: function(xhr, status, error) {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger m-3">
                        <i class="fas fa-exclamation-triangle"></i> Erro ao carregar produtos: ${error}
                    </div>
                `;
            }
        });
    }

    // Função para renderizar produtos
    function renderizarProdutos(data, contentDiv) {
        if (!data.produtos || data.produtos.length === 0) {
            contentDiv.innerHTML = `
                <div class="alert alert-info m-3">
                    <i class="fas fa-info-circle"></i> Nenhum produto encontrado para este documento
                </div>
            `;
            return;
        }

        let html = '<div class="table-responsive" style="padding: 15px;">';
        html += '<table class="table table-sm mb-3">';

        // Header da tabela de produtos
        html += `
            <thead>
                <tr class="text-muted small">
                    <th>Código</th>
                    <th>Produto</th>
                    <th class="text-end">Quantidade</th>
                    <th class="text-end">Preço</th>
                    <th class="text-end">Valor</th>
                    <th class="text-end">Peso</th>
                    <th class="text-end">Pallet</th>
                </tr>
            </thead>
            <tbody>
        `;

        // Renderizar cada produto
        data.produtos.forEach(function(prod) {
            html += '<tr class="small">';
            html += `<td class="text-primary"><small>${prod.codigo}</small></td>`;
            html += `<td><small>${prod.produto}</small></td>`;
            html += `<td class="text-end">${formatarNumero(prod.quantidade, 0)}</td>`;
            html += `<td class="text-end">R$ ${formatarMoeda(prod.preco)}</td>`;
            html += `<td class="text-end"><strong>R$ ${formatarMoeda(prod.valor)}</strong></td>`;
            html += `<td class="text-end">${prod.peso > 0 ? formatarNumero(prod.peso, 0) : '-'}</td>`;
            html += `<td class="text-end">${prod.pallet > 0 ? formatarNumero(prod.pallet, 2) : '-'}</td>`;
            html += '</tr>';
        });

        html += '</tbody></table></div>';

        contentDiv.innerHTML = html;
    }

    // Função auxiliar para formatar números
    function formatarNumero(num, casasDecimais = 0) {
        if (num === 0 || num === null || num === undefined) {
            return '-';
        }
        return num.toFixed(casasDecimais).replace('.', ',');
    }
</script>

<!-- Scripts Mobile -->
<script src="{{ url_for('static', filename='comercial/js/lista_clientes_mobile.js') }}"></script>
<script src="{{ url_for('static', filename='comercial/js/modal_pedidos_mobile.js') }}"></script>
{% endblock %}
