{% extends "base.html" %}
{% set active_page = "manufatura" %}

{% block title %}Necessidade de Produ√ß√£o{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='manufatura/necessidade_producao/css/necessidade-producao.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='manufatura/necessidade_producao/css/necessidade-producao-layout.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='manufatura/necessidade_producao/css/modal-recursos-produtivos.css') }}">
<style>
    /* For√ßar remo√ß√£o de TODOS os espa√ßos - p√°gina fullscreen */
    main, .main-content, #content, .content { padding: 0 !important; margin: 0 !important; }
    nav.navbar + .container { margin: 0 !important; padding: 0 !important; min-height: 0 !important; }
    nav.navbar + .container:not(:has(.alert)) { display: none !important; }
    .container-fluid.px-1 { margin-top: 0 !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-1 py-0 m-0">
    <!-- ========== BARRA COMPACTA (sempre vis√≠vel) ========== -->
    <div class="barra-compacta barra-compacta-success d-flex align-items-center justify-content-between gap-2">
        <!-- Esquerda: T√≠tulo + Badge -->
        <div class="d-flex align-items-center gap-2">
            <i class="fas fa-cogs"></i>
            <span class="titulo-compacto fw-semibold">Necessidade Produ√ß√£o</span>
            <span id="total-produtos" class="badge bg-light text-dark badge-compacto">0</span>
        </div>

        <!-- Centro: Filtros principais + Calcular -->
        <div class="d-flex align-items-center gap-1 flex-grow-1 justify-content-center">
            <select id="filtro-mes" class="form-select form-select-sm select-compacto">
                <option value="1">Jan</option>
                <option value="2">Fev</option>
                <option value="3">Mar</option>
                <option value="4">Abr</option>
                <option value="5">Mai</option>
                <option value="6">Jun</option>
                <option value="7">Jul</option>
                <option value="8">Ago</option>
                <option value="9">Set</option>
                <option value="10">Out</option>
                <option value="11">Nov</option>
                <option value="12">Dez</option>
            </select>
            <select id="filtro-ano" class="form-select form-select-sm select-compacto" style="width: 70px;"></select>
            <div class="autocomplete-container" style="width: 150px;">
                <input type="text" id="filtro-produto-busca" class="form-control form-control-sm input-compacto" placeholder="üîç Produto..." autocomplete="off">
                <input type="hidden" id="filtro-cod-produto">
                <div id="autocomplete-list" class="autocomplete-list"></div>
            </div>
            <button id="btn-calcular" class="btn btn-light btn-sm btn-compacto">
                <i class="fas fa-calculator"></i> Calcular
            </button>
        </div>

        <!-- Direita: Tamanho fonte + Expandir + Voltar -->
        <div class="d-flex align-items-center gap-1">
            <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-light btn-xs" data-size="very-small" onclick="mudarTamanhoFonte('very-small')" title="Muito pequeno">XS</button>
                <button class="btn btn-outline-light btn-xs" data-size="small" onclick="mudarTamanhoFonte('small')" title="Pequeno">S</button>
                <button class="btn btn-light btn-xs active" data-size="medium" onclick="mudarTamanhoFonte('medium')" title="M√©dio">M</button>
                <button class="btn btn-outline-light btn-xs" data-size="large" onclick="mudarTamanhoFonte('large')" title="Grande">L</button>
            </div>
            <button class="btn btn-sm btn-outline-light btn-compacto" type="button" data-bs-toggle="collapse" data-bs-target="#filtros-avancados" aria-expanded="false" id="btn-toggle-filtros">
                <i class="fas fa-sliders-h"></i>
            </button>
            <a href="{{ url_for('manufatura.index') }}" class="btn btn-sm btn-outline-light btn-compacto" title="Voltar">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
    </div>

    <!-- ========== FILTROS AVAN√áADOS (colaps√°vel) ========== -->
    <div class="collapse" id="filtros-avancados">
        <div class="filtros-expandidos">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <!-- Filtros adicionais -->
                <span class="text-muted small fw-bold"><i class="fas fa-filter me-1"></i>Filtros:</span>
                <select id="filtro-linha" class="form-select form-select-sm" style="width: 100px;"><option value="">Linha</option></select>
                <select id="filtro-marca" class="form-select form-select-sm" style="width: 90px;"><option value="">Marca</option></select>
                <select id="filtro-mp" class="form-select form-select-sm" style="width: 70px;"><option value="">MP</option></select>
                <select id="filtro-embalagem" class="form-select form-select-sm" style="width: 90px;"><option value="">Emb</option></select>
                <button id="btn-limpar-filtros" class="btn btn-xs btn-outline-secondary"><i class="fas fa-eraser"></i></button>

                <span class="mx-1 text-muted">|</span>

                <!-- Colunas -->
                <span class="text-muted small fw-bold"><i class="fas fa-columns me-1"></i>Colunas:</span>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-embalagem" value="embalagem" checked><label class="form-check-label" for="col-embalagem">Emb</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-mp" value="mp" checked><label class="form-check-label" for="col-mp">MP</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-marca" value="marca" checked><label class="form-check-label" for="col-marca">Marca</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-producao" value="producao" checked><label class="form-check-label" for="col-producao">Linha</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-previsao" value="previsao" checked><label class="form-check-label" for="col-previsao">Prev</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-estoque" value="estoque" checked><label class="form-check-label" for="col-estoque">Est</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-pedidos" value="pedidos" checked><label class="form-check-label" for="col-pedidos">Ped</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-saldo-demanda" value="saldo-demanda" checked><label class="form-check-label" for="col-saldo-demanda">Dem</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-carteira" value="carteira" checked><label class="form-check-label" for="col-carteira">Cart</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-ruptura" value="ruptura" checked><label class="form-check-label" for="col-ruptura">Rup</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-carteira-sem-data" value="carteira-sem-data" checked><label class="form-check-label" for="col-carteira-sem-data">S/Dt</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-saldo" value="saldo" checked><label class="form-check-label" for="col-saldo">Saldo</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-programacao" value="programacao" checked><label class="form-check-label" for="col-programacao">Prog</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-necessidade" value="necessidade" checked><label class="form-check-label" for="col-necessidade">Nec</label></div>
                <div class="form-check form-check-inline form-check-sm"><input class="form-check-input col-toggle" type="checkbox" id="col-projecao" value="projecao" checked><label class="form-check-label fw-bold" for="col-projecao">D0-D60</label></div>

                <span class="mx-1 text-muted">|</span>
                <button class="btn btn-xs btn-outline-primary" onclick="selecionarTodasColunas()"><i class="fas fa-check-double"></i></button>
                <button class="btn btn-xs btn-outline-secondary" onclick="limparSelecaoColunas()"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </div>

    <!-- ========== TABELA (maximizada - sem header) ========== -->
    <div class="card-tabela">
        <div class="table-body">
            <div class="table-container">
                <div id="loading-spinner" class="spinner-overlay d-none">
                    <div class="spinner-border text-success"></div>
                </div>

                <table class="table table-necessidade table-hover table-bordered mb-0">
                    <thead>
                        <tr id="thead-row">
                            <!-- 1. C√≥digo -->
                            <th class="sticky-col-codigo header sortable" data-field="cod_produto">
                                C√≥digo <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 2. Produto -->
                            <th class="sticky-col-produto header sortable" data-field="nome_produto">
                                Produto <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 3. Linha de Produ√ß√£o -->
                            <th class="text-center col-producao sortable" data-field="linha_producao">
                                Linha de<br>Produ√ß√£o <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 4. Marca -->
                            <th class="text-center col-marca sortable" data-field="categoria_produto">
                                Marca <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 5. Embalagem -->
                            <th class="text-center col-embalagem sortable" data-field="tipo_embalagem">
                                Embalagem <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 6. MP -->
                            <th class="text-center col-mp sortable" data-field="tipo_materia_prima">
                                MP <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 7. Estoque -->
                            <th class="text-end col-estoque sortable" data-field="estoque_atual">
                                Estoque<br>Atual <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 8. Previs√£o Vendas -->
                            <th class="text-end col-previsao sortable" data-field="previsao_vendas">
                                Previs√£o<br>Vendas <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 9. Pedidos Inseridos -->
                            <th class="text-end col-pedidos sortable" data-field="pedidos_inseridos">
                                Pedidos<br>Inseridos <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 10. Saldo Demanda (NOVO) -->
                            <th class="text-end col-saldo-demanda sortable" data-field="saldo_demanda">
                                Saldo<br>Demanda <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 11. Carteira Pedidos -->
                            <th class="text-end col-carteira sortable" data-field="carteira_pedidos">
                                Carteira<br>Pedidos <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 12. Ruptura Carteira (NOVO) -->
                            <th class="text-end col-ruptura sortable" data-field="ruptura_carteira">
                                Ruptura<br>Carteira <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 13. Carteira S/ Data (NOVO) -->
                            <th class="text-end col-carteira-sem-data sortable" data-field="carteira_sem_data">
                                Carteira<br>S/ Data <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 14. Saldo Vendas Acumulada -->
                            <th class="text-end col-saldo sortable" data-field="saldo_vendas">
                                Saldo Vendas<br>Acumulada <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 15. Programa√ß√£o Produ√ß√£o -->
                            <th class="text-end col-programacao sortable" data-field="programacao_producao">
                                Programa√ß√£o<br>Produ√ß√£o <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 16. Necessidade C/ Previs√£o -->
                            <th class="text-end col-necessidade sortable" data-field="necessidade_producao">
                                Necessidade<br>C/ Previs√£o <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <!-- 17. Proje√ß√£o D0-D60 ser√° inserida dinamicamente pelo JS -->
                            <!-- 18. A√ß√µes -->
                            <th class="text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-necessidade">
                        <tr>
                            <td colspan="100" class="text-center text-muted py-5">
                                <i class="fas fa-info-circle me-2"></i>
                                Selecione o per√≠odo e clique em "Calcular"
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Container para dropdowns (fora da table para evitar overflow) -->
<div id="dropdown-container"></div>

<!-- Incluir modais -->
{% include 'manufatura/necessidade_producao/modals/_modal-projecao.html' %}
{% include 'manufatura/necessidade_producao/modals/_modal-pedidos.html' %}
{% include 'manufatura/necessidade_producao/modals/_modal-recursos-produtivos.html' %}

<!-- Modal de Separa√ß√µes e Estoque (Reutilizado de programacao-linhas) -->
<div class="modal fade" id="modalSeparacoesProduto" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-lg-down modal-dialog-scrollable" style="max-width: 95vw;">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modal-separacoes-titulo">Separa√ß√µes e Estoque</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modal-separacoes-conteudo">
                    <div class="text-center py-3">
                        <div class="spinner-border text-success" role="status"></div>
                        <p class="mt-2">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ Modal Detalhes da Separa√ß√£o j√° est√° inclu√≠do em _modal-pedidos.html (linha 73)
     Removido daqui para evitar IDs duplicados -->

{% endblock %}

{% block scripts %}
<!-- ‚úÖ NOVO: SweetAlert2 para alertas modernos -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='manufatura/necessidade_producao/js/necessidade-producao.js') }}"></script>
<script src="{{ url_for('static', filename='manufatura/necessidade_producao/js/modals/modal-projecao.js') }}"></script>
<script src="{{ url_for('static', filename='manufatura/necessidade_producao/js/modals/modal-pedidos.js') }}"></script>
<script src="{{ url_for('static', filename='manufatura/necessidade_producao/js/modals/modal-recursos-produtivos.js') }}"></script>
<script src="{{ url_for('static', filename='manufatura/necessidade_producao/js/modal-detalhes-separacao.js') }}"></script>
{% endblock %}
