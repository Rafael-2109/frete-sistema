{% extends "base.html" %}

{% block title %}Sincronização Manual - Pedidos de Compras{% endblock %}

{% block extra_css %}
<style>
.card-header-theme {
    background-color: var(--bs-tertiary-bg) !important;
    color: var(--bs-body-color) !important;
    border-bottom: 1px solid var(--bs-border-color) !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 premium-page">

    <!-- Header -->
    <div class="row mb-4 reveal">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-sync"></i> Sincronização Manual - Pedidos e Alocações</h2>
                    <p class="text-muted">Importar pedidos de compras e alocações do Odoo por período</p>
                </div>
                <div>
                    <a href="{{ url_for('pedidos_compras.index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Principal -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">

                    <!-- Informações -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fas fa-info-circle"></i> Informações Importantes
                        </h6>
                        <ul class="mb-0">
                            <li>Sincronize pedidos e alocações de um período específico</li>
                            <li><strong>Período máximo:</strong> 90 dias</li>
                            <li>Importa <strong>pedidos</strong> (purchase.order.line) e <strong>alocações</strong> (purchase.request.allocation)</li>
                            <li>Apenas produtos com <code>detailed_type='product'</code> serão processados</li>
                            <li>Pedidos cancelados (<code>state='cancel'</code>) não serão importados</li>
                            <li>A sincronização automática ocorre a cada 30 minutos (janela de 90 minutos)</li>
                        </ul>
                    </div>

                    <!-- Formulário -->
                    <form method="POST" action="{{ url_for('pedidos_compras.executar_sincronizacao_manual') }}" id="form-sincronizacao">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="data_inicio" class="form-label">
                                        <i class="fas fa-calendar-alt"></i> Data Início
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="data_inicio" name="data_inicio"
                                           value="{{ data_inicio_padrao }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="data_fim" class="form-label">
                                        <i class="fas fa-calendar-check"></i> Data Fim
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="data_fim" name="data_fim"
                                           value="{{ data_fim_padrao }}" required>
                                </div>
                            </div>
                        </div>

                        <!-- Info do Período -->
                        <div class="alert alert-secondary" id="info-periodo" style="display: none;">
                            <strong>Período selecionado:</strong> <span id="periodo-texto"></span><br>
                            <strong>Total de dias:</strong> <span id="periodo-dias"></span>
                        </div>

                        <!-- Botões -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success" id="btn-sincronizar">
                                <i class="fas fa-sync"></i> Iniciar Sincronização
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="btn-ultimos-7-dias">
                                Últimos 7 dias
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="btn-ultimos-30-dias">
                                Últimos 30 dias
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="btn-ultimos-90-dias">
                                Últimos 90 dias
                            </button>
                        </div>
                    </form>

                    <!-- Loading State -->
                    <div id="loading-sincronizacao" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Sincronizando...</span>
                        </div>
                        <p class="mt-2 text-muted">Sincronizando pedidos e alocações com o Odoo... Aguarde.</p>
                        <small class="text-muted">Este processo pode levar alguns minutos dependendo do volume de dados.</small>
                    </div>

                </div>
            </div>

            <!-- Card de Informações Técnicas -->
            <div class="card shadow-sm mt-4">
                <div class="card-header card-header-theme">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i> O que será importado
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-shopping-cart text-primary"></i> Pedidos de Compra</h6>
                            <ul class="small">
                                <li>Modelo Odoo: <code>purchase.order.line</code></li>
                                <li>Tabela: <code>pedido_compras</code></li>
                                <li>Inclui: número, produto, quantidade, preço, fornecedor, datas</li>
                                <li>Operação: <strong>UPSERT</strong> (cria ou atualiza)</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-link text-success"></i> Alocações</h6>
                            <ul class="small">
                                <li>Modelo Odoo: <code>purchase.request.allocation</code></li>
                                <li>Tabela: <code>requisicao_compra_alocacao</code></li>
                                <li>Relaciona: requisições ↔ pedidos</li>
                                <li>Operação: <strong>UPSERT</strong> (cria ou atualiza)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card de Correção de Company ID -->
            <div class="card shadow-sm mt-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-building"></i> Correção de Empresa (Company ID)
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">
                        Corrige registros importados sem identificação de empresa, buscando no Odoo.
                    </p>

                    <!-- Status -->
                    <div id="status-company-id" class="mb-3">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <span class="text-muted">Carregando status...</span>
                    </div>

                    <!-- Botões de Correção -->
                    <div class="row g-2">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-warning w-100 btn-corrigir" data-tabela="pedidos">
                                <i class="fas fa-shopping-cart"></i> Corrigir Pedidos
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-warning w-100 btn-corrigir" data-tabela="requisicoes">
                                <i class="fas fa-clipboard-list"></i> Corrigir Requisições
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-warning w-100 btn-corrigir" data-tabela="alocacoes">
                                <i class="fas fa-link"></i> Corrigir Alocações
                            </button>
                        </div>
                    </div>

                    <!-- Resultado da Correção -->
                    <div id="resultado-correcao" class="mt-3" style="display: none;"></div>
                </div>
            </div>

            <!-- Card de Dicas -->
            <div class="card shadow-sm mt-4">
                <div class="card-header card-header-theme">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb"></i> Dicas de Uso
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-check-circle text-success"></i> Quando usar</h6>
                            <ul class="small">
                                <li>Para importar pedidos de um período específico</li>
                                <li>Quando precisar reprocessar dados</li>
                                <li>Para verificar atualizações de pedidos antigos</li>
                                <li>Após criar novas requisições manualmente</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-exclamation-triangle text-warning"></i> Atenção</h6>
                            <ul class="small">
                                <li>Não execute sincronizações simultâneas</li>
                                <li>Períodos muito longos podem demorar</li>
                                <li>O sistema já sincroniza automaticamente a cada 30 min</li>
                                <li>Alocações dependem de requisições e pedidos existentes</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dataInicio = document.getElementById('data_inicio');
    const dataFim = document.getElementById('data_fim');
    const infoPeriodo = document.getElementById('info-periodo');
    const periodoTexto = document.getElementById('periodo-texto');
    const periodoDias = document.getElementById('periodo-dias');
    const formSincronizacao = document.getElementById('form-sincronizacao');
    const loadingSincronizacao = document.getElementById('loading-sincronizacao');
    const btnSincronizar = document.getElementById('btn-sincronizar');

    // Atualizar info do período
    function atualizarInfoPeriodo() {
        if (dataInicio.value && dataFim.value) {
            const inicio = new Date(dataInicio.value + 'T00:00:00');
            const fim = new Date(dataFim.value + 'T23:59:59');
            const dias = Math.ceil((fim - inicio) / (1000 * 60 * 60 * 24));

            if (dias >= 0) {
                periodoTexto.textContent = `${inicio.toLocaleDateString('pt-BR')} até ${fim.toLocaleDateString('pt-BR')}`;
                periodoDias.textContent = `${dias} dia${dias !== 1 ? 's' : ''}`;
                infoPeriodo.style.display = 'block';

                // Validar período máximo
                if (dias > 90) {
                    periodoDias.innerHTML = `<span class="text-danger">${dias} dias (MÁXIMO: 90 dias)</span>`;
                }
            } else {
                infoPeriodo.style.display = 'none';
            }
        }
    }

    dataInicio.addEventListener('change', atualizarInfoPeriodo);
    dataFim.addEventListener('change', atualizarInfoPeriodo);

    // Botões de atalho
    document.getElementById('btn-ultimos-7-dias').addEventListener('click', function() {
        const hoje = new Date();
        const seteDiasAtras = new Date(hoje);
        seteDiasAtras.setDate(hoje.getDate() - 7);

        dataInicio.value = seteDiasAtras.toISOString().split('T')[0];
        dataFim.value = hoje.toISOString().split('T')[0];
        atualizarInfoPeriodo();
    });

    document.getElementById('btn-ultimos-30-dias').addEventListener('click', function() {
        const hoje = new Date();
        const trintaDiasAtras = new Date(hoje);
        trintaDiasAtras.setDate(hoje.getDate() - 30);

        dataInicio.value = trintaDiasAtras.toISOString().split('T')[0];
        dataFim.value = hoje.toISOString().split('T')[0];
        atualizarInfoPeriodo();
    });

    document.getElementById('btn-ultimos-90-dias').addEventListener('click', function() {
        const hoje = new Date();
        const noventaDiasAtras = new Date(hoje);
        noventaDiasAtras.setDate(hoje.getDate() - 90);

        dataInicio.value = noventaDiasAtras.toISOString().split('T')[0];
        dataFim.value = hoje.toISOString().split('T')[0];
        atualizarInfoPeriodo();
    });

    // Loading ao submeter
    formSincronizacao.addEventListener('submit', function() {
        btnSincronizar.disabled = true;
        loadingSincronizacao.style.display = 'block';
    });

    // Inicializar
    atualizarInfoPeriodo();

    // ========================================
    // CORREÇÃO DE COMPANY ID
    // ========================================

    // Carregar status inicial
    carregarStatusCompanyId();

    // Botões de correção
    document.querySelectorAll('.btn-corrigir').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const tabela = this.dataset.tabela;
            corrigirCompanyId(tabela, this);
        });
    });
});

// Carregar status de company_id
function carregarStatusCompanyId() {
    const container = document.getElementById('status-company-id');

    fetch('/manufatura/pedidos-compras/api/status-company-id')
        .then(response => response.json())
        .then(data => {
            if (data.erro) {
                container.innerHTML = `<div class="alert alert-danger py-1 mb-0">${data.erro}</div>`;
                return;
            }

            let html = '<div class="row g-2">';

            // Pedidos
            const pedidosClass = data.pedidos.sem_empresa > 0 ? 'text-danger' : 'text-success';
            html += `
                <div class="col-md-4">
                    <div class="border rounded p-2 text-center">
                        <small class="text-muted">Pedidos</small>
                        <div class="${pedidosClass}">
                            <strong>${data.pedidos.sem_empresa}</strong>/${data.pedidos.total}
                        </div>
                        <small class="text-muted">${data.pedidos.percentual_ok}% OK</small>
                    </div>
                </div>
            `;

            // Requisições
            const reqClass = data.requisicoes.sem_empresa > 0 ? 'text-danger' : 'text-success';
            html += `
                <div class="col-md-4">
                    <div class="border rounded p-2 text-center">
                        <small class="text-muted">Requisições</small>
                        <div class="${reqClass}">
                            <strong>${data.requisicoes.sem_empresa}</strong>/${data.requisicoes.total}
                        </div>
                        <small class="text-muted">${data.requisicoes.percentual_ok}% OK</small>
                    </div>
                </div>
            `;

            // Alocações
            const alocClass = data.alocacoes.sem_empresa > 0 ? 'text-danger' : 'text-success';
            html += `
                <div class="col-md-4">
                    <div class="border rounded p-2 text-center">
                        <small class="text-muted">Alocações</small>
                        <div class="${alocClass}">
                            <strong>${data.alocacoes.sem_empresa}</strong>/${data.alocacoes.total}
                        </div>
                        <small class="text-muted">${data.alocacoes.percentual_ok}% OK</small>
                    </div>
                </div>
            `;

            html += '</div>';
            container.innerHTML = html;
        })
        .catch(error => {
            container.innerHTML = `<div class="alert alert-danger py-1 mb-0">Erro: ${error.message}</div>`;
        });
}

// Corrigir company_id
function corrigirCompanyId(tabela, btn) {
    const resultadoContainer = document.getElementById('resultado-correcao');
    const originalHtml = btn.innerHTML;

    // Desabilitar botão
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Corrigindo...';

    resultadoContainer.style.display = 'block';
    resultadoContainer.innerHTML = '<div class="alert alert-info py-2">Processando... Aguarde.</div>';

    fetch('/manufatura/pedidos-compras/api/corrigir-company-id', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            tabela: tabela,
            dry_run: false,
            batch_size: 500
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.erro) {
            resultadoContainer.innerHTML = `<div class="alert alert-danger py-2">${data.erro}</div>`;
        } else {
            let msgClass = data.corrigidos > 0 ? 'success' : 'info';
            let restantes = data.restantes !== null ? ` | Restantes: ${data.restantes}` : '';
            resultadoContainer.innerHTML = `
                <div class="alert alert-${msgClass} py-2">
                    <strong>${data.tabela.toUpperCase()}:</strong>
                    ${data.corrigidos}/${data.total} corrigidos${restantes}
                </div>
            `;

            // Atualizar status
            carregarStatusCompanyId();
        }
    })
    .catch(error => {
        resultadoContainer.innerHTML = `<div class="alert alert-danger py-2">Erro: ${error.message}</div>`;
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    });
}
</script>
{% endblock %}
