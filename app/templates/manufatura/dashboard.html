{% extends "base.html" %}

{% block title %}Dashboard - Manufatura/PCP{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-3">
                <i class="fas fa-industry me-2"></i>
                Módulo de Manufatura/PCP
            </h1>
        </div>
    </div>

    <!-- Cards de Métricas -->
    <div class="row mb-4" id="metricas-cards">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Ordens Abertas
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="ordens-abertas">
                                <span class="spinner-border spinner-border-sm"></span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Necessidades Pendentes
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="necessidades-pendentes">
                                <span class="spinner-border spinner-border-sm"></span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Taxa Cumprimento
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="taxa-cumprimento">
                                <span class="spinner-border spinner-border-sm"></span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-percentage fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Ordens Concluídas/Mês
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="ordens-concluidas">
                                <span class="spinner-border spinner-border-sm"></span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu de Navegação -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Menu Principal</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('manufatura.previsao_demanda') }}" class="btn btn-outline-primary btn-block">
                                <i class="fas fa-chart-line me-2"></i>
                                Previsão de Demanda
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('manufatura.ordens_producao') }}" class="btn btn-outline-success btn-block">
                                <i class="fas fa-tasks me-2"></i>
                                Ordens de Produção
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('manufatura.requisicoes_compras') }}" class="btn btn-outline-warning btn-block">
                                <i class="fas fa-shopping-basket me-2"></i>
                                Requisições de Compras
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-outline-info btn-block" disabled>
                                <i class="fas fa-cogs me-2"></i>
                                Plano Mestre (Em breve)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabelas Resumo -->
    <div class="row">
        <!-- Ordens Abertas -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Ordens de Produção Abertas</h6>
                    <a href="{{ url_for('manufatura.ordens_producao') }}" class="btn btn-sm btn-primary">
                        Ver todas
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="tabela-ordens-abertas">
                            <thead>
                                <tr>
                                    <th>Ordem</th>
                                    <th>Produto</th>
                                    <th>Status</th>
                                    <th>Progresso</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="4" class="text-center">
                                        <span class="spinner-border spinner-border-sm"></span>
                                        Carregando...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Necessidades de Compras -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between">
                    <h6 class="m-0 font-weight-bold text-warning">Necessidades de Compras Urgentes</h6>
                    <a href="{{ url_for('manufatura.requisicoes_compras') }}" class="btn btn-sm btn-warning">
                        Ver todas
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="tabela-necessidades">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Qtd</th>
                                    <th>Necessidade</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="4" class="text-center">
                                        <span class="spinner-border spinner-border-sm"></span>
                                        Carregando...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Carregar métricas
    function carregarMetricas() {
        $.get('{{ url_for("manufatura.dashboard_metricas") }}')
            .done(function(data) {
                $('#ordens-abertas').text(data.ordens.abertas);
                $('#necessidades-pendentes').text(data.compras.necessidades_pendentes);
                $('#taxa-cumprimento').text(data.previsao.taxa_cumprimento + '%');
                $('#ordens-concluidas').text(data.ordens.concluidas_mes);
            })
            .fail(function() {
                $('.card-body .h5').text('Erro');
            });
    }

    // Carregar ordens abertas
    function carregarOrdensAbertas() {
        $.get('{{ url_for("manufatura.dashboard_ordens_abertas") }}')
            .done(function(ordens) {
                var tbody = $('#tabela-ordens-abertas tbody');
                tbody.empty();
                
                if (ordens.length === 0) {
                    tbody.append('<tr><td colspan="4" class="text-center">Nenhuma ordem aberta</td></tr>');
                    return;
                }
                
                ordens.forEach(function(ordem) {
                    var statusBadge = {
                        'Planejada': 'badge-secondary',
                        'Liberada': 'badge-info',
                        'Em Produção': 'badge-warning'
                    }[ordem.status] || 'badge-secondary';
                    
                    var tr = $('<tr>');
                    tr.append('<td>' + ordem.numero_ordem + '</td>');
                    tr.append('<td>' + ordem.cod_produto + '<br><small>' + ordem.nome_produto + '</small></td>');
                    tr.append('<td><span class="badge ' + statusBadge + '">' + ordem.status + '</span></td>');
                    tr.append('<td><div class="progress"><div class="progress-bar" style="width: ' + ordem.progresso + '%">' + ordem.progresso + '%</div></div></td>');
                    tbody.append(tr);
                });
            })
            .fail(function() {
                $('#tabela-ordens-abertas tbody').html('<tr><td colspan="4" class="text-center text-danger">Erro ao carregar</td></tr>');
            });
    }

    // Carregar necessidades
    function carregarNecessidades() {
        $.get('{{ url_for("manufatura.dashboard_necessidades") }}')
            .done(function(necessidades) {
                var tbody = $('#tabela-necessidades tbody');
                tbody.empty();
                
                if (necessidades.length === 0) {
                    tbody.append('<tr><td colspan="4" class="text-center">Nenhuma necessidade urgente</td></tr>');
                    return;
                }
                
                necessidades.forEach(function(item) {
                    var tr = $('<tr>');
                    if (item.urgente) tr.addClass('table-danger');
                    
                    tr.append('<td>' + item.cod_produto + '<br><small>' + item.nome_produto + '</small></td>');
                    tr.append('<td>' + item.qtd_necessaria.toFixed(2) + '</td>');
                    tr.append('<td>' + item.data_necessidade + '</td>');
                    tr.append('<td>' + (item.urgente ? '<span class="badge badge-danger">Urgente</span>' : '<span class="badge badge-warning">' + item.dias_restantes + ' dias</span>') + '</td>');
                    tbody.append(tr);
                });
            })
            .fail(function() {
                $('#tabela-necessidades tbody').html('<tr><td colspan="4" class="text-center text-danger">Erro ao carregar</td></tr>');
            });
    }

    // Carregar dados ao iniciar
    carregarMetricas();
    carregarOrdensAbertas();
    carregarNecessidades();
    
    // Atualizar a cada 30 segundos
    setInterval(function() {
        carregarMetricas();
        carregarOrdensAbertas();
        carregarNecessidades();
    }, 30000);
});
</script>
{% endblock %}