{% extends "base.html" %}
{% set active_page = "manufatura" %}

{% block title %}Programação por Linha{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='manufatura/programacao_linhas/css/programacao-linhas.css') }}">
<style>
/* Card header theme-aware */
.card-header-theme {
    background-color: var(--bs-tertiary-bg) !important;
    color: var(--bs-body-color) !important;
    border-bottom: 1px solid var(--bs-border-color) !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-2 premium-page">

    <!-- Cabeçalho com Filtros -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
            <h5 class="mb-0">
                <i class="fas fa-calendar-alt text-success me-2"></i>
                Programação por Linha de Produção
            </h5>
        </div>

        <!-- Filtros Inline -->
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <!-- Período -->
            <select id="filtro-mes" class="form-select form-select-sm" style="width: 110px;">
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Março</option>
                <option value="4">Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>
            <select id="filtro-ano" class="form-select form-select-sm" style="width: 80px;"></select>
            <button id="btn-carregar" class="btn btn-success btn-sm">
                <i class="fas fa-sync me-1"></i>Carregar
            </button>

            <!-- ✅ NOVO: Botão Adicionar Programação -->
            <button id="btn-adicionar-programacao" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAdicionarProgramacao">
                <i class="fas fa-plus me-1"></i>Adicionar Programação
            </button>

            <span class="mx-1 text-muted">|</span>

            <!-- ✅ TOGGLE C/ HISTÓRICO -->
            <div class="form-check form-switch d-flex align-items-center gap-2">
                <input class="form-check-input" type="checkbox" id="toggle-historico" style="cursor: pointer;">
                <label class="form-check-label" for="toggle-historico" style="cursor: pointer; font-weight: 500;">
                    C/ Histórico
                </label>
            </div>

            <span class="mx-1 text-muted">|</span>

            <!-- ✅ 3 BOTÕES DE AGRUPAMENTO -->
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="agrupamento" id="group-linha" value="linha" checked>
                <label class="btn btn-outline-primary btn-sm" for="group-linha" title="Agrupar por Linha de Produção">
                    <i class="fas fa-industry"></i> Por Linha
                </label>
                <input type="radio" class="btn-check" name="agrupamento" id="group-dia" value="dia">
                <label class="btn btn-outline-primary btn-sm" for="group-dia" title="Agrupar por Dia">
                    <i class="fas fa-calendar-day"></i> Por Dia
                </label>
                <input type="radio" class="btn-check" name="agrupamento" id="group-produto" value="produto">
                <label class="btn btn-outline-primary btn-sm" for="group-produto" title="Agrupar por Produto">
                    <i class="fas fa-boxes"></i> Por Produto
                </label>
            </div>

            <span class="mx-1 text-muted">|</span>

            <!-- ✅ FILTROS DINÂMICOS -->
            <select id="filtro-linha" class="form-select form-select-sm" style="width: 150px;">
                <option value="">Todas as linhas</option>
            </select>
            <select id="filtro-produto" class="form-select form-select-sm" style="width: 150px;">
                <option value="">Todos os produtos</option>
            </select>
            <input type="date" id="filtro-data" class="form-control form-control-sm" style="width: 140px;" placeholder="Filtrar data">

            <button id="btn-limpar-filtros" class="btn btn-outline-secondary btn-sm" title="Limpar filtros">
                <i class="fas fa-eraser"></i>
            </button>

            <span class="mx-1 text-muted">|</span>

            <button id="btn-expandir-todos" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-expand-alt me-1"></i>Expandir
            </button>
            <button id="btn-colapsar-todos" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-compress-alt me-1"></i>Colapsar
            </button>
        </div>

        <a href="{{ url_for('manufatura.index') }}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-1"></i>Voltar
        </a>
    </div>

    <!-- Card Principal -->
    <div class="card shadow">
        <div class="card-header card-header-theme d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-industry me-2"></i>
                <span id="titulo-agrupamento">Programação por Linha</span>
            </div>
            <div>
                <span id="total-programacoes" class="badge bg-success">0 programações</span>
                <span id="total-grupos" class="badge bg-primary ms-2">0 grupos</span>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="loading-spinner" class="text-center py-5 d-none">
                <div class="spinner-border text-success" role="status"></div>
                <p class="mt-2 text-muted">Carregando...</p>
            </div>

            <!-- ✅ CONTAINER ÚNICO PARA TODOS OS AGRUPAMENTOS (estilo modal) -->
            <div id="programacao-container" class="p-3">
                <div class="text-center text-muted py-5">
                    <i class="fas fa-info-circle me-2"></i>
                    Selecione o mês e clique em "Carregar"
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Modal de Separações e Estoque -->
<div class="modal fade" id="modalSeparacoesProduto" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-lg-down modal-dialog-scrollable" style="max-width: 95vw;">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modal-separacoes-titulo">Separações e Estoque</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modal-separacoes-conteudo">
                    <div class="text-center py-3">
                        <div class="spinner-border text-success" role="status"></div>
                        <p class="mt-2">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Incluir modais de pedidos (contém modalDetalhesSeparacao) -->
{% include 'manufatura/necessidade_producao/modals/_modal-pedidos.html' %}

<!-- ✅ NOVO: Modal Adicionar Programação -->
<div class="modal fade" id="modalAdicionarProgramacao" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>Adicionar Programação de Produção
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-adicionar-programacao">
                    <!-- Seleção de Produto -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="add-prog-produto-busca" class="form-label">Buscar Produto <span class="text-danger">*</span></label>
                            <div class="autocomplete-container">
                                <input type="text"
                                       id="add-prog-produto-busca"
                                       class="form-control"
                                       placeholder="Digite código ou nome do produto..."
                                       autocomplete="off"
                                       required>
                                <input type="hidden" id="add-prog-cod-produto">
                                <div id="add-prog-autocomplete-list" class="autocomplete-list"></div>
                            </div>
                            <small class="text-muted">Digite pelo menos 2 caracteres para buscar</small>
                        </div>
                        <div class="col-md-4">
                            <label for="add-prog-produto-select" class="form-label">Ou selecione</label>
                            <select id="add-prog-produto-select" class="form-select">
                                <option value="">Carregando...</option>
                            </select>
                            <small class="text-muted">Produtos comuns</small>
                        </div>
                    </div>

                    <!-- Nome do Produto Selecionado -->
                    <div id="add-prog-produto-info" class="alert alert-info d-none mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Produto:</strong> <span id="add-prog-nome-produto"></span>
                    </div>

                    <!-- Data e Linha de Produção -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="add-prog-data" class="form-label">Data de Programação <span class="text-danger">*</span></label>
                            <input type="date" id="add-prog-data" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label for="add-prog-linha" class="form-label">Linha de Produção <span class="text-danger">*</span></label>
                            <select id="add-prog-linha" class="form-select" required disabled>
                                <option value="">Selecione um produto primeiro</option>
                            </select>
                        </div>
                    </div>

                    <!-- Quantidade e Cliente -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="add-prog-quantidade" class="form-label">Quantidade <span class="text-danger">*</span></label>
                            <input type="number"
                                   id="add-prog-quantidade"
                                   class="form-control"
                                   step="0.001"
                                   min="0.001"
                                   placeholder="0.000"
                                   required>
                        </div>
                        <div class="col-md-6">
                            <label for="add-prog-cliente" class="form-label">Cliente/Marca (opcional)</label>
                            <input type="text"
                                   id="add-prog-cliente"
                                   class="form-control"
                                   placeholder="Ex: Cliente X, Marca Y"
                                   maxlength="100">
                        </div>
                    </div>

                    <!-- Observações -->
                    <div class="mb-3">
                        <label for="add-prog-observacao" class="form-label">Observações PCP (opcional)</label>
                        <textarea id="add-prog-observacao"
                                  class="form-control"
                                  rows="2"
                                  placeholder="Observações adicionais..."></textarea>
                    </div>

                    <!-- Alertas -->
                    <div id="add-prog-alert" class="alert d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" id="btn-salvar-programacao" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Salvar Programação
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- ✅ IMPORTANTE: Carregar script de necessidade_producao PRIMEIRO (tem a função CORRETA) -->
<script src="{{ url_for('static', filename='manufatura/necessidade_producao/js/necessidade-producao.js') }}"></script>
<script src="{{ url_for('static', filename='manufatura/programacao_linhas/js/programacao-linhas-agrupamentos.js') }}"></script>
<script src="{{ url_for('static', filename='manufatura/necessidade_producao/js/modal-detalhes-separacao.js') }}"></script>
<!-- ✅ NOVO: Script do modal de adicionar programação -->
<script src="{{ url_for('static', filename='manufatura/programacao_linhas/js/modal-adicionar-programacao.js') }}"></script>

<!-- ✅ Chamar popularFiltros após carregar dados -->
<script>
// ⚠️ NÃO carregar programacao-linhas.js (tem função antiga)
// Usar apenas necessidade-producao.js que tem a função COMPLETA com accordions

// Adicionar carregamento manual de dados (sem depender de programacao-linhas.js)
let programacaoState = {
    mesAtual: new Date().getMonth() + 1,
    anoAtual: new Date().getFullYear(),
    comHistorico: false,  // ✅ NOVO
    linhas: []
};

$(document).ready(function() {
    const anoAtual = new Date().getFullYear();
    const mesAtual = new Date().getMonth() + 1;

    // Preencher anos
    for (let i = -1; i <= 1; i++) {
        const ano = anoAtual + i;
        $('#filtro-ano').append($('<option></option>').val(ano).text(ano).prop('selected', i === 0));
    }

    // Selecionar mês atual
    $('#filtro-mes').val(mesAtual);

    // Eventos
    $('#btn-carregar').on('click', carregarProgramacaoLinhas);
    $('#toggle-historico').on('change', carregarProgramacaoLinhas);  // ✅ NOVO: Recarregar ao mudar toggle

    // Carregar automaticamente
    carregarProgramacaoLinhas();
});

async function carregarProgramacaoLinhas() {
    try {
        const mes = $('#filtro-mes').val();
        const ano = $('#filtro-ano').val();
        const comHistorico = $('#toggle-historico').is(':checked');  // ✅ NOVO

        programacaoState.mesAtual = parseInt(mes);
        programacaoState.anoAtual = parseInt(ano);
        programacaoState.comHistorico = comHistorico;  // ✅ NOVO: Armazenar no state

        mostrarLoading(true);

        const params = new URLSearchParams({
            mes,
            ano,
            com_historico: comHistorico  // ✅ NOVO: Enviar para backend
        });
        const response = await fetch(`/manufatura/recursos/api/programacao-linhas/dados?${params}`);

        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }

        const dados = await response.json();

        if (dados.erro) {
            throw new Error(dados.erro);
        }

        programacaoState.linhas = dados.linhas || [];

        console.log('[PROGRAMACAO] Dados recebidos:', dados);

        popularFiltros(programacaoState.linhas);
        renderizarAgrupamento();

    } catch (error) {
        console.error('[PROGRAMACAO] Erro ao carregar:', error);
        $('#programacao-container').html(`
            <div class="text-center text-danger py-5">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Erro ao carregar: ${error.message}
            </div>
        `);
    } finally {
        mostrarLoading(false);
    }
}

function mostrarLoading(mostrar) {
    if (mostrar) {
        $('#loading-spinner').removeClass('d-none');
        $('#programacao-container').addClass('d-none');
    } else {
        $('#loading-spinner').addClass('d-none');
        $('#programacao-container').removeClass('d-none');
    }
}

// ✅ Função para abrir modal (usa a CORRETA de necessidade-producao.js)
async function abrirModalSeparacoesProduto(codProduto, diaClicado) {
    try {
        console.log(`[MODAL SEPARACOES] Abrindo para produto: ${codProduto}, dia: ${diaClicado}`);

        const dataClicada = new Date(diaClicado);
        const dataInicio = new Date(dataClicada);
        dataInicio.setDate(dataInicio.getDate() - 7);
        const dataFim = new Date(dataClicada);
        dataFim.setDate(dataFim.getDate() + 7);

        const params = new URLSearchParams({
            cod_produto: codProduto,
            data_inicio: dataInicio.toISOString().split('T')[0],
            data_fim: dataFim.toISOString().split('T')[0],
            data_referencia: diaClicado
        });

        const response = await fetch(`/manufatura/recursos/api/separacoes-estoque?${params}`);
        const dados = await response.json();

        if (dados.erro) {
            throw new Error(dados.erro);
        }

        // ✅ Usar função de necessidade-producao.js (tem accordions completos)
        if (typeof renderizarModalSeparacoes === 'function') {
            renderizarModalSeparacoes(dados, codProduto, diaClicado);
        } else {
            console.error('Função renderizarModalSeparacoes não encontrada!');
            alert('Erro: Função de renderização não carregada');
            return;
        }

        const modal = new bootstrap.Modal(document.getElementById('modalSeparacoesProduto'));
        modal.show();

    } catch (error) {
        console.error('[MODAL SEPARACOES] Erro:', error);
        alert(`Erro ao carregar separações: ${error.message}`);
    }
}
</script>
{% endblock %}
