{% extends "base.html" %}
{% set active_page = "manufatura" %}

{% block title %}Análise de Produção{% endblock %}

{% block extra_css %}
<style>
/* ==========================================================================
   ANALISE PRODUCAO - Theme-aware Styles
   ========================================================================== */

.nivel-indent {
    padding-left: calc(var(--nivel) * 1.5rem);
}
.nivel-0 { --nivel: 0; }
.nivel-1 { --nivel: 1; }
.nivel-2 { --nivel: 2; }
.nivel-3 { --nivel: 3; }
.nivel-4 { --nivel: 4; }

/* Badges de tipo - Theme-aware */
.tipo-badge-INTERMEDIARIO {
    background-color: var(--mfg-purple, hsl(258 72% 66%)) !important;
    color: white !important;
}
.tipo-badge-COMPONENTE {
    background-color: var(--bs-info) !important;
    color: white !important;
}
.tipo-badge-ACABADO {
    background-color: var(--bs-success) !important;
    color: white !important;
}

/* Ajustes - Theme-aware */
.ajuste-positivo {
    color: var(--bs-success) !important;
    font-weight: bold;
}
.ajuste-negativo {
    color: var(--bs-danger) !important;
    font-weight: bold;
}

/* Dark mode - cores mais vibrantes */
[data-bs-theme="dark"] .ajuste-positivo,
[data-theme="dark"] .ajuste-positivo {
    color: var(--mfg-success-vibrant, hsl(145 72% 58%)) !important;
}
[data-bs-theme="dark"] .ajuste-negativo,
[data-theme="dark"] .ajuste-negativo {
    color: var(--mfg-danger-vibrant, hsl(0 90% 71%)) !important;
}

.input-ajuste {
    width: 100px;
    text-align: right;
}

/* Componente row - Theme-aware */
.componente-row {
    transition: background-color 0.2s;
}
.componente-row:hover {
    background-color: var(--bs-tertiary-bg) !important;
}
.componente-row.modificado {
    background-color: rgba(var(--bs-warning-rgb), 0.2) !important;
}

.tree-icon {
    color: var(--bs-secondary-color);
    margin-right: 0.5rem;
}

.modal-xl-custom {
    max-width: 95%;
}

/* Sticky header - Theme-aware */
.sticky-header {
    position: sticky;
    top: 0;
    background: var(--bs-tertiary-bg) !important;
    z-index: 10;
}

/* Table thead theme-aware */
.table-thead-theme {
    background-color: var(--bs-tertiary-bg) !important;
}
.table-thead-theme th {
    background-color: var(--bs-tertiary-bg) !important;
    color: var(--bs-body-color) !important;
    border-bottom: 2px solid var(--bs-border-color) !important;
    font-weight: 600;
}

/* Card header theme-aware */
.card-header-theme {
    background-color: var(--bs-tertiary-bg) !important;
    color: var(--bs-body-color) !important;
    border-bottom: 1px solid var(--bs-border-color) !important;
}

/* Modal headers - Keep colored but ensure visibility */
.modal-header.bg-primary,
.modal-header.bg-success {
    border-bottom: none;
}

/* Card header bg-success em modal */
.card .card-header.bg-success {
    background-color: var(--bs-success) !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4 premium-page">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 reveal">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-microscope text-primary me-2"></i>
                Análise de Produção
            </h1>
            <p class="text-muted mb-0">Analise e ajuste consumos de componentes das produções realizadas</p>
        </div>
        <a href="{{ url_for('manufatura.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Data Início</label>
                    <input type="date" name="data_inicio" class="form-control"
                           value="{{ filtros.data_inicio }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Data Fim</label>
                    <input type="date" name="data_fim" class="form-control"
                           value="{{ filtros.data_fim }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Código do Produto</label>
                    <input type="text" name="cod_produto" class="form-control"
                           value="{{ filtros.cod_produto }}" placeholder="Ex: 12345">
                </div>
                <div class="col-md-3">
                    <label class="form-label">ID Operação</label>
                    <input type="text" name="operacao_id" class="form-control"
                           value="{{ filtros.operacao_id }}" placeholder="PROD_...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                    <a href="{{ url_for('manufatura.analise_producao') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela de Produções -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Produções Realizadas
                {% if producoes %}
                <span class="badge bg-secondary ms-2">{{ producoes.total }} registro(s)</span>
                {% endif %}
            </h5>
        </div>
        <div class="card-body">
            {% if producoes and producoes.items %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-thead-theme">
                        <tr>
                            <th>ID</th>
                            <th>Data</th>
                            <th>Código</th>
                            <th>Produto</th>
                            <th class="text-end">Qtd Produzida</th>
                            <th>Local</th>
                            <th>Operação</th>
                            <th>Tipo Origem</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for prod in producoes.items %}
                        <tr>
                            <td>{{ prod.id }}</td>
                            <td>{{ prod.data_movimentacao.strftime('%d/%m/%Y') if prod.data_movimentacao else '-' }}</td>
                            <td><strong>{{ prod.cod_produto }}</strong></td>
                            <td>{{ prod.nome_produto }}</td>
                            <td class="text-end text-success fw-bold">{{ prod.qtd_movimentacao|valor_br }}</td>
                            <td>{{ prod.local_movimentacao or '-' }}</td>
                            <td>
                                {% if prod.operacao_producao_id %}
                                <span class="badge bg-info" title="{{ prod.operacao_producao_id }}">
                                    {{ prod.operacao_producao_id[:15] }}...
                                </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if prod.tipo_origem_producao %}
                                <span class="badge bg-secondary">{{ prod.tipo_origem_producao }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-primary"
                                        onclick="abrirModalComponentes({{ prod.id }})"
                                        title="Analisar Componentes">
                                    <i class="fas fa-sitemap"></i> Analisar
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginação -->
            {% if producoes.pages > 1 %}
            <nav aria-label="Paginação">
                <ul class="pagination justify-content-center mt-4">
                    {% if producoes.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('manufatura.analise_producao', page=producoes.prev_num, **filtros) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for page_num in producoes.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if page_num %}
                            {% if page_num != producoes.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('manufatura.analise_producao', page=page_num, **filtros) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {% if producoes.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('manufatura.analise_producao', page=producoes.next_num, **filtros) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nenhuma produção encontrada</h5>
                <p class="text-muted">Ajuste os filtros ou importe produções via Excel.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Análise de Componentes -->
<div class="modal fade" id="modalComponentes" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-xl-custom">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-sitemap me-2"></i>
                    Análise de Componentes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Informações da Produção -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-industry me-2"></i>Produção</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <label class="form-label text-muted small">ID</label>
                                <p class="fw-bold mb-0" id="modal-prod-id">-</p>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-muted small">Código</label>
                                <p class="fw-bold mb-0" id="modal-prod-codigo">-</p>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-muted small">Produto</label>
                                <p class="fw-bold mb-0" id="modal-prod-nome">-</p>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-muted small">Qtd Produzida</label>
                                <p class="fw-bold text-success mb-0" id="modal-prod-qtd">-</p>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-muted small">Data</label>
                                <p class="fw-bold mb-0" id="modal-prod-data">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Componentes -->
                <div class="card">
                    <div class="card-header card-header-theme">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-cubes me-2"></i>Componentes da BOM</h6>
                            <div>
                                <span class="badge bg-info me-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Preencha Ajuste ou Consumo Real - o outro será calculado automaticamente
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-sm table-hover mb-0" id="tabelaComponentes">
                                <thead class="table-thead-theme sticky-header">
                                    <tr>
                                        <th style="min-width: 250px;">Componente</th>
                                        <th class="text-center">Tipo</th>
                                        <th class="text-end">Estoque</th>
                                        <th class="text-end">Consumo Previsto</th>
                                        <th class="text-end" style="width: 120px;">Ajuste</th>
                                        <th class="text-end" style="width: 120px;">Consumo Real</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoComponentes">
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            Carregando componentes...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Fechar
                </button>
                <button type="button" class="btn btn-success" id="btnSalvarAjustes" onclick="salvarAjustes()">
                    <i class="fas fa-save me-1"></i>Salvar Ajustes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Variáveis globais
let producaoAtualId = null;
let componentesOriginais = {};

/**
 * Abre o modal e carrega os componentes da produção
 */
function abrirModalComponentes(producaoId) {
    producaoAtualId = producaoId;
    componentesOriginais = {};

    // Limpar e mostrar loading
    document.getElementById('corpoComponentes').innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-4">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Carregando componentes...
            </td>
        </tr>
    `;

    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalComponentes'));
    modal.show();

    // Carregar dados
    fetch(`/manufatura/analise-producao/${producaoId}/componentes`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                preencherModalComponentes(data);
            } else {
                Swal.fire('Erro', data.message || 'Erro ao carregar componentes', 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            Swal.fire('Erro', 'Erro de comunicação com o servidor', 'error');
        });
}

/**
 * Preenche o modal com os dados da produção e componentes
 */
function preencherModalComponentes(data) {
    const prod = data.producao;

    // Informações da produção
    document.getElementById('modal-prod-id').textContent = prod.id;
    document.getElementById('modal-prod-codigo').textContent = prod.cod_produto;
    document.getElementById('modal-prod-nome').textContent = prod.nome_produto;
    document.getElementById('modal-prod-qtd').textContent = formatarNumero(prod.qtd_produzida);
    document.getElementById('modal-prod-data').textContent = prod.data_movimentacao;

    // Componentes
    const tbody = document.getElementById('corpoComponentes');

    if (!data.componentes || data.componentes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    Este produto não possui estrutura de materiais (BOM)
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    data.componentes.forEach(comp => {
        // Guardar dados originais
        componentesOriginais[comp.cod_produto] = {
            consumo_previsto: comp.consumo_previsto,
            consumo_real: comp.consumo_real,
            ajuste_registrado: comp.ajuste_registrado
        };

        // Calcular ajuste atual (diferença entre real e previsto)
        const ajusteAtual = comp.consumo_real - comp.consumo_previsto;

        // Classes de indentação
        const nivelClass = `nivel-${Math.min(comp.nivel, 4)}`;

        // Ícone de estrutura
        const treeIcon = comp.tem_estrutura
            ? '<i class="fas fa-folder-open tree-icon"></i>'
            : '<i class="fas fa-cube tree-icon"></i>';

        // Badge do tipo
        const tipoBadgeClass = `tipo-badge-${comp.tipo}`;

        html += `
            <tr class="componente-row" data-cod="${comp.cod_produto}">
                <td>
                    <div class="nivel-indent ${nivelClass}">
                        ${treeIcon}
                        <strong>${comp.cod_produto}</strong>
                        <br>
                        <small class="text-muted">${comp.nome_produto}</small>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge ${tipoBadgeClass}">${comp.tipo}</span>
                </td>
                <td class="text-end">
                    <span class="${comp.estoque_atual < 0 ? 'text-danger' : ''}">${formatarNumero(comp.estoque_atual)}</span>
                </td>
                <td class="text-end fw-bold">${formatarNumero(comp.consumo_previsto)}</td>
                <td class="text-end">
                    <input type="number"
                           class="form-control form-control-sm input-ajuste"
                           id="ajuste-${comp.cod_produto}"
                           value="${ajusteAtual.toFixed(3)}"
                           step="0.001"
                           onchange="calcularConsumoReal('${comp.cod_produto}')"
                           onfocus="this.select()">
                </td>
                <td class="text-end">
                    <input type="number"
                           class="form-control form-control-sm input-ajuste"
                           id="consumo-real-${comp.cod_produto}"
                           value="${comp.consumo_real.toFixed(3)}"
                           step="0.001"
                           onchange="calcularAjuste('${comp.cod_produto}')"
                           onfocus="this.select()">
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

/**
 * Calcula o Consumo Real quando o Ajuste é alterado
 */
function calcularConsumoReal(codProduto) {
    const original = componentesOriginais[codProduto];
    const inputAjuste = document.getElementById(`ajuste-${codProduto}`);
    const inputConsumoReal = document.getElementById(`consumo-real-${codProduto}`);

    const ajuste = parseFloat(inputAjuste.value) || 0;
    const consumoReal = original.consumo_previsto + ajuste;

    inputConsumoReal.value = consumoReal.toFixed(3);

    // Marcar linha como modificada
    marcarLinha(codProduto, ajuste);
}

/**
 * Calcula o Ajuste quando o Consumo Real é alterado
 */
function calcularAjuste(codProduto) {
    const original = componentesOriginais[codProduto];
    const inputAjuste = document.getElementById(`ajuste-${codProduto}`);
    const inputConsumoReal = document.getElementById(`consumo-real-${codProduto}`);

    const consumoReal = parseFloat(inputConsumoReal.value) || 0;
    const ajuste = consumoReal - original.consumo_previsto;

    inputAjuste.value = ajuste.toFixed(3);

    // Marcar linha como modificada
    marcarLinha(codProduto, ajuste);
}

/**
 * Marca visualmente a linha como modificada
 */
function marcarLinha(codProduto, ajuste) {
    const original = componentesOriginais[codProduto];
    const ajusteOriginal = original.consumo_real - original.consumo_previsto;
    const row = document.querySelector(`tr[data-cod="${codProduto}"]`);
    const inputAjuste = document.getElementById(`ajuste-${codProduto}`);

    // Comparar com ajuste original (já registrado)
    const diferenca = Math.abs(ajuste - ajusteOriginal);

    if (diferenca > 0.001) {
        row.classList.add('modificado');
    } else {
        row.classList.remove('modificado');
    }

    // Colorir input de ajuste
    if (ajuste > 0.001) {
        inputAjuste.classList.add('ajuste-positivo');
        inputAjuste.classList.remove('ajuste-negativo');
    } else if (ajuste < -0.001) {
        inputAjuste.classList.add('ajuste-negativo');
        inputAjuste.classList.remove('ajuste-positivo');
    } else {
        inputAjuste.classList.remove('ajuste-positivo', 'ajuste-negativo');
    }
}

/**
 * Salva os ajustes no servidor
 */
function salvarAjustes() {
    const ajustesParaSalvar = [];

    // Coletar ajustes modificados
    Object.keys(componentesOriginais).forEach(codProduto => {
        const original = componentesOriginais[codProduto];
        const inputAjuste = document.getElementById(`ajuste-${codProduto}`);

        if (!inputAjuste) return;

        const ajusteNovo = parseFloat(inputAjuste.value) || 0;
        const ajusteOriginal = original.ajuste_registrado || 0;

        // Só salvar se houver diferença significativa
        const diferenca = ajusteNovo - ajusteOriginal;

        if (Math.abs(diferenca) > 0.001) {
            ajustesParaSalvar.push({
                cod_produto: codProduto,
                qtd_ajuste: diferenca  // Diferença a adicionar
            });
        }
    });

    if (ajustesParaSalvar.length === 0) {
        Swal.fire('Aviso', 'Nenhum ajuste para salvar', 'info');
        return;
    }

    // Confirmar
    Swal.fire({
        title: 'Confirmar Ajustes',
        html: `Serão salvos <strong>${ajustesParaSalvar.length}</strong> ajuste(s).<br><br>
               <small class="text-muted">Ajustes positivos devolvem ao estoque, negativos consomem mais.</small>`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Salvar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            executarSalvarAjustes(ajustesParaSalvar);
        }
    });
}

/**
 * Executa o salvamento dos ajustes
 */
function executarSalvarAjustes(ajustes) {
    fetch(`/manufatura/analise-producao/${producaoAtualId}/ajustar`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ ajustes: ajustes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Sucesso!',
                text: data.message,
                timer: 2000,
                showConfirmButton: false
            });

            // Recarregar componentes
            abrirModalComponentes(producaoAtualId);
        } else {
            Swal.fire('Erro', data.message || 'Erro ao salvar ajustes', 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        Swal.fire('Erro', 'Erro de comunicação com o servidor', 'error');
    });
}

/**
 * Formata número no padrão brasileiro
 */
function formatarNumero(valor) {
    if (valor === null || valor === undefined) return '-';
    return parseFloat(valor).toLocaleString('pt-BR', {
        minimumFractionDigits: 3,
        maximumFractionDigits: 3
    });
}
</script>
{% endblock %}
