{% extends "base.html" %}
{% set active_page = "manufatura" %}

{% block title %}Análise de Produção{% endblock %}

{% block extra_css %}
<style>
/* ==========================================================================
   ANALISE PRODUCAO - Theme-aware Styles
   ========================================================================== */

.nivel-indent {
    padding-left: calc(var(--nivel) * 1.5rem);
}
.nivel-0 { --nivel: 0; }
.nivel-1 { --nivel: 1; }
.nivel-2 { --nivel: 2; }
.nivel-3 { --nivel: 3; }
.nivel-4 { --nivel: 4; }

/* Badges de tipo - Theme-aware */
.tipo-badge-INTERMEDIARIO {
    background-color: var(--mfg-purple, hsl(258 72% 66%)) !important;
    color: white !important;
}
.tipo-badge-COMPONENTE {
    background-color: var(--bs-info) !important;
    color: white !important;
}
.tipo-badge-ACABADO {
    background-color: var(--bs-success) !important;
    color: white !important;
}

/* Ajustes - Theme-aware */
.ajuste-positivo {
    color: var(--bs-success) !important;
    font-weight: bold;
}
.ajuste-negativo {
    color: var(--bs-danger) !important;
    font-weight: bold;
}

/* Dark mode - cores mais vibrantes */
[data-bs-theme="dark"] .ajuste-positivo,
[data-theme="dark"] .ajuste-positivo {
    color: var(--mfg-success-vibrant, hsl(145 72% 58%)) !important;
}
[data-bs-theme="dark"] .ajuste-negativo,
[data-theme="dark"] .ajuste-negativo {
    color: var(--mfg-danger-vibrant, hsl(0 90% 71%)) !important;
}

.input-ajuste {
    width: 100px;
    text-align: right;
}

/* Componente row - Theme-aware */
.componente-row {
    transition: background-color 0.2s;
}
.componente-row:hover {
    background-color: var(--bs-tertiary-bg) !important;
}
.componente-row.modificado {
    background-color: rgba(var(--bs-warning-rgb), 0.2) !important;
}

.tree-icon {
    color: var(--bs-secondary-color);
    margin-right: 0.5rem;
}

.modal-xl-custom {
    max-width: 95%;
}

/* Sticky header - Theme-aware */
.sticky-header {
    position: sticky;
    top: 0;
    background: var(--bs-tertiary-bg) !important;
    z-index: 10;
}

/* Table thead theme-aware */
.table-thead-theme {
    background-color: var(--bs-tertiary-bg) !important;
}
.table-thead-theme th {
    background-color: var(--bs-tertiary-bg) !important;
    color: var(--bs-body-color) !important;
    border-bottom: 2px solid var(--bs-border-color) !important;
    font-weight: 600;
}

/* Card header theme-aware */
.card-header-theme {
    background-color: var(--bs-tertiary-bg) !important;
    color: var(--bs-body-color) !important;
    border-bottom: 1px solid var(--bs-border-color) !important;
}

/* Modal headers - Keep colored but ensure visibility */
.modal-header.bg-primary,
.modal-header.bg-success {
    border-bottom: none;
}

/* Card header bg-success em modal */
.card .card-header.bg-success {
    background-color: var(--bs-success) !important;
}

/* Linha agrupada */
.row-grupo {
    cursor: pointer;
    background-color: rgba(var(--bs-primary-rgb), 0.05) !important;
}
.row-grupo:hover {
    background-color: rgba(var(--bs-primary-rgb), 0.12) !important;
}
.row-grupo .chevron-icon {
    transition: transform 0.2s;
}
.row-grupo.expanded .chevron-icon {
    transform: rotate(90deg);
}

/* Sub-linhas (expandidas) */
.row-subitem {
    background-color: rgba(var(--bs-secondary-rgb), 0.05) !important;
    font-size: 0.85rem;
}
.row-subitem td {
    vertical-align: middle;
}

/* Badge de contagem */
.badge-producoes {
    font-size: 0.7rem;
    vertical-align: middle;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4 premium-page">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 reveal">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-microscope text-primary me-2"></i>
                Análise de Produção
            </h1>
            <p class="text-muted mb-0">Analise e ajuste consumos de componentes das produções realizadas</p>
        </div>
        <a href="{{ url_for('manufatura.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Data Início</label>
                    <input type="date" name="data_inicio" class="form-control"
                           value="{{ filtros.data_inicio }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Data Fim</label>
                    <input type="date" name="data_fim" class="form-control"
                           value="{{ filtros.data_fim }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Código Produto</label>
                    <input type="text" name="cod_produto" class="form-control"
                           value="{{ filtros.cod_produto }}" placeholder="Ex: 12345">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Nome Produto</label>
                    <input type="text" name="nome_produto" class="form-control"
                           value="{{ filtros.nome_produto }}" placeholder="Nome...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Ordem Produção</label>
                    <input type="text" name="ordem_producao" class="form-control"
                           value="{{ filtros.ordem_producao }}" placeholder="OP-...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Local / Linha</label>
                    <input type="text" name="local_movimentacao" class="form-control"
                           value="{{ filtros.local_movimentacao }}" placeholder="Linha...">
                </div>
                <div class="col-12 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                    <a href="{{ url_for('manufatura.analise_producao') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Limpar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela de Produções -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Produções Realizadas
                {% if producoes %}
                <span class="badge bg-secondary ms-2">{{ producoes.total }} registro(s)</span>
                {% endif %}
            </h5>
        </div>
        <div class="card-body">
            {% if producoes and producoes.items %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-thead-theme">
                        <tr>
                            <th style="width: 30px;"></th>
                            <th>Data</th>
                            <th>Código</th>
                            <th>Produto</th>
                            <th class="text-end">Qtd Produzida</th>
                            <th>Local</th>
                            <th>Ordem Produção</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in producoes.items %}
                        {% if item.tipo_item == 'grupo' %}
                        {# ===== LINHA AGRUPADA ===== #}
                        <tr class="row-grupo" id="grupo-{{ item.ordem_producao }}-{{ item.cod_produto }}"
                            onclick="toggleGrupo('{{ item.ordem_producao }}', '{{ item.cod_produto }}')">
                            <td class="text-center">
                                <i class="fas fa-chevron-right chevron-icon"></i>
                            </td>
                            <td>{{ item.ultima_data.strftime('%d/%m/%Y') if item.ultima_data else '-' }}</td>
                            <td><strong>{{ item.cod_produto }}</strong></td>
                            <td>
                                {{ item.nome_produto }}
                                <span class="badge bg-primary badge-producoes ms-1">
                                    {{ item.qtd_producoes }} prod.
                                </span>
                            </td>
                            <td class="text-end text-success fw-bold">{{ item.qtd_total|valor_br }}</td>
                            <td>{{ item.local_movimentacao or '-' }}</td>
                            <td>
                                <span class="badge bg-primary">{{ item.ordem_producao }}</span>
                            </td>
                            <td class="text-center" onclick="event.stopPropagation();">
                                <button type="button" class="btn btn-sm btn-primary"
                                        onclick="abrirModalComponentesGrupo('{{ item.ordem_producao }}', '{{ item.cod_produto }}')"
                                        title="Analisar Componentes do Grupo">
                                    <i class="fas fa-sitemap"></i> Analisar
                                </button>
                            </td>
                        </tr>
                        {# Sub-linhas são inseridas diretamente no tbody via JS (toggleGrupo) #}

                        {% else %}
                        {# ===== LINHA INDIVIDUAL (sem OP) ===== #}
                        <tr>
                            <td></td>
                            <td>{{ item.ultima_data.strftime('%d/%m/%Y') if item.ultima_data else '-' }}</td>
                            <td><strong>{{ item.cod_produto }}</strong></td>
                            <td>{{ item.nome_produto }}</td>
                            <td class="text-end text-success fw-bold">{{ item.qtd_total|valor_br }}</td>
                            <td>{{ item.local_movimentacao or '-' }}</td>
                            <td>
                                <span class="text-muted">-</span>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-primary"
                                        onclick="abrirModalComponentes({{ item.id }})"
                                        title="Analisar Componentes">
                                    <i class="fas fa-sitemap"></i> Analisar
                                </button>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginação -->
            {% if producoes.pages > 1 %}
            <nav aria-label="Paginação">
                <ul class="pagination justify-content-center mt-4">
                    {% if producoes.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('manufatura.analise_producao', page=producoes.prev_num, **filtros) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {# Páginas numeradas simples #}
                    {% set start_page = [1, producoes.page - 2]|max %}
                    {% set end_page = [producoes.pages, producoes.page + 2]|min %}

                    {% if start_page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('manufatura.analise_producao', page=1, **filtros) }}">1</a>
                    </li>
                    {% if start_page > 2 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                    {% endif %}

                    {% for page_num in range(start_page, end_page + 1) %}
                        {% if page_num != producoes.page %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('manufatura.analise_producao', page=page_num, **filtros) }}">
                                {{ page_num }}
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {% if end_page < producoes.pages %}
                    {% if end_page < producoes.pages - 1 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('manufatura.analise_producao', page=producoes.pages, **filtros) }}">{{ producoes.pages }}</a>
                    </li>
                    {% endif %}

                    {% if producoes.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('manufatura.analise_producao', page=producoes.next_num, **filtros) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nenhuma produção encontrada</h5>
                <p class="text-muted">Ajuste os filtros ou importe produções via Excel.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Análise de Componentes -->
<div class="modal fade" id="modalComponentes" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-xl-custom">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-sitemap me-2"></i>
                    Análise de Componentes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Informações da Produção -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-industry me-2"></i>Produção</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <label class="form-label text-muted small">ID</label>
                                <p class="fw-bold mb-0" id="modal-prod-id">-</p>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-muted small">Código</label>
                                <p class="fw-bold mb-0" id="modal-prod-codigo">-</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted small">Produto</label>
                                <p class="fw-bold mb-0" id="modal-prod-nome">-</p>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-muted small">Qtd Produzida</label>
                                <p class="fw-bold text-success mb-0" id="modal-prod-qtd">-</p>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label text-muted small">Data</label>
                                <p class="fw-bold mb-0" id="modal-prod-data">-</p>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-muted small">Ordem Produção</label>
                                <p class="fw-bold mb-0" id="modal-prod-op">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Componentes -->
                <div class="card">
                    <div class="card-header card-header-theme">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-cubes me-2"></i>Componentes da BOM</h6>
                            <div>
                                <span class="badge bg-info me-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Preencha Ajuste ou Consumo Real - o outro será calculado automaticamente
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-sm table-hover mb-0" id="tabelaComponentes">
                                <thead class="table-thead-theme sticky-header">
                                    <tr>
                                        <th style="min-width: 250px;">Componente</th>
                                        <th class="text-center">Tipo</th>
                                        <th class="text-end">Estoque</th>
                                        <th class="text-end">Consumo Previsto</th>
                                        <th class="text-end" style="width: 120px;">Ajuste</th>
                                        <th class="text-end" style="width: 120px;">Consumo Real</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoComponentes">
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            Carregando componentes...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Fechar
                </button>
                <button type="button" class="btn btn-success" id="btnSalvarAjustes" onclick="salvarAjustes()">
                    <i class="fas fa-save me-1"></i>Salvar Ajustes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Variáveis globais
let producaoAtualId = null;
let producaoAtualGrupo = null; // {ordem_producao, cod_produto} se for grupo
let componentesOriginais = {};

// ========================================
// EXPANSÃO DE GRUPOS
// ========================================

function toggleGrupo(ordemProducao, codProduto) {
    const grupoId = `${ordemProducao}-${codProduto}`;
    const rowGrupo = document.getElementById(`grupo-${grupoId}`);
    // Usar data-attribute para selecionar sub-linhas (seguro contra chars especiais)
    const seletor = `tr[data-grupo-id="${grupoId}"]`;

    if (rowGrupo.classList.contains('expanded')) {
        // Fechar: ocultar sub-linhas
        rowGrupo.classList.remove('expanded');
        document.querySelectorAll(seletor).forEach(tr => {
            tr.style.display = 'none';
        });
        return;
    }

    // Abrir
    rowGrupo.classList.add('expanded');

    // Se já tem sub-linhas no DOM (cache), apenas exibir
    const existentes = document.querySelectorAll(seletor);
    if (existentes.length > 0) {
        existentes.forEach(tr => {
            tr.style.display = '';
        });
        return;
    }

    // Loading: inserir TR de loading após a linha do grupo
    const loadingTr = document.createElement('tr');
    loadingTr.className = 'row-subitem loading-row';
    loadingTr.setAttribute('data-grupo-id', grupoId);
    loadingTr.innerHTML = `<td colspan="8" class="text-center py-2">
        <i class="fas fa-spinner fa-spin me-2"></i> Carregando...
    </td>`;
    rowGrupo.after(loadingTr);

    fetch(`/manufatura/analise-producao/grupo-detalhe?ordem_producao=${encodeURIComponent(ordemProducao)}&cod_produto=${encodeURIComponent(codProduto)}`)
        .then(response => response.json())
        .then(data => {
            // Remover loading
            loadingTr.remove();

            if (!data.success || !data.producoes || data.producoes.length === 0) {
                const emptyTr = document.createElement('tr');
                emptyTr.className = 'row-subitem';
                emptyTr.setAttribute('data-grupo-id', grupoId);
                emptyTr.innerHTML = '<td colspan="8" class="text-center text-muted py-2">Nenhuma produção encontrada</td>';
                rowGrupo.after(emptyTr);
                return;
            }

            // Inserir sub-linhas após a linha do grupo
            const fragment = document.createDocumentFragment();
            data.producoes.forEach(prod => {
                const tr = document.createElement('tr');
                tr.className = 'row-subitem';
                tr.setAttribute('data-grupo-id', grupoId);
                tr.innerHTML = `
                    <td>
                        <small class="text-muted" style="padding-left: 1.5rem;"><i class="fas fa-arrow-right me-1"></i>#${prod.id}</small>
                    </td>
                    <td>${prod.data_movimentacao}</td>
                    <td>${prod.cod_produto}</td>
                    <td>${prod.nome_produto}</td>
                    <td class="text-end text-success fw-bold">${parseFloat(prod.qtd_movimentacao).toLocaleString('pt-BR', {minimumFractionDigits: 3})}</td>
                    <td>${prod.local_movimentacao}</td>
                    <td>-</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-primary"
                                onclick="abrirModalComponentes(${prod.id})"
                                title="Analisar esta produção individual">
                            <i class="fas fa-sitemap"></i>
                        </button>
                    </td>
                `;
                fragment.appendChild(tr);
            });

            // Inserir todas as linhas de uma vez após o grupo
            rowGrupo.after(fragment);
        })
        .catch(error => {
            console.error('Erro:', error);
            loadingTr.remove();
            const errorTr = document.createElement('tr');
            errorTr.className = 'row-subitem';
            errorTr.setAttribute('data-grupo-id', grupoId);
            errorTr.innerHTML = '<td colspan="8" class="text-center text-danger py-2">Erro ao carregar dados</td>';
            rowGrupo.after(errorTr);
        });
}

// ========================================
// MODAL DE COMPONENTES (INDIVIDUAL)
// ========================================

function abrirModalComponentes(producaoId) {
    producaoAtualId = producaoId;
    producaoAtualGrupo = null;
    componentesOriginais = {};

    // Limpar e mostrar loading
    document.getElementById('corpoComponentes').innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-4">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Carregando componentes...
            </td>
        </tr>
    `;

    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalComponentes'));
    modal.show();

    // Carregar dados
    fetch(`/manufatura/analise-producao/${producaoId}/componentes`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                preencherModalComponentes(data);
            } else {
                Swal.fire('Erro', data.message || 'Erro ao carregar componentes', 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            Swal.fire('Erro', 'Erro de comunicação com o servidor', 'error');
        });
}

// ========================================
// MODAL DE COMPONENTES (GRUPO)
// ========================================

function abrirModalComponentesGrupo(ordemProducao, codProduto) {
    producaoAtualId = null;
    producaoAtualGrupo = { ordem_producao: ordemProducao, cod_produto: codProduto };
    componentesOriginais = {};

    // Limpar e mostrar loading
    document.getElementById('corpoComponentes').innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-4">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Carregando componentes do grupo...
            </td>
        </tr>
    `;

    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalComponentes'));
    modal.show();

    // Carregar dados do grupo
    fetch(`/manufatura/analise-producao/componentes-grupo?ordem_producao=${encodeURIComponent(ordemProducao)}&cod_produto=${encodeURIComponent(codProduto)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                preencherModalComponentes(data);
            } else {
                Swal.fire('Erro', data.message || 'Erro ao carregar componentes do grupo', 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            Swal.fire('Erro', 'Erro de comunicação com o servidor', 'error');
        });
}

// ========================================
// PREENCHER MODAL (REUSÁVEL)
// ========================================

function preencherModalComponentes(data) {
    const prod = data.producao;

    // Informações da produção
    document.getElementById('modal-prod-id').textContent = prod.id;
    document.getElementById('modal-prod-codigo').textContent = prod.cod_produto;
    document.getElementById('modal-prod-nome').textContent = prod.nome_produto;
    document.getElementById('modal-prod-qtd').textContent = formatarNumero(prod.qtd_produzida);
    document.getElementById('modal-prod-data').textContent = prod.data_movimentacao;

    // Ordem de Produção
    const opElement = document.getElementById('modal-prod-op');
    if (prod.ordem_producao) {
        opElement.innerHTML = `<span class="badge bg-primary">${prod.ordem_producao}</span>`;
        if (prod.qtd_producoes && prod.qtd_producoes > 1) {
            opElement.innerHTML += ` <span class="badge bg-secondary">${prod.qtd_producoes} produções</span>`;
        }
    } else {
        opElement.textContent = '-';
    }

    // Componentes
    const tbody = document.getElementById('corpoComponentes');

    if (!data.componentes || data.componentes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    Este produto não possui estrutura de materiais (BOM)
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    data.componentes.forEach(comp => {
        // Guardar dados originais
        componentesOriginais[comp.cod_produto] = {
            consumo_previsto: comp.consumo_previsto,
            consumo_real: comp.consumo_real,
            ajuste_registrado: comp.ajuste_registrado
        };

        // Calcular ajuste atual (diferença entre real e previsto)
        // Invertido: negativo = consumiu mais, positivo = consumiu menos
        const ajusteAtual = -(comp.consumo_real - comp.consumo_previsto);

        // Classes de indentação
        const nivelClass = `nivel-${Math.min(comp.nivel, 4)}`;

        // Ícone de estrutura
        const treeIcon = comp.tem_estrutura
            ? '<i class="fas fa-folder-open tree-icon"></i>'
            : '<i class="fas fa-cube tree-icon"></i>';

        // Badge do tipo
        const tipoBadgeClass = `tipo-badge-${comp.tipo}`;

        html += `
            <tr class="componente-row" data-cod="${comp.cod_produto}">
                <td>
                    <div class="nivel-indent ${nivelClass}">
                        ${treeIcon}
                        <strong>${comp.cod_produto}</strong>
                        <br>
                        <small class="text-muted">${comp.nome_produto}</small>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge ${tipoBadgeClass}">${comp.tipo}</span>
                </td>
                <td class="text-end">
                    <span class="${comp.estoque_atual < 0 ? 'text-danger' : ''}">${formatarNumero(comp.estoque_atual)}</span>
                </td>
                <td class="text-end fw-bold">${formatarNumero(-comp.consumo_previsto)}</td>
                <td class="text-end">
                    <input type="number"
                           class="form-control form-control-sm input-ajuste"
                           id="ajuste-${comp.cod_produto}"
                           value="${ajusteAtual.toFixed(3)}"
                           step="0.001"
                           onchange="calcularConsumoReal('${comp.cod_produto}')"
                           onfocus="this.select()">
                </td>
                <td class="text-end">
                    <input type="number"
                           class="form-control form-control-sm input-ajuste"
                           id="consumo-real-${comp.cod_produto}"
                           value="${(-comp.consumo_real).toFixed(3)}"
                           step="0.001"
                           onchange="calcularAjuste('${comp.cod_produto}')"
                           onfocus="this.select()">
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

// ========================================
// CÁLCULOS DE AJUSTE
// ========================================

function calcularConsumoReal(codProduto) {
    const original = componentesOriginais[codProduto];
    const inputAjuste = document.getElementById(`ajuste-${codProduto}`);
    const inputConsumoReal = document.getElementById(`consumo-real-${codProduto}`);

    const ajuste = parseFloat(inputAjuste.value) || 0;
    // Consumo real = -previsto + ajuste (ambos negativos quando consumiu)
    const consumoReal = -original.consumo_previsto + ajuste;

    inputConsumoReal.value = consumoReal.toFixed(3);
    marcarLinha(codProduto, ajuste);
}

function calcularAjuste(codProduto) {
    const original = componentesOriginais[codProduto];
    const inputAjuste = document.getElementById(`ajuste-${codProduto}`);
    const inputConsumoReal = document.getElementById(`consumo-real-${codProduto}`);

    const consumoReal = parseFloat(inputConsumoReal.value) || 0;
    // Ajuste = consumoReal - (-previsto) = consumoReal + previsto
    const ajuste = consumoReal + original.consumo_previsto;

    inputAjuste.value = ajuste.toFixed(3);
    marcarLinha(codProduto, ajuste);
}

function marcarLinha(codProduto, ajuste) {
    const original = componentesOriginais[codProduto];
    // Invertido para semântica de saída: negativo = consumiu mais
    const ajusteOriginal = -(original.consumo_real - original.consumo_previsto);
    const row = document.querySelector(`tr[data-cod="${codProduto}"]`);
    const inputAjuste = document.getElementById(`ajuste-${codProduto}`);

    const diferenca = Math.abs(ajuste - ajusteOriginal);

    if (diferenca > 0.001) {
        row.classList.add('modificado');
    } else {
        row.classList.remove('modificado');
    }

    if (ajuste > 0.001) {
        inputAjuste.classList.add('ajuste-positivo');
        inputAjuste.classList.remove('ajuste-negativo');
    } else if (ajuste < -0.001) {
        inputAjuste.classList.add('ajuste-negativo');
        inputAjuste.classList.remove('ajuste-positivo');
    } else {
        inputAjuste.classList.remove('ajuste-positivo', 'ajuste-negativo');
    }
}

// ========================================
// SALVAR AJUSTES (INDIVIDUAL E GRUPO)
// ========================================

function salvarAjustes() {
    const ajustesParaSalvar = [];

    Object.keys(componentesOriginais).forEach(codProduto => {
        const original = componentesOriginais[codProduto];
        const inputAjuste = document.getElementById(`ajuste-${codProduto}`);

        if (!inputAjuste) return;

        const ajusteNovo = parseFloat(inputAjuste.value) || 0;
        // Inverter: no frontend negativo = consumiu mais, backend espera positivo = consumiu mais
        const ajusteOriginal = -(original.ajuste_registrado || 0);

        const diferenca = ajusteNovo - ajusteOriginal;

        if (Math.abs(diferenca) > 0.001) {
            ajustesParaSalvar.push({
                cod_produto: codProduto,
                qtd_ajuste: -diferenca  // Inverter para o backend
            });
        }
    });

    if (ajustesParaSalvar.length === 0) {
        Swal.fire('Aviso', 'Nenhum ajuste para salvar', 'info');
        return;
    }

    Swal.fire({
        title: 'Confirmar Ajustes',
        html: `Serão salvos <strong>${ajustesParaSalvar.length}</strong> ajuste(s).<br><br>
               <small class="text-muted">Ajustes negativos aumentam o consumo, positivos reduzem.</small>`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Salvar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            executarSalvarAjustes(ajustesParaSalvar);
        }
    });
}

function executarSalvarAjustes(ajustes) {
    let url, body;

    if (producaoAtualGrupo) {
        // GRUPO: usar rota de grupo
        url = '/manufatura/analise-producao/grupo/ajustar';
        body = JSON.stringify({
            ordem_producao: producaoAtualGrupo.ordem_producao,
            cod_produto: producaoAtualGrupo.cod_produto,
            ajustes: ajustes
        });
    } else {
        // INDIVIDUAL: usar rota individual
        url = `/manufatura/analise-producao/${producaoAtualId}/ajustar`;
        body = JSON.stringify({ ajustes: ajustes });
    }

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: body
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Sucesso!',
                text: data.message,
                timer: 2000,
                showConfirmButton: false
            });

            // Recarregar componentes
            if (producaoAtualGrupo) {
                abrirModalComponentesGrupo(producaoAtualGrupo.ordem_producao, producaoAtualGrupo.cod_produto);
            } else {
                abrirModalComponentes(producaoAtualId);
            }
        } else {
            Swal.fire('Erro', data.message || 'Erro ao salvar ajustes', 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        Swal.fire('Erro', 'Erro de comunicação com o servidor', 'error');
    });
}

// ========================================
// UTILITÁRIOS
// ========================================

function formatarNumero(valor) {
    if (valor === null || valor === undefined) return '-';
    return parseFloat(valor).toLocaleString('pt-BR', {
        minimumFractionDigits: 3,
        maximumFractionDigits: 3
    });
}
</script>
{% endblock %}
