{% extends 'base.html' %}
{% set active_page = "manufatura" %}

{% block title %}Macro Projecao de Componentes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/modules/manufatura/macro-projecao.css') }}">
{% endblock %}

{% block content %}
<div class="macro-container">
    <!-- Filtros -->
    <div class="filters-card">
        <div class="row g-2 align-items-end">
            <!-- Linha 1: Filtros de dropdown -->
            <div class="col-md-3">
                <label class="form-label small mb-1">Categoria</label>
                <select id="select-categoria" class="form-select form-select-sm">
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-1">Tipo Mat. Prima</label>
                <select id="select-tipo-mp" class="form-select form-select-sm">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-1">Linha Producao</label>
                <select id="select-linha" class="form-select form-select-sm">
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-center gap-2">
                <button id="btn-limpar-filtros" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-times me-1"></i>Limpar
                </button>
                <button id="btn-exportar" class="btn btn-export btn-sm">
                    <i class="fas fa-file-excel me-1"></i>Excel
                </button>
            </div>
        </div>
        <div class="row g-2 mt-2 align-items-center">
            <!-- Linha 2: Busca e ordenacao -->
            <div class="col-md-4">
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" id="input-busca" class="form-control form-control-sm search-input" placeholder="Buscar codigo ou produto...">
                </div>
            </div>
            <div class="col-md-3">
                <select id="select-ordenar" class="form-select form-select-sm">
                    <option value="ruptura_saldo">Ordenar: Mais criticos</option>
                    <option value="nome">Ordenar: Nome A-Z</option>
                    <option value="codigo">Ordenar: Codigo</option>
                </select>
            </div>
            <div class="col-md-3">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="check-negativos">
                    <label class="form-check-label small" for="check-negativos">
                        Apenas saldos negativos
                    </label>
                </div>
            </div>
            <div class="col-md-2 text-end">
                <span id="info-data" class="text-muted small"></span>
            </div>
        </div>
    </div>

    <!-- Tabela -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="table-macro" id="tabela-projecao">
                <thead>
                    <tr>
                        <th colspan="2">IDENTIFICACAO</th>
                        <th colspan="3" class="grupo-ruptura">RUPTURA</th>
                        <th colspan="3" class="grupo-mes-atual" id="th-mes-atual">SALDO DEMANDA</th>
                        <th colspan="3" class="grupo-mes-proximo" id="th-mes-proximo">SALDO DEMANDA</th>
                    </tr>
                    <tr>
                        <th>Codigo</th>
                        <th>Produto</th>
                        <th class="grupo-ruptura">Estoque</th>
                        <th class="grupo-ruptura">Necessidade</th>
                        <th class="grupo-ruptura">Saldo</th>
                        <th class="grupo-mes-atual">Chegada</th>
                        <th class="grupo-mes-atual">Necessidade</th>
                        <th class="grupo-mes-atual">Saldo</th>
                        <th class="grupo-mes-proximo">Chegada</th>
                        <th class="grupo-mes-proximo">Necessidade</th>
                        <th class="grupo-mes-proximo">Saldo</th>
                    </tr>
                </thead>
                <tbody id="tbody-projecao">
                    <!-- Dados serao inseridos via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner">
        <i class="fas fa-circle-notch"></i>
        <p class="mt-3">Calculando projecao...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const MESES = {
    1: 'JAN', 2: 'FEV', 3: 'MAR', 4: 'ABR',
    5: 'MAI', 6: 'JUN', 7: 'JUL', 8: 'AGO',
    9: 'SET', 10: 'OUT', 11: 'NOV', 12: 'DEZ'
};

let dadosCarregados = null;

document.addEventListener('DOMContentLoaded', function() {
    // Carregar filtros primeiro, depois dados
    carregarFiltros().then(() => carregarDados());

    // Event listeners
    document.getElementById('input-busca').addEventListener('input', debounce(filtrarTabela, 300));
    document.getElementById('check-negativos').addEventListener('change', filtrarTabela);
    document.getElementById('select-ordenar').addEventListener('change', filtrarTabela);
    document.getElementById('btn-exportar').addEventListener('click', exportarExcel);
    document.getElementById('btn-limpar-filtros').addEventListener('click', limparFiltros);

    // Filtros de dropdown - recarregam dados do servidor
    document.getElementById('select-categoria').addEventListener('change', carregarDados);
    document.getElementById('select-tipo-mp').addEventListener('change', carregarDados);
    document.getElementById('select-linha').addEventListener('change', carregarDados);
});

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

async function carregarFiltros() {
    try {
        const response = await fetch('{{ url_for("macro_projecao.api_filtros") }}');
        const dados = await response.json();

        if (!dados.sucesso) {
            console.error('Erro ao carregar filtros:', dados.erro);
            return;
        }

        // Popular select de categorias
        const selectCategoria = document.getElementById('select-categoria');
        dados.categorias.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            selectCategoria.appendChild(option);
        });

        // Popular select de tipos de materia prima
        const selectTipoMP = document.getElementById('select-tipo-mp');
        dados.tipos_materia_prima.forEach(tipo => {
            const option = document.createElement('option');
            option.value = tipo;
            option.textContent = tipo;
            selectTipoMP.appendChild(option);
        });

        // Popular select de linhas de producao
        const selectLinha = document.getElementById('select-linha');
        dados.linhas_producao.forEach(linha => {
            const option = document.createElement('option');
            option.value = linha;
            option.textContent = linha;
            selectLinha.appendChild(option);
        });

    } catch (error) {
        console.error('Erro ao carregar filtros:', error);
    }
}

async function carregarDados() {
    try {
        document.getElementById('loading-overlay').style.display = 'flex';

        // Montar URL com filtros
        const params = new URLSearchParams();
        const categoria = document.getElementById('select-categoria').value;
        const tipoMP = document.getElementById('select-tipo-mp').value;
        const linha = document.getElementById('select-linha').value;

        if (categoria) params.append('categoria', categoria);
        if (tipoMP) params.append('tipo_materia_prima', tipoMP);
        if (linha) params.append('linha_producao', linha);

        const url = '{{ url_for("macro_projecao.api_dados") }}' + (params.toString() ? '?' + params.toString() : '');
        const response = await fetch(url);
        const dados = await response.json();

        if (!dados.sucesso) {
            throw new Error(dados.erro || 'Erro ao carregar dados');
        }

        dadosCarregados = dados;
        atualizarInterface(dados);

    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao carregar dados: ' + error.message);
    } finally {
        document.getElementById('loading-overlay').style.display = 'none';
    }
}

function limparFiltros() {
    document.getElementById('select-categoria').value = '';
    document.getElementById('select-tipo-mp').value = '';
    document.getElementById('select-linha').value = '';
    document.getElementById('input-busca').value = '';
    document.getElementById('check-negativos').checked = false;
    document.getElementById('select-ordenar').value = 'ruptura_saldo';
    carregarDados();
}

function atualizarInterface(dados) {
    // Atualizar cabecalhos com meses
    const mesAtualNome = MESES[dados.mes_atual];
    const mesProximoNome = MESES[dados.mes_proximo];

    document.getElementById('th-mes-atual').textContent = `SALDO DEMANDA ${mesAtualNome}/${dados.ano_atual}`;
    document.getElementById('th-mes-proximo').textContent = `SALDO DEMANDA ${mesProximoNome}/${dados.ano_proximo}`;

    // Atualizar data
    document.getElementById('info-data').textContent = `Calculado em: ${dados.data_calculo}`;

    // Renderizar tabela
    renderizarTabela(dados.componentes);
}

function renderizarTabela(componentes) {
    const tbody = document.getElementById('tbody-projecao');
    tbody.innerHTML = '';

    if (componentes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center py-4 text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p>Nenhum componente encontrado</p>
                </td>
            </tr>
        `;
        return;
    }

    componentes.forEach(comp => {
        const tr = document.createElement('tr');

        // Determinar classes de saldo
        const classeRuptura = getClasseSaldo(comp.ruptura.saldo);
        const classeAtual = getClasseSaldo(comp.saldo_mes_atual.saldo);
        const classeProximo = getClasseSaldo(comp.saldo_mes_proximo.saldo);

        // Badge de unificacao
        const badgeUnificado = comp.codigos_unificados ?
            `<span class="badge-unificado" title="Codigos: ${comp.codigos_unificados.join(', ')}">UN</span>` : '';

        tr.innerHTML = `
            <td class="codigo">${comp.cod_produto}${badgeUnificado}</td>
            <td class="produto" title="${comp.nome_produto}">${comp.nome_produto}</td>
            <td class="numero grupo-ruptura">${formatNumber(comp.ruptura.estoque_atual)}</td>
            <td class="numero grupo-ruptura">${formatNumber(comp.ruptura.necessidade)}</td>
            <td class="numero grupo-ruptura ${classeRuptura}">${formatNumber(comp.ruptura.saldo)}</td>
            <td class="numero grupo-mes-atual">${formatNumber(comp.saldo_mes_atual.chegada)}</td>
            <td class="numero grupo-mes-atual">${formatNumber(comp.saldo_mes_atual.necessidade)}</td>
            <td class="numero grupo-mes-atual ${classeAtual}">${formatNumber(comp.saldo_mes_atual.saldo)}</td>
            <td class="numero grupo-mes-proximo">${formatNumber(comp.saldo_mes_proximo.chegada)}</td>
            <td class="numero grupo-mes-proximo">${formatNumber(comp.saldo_mes_proximo.necessidade)}</td>
            <td class="numero grupo-mes-proximo ${classeProximo}">${formatNumber(comp.saldo_mes_proximo.saldo)}</td>
        `;

        tbody.appendChild(tr);
    });
}

function getClasseSaldo(valor) {
    if (valor < 0) return 'saldo-negativo';
    if (valor > 0) return 'saldo-positivo';
    return 'saldo-neutro';
}

function formatNumber(valor) {
    return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    }).format(valor);
}

function filtrarTabela() {
    if (!dadosCarregados) return;

    const busca = document.getElementById('input-busca').value.toLowerCase().trim();
    const apenasNegativos = document.getElementById('check-negativos').checked;
    const ordenarPor = document.getElementById('select-ordenar').value;

    let componentes = [...dadosCarregados.componentes];

    // Filtrar por busca
    if (busca) {
        componentes = componentes.filter(c =>
            c.cod_produto.toLowerCase().includes(busca) ||
            c.nome_produto.toLowerCase().includes(busca)
        );
    }

    // Filtrar apenas negativos
    if (apenasNegativos) {
        componentes = componentes.filter(c =>
            c.ruptura.saldo < 0 ||
            c.saldo_mes_atual.saldo < 0 ||
            c.saldo_mes_proximo.saldo < 0
        );
    }

    // Ordenar
    switch (ordenarPor) {
        case 'ruptura_saldo':
            componentes.sort((a, b) => a.ruptura.saldo - b.ruptura.saldo);
            break;
        case 'nome':
            componentes.sort((a, b) => a.nome_produto.localeCompare(b.nome_produto));
            break;
        case 'codigo':
            componentes.sort((a, b) => a.cod_produto.localeCompare(b.cod_produto));
            break;
    }

    // Atualizar tabela
    renderizarTabela(componentes);
}

function exportarExcel() {
    // Montar URL com filtros atuais
    const params = new URLSearchParams();
    const categoria = document.getElementById('select-categoria').value;
    const tipoMP = document.getElementById('select-tipo-mp').value;
    const linha = document.getElementById('select-linha').value;

    if (categoria) params.append('categoria', categoria);
    if (tipoMP) params.append('tipo_materia_prima', tipoMP);
    if (linha) params.append('linha_producao', linha);

    const url = '{{ url_for("macro_projecao.exportar_excel") }}' + (params.toString() ? '?' + params.toString() : '');
    window.location.href = url;
}
</script>
{% endblock %}
