{% extends "base.html" %}

{% block title %}Ordens de Produção - Manufatura/PCP{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('manufatura.dashboard') }}">Manufatura</a></li>
                    <li class="breadcrumb-item active">Ordens de Produção</li>
                </ol>
            </nav>
            <h1 class="h3 mb-3">
                <i class="fas fa-tasks me-2"></i>
                Ordens de Produção
            </h1>
        </div>
    </div>

    <!-- Cards de Status -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">Planejadas</div>
                    <div class="h5 mb-0 font-weight-bold" id="count-planejadas">0</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Liberadas</div>
                    <div class="h5 mb-0 font-weight-bold" id="count-liberadas">0</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Em Produção</div>
                    <div class="h5 mb-0 font-weight-bold" id="count-producao">0</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Concluídas</div>
                    <div class="h5 mb-0 font-weight-bold" id="count-concluidas">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações e Filtros -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Ações e Filtros</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label>Status</label>
                    <select class="form-control" id="filtro-status">
                        <option value="">Todos</option>
                        <option value="Planejada">Planejada</option>
                        <option value="Liberada">Liberada</option>
                        <option value="Em Produção">Em Produção</option>
                        <option value="Concluída">Concluída</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>Linha Produção</label>
                    <select class="form-control" id="filtro-linha">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label>&nbsp;</label>
                    <div>
                        <button class="btn btn-primary" onclick="carregarOrdens()">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                        <button class="btn btn-success" onclick="abrirModalNovaOrdem()">
                            <i class="fas fa-plus"></i> Nova Ordem
                        </button>
                        <button class="btn btn-warning" onclick="gerarOrdensMTO()">
                            <i class="fas fa-magic"></i> Gerar MTO Auto
                        </button>
                        <button class="btn btn-info" onclick="abrirSequenciamento()">
                            <i class="fas fa-sort"></i> Sequenciar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Ordens -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Lista de Ordens</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="tabela-ordens">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Origem</th>
                            <th>Status</th>
                            <th>Produto</th>
                            <th>Cliente/Pedido</th>
                            <th>Qtd Plan.</th>
                            <th>Qtd Prod.</th>
                            <th>Progresso</th>
                            <th>Início</th>
                            <th>Fim</th>
                            <th>Linha</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="12" class="text-center">
                                <span class="spinner-border spinner-border-sm"></span> Carregando...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Ordem -->
<div class="modal fade" id="modalNovaOrdem" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Ordem de Produção</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formNovaOrdem">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Origem</label>
                                <select class="form-control" name="origem_ordem" required>
                                    <option value="Manual">Manual</option>
                                    <option value="PMP">Plano Mestre</option>
                                    <option value="MTO">Make to Order</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Código Produto</label>
                                <input type="text" class="form-control" name="cod_produto" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Nome Produto</label>
                                <input type="text" class="form-control" name="nome_produto">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Qtd Planejada</label>
                                <input type="number" class="form-control" name="qtd_planejada" step="0.001" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Data Início</label>
                                <input type="date" class="form-control" name="data_inicio_prevista" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Data Fim</label>
                                <input type="date" class="form-control" name="data_fim_prevista" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Linha Produção</label>
                                <select class="form-control" name="linha_producao">
                                    <option value="">Selecione</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="explodir_bom" checked>
                                <label class="form-check-label" for="explodir_bom">
                                    Explodir lista de materiais (BOM)
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- Área para mostrar BOM explodido -->
                <div id="area-bom" class="mt-3" style="display:none;">
                    <h6>Materiais Necessários:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Qtd Necessária</th>
                                    <th>Disponível</th>
                                    <th>Comprar</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-bom">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarOrdem()">Criar Ordem</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalhes Ordem -->
<div class="modal fade" id="modalDetalhesOrdem" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Ordem</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="detalhes-ordem">
                <!-- Preenchido dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
var ordens = [];

$(document).ready(function() {
    carregarOrdens();
    carregarLinhas();
});

function carregarOrdens() {
    var status = $('#filtro-status').val();
    
    $.get('{{ url_for("manufatura.listar_ordens") }}', {status: status})
        .done(function(data) {
            ordens = data;
            renderizarTabela();
            atualizarContadores();
        })
        .fail(function() {
            alert('Erro ao carregar ordens');
        });
}

function renderizarTabela() {
    var tbody = $('#tabela-ordens tbody');
    tbody.empty();
    
    if (ordens.length === 0) {
        tbody.append('<tr><td colspan="12" class="text-center">Nenhuma ordem encontrada</td></tr>');
        return;
    }
    
    ordens.forEach(function(o) {
        var progresso = o.qtd_planejada > 0 ? 
            ((o.qtd_produzida / o.qtd_planejada) * 100).toFixed(1) : 0;
        
        var statusBadge = {
            'Planejada': 'badge-secondary',
            'Liberada': 'badge-info',
            'Em Produção': 'badge-warning',
            'Concluída': 'badge-success',
            'Cancelada': 'badge-danger'
        }[o.status] || 'badge-secondary';
        
        var origemBadge = o.origem_ordem === 'MTO' ? 'badge-warning' : 'badge-primary';
        
        // Coluna Cliente/Pedido para MTO
        var clientePedido = '';
        if (o.origem_ordem === 'MTO' && o.separacao_lote_id) {
            clientePedido = '<small>';
            if (o.raz_social_red) {
                clientePedido += o.raz_social_red + '<br>';
            }
            if (o.num_pedido_origem) {
                clientePedido += 'Ped: ' + o.num_pedido_origem + '<br>';
            }
            clientePedido += 'Lote: ' + o.separacao_lote_id;
            if (o.qtd_pedido_atual) {
                clientePedido += '<br>Qtd: ' + o.qtd_pedido_atual.toFixed(2);
            }
            clientePedido += '</small>';
        } else {
            clientePedido = '<span class="text-muted">-</span>';
        }
        
        var tr = $('<tr>');
        tr.append('<td>' + o.numero_ordem + '</td>');
        tr.append('<td><span class="badge ' + origemBadge + '">' + o.origem_ordem + '</span></td>');
        tr.append('<td><span class="badge ' + statusBadge + '">' + o.status + '</span></td>');
        tr.append('<td>' + o.cod_produto + '<br><small>' + o.nome_produto + '</small></td>');
        tr.append('<td>' + clientePedido + '</td>');
        tr.append('<td class="text-right">' + o.qtd_planejada.toFixed(2) + '</td>');
        tr.append('<td class="text-right">' + o.qtd_produzida.toFixed(2) + '</td>');
        tr.append('<td><div class="progress"><div class="progress-bar" style="width:' + progresso + '%">' + progresso + '%</div></div></td>');
        tr.append('<td>' + (o.data_inicio_prevista || '-') + '</td>');
        tr.append('<td>' + (o.data_fim_prevista || '-') + '</td>');
        tr.append('<td>' + (o.linha_producao || '-') + '</td>');
        tr.append('<td class="text-center">' +
            '<div class="btn-group btn-group-sm">' +
            '<button class="btn btn-info" onclick="verDetalhes(' + o.id + ')" title="Detalhes">' +
            '<i class="fas fa-eye"></i></button>' +
            '<button class="btn btn-warning" onclick="alterarStatus(' + o.id + ')" title="Status">' +
            '<i class="fas fa-exchange-alt"></i></button>' +
            (o.origem_ordem === 'MTO' ? 
                '<button class="btn btn-success" onclick="validarMTO(' + o.id + ')" title="Validar Qtd">' +
                '<i class="fas fa-check-circle"></i></button>' : '') +
            '</div></td>');
        tbody.append(tr);
    });
}

function atualizarContadores() {
    var contadores = {
        'Planejada': 0,
        'Liberada': 0,
        'Em Produção': 0,
        'Concluída': 0
    };
    
    ordens.forEach(function(o) {
        if (contadores[o.status] !== undefined) {
            contadores[o.status]++;
        }
    });
    
    $('#count-planejadas').text(contadores['Planejada']);
    $('#count-liberadas').text(contadores['Liberada']);
    $('#count-producao').text(contadores['Em Produção']);
    $('#count-concluidas').text(contadores['Concluída']);
}

function abrirModalNovaOrdem() {
    $('#formNovaOrdem')[0].reset();
    $('#modalNovaOrdem').modal('show');
}

function salvarOrdem() {
    var dados = {
        origem_ordem: $('[name="origem_ordem"]').val(),
        cod_produto: $('[name="cod_produto"]').val(),
        nome_produto: $('[name="nome_produto"]').val(),
        qtd_planejada: parseFloat($('[name="qtd_planejada"]').val()),
        data_inicio_prevista: $('[name="data_inicio_prevista"]').val(),
        data_fim_prevista: $('[name="data_fim_prevista"]').val(),
        linha_producao: $('[name="linha_producao"]').val(),
        explodir_bom: $('#explodir_bom').is(':checked')
    };
    
    $.post('{{ url_for("manufatura.criar_ordem") }}', 
        JSON.stringify(dados),
        {contentType: 'application/json'}
    )
    .done(function(response) {
        $('#modalNovaOrdem').modal('hide');
        carregarOrdens();
        alert('Ordem criada com sucesso!');
    })
    .fail(function(xhr) {
        alert('Erro ao criar ordem: ' + xhr.responseJSON.erro);
    });
}

function verDetalhes(id) {
    $.get('{{ url_for("manufatura.obter_ordem", id=0) }}'.replace('0', id))
        .done(function(ordem) {
            var html = '<div class="row">';
            html += '<div class="col-md-6"><strong>Número:</strong> ' + ordem.numero_ordem + '</div>';
            html += '<div class="col-md-6"><strong>Status:</strong> ' + ordem.status + '</div>';
            html += '<div class="col-md-6"><strong>Produto:</strong> ' + ordem.cod_produto + '</div>';
            html += '<div class="col-md-6"><strong>Linha:</strong> ' + (ordem.linha_producao || '-') + '</div>';
            
            // Informações MTO se aplicável
            if (ordem.origem_ordem === 'MTO' && ordem.separacao_lote_id) {
                html += '<div class="col-md-12 mt-2"><strong>Vínculo MTO:</strong></div>';
                html += '<div class="col-md-6"><strong>Lote Separação:</strong> ' + ordem.separacao_lote_id + '</div>';
                html += '<div class="col-md-6"><strong>Pedido:</strong> ' + (ordem.num_pedido_origem || '-') + '</div>';
                html += '<div class="col-md-6"><strong>Cliente:</strong> ' + (ordem.raz_social_red || '-') + '</div>';
                html += '<div class="col-md-6"><strong>Qtd Pedido:</strong> ' + (ordem.qtd_pedido_atual ? ordem.qtd_pedido_atual.toFixed(2) : '-') + '</div>';
            }
            
            html += '</div>';
            
            if (ordem.materiais_necessarios && ordem.materiais_necessarios.length > 0) {
                html += '<h6 class="mt-3">Materiais Necessários:</h6>';
                html += '<table class="table table-sm"><thead><tr><th>Material</th><th>Qtd</th><th>Disponível</th><th>Comprar</th></tr></thead><tbody>';
                ordem.materiais_necessarios.forEach(function(m) {
                    html += '<tr>';
                    html += '<td>' + m.cod_produto + ' - ' + m.nome_produto + '</td>';
                    html += '<td>' + m.qtd_necessaria.toFixed(2) + '</td>';
                    html += '<td>' + m.qtd_disponivel.toFixed(2) + '</td>';
                    html += '<td>' + m.qtd_comprar.toFixed(2) + '</td>';
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }
            
            $('#detalhes-ordem').html(html);
            $('#modalDetalhesOrdem').modal('show');
        });
}

function alterarStatus(id) {
    var novoStatus = prompt('Novo status:\nLiberada\nEm Produção\nConcluída\nCancelada');
    if (!novoStatus) return;
    
    $.post('{{ url_for("manufatura.atualizar_status_ordem", id=0) }}'.replace('0', id), 
        JSON.stringify({status: novoStatus}),
        {contentType: 'application/json'}
    )
    .done(function() {
        carregarOrdens();
        alert('Status atualizado!');
    })
    .fail(function(xhr) {
        alert('Erro: ' + xhr.responseJSON.erro);
    });
}

function gerarOrdensMTO() {
    if (!confirm('Gerar ordens MTO automaticamente para pedidos urgentes?')) return;
    
    $.post('{{ url_for("manufatura.gerar_ordens_mto") }}')
        .done(function(response) {
            alert(response.mensagem);
            carregarOrdens();
        })
        .fail(function() {
            alert('Erro ao gerar ordens MTO');
        });
}

function carregarLinhas() {
    // Implementar carregamento de linhas de produção
}

function abrirSequenciamento() {
    window.location.href = '{{ url_for("manufatura.sequenciamento") }}';
}

function validarMTO(id) {
    $.get('{{ url_for("manufatura.validar_quantidade_mto", id=0) }}'.replace('0', id))
        .done(function(response) {
            var mensagem = 'Validação MTO:\n\n';
            mensagem += 'Status: ' + response.mensagem + '\n';
            mensagem += 'Fonte: ' + response.fonte + '\n';
            mensagem += 'Quantidade Ordem: ' + response.qtd_ordem + '\n';
            mensagem += 'Quantidade Pedido (Vínculo): ' + response.qtd_pedido_vinculo + '\n';
            mensagem += 'Quantidade Pedido (Atual): ' + response.qtd_pedido_atual + '\n';
            
            if (response.atualizado) {
                mensagem += '\n⚠️ Quantidade foi atualizada automaticamente!';
            }
            
            alert(mensagem);
            
            if (response.atualizado) {
                carregarOrdens();
            }
        })
        .fail(function() {
            alert('Erro ao validar quantidade MTO');
        });
}
</script>
{% endblock %}