{% extends "base.html" %}

{% block title %}Historico de Pedidos - Manufatura/PCP{% endblock %}

{% block content %}
<!-- Token CSRF -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container-fluid px-4 py-3 premium-page">
    <div class="row mb-4 reveal">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('manufatura.index') }}">Manufatura</a></li>
                    <li class="breadcrumb-item active">Historico de Pedidos</li>
                </ol>
            </nav>
            <h1 class="h3 mb-3">
                <i class="fas fa-history me-2"></i>
                Historico de Pedidos
            </h1>
        </div>
    </div>

    <!-- Estatisticas -->
    <div class="row mb-4" id="estatisticas-container">
        <div class="col-md-3">
            <div class="historico-stats-card historico-stats-card-primary">
                <h4 id="stat-registros">-</h4>
                <p>Total de Registros</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="historico-stats-card historico-stats-card-pink">
                <h4 id="stat-pedidos">-</h4>
                <p>Pedidos Unicos</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="historico-stats-card historico-stats-card-cyan">
                <h4 id="stat-produtos">-</h4>
                <p>Produtos Unicos</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="historico-stats-card historico-stats-card-green">
                <h4 id="stat-valor">-</h4>
                <p>Valor Total</p>
            </div>
        </div>
    </div>

    <!-- Filtros e Acoes -->
    <div class="card shadow mb-4">
        <div class="card-header historico-card-header py-3">
            <h6 class="m-0 fw-bold">
                <i class="fas fa-filter me-2"></i>Filtros e Sincronizacao
            </h6>
        </div>
        <div class="card-body">
            <!-- Row 1: Datas + Grupo + Cliente + CNPJ -->
            <div class="row mb-2">
                <div class="col-md-2">
                    <label>Data Inicio</label>
                    <input type="date" class="form-control" id="filtro-data-inicio">
                </div>
                <div class="col-md-2">
                    <label>Data Fim</label>
                    <input type="date" class="form-control" id="filtro-data-fim">
                </div>
                <div class="col-md-2">
                    <label>Grupo</label>
                    <select class="form-control" id="filtro-grupo">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>Cliente</label>
                    <input type="text" class="form-control" id="filtro-cliente" placeholder="Nome do cliente">
                </div>
                <div class="col-md-3">
                    <label>CNPJ</label>
                    <input type="text" class="form-control" id="filtro-cnpj" placeholder="00.000.000/0000-00">
                </div>
            </div>
            <!-- Row 2: Produto + Acoes -->
            <div class="row">
                <div class="col-md-2">
                    <label>Codigo Produto</label>
                    <input type="text" class="form-control" id="filtro-cod-produto" placeholder="Ex: 12345">
                </div>
                <div class="col-md-3">
                    <label>Nome Produto</label>
                    <input type="text" class="form-control" id="filtro-nome-produto" placeholder="Nome do produto">
                </div>
                <div class="col-md-7">
                    <label>&nbsp;</label>
                    <div class="text-end">
                        <button class="btn btn-primary" onclick="carregarHistorico()">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <button class="btn btn-success" onclick="exportarExcel()">
                            <i class="fas fa-download"></i> Exportar Excel
                        </button>
                        <button class="btn btn-warning historico-sync-btn" onclick="sincronizarOdoo()">
                            <i class="fas fa-sync"></i> Sincronizar Odoo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Dados -->
    <div class="card shadow">
        <div class="card-header historico-card-header py-3">
            <h6 class="m-0 fw-bold">
                <i class="fas fa-table me-2"></i>Registros do Historico
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover historico-table" id="tabela-historico">
                    <thead class="historico-thead">
                        <tr>
                            <th>Pedido</th>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Grupo</th>
                            <th>Cidade/UF</th>
                            <th>Codigo Produto</th>
                            <th>Nome Produto</th>
                            <th class="text-end">Quantidade</th>
                            <th class="text-end">Valor</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-historico">
                        <tr>
                            <td colspan="9" class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                Configure os filtros e clique em "Buscar"
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Paginacao -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <p id="info-paginacao" class="text-muted">-</p>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-sm btn-secondary" onclick="mudarPagina(-1)">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    <span id="pagina-atual" class="mx-2">Pagina 1</span>
                    <button class="btn btn-sm btn-secondary" onclick="mudarPagina(1)">
                        Proxima <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Configuracao global
var paginaAtual = 1;
var totalPaginas = 1;

// Coleta todos os filtros ativos
function coletarFiltros() {
    return {
        data_inicio: $('#filtro-data-inicio').val(),
        data_fim: $('#filtro-data-fim').val(),
        grupo: $('#filtro-grupo').val(),
        cliente: $('#filtro-cliente').val(),
        cnpj: $('#filtro-cnpj').val(),
        cod_produto: $('#filtro-cod-produto').val(),
        nome_produto: $('#filtro-nome-produto').val()
    };
}

// Inicializacao
$(document).ready(function() {
    // Define data padrao (30 dias atras ate hoje)
    var hoje = new Date();
    var umMesAtras = new Date();
    umMesAtras.setMonth(umMesAtras.getMonth() - 1);

    $('#filtro-data-fim').val(hoje.toISOString().split('T')[0]);
    $('#filtro-data-inicio').val(umMesAtras.toISOString().split('T')[0]);

    // Carrega grupos
    carregarGrupos();

    // Carrega estatisticas iniciais
    carregarEstatisticas();

    // Carrega historico
    carregarHistorico();

    // Enter nos filtros texto dispara busca
    $('#filtro-cliente, #filtro-cnpj, #filtro-cod-produto, #filtro-nome-produto').keypress(function(e) {
        if (e.which === 13) {
            carregarHistorico();
        }
    });
});

// Carrega grupos empresariais
function carregarGrupos() {
    $.get('/manufatura/api/previsao-demanda/listar-grupos')
    .done(function(grupos) {
        var $select = $('#filtro-grupo');
        $select.empty().append('<option value="">Todos os Grupos</option>');

        grupos.forEach(function(grupo) {
            if (grupo.value !== '') {
                $select.append($('<option>').val(grupo.value).text(grupo.label));
            }
        });
    });
}

// Carrega estatisticas
function carregarEstatisticas() {
    var filtros = coletarFiltros();

    $.get('/manufatura/api/historico-pedidos/estatisticas', filtros)
    .done(function(stats) {
        $('#stat-registros').text(stats.total_registros.toLocaleString('pt-BR'));
        $('#stat-pedidos').text(stats.total_pedidos.toLocaleString('pt-BR'));
        $('#stat-produtos').text(stats.total_produtos.toLocaleString('pt-BR'));
        $('#stat-valor').text('R$ ' + stats.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2}));
    })
    .fail(function() {
        console.error('Erro ao carregar estatisticas');
    });
}

// Carrega historico
function carregarHistorico(pagina) {
    pagina = pagina || 1;

    var filtros = coletarFiltros();
    filtros.page = pagina;
    filtros.per_page = 50;

    $('#tbody-historico').html(
        '<tr><td colspan="9" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Carregando...</td></tr>'
    );

    $.get('/manufatura/api/historico-pedidos/listar', filtros)
    .done(function(response) {
        var $tbody = $('#tbody-historico');
        $tbody.empty();

        if (response.registros.length === 0) {
            $tbody.html('<tr><td colspan="9" class="text-center text-muted">Nenhum registro encontrado</td></tr>');
            return;
        }

        response.registros.forEach(function(r) {
            var $tr = $('<tr>');
            $tr.append('<td>' + r.num_pedido + '</td>');
            $tr.append('<td>' + (r.data_pedido || '-') + '</td>');
            $tr.append('<td><small>' + (r.raz_social_red || '-') + '</small></td>');
            $tr.append('<td><span class="badge bg-info">' + (r.nome_grupo || '-') + '</span></td>');
            $tr.append('<td>' + (r.nome_cidade || '-') + '/' + (r.cod_uf || '-') + '</td>');
            $tr.append('<td><strong>' + r.cod_produto + '</strong></td>');
            $tr.append('<td><small>' + (r.nome_produto || '-') + '</small></td>');
            $tr.append('<td class="text-end">' + r.qtd_produto_pedido.toLocaleString('pt-BR', {minimumFractionDigits: 3}) + '</td>');
            $tr.append('<td class="text-end">R$ ' + r.valor_produto_pedido.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '</td>');
            $tbody.append($tr);
        });

        // Atualiza paginacao
        paginaAtual = response.page;
        totalPaginas = response.total_pages;
        $('#pagina-atual').text('Pagina ' + paginaAtual + ' de ' + totalPaginas);
        $('#info-paginacao').text('Mostrando ' + response.registros.length + ' de ' + response.total + ' registros');

        // Atualiza estatisticas
        carregarEstatisticas();
    })
    .fail(function() {
        $('#tbody-historico').html('<tr><td colspan="9" class="text-center text-danger">Erro ao carregar dados</td></tr>');
    });
}

// Muda pagina
function mudarPagina(direcao) {
    var novaPagina = paginaAtual + direcao;
    if (novaPagina < 1 || novaPagina > totalPaginas) return;
    carregarHistorico(novaPagina);
}

// Exporta para Excel
function exportarExcel() {
    var filtros = coletarFiltros();

    if (!filtros.data_fim) {
        alert('Selecione uma data fim para exportar');
        return;
    }

    var params = $.param(filtros);
    window.location.href = '/manufatura/api/historico-pedidos/exportar-excel?' + params;
}

// Sincroniza com Odoo
function sincronizarOdoo() {
    var dataInicio = $('#filtro-data-inicio').val();
    var dataFim = $('#filtro-data-fim').val();

    if (!dataFim) {
        alert('Selecione uma data fim para sincronizar');
        return;
    }

    if (!confirm('Sincronizar historico de pedidos do Odoo?\n\nPeriodo: ' + (dataInicio || 'inicio') + ' ate ' + dataFim)) {
        return;
    }

    var $btn = $('.historico-sync-btn');
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Sincronizando...');

    $.ajax({
        url: '/manufatura/api/historico-pedidos/sincronizar-odoo',
        method: 'POST',
        data: JSON.stringify({
            data_inicio: dataInicio,
            data_fim: dataFim
        }),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
        }
    })
    .done(function(response) {
        alert(response.mensagem + '\n\nTotal de registros: ' + response.total_registros);
        carregarHistorico();
    })
    .fail(function(xhr) {
        var erro = xhr.responseJSON ? xhr.responseJSON.erro : 'Erro ao sincronizar';
        alert('Erro: ' + erro);
    })
    .always(function() {
        $btn.prop('disabled', false).html('<i class="fas fa-sync"></i> Sincronizar Odoo');
    });
}
</script>
{% endblock %}
