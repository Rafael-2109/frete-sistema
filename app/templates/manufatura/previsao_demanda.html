{% extends "base.html" %}

{% block title %}Previsão de Demanda - Manufatura/PCP{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('manufatura.dashboard') }}">Manufatura</a></li>
                    <li class="breadcrumb-item active">Previsão de Demanda</li>
                </ol>
            </nav>
            <h1 class="h3 mb-3">
                <i class="fas fa-chart-line me-2"></i>
                Previsão de Demanda
            </h1>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Filtros e Ações</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-2">
                    <label>Mês</label>
                    <select class="form-control" id="filtro-mes">
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Março</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label>Ano</label>
                    <input type="number" class="form-control" id="filtro-ano" value="{{ current_year }}" min="2024" max="2030">
                </div>
                <div class="col-md-3">
                    <label>Grupo Empresarial</label>
                    <select class="form-control" id="filtro-grupo">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label>&nbsp;</label>
                    <div>
                        <button class="btn btn-primary" onclick="carregarPrevisoes()">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <button class="btn btn-success" onclick="abrirModalNovaPrevisao()">
                            <i class="fas fa-plus"></i> Nova Previsão
                        </button>
                        <button class="btn btn-info" onclick="gerarPorHistorico()">
                            <i class="fas fa-history"></i> Gerar por Histórico
                        </button>
                        <button class="btn btn-warning" onclick="gerarPlanoMestre()">
                            <i class="fas fa-project-diagram"></i> Gerar Plano Mestre
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Previsões -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Previsões Cadastradas</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="tabela-previsoes">
                    <thead>
                        <tr>
                            <th>Mês/Ano</th>
                            <th>Grupo</th>
                            <th>Cód. Produto</th>
                            <th>Nome Produto</th>
                            <th>Qtd Prevista</th>
                            <th>Qtd Realizada</th>
                            <th>% Realizado</th>
                            <th>Disparo</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" class="text-center">Selecione período para carregar</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Previsão -->
<div class="modal fade" id="modalNovaPrevisao" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Previsão de Demanda</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formNovaPrevisao">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Mês</label>
                                <select class="form-control" name="mes" required>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Março</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Ano</label>
                                <input type="number" class="form-control" name="ano" required min="2024" max="2030">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Grupo Empresarial</label>
                                <select class="form-control" name="nome_grupo">
                                    <option value="">Sem grupo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Código Produto</label>
                                <input type="text" class="form-control" name="cod_produto" required>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="form-group">
                                <label>Nome Produto</label>
                                <input type="text" class="form-control" name="nome_produto">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Qtd Prevista</label>
                                <input type="number" class="form-control" name="qtd_prevista" step="0.001" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Disparo Produção</label>
                                <select class="form-control" name="disparo_producao" required>
                                    <option value="MTS">MTS - Estoque</option>
                                    <option value="MTO">MTO - Pedido</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarPrevisao()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
var previsoes = [];
var mesAtual = new Date().getMonth() + 1;
var anoAtual = new Date().getFullYear();

$(document).ready(function() {
    $('#filtro-mes').val(mesAtual);
    $('#filtro-ano').val(anoAtual);
    $('input[name="ano"]').val(anoAtual);
    carregarPrevisoes();
    carregarGrupos();
});

function carregarPrevisoes() {
    var mes = $('#filtro-mes').val();
    var ano = $('#filtro-ano').val();
    
    $.get('{{ url_for("manufatura.listar_previsoes") }}', {
        mes: mes,
        ano: ano
    })
    .done(function(data) {
        previsoes = data;
        renderizarTabela();
    })
    .fail(function() {
        alert('Erro ao carregar previsões');
    });
}

function renderizarTabela() {
    var tbody = $('#tabela-previsoes tbody');
    tbody.empty();
    
    if (previsoes.length === 0) {
        tbody.append('<tr><td colspan="9" class="text-center">Nenhuma previsão encontrada</td></tr>');
        return;
    }
    
    previsoes.forEach(function(p) {
        var percentual = p.qtd_demanda_prevista > 0 ? 
            ((p.qtd_demanda_realizada / p.qtd_demanda_prevista) * 100).toFixed(1) : 0;
        
        var badgeDisparo = p.disparo_producao === 'MTO' ? 
            'badge-warning' : 'badge-info';
        
        var tr = $('<tr>');
        tr.append('<td>' + p.mes + '/' + p.ano + '</td>');
        tr.append('<td>' + (p.nome_grupo || '-') + '</td>');
        tr.append('<td>' + p.cod_produto + '</td>');
        tr.append('<td>' + p.nome_produto + '</td>');
        tr.append('<td class="text-right">' + p.qtd_demanda_prevista.toFixed(2) + '</td>');
        tr.append('<td class="text-right">' + p.qtd_demanda_realizada.toFixed(2) + '</td>');
        tr.append('<td class="text-center">' + percentual + '%</td>');
        tr.append('<td class="text-center"><span class="badge ' + badgeDisparo + '">' + p.disparo_producao + '</span></td>');
        tr.append('<td class="text-center">' +
            '<button class="btn btn-sm btn-info" onclick="editarPrevisao(' + p.id + ')">' +
            '<i class="fas fa-edit"></i></button> ' +
            '<button class="btn btn-sm btn-danger" onclick="excluirPrevisao(' + p.id + ')">' +
            '<i class="fas fa-trash"></i></button>' +
            '</td>');
        tbody.append(tr);
    });
}

function abrirModalNovaPrevisao() {
    $('#formNovaPrevisao')[0].reset();
    $('#modalNovaPrevisao').modal('show');
}

function salvarPrevisao() {
    var dados = {
        mes: $('[name="mes"]').val(),
        ano: $('[name="ano"]').val(),
        nome_grupo: $('[name="nome_grupo"]').val(),
        cod_produto: $('[name="cod_produto"]').val(),
        nome_produto: $('[name="nome_produto"]').val(),
        qtd_prevista: parseFloat($('[name="qtd_prevista"]').val()),
        disparo_producao: $('[name="disparo_producao"]').val()
    };
    
    $.post('{{ url_for("manufatura.criar_previsao") }}', 
        JSON.stringify(dados),
        {contentType: 'application/json'}
    )
    .done(function(response) {
        $('#modalNovaPrevisao').modal('hide');
        carregarPrevisoes();
        alert('Previsão criada com sucesso!');
    })
    .fail(function(xhr) {
        alert('Erro ao salvar: ' + xhr.responseJSON.erro);
    });
}

function gerarPorHistorico() {
    if (!confirm('Gerar previsões baseadas no histórico do ano anterior?')) return;
    
    var mes = $('#filtro-mes').val();
    var ano = $('#filtro-ano').val();
    
    // Obter token CSRF
    var csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                    $('meta[name="csrf-token"]').attr('content');
    
    $.ajax({
        url: '{{ url_for("manufatura.gerar_previsao_historico") }}',
        type: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        data: {
            mes: mes,
            ano: ano,
            multiplicador: 1.0
        },
        success: function(response) {
            alert(response.mensagem);
            carregarPrevisoes();
        },
        error: function() {
            alert('Erro ao gerar previsões');
        }
    });
}

function gerarPlanoMestre() {
    if (!confirm('Gerar Plano Mestre de Produção para o período selecionado?')) return;
    
    var mes = $('#filtro-mes').val();
    var ano = $('#filtro-ano').val();
    
    $.post('{{ url_for("manufatura.gerar_plano_mestre") }}', {
        mes: mes,
        ano: ano
    })
    .done(function(response) {
        alert('Plano Mestre gerado com sucesso!');
        window.location.href = '{{ url_for("manufatura.plano_mestre") }}?mes=' + mes + '&ano=' + ano;
    })
    .fail(function() {
        alert('Erro ao gerar plano mestre');
    });
}

function carregarGrupos() {
    // Implementar carregamento de grupos empresariais
}
</script>
{% endblock %}