{% extends 'base.html' %}

{% block extra_css %}
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
{% endblock %}

{% block content %}

<div class="container mt-4">
  <h4>üîé Consulta de V√≠nculos</h4>

  <!-- ===============================
       1) BOT√ïES DE REGI√ïES + ESTADOS
     =============================== -->
  <div class="mb-3 d-flex gap-2">
    <!-- NORTE -->
    <div class="btn-group">
      <button type="button" class="btn btn-sm btn-dark dropdown-toggle" data-bs-toggle="dropdown">Norte</button>
      <ul class="dropdown-menu">        
        <li><a class="dropdown-item" href="?uf=AC">AC</a></li>
        <li><a class="dropdown-item" href="?uf=AM">AM</a></li>
        <li><a class="dropdown-item" href="?uf=AP">AP</a></li>
        <li><a class="dropdown-item" href="?uf=PA">PA</a></li>
        <li><a class="dropdown-item" href="?uf=RO">RO</a></li>
        <li><a class="dropdown-item" href="?uf=RR">RR</a></li>
        <li><a class="dropdown-item" href="?uf=TO">TO</a></li>
      </ul>
    </div>

    <!-- NORDESTE -->
    <div class="btn-group">
      <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown">Nordeste</button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="?uf=AL">AL</a></li>
        <li><a class="dropdown-item" href="?uf=BA">BA</a></li>
        <li><a class="dropdown-item" href="?uf=CE">CE</a></li>
        <li><a class="dropdown-item" href="?uf=MA">MA</a></li>
        <li><a class="dropdown-item" href="?uf=PB">PB</a></li>
        <li><a class="dropdown-item" href="?uf=PE">PE</a></li>
        <li><a class="dropdown-item" href="?uf=PI">PI</a></li>
        <li><a class="dropdown-item" href="?uf=RN">RN</a></li>
        <li><a class="dropdown-item" href="?uf=SE">SE</a></li>
      </ul>
    </div>

    <!-- CENTRO-OESTE -->
    <div class="btn-group">
      <button type="button" class="btn btn-sm btn-success dropdown-toggle" data-bs-toggle="dropdown">C.Oeste</button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="?uf=DF">DF</a></li>
        <li><a class="dropdown-item" href="?uf=GO">GO</a></li>
        <li><a class="dropdown-item" href="?uf=MS">MS</a></li>
        <li><a class="dropdown-item" href="?uf=MT">MT</a></li>
      </ul>
    </div>

    <!-- SUDESTE -->
    <div class="btn-group">
      <button type="button" class="btn btn-sm btn-warning dropdown-toggle" data-bs-toggle="dropdown">Sudeste</button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="?uf=ES">ES</a></li>
        <li><a class="dropdown-item" href="?uf=MG">MG</a></li>
        <li><a class="dropdown-item" href="?uf=RJ">RJ</a></li>
        <li><a class="dropdown-item" href="?uf=SP">SP</a></li>
      </ul>
    </div>

    <!-- SUL -->
    <div class="btn-group">
      <button type="button" class="btn btn-sm btn-info dropdown-toggle" data-bs-toggle="dropdown">Sul</button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="?uf=PR">PR</a></li>
        <li><a class="dropdown-item" href="?uf=RS">RS</a></li>
        <li><a class="dropdown-item" href="?uf=SC">SC</a></li>
      </ul>
    </div>
  </div>

  <!-- ===============================
       2) FILTRO COM FORM PADR√ÉO
     =============================== -->
  <form method="GET" class="card p-3 shadow-sm mb-4">
    <div class="row g-2">
      <div class="col-md-2">{{ form.razao_social.label }}{{ form.razao_social(class="form-control") }}</div>
      <div class="col-md-2">{{ form.cnpj.label }}{{ form.cnpj(class="form-control") }}</div>
      <div class="col-md-1">{{ form.uf.label }}{{ form.uf(class="form-control") }}</div>
      <div class="col-md-2">{{ form.cidade.label }}{{ form.cidade(class="form-control") }}</div>
      <div class="col-md-2">{{ form.codigo_ibge.label }}{{ form.codigo_ibge(class="form-control") }}</div>
      <div class="col-md-2">{{ form.nome_tabela.label }}{{ form.nome_tabela(class="form-control") }}</div>
      <div class="col-md-1 d-grid">{{ form.submit(class="btn btn-primary") }}</div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-md-3">
        <label class="form-label">Status do V√≠nculo</label>
        <select name="status" class="form-select">
          <option value="">Todos os Status</option>
          <option value="ok" {% if request.args.get('status') == 'ok' %}selected{% endif %}>‚úÖ OK</option>
          <option value="orfa" {% if request.args.get('status') == 'orfa' %}selected{% endif %}>‚ùå √ìrf√£o</option>
          <option value="grupo_empresarial" {% if request.args.get('status') == 'grupo_empresarial' %}selected{% endif %}>üîÑ Grupo Empresarial</option>
        </select>
      </div>
      <div class="col-md-3">
        <div class="form-check mt-4">
          <input class="form-check-input" type="checkbox" name="apenas_orfaos" value="1" 
                 {% if request.args.get('apenas_orfaos') %}checked{% endif %}>
          <label class="form-check-label">
            üö® Apenas V√≠nculos √ìrf√£os
          </label>
        </div>
      </div>
    </div>
  </form>

  {% if registros %}
  <div class="d-flex justify-content-end mb-3 gap-2">
    <!-- Bot√£o Apenas Exportar -->
    <form method="POST" action="{{ url_for('vinculos.exportar_vinculos') }}">
      {{ form.csrf_token }}
      <button type="submit" class="btn btn-info btn-sm">‚¨áÔ∏è Exportar ({{ paginacao.total }})</button>
    </form>

  </div>

  <!-- Tabela de Resultados -->
  <div class="table-responsive">
    <table class="table table-sm table-hover table-striped">
      <thead>
        <tr class="text-center">
          <th>ID</th>
          <th>Status</th>
          <th>Transportadora</th>
          <th>Cidade</th>
          <th>UF</th>
          <th>IBGE</th>
          <th>Tabela</th>
          <th>Lead Time</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for v in paginacao.items %}
        <tr class="text-center">
          <td>{{ v.id }}</td>
          <td>
            <span class="badge badge-{{ v.status_cor }}">
              {{ v.status_texto }}
            </span>
          </td>
          <td>{{ v.transportadora.razao_social }}</td>
          <td>{{ v.cidade.nome }}</td>
          <td>{{ v.cidade.uf }}</td>
          <td>{{ v.cidade.codigo_ibge }}</td>
          <td>{{ v.nome_tabela }}</td>
          <td>{{ v.lead_time or '' }}</td>
          <td class="d-flex justify-content-center gap-1">
            <!-- Bot√£o que abre modal de edi√ß√£o -->
            <button class="btn btn-sm btn-outline-primary" onclick="abrirModalEditar('{{ v.id }}', '{{ v.transportadora.razao_social }}', '{{ v.transportadora.cnpj }}', '{{ v.cidade.uf }}', '{{ v.cidade.nome }}', '{{ v.cidade.codigo_ibge }}', '{{ v.nome_tabela }}', '{{ v.lead_time or '' }}')">
              Editar
            </button>

            <!-- Bot√£o para excluir com SweetAlert2 -->
            <button type="button" class="btn btn-sm btn-outline-danger btn-excluir-vinculo"
                    data-vinculo-id="{{ v.id }}"
                    data-transportadora="{{ v.transportadora.razao_social }}"
                    data-cidade="{{ v.cidade.nome }}">
              Excluir
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagina√ß√£o -->
  <div class="d-flex justify-content-center mt-3">
    <nav>
      <ul class="pagination">
        <!-- << primeira p√°gina -->
        {% set first_args = request.args.copy() %}
        {% set _ignore = first_args.pop('page', None) %}
        <li class="page-item {% if paginacao.page <= 1 %}disabled{% endif %}">
          <a class="page-link" href="?{{ first_args|urlencode }}" aria-label="Primeira">&laquo;</a>
        </li>

        <!-- < anterior -->
        {% set prev_args = request.args.copy() %}
        {% set _ignore = prev_args.pop('page', None) %}
        {% if paginacao.has_prev %}
          {% set _ignore = prev_args.update({'page': paginacao.prev_num}) %}
        {% endif %}
        <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
          <a class="page-link" href="?{{ prev_args|urlencode }}">&lt;</a>
        </li>

        <!-- P√°ginas -->
        {% for page_num in paginacao.iter_pages(left_edge=2, left_current=2, right_current=2, right_edge=2) %}
          {% if page_num %}
            {% set page_args = request.args.copy() %}
            {% set _ignore = page_args.pop('page', None) %}
            {% set _ignore = page_args.update({'page': page_num}) %}
            <li class="page-item {% if page_num == paginacao.page %}active{% endif %}">
              <a class="page-link" href="?{{ page_args|urlencode }}">{{ page_num }}</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
          {% endif %}
        {% endfor %}

        <!-- > pr√≥xima -->
        {% set next_args = request.args.copy() %}
        {% set _ignore = next_args.pop('page', None) %}
        {% if paginacao.has_next %}
          {% set _ignore = next_args.update({'page': paginacao.next_num}) %}
        {% endif %}
        <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
          <a class="page-link" href="?{{ next_args|urlencode }}">&gt;</a>
        </li>

        <!-- >> √∫ltima p√°gina -->
        {% set last_args = request.args.copy() %}
        {% set _ignore = last_args.pop('page', None) %}
        {% set _ignore = last_args.update({'page': paginacao.pages}) %}
        <li class="page-item {% if paginacao.page >= paginacao.pages %}disabled{% endif %}">
          <a class="page-link" href="?{{ last_args|urlencode }}" aria-label="√öltima">&raquo;</a>
        </li>
      </ul>
    </nav>
  </div>

  <!-- Contador de Registros -->
  <div class="text-center mt-2">
    <small class="text-muted">
      Exibindo registros {{ (paginacao.page - 1) * paginacao.per_page + 1 }}
      ao {{ (paginacao.page - 1) * paginacao.per_page + paginacao.items|length }}
      de {{ paginacao.total }} no total
    </small>
  </div>

  {% else %}
  <div class="alert alert-warning">Nenhum v√≠nculo encontrado.</div>
  {% endif %}
</div>

<!-- Modal de Edi√ß√£o -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‚úèÔ∏è Editar V√≠nculo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('vinculos.editar_vinculo') }}">
        {{ editar_form.csrf_token }}
        {{ editar_form.vinculo_id }}
        
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">ID do V√≠nculo</label>
            <input type="text" id="visual_id_vinculo" class="form-control" readonly>
          </div>
          
          <div class="mb-3">
            {{ editar_form.razao_social.label(class="form-label") }}
            {{ editar_form.razao_social(class="form-control", id="edit_razao_social") }}
          </div>
          
          <div class="mb-3">
            {{ editar_form.cnpj.label(class="form-label") }}
            {{ editar_form.cnpj(class="form-control", id="edit_cnpj", readonly=true) }}
          </div>
          
          <div class="row mb-3">
            <div class="col-md-2">
              {{ editar_form.uf.label(class="form-label") }}
              {{ editar_form.uf(class="form-control", id="edit_uf") }}
            </div>
            <div class="col-md-10">
              {{ editar_form.cidade.label(class="form-label") }}
              {{ editar_form.cidade(class="form-control", id="edit_cidade") }}
            </div>
          </div>
          
          <div class="mb-3">
            {{ editar_form.codigo_ibge.label(class="form-label") }}
            {{ editar_form.codigo_ibge(class="form-control", id="edit_codigo_ibge") }}
          </div>
          
          <div class="mb-3">
            {{ editar_form.nome_tabela.label(class="form-label") }}
            {{ editar_form.nome_tabela(class="form-control", id="edit_nome_tabela") }}
          </div>
          
          <div class="mb-3">
            {{ editar_form.lead_time.label(class="form-label") }}
            {{ editar_form.lead_time(class="form-control", id="edit_lead_time") }}
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          {{ editar_form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Script para abrir o Modal de Edi√ß√£o -->
<script>
function abrirModalEditar(id, razao, cnpj, uf, cidade, ibge, tabela, lead) {
  // Preencher o hidden vinculo_id corretamente
  var hiddenIdField = document.getElementsByName('vinculo_id')[0];
  if (hiddenIdField) {
    hiddenIdField.value = id;
  }

  // Preencher o campo visual do ID para o usu√°rio ver
  document.getElementById('visual_id_vinculo').value = id;

  // Preencher os outros campos
  document.getElementById('edit_razao_social').value = razao;
  document.getElementById('edit_cnpj').value = cnpj;
  document.getElementById('edit_uf').value = uf;
  document.getElementById('edit_cidade').value = cidade;
  document.getElementById('edit_codigo_ibge').value = ibge;
  document.getElementById('edit_nome_tabela').value = tabela;
  document.getElementById('edit_lead_time').value = lead;

  // Abrir o modal
  var modal = new bootstrap.Modal(document.getElementById('modalEditar'));
  modal.show();
}

// Script para excluir v√≠nculo com SweetAlert2 (AJAX - sem reload)
document.addEventListener('DOMContentLoaded', function() {
    const botoesExcluir = document.querySelectorAll('.btn-excluir-vinculo');

    botoesExcluir.forEach(function(botao) {
        botao.addEventListener('click', function() {
            const vinculoId = this.dataset.vinculoId;
            const transportadora = this.dataset.transportadora;
            const cidade = this.dataset.cidade;
            const linhaTabela = this.closest('tr'); // Pega a linha da tabela

            Swal.fire({
                title: 'Excluir V√≠nculo?',
                html: `
                    <p><strong>ID:</strong> ${vinculoId}</p>
                    <p><strong>Transportadora:</strong> ${transportadora}</p>
                    <p><strong>Cidade:</strong> ${cidade}</p>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    // Fazer requisi√ß√£o AJAX
                    return fetch(`/vinculos/excluir_vinculo/${vinculoId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: `csrf_token={{ csrf_token() }}`
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro ao excluir v√≠nculo');
                        }
                        return response;
                    })
                    .catch(error => {
                        Swal.showValidationMessage(`Erro: ${error.message}`);
                    });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    // Anima√ß√£o suave de fade out na linha
                    linhaTabela.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                    linhaTabela.style.opacity = '0';
                    linhaTabela.style.transform = 'translateX(-20px)';

                    // Remover linha ap√≥s anima√ß√£o
                    setTimeout(() => {
                        linhaTabela.remove();
                    }, 500);

                    // Toast de sucesso
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'V√≠nculo exclu√≠do com sucesso!',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                }
            });
        });
    });
});
</script>
{% endblock %}
