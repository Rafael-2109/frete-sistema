{% extends 'base.html' %}

{% block title %}Dashboard - Sistema de Fretes{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
            <p class="mb-0 text-muted">Visão geral do sistema</p>
        </div>
    </div>

    <!-- 🆕 Cards com Dados da API JSON -->
    <div class="row mb-4" id="api-stats-cards">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Embarques Ativos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-embarques">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-truck fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Fretes Aprovados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="fretes-aprovados">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pendências Financeiras
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="pendencias-financeiras">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Entregas Realizadas
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="entregas-realizadas">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shipping-fast fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 🆕 Tabela com Últimos Embarques da API -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Últimos Embarques (via API)</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="recarregarDados()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                </div>
                <div class="card-body">
                    <div id="loading-embarques" class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> Carregando dados da API...
                    </div>
                    <div id="tabela-embarques" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-bordered" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Embarque</th>
                                        <th>Status</th>
                                        <th>Transportadora</th>
                                        <th>Data</th>
                                        <th>Fretes</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-embarques">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- 🆕 Widget de Consulta Rápida -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Consulta Rápida via API</h6>
                </div>
                <div class="card-body">
                    <form id="form-consulta-cliente">
                        <div class="form-group">
                            <label for="cliente-nome">Nome do Cliente:</label>
                            <input type="text" class="form-control" id="cliente-nome" placeholder="Ex: Assai, Carrefour...">
                        </div>
                        <div class="form-group">
                            <label for="cliente-uf">UF (Opcional):</label>
                            <select class="form-control" id="cliente-uf">
                                <option value="">Todas</option>
                                <option value="SP">SP</option>
                                <option value="RJ">RJ</option>
                                <option value="MG">MG</option>
                                <option value="PR">PR</option>
                                <option value="SC">SC</option>
                                <option value="RS">RS</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-search"></i> Consultar
                        </button>
                        <button type="button" class="btn btn-success btn-block mt-2" onclick="downloadExcelCliente()">
                            <i class="fas fa-file-excel"></i> Baixar Excel
                        </button>
                    </form>
                    
                    <div id="resultado-consulta" class="mt-3" style="display: none;">
                        <h6>Resultado:</h6>
                        <div id="dados-cliente"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 🚀 Carrega dados iniciais
    carregarEstatisticas();
    carregarUltimosEmbarques();
    
    // Event listener para consulta de cliente
    document.getElementById('form-consulta-cliente').addEventListener('submit', function(e) {
        e.preventDefault();
        consultarCliente();
    });
});

// 📊 Função para carregar estatísticas via API interna
async function carregarEstatisticas() {
    try {
        const response = await fetch('/api/estatisticas-internas');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.data;
            
            // Atualiza os cards
            document.getElementById('total-embarques').textContent = stats.embarques.ativos;
            document.getElementById('fretes-aprovados').textContent = 
                `${stats.fretes.aprovados} (${stats.fretes.percentual_aprovacao}%)`;
            document.getElementById('pendencias-financeiras').textContent = stats.entregas.pendencias_financeiras;
            document.getElementById('entregas-realizadas').textContent = 
                `${stats.entregas.entregues} (${stats.entregas.percentual_entrega}%)`;
        }
    } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
        // Fallback visual
        document.getElementById('total-embarques').innerHTML = '<span class="text-danger">Erro</span>';
        document.getElementById('fretes-aprovados').innerHTML = '<span class="text-danger">Erro</span>';
        document.getElementById('pendencias-financeiras').innerHTML = '<span class="text-danger">Erro</span>';
        document.getElementById('entregas-realizadas').innerHTML = '<span class="text-danger">Erro</span>';
    }
}

// 📋 Função para carregar últimos embarques via API interna
async function carregarUltimosEmbarques() {
    try {
        const response = await fetch('/api/embarques-internos?limite=8');
        const data = await response.json();
        
        if (data.success) {
            const tbody = document.getElementById('tbody-embarques');
            tbody.innerHTML = '';
            
            data.data.forEach(embarque => {
                const row = `
                    <tr>
                        <td><strong>#${embarque.numero}</strong></td>
                        <td>
                            <span class="badge badge-${embarque.status === 'ativo' ? 'success' : 'secondary'}">
                                ${embarque.status}
                            </span>
                        </td>
                        <td>${embarque.transportadora || 'N/A'}</td>
                        <td>${embarque.data_embarque ? new Date(embarque.data_embarque).toLocaleDateString('pt-BR') : 'N/A'}</td>
                        <td>
                            <span class="badge badge-info">${embarque.total_fretes} fretes</span>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            document.getElementById('loading-embarques').style.display = 'none';
            document.getElementById('tabela-embarques').style.display = 'block';
        }
    } catch (error) {
        console.error('Erro ao carregar embarques:', error);
        document.getElementById('loading-embarques').innerHTML = '<span class="text-danger">Erro ao carregar dados</span>';
    }
}

// 🔍 Função para consultar cliente via API (TEMPORARIAMENTE DESABILITADA)
async function consultarCliente() {
    const nomeCliente = document.getElementById('cliente-nome').value.trim();
    
    if (!nomeCliente) {
        alert('Digite o nome do cliente');
        return;
    }
    
    // Funcionalidade temporariamente desabilitada
    const resultadoDiv = document.getElementById('resultado-consulta');
    const dadosDiv = document.getElementById('dados-cliente');
    
    dadosDiv.innerHTML = `
        <div class="alert alert-warning">
            <i class="fas fa-wrench"></i> 
            <strong>Funcionalidade em manutenção</strong><br>
            A consulta rápida de clientes está temporariamente indisponível.
            Use o menu "Pedidos > Lista de Pedidos" para consultar informações de clientes.
        </div>
    `;
    resultadoDiv.style.display = 'block';
}

// 📥 Função para download de Excel via API (TEMPORARIAMENTE DESABILITADA)
function downloadExcelCliente() {
    alert('Funcionalidade temporariamente indisponível. Use o menu "Relatórios" para exportar dados.');
}

// 🔄 Função para recarregar todos os dados
function recarregarDados() {
    carregarEstatisticas();
    carregarUltimosEmbarques();
}

// 🔄 Auto-refresh a cada 5 minutos
setInterval(function() {
    carregarEstatisticas();
    carregarUltimosEmbarques();
}, 5 * 60 * 1000);
</script>

{% endblock %}
