{% extends 'base.html' %}

{% block title %}Dashboard - Sistema de Fretes{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
            <p class="mb-0 text-muted">Vis√£o geral do sistema</p>
        </div>
    </div>

    <!-- üÜï Cards com Dados da API JSON -->
    <div class="row mb-4" id="api-stats-cards">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Embarques Pendentes
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-embarques">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-truck fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Fretes Pendentes
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="fretes-pendentes">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Pedidos Abertos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="pedidos-abertos">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Entregas Pendentes
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="entregas-pendentes">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-truck-loading fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üè≠ CARTEIRA & PRODU√á√ÉO - Novos M√≥dulos Implementados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow border-left-success">
                <div
                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-gradient-success">
                    <h6 class="m-0 font-weight-bold text-black">üè≠ Carteira & Produ√ß√£o</h6>
                    <div>
                        <span class="badge bg-light">‚úÖ 6 M√ìDULOS</span>
                        <span class="badge bg-warning ms-1">NOVO</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="text-dark mb-2">Sistema Completo de Gest√£o</h5>
                            <p class="text-muted mb-3">
                                Acesse os <strong>6 novos m√≥dulos</strong> para gest√£o completa da carteira de pedidos,
                                produ√ß√£o, estoque, faturamento e rotas de entrega.
                            </p>
                            <div class="row">
                                <div class="col-md-4">
                                    <ul class="list-unstyled text-sm">
                                        <li><i class="fas fa-check text-success"></i> Faturamento por Produto</li>
                                        <li><i class="fas fa-check text-success"></i> Programa√ß√£o de Produ√ß√£o</li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <ul class="list-unstyled text-sm">
                                        <li><i class="fas fa-check text-success"></i> Movimenta√ß√£o de Estoque</li>
                                        <li><i class="fas fa-check text-success"></i> Cadastro de Palletiza√ß√£o</li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <ul class="list-unstyled text-sm">
                                        <li><i class="fas fa-check text-success"></i> Cadastro de Rotas</li>
                                        <li><i class="fas fa-check text-success"></i> Cadastro de Sub-rotas</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="mb-3">
                                <i class="fas fa-industry fa-3x text-success mb-2"></i>
                                <p class="text-muted small">Sistema Integrado</p>
                            </div>
                            <div class="btn-group-vertical w-100" role="group">
                                <a href="{{ url_for('carteira.index') }}" class="btn btn-success btn-sm">
                                    <i class="fas fa-clipboard-list"></i> üìã Carteira de Pedidos
                                </a>
                                <a href="{{ url_for('producao.index') }}" class="btn btn-success btn-sm">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard Produ√ß√£o
                                </a>
                                <a href="{{ url_for('estoque.index') }}" class="btn btn-info btn-sm">
                                    <i class="fas fa-warehouse"></i> Dashboard Estoque
                                </a>
                                <a href="{{ url_for('faturamento.listar_faturamento_produtos') }}"
                                    class="btn btn-primary btn-sm">
                                    <i class="fas fa-receipt"></i> Faturamento por Produto
                                </a>
                                <button type="button" class="btn btn-outline-success btn-sm"
                                    onclick="mostrarModulosCarteira()">
                                    <i class="fas fa-list"></i> Ver Todos os M√≥dulos
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista completa oculta inicialmente -->
                    <div id="modulos-carteira" class="mt-4" style="display: none;">
                        <hr>
                        <h6 class="text-success mb-3">üìã Acesso R√°pido aos 6 M√≥dulos:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-primary mb-3">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">üìã Carteira</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="list-group list-group-flush">
                                            <a href="{{ url_for('carteira.listar_pedidos_agrupados') }}"
                                                class="list-group-item list-group-item-action py-2">
                                                <i class="fas fa-layer-group text-warning"></i> Carteira Agrupada
                                                <span class="badge bg-success ml-2">NOVO</span>
                                            </a>
                                            <!-- Links removidos - funcionalidades desativadas ap√≥s limpeza carteira -->
                                        </div>
                                    </div>
                                </div>

                                <div class="card border-success mb-3">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">üè≠ Produ√ß√£o</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="list-group list-group-flush">
                                            <a href="{{ url_for('producao.listar_programacao') }}"
                                                class="list-group-item list-group-item-action py-2">
                                                <i class="fas fa-calendar-check text-primary"></i> Programa√ß√£o de
                                                Produ√ß√£o
                                            </a>
                                            <a href="{{ url_for('producao.listar_palletizacao') }}"
                                                class="list-group-item list-group-item-action py-2">
                                                <i class="fas fa-cubes text-warning"></i> Cadastro de Palletiza√ß√£o
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="card border-info mb-3">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">üì¶ Estoque</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="list-group list-group-flush">
                                            <a href="{{ url_for('estoque.listar_movimentacoes') }}"
                                                class="list-group-item list-group-item-action py-2">
                                                <i class="fas fa-exchange-alt text-info"></i> Movimenta√ß√µes de Estoque
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-dark mb-3">
                                    <div class="card-header bg-dark text-white">
                                        <h6 class="mb-0">üí∞ Faturamento</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="list-group list-group-flush">
                                            <a href="{{ url_for('faturamento.listar_faturamento_produtos') }}"
                                                class="list-group-item list-group-item-action py-2">
                                                <i class="fas fa-receipt text-success"></i> Faturamento por Produto
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="card border-warning mb-3">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">üó∫Ô∏è Rotas</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="list-group list-group-flush">
                                            <a href="{{ url_for('localidades.listar_rotas') }}"
                                                class="list-group-item list-group-item-action py-2">
                                                <i class="fas fa-route text-warning"></i> Cadastro de Rotas
                                            </a>
                                            <a href="{{ url_for('localidades.listar_sub_rotas') }}"
                                                class="list-group-item list-group-item-action py-2">
                                                <i class="fas fa-map-marker-alt text-danger"></i> Cadastro de Sub-rotas
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('carteira.index') }}" class="btn btn-primary">
                                    üìã Dashboard Carteira
                                </a>
                                <a href="{{ url_for('producao.index') }}" class="btn btn-success">
                                    üìä Dashboard Produ√ß√£o
                                </a>
                                <a href="{{ url_for('estoque.index') }}" class="btn btn-info">
                                    üìä Dashboard Estoque
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üÜï Tabela com √öltimos Embarques da API -->
    <div class="row">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">√öltimos Embarques (via API)</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="recarregarDados()">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
            </div>
            <div class="card-body">
                <div id="loading-embarques" class="text-center">
                    <i class="fas fa-spinner fa-spin"></i> Carregando dados da API...
                </div>
                <div id="tabela-embarques" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-bordered" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Embarque</th>
                                    <th>Status</th>
                                    <th>Transportadora</th>
                                    <th>Data Prevista</th>
                                    <th>Data de Embarque</th>
                                    <th>Tipo de Carga</th>
                                    <th>Modalidade</th>
                                    <th>Valor Total</th>
                                    <th>Pallet Total</th>
                                    <th>Peso Total</th>
                                    <th>Fretes</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-embarques">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // üöÄ Carrega dados iniciais
        carregarEstatisticas();
        carregarUltimosEmbarques();

        // Event listener para consulta de cliente
        document.getElementById('form-consulta-cliente').addEventListener('submit', function (e) {
            e.preventDefault();
            consultarCliente();
        });
    });

    // üìä Fun√ß√£o para carregar estat√≠sticas via API interna
    async function carregarEstatisticas() {
        try {
            const response = await fetch('/api/estatisticas-internas');
            const data = await response.json();

            if (data.success) {
                const stats = data.data;

                // Atualiza os cards
                // Embarques pendentes (sem data de embarque)
                document.getElementById('total-embarques').textContent = stats.embarques.pendentes || '0';

                // Fretes pendentes
                document.getElementById('fretes-pendentes').textContent = stats.fretes.pendentes_aprovacao || '0';

                // Pedidos abertos - ser√° calculado na API
                document.getElementById('pedidos-abertos').textContent = stats.pedidos?.abertos || '0';

                // Entregas pendentes (j√° vem calculado da API)
                document.getElementById('entregas-pendentes').textContent = stats.entregas.pendentes || '0';
            }
        } catch (error) {
            console.error('Erro ao carregar estat√≠sticas:', error);
            // Fallback visual
            document.getElementById('total-embarques').innerHTML = '<span class="text-danger">Erro</span>';
            document.getElementById('fretes-pendentes').innerHTML = '<span class="text-danger">Erro</span>';
            document.getElementById('pedidos-abertos').innerHTML = '<span class="text-danger">Erro</span>';
            document.getElementById('entregas-pendentes').innerHTML = '<span class="text-danger">Erro</span>';
        }
    }

    // üìã Fun√ß√£o para carregar √∫ltimos embarques via API interna
    async function carregarUltimosEmbarques() {
        try {
            const response = await fetch('/api/embarques-internos?limite=8');
            const data = await response.json();

            if (data.success) {
                const tbody = document.getElementById('tbody-embarques');
                tbody.innerHTML = '';

                data.data.forEach(embarque => {
                    const row = `
                    <tr>
                        <td><strong>#${embarque.numero}</strong></td>
                        <td>
                            <span class="badge bg-${embarque.status === 'ativo' ? 'success' : 'secondary'}">
                                ${embarque.status}
                            </span>
                        </td>
                        <td>${embarque.transportadora || 'N/A'}</td>
                        <td>${embarque.data_prevista_embarque ? new Date(embarque.data_prevista_embarque).toLocaleDateString('pt-BR') : '-'}</td>
                        <td>${embarque.data_embarque ? new Date(embarque.data_embarque).toLocaleDateString('pt-BR') : '-'}</td>
                        <td>${embarque.tipo_carga}</td>
                        <td>${embarque.modalidade}</td>
                        <td>${embarque.valor_total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                        <td>${embarque.pallet_total.toFixed(2)}</td>
                        <td>${embarque.peso_total.toFixed(0)}</td>
                        <td>${embarque.total_fretes} fretes</td>
                    </tr>
                `;
                    tbody.innerHTML += row;
                });

                document.getElementById('loading-embarques').style.display = 'none';
                document.getElementById('tabela-embarques').style.display = 'block';
            }
        } catch (error) {
            console.error('Erro ao carregar embarques:', error);
            document.getElementById('loading-embarques').innerHTML = '<span class="text-danger">Erro ao carregar dados</span>';
        }
    }

    // üîç Fun√ß√£o para consultar cliente via API (TEMPORARIAMENTE DESABILITADA)
    async function consultarCliente() {
        const nomeCliente = document.getElementById('cliente-nome').value.trim();

        if (!nomeCliente) {
            alert('Digite o nome do cliente');
            return;
        }

        // Funcionalidade temporariamente desabilitada
        const resultadoDiv = document.getElementById('resultado-consulta');
        const dadosDiv = document.getElementById('dados-cliente');

        dadosDiv.innerHTML = `
        <div class="alert alert-warning">
            <i class="fas fa-wrench"></i> 
            <strong>Funcionalidade em manuten√ß√£o</strong><br>
            A consulta r√°pida de clientes est√° temporariamente indispon√≠vel.
            Use o menu "Pedidos > Lista de Pedidos" para consultar informa√ß√µes de clientes.
        </div>
    `;
        resultadoDiv.style.display = 'block';
    }

    // üì• Fun√ß√£o para download de Excel via API (TEMPORARIAMENTE DESABILITADA)
    function downloadExcelCliente() {
        alert('Funcionalidade temporariamente indispon√≠vel. Use o menu "Relat√≥rios" para exportar dados.');
    }

    // üîÑ Fun√ß√£o para recarregar todos os dados
    function recarregarDados() {
        carregarEstatisticas();
        carregarUltimosEmbarques();
    }

    // üîÑ Auto-refresh a cada 5 minutos
    setInterval(function () {
        carregarEstatisticas();
        carregarUltimosEmbarques();
    }, 5 * 60 * 1000);

    // ü§ñ Fun√ß√£o para mostrar/ocultar exemplos MCP
    function mostrarExemplos() {
        const exemploDiv = document.getElementById('exemplos-mcp');
        const botao = event.target;

        if (exemploDiv.style.display === 'none') {
            exemploDiv.style.display = 'block';
            botao.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar Exemplos';

            // Scroll suave para os exemplos
            exemploDiv.scrollIntoView({ behavior: 'smooth' });
        } else {
            exemploDiv.style.display = 'none';
            botao.innerHTML = '<i class="fas fa-lightbulb"></i> Ver Exemplos';
        }
    }

    // üè≠ Fun√ß√£o para mostrar/ocultar m√≥dulos da carteira
    function mostrarModulosCarteira() {
        const modulosDiv = document.getElementById('modulos-carteira');
        const botao = event.target;

        if (modulosDiv.style.display === 'none') {
            modulosDiv.style.display = 'block';
            botao.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar M√≥dulos';

            // Scroll suave para os m√≥dulos
            modulosDiv.scrollIntoView({ behavior: 'smooth' });
        } else {
            modulosDiv.style.display = 'none';
            botao.innerHTML = '<i class="fas fa-list"></i> Ver Todos os M√≥dulos';
        }
    }
</script>

{% endblock %}