{% extends 'base.html' %}

{% block title %}Dashboard - Sistema de Fretes{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
            <p class="mb-0 text-muted">Vis√£o geral do sistema</p>
        </div>
    </div>

    <!-- üÜï Cards com Dados da API JSON -->
    <div class="row mb-4" id="api-stats-cards">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Embarques Ativos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-embarques">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-truck fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Fretes Aprovados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="fretes-aprovados">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pend√™ncias Financeiras
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="pendencias-financeiras">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Entregas Realizadas
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="entregas-realizadas">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shipping-fast fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ü§ñ Se√ß√£o MCP v4.0 - NOVA -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow border-left-dark">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-gradient-dark text-white">
                    <h6 class="m-0 font-weight-bold">ü§ñ Claude AI - MCP v4.0</h6>
                    <div>
                        <span class="badge badge-success">‚úÖ ATIVO</span>
                        <span class="badge badge-info ms-1">11 Ferramentas</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="text-dark mb-2">Sistema Inteligente Avan√ßado</h5>
                            <p class="text-muted mb-3">
                                Consulte dados em <strong>linguagem natural</strong>, detecte anomalias, analise tend√™ncias e otimize rotas usando intelig√™ncia artificial conectada aos dados reais do sistema.
                            </p>
                            <div class="row">
                                <div class="col-sm-6 mb-2">
                                    <span class="badge badge-primary mr-1">üìä An√°lise de Tend√™ncias</span>
                                    <span class="badge badge-success mr-1">üîç Detec√ß√£o de Anomalias</span>
                                </div>
                                <div class="col-sm-6 mb-2">
                                    <span class="badge badge-warning mr-1">üó∫Ô∏è Otimiza√ß√£o de Rotas</span>
                                    <span class="badge badge-info mr-1">üí∞ Previs√£o de Custos</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="mb-3">
                                <i class="fas fa-robot fa-3x text-primary mb-2"></i>
                                <p class="text-muted small">NLP com 90% precis√£o</p>
                            </div>
                            <div class="btn-group-vertical w-100" role="group">
                                <a href="/claude-ai/v4/dashboard" class="btn btn-primary btn-sm">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard v4.0
                                </a>
                                <a href="/claude-ai/chat" class="btn btn-success btn-sm">
                                    <i class="fas fa-comments"></i> Chat Inteligente
                                </a>
                                <a href="/claude-ai/real" class="btn btn-warning btn-sm">
                                    <i class="fas fa-brain"></i> Claude REAL (Beta)
                                </a>
                                <button type="button" class="btn btn-info btn-sm" onclick="mostrarExemplos()">
                                    <i class="fas fa-lightbulb"></i> Ver Exemplos
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exemplos ocultos inicialmente -->
                    <div id="exemplos-mcp" class="mt-4" style="display: none;">
                        <hr>
                        <h6 class="text-primary mb-3">üí¨ Exemplos de Consultas em Linguagem Natural:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="bg-light p-3 rounded mb-2">
                                    <strong>"Como est√£o os fretes do Assai em SP?"</strong>
                                    <br><small class="text-muted">‚Üí Consulta inteligente por cliente e UF</small>
                                </div>
                                <div class="bg-light p-3 rounded mb-2">
                                    <strong>"Detectar problemas nos custos"</strong>
                                    <br><small class="text-muted">‚Üí An√°lise autom√°tica de anomalias</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="bg-light p-3 rounded mb-2">
                                    <strong>"An√°lise de tend√™ncias dos √∫ltimos 30 dias"</strong>
                                    <br><small class="text-muted">‚Üí Analytics avan√ßado com dados reais</small>
                                </div>
                                <div class="bg-light p-3 rounded mb-2">
                                    <strong>"Otimizar rotas para RJ e MG"</strong>
                                    <br><small class="text-muted">‚Üí Otimiza√ß√£o baseada em hist√≥rico</small>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <a href="/claude-ai/v4/dashboard" class="btn btn-primary">
                                üöÄ Testar Agora
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üÜï Tabela com √öltimos Embarques da API -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">√öltimos Embarques (via API)</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="recarregarDados()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                </div>
                <div class="card-body">
                    <div id="loading-embarques" class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> Carregando dados da API...
                    </div>
                    <div id="tabela-embarques" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-bordered" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Embarque</th>
                                        <th>Status</th>
                                        <th>Transportadora</th>
                                        <th>Data</th>
                                        <th>Fretes</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-embarques">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- ü§ñ Link r√°pido para MCP v4.0 -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">ü§ñ Claude AI - MCP v4.0</h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Acesse o sistema inteligente com processamento de linguagem natural avan√ßado.
                    </p>
                    
                    <div class="mb-3">
                        <strong>üí¨ Exemplos de consultas:</strong>
                        <ul class="mt-2 text-sm">
                            <li>"Status do sistema"</li>
                            <li>"Transportadoras cadastradas"</li>
                            <li>"An√°lise de tend√™ncias"</li>
                            <li>"Embarques ativos"</li>
                        </ul>
                    </div>
                    
                    <div class="btn-group-vertical w-100">
                        <a href="/claude-ai/v4/dashboard" class="btn btn-primary btn-sm">
                            <i class="fas fa-tachometer-alt"></i> Dashboard v4.0
                        </a>
                        <a href="/claude-ai/chat" class="btn btn-success btn-sm">
                            <i class="fas fa-comments"></i> Chat Inteligente
                        </a>
                        <a href="/claude-ai/real" class="btn btn-warning btn-sm">
                            <i class="fas fa-brain"></i> Claude REAL (Beta)
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // üöÄ Carrega dados iniciais
    carregarEstatisticas();
    carregarUltimosEmbarques();
    
    // Event listener para consulta de cliente
    document.getElementById('form-consulta-cliente').addEventListener('submit', function(e) {
        e.preventDefault();
        consultarCliente();
    });
});

// üìä Fun√ß√£o para carregar estat√≠sticas via API interna
async function carregarEstatisticas() {
    try {
        const response = await fetch('/api/estatisticas-internas');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.data;
            
            // Atualiza os cards
            document.getElementById('total-embarques').textContent = stats.embarques.ativos;
            document.getElementById('fretes-aprovados').textContent = 
                `${stats.fretes.aprovados} (${stats.fretes.percentual_aprovacao}%)`;
            document.getElementById('pendencias-financeiras').textContent = stats.entregas.pendencias_financeiras;
            document.getElementById('entregas-realizadas').textContent = 
                `${stats.entregas.entregues} (${stats.entregas.percentual_entrega}%)`;
        }
    } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
        // Fallback visual
        document.getElementById('total-embarques').innerHTML = '<span class="text-danger">Erro</span>';
        document.getElementById('fretes-aprovados').innerHTML = '<span class="text-danger">Erro</span>';
        document.getElementById('pendencias-financeiras').innerHTML = '<span class="text-danger">Erro</span>';
        document.getElementById('entregas-realizadas').innerHTML = '<span class="text-danger">Erro</span>';
    }
}

// üìã Fun√ß√£o para carregar √∫ltimos embarques via API interna
async function carregarUltimosEmbarques() {
    try {
        const response = await fetch('/api/embarques-internos?limite=8');
        const data = await response.json();
        
        if (data.success) {
            const tbody = document.getElementById('tbody-embarques');
            tbody.innerHTML = '';
            
            data.data.forEach(embarque => {
                const row = `
                    <tr>
                        <td><strong>#${embarque.numero}</strong></td>
                        <td>
                            <span class="badge badge-${embarque.status === 'ativo' ? 'success' : 'secondary'}">
                                ${embarque.status}
                            </span>
                        </td>
                        <td>${embarque.transportadora || 'N/A'}</td>
                        <td>${embarque.data_embarque ? new Date(embarque.data_embarque).toLocaleDateString('pt-BR') : 'N/A'}</td>
                        <td>
                            <span class="badge badge-info">${embarque.total_fretes} fretes</span>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            document.getElementById('loading-embarques').style.display = 'none';
            document.getElementById('tabela-embarques').style.display = 'block';
        }
    } catch (error) {
        console.error('Erro ao carregar embarques:', error);
        document.getElementById('loading-embarques').innerHTML = '<span class="text-danger">Erro ao carregar dados</span>';
    }
}

// üîç Fun√ß√£o para consultar cliente via API (TEMPORARIAMENTE DESABILITADA)
async function consultarCliente() {
    const nomeCliente = document.getElementById('cliente-nome').value.trim();
    
    if (!nomeCliente) {
        alert('Digite o nome do cliente');
        return;
    }
    
    // Funcionalidade temporariamente desabilitada
    const resultadoDiv = document.getElementById('resultado-consulta');
    const dadosDiv = document.getElementById('dados-cliente');
    
    dadosDiv.innerHTML = `
        <div class="alert alert-warning">
            <i class="fas fa-wrench"></i> 
            <strong>Funcionalidade em manuten√ß√£o</strong><br>
            A consulta r√°pida de clientes est√° temporariamente indispon√≠vel.
            Use o menu "Pedidos > Lista de Pedidos" para consultar informa√ß√µes de clientes.
        </div>
    `;
    resultadoDiv.style.display = 'block';
}

// üì• Fun√ß√£o para download de Excel via API (TEMPORARIAMENTE DESABILITADA)
function downloadExcelCliente() {
    alert('Funcionalidade temporariamente indispon√≠vel. Use o menu "Relat√≥rios" para exportar dados.');
}

// üîÑ Fun√ß√£o para recarregar todos os dados
function recarregarDados() {
    carregarEstatisticas();
    carregarUltimosEmbarques();
}

// üîÑ Auto-refresh a cada 5 minutos
setInterval(function() {
    carregarEstatisticas();
    carregarUltimosEmbarques();
}, 5 * 60 * 1000);

// ü§ñ Fun√ß√£o para mostrar/ocultar exemplos MCP
function mostrarExemplos() {
    const exemploDiv = document.getElementById('exemplos-mcp');
    const botao = event.target;
    
    if (exemploDiv.style.display === 'none') {
        exemploDiv.style.display = 'block';
        botao.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar Exemplos';
        
        // Scroll suave para os exemplos
        exemploDiv.scrollIntoView({ behavior: 'smooth' });
    } else {
        exemploDiv.style.display = 'none';
        botao.innerHTML = '<i class="fas fa-lightbulb"></i> Ver Exemplos';
    }
}
</script>

{% endblock %}
