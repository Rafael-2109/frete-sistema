{% extends 'base.html' %}

{% block title %}Agente Log√≠stico - Claude Agent SDK{% endblock %}

{% block extra_css %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<!-- DESIGN-001: Agent Theme (Deep Ocean) - Carrega ANTES do chat.css -->
<link rel="stylesheet" href="{{ url_for('static', filename='agente/css/agent-theme.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='agente/css/chat.css') }}">
<!-- FEAT-023: Highlight.js para syntax highlighting -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css">
{% endblock %}

{% block content %}
<!-- FEAT-025: Layout Fullscreen -->
<div class="chat-fullscreen-wrapper">
    <div class="chat-container">
        <!-- Header Compacto -->
        <div class="chat-header">
            <div class="chat-header-left">
                <!-- Bot√£o de Sess√µes -->
                <button class="btn-sessions" onclick="openSessionsModal()" title="Conversas anteriores">
                    <i class="fas fa-comments"></i>
                    <span class="sessions-count-badge" id="sessions-count-badge" style="display: none;">0</span>
                </button>
                <div class="chat-title">
                    <h5>Nacom Goya IA</h5>
                    <small id="model-display">Claude Agent SDK ‚Ä¢ Sonnet</small>
                </div>
            </div>

            <div class="chat-header-center">
                <!-- FEAT-001: Seletor de Modelo com Tooltip -->
                <div class="header-control has-tooltip">
                    <select id="model-selector" class="model-select">
                        <option value="claude-haiku-4-5-20251001">‚ö° Haiku</option>
                        <option value="claude-sonnet-4-5-20250929" selected>‚ö°‚ö° Sonnet</option>
                        <option value="claude-opus-4-5-20251101">üß† Opus</option>
                    </select>
                    <div class="control-tooltip">
                        <strong>Escolha o Modelo</strong>
                        <ul>
                            <li><b>‚ö° Haiku:</b> R√°pido e econ√¥mico</li>
                            <li><b>‚ö°‚ö° Sonnet:</b> Equilibrado (recomendado)</li>
                            <li><b>üß† Opus:</b> Mais potente</li>
                        </ul>
                    </div>
                </div>

                <!-- FEAT-002: Toggle Thinking com Tooltip -->
                <div class="header-control has-tooltip">
                    <label class="toggle-switch">
                        <input type="checkbox" id="thinking-toggle">
                        <span class="toggle-slider"></span>
                        <i class="fas fa-brain toggle-icon"></i>
                    </label>
                    <div class="control-tooltip">
                        <strong><i class="fas fa-brain"></i> Pensamento Profundo</strong>
                        <p>Quando ativado, o agente analisa mais antes de responder.</p>
                        <small>Ideal para decis√µes complexas.</small>
                    </div>
                </div>

                <!-- FEAT-010: Toggle Plan Mode com Tooltip -->
                <div class="header-control has-tooltip">
                    <label class="toggle-switch plan">
                        <input type="checkbox" id="plan-mode-toggle">
                        <span class="toggle-slider"></span>
                        <i class="fas fa-clipboard-list toggle-icon"></i>
                    </label>
                    <div class="control-tooltip">
                        <strong><i class="fas fa-clipboard-list"></i> Modo Planejamento</strong>
                        <p>Apenas analisa e sugere, sem executar a√ß√µes.</p>
                        <small>Use para revisar antes de confirmar.</small>
                    </div>
                </div>
            </div>

            <div class="chat-header-right">
                <!-- FEAT-004: Budget de Tokens (Admin) -->
                {% if current_user.perfil == 'administrador' %}
                <div class="token-budget-mini" id="token-budget" style="display: none;">
                    <span class="token-count" id="token-total" title="Tokens usados">0</span>
                    <span class="token-cost" id="token-cost" title="Custo USD">$0.00</span>
                </div>
                {% endif %}

                <!-- DESIGN-001: Toggle de Tema Dark/Light -->
                <button class="theme-toggle" onclick="toggleAgentTheme()" title="Alternar tema">
                    <i class="fas fa-sun theme-toggle__icon theme-toggle__icon--light"></i>
                    <i class="fas fa-moon theme-toggle__icon theme-toggle__icon--dark"></i>
                </button>

                <span class="status-indicator online" title="Online">
                    <i class="fas fa-circle"></i>
                </span>

                <!-- Menu de op√ß√µes -->
                <div class="dropdown">
                    <button class="btn-menu" data-bs-toggle="dropdown" title="Op√ß√µes">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="openSessionsModal()">
                            <i class="fas fa-comments me-2"></i>Conversas
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="startNewSession()">
                            <i class="fas fa-plus me-2"></i>Nova Conversa
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="toggleTimeline()">
                            <i class="fas fa-history me-2"></i>Timeline
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="clearSession()">
                            <i class="fas fa-eraser me-2"></i>Limpar
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="showHelp()">
                            <i class="fas fa-question-circle me-2"></i>Ajuda
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- FEAT-009: Barra de Progresso -->
        <div id="progress-bar-container" class="progress-bar-container" style="display: none;">
            <div class="progress-bar-info">
                <span id="progress-status">Processando...</span>
                <span id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%"></div>
            </div>
        </div>

        <!-- √Årea de Mensagens -->
        <div class="chat-messages" id="chat-messages">
            <!-- Mensagem de boas-vindas -->
            <div class="message assistant">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        <h6>üëã Ol√°! Sou o Agente Nacom Goya</h6>
                        <p>Posso ajudar voc√™ com:</p>
                        <ul>
                            <li>üì¶ Consultar pedidos e status</li>
                            <li>üìä Analisar disponibilidade de estoque</li>
                            <li>üöõ Calcular prazos de entrega</li>
                            <li>‚úÖ Criar separa√ß√µes de pedidos</li>
                        </ul>
                        <p><strong>Como posso ajudar?</strong></p>
                    </div>
                    <div class="message-time">Agora</div>
                </div>
            </div>
        </div>

        <!-- Indicador de digita√ß√£o -->
        <div id="typing-container" class="typing-container" style="display: none;">
            <div class="message assistant">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="typing-indicator">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                    <span class="typing-text" id="typing-text">Pensando...</span>
                </div>
            </div>
        </div>

        <!-- FEAT-003: Painel de Thinking -->
        <div id="thinking-panel" class="thinking-panel" style="display: none;">
            <div class="thinking-content">
                <div class="thinking-header">
                    <span class="thinking-label">
                        <i class="fas fa-brain me-1"></i>
                        <span id="thinking-status">Pensando...</span>
                    </span>
                    <button class="btn-minimize" onclick="toggleThinkingPanel()" title="Minimizar">
                        <i class="fas fa-chevron-up" id="thinking-toggle-icon"></i>
                    </button>
                </div>
                <div class="thinking-body" id="thinking-text"></div>
            </div>
        </div>

        <!-- FEAT-028: √Årea de Arquivos -->
        <div id="files-panel" class="files-panel" style="display: none;">
            <!-- Arquivos Anexados (upload do usu√°rio) -->
            <div class="files-section attachments-section" id="attachments-section" style="display: none;">
                <div class="files-section-header">
                    <span><i class="fas fa-paperclip me-1"></i>Anexos</span>
                    <button class="btn-clear-files" onclick="clearAttachments()" title="Remover todos">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="files-list" id="attachments-list"></div>
            </div>
            <!-- Downloads Dispon√≠veis (gerados pelo agente) -->
            <div class="files-section downloads-section" id="downloads-section" style="display: none;">
                <div class="files-section-header">
                    <span><i class="fas fa-download me-1"></i>Downloads</span>
                    <button class="btn-clear-files" onclick="clearDownloads()" title="Limpar">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="files-list" id="downloads-list"></div>
            </div>
        </div>

        <!-- Input com Textarea e Bot√£o Stop -->
        <div class="chat-input">
            <form id="chat-form">
                <!-- FEAT-028: Input file oculto -->
                <input type="file" id="file-input" multiple accept=".pdf,.xlsx,.xls,.csv,.png,.jpg,.jpeg,.gif" style="display: none;">

                <!-- FEAT-028: Bot√£o Anexar -->
                <button type="button" class="btn-attach" onclick="document.getElementById('file-input').click()" title="Anexar arquivo (PDF, Excel, CSV, Imagens)">
                    <i class="fas fa-paperclip"></i>
                </button>

                <textarea
                    id="message-input"
                    placeholder="Digite sua pergunta... (Enter envia, Shift+Enter nova linha)"
                    maxlength="2000"
                    rows="1"
                    autocomplete="off"
                ></textarea>
                <div class="input-actions">
                    <!-- Bot√£o Stop (vis√≠vel durante processamento) -->
                    <button type="button" id="stop-btn" class="btn-stop" style="display: none;" onclick="stopGeneration()" title="Parar gera√ß√£o">
                        <i class="fas fa-stop"></i>
                    </button>
                    <!-- Bot√£o Enviar -->
                    <button type="submit" id="send-btn" disabled title="Enviar (Enter)">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
            <div class="input-hint">
                <small>Enter envia ‚Ä¢ Shift+Enter nova linha</small>
            </div>
        </div>
    </div>
</div>

<!-- FEAT-025: Modal de Sess√µes -->
<div id="sessions-modal" class="sessions-modal" style="display: none;">
    <div class="sessions-modal-backdrop" onclick="closeSessionsModal()"></div>
    <div class="sessions-modal-content">
        <div class="sessions-modal-header">
            <h5><i class="fas fa-comments me-2"></i>Conversas</h5>
            <button class="btn-close-modal" onclick="closeSessionsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sessions-modal-actions">
            <button class="btn-new-session" onclick="startNewSession(); closeSessionsModal();">
                <i class="fas fa-plus me-2"></i>Nova Conversa
            </button>
        </div>
        <div class="sessions-modal-body">
            <div id="sessions-list" class="sessions-list">
                <div class="sessions-loading" id="sessions-loading">
                    <i class="fas fa-spinner fa-spin me-2"></i>Carregando...
                </div>
                <div class="sessions-empty" id="sessions-empty" style="display: none;">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Nenhuma conversa ainda</p>
                    <small class="text-muted">Suas conversas aparecer√£o aqui</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirma√ß√£o -->
<div id="confirmation-overlay" class="confirmation-overlay" style="display: none;">
    <div class="confirmation-modal">
        <h5>‚ö†Ô∏è Confirmar A√ß√£o</h5>
        <p id="confirmation-message">Deseja executar esta a√ß√£o?</p>
        <div class="confirmation-buttons">
            <button class="btn-cancel" onclick="cancelAction()">Cancelar</button>
            <button class="btn-confirm" onclick="confirmAction()">Confirmar</button>
        </div>
    </div>
</div>

<!-- FEAT-006: Timeline de A√ß√µes (flutuante) -->
<div id="action-timeline" class="action-timeline-container hidden">
    <div class="timeline-header">
        <span class="timeline-header-title"><i class="fas fa-history"></i>A√ß√µes</span>
        <span class="badge bg-light text-dark" id="action-count">0</span>
        <button class="btn-close-panel" onclick="hideTimeline()" title="Fechar">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="timeline-body" id="timeline-body">
        <div class="timeline-empty" id="timeline-empty">
            <i class="fas fa-clock fa-2x mb-2"></i>
            <p class="mb-0">Nenhuma a√ß√£o ainda</p>
        </div>
        <div id="timeline-items"></div>
    </div>
</div>

<!-- FEAT-008: Todo List Visual (flutuante) -->
<div id="todo-panel" class="todo-panel-container hidden">
    <div class="todo-header">
        <span class="todo-header-title"><i class="fas fa-tasks"></i>Tarefas</span>
        <span class="badge bg-light text-success" id="todo-progress-badge">0%</span>
        <button class="btn-close-panel" onclick="hideTodoPanel()" title="Fechar">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="todo-body">
        <ul id="todo-list" class="todo-list"></ul>
    </div>
    <div class="todo-progress-container">
        <div class="todo-progress">
            <div class="todo-progress-bar" id="todo-progress-bar" style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- FEAT-023: Markdown Avan√ßado - Bibliotecas -->
<script src="https://cdn.jsdelivr.net/npm/marked@13.0.0/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
<script src="{{ url_for('static', filename='agente/js/chat.js') }}"></script>

<!-- DESIGN-001: Theme Management -->
<script>
/**
 * Agent Theme Manager
 * Gerencia dark/light mode com persist√™ncia em localStorage
 */

// Inicializa tema ao carregar a p√°gina
(function initAgentTheme() {
    const savedTheme = localStorage.getItem('agent-theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');

    document.documentElement.setAttribute('data-theme', theme);

    // Tamb√©m sincroniza com data-bs-theme para compatibilidade Bootstrap
    document.documentElement.setAttribute('data-bs-theme', theme);

    console.log('[THEME] Inicializado:', theme);
})();

/**
 * Alterna entre dark e light mode
 */
function toggleAgentTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme') || 'dark';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    // Aplica o novo tema
    html.setAttribute('data-theme', newTheme);
    html.setAttribute('data-bs-theme', newTheme);

    // Persiste no localStorage
    localStorage.setItem('agent-theme', newTheme);

    console.log('[THEME] Alterado para:', newTheme);
}

// Escuta mudan√ßas na prefer√™ncia do sistema (se usu√°rio n√£o tiver escolhido)
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem('agent-theme')) {
        const newTheme = e.matches ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        document.documentElement.setAttribute('data-bs-theme', newTheme);
        console.log('[THEME] Sistema alterou para:', newTheme);
    }
});
</script>
{% endblock %}
