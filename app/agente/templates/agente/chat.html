{% extends 'base.html' %}

{% block title %}Agente Log√≠stico - Claude Agent SDK{% endblock %}

{% block extra_css %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<!-- DESIGN-001: Agent Theme (Deep Ocean) - Carrega ANTES do chat.css -->
<link rel="stylesheet" href="{{ url_for('static', filename='agente/css/agent-theme.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='agente/css/chat.css') }}">
<!-- FEAT-023: Highlight.js para syntax highlighting -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css">
{% endblock %}

{% block content %}
<!-- FEAT-025: Layout Fullscreen -->
<div class="chat-fullscreen-wrapper">
    <div class="chat-container">
        <!-- Header Compacto -->
        <div class="chat-header">
            <div class="chat-header-left">
                <!-- Bot√£o de Sess√µes -->
                <button class="btn-sessions" onclick="openSessionsModal()" title="Conversas anteriores">
                    <i class="fas fa-comments"></i>
                    <span class="sessions-count-badge" id="sessions-count-badge" style="display: none;">0</span>
                </button>
                <div class="chat-title">
                    <h5>Nacom Goya IA</h5>
                    <small id="model-display">Claude Agent SDK ‚Ä¢ Sonnet</small>
                </div>
            </div>

            <div class="chat-header-center">
                <!-- FEAT-001: Seletor de Modelo com Tooltip -->
                <div class="header-control has-tooltip">
                    <select id="model-selector" class="model-select">
                        <option value="claude-haiku-4-5-20251001">‚ö° Haiku</option>
                        <option value="claude-sonnet-4-5-20250929" selected>‚ö°‚ö° Sonnet</option>
                        <option value="claude-opus-4-5-20251101">üß† Opus</option>
                    </select>
                    <div class="control-tooltip">
                        <strong>Escolha o Modelo</strong>
                        <ul>
                            <li><b>‚ö° Haiku:</b> R√°pido e econ√¥mico</li>
                            <li><b>‚ö°‚ö° Sonnet:</b> Equilibrado (recomendado)</li>
                            <li><b>üß† Opus:</b> Mais potente</li>
                        </ul>
                    </div>
                </div>

                <!-- FEAT-002: Toggle Thinking com Tooltip -->
                <div class="header-control has-tooltip">
                    <label class="toggle-switch">
                        <input type="checkbox" id="thinking-toggle">
                        <span class="toggle-slider"></span>
                        <i class="fas fa-brain toggle-icon"></i>
                    </label>
                    <div class="control-tooltip">
                        <strong><i class="fas fa-brain"></i> Pensamento Profundo</strong>
                        <p>Quando ativado, o agente analisa mais antes de responder.</p>
                        <small>Ideal para decis√µes complexas.</small>
                    </div>
                </div>

                <!-- FEAT-010: Toggle Plan Mode com Tooltip -->
                <div class="header-control has-tooltip">
                    <label class="toggle-switch plan">
                        <input type="checkbox" id="plan-mode-toggle">
                        <span class="toggle-slider"></span>
                        <i class="fas fa-clipboard-list toggle-icon"></i>
                    </label>
                    <div class="control-tooltip">
                        <strong><i class="fas fa-clipboard-list"></i> Modo Planejamento</strong>
                        <p>Apenas analisa e sugere, sem executar a√ß√µes.</p>
                        <small>Use para revisar antes de confirmar.</small>
                    </div>
                </div>
            </div>

            <div class="chat-header-right">
                <!-- FEAT-004: Budget de Tokens (Admin) - FIX: Elementos DOM completos -->
                {% if current_user.perfil == 'administrador' %}
                <div class="token-budget-container" id="token-budget" style="display: none;">
                    <div class="token-budget-stats">
                        <span class="token-stat">
                            <i class="fas fa-arrow-down"></i>
                            <span id="token-input" title="Tokens de entrada">0</span>
                        </span>
                        <span class="token-stat">
                            <i class="fas fa-arrow-up"></i>
                            <span id="token-output" title="Tokens de sa√≠da">0</span>
                        </span>
                        <span class="token-stat total">
                            <span class="token-count" id="token-total" title="Total de tokens">0</span>
                        </span>
                        <span class="token-cost" id="token-cost" title="Custo USD">$0.00</span>
                    </div>
                    <div class="token-budget-bar">
                        <div class="token-progress-bar" id="token-progress-bar" style="width: 0%"></div>
                    </div>
                    <span class="token-percentage" id="token-percentage">0%</span>
                </div>
                {% endif %}

                <!-- DESIGN-001: Toggle de Tema Dark/Light -->
                <button class="theme-toggle" onclick="toggleAgentTheme()" title="Alternar tema">
                    <i class="fas fa-sun theme-toggle__icon theme-toggle__icon--light"></i>
                    <i class="fas fa-moon theme-toggle__icon theme-toggle__icon--dark"></i>
                </button>

                <span class="status-indicator online" title="Online">
                    <i class="fas fa-circle"></i>
                </span>

                <!-- Menu de op√ß√µes -->
                <div class="dropdown">
                    <button class="btn-menu" data-bs-toggle="dropdown" title="Op√ß√µes">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="openSessionsModal()">
                            <i class="fas fa-comments me-2"></i>Conversas
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="startNewSession()">
                            <i class="fas fa-plus me-2"></i>Nova Conversa
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="toggleTimeline()">
                            <i class="fas fa-history me-2"></i>Timeline
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="clearSession()">
                            <i class="fas fa-eraser me-2"></i>Limpar
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <!-- SPRINT-4: Exportar conversa -->
                        <li><a class="dropdown-item" href="#" onclick="exportConversation('markdown')">
                            <i class="fas fa-file-alt me-2"></i>Exportar Markdown
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportConversation('pdf')">
                            <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <!-- SPRINT-4: Favoritos -->
                        <li><a class="dropdown-item" href="#" onclick="toggleFavoritesView()">
                            <i class="fas fa-star me-2"></i>Ver Favoritos
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="showHelp()">
                            <i class="fas fa-question-circle me-2"></i>Ajuda
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- FEAT-009: Barra de Progresso -->
        <div id="progress-bar-container" class="progress-bar-container" style="display: none;">
            <div class="progress-bar-info">
                <span id="progress-status">Processando...</span>
                <span id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%"></div>
            </div>
        </div>

        <!-- √Årea de Mensagens -->
        <div class="chat-messages" id="chat-messages">
            <!-- Mensagem de boas-vindas -->
            <div class="message assistant">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        <h6>üëã Ol√°! Sou o Agente Nacom Goya</h6>
                        <p>Posso ajudar voc√™ com:</p>
                        <ul>
                            <li>üì¶ Consultar pedidos e status</li>
                            <li>üìä Analisar disponibilidade de estoque</li>
                            <li>üöõ Calcular prazos de entrega</li>
                            <li>‚úÖ Criar separa√ß√µes de pedidos</li>
                        </ul>
                        <p><strong>Como posso ajudar?</strong></p>
                    </div>
                    <div class="message-time">Agora</div>
                </div>
            </div>
        </div>

        <!-- Indicador de digita√ß√£o -->
        <div id="typing-container" class="typing-container" style="display: none;">
            <div class="message assistant">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="typing-indicator">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                    <span class="typing-text" id="typing-text">Pensando...</span>
                </div>
            </div>
        </div>

        <!-- FEAT-003: Painel de Thinking -->
        <div id="thinking-panel" class="thinking-panel" style="display: none;">
            <div class="thinking-content">
                <div class="thinking-header">
                    <span class="thinking-label">
                        <i class="fas fa-brain me-1"></i>
                        <span id="thinking-status">Pensando...</span>
                    </span>
                    <button class="btn-minimize" onclick="toggleThinkingPanel()" title="Minimizar">
                        <i class="fas fa-chevron-up" id="thinking-toggle-icon"></i>
                    </button>
                </div>
                <div class="thinking-body" id="thinking-text"></div>
            </div>
        </div>

        <!-- FEAT-028: √Årea de Arquivos -->
        <div id="files-panel" class="files-panel" style="display: none;">
            <!-- Arquivos Anexados (upload do usu√°rio) -->
            <div class="files-section attachments-section" id="attachments-section" style="display: none;">
                <div class="files-section-header">
                    <span><i class="fas fa-paperclip me-1"></i>Anexos</span>
                    <button class="btn-clear-files" onclick="clearAttachments()" title="Remover todos">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="files-list" id="attachments-list"></div>
            </div>
            <!-- Downloads Dispon√≠veis (gerados pelo agente) -->
            <div class="files-section downloads-section" id="downloads-section" style="display: none;">
                <div class="files-section-header">
                    <span><i class="fas fa-download me-1"></i>Downloads</span>
                    <button class="btn-clear-files" onclick="clearDownloads()" title="Limpar">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="files-list" id="downloads-list"></div>
            </div>
        </div>

        <!-- Input com Textarea e Bot√£o Stop -->
        <div class="chat-input">
            <form id="chat-form">
                <!-- FEAT-028: Input file oculto -->
                <input type="file" id="file-input" multiple accept=".pdf,.xlsx,.xls,.csv,.png,.jpg,.jpeg,.gif" style="display: none;">

                <!-- FEAT-028: Bot√£o Anexar -->
                <button type="button" class="btn-attach" onclick="document.getElementById('file-input').click()" title="Anexar arquivo (PDF, Excel, CSV, Imagens)">
                    <i class="fas fa-paperclip"></i>
                </button>

                <!-- SPRINT-4: Bot√£o Voice Input -->
                <button type="button" class="btn-voice" id="voice-btn" onclick="toggleVoiceInput()" title="Entrada por voz (clique para falar)">
                    <i class="fas fa-microphone" id="voice-icon"></i>
                </button>

                <textarea
                    id="message-input"
                    placeholder="Digite sua pergunta... (Enter envia, Shift+Enter nova linha)"
                    maxlength="2000"
                    rows="1"
                    autocomplete="off"
                ></textarea>
                <div class="input-actions">
                    <!-- Bot√£o Stop (vis√≠vel durante processamento) -->
                    <button type="button" id="stop-btn" class="btn-stop" style="display: none;" onclick="stopGeneration()" title="Parar gera√ß√£o">
                        <i class="fas fa-stop"></i>
                    </button>
                    <!-- Bot√£o Enviar -->
                    <button type="submit" id="send-btn" disabled title="Enviar (Enter)">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
            <div class="input-hint">
                <small>Enter envia ‚Ä¢ Shift+Enter nova linha</small>
            </div>
        </div>
    </div>
</div>

<!-- FEAT-025: Modal de Sess√µes -->
<div id="sessions-modal" class="sessions-modal" style="display: none;">
    <div class="sessions-modal-backdrop" onclick="closeSessionsModal()"></div>
    <div class="sessions-modal-content">
        <div class="sessions-modal-header">
            <h5><i class="fas fa-comments me-2"></i>Conversas</h5>
            <button class="btn-close-modal" onclick="closeSessionsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sessions-modal-actions">
            <button class="btn-new-session" onclick="startNewSession(); closeSessionsModal();">
                <i class="fas fa-plus me-2"></i>Nova Conversa
            </button>
        </div>
        <div class="sessions-modal-body">
            <div id="sessions-list" class="sessions-list">
                <div class="sessions-loading" id="sessions-loading">
                    <i class="fas fa-spinner fa-spin me-2"></i>Carregando...
                </div>
                <div class="sessions-empty" id="sessions-empty" style="display: none;">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Nenhuma conversa ainda</p>
                    <small class="text-muted">Suas conversas aparecer√£o aqui</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirma√ß√£o -->
<div id="confirmation-overlay" class="confirmation-overlay" style="display: none;">
    <div class="confirmation-modal">
        <h5>‚ö†Ô∏è Confirmar A√ß√£o</h5>
        <p id="confirmation-message">Deseja executar esta a√ß√£o?</p>
        <div class="confirmation-buttons">
            <button class="btn-cancel" onclick="cancelAction()">Cancelar</button>
            <button class="btn-confirm" onclick="confirmAction()">Confirmar</button>
        </div>
    </div>
</div>

<!-- FEAT-006: Timeline de A√ß√µes (flutuante) -->
<div id="action-timeline" class="action-timeline-container hidden">
    <div class="timeline-header">
        <span class="timeline-header-title"><i class="fas fa-history"></i>A√ß√µes</span>
        <span class="badge bg-light text-dark" id="action-count">0</span>
        <button class="btn-close-panel" onclick="hideTimeline()" title="Fechar">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="timeline-body" id="timeline-body">
        <div class="timeline-empty" id="timeline-empty">
            <i class="fas fa-clock fa-2x mb-2"></i>
            <p class="mb-0">Nenhuma a√ß√£o ainda</p>
        </div>
        <div id="timeline-items"></div>
    </div>
</div>

<!-- FEAT-008: Todo List Visual (flutuante) -->
<div id="todo-panel" class="todo-panel-container hidden">
    <div class="todo-header">
        <span class="todo-header-title"><i class="fas fa-tasks"></i>Tarefas</span>
        <span class="badge bg-light text-success" id="todo-progress-badge">0%</span>
        <button class="btn-close-panel" onclick="hideTodoPanel()" title="Fechar">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="todo-body">
        <ul id="todo-list" class="todo-list"></ul>
    </div>
    <div class="todo-progress-container">
        <div class="todo-progress">
            <div class="todo-progress-bar" id="todo-progress-bar" style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- FEAT-023: Markdown Avan√ßado - Bibliotecas -->
<script src="https://cdn.jsdelivr.net/npm/marked@13.0.0/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
<script src="{{ url_for('static', filename='agente/js/chat.js') }}"></script>

<!-- DESIGN-001: Theme Management + FIX P3.1: Preferences Persistence -->
<script>
/**
 * Agent Preferences Manager
 * Gerencia tema, modelo, thinking e plan mode com persist√™ncia em localStorage
 */

// Chaves do localStorage
const STORAGE_KEYS = {
    theme: 'agent-theme',
    model: 'agent-model',
    thinking: 'agent-thinking',
    planMode: 'agent-plan-mode'
};

// ============================================
// TEMA (Dark/Light)
// ============================================
(function initAgentTheme() {
    const savedTheme = localStorage.getItem(STORAGE_KEYS.theme);
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');

    document.documentElement.setAttribute('data-theme', theme);
    document.documentElement.setAttribute('data-bs-theme', theme);

    console.log('[PREFS] Tema inicializado:', theme);
})();

function toggleAgentTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme') || 'dark';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    html.setAttribute('data-theme', newTheme);
    html.setAttribute('data-bs-theme', newTheme);
    localStorage.setItem(STORAGE_KEYS.theme, newTheme);

    console.log('[PREFS] Tema alterado para:', newTheme);
}

window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem(STORAGE_KEYS.theme)) {
        const newTheme = e.matches ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        document.documentElement.setAttribute('data-bs-theme', newTheme);
        console.log('[PREFS] Sistema alterou tema para:', newTheme);
    }
});

// ============================================
// FIX P3.1: MODELO, THINKING, PLAN MODE
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // --- Restaurar Modelo ---
    const modelSelector = document.getElementById('model-selector');
    const savedModel = localStorage.getItem(STORAGE_KEYS.model);
    if (modelSelector && savedModel) {
        // Verifica se o modelo salvo existe nas op√ß√µes
        const optionExists = Array.from(modelSelector.options).some(opt => opt.value === savedModel);
        if (optionExists) {
            modelSelector.value = savedModel;
            // Atualiza vari√°vel global do chat.js
            if (typeof currentModel !== 'undefined') {
                currentModel = savedModel;
            }
            // Dispara evento change para atualizar display
            modelSelector.dispatchEvent(new Event('change'));
            console.log('[PREFS] Modelo restaurado:', savedModel);
        }
    }

    // Salvar modelo quando alterado
    if (modelSelector) {
        modelSelector.addEventListener('change', function() {
            localStorage.setItem(STORAGE_KEYS.model, this.value);
            console.log('[PREFS] Modelo salvo:', this.value);
        });
    }

    // --- Restaurar Thinking Toggle ---
    const thinkingToggle = document.getElementById('thinking-toggle');
    const savedThinking = localStorage.getItem(STORAGE_KEYS.thinking);
    if (thinkingToggle && savedThinking !== null) {
        const isEnabled = savedThinking === 'true';
        thinkingToggle.checked = isEnabled;
        // Atualiza vari√°vel global do chat.js
        if (typeof thinkingEnabled !== 'undefined') {
            thinkingEnabled = isEnabled;
        }
        console.log('[PREFS] Thinking restaurado:', isEnabled);
    }

    // Salvar thinking quando alterado
    if (thinkingToggle) {
        thinkingToggle.addEventListener('change', function() {
            localStorage.setItem(STORAGE_KEYS.thinking, this.checked.toString());
            console.log('[PREFS] Thinking salvo:', this.checked);
        });
    }

    // --- Restaurar Plan Mode Toggle ---
    const planModeToggle = document.getElementById('plan-mode-toggle');
    const savedPlanMode = localStorage.getItem(STORAGE_KEYS.planMode);
    if (planModeToggle && savedPlanMode !== null) {
        const isEnabled = savedPlanMode === 'true';
        planModeToggle.checked = isEnabled;
        // Atualiza vari√°vel global do chat.js
        if (typeof planModeEnabled !== 'undefined') {
            planModeEnabled = isEnabled;
        }
        console.log('[PREFS] Plan Mode restaurado:', isEnabled);
    }

    // Salvar plan mode quando alterado
    if (planModeToggle) {
        planModeToggle.addEventListener('change', function() {
            localStorage.setItem(STORAGE_KEYS.planMode, this.checked.toString());
            console.log('[PREFS] Plan Mode salvo:', this.checked);
        });
    }

    console.log('[PREFS] Preferencias carregadas com sucesso');

    // ============================================
    // P3.2: ATALHOS DE TECLADO
    // ============================================
    document.addEventListener('keydown', function(e) {
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
        const cmdOrCtrl = isMac ? e.metaKey : e.ctrlKey;

        // Cmd/Ctrl + K: Abrir modal de sess√µes
        if (cmdOrCtrl && e.key === 'k') {
            e.preventDefault();
            if (typeof openSessionsModal === 'function') {
                openSessionsModal();
            }
            console.log('[KEYS] Cmd+K: Abrir sess√µes');
        }

        // Cmd/Ctrl + N: Nova sess√£o
        if (cmdOrCtrl && e.key === 'n') {
            e.preventDefault();
            if (typeof startNewSession === 'function') {
                startNewSession();
            }
            console.log('[KEYS] Cmd+N: Nova sess√£o');
        }

        // Cmd/Ctrl + Enter: Enviar mensagem (alternativo)
        if (cmdOrCtrl && e.key === 'Enter') {
            const textarea = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            if (document.activeElement === textarea && sendBtn && !sendBtn.disabled) {
                e.preventDefault();
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        }

        // Esc: Fechar modais
        if (e.key === 'Escape') {
            // Fechar modal de sess√µes
            const sessionsModal = document.getElementById('sessions-modal');
            if (sessionsModal && sessionsModal.style.display !== 'none') {
                if (typeof closeSessionsModal === 'function') {
                    closeSessionsModal();
                }
                console.log('[KEYS] Esc: Fechar modal sess√µes');
                return;
            }

            // Fechar modal de confirma√ß√£o
            const confirmModal = document.getElementById('confirmation-overlay');
            if (confirmModal && confirmModal.style.display !== 'none') {
                if (typeof cancelAction === 'function') {
                    cancelAction();
                }
                console.log('[KEYS] Esc: Fechar modal confirma√ß√£o');
                return;
            }

            // Fechar timeline
            const timeline = document.getElementById('action-timeline');
            if (timeline && !timeline.classList.contains('hidden')) {
                if (typeof hideTimeline === 'function') {
                    hideTimeline();
                }
                console.log('[KEYS] Esc: Fechar timeline');
                return;
            }

            // Fechar todo panel
            const todoPanel = document.getElementById('todo-panel');
            if (todoPanel && !todoPanel.classList.contains('hidden')) {
                if (typeof hideTodoPanel === 'function') {
                    hideTodoPanel();
                }
                console.log('[KEYS] Esc: Fechar todo panel');
                return;
            }
        }
    });

    console.log('[KEYS] Atalhos registrados: Cmd/Ctrl+K (sess√µes), Cmd/Ctrl+N (nova), Esc (fechar)');

    // ============================================
    // P3.4: INDICADOR VISUAL DE CONEX√ÉO
    // ============================================
    const statusIndicator = document.querySelector('.status-indicator');
    let connectionStatus = 'online';
    let lastHeartbeat = Date.now();

    function updateConnectionStatus(status) {
        if (!statusIndicator) return;

        connectionStatus = status;
        statusIndicator.className = 'status-indicator ' + status;

        const icon = statusIndicator.querySelector('i');
        if (icon) {
            if (status === 'online') {
                statusIndicator.title = 'Conectado';
                icon.className = 'fas fa-circle';
            } else if (status === 'connecting') {
                statusIndicator.title = 'Reconectando...';
                icon.className = 'fas fa-circle-notch fa-spin';
            } else {
                statusIndicator.title = 'Desconectado';
                icon.className = 'fas fa-exclamation-circle';
            }
        }
    }

    // Verificar conex√£o periodicamente
    function checkConnection() {
        fetch('/agente/api/health', { method: 'GET' })
            .then(response => {
                if (response.ok) {
                    lastHeartbeat = Date.now();
                    if (connectionStatus !== 'online') {
                        updateConnectionStatus('online');
                        console.log('[CONN] Conex√£o restaurada');
                    }
                } else {
                    throw new Error('Health check failed');
                }
            })
            .catch(() => {
                const timeSinceLastHeartbeat = Date.now() - lastHeartbeat;
                if (timeSinceLastHeartbeat > 10000) {
                    updateConnectionStatus('offline');
                    console.log('[CONN] Conex√£o perdida');
                } else if (connectionStatus === 'online') {
                    updateConnectionStatus('connecting');
                    console.log('[CONN] Verificando conex√£o...');
                }
            });
    }

    // Verificar a cada 30 segundos
    setInterval(checkConnection, 30000);

    // Detectar mudan√ßas de rede do navegador
    window.addEventListener('online', () => {
        updateConnectionStatus('connecting');
        checkConnection();
        console.log('[CONN] Navegador: online');
    });

    window.addEventListener('offline', () => {
        updateConnectionStatus('offline');
        console.log('[CONN] Navegador: offline');
    });

    // ============================================
    // P3.6: DRAG & DROP PARA ARQUIVOS
    // ============================================
    const chatContainer = document.querySelector('.chat-container');
    const fileInput = document.getElementById('file-input');
    let dragCounter = 0;

    if (chatContainer && fileInput) {
        // Criar overlay de drop
        const dropOverlay = document.createElement('div');
        dropOverlay.className = 'drop-overlay';
        dropOverlay.innerHTML = `
            <div class="drop-overlay-content">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Solte os arquivos aqui</span>
                <small>PDF, Excel, CSV, Imagens</small>
            </div>
        `;
        chatContainer.appendChild(dropOverlay);

        // Prevenir comportamento padr√£o em todo o documento
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        // Mostrar overlay quando arrastar sobre o chat
        chatContainer.addEventListener('dragenter', (e) => {
            dragCounter++;
            if (e.dataTransfer.types.includes('Files')) {
                dropOverlay.classList.add('active');
            }
        });

        chatContainer.addEventListener('dragleave', () => {
            dragCounter--;
            if (dragCounter === 0) {
                dropOverlay.classList.remove('active');
            }
        });

        chatContainer.addEventListener('dragover', (e) => {
            if (e.dataTransfer.types.includes('Files')) {
                e.dataTransfer.dropEffect = 'copy';
            }
        });

        // Processar arquivos soltos
        chatContainer.addEventListener('drop', (e) => {
            dragCounter = 0;
            dropOverlay.classList.remove('active');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Adicionar arquivos ao input
                const dataTransfer = new DataTransfer();

                // Manter arquivos existentes
                if (fileInput.files) {
                    for (let i = 0; i < fileInput.files.length; i++) {
                        dataTransfer.items.add(fileInput.files[i]);
                    }
                }

                // Adicionar novos arquivos
                for (let i = 0; i < files.length; i++) {
                    dataTransfer.items.add(files[i]);
                }

                fileInput.files = dataTransfer.files;

                // Disparar evento change para processar arquivos
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));

                console.log('[DROP] Arquivos adicionados:', files.length);
            }
        });

        console.log('[DROP] Drag & drop habilitado');
    }
});
</script>

<!-- P3.6: Estilos do Drop Overlay (inline para n√£o precisar editar CSS) -->
<style>
.drop-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 212, 170, 0.1);
    border: 3px dashed var(--agent-accent-primary, #00d4aa);
    border-radius: var(--agent-radius-lg, 16px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
    transition: all 0.3s ease;
}

.drop-overlay.active {
    display: flex;
}

.drop-overlay-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 40px;
    background: var(--agent-bg-secondary, #111d2e);
    border-radius: var(--agent-radius-lg, 16px);
    box-shadow: var(--agent-shadow-xl, 0 20px 40px rgba(0,0,0,0.6));
    animation: dropPulse 1.5s ease-in-out infinite;
}

.drop-overlay-content i {
    font-size: 3rem;
    color: var(--agent-accent-primary, #00d4aa);
}

.drop-overlay-content span {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--agent-text-primary, #f0f6fc);
}

.drop-overlay-content small {
    font-size: 0.8rem;
    color: var(--agent-text-muted, #6e7681);
}

@keyframes dropPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

/* Status indicator styles */
.status-indicator.connecting i {
    color: var(--agent-warning, #f59e0b) !important;
}

.status-indicator.offline i {
    color: var(--agent-danger, #ef4444) !important;
}

/* ============================================
   SPRINT-4: VOICE INPUT STYLES
   ============================================ */
.btn-voice {
    width: 40px;
    height: 40px;
    border-radius: var(--agent-radius-md, 10px);
    border: 1px solid var(--agent-border-color, rgba(240, 246, 252, 0.1));
    background: var(--agent-bg-tertiary, #1a2942);
    color: var(--agent-text-secondary, #8b949e);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.btn-voice:hover {
    background: var(--agent-bg-hover, #243554);
    color: var(--agent-accent-primary, #00d4aa);
    border-color: var(--agent-accent-primary, #00d4aa);
}

.btn-voice.recording {
    background: var(--agent-danger, #ef4444) !important;
    color: white !important;
    border-color: var(--agent-danger, #ef4444) !important;
    animation: voicePulse 1s ease-in-out infinite;
}

.btn-voice.recording i {
    animation: none;
}

.btn-voice:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

@keyframes voicePulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
    50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
}

/* Voice feedback toast */
.voice-feedback {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--agent-bg-secondary, #111d2e);
    color: var(--agent-text-primary, #f0f6fc);
    padding: 12px 24px;
    border-radius: var(--agent-radius-lg, 16px);
    box-shadow: var(--agent-shadow-xl, 0 20px 40px rgba(0,0,0,0.6));
    display: none;
    align-items: center;
    gap: 12px;
    z-index: 1100;
    border: 1px solid var(--agent-border-color, rgba(240, 246, 252, 0.1));
}

.voice-feedback.active {
    display: flex;
    animation: fadeInUp 0.3s ease;
}

.voice-feedback i {
    color: var(--agent-danger, #ef4444);
    font-size: 1.2rem;
}

.voice-feedback .voice-text {
    font-size: 0.9rem;
}

.voice-feedback .voice-transcript {
    font-style: italic;
    color: var(--agent-text-secondary, #8b949e);
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* ============================================
   SPRINT-4: FAVORITE BUTTON STYLES
   ============================================ */
.message-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s ease;
    margin-top: 4px;
}

.message:hover .message-actions {
    opacity: 1;
}

.btn-favorite {
    width: 24px;
    height: 24px;
    border-radius: var(--agent-radius-sm, 6px);
    border: none;
    background: transparent;
    color: var(--agent-text-muted, #6e7681);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    transition: all 0.2s ease;
}

.btn-favorite:hover {
    background: var(--agent-warning-muted, rgba(245, 158, 11, 0.15));
    color: var(--agent-warning, #f59e0b);
}

.btn-favorite.favorited {
    color: var(--agent-warning, #f59e0b);
}

.btn-favorite.favorited i {
    font-weight: 900;
}

/* Favorites view indicator */
.favorites-mode-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--agent-warning-muted, rgba(245, 158, 11, 0.15));
    border-bottom: 1px solid var(--agent-warning, #f59e0b);
    color: var(--agent-warning, #f59e0b);
    font-size: 0.85rem;
}

.favorites-mode-indicator.active {
    display: flex;
}

.favorites-mode-indicator button {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: var(--agent-radius-sm, 6px);
}

.favorites-mode-indicator button:hover {
    background: var(--agent-warning, #f59e0b);
    color: var(--agent-bg-primary, #0a1628);
}

/* Hidden class for non-favorited messages in favorites view */
.message.hidden-by-filter {
    display: none !important;
}
</style>

<!-- SPRINT-4: JavaScript para Voice Input, Export e Favoritos -->
<script>
// ============================================
// VOICE INPUT (Web Speech API)
// ============================================
let recognition = null;
let isRecording = false;

// Verificar suporte
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

function initVoiceInput() {
    const voiceBtn = document.getElementById('voice-btn');

    if (!SpeechRecognition) {
        if (voiceBtn) {
            voiceBtn.disabled = true;
            voiceBtn.title = 'Seu navegador n√£o suporta entrada por voz';
        }
        console.log('[VOICE] Speech Recognition n√£o suportado');
        return;
    }

    recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.continuous = true;
    recognition.interimResults = true;

    recognition.onstart = () => {
        isRecording = true;
        voiceBtn.classList.add('recording');
        voiceBtn.querySelector('i').className = 'fas fa-stop';
        showVoiceFeedback('Ouvindo...', '');
        console.log('[VOICE] Grava√ß√£o iniciada');
    };

    recognition.onresult = (event) => {
        const textarea = document.getElementById('message-input');
        let finalTranscript = '';
        let interimTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }

        // Mostrar transcri√ß√£o em tempo real
        if (interimTranscript) {
            showVoiceFeedback('Ouvindo...', interimTranscript);
        }

        // Adicionar texto final ao textarea
        if (finalTranscript) {
            const currentText = textarea.value;
            const separator = currentText && !currentText.endsWith(' ') ? ' ' : '';
            textarea.value = currentText + separator + finalTranscript;
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            console.log('[VOICE] Transcrito:', finalTranscript);
        }
    };

    recognition.onerror = (event) => {
        console.error('[VOICE] Erro:', event.error);
        stopVoiceInput();

        if (event.error === 'not-allowed') {
            alert('Permiss√£o de microfone negada. Por favor, permita o acesso ao microfone nas configura√ß√µes do navegador.');
        }
    };

    recognition.onend = () => {
        stopVoiceInput();
        console.log('[VOICE] Grava√ß√£o finalizada');
    };

    console.log('[VOICE] Voice input inicializado');
}

function toggleVoiceInput() {
    if (!recognition) {
        alert('Entrada por voz n√£o suportada neste navegador.');
        return;
    }

    if (isRecording) {
        recognition.stop();
    } else {
        recognition.start();
    }
}

function stopVoiceInput() {
    isRecording = false;
    const voiceBtn = document.getElementById('voice-btn');
    if (voiceBtn) {
        voiceBtn.classList.remove('recording');
        voiceBtn.querySelector('i').className = 'fas fa-microphone';
    }
    hideVoiceFeedback();
}

function showVoiceFeedback(status, transcript) {
    let feedback = document.querySelector('.voice-feedback');
    if (!feedback) {
        feedback = document.createElement('div');
        feedback.className = 'voice-feedback';
        feedback.innerHTML = `
            <i class="fas fa-microphone"></i>
            <div>
                <div class="voice-text">${status}</div>
                <div class="voice-transcript">${transcript}</div>
            </div>
        `;
        document.body.appendChild(feedback);
    }

    feedback.querySelector('.voice-text').textContent = status;
    feedback.querySelector('.voice-transcript').textContent = transcript;
    feedback.classList.add('active');
}

function hideVoiceFeedback() {
    const feedback = document.querySelector('.voice-feedback');
    if (feedback) {
        feedback.classList.remove('active');
    }
}

// Inicializar voice input
document.addEventListener('DOMContentLoaded', initVoiceInput);

// ============================================
// EXPORTAR CONVERSA
// ============================================
function exportConversation(format) {
    const messages = document.querySelectorAll('#chat-messages .message');

    if (messages.length <= 1) { // Apenas mensagem de boas-vindas
        alert('N√£o h√° mensagens para exportar.');
        return;
    }

    const conversationData = [];
    const timestamp = new Date().toLocaleString('pt-BR');

    messages.forEach((msg, index) => {
        if (index === 0) return; // Pular mensagem de boas-vindas

        const isUser = msg.classList.contains('user');
        const bubble = msg.querySelector('.message-bubble');
        const time = msg.querySelector('.message-time');

        if (bubble) {
            conversationData.push({
                role: isUser ? 'Usu√°rio' : 'Assistente',
                content: bubble.innerText || bubble.textContent,
                time: time ? time.textContent : ''
            });
        }
    });

    if (format === 'markdown') {
        exportAsMarkdown(conversationData, timestamp);
    } else if (format === 'pdf') {
        exportAsPDF(conversationData, timestamp);
    }
}

function exportAsMarkdown(data, timestamp) {
    let markdown = `# Conversa com Nacom Goya IA\n\n`;
    markdown += `**Exportado em:** ${timestamp}\n\n`;
    markdown += `---\n\n`;

    data.forEach(msg => {
        const icon = msg.role === 'Usu√°rio' ? 'üë§' : 'ü§ñ';
        markdown += `### ${icon} ${msg.role}\n`;
        if (msg.time) markdown += `*${msg.time}*\n\n`;
        markdown += `${msg.content}\n\n`;
        markdown += `---\n\n`;
    });

    // Download do arquivo
    const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `conversa-nacom-${Date.now()}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    console.log('[EXPORT] Markdown exportado');
}

function exportAsPDF(data, timestamp) {
    // Criar HTML para o PDF
    let html = `
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                body {
                    font-family: 'Segoe UI', Arial, sans-serif;
                    padding: 40px;
                    max-width: 800px;
                    margin: 0 auto;
                    color: #1f2328;
                    line-height: 1.6;
                }
                h1 {
                    color: #00a88a;
                    border-bottom: 2px solid #00a88a;
                    padding-bottom: 10px;
                }
                .meta {
                    color: #57606a;
                    font-size: 0.9em;
                    margin-bottom: 30px;
                }
                .message {
                    margin: 20px 0;
                    padding: 15px;
                    border-radius: 10px;
                    page-break-inside: avoid;
                }
                .user {
                    background: #e8f4fd;
                    border-left: 4px solid #0284c7;
                }
                .assistant {
                    background: #f0fdf4;
                    border-left: 4px solid #00a88a;
                }
                .role {
                    font-weight: 600;
                    margin-bottom: 8px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                .time {
                    font-size: 0.8em;
                    color: #8b949e;
                }
                .content {
                    white-space: pre-wrap;
                }
                pre {
                    background: #1f2328;
                    color: #f0f6fc;
                    padding: 12px;
                    border-radius: 6px;
                    overflow-x: auto;
                }
                code {
                    background: #e8eef4;
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-size: 0.9em;
                }
            </style>
        </head>
        <body>
            <h1>ü§ñ Conversa com Nacom Goya IA</h1>
            <div class="meta">Exportado em: ${timestamp}</div>
    `;

    data.forEach(msg => {
        const icon = msg.role === 'Usu√°rio' ? 'üë§' : 'ü§ñ';
        const cssClass = msg.role === 'Usu√°rio' ? 'user' : 'assistant';
        html += `
            <div class="message ${cssClass}">
                <div class="role">${icon} ${msg.role} <span class="time">${msg.time || ''}</span></div>
                <div class="content">${escapeHtml(msg.content)}</div>
            </div>
        `;
    });

    html += '</body></html>';

    // Abrir em nova janela para impress√£o
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();

    // Aguardar carregamento e imprimir
    printWindow.onload = function() {
        printWindow.print();
    };

    console.log('[EXPORT] PDF gerado (via impress√£o)');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================
// FAVORITAR MENSAGENS
// ============================================
let favorites = JSON.parse(localStorage.getItem('agent-favorites') || '[]');
let favoritesViewActive = false;

function initFavorites() {
    // Observar novas mensagens para adicionar bot√£o de favorito
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                if (node.nodeType === 1 && node.classList.contains('message')) {
                    addFavoriteButton(node);
                }
            });
        });
    });

    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        observer.observe(chatMessages, { childList: true });

        // Adicionar bot√£o √†s mensagens existentes
        chatMessages.querySelectorAll('.message').forEach(addFavoriteButton);
    }

    // Criar indicador de modo favoritos
    createFavoritesModeIndicator();

    console.log('[FAVS] Favoritos inicializados:', favorites.length);
}

function addFavoriteButton(messageEl) {
    // N√£o adicionar √† mensagem de boas-vindas
    if (messageEl.querySelector('h6')) return;

    // Verificar se j√° tem bot√£o
    if (messageEl.querySelector('.message-actions')) return;

    const messageId = generateMessageId(messageEl);
    messageEl.dataset.messageId = messageId;

    const content = messageEl.querySelector('.message-content');
    if (!content) return;

    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'message-actions';

    const isFavorited = favorites.includes(messageId);

    actionsDiv.innerHTML = `
        <button class="btn-favorite ${isFavorited ? 'favorited' : ''}"
                onclick="toggleFavorite('${messageId}')"
                title="${isFavorited ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
            <i class="fa${isFavorited ? 's' : 'r'} fa-star"></i>
        </button>
    `;

    content.appendChild(actionsDiv);
}

function generateMessageId(messageEl) {
    const bubble = messageEl.querySelector('.message-bubble');
    const content = bubble ? bubble.textContent.substring(0, 50) : '';
    const isUser = messageEl.classList.contains('user');
    return `${isUser ? 'user' : 'assistant'}-${hashCode(content)}`;
}

function hashCode(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return Math.abs(hash).toString(36);
}

function toggleFavorite(messageId) {
    const index = favorites.indexOf(messageId);
    const btn = document.querySelector(`[data-message-id="${messageId}"] .btn-favorite`);

    if (index === -1) {
        favorites.push(messageId);
        if (btn) {
            btn.classList.add('favorited');
            btn.querySelector('i').className = 'fas fa-star';
            btn.title = 'Remover dos favoritos';
        }
        console.log('[FAVS] Adicionado:', messageId);
    } else {
        favorites.splice(index, 1);
        if (btn) {
            btn.classList.remove('favorited');
            btn.querySelector('i').className = 'far fa-star';
            btn.title = 'Adicionar aos favoritos';
        }
        console.log('[FAVS] Removido:', messageId);

        // Se estiver no modo favoritos, esconder a mensagem
        if (favoritesViewActive) {
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageEl) {
                messageEl.classList.add('hidden-by-filter');
            }
        }
    }

    localStorage.setItem('agent-favorites', JSON.stringify(favorites));
}

function createFavoritesModeIndicator() {
    const chatContainer = document.querySelector('.chat-container');
    if (!chatContainer) return;

    const indicator = document.createElement('div');
    indicator.className = 'favorites-mode-indicator';
    indicator.id = 'favorites-indicator';
    indicator.innerHTML = `
        <i class="fas fa-star"></i>
        <span>Mostrando apenas favoritos</span>
        <button onclick="toggleFavoritesView()" title="Mostrar todas">
            <i class="fas fa-times"></i> Sair
        </button>
    `;

    // Inserir ap√≥s o progress bar
    const progressBar = document.getElementById('progress-bar-container');
    if (progressBar) {
        progressBar.after(indicator);
    } else {
        const header = document.querySelector('.chat-header');
        if (header) {
            header.after(indicator);
        }
    }
}

function toggleFavoritesView() {
    favoritesViewActive = !favoritesViewActive;

    const indicator = document.getElementById('favorites-indicator');
    const messages = document.querySelectorAll('#chat-messages .message');

    if (favoritesViewActive) {
        indicator.classList.add('active');

        messages.forEach((msg, index) => {
            if (index === 0) return; // Manter boas-vindas

            const messageId = msg.dataset.messageId;
            if (!favorites.includes(messageId)) {
                msg.classList.add('hidden-by-filter');
            }
        });

        console.log('[FAVS] Modo favoritos ativado');
    } else {
        indicator.classList.remove('active');
        messages.forEach(msg => msg.classList.remove('hidden-by-filter'));
        console.log('[FAVS] Modo favoritos desativado');
    }
}

// Inicializar favoritos
document.addEventListener('DOMContentLoaded', initFavorites);
</script>
{% endblock %}
