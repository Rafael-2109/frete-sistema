{% extends 'base.html' %}

{% block title %}Agente Log√≠stico - Claude Agent SDK{% endblock %}

{% block extra_css %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<!-- DESIGN-001: Agent Theme (Deep Ocean) - Carrega ANTES do chat.css -->
<link rel="stylesheet" href="{{ url_for('static', filename='agente/css/agent-theme.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='agente/css/chat.css') }}">
<!-- FEAT-023: Highlight.js para syntax highlighting -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css">
{% endblock %}

{% block content %}
<!-- FEAT-025: Layout Fullscreen -->
<div class="chat-fullscreen-wrapper">
    <div class="chat-container">
        <!-- Header Compacto -->
        <div class="chat-header">
            <div class="chat-header-left">
                <!-- Bot√£o de Sess√µes -->
                <button class="btn-sessions" onclick="openSessionsModal()" title="Conversas anteriores">
                    <i class="fas fa-comments"></i>
                    <span class="sessions-count-badge" id="sessions-count-badge" style="display: none;">0</span>
                </button>
                <div class="chat-title">
                    <h5>Nacom Goya IA</h5>
                    <small id="model-display">Claude Agent SDK ‚Ä¢ Sonnet</small>
                </div>
            </div>

            <div class="chat-header-center">
                <!-- FEAT-001: Seletor de Modelo com Tooltip -->
                <div class="header-control has-tooltip">
                    <select id="model-selector" class="model-select">
                        <option value="claude-haiku-4-5-20251001">‚ö° Haiku</option>
                        <option value="claude-sonnet-4-5-20250929" selected>‚ö°‚ö° Sonnet</option>
                        <option value="claude-opus-4-5-20251101">üß† Opus</option>
                    </select>
                    <div class="control-tooltip">
                        <strong>Escolha o Modelo</strong>
                        <ul>
                            <li><b>‚ö° Haiku:</b> R√°pido e econ√¥mico</li>
                            <li><b>‚ö°‚ö° Sonnet:</b> Equilibrado (recomendado)</li>
                            <li><b>üß† Opus:</b> Mais potente</li>
                        </ul>
                    </div>
                </div>

                <!-- FEAT-002: Toggle Thinking com Tooltip -->
                <div class="header-control has-tooltip">
                    <label class="toggle-switch">
                        <input type="checkbox" id="thinking-toggle">
                        <span class="toggle-slider"></span>
                        <i class="fas fa-brain toggle-icon"></i>
                    </label>
                    <div class="control-tooltip">
                        <strong><i class="fas fa-brain"></i> Pensamento Profundo</strong>
                        <p>Quando ativado, o agente analisa mais antes de responder.</p>
                        <small>Ideal para decis√µes complexas.</small>
                    </div>
                </div>

                <!-- FEAT-010: Toggle Plan Mode com Tooltip -->
                <div class="header-control has-tooltip">
                    <label class="toggle-switch plan">
                        <input type="checkbox" id="plan-mode-toggle">
                        <span class="toggle-slider"></span>
                        <i class="fas fa-clipboard-list toggle-icon"></i>
                    </label>
                    <div class="control-tooltip">
                        <strong><i class="fas fa-clipboard-list"></i> Modo Planejamento</strong>
                        <p>Apenas analisa e sugere, sem executar a√ß√µes.</p>
                        <small>Use para revisar antes de confirmar.</small>
                    </div>
                </div>
            </div>

            <div class="chat-header-right">
                <!-- FEAT-004: Budget de Tokens (Admin) - FIX: Elementos DOM completos -->
                {% if current_user.perfil == 'administrador' %}
                <div class="token-budget-container" id="token-budget" style="display: none;">
                    <div class="token-budget-stats">
                        <span class="token-stat">
                            <i class="fas fa-arrow-down"></i>
                            <span id="token-input" title="Tokens de entrada">0</span>
                        </span>
                        <span class="token-stat">
                            <i class="fas fa-arrow-up"></i>
                            <span id="token-output" title="Tokens de sa√≠da">0</span>
                        </span>
                        <span class="token-stat total">
                            <span class="token-count" id="token-total" title="Total de tokens">0</span>
                        </span>
                        <span class="token-cost" id="token-cost" title="Custo USD">$0.00</span>
                    </div>
                    <div class="token-budget-bar">
                        <div class="token-progress-bar" id="token-progress-bar" style="width: 0%"></div>
                    </div>
                    <span class="token-percentage" id="token-percentage">0%</span>
                </div>
                {% endif %}

                <!-- DESIGN-001: Toggle de Tema Dark/Light -->
                <button class="theme-toggle" onclick="toggleAgentTheme()" title="Alternar tema">
                    <i class="fas fa-sun theme-toggle__icon theme-toggle__icon--light"></i>
                    <i class="fas fa-moon theme-toggle__icon theme-toggle__icon--dark"></i>
                </button>

                <span class="status-indicator online" title="Online">
                    <i class="fas fa-circle"></i>
                </span>

                <!-- Menu de op√ß√µes -->
                <div class="dropdown">
                    <button class="btn-menu" data-bs-toggle="dropdown" title="Op√ß√µes">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="openSessionsModal()">
                            <i class="fas fa-comments me-2"></i>Conversas
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="startNewSession()">
                            <i class="fas fa-plus me-2"></i>Nova Conversa
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="toggleTimeline()">
                            <i class="fas fa-history me-2"></i>Timeline
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="clearSession()">
                            <i class="fas fa-eraser me-2"></i>Limpar
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="showHelp()">
                            <i class="fas fa-question-circle me-2"></i>Ajuda
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- FEAT-009: Barra de Progresso -->
        <div id="progress-bar-container" class="progress-bar-container" style="display: none;">
            <div class="progress-bar-info">
                <span id="progress-status">Processando...</span>
                <span id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%"></div>
            </div>
        </div>

        <!-- √Årea de Mensagens -->
        <div class="chat-messages" id="chat-messages">
            <!-- Mensagem de boas-vindas -->
            <div class="message assistant">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        <h6>üëã Ol√°! Sou o Agente Nacom Goya</h6>
                        <p>Posso ajudar voc√™ com:</p>
                        <ul>
                            <li>üì¶ Consultar pedidos e status</li>
                            <li>üìä Analisar disponibilidade de estoque</li>
                            <li>üöõ Calcular prazos de entrega</li>
                            <li>‚úÖ Criar separa√ß√µes de pedidos</li>
                        </ul>
                        <p><strong>Como posso ajudar?</strong></p>
                    </div>
                    <div class="message-time">Agora</div>
                </div>
            </div>
        </div>

        <!-- Indicador de digita√ß√£o -->
        <div id="typing-container" class="typing-container" style="display: none;">
            <div class="message assistant">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="typing-indicator">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                    <span class="typing-text" id="typing-text">Pensando...</span>
                </div>
            </div>
        </div>

        <!-- FEAT-003: Painel de Thinking -->
        <div id="thinking-panel" class="thinking-panel" style="display: none;">
            <div class="thinking-content">
                <div class="thinking-header">
                    <span class="thinking-label">
                        <i class="fas fa-brain me-1"></i>
                        <span id="thinking-status">Pensando...</span>
                    </span>
                    <button class="btn-minimize" onclick="toggleThinkingPanel()" title="Minimizar">
                        <i class="fas fa-chevron-up" id="thinking-toggle-icon"></i>
                    </button>
                </div>
                <div class="thinking-body" id="thinking-text"></div>
            </div>
        </div>

        <!-- FEAT-028: √Årea de Arquivos -->
        <div id="files-panel" class="files-panel" style="display: none;">
            <!-- Arquivos Anexados (upload do usu√°rio) -->
            <div class="files-section attachments-section" id="attachments-section" style="display: none;">
                <div class="files-section-header">
                    <span><i class="fas fa-paperclip me-1"></i>Anexos</span>
                    <button class="btn-clear-files" onclick="clearAttachments()" title="Remover todos">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="files-list" id="attachments-list"></div>
            </div>
            <!-- Downloads Dispon√≠veis (gerados pelo agente) -->
            <div class="files-section downloads-section" id="downloads-section" style="display: none;">
                <div class="files-section-header">
                    <span><i class="fas fa-download me-1"></i>Downloads</span>
                    <button class="btn-clear-files" onclick="clearDownloads()" title="Limpar">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="files-list" id="downloads-list"></div>
            </div>
        </div>

        <!-- Input com Textarea e Bot√£o Stop -->
        <div class="chat-input">
            <form id="chat-form">
                <!-- FEAT-028: Input file oculto -->
                <input type="file" id="file-input" multiple accept=".pdf,.xlsx,.xls,.csv,.png,.jpg,.jpeg,.gif" style="display: none;">

                <!-- FEAT-028: Bot√£o Anexar -->
                <button type="button" class="btn-attach" onclick="document.getElementById('file-input').click()" title="Anexar arquivo (PDF, Excel, CSV, Imagens)">
                    <i class="fas fa-paperclip"></i>
                </button>

                <textarea
                    id="message-input"
                    placeholder="Digite sua pergunta... (Enter envia, Shift+Enter nova linha)"
                    maxlength="2000"
                    rows="1"
                    autocomplete="off"
                ></textarea>
                <div class="input-actions">
                    <!-- Bot√£o Stop (vis√≠vel durante processamento) -->
                    <button type="button" id="stop-btn" class="btn-stop" style="display: none;" onclick="stopGeneration()" title="Parar gera√ß√£o">
                        <i class="fas fa-stop"></i>
                    </button>
                    <!-- Bot√£o Enviar -->
                    <button type="submit" id="send-btn" disabled title="Enviar (Enter)">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
            <div class="input-hint">
                <small>Enter envia ‚Ä¢ Shift+Enter nova linha</small>
            </div>
        </div>
    </div>
</div>

<!-- FEAT-025: Modal de Sess√µes -->
<div id="sessions-modal" class="sessions-modal" style="display: none;">
    <div class="sessions-modal-backdrop" onclick="closeSessionsModal()"></div>
    <div class="sessions-modal-content">
        <div class="sessions-modal-header">
            <h5><i class="fas fa-comments me-2"></i>Conversas</h5>
            <button class="btn-close-modal" onclick="closeSessionsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sessions-modal-actions">
            <button class="btn-new-session" onclick="startNewSession(); closeSessionsModal();">
                <i class="fas fa-plus me-2"></i>Nova Conversa
            </button>
        </div>
        <div class="sessions-modal-body">
            <div id="sessions-list" class="sessions-list">
                <div class="sessions-loading" id="sessions-loading">
                    <i class="fas fa-spinner fa-spin me-2"></i>Carregando...
                </div>
                <div class="sessions-empty" id="sessions-empty" style="display: none;">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Nenhuma conversa ainda</p>
                    <small class="text-muted">Suas conversas aparecer√£o aqui</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirma√ß√£o -->
<div id="confirmation-overlay" class="confirmation-overlay" style="display: none;">
    <div class="confirmation-modal">
        <h5>‚ö†Ô∏è Confirmar A√ß√£o</h5>
        <p id="confirmation-message">Deseja executar esta a√ß√£o?</p>
        <div class="confirmation-buttons">
            <button class="btn-cancel" onclick="cancelAction()">Cancelar</button>
            <button class="btn-confirm" onclick="confirmAction()">Confirmar</button>
        </div>
    </div>
</div>

<!-- FEAT-006: Timeline de A√ß√µes (flutuante) -->
<div id="action-timeline" class="action-timeline-container hidden">
    <div class="timeline-header">
        <span class="timeline-header-title"><i class="fas fa-history"></i>A√ß√µes</span>
        <span class="badge bg-light text-dark" id="action-count">0</span>
        <button class="btn-close-panel" onclick="hideTimeline()" title="Fechar">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="timeline-body" id="timeline-body">
        <div class="timeline-empty" id="timeline-empty">
            <i class="fas fa-clock fa-2x mb-2"></i>
            <p class="mb-0">Nenhuma a√ß√£o ainda</p>
        </div>
        <div id="timeline-items"></div>
    </div>
</div>

<!-- FEAT-008: Todo List Visual (flutuante) -->
<div id="todo-panel" class="todo-panel-container hidden">
    <div class="todo-header">
        <span class="todo-header-title"><i class="fas fa-tasks"></i>Tarefas</span>
        <span class="badge bg-light text-success" id="todo-progress-badge">0%</span>
        <button class="btn-close-panel" onclick="hideTodoPanel()" title="Fechar">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="todo-body">
        <ul id="todo-list" class="todo-list"></ul>
    </div>
    <div class="todo-progress-container">
        <div class="todo-progress">
            <div class="todo-progress-bar" id="todo-progress-bar" style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- FEAT-023: Markdown Avan√ßado - Bibliotecas -->
<script src="https://cdn.jsdelivr.net/npm/marked@13.0.0/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
<script src="{{ url_for('static', filename='agente/js/chat.js') }}"></script>

<!-- DESIGN-001: Theme Management + FIX P3.1: Preferences Persistence -->
<script>
/**
 * Agent Preferences Manager
 * Gerencia tema, modelo, thinking e plan mode com persist√™ncia em localStorage
 */

// Chaves do localStorage
const STORAGE_KEYS = {
    theme: 'agent-theme',
    model: 'agent-model',
    thinking: 'agent-thinking',
    planMode: 'agent-plan-mode'
};

// ============================================
// TEMA (Dark/Light)
// ============================================
(function initAgentTheme() {
    const savedTheme = localStorage.getItem(STORAGE_KEYS.theme);
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');

    document.documentElement.setAttribute('data-theme', theme);
    document.documentElement.setAttribute('data-bs-theme', theme);

    console.log('[PREFS] Tema inicializado:', theme);
})();

function toggleAgentTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme') || 'dark';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    html.setAttribute('data-theme', newTheme);
    html.setAttribute('data-bs-theme', newTheme);
    localStorage.setItem(STORAGE_KEYS.theme, newTheme);

    console.log('[PREFS] Tema alterado para:', newTheme);
}

window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem(STORAGE_KEYS.theme)) {
        const newTheme = e.matches ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        document.documentElement.setAttribute('data-bs-theme', newTheme);
        console.log('[PREFS] Sistema alterou tema para:', newTheme);
    }
});

// ============================================
// FIX P3.1: MODELO, THINKING, PLAN MODE
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // --- Restaurar Modelo ---
    const modelSelector = document.getElementById('model-selector');
    const savedModel = localStorage.getItem(STORAGE_KEYS.model);
    if (modelSelector && savedModel) {
        // Verifica se o modelo salvo existe nas op√ß√µes
        const optionExists = Array.from(modelSelector.options).some(opt => opt.value === savedModel);
        if (optionExists) {
            modelSelector.value = savedModel;
            // Atualiza vari√°vel global do chat.js
            if (typeof currentModel !== 'undefined') {
                currentModel = savedModel;
            }
            // Dispara evento change para atualizar display
            modelSelector.dispatchEvent(new Event('change'));
            console.log('[PREFS] Modelo restaurado:', savedModel);
        }
    }

    // Salvar modelo quando alterado
    if (modelSelector) {
        modelSelector.addEventListener('change', function() {
            localStorage.setItem(STORAGE_KEYS.model, this.value);
            console.log('[PREFS] Modelo salvo:', this.value);
        });
    }

    // --- Restaurar Thinking Toggle ---
    const thinkingToggle = document.getElementById('thinking-toggle');
    const savedThinking = localStorage.getItem(STORAGE_KEYS.thinking);
    if (thinkingToggle && savedThinking !== null) {
        const isEnabled = savedThinking === 'true';
        thinkingToggle.checked = isEnabled;
        // Atualiza vari√°vel global do chat.js
        if (typeof thinkingEnabled !== 'undefined') {
            thinkingEnabled = isEnabled;
        }
        console.log('[PREFS] Thinking restaurado:', isEnabled);
    }

    // Salvar thinking quando alterado
    if (thinkingToggle) {
        thinkingToggle.addEventListener('change', function() {
            localStorage.setItem(STORAGE_KEYS.thinking, this.checked.toString());
            console.log('[PREFS] Thinking salvo:', this.checked);
        });
    }

    // --- Restaurar Plan Mode Toggle ---
    const planModeToggle = document.getElementById('plan-mode-toggle');
    const savedPlanMode = localStorage.getItem(STORAGE_KEYS.planMode);
    if (planModeToggle && savedPlanMode !== null) {
        const isEnabled = savedPlanMode === 'true';
        planModeToggle.checked = isEnabled;
        // Atualiza vari√°vel global do chat.js
        if (typeof planModeEnabled !== 'undefined') {
            planModeEnabled = isEnabled;
        }
        console.log('[PREFS] Plan Mode restaurado:', isEnabled);
    }

    // Salvar plan mode quando alterado
    if (planModeToggle) {
        planModeToggle.addEventListener('change', function() {
            localStorage.setItem(STORAGE_KEYS.planMode, this.checked.toString());
            console.log('[PREFS] Plan Mode salvo:', this.checked);
        });
    }

    console.log('[PREFS] Preferencias carregadas com sucesso');

    // ============================================
    // P3.2: ATALHOS DE TECLADO
    // ============================================
    document.addEventListener('keydown', function(e) {
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
        const cmdOrCtrl = isMac ? e.metaKey : e.ctrlKey;

        // Cmd/Ctrl + K: Abrir modal de sess√µes
        if (cmdOrCtrl && e.key === 'k') {
            e.preventDefault();
            if (typeof openSessionsModal === 'function') {
                openSessionsModal();
            }
            console.log('[KEYS] Cmd+K: Abrir sess√µes');
        }

        // Cmd/Ctrl + N: Nova sess√£o
        if (cmdOrCtrl && e.key === 'n') {
            e.preventDefault();
            if (typeof startNewSession === 'function') {
                startNewSession();
            }
            console.log('[KEYS] Cmd+N: Nova sess√£o');
        }

        // Cmd/Ctrl + Enter: Enviar mensagem (alternativo)
        if (cmdOrCtrl && e.key === 'Enter') {
            const textarea = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            if (document.activeElement === textarea && sendBtn && !sendBtn.disabled) {
                e.preventDefault();
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        }

        // Esc: Fechar modais
        if (e.key === 'Escape') {
            // Fechar modal de sess√µes
            const sessionsModal = document.getElementById('sessions-modal');
            if (sessionsModal && sessionsModal.style.display !== 'none') {
                if (typeof closeSessionsModal === 'function') {
                    closeSessionsModal();
                }
                console.log('[KEYS] Esc: Fechar modal sess√µes');
                return;
            }

            // Fechar modal de confirma√ß√£o
            const confirmModal = document.getElementById('confirmation-overlay');
            if (confirmModal && confirmModal.style.display !== 'none') {
                if (typeof cancelAction === 'function') {
                    cancelAction();
                }
                console.log('[KEYS] Esc: Fechar modal confirma√ß√£o');
                return;
            }

            // Fechar timeline
            const timeline = document.getElementById('action-timeline');
            if (timeline && !timeline.classList.contains('hidden')) {
                if (typeof hideTimeline === 'function') {
                    hideTimeline();
                }
                console.log('[KEYS] Esc: Fechar timeline');
                return;
            }

            // Fechar todo panel
            const todoPanel = document.getElementById('todo-panel');
            if (todoPanel && !todoPanel.classList.contains('hidden')) {
                if (typeof hideTodoPanel === 'function') {
                    hideTodoPanel();
                }
                console.log('[KEYS] Esc: Fechar todo panel');
                return;
            }
        }
    });

    console.log('[KEYS] Atalhos registrados: Cmd/Ctrl+K (sess√µes), Cmd/Ctrl+N (nova), Esc (fechar)');

    // ============================================
    // P3.4: INDICADOR VISUAL DE CONEX√ÉO
    // ============================================
    const statusIndicator = document.querySelector('.status-indicator');
    let connectionStatus = 'online';
    let lastHeartbeat = Date.now();

    function updateConnectionStatus(status) {
        if (!statusIndicator) return;

        connectionStatus = status;
        statusIndicator.className = 'status-indicator ' + status;

        const icon = statusIndicator.querySelector('i');
        if (icon) {
            if (status === 'online') {
                statusIndicator.title = 'Conectado';
                icon.className = 'fas fa-circle';
            } else if (status === 'connecting') {
                statusIndicator.title = 'Reconectando...';
                icon.className = 'fas fa-circle-notch fa-spin';
            } else {
                statusIndicator.title = 'Desconectado';
                icon.className = 'fas fa-exclamation-circle';
            }
        }
    }

    // Verificar conex√£o periodicamente
    function checkConnection() {
        fetch('/api/agente/health', { method: 'GET' })
            .then(response => {
                if (response.ok) {
                    lastHeartbeat = Date.now();
                    if (connectionStatus !== 'online') {
                        updateConnectionStatus('online');
                        console.log('[CONN] Conex√£o restaurada');
                    }
                } else {
                    throw new Error('Health check failed');
                }
            })
            .catch(() => {
                const timeSinceLastHeartbeat = Date.now() - lastHeartbeat;
                if (timeSinceLastHeartbeat > 10000) {
                    updateConnectionStatus('offline');
                    console.log('[CONN] Conex√£o perdida');
                } else if (connectionStatus === 'online') {
                    updateConnectionStatus('connecting');
                    console.log('[CONN] Verificando conex√£o...');
                }
            });
    }

    // Verificar a cada 30 segundos
    setInterval(checkConnection, 30000);

    // Detectar mudan√ßas de rede do navegador
    window.addEventListener('online', () => {
        updateConnectionStatus('connecting');
        checkConnection();
        console.log('[CONN] Navegador: online');
    });

    window.addEventListener('offline', () => {
        updateConnectionStatus('offline');
        console.log('[CONN] Navegador: offline');
    });

    // ============================================
    // P3.6: DRAG & DROP PARA ARQUIVOS
    // ============================================
    const chatContainer = document.querySelector('.chat-container');
    const fileInput = document.getElementById('file-input');
    let dragCounter = 0;

    if (chatContainer && fileInput) {
        // Criar overlay de drop
        const dropOverlay = document.createElement('div');
        dropOverlay.className = 'drop-overlay';
        dropOverlay.innerHTML = `
            <div class="drop-overlay-content">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Solte os arquivos aqui</span>
                <small>PDF, Excel, CSV, Imagens</small>
            </div>
        `;
        chatContainer.appendChild(dropOverlay);

        // Prevenir comportamento padr√£o em todo o documento
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        // Mostrar overlay quando arrastar sobre o chat
        chatContainer.addEventListener('dragenter', (e) => {
            dragCounter++;
            if (e.dataTransfer.types.includes('Files')) {
                dropOverlay.classList.add('active');
            }
        });

        chatContainer.addEventListener('dragleave', () => {
            dragCounter--;
            if (dragCounter === 0) {
                dropOverlay.classList.remove('active');
            }
        });

        chatContainer.addEventListener('dragover', (e) => {
            if (e.dataTransfer.types.includes('Files')) {
                e.dataTransfer.dropEffect = 'copy';
            }
        });

        // Processar arquivos soltos
        chatContainer.addEventListener('drop', (e) => {
            dragCounter = 0;
            dropOverlay.classList.remove('active');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Adicionar arquivos ao input
                const dataTransfer = new DataTransfer();

                // Manter arquivos existentes
                if (fileInput.files) {
                    for (let i = 0; i < fileInput.files.length; i++) {
                        dataTransfer.items.add(fileInput.files[i]);
                    }
                }

                // Adicionar novos arquivos
                for (let i = 0; i < files.length; i++) {
                    dataTransfer.items.add(files[i]);
                }

                fileInput.files = dataTransfer.files;

                // Disparar evento change para processar arquivos
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));

                console.log('[DROP] Arquivos adicionados:', files.length);
            }
        });

        console.log('[DROP] Drag & drop habilitado');
    }
});
</script>

<!-- P3.6: Estilos do Drop Overlay (inline para n√£o precisar editar CSS) -->
<style>
.drop-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 212, 170, 0.1);
    border: 3px dashed var(--agent-accent-primary, #00d4aa);
    border-radius: var(--agent-radius-lg, 16px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
    transition: all 0.3s ease;
}

.drop-overlay.active {
    display: flex;
}

.drop-overlay-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 40px;
    background: var(--agent-bg-secondary, #111d2e);
    border-radius: var(--agent-radius-lg, 16px);
    box-shadow: var(--agent-shadow-xl, 0 20px 40px rgba(0,0,0,0.6));
    animation: dropPulse 1.5s ease-in-out infinite;
}

.drop-overlay-content i {
    font-size: 3rem;
    color: var(--agent-accent-primary, #00d4aa);
}

.drop-overlay-content span {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--agent-text-primary, #f0f6fc);
}

.drop-overlay-content small {
    font-size: 0.8rem;
    color: var(--agent-text-muted, #6e7681);
}

@keyframes dropPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

/* Status indicator styles */
.status-indicator.connecting i {
    color: var(--agent-warning, #f59e0b) !important;
}

.status-indicator.offline i {
    color: var(--agent-danger, #ef4444) !important;
}
</style>
{% endblock %}
