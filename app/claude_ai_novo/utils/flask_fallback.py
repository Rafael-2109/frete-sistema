"""
üîÑ FLASK FALLBACK - Fallback para Depend√™ncias Flask
==================================================

M√≥dulo que fornece fallbacks para quando o Flask n√£o est√° dispon√≠vel,
permitindo que o sistema funcione em modo standalone.

Fun√ß√£o: Substituir imports do Flask por mocks funcionais quando
o sistema √© executado fora do contexto Flask.
"""

import logging
from typing import Dict, List, Any, Optional, Union
try:
    from unittest.mock import Mock
except ImportError:
    class Mock:
        def __init__(self, *args, **kwargs):
            pass
        def __call__(self, *args, **kwargs):
            return self
        def __getattr__(self, name):
            return self

logger = logging.getLogger(__name__)

# Vari√°veis globais para indicar disponibilidade do Flask
try:
    from flask import Flask
    FLASK_AVAILABLE = True
except ImportError:
    Flask = None
    FLASK_AVAILABLE = False

class FlaskFallback:
    """
    Classe que simula funcionalidades do Flask quando n√£o dispon√≠vel.
    
    Permite que m√≥dulos que dependem do Flask funcionem em modo standalone
    para testes e execu√ß√£o independente.
    """
    
    def __init__(self):
        self.available = False
        self.mock_app = None
        self.mock_models = {}
        self._initialize_fallback()
    
    def _initialize_fallback(self):
        """Inicializa fallbacks do Flask"""
        try:
            # Tentar importar Flask
            import flask
            self.available = True
            logger.info("‚úÖ Flask dispon√≠vel - usando vers√£o real")
            
        except ImportError:
            logger.warning("üì¶ Flask n√£o dispon√≠vel - usando fallback mock")
            self.available = False
            self._create_mock_flask()
    
    def _create_mock_flask(self):
        """Cria mocks do Flask"""
        # Mock do app Flask
        self.mock_app = Mock()
        self.mock_app.config = {
            'SECRET_KEY': 'mock-secret-key',
            'SQLALCHEMY_DATABASE_URI': 'sqlite:///:memory:',
            'SQLALCHEMY_TRACK_MODIFICATIONS': False
        }
        
        # Mock dos modelos principais
        self.mock_models = {
            'Pedido': self._create_mock_model('Pedido'),
            'Embarque': self._create_mock_model('Embarque'),
            'EmbarqueItem': self._create_mock_model('EmbarqueItem'),
            'EntregaMonitorada': self._create_mock_model('EntregaMonitorada'),
            'RelatorioFaturamentoImportado': self._create_mock_model('RelatorioFaturamentoImportado'),
            'Transportadora': self._create_mock_model('Transportadora'),
            'Usuario': self._create_mock_model('Usuario'),
            'Frete': self._create_mock_model('Frete'),
            'ContatoAgendamento': self._create_mock_model('ContatoAgendamento'),
            'Separacao': self._create_mock_model('Separacao'),
            'PendenciaFinanceira': self._create_mock_model('PendenciaFinanceira'),
            'ControlePortaria': self._create_mock_model('ControlePortaria'),
            'DespesaExtra': self._create_mock_model('DespesaExtra'),
            'Estoque': self._create_mock_model('Estoque'),
            'Produto': self._create_mock_model('Produto'),
            'ItemPedido': self._create_mock_model('ItemPedido')
        }
        
        logger.info("üîÑ Mocks do Flask criados com sucesso")
    
    def _create_mock_model(self, model_name: str) -> Mock:
        """
        Cria mock de um modelo SQLAlchemy.
        
        Args:
            model_name: Nome do modelo
            
        Returns:
            Mock configurado do modelo
        """
        mock_model = Mock()
        mock_model.__name__ = model_name
        mock_model.__tablename__ = model_name.lower()
        
        # Mock query
        mock_query = Mock()
        mock_query.all.return_value = []
        mock_query.first.return_value = None
        mock_query.count.return_value = 0
        mock_query.filter.return_value = mock_query
        mock_query.filter_by.return_value = mock_query
        mock_query.order_by.return_value = mock_query
        mock_query.limit.return_value = mock_query
        mock_query.offset.return_value = mock_query
        mock_query.join.return_value = mock_query
        
        mock_model.query = mock_query
        
        return mock_model
    
    def get_app(self):
        """
        Retorna app Flask ou mock.
        
        Returns:
            Flask app ou mock
        """
        if self.available:
            try:
                from flask import current_app
                return current_app
            except RuntimeError:
                # Fora do contexto Flask - tentar obter app real
                try:
                    # Tentar importar e criar app real
                    import sys
                    import os
                    
                    # Adicionar path do projeto se necess√°rio
                    projeto_path = os.path.dirname(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))
                    if projeto_path not in sys.path:
                        sys.path.insert(0, projeto_path)
                    
                    # Tentar importar o app real
                    from app import create_app
                    app = create_app()
                    
                    self.logger.info("‚úÖ App Flask real obtido fora do contexto web")
                    return app
                    
                except Exception as e:
                    self.logger.warning(f"‚ö†Ô∏è N√£o foi poss√≠vel obter app Flask real: {e}")
                    return self.mock_app
        else:
            return self.mock_app
    
    def get_model(self, model_name: str):
        """
        Retorna modelo real ou mock.
        
        Args:
            model_name: Nome do modelo
            
        Returns:
            Modelo real ou mock
        """
        if self.available:
            try:
                # CORRE√á√ÉO: Verificar Flask context primeiro
                try:
                    from flask import current_app
                    current_app.config
                    
                    # Estamos em contexto Flask v√°lido - importar modelos reais
                    if model_name == 'Pedido':
                        from app.pedidos.models import Pedido
                        self.logger.info(f"‚úÖ Modelo real {model_name} obtido")
                        return Pedido
                    elif model_name == 'Embarque':
                        from app.embarques.models import Embarque
                        self.logger.info(f"‚úÖ Modelo real {model_name} obtido")
                        return Embarque
                    elif model_name == 'EmbarqueItem':
                        from app.embarques.models import EmbarqueItem
                        self.logger.info(f"‚úÖ Modelo real {model_name} obtido")
                        return EmbarqueItem
                    elif model_name == 'EntregaMonitorada':
                        from app.monitoramento.models import EntregaMonitorada
                        self.logger.info(f"‚úÖ Modelo real {model_name} obtido")
                        return EntregaMonitorada
                    elif model_name == 'RelatorioFaturamentoImportado':
                        from app.faturamento.models import RelatorioFaturamentoImportado
                        self.logger.info(f"‚úÖ Modelo real {model_name} obtido")
                        return RelatorioFaturamentoImportado
                    elif model_name == 'Transportadora':
                        from app.transportadoras.models import Transportadora
                        self.logger.info(f"‚úÖ Modelo real {model_name} obtido")
                        return Transportadora
                    elif model_name == 'Usuario':
                        from app.auth.models import Usuario
                        self.logger.info(f"‚úÖ Modelo real {model_name} obtido")
                        return Usuario
                    elif model_name == 'Frete':
                        from app.fretes.models import Frete
                        self.logger.info(f"‚úÖ Modelo real {model_name} obtido")
                        return Frete
                    else:
                        # Modelo n√£o mapeado - usar mock
                        self.logger.warning(f"‚ö†Ô∏è Modelo {model_name} n√£o mapeado, usando mock")
                        return self.mock_models.get(model_name, Mock())
                        
                except RuntimeError:
                    # Fora do contexto Flask
                    self.logger.warning(f"‚ö†Ô∏è Fora do contexto Flask, usando mock para {model_name}")
                    return self.mock_models.get(model_name, Mock())
                    
            except ImportError:
                # Fallback para mock se import falhar
                self.logger.warning(f"‚ö†Ô∏è Import falhou para {model_name}, usando mock")
                return self.mock_models.get(model_name, Mock())
        else:
            return self.mock_models.get(model_name, Mock())
    
    def get_db(self):
        """
        Retorna inst√¢ncia do banco ou mock.
        
        Returns:
            SQLAlchemy db ou mock
        """
        if self.available:
            try:
                # CORRE√á√ÉO: Primeiro verificar se estamos em Flask context v√°lido
                try:
                    from flask import current_app
                    # Se current_app funciona, estamos em contexto Flask v√°lido
                    current_app.config
                    
                    # Importar db real
                    from app import db
                    self.logger.info("‚úÖ DB real obtido com sucesso")
                    return db
                    
                except RuntimeError:
                    # N√£o estamos em contexto Flask
                    self.logger.warning("‚ö†Ô∏è Fora do contexto Flask, usando mock DB")
                    return self._create_mock_db()
                    
            except Exception as e:
                self.logger.warning(f"‚ö†Ô∏è Erro ao obter db real: {e}")
                return self._create_mock_db()
        else:
            return self._create_mock_db()
    
    def _create_mock_db(self):
        """Cria mock do banco de dados"""
        mock_db = Mock()
        mock_db.session = Mock()
        mock_db.session.query = Mock(return_value=Mock())
        mock_db.session.add = Mock()
        mock_db.session.commit = Mock()
        mock_db.session.rollback = Mock()
        mock_db.session.close = Mock()
        
        return mock_db
    
    def get_current_user(self):
        """
        Retorna usu√°rio atual ou mock.
        
        Returns:
            Usu√°rio atual ou mock
        """
        if self.available:
            try:
                from flask_login import current_user
                return current_user
            except ImportError:
                return self._create_mock_user()
        else:
            return self._create_mock_user()
    
    def _create_mock_user(self):
        """Cria mock do usu√°rio"""
        mock_user = Mock()
        mock_user.id = 1
        mock_user.nome = "Mock User"
        mock_user.email = "mock@test.com"
        mock_user.codigo_vendedor = "MOCK001"
        mock_user.perfil = "admin"
        mock_user.is_authenticated = True
        mock_user.is_active = True
        mock_user.is_anonymous = False
        
        return mock_user
    
    def is_flask_available(self) -> bool:
        """
        Verifica se Flask est√° dispon√≠vel.
        
        Returns:
            True se Flask est√° dispon√≠vel
        """
        return self.available
    
    def get_config(self, key: str, default: Any = None) -> Any:
        """
        Obt√©m configura√ß√£o do Flask ou padr√£o.
        
        Args:
            key: Chave da configura√ß√£o
            default: Valor padr√£o
            
        Returns:
            Valor da configura√ß√£o ou padr√£o
        """
        if self.available:
            try:
                from flask import current_app
                return current_app.config.get(key, default)
            except RuntimeError:
                return self.mock_app.config.get(key, default)
        else:
            return self.mock_app.config.get(key, default)

# Inst√¢ncia global
_flask_fallback = None

def get_flask_fallback() -> FlaskFallback:
    """
    Retorna inst√¢ncia global do FlaskFallback.
    
    Returns:
        FlaskFallback: Inst√¢ncia do fallback
    """
    global _flask_fallback
    if _flask_fallback is None:
        _flask_fallback = FlaskFallback()
    return _flask_fallback

# Fun√ß√µes de conveni√™ncia
def get_app():
    """Fun√ß√£o de conveni√™ncia para obter app"""
    return get_flask_fallback().get_app()

def get_model(model_name: str):
    """Fun√ß√£o de conveni√™ncia para obter modelo"""
    return get_flask_fallback().get_model(model_name)

def get_db():
    """Fun√ß√£o de conveni√™ncia para obter db"""
    return get_flask_fallback().get_db()

def get_current_user():
    """Fun√ß√£o de conveni√™ncia para obter usu√°rio atual"""
    return get_flask_fallback().get_current_user()

def is_flask_available() -> bool:
    """Fun√ß√£o de conveni√™ncia para verificar Flask"""
    return get_flask_fallback().is_flask_available()

def get_config(key: str, default: Any = None) -> Any:
    """Fun√ß√£o de conveni√™ncia para obter configura√ß√£o"""
    return get_flask_fallback().get_config(key, default)

# Exports
__all__ = [
    'FlaskFallback',
    'get_flask_fallback',
    'get_app',
    'get_model',
    'get_db',
    'get_current_user',
    'is_flask_available',
    'get_config'
] 