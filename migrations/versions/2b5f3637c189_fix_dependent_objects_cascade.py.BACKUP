"""fix_dependent_objects_cascade

Revision ID: 2b5f3637c189
Revises: safe_permission_update
Create Date: 2025-07-26 22:56:25.407183

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '2b5f3637c189'
down_revision = 'safe_permission_update'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    
    # CORREÇÃO: Primeiro dropar views que dependem das tabelas
    conn = op.get_bind()
    
    # Lista de views que podem depender das tabelas AI
    views_to_drop = [
        'ai_feedback_analytics',
        'ai_session_analytics',
        'ai_pattern_summary',
        'ai_feedback_summary',
        'historico_summary',
        'faturamento_analytics'
    ]
    
    for view_name in views_to_drop:
        try:
            conn.execute(f"DROP VIEW IF EXISTS {view_name} CASCADE")
        except Exception:
            # Ignorar se a view não existir
            pass
    
    # CORREÇÃO: Verificar e adicionar campo separacao_lote_id em pre_separacao_item se não existir
    result = conn.execute("""
        SELECT column_name 
        FROM information_schema.columns 
        WHERE table_name = 'pre_separacao_item' 
        AND column_name = 'separacao_lote_id'
    """).fetchone()
    
    if not result:
        try:
            op.add_column('pre_separacao_item', 
                sa.Column('separacao_lote_id', sa.String(50), nullable=True))
            op.create_index('ix_pre_separacao_item_separacao_lote_id', 
                'pre_separacao_item', ['separacao_lote_id'])
        except Exception:
            # Se já existir, ignorar
            pass
    
    # CORREÇÃO: Comentar drop de tabelas AI para mantê-las
    # Essas tabelas podem ser úteis no futuro e não afetam o sistema
    """
    # Comentado para preservar tabelas AI
    with op.batch_alter_table('ai_advanced_sessions', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('idx_ai_sessions_confidence'))
        batch_op.drop_index(batch_op.f('idx_ai_sessions_domain'))
        batch_op.drop_index(batch_op.f('idx_ai_sessions_metadata'), postgresql_using='gin')
        batch_op.drop_index(batch_op.f('idx_ai_sessions_metadata_gin'), postgresql_using='gin')
        batch_op.drop_index(batch_op.f('idx_ai_sessions_user'))
        batch_op.drop_index(batch_op.f('idx_ai_sessions_user_date'))

    op.drop_table('ai_advanced_sessions')
    """
    
    # ... existing code ...
