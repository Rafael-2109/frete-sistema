#!/usr/bin/env python3
"""
Script de Setup e Migra√ß√£o para Sistema de Estoque em Tempo Real
Executa todas as opera√ß√µes necess√°rias para configurar o novo sistema
"""

import os
import sys
from datetime import datetime

# Adicionar o diret√≥rio raiz ao path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

def verificar_ambiente():
    """Verifica se o ambiente est√° configurado corretamente"""
    print("üîç Verificando ambiente...")
    
    # Verificar Python
    versao_python = sys.version_info
    if versao_python.major < 3 or (versao_python.major == 3 and versao_python.minor < 8):
        print(f"‚ùå Python {versao_python.major}.{versao_python.minor} detectado. Necess√°rio Python 3.8+")
        return False
    print(f"‚úÖ Python {versao_python.major}.{versao_python.minor}.{versao_python.micro}")
    
    # Verificar DATABASE_URL
    database_url = os.getenv('DATABASE_URL', '')
    if database_url:
        print(f"‚úÖ DATABASE_URL configurada: {database_url[:30]}...")
    else:
        print("‚ö†Ô∏è  DATABASE_URL n√£o configurada (usando SQLite local)")
    
    return True


def criar_tabelas():
    """Cria as tabelas do novo sistema"""
    print("\nüìä Criando tabelas do sistema de tempo real...")
    
    try:
        from app import create_app, db
        app = create_app()
        
        with app.app_context():
            # Importar modelos para garantir que sejam conhecidos
            from app.estoque.models_tempo_real import EstoqueTempoReal, MovimentacaoPrevista
            
            # Criar tabelas
            db.create_all()
            
            # Verificar se foram criadas
            from sqlalchemy import inspect
            inspector = inspect(db.engine)
            
            tabelas_criadas = []
            if inspector.has_table('estoque_tempo_real'):
                tabelas_criadas.append('estoque_tempo_real')
            if inspector.has_table('movimentacao_prevista'):
                tabelas_criadas.append('movimentacao_prevista')
            
            if len(tabelas_criadas) == 2:
                print("‚úÖ Tabelas criadas com sucesso:")
                for tabela in tabelas_criadas:
                    print(f"   - {tabela}")
                return True
            else:
                print(f"‚ö†Ô∏è  Apenas {len(tabelas_criadas)} tabela(s) criada(s)")
                return False
                
    except Exception as e:
        print(f"‚ùå Erro ao criar tabelas: {e}")
        return False


def migrar_dados_existentes():
    """Migra dados do sistema antigo para o novo"""
    print("\nüîÑ Migrando dados existentes...")
    
    try:
        from app import create_app, db
        from app.estoque.models import MovimentacaoEstoque, UnificacaoCodigos
        from app.estoque.models_tempo_real import EstoqueTempoReal, MovimentacaoPrevista
        from app.estoque.services.estoque_tempo_real import ServicoEstoqueTempoReal
        from app.carteira.models import PreSeparacaoItem
        from app.separacao.models import Separacao
        from app.producao.models import ProgramacaoProducao
        from app.utils import agora_brasil
        from decimal import Decimal
        from datetime import date
        
        app = create_app()
        
        with app.app_context():
            # 1. Migrar saldo atual de estoque
            print("  üì¶ Migrando saldos atuais...")
            
            produtos = db.session.query(
                MovimentacaoEstoque.cod_produto,
                MovimentacaoEstoque.nome_produto
            ).filter(
                MovimentacaoEstoque.ativo == True
            ).distinct().all()
            
            produtos_processados = 0
            for cod_produto, nome_produto in produtos:
                try:
                    # Calcular saldo atual
                    saldo = Decimal('0')
                    
                    # Considerar unifica√ß√£o
                    codigos = UnificacaoCodigos.get_todos_codigos_relacionados(cod_produto)
                    
                    for codigo in codigos:
                        movs = MovimentacaoEstoque.query.filter_by(
                            cod_produto=codigo,
                            ativo=True
                        ).all()
                        
                        for mov in movs:
                            # qtd_movimentacao j√° vem com sinal correto
                            saldo += Decimal(str(mov.qtd_movimentacao))
                    
                    # Criar ou atualizar EstoqueTempoReal
                    estoque = EstoqueTempoReal.query.filter_by(
                        cod_produto=cod_produto
                    ).first()
                    
                    if not estoque:
                        estoque = EstoqueTempoReal(
                            cod_produto=cod_produto,
                            nome_produto=nome_produto or f"Produto {cod_produto}"
                        )
                    
                    estoque.saldo_atual = saldo
                    estoque.atualizado_em = agora_brasil()
                    
                    db.session.add(estoque)
                    produtos_processados += 1
                    
                    if produtos_processados % 50 == 0:
                        db.session.commit()
                        print(f"    ‚úÖ {produtos_processados} produtos processados...")
                        
                except Exception as e:
                    print(f"    ‚ö†Ô∏è  Erro no produto {cod_produto}: {e}")
            
            db.session.commit()
            print(f"  ‚úÖ {produtos_processados} produtos migrados")
            
            # 2. Migrar movimenta√ß√µes previstas
            print("\n  üìÖ Migrando movimenta√ß√µes previstas...")
            hoje = date.today()
            movs_previstas = 0
            
            # PreSeparacaoItem
            preseps = PreSeparacaoItem.query.filter(
                PreSeparacaoItem.recomposto == False,
                PreSeparacaoItem.data_expedicao_editada >= hoje
            ).all()
            
            for item in preseps:
                if item.qtd_selecionada_usuario > 0:
                    ServicoEstoqueTempoReal.atualizar_movimentacao_prevista(
                        cod_produto=item.cod_produto,
                        data=item.data_expedicao_editada,
                        qtd_saida=Decimal(str(item.qtd_selecionada_usuario))
                    )
                    movs_previstas += 1
            
            print(f"    ‚úÖ {len(preseps)} pr√©-separa√ß√µes processadas")
            
            # Separacao
            seps = Separacao.query.filter(
                Separacao.expedicao >= hoje,
                Separacao.qtd_saldo > 0
            ).all()
            
            for sep in seps:
                ServicoEstoqueTempoReal.atualizar_movimentacao_prevista(
                    cod_produto=sep.cod_produto,
                    data=sep.expedicao,
                    qtd_saida=Decimal(str(sep.qtd_saldo))
                )
                movs_previstas += 1
            
            print(f"    ‚úÖ {len(seps)} separa√ß√µes processadas")
            
            # ProgramacaoProducao
            try:
                prods = ProgramacaoProducao.query.filter(
                    ProgramacaoProducao.data_programacao >= hoje,
                    ProgramacaoProducao.qtd_programada > 0
                ).all()
                
                for prod in prods:
                    ServicoEstoqueTempoReal.atualizar_movimentacao_prevista(
                        cod_produto=prod.cod_produto,
                        data=prod.data_programacao,
                        qtd_entrada=Decimal(str(prod.qtd_programada))
                    )
                    movs_previstas += 1
                
                print(f"    ‚úÖ {len(prods)} programa√ß√µes processadas")
            except:
                print("    ‚ÑπÔ∏è  Tabela ProgramacaoProducao n√£o dispon√≠vel")
            
            db.session.commit()
            print(f"  ‚úÖ Total de {movs_previstas} movimenta√ß√µes previstas migradas")
            
            # 3. Calcular rupturas
            print("\n  üìä Calculando rupturas D+7...")
            produtos = EstoqueTempoReal.query.all()
            
            for i, produto in enumerate(produtos):
                try:
                    ServicoEstoqueTempoReal.calcular_ruptura_d7(produto.cod_produto)
                    if (i + 1) % 50 == 0:
                        db.session.commit()
                        print(f"    ‚úÖ {i + 1}/{len(produtos)} produtos calculados...")
                except Exception as e:
                    print(f"    ‚ö†Ô∏è  Erro no produto {produto.cod_produto}: {e}")
            
            db.session.commit()
            print(f"  ‚úÖ Rupturas calculadas para {len(produtos)} produtos")
            
            return True
            
    except Exception as e:
        print(f"‚ùå Erro na migra√ß√£o: {e}")
        import traceback
        traceback.print_exc()
        return False


def verificar_integridade():
    """Verifica se a migra√ß√£o foi bem sucedida"""
    print("\nüîç Verificando integridade dos dados...")
    
    try:
        from app import create_app, db
        from app.estoque.models_tempo_real import EstoqueTempoReal, MovimentacaoPrevista
        
        app = create_app()
        
        with app.app_context():
            # Contar registros
            total_estoque = EstoqueTempoReal.query.count()
            total_movs = MovimentacaoPrevista.query.count()
            
            # Produtos com estoque negativo
            negativos = EstoqueTempoReal.query.filter(
                EstoqueTempoReal.saldo_atual < 0
            ).count()
            
            # Produtos com ruptura
            rupturas = EstoqueTempoReal.query.filter(
                EstoqueTempoReal.dia_ruptura != None
            ).count()
            
            print(f"""
  üìä Resumo da Verifica√ß√£o:
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ‚úÖ EstoqueTempoReal: {total_estoque} produtos
  ‚úÖ MovimentacaoPrevista: {total_movs} registros
  ‚ö†Ô∏è  Estoque Negativo: {negativos} produtos
  ‚ö†Ô∏è  Rupturas Previstas: {rupturas} produtos
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            """)
            
            if total_estoque > 0:
                return True
            else:
                print("‚ùå Nenhum produto encontrado no novo sistema")
                return False
                
    except Exception as e:
        print(f"‚ùå Erro na verifica√ß√£o: {e}")
        return False


def main():
    """Fun√ß√£o principal"""
    print("""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   SETUP DO SISTEMA DE ESTOQUE EM TEMPO REAL         ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    """)
    
    # 1. Verificar ambiente
    if not verificar_ambiente():
        print("\n‚ùå Ambiente n√£o est√° pronto. Corrija os problemas acima.")
        return 1
    
    # 2. Criar tabelas
    if not criar_tabelas():
        print("\n‚ùå Falha ao criar tabelas. Verifique o banco de dados.")
        return 1
    
    # 3. Migrar dados
    resposta = input("\nüîÑ Deseja migrar dados existentes? (s/N): ")
    if resposta.lower() == 's':
        if not migrar_dados_existentes():
            print("\n‚ö†Ô∏è  Migra√ß√£o teve problemas, mas continuando...")
    else:
        print("‚ÑπÔ∏è  Migra√ß√£o pulada")
    
    # 4. Verificar integridade
    if not verificar_integridade():
        print("\n‚ö†Ô∏è  Verifica√ß√£o encontrou problemas")
    
    print("""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë            SETUP CONCLU√çDO COM SUCESSO!              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìù Pr√≥ximos passos:
   1. Testar performance: python test_performance_tempo_real.py
   2. Rodar aplica√ß√£o: python run.py
   3. Acessar: http://localhost:5000

‚úÖ Sistema de Estoque em Tempo Real est√° pronto!
    """)
    
    return 0


if __name__ == '__main__':
    sys.exit(main())